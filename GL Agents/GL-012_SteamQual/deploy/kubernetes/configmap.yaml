# =============================================================================
# GL-012 STEAMQUAL - Kubernetes ConfigMap and Secrets
# =============================================================================
# Configuration management for steam quality monitoring agent.
#
# Contents:
#   - ConfigMap: gl-012-config (application configuration)
#   - Secret: gl-012-secrets (sensitive data - template only)
#
# Environment-specific overrides can be applied using Kustomize overlays
# or Helm values.
#
# Standards Compliance:
#   - ASME PTC 19.11: Steam and Water Sampling
#   - IAPWS-IF97: Steam Property Calculations
#   - ISO 9001: Quality Management
#
# Author: GL-DevOpsEngineer
# Version: 1.0.0
# Date: December 2025
# =============================================================================

---
# =============================================================================
# ConfigMap - Application Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-012-config
  namespace: gl-agents
  labels:
    app.kubernetes.io/name: gl-012-steamqual
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: greenlang
data:
  # ==========================================================================
  # Agent Identity
  # ==========================================================================
  GL_AGENT_ID: "GL-012"
  GL_AGENT_NAME: "STEAMQUAL"
  GL_VERSION: "1.0.0"

  # ==========================================================================
  # Logging Configuration
  # ==========================================================================
  GL_LOG_LEVEL: "INFO"
  GL_LOG_FORMAT: "json"
  GL_LOG_OUTPUT: "stdout"

  # ==========================================================================
  # API Configuration
  # ==========================================================================
  API_HOST: "0.0.0.0"
  API_PORT: "8080"
  API_WORKERS: "4"
  API_TIMEOUT: "60"
  API_MAX_REQUEST_SIZE: "10485760"  # 10MB

  # ==========================================================================
  # Metrics Configuration
  # ==========================================================================
  GL_ENABLE_METRICS: "true"
  GL_METRICS_PORT: "9090"
  GL_METRICS_PATH: "/metrics"
  PROMETHEUS_MULTIPROC_DIR: "/tmp/prometheus"

  # ==========================================================================
  # Tracing Configuration
  # ==========================================================================
  GL_ENABLE_TRACING: "true"
  OTEL_SERVICE_NAME: "gl-012-steamqual"
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger-collector.monitoring:4317"
  OTEL_TRACES_SAMPLER: "parentbased_traceidratio"
  OTEL_TRACES_SAMPLER_ARG: "0.1"  # 10% sampling

  # ==========================================================================
  # Steam Quality Configuration (IAPWS-IF97)
  # ==========================================================================
  IAPWS_PRECISION: "high"
  STEAM_QUALITY_MIN: "0.0"
  STEAM_QUALITY_MAX: "1.0"
  STEAM_QUALITY_PRECISION: "0.001"
  STEAM_TABLE_CACHE_ENABLED: "true"
  STEAM_TABLE_CACHE_SIZE: "10000"
  STEAM_TABLE_CACHE_TTL: "3600"

  # ==========================================================================
  # Calculation Configuration
  # ==========================================================================
  CALCULATION_DECIMAL_PLACES: "6"
  UNCERTAINTY_PROPAGATION: "true"
  GL_DETERMINISTIC_MODE: "true"
  GL_DECIMAL_PRECISION: "true"

  # ==========================================================================
  # Safety Configuration
  # ==========================================================================
  GL_FAIL_CLOSED: "true"
  CIRCUIT_BREAKER_ENABLED: "true"
  CIRCUIT_BREAKER_THRESHOLD: "5"
  CIRCUIT_BREAKER_TIMEOUT: "60"
  BOUNDS_VALIDATION_ENABLED: "true"

  # ==========================================================================
  # Audit Configuration
  # ==========================================================================
  GL_AUDIT_ENABLED: "true"
  GL_AUDIT_RETENTION_DAYS: "2555"  # 7 years per regulatory requirements
  GL_AUDIT_STORAGE_PATH: "/app/audit"
  GL_READ_ONLY_MODE: "true"

  # ==========================================================================
  # Feature Flags
  # ==========================================================================
  FEATURE_SHAP_EXPLAINABILITY: "true"
  FEATURE_REAL_TIME_MONITORING: "true"
  FEATURE_PREDICTIVE_ANALYSIS: "true"
  FEATURE_BATCH_PROCESSING: "true"
  FEATURE_WEBHOOK_NOTIFICATIONS: "false"

  # ==========================================================================
  # Cache Configuration
  # ==========================================================================
  REDIS_CACHE_TTL: "3600"
  REDIS_CACHE_PREFIX: "gl012:"
  REDIS_CONNECTION_POOL_SIZE: "10"

  # ==========================================================================
  # Database Configuration
  # ==========================================================================
  DB_POOL_SIZE: "10"
  DB_MAX_OVERFLOW: "20"
  DB_POOL_TIMEOUT: "30"
  DB_POOL_RECYCLE: "1800"

  # ==========================================================================
  # Pressure and Temperature Units (ASME PTC 19.11)
  # ==========================================================================
  DEFAULT_PRESSURE_UNIT: "MPa"
  DEFAULT_TEMPERATURE_UNIT: "K"
  DEFAULT_MASS_FLOW_UNIT: "kg/s"
  DEFAULT_ENERGY_UNIT: "kJ"

  # ==========================================================================
  # Alarm Thresholds
  # ==========================================================================
  ALARM_STEAM_QUALITY_LOW: "0.80"
  ALARM_STEAM_QUALITY_CRITICAL: "0.70"
  ALARM_MOISTURE_HIGH: "0.15"
  ALARM_MOISTURE_CRITICAL: "0.25"
  ALARM_SUPERHEAT_LOW: "5.0"
  ALARM_SUPERHEAT_HIGH: "50.0"

---
# =============================================================================
# Secret - Sensitive Configuration (TEMPLATE - Replace in production)
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: gl-012-secrets
  namespace: gl-agents
  labels:
    app.kubernetes.io/name: gl-012-steamqual
    app.kubernetes.io/component: secrets
type: Opaque
stringData:
  # ==========================================================================
  # Database Credentials
  # NOTE: In production, use External Secrets Operator or Vault
  # ==========================================================================
  DATABASE_URL: "postgresql://steamqual:CHANGE_ME@timescaledb:5432/steamqual"
  DATABASE_PASSWORD: "CHANGE_ME"

  # ==========================================================================
  # Redis Credentials
  # ==========================================================================
  REDIS_URL: "redis://:CHANGE_ME@redis:6379/0"
  REDIS_PASSWORD: "CHANGE_ME"

  # ==========================================================================
  # API Authentication
  # ==========================================================================
  API_KEY: "CHANGE_ME_IN_PRODUCTION"
  JWT_SECRET_KEY: "CHANGE_ME_IN_PRODUCTION"

  # ==========================================================================
  # External Service Credentials
  # ==========================================================================
  SCADA_API_KEY: "CHANGE_ME"
  SCADA_CLIENT_SECRET: "CHANGE_ME"

---
# =============================================================================
# ConfigMap - Prometheus Scrape Config
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-012-prometheus-config
  namespace: gl-agents
  labels:
    app.kubernetes.io/name: gl-012-steamqual
    app.kubernetes.io/component: monitoring-config
data:
  prometheus-additional-scrape-configs.yaml: |
    - job_name: 'gl-012-steamqual'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - gl-agents
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
          action: keep
          regex: gl-012-steamqual
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
      metrics_relabel_configs:
        - source_labels: [__name__]
          regex: 'go_.*'
          action: drop

---
# =============================================================================
# ConfigMap - Alert Rules
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-012-alert-rules
  namespace: gl-agents
  labels:
    app.kubernetes.io/name: gl-012-steamqual
    app.kubernetes.io/component: alerts
data:
  steamqual-alerts.yaml: |
    groups:
      - name: gl-012-steamqual-alerts
        rules:
          # Steam quality degradation alert
          - alert: SteamQualityDegraded
            expr: steam_quality_percentage < 80
            for: 5m
            labels:
              severity: warning
              agent: gl-012-steamqual
            annotations:
              summary: "Steam quality below acceptable threshold"
              description: "Steam quality is {{ $value }}%, below the 80% threshold."

          # Critical steam quality alert
          - alert: SteamQualityCritical
            expr: steam_quality_percentage < 70
            for: 2m
            labels:
              severity: critical
              agent: gl-012-steamqual
            annotations:
              summary: "Steam quality critically low"
              description: "Steam quality is {{ $value }}%, below the 70% critical threshold. Immediate action required."

          # High moisture content alert
          - alert: HighMoistureContent
            expr: steam_moisture_percentage > 15
            for: 5m
            labels:
              severity: warning
              agent: gl-012-steamqual
            annotations:
              summary: "High moisture content in steam"
              description: "Steam moisture content is {{ $value }}%, above the 15% threshold."

          # API latency alert
          - alert: SteamQualAPIHighLatency
            expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="gl-012-steamqual"}[5m])) > 1
            for: 5m
            labels:
              severity: warning
              agent: gl-012-steamqual
            annotations:
              summary: "High API latency detected"
              description: "99th percentile latency is {{ $value }}s, above 1s threshold."

          # Error rate alert
          - alert: SteamQualHighErrorRate
            expr: rate(http_requests_total{job="gl-012-steamqual", status=~"5.."}[5m]) / rate(http_requests_total{job="gl-012-steamqual"}[5m]) > 0.05
            for: 5m
            labels:
              severity: critical
              agent: gl-012-steamqual
            annotations:
              summary: "High error rate detected"
              description: "Error rate is {{ $value | humanizePercentage }}, above 5% threshold."

          # Pod restart alert
          - alert: SteamQualPodRestarting
            expr: increase(kube_pod_container_status_restarts_total{pod=~"gl-012-steamqual.*"}[1h]) > 3
            for: 5m
            labels:
              severity: warning
              agent: gl-012-steamqual
            annotations:
              summary: "Frequent pod restarts"
              description: "Pod has restarted {{ $value }} times in the last hour."
