# GL-017_Condensync Secret Template
# Version: 1.0.0
#
# WARNING: This is a TEMPLATE. Never commit actual secrets to version control.
# Use external secret management (AWS Secrets Manager, HashiCorp Vault, etc.)
#
# For production deployments, use:
# - ExternalSecrets Operator
# - Sealed Secrets
# - AWS Secrets Manager with IRSA
# - HashiCorp Vault

---
# Basic Secret (For Development Only)
# NOTE: Base64 encode values before applying
# echo -n 'value' | base64
apiVersion: v1
kind: Secret
metadata:
  name: gl-017-condensync-secrets
  namespace: greenlang
  labels:
    app: gl-017-condensync
    app.kubernetes.io/name: gl-017-condensync
    app.kubernetes.io/component: secrets
  annotations:
    # Indicate this is a template
    template.greenlang.io/type: "secret-template"
    template.greenlang.io/warning: "DO NOT COMMIT ACTUAL SECRETS"
type: Opaque
data:
  # Database Connection (base64 encoded)
  # postgresql://user:password@host:5432/condensync_db
  database-url: cG9zdGdyZXNxbDovL3VzZXI6cGFzc3dvcmRAaG9zdDo1NDMyL2NvbmRlbnN5bmNfZGI=

  # Redis Connection (base64 encoded)
  # redis://host:6379/0
  redis-url: cmVkaXM6Ly9ob3N0OjYzNzkvMA==

  # API Key (base64 encoded)
  api-key: QVBJX0tFWV9QTEFDRUhPTERFUg==

  # JWT Secret (base64 encoded)
  jwt-secret: SldUX1NFQ1JFVF9QTEFDRUhPTERFUg==

  # Message Broker Credentials (base64 encoded)
  rabbitmq-url: YW1xcDovL3VzZXI6cGFzc3dvcmRAcmFiYml0bXE6NTY3Mi8=

---
# External Secrets Operator - AWS Secrets Manager
# Requires: External Secrets Operator installed
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-017-condensync-external-secrets
  namespace: greenlang
  labels:
    app: gl-017-condensync
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-017-condensync-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        database-url: "{{ .database_url }}"
        redis-url: "{{ .redis_url }}"
        api-key: "{{ .api_key }}"
        jwt-secret: "{{ .jwt_secret }}"
        rabbitmq-url: "{{ .rabbitmq_url }}"
  data:
    - secretKey: database_url
      remoteRef:
        key: greenlang/production/gl-017-condensync
        property: database_url
    - secretKey: redis_url
      remoteRef:
        key: greenlang/production/gl-017-condensync
        property: redis_url
    - secretKey: api_key
      remoteRef:
        key: greenlang/production/gl-017-condensync
        property: api_key
    - secretKey: jwt_secret
      remoteRef:
        key: greenlang/production/gl-017-condensync
        property: jwt_secret
    - secretKey: rabbitmq_url
      remoteRef:
        key: greenlang/production/gl-017-condensync
        property: rabbitmq_url

---
# Cluster Secret Store for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-gl017
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# HashiCorp Vault - Secrets Injection
# Requires: Vault Agent Injector installed
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-017-condensync-vault-sa
  namespace: greenlang
  labels:
    app: gl-017-condensync
  annotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/agent-inject-status: "update"
    vault.hashicorp.com/role: "gl-017-condensync-role"
    vault.hashicorp.com/agent-inject-secret-database: "secret/data/greenlang/production/gl-017-condensync/database"
    vault.hashicorp.com/agent-inject-template-database: |
      {{- with secret "secret/data/greenlang/production/gl-017-condensync/database" -}}
      export DATABASE_URL="{{ .Data.data.url }}"
      {{- end -}}
    vault.hashicorp.com/agent-inject-secret-redis: "secret/data/greenlang/production/gl-017-condensync/redis"
    vault.hashicorp.com/agent-inject-template-redis: |
      {{- with secret "secret/data/greenlang/production/gl-017-condensync/redis" -}}
      export REDIS_URL="{{ .Data.data.url }}"
      {{- end -}}
    vault.hashicorp.com/agent-inject-secret-api: "secret/data/greenlang/production/gl-017-condensync/api"
    vault.hashicorp.com/agent-inject-template-api: |
      {{- with secret "secret/data/greenlang/production/gl-017-condensync/api" -}}
      export API_KEY="{{ .Data.data.key }}"
      export JWT_SECRET="{{ .Data.data.jwt_secret }}"
      {{- end -}}

---
# TLS Secret (for HTTPS)
# Create with: kubectl create secret tls gl-017-condensync-tls --cert=tls.crt --key=tls.key
apiVersion: v1
kind: Secret
metadata:
  name: gl-017-condensync-tls
  namespace: greenlang
  labels:
    app: gl-017-condensync
type: kubernetes.io/tls
data:
  # Base64 encoded certificate and key
  tls.crt: LS0t...BASE64_ENCODED_CERTIFICATE...
  tls.key: LS0t...BASE64_ENCODED_PRIVATE_KEY...

---
# Docker Registry Secret
# Create with: kubectl create secret docker-registry registry-credentials ...
apiVersion: v1
kind: Secret
metadata:
  name: gl-017-condensync-registry
  namespace: greenlang
  labels:
    app: gl-017-condensync
type: kubernetes.io/dockerconfigjson
data:
  # Base64 encoded docker config
  .dockerconfigjson: eyJhdXRocyI6eyJnaGNyLmlvIjp7InVzZXJuYW1lIjoiX2pzb25fa2V5IiwicGFzc3dvcmQiOiIuLi4iLCJhdXRoIjoiLi4uIn19fQ==

---
# Secret Rotation CronJob
# Automatically rotate secrets on schedule
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gl-017-condensync-secret-rotation
  namespace: greenlang
  labels:
    app: gl-017-condensync
spec:
  schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: gl-017-condensync-secret-rotation-sa
          containers:
            - name: rotate-secrets
              image: amazon/aws-cli:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Rotating secrets for GL-017 Condensync..."
                  # Rotate API keys in AWS Secrets Manager
                  aws secretsmanager rotate-secret \
                    --secret-id greenlang/production/gl-017-condensync/api-key \
                    --rotation-lambda-arn arn:aws:lambda:us-east-1:ACCOUNT:function:secret-rotation
                  echo "Secret rotation completed"
              env:
                - name: AWS_REGION
                  value: us-east-1
              resources:
                limits:
                  cpu: 100m
                  memory: 128Mi
                requests:
                  cpu: 50m
                  memory: 64Mi
          restartPolicy: OnFailure
