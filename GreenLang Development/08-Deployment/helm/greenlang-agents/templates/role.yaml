{{- if .Values.rbac.create -}}
{{/*
Role - Namespace-scoped permissions for GreenLang Agents
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-role
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
rules:
  # ConfigMaps - read application configuration
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Secrets - read credentials (limited)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames:
      - {{ include "greenlang-agents.fullname" . }}-secrets
      - {{ include "greenlang-agents.fullname" . }}-api-keys
      - {{ include "greenlang-agents.fullname" . }}-tls
    verbs: ["get"]

  # Pods - view own pods for health checks
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Pod logs - for debugging
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]

  # Services - service discovery
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]

  # Events - view events for debugging
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

  # Leases - leader election for scheduler
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Jobs - create and manage batch jobs
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # CronJobs - scheduled tasks
  - apiGroups: ["batch"]
    resources: ["cronjobs"]
    verbs: ["get", "list", "watch"]

  # HPA - view autoscaling status
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch"]

  # PodDisruptionBudgets - view PDB status
  - apiGroups: ["policy"]
    resources: ["poddisruptionbudgets"]
    verbs: ["get", "list", "watch"]
---
{{/*
Role for scheduler leader election
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-leader-election
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
rules:
  # Leases for leader election
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # ConfigMaps as backup for leader election
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Events for leader election status
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
{{- end }}
