# GreenLang ServiceMonitors for Prometheus Operator
# Service discovery configuration for all agents and services

---
# EUDR Agent ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: eudr-agent
  namespace: monitoring
  labels:
    app: eudr-agent
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: eudr-agent
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'eudr_.*'
          action: keep

---
# CBAM Agent ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cbam-agent
  namespace: monitoring
  labels:
    app: cbam-agent
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: cbam-agent
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace

---
# SB253 Agent ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: sb253-agent
  namespace: monitoring
  labels:
    app: sb253-agent
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: sb253-agent
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
      honorLabels: true

---
# API Gateway ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api-gateway
  namespace: monitoring
  labels:
    app: api-gateway
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: api-gateway
  endpoints:
    - port: metrics
      interval: 10s
      path: /metrics
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace

---
# Emission Calculator ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: emission-calculator
  namespace: monitoring
  labels:
    app: emission-calculator
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: emission-calculator
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
      honorLabels: true

---
# Satellite Analysis ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: satellite-analysis
  namespace: monitoring
  labels:
    app: satellite-analysis
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: satellite-analysis
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      honorLabels: true

---
# Supply Chain Tracker ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: supply-chain-tracker
  namespace: monitoring
  labels:
    app: supply-chain-tracker
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: supply-chain-tracker
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
      honorLabels: true

---
# PostgreSQL Exporter ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-exporter
  namespace: monitoring
  labels:
    app: postgres-exporter
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: postgres-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http

---
# Redis Exporter ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redis-exporter
  namespace: monitoring
  labels:
    app: redis-exporter
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      app: redis-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http

---
# PodMonitor for all GreenLang pods with prometheus annotations
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: greenlang-pods
  namespace: monitoring
  labels:
    release: prometheus
spec:
  namespaceSelector:
    matchNames:
      - greenlang
  selector:
    matchLabels:
      prometheus.io/scrape: "true"
  podMetricsEndpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          targetLabel: __metrics_path__
          regex: (.+)
        - sourceLabels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          targetLabel: __address__
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - sourceLabels: [__meta_kubernetes_pod_label_app]
          targetLabel: app
