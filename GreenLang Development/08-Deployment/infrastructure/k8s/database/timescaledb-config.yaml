# =============================================================================
# GreenLang TimescaleDB Kubernetes Configuration
# =============================================================================
# INFRA-003: TimescaleDB deployment configuration for time-series data
#
# This configuration provides:
#   1. TimescaleDB StatefulSet deployment
#   2. High-availability setup with streaming replication
#   3. Automated backups with pgBackRest
#   4. Connection pooling with PgBouncer
# =============================================================================
---
# =============================================================================
# NAMESPACE
# =============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: greenlang-database
  labels:
    app.kubernetes.io/name: greenlang-database
    app.kubernetes.io/part-of: greenlang-platform

---
# =============================================================================
# CONFIGMAP: TimescaleDB Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: timescaledb-config
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
  annotations:
    infra-task: "INFRA-003"
data:
  # PostgreSQL configuration
  postgresql.conf: |
    # ==========================================================================
    # TimescaleDB PostgreSQL Configuration for GreenLang
    # ==========================================================================

    # Connection Settings
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    superuser_reserved_connections = 3

    # Memory Settings (adjust based on instance size)
    shared_buffers = 4GB
    effective_cache_size = 12GB
    work_mem = 64MB
    maintenance_work_mem = 1GB

    # WAL Settings
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    wal_keep_size = 2GB
    archive_mode = on
    archive_command = 'pgbackrest --stanza=greenlang archive-push %p'

    # Checkpointing
    checkpoint_timeout = 15min
    checkpoint_completion_target = 0.9
    max_wal_size = 4GB
    min_wal_size = 1GB

    # Query Planning
    random_page_cost = 1.1
    effective_io_concurrency = 200
    default_statistics_target = 100

    # Parallel Query
    max_parallel_workers_per_gather = 4
    max_parallel_workers = 8
    max_parallel_maintenance_workers = 4
    parallel_leader_participation = on

    # Logging
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_min_duration_statement = 1000
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on
    log_temp_files = 0

    # Statistics
    track_activities = on
    track_counts = on
    track_io_timing = on
    track_functions = all

    # TimescaleDB Specific
    shared_preload_libraries = 'timescaledb,pg_stat_statements'
    timescaledb.max_background_workers = 8
    timescaledb.telemetry_level = off

    # Autovacuum
    autovacuum = on
    autovacuum_max_workers = 4
    autovacuum_naptime = 30s
    autovacuum_vacuum_threshold = 50
    autovacuum_analyze_threshold = 50
    autovacuum_vacuum_scale_factor = 0.05
    autovacuum_analyze_scale_factor = 0.02

    # SSL/TLS (enabled in production)
    ssl = on
    ssl_cert_file = '/etc/ssl/certs/server.crt'
    ssl_key_file = '/etc/ssl/private/server.key'
    ssl_ca_file = '/etc/ssl/certs/ca.crt'
    ssl_min_protocol_version = 'TLSv1.3'

  # pg_hba.conf for authentication
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # Local connections
    local   all             postgres                                peer
    local   all             all                                     md5

    # IPv4 local connections
    host    all             all             127.0.0.1/32            scram-sha-256

    # IPv4 remote connections (within Kubernetes cluster)
    hostssl all             all             10.0.0.0/8              scram-sha-256
    hostssl all             all             172.16.0.0/12           scram-sha-256
    hostssl all             all             192.168.0.0/16          scram-sha-256

    # Replication connections
    hostssl replication     replicator      10.0.0.0/8              scram-sha-256

    # Deny all other connections
    hostssl all             all             0.0.0.0/0               reject

  # Init script for database setup
  init-db.sh: |
    #!/bin/bash
    set -e

    # Create application database and user
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        -- Create application database
        CREATE DATABASE greenlang;

        -- Create application user
        CREATE USER greenlang_app WITH ENCRYPTED PASSWORD '${GREENLANG_DB_PASSWORD}';

        -- Grant privileges
        GRANT ALL PRIVILEGES ON DATABASE greenlang TO greenlang_app;

        -- Connect to greenlang database
        \c greenlang

        -- Enable TimescaleDB extension
        CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
        CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
        CREATE EXTENSION IF NOT EXISTS pgcrypto;
        CREATE EXTENSION IF NOT EXISTS pgvector;

        -- Create metrics schema
        CREATE SCHEMA IF NOT EXISTS metrics;
        GRANT ALL ON SCHEMA metrics TO greenlang_app;

        -- Verify extensions
        SELECT * FROM pg_extension;
    EOSQL

    echo "Database initialization completed successfully!"

---
# =============================================================================
# SECRET: Database Credentials
# =============================================================================
# NOTE: In production, use external-secrets-operator or vault-secrets-operator
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: timescaledb-credentials
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
  annotations:
    infra-task: "INFRA-003"
    external-secrets.io/managed: "true"
type: Opaque
stringData:
  # Placeholder - should be populated by secrets operator in production
  POSTGRES_USER: "postgres"
  POSTGRES_PASSWORD: "changeme-in-production"
  GREENLANG_DB_PASSWORD: "changeme-in-production"
  REPLICATOR_PASSWORD: "changeme-in-production"

---
# =============================================================================
# STATEFULSET: TimescaleDB
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: timescaledb
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
  annotations:
    infra-task: "INFRA-003"
spec:
  serviceName: timescaledb
  replicas: 3
  podManagementPolicy: OrderedReady
  selector:
    matchLabels:
      app.kubernetes.io/name: timescaledb
  template:
    metadata:
      labels:
        app.kubernetes.io/name: timescaledb
        app.kubernetes.io/component: database
        app.kubernetes.io/part-of: greenlang-platform
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
    spec:
      securityContext:
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70

      initContainers:
        - name: init-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /config/postgresql.conf /data/postgresql.conf
              cp /config/pg_hba.conf /data/pg_hba.conf
              chmod 600 /data/*.conf
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data

      containers:
        - name: timescaledb
          image: timescale/timescaledb-ha:pg15-latest
          imagePullPolicy: IfNotPresent

          ports:
            - name: postgresql
              containerPort: 5432
              protocol: TCP

          envFrom:
            - secretRef:
                name: timescaledb-credentials

          env:
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            - name: POSTGRES_DB
              value: postgres

          resources:
            requests:
              cpu: "1"
              memory: "4Gi"
            limits:
              cpu: "4"
              memory: "16Gi"

          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql
            - name: tls-certs
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: tls-keys
              mountPath: /etc/ssl/private
              readOnly: true

          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
                - -d
                - postgres
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6

          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
                - -d
                - postgres
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

        - name: postgres-exporter
          image: prometheuscommunity/postgres-exporter:v0.15.0
          imagePullPolicy: IfNotPresent

          ports:
            - name: metrics
              containerPort: 9187
              protocol: TCP

          env:
            - name: DATA_SOURCE_NAME
              valueFrom:
                secretKeyRef:
                  name: timescaledb-credentials
                  key: POSTGRES_PASSWORD
            - name: DATA_SOURCE_URI
              value: "localhost:5432/postgres?sslmode=disable"

          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"

      volumes:
        - name: config
          configMap:
            name: timescaledb-config
        - name: tls-certs
          secret:
            secretName: timescaledb-tls
            items:
              - key: tls.crt
                path: server.crt
              - key: ca.crt
                path: ca.crt
        - name: tls-keys
          secret:
            secretName: timescaledb-tls
            items:
              - key: tls.key
                path: server.key
                mode: 0600

  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/name: timescaledb
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 500Gi

---
# =============================================================================
# SERVICE: TimescaleDB Headless (for StatefulSet)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: timescaledb
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
  selector:
    app.kubernetes.io/name: timescaledb

---
# =============================================================================
# SERVICE: TimescaleDB Primary (for write connections)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-primary
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
spec:
  type: ClusterIP
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
  selector:
    app.kubernetes.io/name: timescaledb
    role: primary

---
# =============================================================================
# SERVICE: TimescaleDB Replica (for read connections)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-replica
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
spec:
  type: ClusterIP
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
  selector:
    app.kubernetes.io/name: timescaledb
    role: replica

---
# =============================================================================
# PODDISRUPTIONBUDGET: Ensure availability during maintenance
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: timescaledb-pdb
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: timescaledb

---
# =============================================================================
# SERVICEMONITOR: Prometheus monitoring
# =============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: timescaledb
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: greenlang-platform
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: timescaledb
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
