# GreenLang Climate OS - Production Network Policies
# INFRA-001: Kubernetes Production Cluster - Security

---
# Default deny all ingress traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: greenlang-production
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# Default deny all egress traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: greenlang-production
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
# Allow DNS resolution for all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: greenlang-production
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# API Gateway network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-policy
  namespace: greenlang-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: api-gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow ingress from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
    # Allow health checks from anywhere in cluster
    - from: []
      ports:
        - protocol: TCP
          port: 8081
  egress:
    # Allow to API services
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: api
      ports:
        - protocol: TCP
          port: 8000
    # Allow to Agent Factory
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: agent-factory
      ports:
        - protocol: TCP
          port: 8000
    # Allow to Redis for caching
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: redis
      ports:
        - protocol: TCP
          port: 6379
---
# Agent Factory network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: agent-factory-policy
  namespace: greenlang-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: agent-factory
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from API Gateway
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: api-gateway
      ports:
        - protocol: TCP
          port: 8000
    # Allow from workers
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: worker
      ports:
        - protocol: TCP
          port: 8000
  egress:
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow to Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379
    # Allow to Weaviate
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: weaviate
      ports:
        - protocol: TCP
          port: 8080
    # Allow spawned agent pods to communicate back
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/managed-by: agent-factory
---
# PostgreSQL network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-policy
  namespace: greenlang-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: postgresql
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from application services only
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: greenlang
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # Allow replication between PostgreSQL pods
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: postgresql
      ports:
        - protocol: TCP
          port: 5432
---
# Redis network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-policy
  namespace: greenlang-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: redis
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from application services
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: greenlang
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379
  egress:
    # Allow Sentinel communication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379
---
# Worker pods network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: worker-policy
  namespace: greenlang-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: worker
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Health checks only
    - from: []
      ports:
        - protocol: TCP
          port: 8081
  egress:
    # Allow to Agent Factory
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: agent-factory
      ports:
        - protocol: TCP
          port: 8000
    # Allow to Redis for queue
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow external API calls (emission factors, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
---
# Monitoring namespace access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring
  namespace: greenlang-production
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 8081
