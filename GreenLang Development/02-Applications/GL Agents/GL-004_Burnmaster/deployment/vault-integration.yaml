# =============================================================================
# GL-004 BURNMASTER - Vault Kubernetes Integration
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-004-burnmaster
  namespace: greenlang
  labels:
    app: gl-004-burnmaster
    agent-id: GL-004
  annotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "gl-004-burnmaster"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gl-004-vault-auth-delegator
subjects:
  - kind: ServiceAccount
    name: gl-004-burnmaster
    namespace: greenlang
roleRef:
  kind: ClusterRole
  name: system:auth-delegator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-004-vault-agent-config
  namespace: greenlang
data:
  vault-agent-config.hcl: |
    pid_file = "/home/vault/.pid"
    vault {
      address = "https://vault.greenlang.local:8200"
    }
    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "gl-004-burnmaster"
        }
      }
      sink "file" {
        config = {
          path = "/home/vault/.vault-token"
          mode = 0640
        }
      }
    }
    template {
      destination = "/vault/secrets/database.json"
      contents = <<EOF
    {
      "username": "{{ with secret "database/creds/gl-004-postgres" }}{{ .Data.username }}{{ end }}",
      "password": "{{ with secret "database/creds/gl-004-postgres" }}{{ .Data.password }}{{ end }}"
    }
    EOF
    }
    template {
      destination = "/vault/secrets/flame-scanner.json"
      contents = <<EOF
    {{ with secret "secret/data/greenlang/agents/GL-004/integrations/flame-scanner" }}
    {{ .Data.data | toJSON }}
    {{ end }}
    EOF
    }
    template {
      destination = "/vault/secrets/combustion-analyzer.json"
      contents = <<EOF
    {{ with secret "secret/data/greenlang/agents/GL-004/integrations/combustion-analyzer" }}
    {{ .Data.data | toJSON }}
    {{ end }}
    EOF
    }
    template {
      destination = "/vault/secrets/jwt-secret"
      contents = "{{ with secret \"secret/data/greenlang/agents/GL-004/auth/jwt\" }}{{ .Data.data.secret }}{{ end }}"
      perms = "0400"
    }
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gl-004-vault-backend
  namespace: greenlang
spec:
  provider:
    vault:
      server: "https://vault.greenlang.local:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "gl-004-burnmaster"
          serviceAccountRef:
            name: "gl-004-burnmaster"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-004-secrets
  namespace: greenlang
spec:
  refreshInterval: "5m"
  secretStoreRef:
    kind: SecretStore
    name: gl-004-vault-backend
  target:
    name: gl-004-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: greenlang/agents/GL-004/auth/jwt
        property: secret
    - secretKey: DCS_USERNAME
      remoteRef:
        key: greenlang/agents/GL-004/integrations/dcs
        property: username
    - secretKey: DCS_PASSWORD
      remoteRef:
        key: greenlang/agents/GL-004/integrations/dcs
        property: password
