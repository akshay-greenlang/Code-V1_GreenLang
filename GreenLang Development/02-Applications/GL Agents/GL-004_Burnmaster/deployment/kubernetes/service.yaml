# GL-004 BURNMASTER - Kubernetes Services
# ========================================
# Service definitions for internal and external access

---
# ClusterIP Service for internal communication
apiVersion: v1
kind: Service
metadata:
  name: gl004-burnmaster
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
    app.kubernetes.io/component: service
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: gl004-burnmaster
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: grpc
      port: 50051
      targetPort: 50051
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  sessionAffinity: None

---
# Headless Service for StatefulSet/direct pod access
apiVersion: v1
kind: Service
metadata:
  name: gl004-burnmaster-headless
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
    app.kubernetes.io/component: headless-service
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app.kubernetes.io/name: gl004-burnmaster
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: grpc
      port: 50051
      targetPort: 50051
  publishNotReadyAddresses: true

---
# gRPC Service with proper configuration
apiVersion: v1
kind: Service
metadata:
  name: gl004-burnmaster-grpc
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
    app.kubernetes.io/component: grpc-service
  annotations:
    service.kubernetes.io/topology-aware-hints: "auto"
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: gl004-burnmaster
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
      protocol: TCP
      appProtocol: grpc
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

---
# Ingress for external HTTP access
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gl004-burnmaster-ingress
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
    app.kubernetes.io/component: ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # CORS configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://*.greenlang.io"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,X-Request-ID"
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains";
      more_set_headers "Content-Security-Policy: default-src 'self'";
    # TLS configuration
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.burnmaster.greenlang.io
        - burnmaster.greenlang.io
      secretName: gl004-burnmaster-tls
  rules:
    - host: api.burnmaster.greenlang.io
      http:
        paths:
          - path: /api/v1
            pathType: Prefix
            backend:
              service:
                name: gl004-burnmaster
                port:
                  number: 80
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: gl004-burnmaster
                port:
                  number: 80
    - host: burnmaster.greenlang.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: gl004-burnmaster
                port:
                  number: 80

---
# Ingress for gRPC (requires separate ingress with backend protocol annotation)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gl004-burnmaster-grpc-ingress
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
    app.kubernetes.io/component: grpc-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - grpc.burnmaster.greenlang.io
      secretName: gl004-burnmaster-grpc-tls
  rules:
    - host: grpc.burnmaster.greenlang.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: gl004-burnmaster-grpc
                port:
                  number: 50051

---
# Network Policy - Ingress rules
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl004-burnmaster-network-policy
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: gl004-burnmaster
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 50051
    # Allow from monitoring namespace
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9090
    # Allow from same namespace
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 50051
        - protocol: TCP
          port: 9090
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow to databases
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: databases
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 8086  # InfluxDB
    # Allow to Kafka
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kafka
      ports:
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 29092
    # Allow HTTPS outbound
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# ServiceMonitor for Prometheus Operator
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: gl004-burnmaster-monitor
  namespace: greenlang
  labels:
    app.kubernetes.io/name: gl004-burnmaster
    release: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: gl004-burnmaster
  endpoints:
    - port: metrics
      interval: 30s
      scrapeTimeout: 10s
      path: /metrics
      scheme: http
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
  namespaceSelector:
    matchNames:
      - greenlang
