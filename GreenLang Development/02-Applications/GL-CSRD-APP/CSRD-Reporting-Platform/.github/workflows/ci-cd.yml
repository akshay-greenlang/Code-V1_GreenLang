---
# ============================================================================
# CSRD/ESRS Platform - Complete CI/CD Pipeline
# ============================================================================
#
# This workflow provides:
# - Automated testing (975 tests)
# - Security scanning
# - Docker image building
# - Kubernetes deployment
# - Production rollout with canary deployment
#
# Triggers:
# - Push to main/master: Build, test, deploy to production
# - Push to develop: Build, test, deploy to staging
# - Pull requests: Build and test only
# - Tags (v*): Create release and deploy
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - main
      - develop
      - 'release/**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/csrd-app
  KUBECONFIG_PATH: ${{ secrets.KUBECONFIG }}

jobs:
  # ==========================================================================
  # JOB 1: Code Quality & Linting
  # ==========================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit safety

      - name: Run Ruff linter
        run: ruff check . --output-format=github
        continue-on-error: true

      - name: Run MyPy type checker
        run: |
          mypy agents/ cli/ sdk/ api/ --ignore-missing-imports
        continue-on-error: true

      - name: Run Bandit security scanner
        run: |
          bandit -r agents/ cli/ sdk/ api/ -f json -o bandit-report.json
          bandit -r agents/ cli/ sdk/ api/
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: bandit-report.json
          retention-days: 30

  # ==========================================================================
  # JOB 2: Unit & Integration Tests (975 tests!)
  # ==========================================================================
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist pytest-timeout pytest-asyncio

      - name: Run test suite
        run: |
          pytest tests/ -v --tb=short --maxfail=10 -n auto --timeout=300 \
            --cov=agents --cov=cli --cov=sdk --cov=api \
            --cov-report=xml --cov-report=html --cov-report=term
        timeout-minutes: 30
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-csrd
          fail_ci_if_error: false

      - name: Upload coverage reports
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

  # ==========================================================================
  # JOB 3: Build Docker Image
  # ==========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ==========================================================================
  # JOB 4: Deploy to Staging
  # ==========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.csrd.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config

      - name: Update deployment image
        run: |
          kubectl set image deployment/csrd-app \
            csrd-app=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n staging

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/csrd-app -n staging --timeout=5m

      - name: Run smoke tests
        run: |
          kubectl run smoke-test --rm -i --restart=Never \
            --image=curlimages/curl:latest \
            --namespace=staging \
            -- curl -f http://csrd-service/health || exit 1

  # ==========================================================================
  # JOB 5: Deploy to Production (Canary)
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' ||
       startsWith(github.ref, 'refs/tags/v') ||
       github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://csrd.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config

      - name: Create canary deployment
        run: |
          # Deploy canary with 10% traffic
          kubectl apply -f deployment/k8s/canary.yaml -n production

      - name: Monitor canary metrics
        run: |
          # Wait 5 minutes and check error rates
          sleep 300
          # TODO: Query Prometheus for error rates

      - name: Promote canary to production
        run: |
          # Update main deployment
          kubectl set image deployment/csrd-app \
            csrd-app=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n production

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/csrd-app -n production --timeout=10m

      - name: Clean up canary
        if: always()
        run: |
          kubectl delete -f deployment/k8s/canary.yaml -n production --ignore-not-found

      - name: Run production smoke tests
        run: |
          kubectl run smoke-test --rm -i --restart=Never \
            --image=curlimages/curl:latest \
            --namespace=production \
            -- curl -f http://csrd-service/health || exit 1

  # ==========================================================================
  # JOB 6: Create GitHub Release
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/changelog-config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            deployment/k8s/*.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # JOB 7: Notify on Completion
  # ==========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [quality, test, build, deploy-production]
    if: always()

    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.quality.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ All CI/CD stages passed!"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "❌ Some CI/CD stages failed"
            exit 1
          fi

      # Add Slack, Discord, or email notifications here
      # - name: Send Slack notification
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "CSRD Platform deployment ${{ steps.check.outputs.status }}"
      #       }
