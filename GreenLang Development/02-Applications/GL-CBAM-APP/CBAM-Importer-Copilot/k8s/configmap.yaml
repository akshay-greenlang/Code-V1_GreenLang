# ============================================================================
# GL-CBAM-APP - Kubernetes ConfigMaps
# ============================================================================
# Configuration data for the application:
# - Application settings
# - Feature flags
# - CBAM rules and reference data
# ============================================================================

---
# ============================================================================
# Application Configuration
# ============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: cbam-api-config
  namespace: gl-cbam
  labels:
    app: cbam-api
    component: configuration
data:
  # Application settings
  APP_ENV: "production"
  APP_VERSION: "1.0.0"
  LOG_LEVEL: "INFO"

  # API settings
  API_TITLE: "GL-CBAM-APP API"
  API_DESCRIPTION: "GreenLang CBAM Importer Copilot - Backend API"
  API_VERSION: "1.0.0"
  API_PREFIX: "/api/v1"

  # Database settings (non-sensitive)
  DB_POOL_SIZE: "10"
  DB_MAX_OVERFLOW: "20"
  DB_POOL_TIMEOUT: "30"
  DB_POOL_RECYCLE: "3600"
  DB_ECHO: "false"

  # Redis settings (non-sensitive)
  REDIS_DB: "0"
  REDIS_MAX_CONNECTIONS: "50"
  REDIS_DECODE_RESPONSES: "true"

  # CORS settings
  CORS_ORIGINS: "https://cbam.greenlang.com,https://app.greenlang.com"
  CORS_ALLOW_CREDENTIALS: "true"
  CORS_ALLOW_METHODS: "GET,POST,PUT,DELETE,OPTIONS,PATCH"
  CORS_ALLOW_HEADERS: "Content-Type,Authorization,X-Requested-With"

  # File upload settings
  MAX_UPLOAD_SIZE_MB: "100"
  UPLOAD_DIR: "/app/uploads"
  ALLOWED_UPLOAD_EXTENSIONS: ".csv,.xlsx,.json,.yaml"

  # Performance settings
  WORKER_PROCESSES: "4"
  WORKER_TIMEOUT: "120"
  KEEP_ALIVE: "5"
  MAX_REQUESTS: "1000"
  MAX_REQUESTS_JITTER: "100"

  # Feature flags
  ENABLE_API_DOCS: "true"
  ENABLE_METRICS: "true"
  ENABLE_TRACING: "false"
  ENABLE_RATE_LIMITING: "true"
  ENABLE_CACHING: "true"

  # Rate limiting
  RATE_LIMIT_PER_MINUTE: "60"
  RATE_LIMIT_PER_HOUR: "1000"

  # JWT settings (non-sensitive)
  JWT_ALGORITHM: "HS256"
  ACCESS_TOKEN_EXPIRE_MINUTES: "30"
  REFRESH_TOKEN_EXPIRE_DAYS: "7"

  # Logging
  LOG_FORMAT: "json"
  LOG_DATE_FORMAT: "%Y-%m-%d %H:%M:%S"
  LOG_MAX_BYTES: "10485760"  # 10MB
  LOG_BACKUP_COUNT: "5"

  # CBAM specific
  DEFAULT_QUARTER: "Q4-2024"
  CBAM_REGISTRY_URL: "https://cbam-registry.ec.europa.eu"

---
# ============================================================================
# CBAM Rules Configuration Files
# ============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: cbam-rules
  namespace: gl-cbam
  labels:
    app: cbam-api
    component: configuration
data:
  cbam_rules.yaml: |
    # CBAM Rules Configuration
    version: "1.0.0"
    effective_date: "2024-10-01"

    # Default emission factors (tCO2/tonne)
    default_emission_factors:
      iron_steel:
        direct: 2.1
        indirect: 0.5
        total: 2.6

      aluminum:
        direct: 8.6
        indirect: 1.4
        total: 10.0

      cement:
        direct: 0.766
        indirect: 0.034
        total: 0.8

      fertilizers:
        direct: 2.0
        indirect: 0.3
        total: 2.3

      electricity:
        direct: 0.0
        indirect: 0.4
        total: 0.4

      hydrogen:
        direct: 10.0
        indirect: 1.0
        total: 11.0

    # CN code categories
    cn_code_categories:
      iron_steel: ["7206", "7207", "7208", "7209", "7210", "7211", "7212", "7213", "7214", "7215", "7216"]
      aluminum: ["7601", "7602", "7603", "7604", "7605", "7606", "7607", "7608"]
      cement: ["2523"]
      fertilizers: ["3102", "3103", "3104", "3105"]
      electricity: ["2716"]
      hydrogen: ["2804"]

    # Validation thresholds
    validation:
      min_mass_tonnes: 0.001
      max_mass_tonnes: 100000
      min_emissions_tco2: 0.0
      max_emissions_tco2: 1000000

    # Reporting periods
    reporting_periods:
      - quarter: "Q1-2024"
        start_date: "2024-01-01"
        end_date: "2024-03-31"
      - quarter: "Q2-2024"
        start_date: "2024-04-01"
        end_date: "2024-06-30"
      - quarter: "Q3-2024"
        start_date: "2024-07-01"
        end_date: "2024-09-30"
      - quarter: "Q4-2024"
        start_date: "2024-10-01"
        end_date: "2024-12-31"

---
# ============================================================================
# Database Migration Scripts
# ============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: cbam-db-migrations
  namespace: gl-cbam
  labels:
    app: cbam-api
    component: database
data:
  init-schema.sql: |
    -- GL-CBAM-APP Database Schema

    -- Shipments table
    CREATE TABLE IF NOT EXISTS shipments (
      id SERIAL PRIMARY KEY,
      shipment_id VARCHAR(255) UNIQUE NOT NULL,
      cn_code VARCHAR(10) NOT NULL,
      product_name VARCHAR(255),
      mass_tonnes DECIMAL(12, 3) NOT NULL,
      country_of_origin VARCHAR(2) NOT NULL,
      supplier_id VARCHAR(255),
      import_date DATE NOT NULL,
      quarter VARCHAR(10) NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Emissions table
    CREATE TABLE IF NOT EXISTS emissions (
      id SERIAL PRIMARY KEY,
      shipment_id VARCHAR(255) REFERENCES shipments(shipment_id),
      direct_emissions DECIMAL(12, 3) NOT NULL,
      indirect_emissions DECIMAL(12, 3) NOT NULL,
      total_emissions DECIMAL(12, 3) NOT NULL,
      calculation_method VARCHAR(50) NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Reports table
    CREATE TABLE IF NOT EXISTS reports (
      id SERIAL PRIMARY KEY,
      report_id VARCHAR(255) UNIQUE NOT NULL,
      quarter VARCHAR(10) NOT NULL,
      importer_name VARCHAR(255) NOT NULL,
      importer_eori VARCHAR(50) NOT NULL,
      total_shipments INTEGER NOT NULL,
      total_mass_tonnes DECIMAL(12, 3) NOT NULL,
      total_emissions_tco2 DECIMAL(12, 3) NOT NULL,
      is_valid BOOLEAN DEFAULT false,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      submitted_at TIMESTAMP
    );

    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_shipments_quarter ON shipments(quarter);
    CREATE INDEX IF NOT EXISTS idx_shipments_import_date ON shipments(import_date);
    CREATE INDEX IF NOT EXISTS idx_shipments_cn_code ON shipments(cn_code);
    CREATE INDEX IF NOT EXISTS idx_reports_quarter ON reports(quarter);

    -- Create updated_at trigger
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = CURRENT_TIMESTAMP;
      RETURN NEW;
    END;
    $$ language 'plpgsql';

    CREATE TRIGGER update_shipments_updated_at BEFORE UPDATE ON shipments
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

---
# ============================================================================
# Namespace Configuration
# ============================================================================

apiVersion: v1
kind: Namespace
metadata:
  name: gl-cbam
  labels:
    name: gl-cbam
    environment: production
    team: greenlang-cbam

---
# ============================================================================
# Resource Quotas
# ============================================================================

apiVersion: v1
kind: ResourceQuota
metadata:
  name: cbam-resource-quota
  namespace: gl-cbam
spec:
  hard:
    requests.cpu: "10"
    requests.memory: "20Gi"
    limits.cpu: "20"
    limits.memory: "40Gi"
    persistentvolumeclaims: "10"
    services.loadbalancers: "2"
    pods: "50"

---
# ============================================================================
# Limit Range
# ============================================================================

apiVersion: v1
kind: LimitRange
metadata:
  name: cbam-limit-range
  namespace: gl-cbam
spec:
  limits:
    - max:
        cpu: "4"
        memory: "8Gi"
      min:
        cpu: "100m"
        memory: "128Mi"
      default:
        cpu: "500m"
        memory: "512Mi"
      defaultRequest:
        cpu: "250m"
        memory: "256Mi"
      type: Container

# ============================================================================
# USAGE
# ============================================================================
#
# Apply:
#   kubectl apply -f k8s/configmap.yaml
#
# View ConfigMaps:
#   kubectl get configmap -n gl-cbam
#   kubectl describe configmap cbam-api-config -n gl-cbam
#
# View ConfigMap data:
#   kubectl get configmap cbam-api-config -n gl-cbam -o yaml
#
# Edit ConfigMap:
#   kubectl edit configmap cbam-api-config -n gl-cbam
#
# Restart pods to pick up new config:
#   kubectl rollout restart deployment/cbam-api -n gl-cbam
#
# View resource quota:
#   kubectl get resourcequota -n gl-cbam
#   kubectl describe resourcequota cbam-resource-quota -n gl-cbam
#
# ============================================================================
