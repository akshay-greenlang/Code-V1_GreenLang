# -*- coding: utf-8 -*-
"""
GL-ADAPT-NBS-002: Ecosystem Vulnerability Agent
===============================================

Assesses ecosystem vulnerability to climate change.

Author: GreenLang Team
Version: 1.0.0
"""

import hashlib
import json
import logging
from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Optional

from pydantic import BaseModel, Field

from greenlang.agents.base import AgentConfig, AgentResult, BaseAgent
from greenlang.utilities.determinism.clock import DeterministicClock

logger = logging.getLogger(__name__)


class VulnerabilityLevel(str, Enum):
    VERY_LOW = "very_low"
    LOW = "low"
    MODERATE = "moderate"
    HIGH = "high"
    VERY_HIGH = "very_high"
    CRITICAL = "critical"


class EcosystemType(str, Enum):
    TROPICAL_FOREST = "tropical_forest"
    TEMPERATE_FOREST = "temperate_forest"
    BOREAL_FOREST = "boreal_forest"
    GRASSLAND = "grassland"
    WETLAND = "wetland"
    CORAL_REEF = "coral_reef"
    MANGROVE = "mangrove"
    TUNDRA = "tundra"
    ALPINE = "alpine"


class EcosystemSite(BaseModel):
    site_id: str = Field(...)
    area_ha: float = Field(..., gt=0)
    ecosystem_type: EcosystemType = Field(...)
    species_richness: int = Field(default=100, ge=0)
    endemism_rate: float = Field(default=0.1, ge=0, le=1)
    fragmentation_index: float = Field(default=0.3, ge=0, le=1)
    connectivity_score: float = Field(default=0.6, ge=0, le=1)
    protection_status: str = Field(default="unprotected")


class EcosystemVulnerabilityAssessment(BaseModel):
    site_id: str = Field(...)
    ecosystem_type: EcosystemType = Field(...)
    sensitivity_score: float = Field(..., ge=0, le=100)
    exposure_score: float = Field(..., ge=0, le=100)
    adaptive_capacity_score: float = Field(..., ge=0, le=100)
    overall_vulnerability_score: float = Field(..., ge=0, le=100)
    vulnerability_level: VulnerabilityLevel = Field(...)
    key_stressors: List[str] = Field(...)
    recommended_interventions: List[str] = Field(...)


class EcosystemVulnerabilityInput(BaseModel):
    project_id: str = Field(...)
    sites: List[EcosystemSite] = Field(..., min_length=1)
    time_horizon: str = Field(default="2050")


class EcosystemVulnerabilityOutput(BaseModel):
    project_id: str = Field(...)
    calculation_date: datetime = Field(default_factory=DeterministicClock.now)
    total_area_ha: float = Field(...)
    critical_area_ha: float = Field(...)
    assessments: List[EcosystemVulnerabilityAssessment] = Field(...)
    provenance_hash: str = Field(...)


class EcosystemVulnerabilityAgent(BaseAgent):
    """GL-ADAPT-NBS-002: Ecosystem Vulnerability Agent"""

    AGENT_ID = "GL-ADAPT-NBS-002"
    AGENT_NAME = "Ecosystem Vulnerability Agent"
    VERSION = "1.0.0"

    # Inherent sensitivity by ecosystem type
    SENSITIVITY_FACTORS = {
        EcosystemType.CORAL_REEF: 95,
        EcosystemType.TUNDRA: 90,
        EcosystemType.ALPINE: 85,
        EcosystemType.MANGROVE: 75,
        EcosystemType.WETLAND: 70,
        EcosystemType.TROPICAL_FOREST: 65,
        EcosystemType.BOREAL_FOREST: 60,
        EcosystemType.TEMPERATE_FOREST: 50,
        EcosystemType.GRASSLAND: 45,
    }

    def __init__(self, config: Optional[AgentConfig] = None):
        if config is None:
            config = AgentConfig(name=self.AGENT_NAME, description="Ecosystem vulnerability assessment", version=self.VERSION)
        super().__init__(config)

    def execute(self, input_data: Dict[str, Any]) -> AgentResult:
        try:
            agent_input = EcosystemVulnerabilityInput(**input_data)
            assessments = []
            critical_area = 0.0

            for site in agent_input.sites:
                assessment = self._assess_site(site)
                assessments.append(assessment)
                if assessment.vulnerability_level in (VulnerabilityLevel.CRITICAL, VulnerabilityLevel.VERY_HIGH):
                    critical_area += site.area_ha

            total_area = sum(s.area_ha for s in agent_input.sites)

            provenance_hash = hashlib.sha256(
                json.dumps({"agent": self.AGENT_ID, "ts": DeterministicClock.now().isoformat()}).encode()
            ).hexdigest()

            output = EcosystemVulnerabilityOutput(
                project_id=agent_input.project_id,
                total_area_ha=total_area,
                critical_area_ha=critical_area,
                assessments=assessments,
                provenance_hash=provenance_hash
            )

            return AgentResult(success=True, data=output.model_dump())

        except Exception as e:
            return AgentResult(success=False, error=str(e))

    def _assess_site(self, site: EcosystemSite) -> EcosystemVulnerabilityAssessment:
        # Sensitivity
        base_sensitivity = self.SENSITIVITY_FACTORS.get(site.ecosystem_type, 50)
        sensitivity = base_sensitivity + (site.endemism_rate * 20)
        sensitivity = min(100, sensitivity)

        # Exposure (simplified)
        exposure = 50 + (site.fragmentation_index * 30) + ((1 - site.connectivity_score) * 20)
        exposure = min(100, exposure)

        # Adaptive capacity
        adaptive_capacity = (
            site.connectivity_score * 40 +
            (1 - site.fragmentation_index) * 30 +
            (30 if site.protection_status != "unprotected" else 0)
        )
        adaptive_capacity = min(100, adaptive_capacity)

        # Overall vulnerability = (Sensitivity + Exposure - Adaptive Capacity) / 2
        overall = (sensitivity + exposure - adaptive_capacity) / 2
        overall = max(0, min(100, overall))

        # Vulnerability level
        if overall >= 80:
            level = VulnerabilityLevel.CRITICAL
        elif overall >= 65:
            level = VulnerabilityLevel.VERY_HIGH
        elif overall >= 50:
            level = VulnerabilityLevel.HIGH
        elif overall >= 35:
            level = VulnerabilityLevel.MODERATE
        elif overall >= 20:
            level = VulnerabilityLevel.LOW
        else:
            level = VulnerabilityLevel.VERY_LOW

        # Key stressors
        stressors = []
        if site.ecosystem_type == EcosystemType.CORAL_REEF:
            stressors = ["Ocean acidification", "Sea temperature rise", "Bleaching"]
        elif site.ecosystem_type in (EcosystemType.TUNDRA, EcosystemType.ALPINE):
            stressors = ["Temperature increase", "Permafrost thaw", "Habitat loss"]
        elif site.fragmentation_index > 0.5:
            stressors = ["Habitat fragmentation", "Edge effects", "Isolation"]
        else:
            stressors = ["Climate shift", "Precipitation changes"]

        # Interventions
        interventions = []
        if site.connectivity_score < 0.5:
            interventions.append("Establish wildlife corridors")
        if site.fragmentation_index > 0.4:
            interventions.append("Habitat restoration")
        if site.protection_status == "unprotected":
            interventions.append("Protected area designation")
        interventions.append("Climate-adaptive management")

        return EcosystemVulnerabilityAssessment(
            site_id=site.site_id,
            ecosystem_type=site.ecosystem_type,
            sensitivity_score=round(sensitivity, 1),
            exposure_score=round(exposure, 1),
            adaptive_capacity_score=round(adaptive_capacity, 1),
            overall_vulnerability_score=round(overall, 1),
            vulnerability_level=level,
            key_stressors=stressors,
            recommended_interventions=interventions
        )
