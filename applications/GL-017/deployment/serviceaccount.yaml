# =============================================================================
# GL-017 CONDENSYNC - Service Account and RBAC
# Kubernetes service account with minimal required permissions
# =============================================================================

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-017-condensync-sa
  namespace: greenlang
  labels:
    app: gl-017-condensync
    app.kubernetes.io/name: condensync
    app.kubernetes.io/instance: gl-017
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: rbac
    app.kubernetes.io/part-of: greenlang
  annotations:
    # AWS IAM Role for Service Account (IRSA)
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/gl-017-condensync-role"
    # Azure Workload Identity
    azure.workload.identity/client-id: "CLIENT_ID_PLACEHOLDER"
    # GCP Workload Identity
    iam.gke.io/gcp-service-account: "gl-017-condensync@PROJECT_ID.iam.gserviceaccount.com"
automountServiceAccountToken: false

---
# Role - Namespace-scoped permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-017-condensync-role
  namespace: greenlang
  labels:
    app: gl-017-condensync
    app.kubernetes.io/name: condensync
    app.kubernetes.io/instance: gl-017
    app.kubernetes.io/component: rbac
rules:
  # Read ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
    resourceNames: ["gl-017-condensync-config"]
  # Read Secrets (limited)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
    resourceNames: ["gl-017-condensync-secrets", "gl-017-condensync-tls"]
  # Read own pod info for health checks
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  # Events for debugging
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

---
# RoleBinding - Bind Role to ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-017-condensync-rolebinding
  namespace: greenlang
  labels:
    app: gl-017-condensync
    app.kubernetes.io/name: condensync
    app.kubernetes.io/instance: gl-017
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: gl-017-condensync-sa
    namespace: greenlang
roleRef:
  kind: Role
  name: gl-017-condensync-role
  apiGroup: rbac.authorization.k8s.io

---
# PodDisruptionBudget for high availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gl-017-condensync-pdb
  namespace: greenlang
  labels:
    app: gl-017-condensync
    app.kubernetes.io/name: condensync
    app.kubernetes.io/instance: gl-017
    app.kubernetes.io/component: availability
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: gl-017-condensync
