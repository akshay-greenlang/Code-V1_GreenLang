name: CBAM Importer Copilot CI/CD

on:
  push:
    branches: [master, develop]
    paths:
      - 'CBAM-Importer-Copilot/**'
      - '.github/workflows/cbam-ci.yaml'
  pull_request:
    branches: [master]
    paths:
      - 'CBAM-Importer-Copilot/**'

env:
  PYTHON_VERSION: '3.11'
  APP_PATH: CBAM-Importer-Copilot

jobs:
  # ===========================================================================
  # JOB 1: LINTING & CODE QUALITY
  # ===========================================================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd $APP_PATH
          python -m pip install --upgrade pip
          pip install ruff black isort mypy
          pip install -r requirements.txt

      - name: Run Ruff (Fast linter)
        run: |
          cd $APP_PATH
          ruff check . --line-length=100 --exit-non-zero-on-fix

      - name: Run Black (Code formatter check)
        run: |
          cd $APP_PATH
          black --check --line-length=100 .

      - name: Run isort (Import sorting check)
        run: |
          cd $APP_PATH
          isort --check --profile black --line-length=100 .

      - name: Run MyPy (Type checking)
        run: |
          cd $APP_PATH
          mypy agents/ --ignore-missing-imports --warn-redundant-casts
        continue-on-error: true  # Don't block on type errors initially

  # ===========================================================================
  # JOB 2: SECURITY SCANNING
  # ===========================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit safety detect-secrets

      - name: Run Bandit (Security linter)
        run: |
          cd $APP_PATH
          bandit -r agents/ backend/ cli/ -ll -i

      - name: Run Safety (Dependency vulnerability scan)
        run: |
          cd $APP_PATH
          safety check --json || echo "Safety check found vulnerabilities"
        continue-on-error: true  # Don't block on vulnerabilities initially

      - name: Run detect-secrets
        run: |
          cd $APP_PATH
          detect-secrets scan --baseline .secrets.baseline || echo "Secrets detected"
        continue-on-error: true

      - name: CBAM-specific validation
        run: |
          cd $APP_PATH
          # Validate emission factors database
          python -c "
          import importlib.util
          spec = importlib.util.spec_from_file_location('ef', 'data/emission_factors.py')
          ef = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(ef)
          assert len(ef.EMISSION_FACTORS_DB) >= 14, 'Missing emission factors'
          print('✓ Emission factors database valid')
          "

          # Validate CN codes JSON
          python -c "
          import json
          with open('data/cn_codes.json') as f:
              cn_codes = json.load(f)
          assert len(cn_codes) >= 30, 'Missing CN codes'
          print('✓ CN codes database valid')
          "

          # Validate CBAM rules YAML
          python -c "
          import yaml
          with open('rules/cbam_rules.yaml') as f:
              rules = yaml.safe_load(f)
          assert 'rules' in rules, 'CBAM rules malformed'
          assert len(rules['rules']) >= 50, 'Missing CBAM rules'
          print('✓ CBAM rules valid')
          "

  # ===========================================================================
  # JOB 3: TESTING
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd $APP_PATH
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock

      - name: Run unit tests with coverage
        run: |
          cd $APP_PATH
          pytest tests/ \
            -v \
            --cov=agents \
            --cov=backend \
            --cov=cli \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=70
        env:
          PYTHONPATH: ${{ github.workspace }}/${{ env.APP_PATH }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ${{ env.APP_PATH }}/coverage.xml
          flags: unittests
          name: cbam-importer-coverage
          fail_ci_if_error: false

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.APP_PATH }}/htmlcov/

  # ===========================================================================
  # JOB 4: INTEGRATION TESTS
  # ===========================================================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: greenlang_test
          POSTGRES_USER: greenlang
          POSTGRES_PASSWORD: testpassword
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd $APP_PATH
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run integration tests
        run: |
          cd $APP_PATH
          pytest tests/integration/ -v
        env:
          DATABASE_URL: postgresql://greenlang:testpassword@localhost:5432/greenlang_test
          PYTHONPATH: ${{ github.workspace }}/${{ env.APP_PATH }}

  # ===========================================================================
  # JOB 5: END-TO-END TESTS
  # ===========================================================================
  e2e-test:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd $APP_PATH
          pip install -r requirements.txt

      - name: Run end-to-end pipeline test
        run: |
          cd $APP_PATH
          python cbam_pipeline.py \
            --input examples/demo_shipments.csv \
            --output /tmp/e2e_test_report.json \
            --summary /tmp/e2e_test_summary.md \
            --importer-name "E2E Test Company" \
            --importer-country NL \
            --importer-eori NL000000000000 \
            --declarant-name "CI/CD Test" \
            --declarant-position "Automated Test"

      - name: Validate E2E report
        run: |
          cd $APP_PATH
          python -c "
          import json
          with open('/tmp/e2e_test_report.json') as f:
              report = json.load(f)
          assert report['validation_results']['is_valid'], 'Report validation failed'
          assert 'report_metadata' in report, 'Missing report metadata'
          assert 'emissions_summary' in report, 'Missing emissions summary'
          print('✓ E2E test report valid')
          "

      - name: Upload E2E artifacts
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: |
            /tmp/e2e_test_report.json
            /tmp/e2e_test_summary.md

  # ===========================================================================
  # JOB 6: DOCKER BUILD
  # ===========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: greenlang/cbam-importer
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.APP_PATH }}
          file: ${{ env.APP_PATH }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=greenlang/cbam-importer:buildcache
          cache-to: type=registry,ref=greenlang/cbam-importer:buildcache,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Image scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: greenlang/cbam-importer:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # JOB 7: DEPLOY TO STAGING (OPTIONAL)
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, e2e-test]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://cbam-staging.greenlang.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Deploy to staging
        run: |
          cd $APP_PATH
          kubectl set image deployment/cbam-importer \
            cbam-importer=greenlang/cbam-importer:${{ github.sha }} \
            -n greenlang-staging

          kubectl rollout status deployment/cbam-importer -n greenlang-staging --timeout=5m

      - name: Run smoke tests
        run: |
          sleep 30  # Wait for deployment to stabilize
          STAGING_URL=https://cbam-staging.greenlang.io
          curl -f $STAGING_URL/health || exit 1
          curl -f $STAGING_URL/health/agents || exit 1
          echo "✓ Staging deployment healthy"

  # ===========================================================================
  # JOB 8: DEPLOY TO PRODUCTION (MANUAL APPROVAL)
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, e2e-test]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    environment:
      name: production
      url: https://cbam.greenlang.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}

      - name: Deploy to production
        run: |
          cd $APP_PATH
          kubectl set image deployment/cbam-importer \
            cbam-importer=greenlang/cbam-importer:${{ github.sha }} \
            -n greenlang

          kubectl rollout status deployment/cbam-importer -n greenlang --timeout=10m

      - name: Run production smoke tests
        run: |
          sleep 60  # Wait for deployment to fully stabilize
          PROD_URL=https://cbam.greenlang.io
          curl -f $PROD_URL/health || exit 1
          curl -f $PROD_URL/health/agents || exit 1
          curl -f $PROD_URL/health/database || exit 1
          echo "✓ Production deployment healthy"

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            CBAM Importer Copilot deployed to production
            Version: ${{ github.sha }}
            Deployed by: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()

# ==============================================================================
# WORKFLOW NOTIFICATIONS
# ==============================================================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, security, test, integration-test, e2e-test, build]
    if: always()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: github.event_name == 'push'
