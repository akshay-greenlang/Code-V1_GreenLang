# ============================================================================
# GL-CBAM-APP - Kubernetes Deployment
# ============================================================================
# Production-grade deployment with:
# - Health checks (liveness, readiness, startup)
# - Resource limits and requests
# - Horizontal Pod Autoscaling
# - Rolling update strategy
# - Security best practices
# ============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cbam-api
  namespace: gl-cbam
  labels:
    app: cbam-api
    component: backend
    tier: application
    version: v1.0.0
    managed-by: kubernetes
  annotations:
    description: "GL-CBAM-APP Backend API Deployment"
    maintainer: "GreenLang CBAM Team"
spec:
  # Replica configuration
  replicas: 3
  revisionHistoryLimit: 10

  # Deployment strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  # Selector
  selector:
    matchLabels:
      app: cbam-api
      component: backend

  # Pod template
  template:
    metadata:
      labels:
        app: cbam-api
        component: backend
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
    spec:
      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # Service account
      serviceAccountName: cbam-api-sa

      # DNS configuration
      dnsPolicy: ClusterFirst

      # Init containers (database migration, etc.)
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z cbam-postgres 5432; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

        - name: wait-for-redis
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z cbam-redis 6379; do
                echo "Waiting for Redis..."
                sleep 2
              done
              echo "Redis is ready!"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

      # Main container
      containers:
        - name: api
          image: ghcr.io/greenlang/gl-cbam-app:v1.0.0
          imagePullPolicy: IfNotPresent

          # Ports
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          # Environment variables from ConfigMap
          envFrom:
            - configMapRef:
                name: cbam-api-config
            - secretRef:
                name: cbam-api-secrets

          # Resource limits
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

          # Startup probe (for slow-starting containers)
          startupProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 30

          # Liveness probe (container health)
          livenessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          # Readiness probe (traffic routing)
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          # Volume mounts
          volumeMounts:
            - name: data
              mountPath: /app/data
            - name: logs
              mountPath: /app/logs
            - name: output
              mountPath: /app/output
            - name: uploads
              mountPath: /app/uploads
            - name: config
              mountPath: /app/config
              readOnly: true
            - name: rules
              mountPath: /app/rules
              readOnly: true
            - name: schemas
              mountPath: /app/schemas
              readOnly: true

          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

      # Volumes
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: cbam-api-data
        - name: logs
          persistentVolumeClaim:
            claimName: cbam-api-logs
        - name: output
          persistentVolumeClaim:
            claimName: cbam-api-output
        - name: uploads
          persistentVolumeClaim:
            claimName: cbam-api-uploads
        - name: config
          configMap:
            name: cbam-api-config-files
        - name: rules
          configMap:
            name: cbam-rules
        - name: schemas
          configMap:
            name: cbam-schemas

      # Affinity and tolerations
      affinity:
        # Pod anti-affinity (distribute across nodes)
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - cbam-api
                topologyKey: kubernetes.io/hostname

      # Termination grace period
      terminationGracePeriodSeconds: 30

---
# ============================================================================
# Persistent Volume Claims
# ============================================================================

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cbam-api-data
  namespace: gl-cbam
  labels:
    app: cbam-api
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cbam-api-logs
  namespace: gl-cbam
  labels:
    app: cbam-api
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cbam-api-output
  namespace: gl-cbam
  labels:
    app: cbam-api
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 20Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cbam-api-uploads
  namespace: gl-cbam
  labels:
    app: cbam-api
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 50Gi
  storageClassName: standard

---
# ============================================================================
# Horizontal Pod Autoscaler
# ============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cbam-api-hpa
  namespace: gl-cbam
  labels:
    app: cbam-api
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cbam-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 60
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max

---
# ============================================================================
# Service Account
# ============================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: cbam-api-sa
  namespace: gl-cbam
  labels:
    app: cbam-api
automountServiceAccountToken: true

---
# ============================================================================
# Pod Disruption Budget
# ============================================================================

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cbam-api-pdb
  namespace: gl-cbam
  labels:
    app: cbam-api
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: cbam-api
      component: backend

# ============================================================================
# USAGE
# ============================================================================
#
# Apply:
#   kubectl apply -f k8s/deployment.yaml
#
# View:
#   kubectl get deployment cbam-api -n gl-cbam
#   kubectl get pods -n gl-cbam -l app=cbam-api
#   kubectl get hpa cbam-api-hpa -n gl-cbam
#
# Logs:
#   kubectl logs -f deployment/cbam-api -n gl-cbam
#   kubectl logs -f <pod-name> -n gl-cbam
#
# Scale manually:
#   kubectl scale deployment cbam-api --replicas=5 -n gl-cbam
#
# Restart:
#   kubectl rollout restart deployment/cbam-api -n gl-cbam
#
# Rollback:
#   kubectl rollout undo deployment/cbam-api -n gl-cbam
#
# ============================================================================
