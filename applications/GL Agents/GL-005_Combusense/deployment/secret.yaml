# GL-005 CombustionControlAgent - External Secrets Configuration
#
# SECURITY NOTICE:
# This file uses External Secrets Operator (ESO) to fetch secrets from external vaults.
# NO SECRETS are stored in this repository.
#
# Prerequisites:
# 1. Install External Secrets Operator: https://external-secrets.io/
# 2. Configure SecretStore to connect to your secret backend (AWS Secrets Manager,
#    HashiCorp Vault, Azure Key Vault, GCP Secret Manager, etc.)
# 3. Store actual secrets in your secret backend
#
# Reference: https://external-secrets.io/latest/

---
# External Secrets Operator - Main Configuration
# This pulls secrets from your configured secret backend
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-005-secrets
  namespace: greenlang
  labels:
    app: gl-005-combustion-control
    agent: "GL-005"
  annotations:
    description: "External secrets for GL-005 CombustionControlAgent"
spec:
  # Refresh secrets every hour
  refreshInterval: 1h

  # Reference to SecretStore (configure this separately)
  secretStoreRef:
    name: greenlang-secret-store
    kind: SecretStore

  # Target Kubernetes secret that will be created
  target:
    name: gl-005-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Database configuration from external vault
        DATABASE_URL: "{{ .database_url }}"

        # Security keys from external vault
        JWT_SECRET: "{{ .jwt_secret }}"

        # Redis configuration
        REDIS_URL: "{{ .redis_url }}"

        # AI API keys (if needed)
        ANTHROPIC_API_KEY: "{{ .anthropic_api_key | default \"\" }}"
        OPENAI_API_KEY: "{{ .openai_api_key | default \"\" }}"

        # Industrial protocol credentials
        OPCUA_USERNAME: "{{ .opcua_username | default \"\" }}"
        OPCUA_PASSWORD: "{{ .opcua_password | default \"\" }}"
        MQTT_USERNAME: "{{ .mqtt_username | default \"\" }}"
        MQTT_PASSWORD: "{{ .mqtt_password | default \"\" }}"

  # Map of external secret keys to fetch
  data:
    # Database credentials
    - secretKey: database_url
      remoteRef:
        key: greenlang/gl-005/database_url

    # JWT secret key (CRITICAL - minimum 48 characters for production)
    - secretKey: jwt_secret
      remoteRef:
        key: greenlang/gl-005/jwt_secret

    # Redis connection
    - secretKey: redis_url
      remoteRef:
        key: greenlang/gl-005/redis_url

    # AI API keys
    - secretKey: anthropic_api_key
      remoteRef:
        key: greenlang/gl-005/anthropic_api_key

    - secretKey: openai_api_key
      remoteRef:
        key: greenlang/gl-005/openai_api_key

    # Industrial protocol credentials
    - secretKey: opcua_username
      remoteRef:
        key: greenlang/gl-005/opcua_username

    - secretKey: opcua_password
      remoteRef:
        key: greenlang/gl-005/opcua_password

    - secretKey: mqtt_username
      remoteRef:
        key: greenlang/gl-005/mqtt_username

    - secretKey: mqtt_password
      remoteRef:
        key: greenlang/gl-005/mqtt_password

---
# SecretStore Configuration Examples
# Choose one based on your infrastructure

# Example 1: AWS Secrets Manager
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: greenlang-secret-store
#   namespace: greenlang
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: external-secrets-sa

---
# Example 2: HashiCorp Vault
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: greenlang-secret-store
#   namespace: greenlang
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "greenlang-role"
#           serviceAccountRef:
#             name: external-secrets-sa

---
# Example 3: Azure Key Vault
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: greenlang-secret-store
#   namespace: greenlang
# spec:
#   provider:
#     azurekv:
#       vaultUrl: "https://my-keyvault.vault.azure.net"
#       authType: WorkloadIdentity
#       serviceAccountRef:
#         name: external-secrets-sa

---
# SECRET GENERATION GUIDE
#
# Generate secure secrets using these commands:
#
# 1. JWT Secret (minimum 48 characters for production):
#    python -c 'import secrets; print(secrets.token_urlsafe(48))'
#
# 2. Database Password (32 characters):
#    python -c 'import secrets; print(secrets.token_urlsafe(32))'
#
# 3. Store in your secret backend:
#
#    AWS Secrets Manager:
#    aws secretsmanager create-secret \
#      --name greenlang/gl-005/jwt_secret \
#      --secret-string "$(python -c 'import secrets; print(secrets.token_urlsafe(48))')"
#
#    HashiCorp Vault:
#    vault kv put secret/greenlang/gl-005/jwt_secret \
#      value="$(python -c 'import secrets; print(secrets.token_urlsafe(48))')"
#
# NEVER commit actual secrets to version control!
