# GL-003 UNIFIEDSTEAM - Helm Values
# Steam System Optimization Agent
#
# Default values for unifiedsteam chart.
# Override these values in your environment-specific values files.

# ==============================================================================
# Global Settings
# ==============================================================================
global:
  # Image pull secrets for private registries
  imagePullSecrets: []
  # - name: regcred

  # Storage class for persistent volumes
  storageClass: ""

  # Environment name
  environment: production

# ==============================================================================
# Application Settings
# ==============================================================================
replicaCount: 3

image:
  repository: greenlang/gl-003-unifiedsteam
  pullPolicy: IfNotPresent
  tag: ""  # Defaults to appVersion

imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

# ==============================================================================
# Service Account
# ==============================================================================
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automountServiceAccountToken: true

# ==============================================================================
# Pod Settings
# ==============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

podLabels:
  agent-id: gl-003
  tier: steam-systems

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL

# ==============================================================================
# Container Ports
# ==============================================================================
containerPorts:
  http: 8080
  grpc: 50051
  metrics: 9090

# ==============================================================================
# Service Configuration
# ==============================================================================
service:
  type: ClusterIP
  http:
    port: 80
    targetPort: http
  grpc:
    port: 50051
    targetPort: grpc
  metrics:
    port: 9090
    targetPort: metrics
  annotations: {}

# ==============================================================================
# Ingress Configuration
# ==============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
  hosts:
    - host: steam.greenlang.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: unifiedsteam-tls
      hosts:
        - steam.greenlang.io

# gRPC Ingress
grpcIngress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
  hosts:
    - host: grpc.steam.greenlang.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: unifiedsteam-grpc-tls
      hosts:
        - grpc.steam.greenlang.io

# ==============================================================================
# Resource Limits
# ==============================================================================
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# ==============================================================================
# Autoscaling
# ==============================================================================
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60

# ==============================================================================
# Pod Disruption Budget
# ==============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 2
  # maxUnavailable: 1

# ==============================================================================
# Health Probes
# ==============================================================================
livenessProbe:
  httpGet:
    path: /health/live
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health/ready
    port: http
  initialDelaySeconds: 15
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health/live
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  failureThreshold: 30

# ==============================================================================
# Node Scheduling
# ==============================================================================
nodeSelector: {}

tolerations: []
# - key: "dedicated"
#   operator: "Equal"
#   value: "greenlang"
#   effect: "NoSchedule"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - unifiedsteam
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: unifiedsteam

# ==============================================================================
# Volumes
# ==============================================================================
persistence:
  data:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 20Gi
  models:
    enabled: true
    storageClass: ""
    accessMode: ReadOnlyMany
    size: 10Gi

# ==============================================================================
# Environment Variables
# ==============================================================================
env:
  UNIFIEDSTEAM_ENV: production
  UNIFIEDSTEAM_LOG_LEVEL: INFO
  UNIFIEDSTEAM_API_PORT: "8080"
  UNIFIEDSTEAM_GRPC_PORT: "50051"
  UNIFIEDSTEAM_METRICS_PORT: "9090"

# Environment from ConfigMap
envFromConfigMap: []
# - unifiedsteam-config

# Environment from Secret
envFromSecret: []
# - unifiedsteam-secrets

# ==============================================================================
# Application Configuration
# ==============================================================================
config:
  # Kafka settings
  kafka:
    brokers: "kafka-headless:9092"
    consumerGroup: "unifiedsteam-consumer-group"
    autoOffsetReset: "earliest"
    topics:
      - steam.sensor.readings
      - steam.control.commands
      - steam.optimization.results

  # OPC-UA settings
  opcua:
    endpoint: "opc.tcp://scada.industrial.local:4840"
    securityMode: "SignAndEncrypt"
    securityPolicy: "Basic256Sha256"
    subscriptionInterval: 500

  # Redis settings
  redis:
    host: "redis-master"
    port: 6379
    db: 0
    maxConnections: 100

  # Optimization settings
  optimization:
    interval: 60
    horizon: 300
    minEfficiency: 0.75
    maxIterations: 1000

  # Safety limits
  safety:
    maxPressure: 1200000
    minPressure: 100000
    maxTemperature: 250
    minTemperature: 100

  # OpenTelemetry
  otel:
    endpoint: "http://otel-collector:4317"
    traceRatio: 0.1

  # Feature flags
  features:
    enableRealTimeOptimization: true
    enablePredictiveMaintenance: true
    enableCausalAnalysis: true
    enableExplainability: true
    enableAutomaticControl: false

# ==============================================================================
# Secrets (use external secrets in production)
# ==============================================================================
secrets:
  # Database
  databaseUrl: ""  # Override in production
  databaseUsername: "unifiedsteam"
  databasePassword: ""  # Use external secret

  # API
  apiSecretKey: ""  # Use external secret

  # Redis
  redisPassword: ""  # Use external secret

  # OPC-UA
  opcuaUsername: ""
  opcuaPassword: ""

# ==============================================================================
# External Secrets (for secrets management integration)
# ==============================================================================
externalSecrets:
  enabled: false
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  refreshInterval: "1h"
  data: []
  # - secretKey: database-url
  #   remoteRef:
  #     key: /greenlang/gl-003/database
  #     property: url

# ==============================================================================
# Service Monitor (Prometheus Operator)
# ==============================================================================
serviceMonitor:
  enabled: true
  namespace: ""
  interval: 15s
  scrapeTimeout: 10s
  labels:
    release: prometheus
  metricRelabelings: []
  relabelings: []

# ==============================================================================
# Prometheus Rules
# ==============================================================================
prometheusRule:
  enabled: true
  namespace: ""
  labels:
    release: prometheus
  rules: []
  # Custom rules are added here or use default rules from templates

# ==============================================================================
# Network Policy
# ==============================================================================
networkPolicy:
  enabled: true
  ingress:
    allowFromNamespaces:
      - ingress-nginx
      - observability
    allowFromPodLabels: {}
  egress:
    allowToKafka: true
    allowToRedis: true
    allowToPostgres: true
    allowToOpcua: true
    allowToOtel: true
    customRules: []

# ==============================================================================
# Init Containers
# ==============================================================================
initContainers:
  waitForKafka:
    enabled: true
    image: busybox:1.36
  waitForRedis:
    enabled: true
    image: busybox:1.36
  waitForPostgres:
    enabled: false
    image: busybox:1.36

# ==============================================================================
# Sidecar Containers
# ==============================================================================
sidecars: []
# - name: log-shipper
#   image: fluent/fluent-bit:latest
#   volumeMounts:
#     - name: logs
#       mountPath: /app/logs

# ==============================================================================
# Dependencies Configuration
# ==============================================================================

# Kafka (Bitnami chart)
kafka:
  enabled: false  # Use external Kafka in production
  replicaCount: 3
  auth:
    clientProtocol: plaintext
  persistence:
    enabled: true
    size: 50Gi

# Redis (Bitnami chart)
redis:
  enabled: false  # Use external Redis in production
  architecture: standalone
  auth:
    enabled: true
  master:
    persistence:
      enabled: true
      size: 10Gi

# PostgreSQL (Bitnami chart)
postgresql:
  enabled: false  # Use external PostgreSQL in production
  auth:
    database: unifiedsteam
    username: unifiedsteam
  primary:
    persistence:
      enabled: true
      size: 50Gi

# Prometheus (kube-prometheus-stack)
prometheus:
  enabled: false  # Use existing Prometheus installation

# ==============================================================================
# Testing
# ==============================================================================
tests:
  enabled: true
  image:
    repository: curlimages/curl
    tag: latest
