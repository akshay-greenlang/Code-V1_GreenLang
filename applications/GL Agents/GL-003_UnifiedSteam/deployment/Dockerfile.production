# =============================================================================
# GL-003 UNIFIEDSTEAM - Production Dockerfile
# Steam System Optimization Agent
# =============================================================================
# Multi-stage build for optimized production image:
# - Stage 1: Build dependencies and compile Python packages
# - Stage 2: Production runtime with minimal attack surface
#
# Image size optimization:
# - Uses slim base image
# - Multi-stage build eliminates build tools
# - Virtual environment for clean dependency isolation
# - .dockerignore to exclude unnecessary files
#
# Security hardening:
# - Non-root user
# - Read-only filesystem compatible
# - No shell in final image (optional)
# - Minimal runtime dependencies
# =============================================================================

# =============================================================================
# Build Arguments
# =============================================================================
ARG PYTHON_VERSION=3.11
ARG ALPINE_VERSION=3.19
ARG BUILD_DATE
ARG GIT_COMMIT
ARG VERSION=1.0.0

# =============================================================================
# Stage 1: Builder - Compile dependencies
# =============================================================================
FROM python:${PYTHON_VERSION}-slim-bookworm AS builder

# Build arguments
ARG VERSION

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    g++ \
    gfortran \
    libopenblas-dev \
    liblapack-dev \
    libpq-dev \
    pkg-config \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /build

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip, setuptools, and wheel
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Copy only requirements first for Docker layer caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Optional: Compile Python bytecode for faster startup
RUN python -m compileall /opt/venv/lib/python*/site-packages/ || true

# =============================================================================
# Stage 2: Production Runtime
# =============================================================================
FROM python:${PYTHON_VERSION}-slim-bookworm AS production

# Build arguments for labels
ARG VERSION
ARG BUILD_DATE
ARG GIT_COMMIT

# =============================================================================
# Image Labels (OCI Standard)
# =============================================================================
LABEL maintainer="GreenLang DevOps <devops@greenlang.io>"
LABEL org.opencontainers.image.title="GL-003 UNIFIEDSTEAM"
LABEL org.opencontainers.image.description="Steam System Optimization Agent with Real-time Control and Predictive Analytics"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${GIT_COMMIT}"
LABEL org.opencontainers.image.vendor="GreenLang"
LABEL org.opencontainers.image.source="https://github.com/greenlang/gl-003-unifiedsteam"
LABEL org.opencontainers.image.documentation="https://docs.greenlang.io/agents/gl-003"
LABEL org.opencontainers.image.licenses="Proprietary"
LABEL org.opencontainers.image.base.name="python:${PYTHON_VERSION}-slim-bookworm"

# Application labels
LABEL app.kubernetes.io/name="unifiedsteam"
LABEL app.kubernetes.io/component="steam-optimizer"
LABEL app.kubernetes.io/part-of="greenlang"
LABEL agent-id="gl-003"

# =============================================================================
# Install Runtime Dependencies Only
# =============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Runtime libraries
    libopenblas0 \
    libgomp1 \
    libpq5 \
    # Utilities
    curl \
    ca-certificates \
    tini \
    # Timezone data
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && rm -rf /var/cache/apt/archives/*

# =============================================================================
# Security: Create Non-Root User
# =============================================================================
RUN groupadd --gid 1000 unifiedsteam \
    && useradd --uid 1000 --gid 1000 --shell /sbin/nologin --create-home unifiedsteam

# =============================================================================
# Copy Virtual Environment from Builder
# =============================================================================
COPY --from=builder /opt/venv /opt/venv

# =============================================================================
# Set Environment Variables
# =============================================================================
ENV PATH="/opt/venv/bin:$PATH"
ENV PYTHONPATH="/app"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PYTHONFAULTHANDLER=1
ENV PYTHONHASHSEED=random

# Application environment
ENV UNIFIEDSTEAM_ENV=production
ENV UNIFIEDSTEAM_LOG_LEVEL=INFO
ENV UNIFIEDSTEAM_API_PORT=8080
ENV UNIFIEDSTEAM_GRPC_PORT=50051
ENV UNIFIEDSTEAM_METRICS_PORT=9090

# Timezone
ENV TZ=UTC

# =============================================================================
# Set Working Directory
# =============================================================================
WORKDIR /app

# =============================================================================
# Create Application Directories
# =============================================================================
RUN mkdir -p /app/config /app/data /app/logs /app/models /app/.cache \
    && chown -R unifiedsteam:unifiedsteam /app

# =============================================================================
# Copy Application Code
# =============================================================================
# Copy application source code
COPY --chown=unifiedsteam:unifiedsteam api/ /app/api/
COPY --chown=unifiedsteam:unifiedsteam core/ /app/core/
COPY --chown=unifiedsteam:unifiedsteam optimization/ /app/optimization/
COPY --chown=unifiedsteam:unifiedsteam thermodynamics/ /app/thermodynamics/
COPY --chown=unifiedsteam:unifiedsteam control/ /app/control/
COPY --chown=unifiedsteam:unifiedsteam calculators/ /app/calculators/
COPY --chown=unifiedsteam:unifiedsteam integration/ /app/integration/
COPY --chown=unifiedsteam:unifiedsteam monitoring/ /app/monitoring/
COPY --chown=unifiedsteam:unifiedsteam safety/ /app/safety/
COPY --chown=unifiedsteam:unifiedsteam audit/ /app/audit/
COPY --chown=unifiedsteam:unifiedsteam explainability/ /app/explainability/
COPY --chown=unifiedsteam:unifiedsteam uncertainty/ /app/uncertainty/
COPY --chown=unifiedsteam:unifiedsteam streaming/ /app/streaming/
COPY --chown=unifiedsteam:unifiedsteam causal/ /app/causal/

# Copy main module files
COPY --chown=unifiedsteam:unifiedsteam __init__.py /app/
COPY --chown=unifiedsteam:unifiedsteam cli.py /app/

# =============================================================================
# Switch to Non-Root User
# =============================================================================
USER unifiedsteam

# =============================================================================
# Expose Ports
# =============================================================================
# REST/GraphQL API
EXPOSE 8080
# gRPC API
EXPOSE 50051
# Prometheus metrics
EXPOSE 9090

# =============================================================================
# Health Check
# =============================================================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/api/v1/health || exit 1

# =============================================================================
# Use Tini as Init Process
# =============================================================================
# Tini properly handles signals and reaps zombie processes
ENTRYPOINT ["/usr/bin/tini", "--"]

# =============================================================================
# Default Command
# =============================================================================
# Run FastAPI with Uvicorn
CMD ["uvicorn", "api.rest_api:app", \
     "--host", "0.0.0.0", \
     "--port", "8080", \
     "--workers", "4", \
     "--loop", "uvloop", \
     "--http", "h11", \
     "--log-level", "info", \
     "--access-log", \
     "--proxy-headers", \
     "--forwarded-allow-ips", "*"]

# =============================================================================
# Alternative Commands (use in docker-compose or K8s)
# =============================================================================
# gRPC Server:
# CMD ["python", "-m", "api.grpc_server"]
#
# Kafka Consumer:
# CMD ["python", "-m", "streaming.kafka_consumer"]
#
# CLI Mode:
# CMD ["python", "-m", "cli"]
#
# Development with auto-reload:
# CMD ["uvicorn", "api.rest_api:app", "--host", "0.0.0.0", "--port", "8080", "--reload"]
