# =============================================================================
# GL-003 UNIFIEDSTEAM - Horizontal Pod Autoscaler
# Steam System Optimization Agent
# =============================================================================
# Autoscaling based on:
# - CPU utilization
# - Memory utilization
# - Custom metrics (request latency, queue depth, Kafka lag)
# - External metrics (cloud provider metrics)
#
# Prerequisites:
# - Metrics Server (for resource metrics)
# - Prometheus Adapter (for custom metrics)
# - KEDA (for external/advanced scaling triggers)
# =============================================================================

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: unifiedsteam-hpa
  namespace: greenlang-steam
  labels:
    app.kubernetes.io/name: unifiedsteam
    app.kubernetes.io/instance: unifiedsteam-production
    app.kubernetes.io/component: autoscaler
    app.kubernetes.io/part-of: greenlang
    agent-id: gl-003
  annotations:
    description: "Horizontal Pod Autoscaler for GL-003 UNIFIEDSTEAM"
    # Datadog annotation (if using)
    # ad.datadoghq.com/hpa.check_names: '["kubernetes_autoscaling"]'
spec:
  # =============================================================================
  # Target Reference
  # =============================================================================
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: unifiedsteam

  # =============================================================================
  # Replica Bounds
  # =============================================================================
  minReplicas: 3
  maxReplicas: 15

  # =============================================================================
  # Scaling Metrics
  # =============================================================================
  metrics:
    # =========================================================================
    # Resource Metrics (from Metrics Server)
    # =========================================================================

    # CPU utilization - scale up when average exceeds 70%
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    # Memory utilization - scale up when average exceeds 80%
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

    # =========================================================================
    # Pod Metrics (Custom metrics from Prometheus Adapter)
    # =========================================================================

    # HTTP requests per second per pod
    # Scale when average exceeds 1000 requests/second
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
          selector:
            matchLabels:
              app.kubernetes.io/name: unifiedsteam
        target:
          type: AverageValue
          averageValue: "1000"

    # gRPC requests per second per pod
    # Scale when average exceeds 500 requests/second
    - type: Pods
      pods:
        metric:
          name: grpc_requests_per_second
          selector:
            matchLabels:
              app.kubernetes.io/name: unifiedsteam
        target:
          type: AverageValue
          averageValue: "500"

    # HTTP request latency (P95)
    # Scale when P95 latency exceeds 200ms
    - type: Pods
      pods:
        metric:
          name: http_request_duration_seconds_p95
          selector:
            matchLabels:
              app.kubernetes.io/name: unifiedsteam
        target:
          type: AverageValue
          # 200ms = 0.2 seconds
          averageValue: "200m"

    # Optimization queue depth
    # Scale when queue depth exceeds 50 items per pod
    - type: Pods
      pods:
        metric:
          name: optimization_queue_depth
          selector:
            matchLabels:
              app.kubernetes.io/name: unifiedsteam
        target:
          type: AverageValue
          averageValue: "50"

    # Active connections per pod
    # Scale when average exceeds 200 connections
    - type: Pods
      pods:
        metric:
          name: http_active_connections
          selector:
            matchLabels:
              app.kubernetes.io/name: unifiedsteam
        target:
          type: AverageValue
          averageValue: "200"

    # =========================================================================
    # External Metrics (from external systems via Prometheus Adapter)
    # =========================================================================

    # Kafka consumer lag (total messages behind)
    # Scale when lag exceeds 10000 messages
    - type: External
      external:
        metric:
          name: kafka_consumergroup_lag_sum
          selector:
            matchLabels:
              consumergroup: "unifiedsteam-consumer-group"
              topic: "steam.sensor.readings"
        target:
          type: Value
          value: "10000"

    # Kafka consumer lag rate (messages/second behind)
    # Scale when falling behind at rate > 100 msg/s
    - type: External
      external:
        metric:
          name: kafka_consumergroup_lag_rate
          selector:
            matchLabels:
              consumergroup: "unifiedsteam-consumer-group"
        target:
          type: Value
          value: "100"

    # Redis queue length (if using Redis as task queue)
    - type: External
      external:
        metric:
          name: redis_queue_length
          selector:
            matchLabels:
              queue: "unifiedsteam-optimization-queue"
        target:
          type: Value
          value: "1000"

    # =========================================================================
    # Object Metrics (from Kubernetes objects)
    # =========================================================================

    # Ingress requests per second
    - type: Object
      object:
        metric:
          name: requests-per-second
        describedObject:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          name: unifiedsteam-ingress
        target:
          type: Value
          value: "5000"

  # =============================================================================
  # Scaling Behavior (Fine-grained control)
  # =============================================================================
  behavior:
    # =========================================================================
    # Scale Up Behavior
    # =========================================================================
    scaleUp:
      # Wait 60 seconds before scaling up to avoid flapping
      stabilizationWindowSeconds: 60

      # Scale up policies (pick the one that scales more)
      policies:
        # Add up to 3 pods every 60 seconds
        - type: Pods
          value: 3
          periodSeconds: 60

        # Or add up to 50% of current replicas every 60 seconds
        - type: Percent
          value: 50
          periodSeconds: 60

      # Use the maximum of the two policies
      selectPolicy: Max

    # =========================================================================
    # Scale Down Behavior (More conservative)
    # =========================================================================
    scaleDown:
      # Wait 300 seconds (5 minutes) before scaling down
      # This prevents premature scale-down during traffic dips
      stabilizationWindowSeconds: 300

      # Scale down policies (pick the one that scales less)
      policies:
        # Remove up to 1 pod every 120 seconds
        - type: Pods
          value: 1
          periodSeconds: 120

        # Or remove up to 10% of current replicas every 120 seconds
        - type: Percent
          value: 10
          periodSeconds: 120

      # Use the minimum of the two policies (most conservative)
      selectPolicy: Min

---
# =============================================================================
# Vertical Pod Autoscaler (VPA)
# =============================================================================
# Requires VPA controller to be installed
# Automatically adjusts CPU/memory requests based on actual usage
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: unifiedsteam-vpa
  namespace: greenlang-steam
  labels:
    app.kubernetes.io/name: unifiedsteam
    app.kubernetes.io/instance: unifiedsteam-production
    app.kubernetes.io/component: autoscaler-vertical
    agent-id: gl-003
  annotations:
    description: "Vertical Pod Autoscaler for GL-003 UNIFIEDSTEAM"
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: unifiedsteam

  # Update policy
  updatePolicy:
    # Options:
    # - Off: VPA only provides recommendations, doesn't auto-update
    # - Initial: VPA sets resources only at pod creation
    # - Recreate: VPA evicts pods to apply new resource values
    # - Auto: VPA updates pods in-place when possible, recreates when needed
    updateMode: "Off"  # Start with "Off" to review recommendations

  # Resource policy for containers
  resourcePolicy:
    containerPolicies:
      - containerName: unifiedsteam
        # Minimum allowed resources (never go below this)
        minAllowed:
          cpu: "250m"
          memory: "512Mi"
        # Maximum allowed resources (never exceed this)
        maxAllowed:
          cpu: "4000m"
          memory: "8Gi"
        # Control mode for each resource
        controlledResources:
          - cpu
          - memory
        # What VPA can modify
        controlledValues: RequestsAndLimits

      # Init containers don't need VPA management
      - containerName: wait-for-kafka
        mode: "Off"
      - containerName: wait-for-redis
        mode: "Off"
      - containerName: wait-for-postgres
        mode: "Off"

---
# =============================================================================
# Prometheus Adapter Configuration
# =============================================================================
# ConfigMap for custom metrics rules
# Deploy this if using Prometheus Adapter for custom HPA metrics
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-adapter-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus-adapter
data:
  config.yaml: |
    # Custom metrics for UnifiedSteam HPA
    rules:
      # HTTP requests per second
      - seriesQuery: 'http_requests_total{namespace="greenlang-steam",pod!=""}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
            pod: {resource: "pod"}
        name:
          matches: "^(.*)_total$"
          as: "${1}_per_second"
        metricsQuery: 'rate(<<.Series>>{<<.LabelMatchers>>}[2m])'

      # HTTP request latency P95
      - seriesQuery: 'http_request_duration_seconds_bucket{namespace="greenlang-steam",pod!=""}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
            pod: {resource: "pod"}
        name:
          matches: "http_request_duration_seconds"
          as: "http_request_duration_seconds_p95"
        metricsQuery: 'histogram_quantile(0.95, rate(<<.Series>>{<<.LabelMatchers>>}[5m]))'

      # gRPC requests per second
      - seriesQuery: 'grpc_server_handled_total{namespace="greenlang-steam",pod!=""}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
            pod: {resource: "pod"}
        name:
          matches: "^(.*)_total$"
          as: "${1}_per_second"
        metricsQuery: 'rate(<<.Series>>{<<.LabelMatchers>>}[2m])'

      # Optimization queue depth
      - seriesQuery: 'optimization_queue_size{namespace="greenlang-steam",pod!=""}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
            pod: {resource: "pod"}
        name:
          as: "optimization_queue_depth"
        metricsQuery: '<<.Series>>{<<.LabelMatchers>>}'

      # Active HTTP connections
      - seriesQuery: 'http_connections_active{namespace="greenlang-steam",pod!=""}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
            pod: {resource: "pod"}
        name:
          as: "http_active_connections"
        metricsQuery: '<<.Series>>{<<.LabelMatchers>>}'

    # External metrics rules
    externalRules:
      # Kafka consumer lag
      - seriesQuery: 'kafka_consumergroup_lag{namespace="greenlang-steam"}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
        name:
          as: "kafka_consumergroup_lag_sum"
        metricsQuery: 'sum(<<.Series>>{<<.LabelMatchers>>})'

      # Kafka consumer lag rate
      - seriesQuery: 'kafka_consumergroup_lag{namespace="greenlang-steam"}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
        name:
          as: "kafka_consumergroup_lag_rate"
        metricsQuery: 'rate(sum(<<.Series>>{<<.LabelMatchers>>})[5m])'

      # Redis queue length
      - seriesQuery: 'redis_list_length{namespace="greenlang-steam"}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
        name:
          as: "redis_queue_length"
        metricsQuery: '<<.Series>>{<<.LabelMatchers>>,key="unifiedsteam-optimization-queue"}'

---
# =============================================================================
# KEDA ScaledObject (Alternative to standard HPA)
# =============================================================================
# Uncomment if using KEDA for more advanced scaling triggers
# KEDA supports scaling to/from zero and more trigger types

# apiVersion: keda.sh/v1alpha1
# kind: ScaledObject
# metadata:
#   name: unifiedsteam-scaledobject
#   namespace: greenlang-steam
# spec:
#   scaleTargetRef:
#     name: unifiedsteam
#   pollingInterval: 15
#   cooldownPeriod: 300
#   minReplicaCount: 3
#   maxReplicaCount: 15
#   advanced:
#     restoreToOriginalReplicaCount: true
#     horizontalPodAutoscalerConfig:
#       behavior:
#         scaleDown:
#           stabilizationWindowSeconds: 300
#   triggers:
#     # Kafka consumer lag trigger
#     - type: kafka
#       metadata:
#         bootstrapServers: kafka.greenlang-steam:9092
#         consumerGroup: unifiedsteam-consumer-group
#         topic: steam.sensor.readings
#         lagThreshold: "10000"
#     # Prometheus metric trigger
#     - type: prometheus
#       metadata:
#         serverAddress: http://prometheus.monitoring:9090
#         metricName: http_requests_per_second
#         threshold: "1000"
#         query: |
#           sum(rate(http_requests_total{namespace="greenlang-steam",pod=~"unifiedsteam-.*"}[2m]))
#     # CPU trigger
#     - type: cpu
#       metricType: Utilization
#       metadata:
#         value: "70"
#     # Memory trigger
#     - type: memory
#       metricType: Utilization
#       metadata:
#         value: "80"
