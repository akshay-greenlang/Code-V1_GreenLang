# GL-017_Condensync Helm Chart Values
# Condenser Optimization Agent Configuration
# Version: 1.0.0
#
# Override these values by creating a custom values.yaml file or using --set flags.

# =============================================================================
# Global Settings
# =============================================================================
global:
  # Image registry prefix
  imageRegistry: ghcr.io
  # Image pull secrets
  imagePullSecrets:
    - name: registry-credentials
  # Storage class for persistent volumes
  storageClass: ""
  # Namespace labels
  namespaceLabels:
    team: greenlang
    managed-by: helm

# =============================================================================
# Agent Configuration
# =============================================================================
agent:
  # Agent identifier
  id: "gl-017"
  # Agent name
  name: "Condensync"
  # Agent full name
  fullName: "GL-017_Condensync"
  # Agent description
  description: "Condenser Optimization Agent for GreenLang Industrial AI Platform"
  # Agent group for network policies
  group: "thermal"

# =============================================================================
# Image Configuration
# =============================================================================
image:
  repository: greenlang/gl-017-condensync
  tag: ""  # Defaults to Chart.appVersion
  pullPolicy: Always
  # Digest for immutable deployments (overrides tag)
  digest: ""

# =============================================================================
# Replica Configuration
# =============================================================================
replicaCount: 3

# =============================================================================
# Deployment Strategy
# =============================================================================
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# =============================================================================
# Pod Configuration
# =============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8000"
  prometheus.io/path: "/metrics"

podLabels:
  greenlang.io/agent-id: "gl-017"
  greenlang.io/agent-group: "thermal"
  greenlang.io/monitoring: "enabled"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# =============================================================================
# Container Ports
# =============================================================================
ports:
  - name: http
    containerPort: 8000
    protocol: TCP
  - name: metrics
    containerPort: 9090
    protocol: TCP
  - name: grpc
    containerPort: 50051
    protocol: TCP

# =============================================================================
# Environment Variables
# =============================================================================
env:
  # Static environment variables
  ENVIRONMENT: "production"
  LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"
  # Condenser-specific settings
  CONDENSER_OPTIMIZATION_INTERVAL: "60"
  CONDENSER_PREDICTION_HORIZON: "3600"
  CONDENSER_EFFICIENCY_THRESHOLD: "0.85"

envFrom: []
  # - configMapRef:
  #     name: gl-017-condensync-config
  # - secretRef:
  #     name: gl-017-condensync-secrets

# Additional environment variables from values
extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom-value"
  # - name: SECRET_VAR
  #   valueFrom:
  #     secretKeyRef:
  #       name: secret-name
  #       key: secret-key

# =============================================================================
# Resource Limits
# =============================================================================
resources:
  requests:
    cpu: 500m
    memory: 512Mi
    ephemeral-storage: 100Mi
  limits:
    cpu: 2000m
    memory: 2Gi
    ephemeral-storage: 1Gi

# =============================================================================
# Health Checks
# =============================================================================
livenessProbe:
  httpGet:
    path: /api/v1/health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /api/v1/ready
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /api/v1/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 30

# =============================================================================
# Service Configuration
# =============================================================================
service:
  type: ClusterIP
  port: 80
  targetPort: 8000
  nodePort: 30017  # Used when type is NodePort
  annotations: {}
  labels: {}

# =============================================================================
# Ingress Configuration
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
  hosts:
    - host: gl-017-condensync.greenlang.io
      paths:
        - path: /
          pathType: Prefix
    - host: condensync.greenlang.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: gl-017-condensync-tls
      hosts:
        - gl-017-condensync.greenlang.io
        - condensync.greenlang.io

# =============================================================================
# Horizontal Pod Autoscaler
# =============================================================================
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 2
          periodSeconds: 120

# =============================================================================
# Pod Disruption Budget
# =============================================================================
pdb:
  enabled: true
  minAvailable: 2
  # maxUnavailable: 1

# =============================================================================
# Network Policy
# =============================================================================
networkPolicy:
  enabled: true
  # Allow ingress from these namespaces
  ingressNamespaces:
    - ingress-nginx
    - monitoring
  # Allow egress to these services
  egressRules:
    - to:
        - namespaceSelector:
            matchLabels:
              name: database
      ports:
        - port: 5432
    - to:
        - namespaceSelector:
            matchLabels:
              name: cache
      ports:
        - port: 6379
    - to:
        - namespaceSelector:
            matchLabels:
              name: messaging
      ports:
        - port: 5672

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  name: ""
  annotations: {}
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/gl-017-condensync-role
  automountServiceAccountToken: false

# =============================================================================
# RBAC
# =============================================================================
rbac:
  create: true
  rules: []
    # - apiGroups: [""]
    #   resources: ["configmaps"]
    #   verbs: ["get", "list"]

# =============================================================================
# ConfigMap
# =============================================================================
configMap:
  enabled: true
  data:
    SERVER_HOST: "0.0.0.0"
    SERVER_PORT: "8000"
    SERVER_WORKERS: "4"
    CONDENSER_OPTIMIZATION_ENABLED: "true"
    CONDENSER_OPTIMIZATION_INTERVAL: "60"
    MODEL_UPDATE_INTERVAL: "3600"

# =============================================================================
# Secrets
# =============================================================================
secrets:
  enabled: false
  # Use external secrets instead
  externalSecrets:
    enabled: true
    secretStoreRef:
      name: aws-secrets-manager
      kind: ClusterSecretStore
    data:
      - secretKey: database-url
        remoteRef:
          key: greenlang/production/gl-017-condensync
          property: database_url
      - secretKey: redis-url
        remoteRef:
          key: greenlang/production/gl-017-condensync
          property: redis_url

# =============================================================================
# Volumes
# =============================================================================
volumes:
  - name: tmp
    emptyDir:
      sizeLimit: 100Mi
  - name: cache
    emptyDir:
      sizeLimit: 1Gi
  - name: models
    emptyDir:
      sizeLimit: 2Gi
  - name: data
    emptyDir:
      sizeLimit: 500Mi

volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/.cache
  - name: models
    mountPath: /app/models
  - name: data
    mountPath: /app/data

# Persistent Volume Claims
persistence:
  enabled: false
  storageClass: ""
  accessModes:
    - ReadWriteOnce
  size: 20Gi
  annotations: {}

# =============================================================================
# Init Containers
# =============================================================================
initContainers:
  enabled: true
  waitForDependencies:
    enabled: true
    image: busybox:1.36
    dependencies:
      - host: postgresql.database.svc.cluster.local
        port: 5432
      - host: redis.cache.svc.cluster.local
        port: 6379

# =============================================================================
# Sidecar Containers
# =============================================================================
sidecars: []
  # - name: log-shipper
  #   image: fluent/fluent-bit:latest
  #   volumeMounts:
  #     - name: logs
  #       mountPath: /var/log

# =============================================================================
# Node Scheduling
# =============================================================================
nodeSelector:
  kubernetes.io/os: linux

tolerations: []
  # - key: "dedicated"
  #   operator: "Equal"
  #   value: "greenlang"
  #   effect: "NoSchedule"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: '{{ include "gl-017-condensync.name" . }}'
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: '{{ include "gl-017-condensync.name" . }}'

# =============================================================================
# Priority
# =============================================================================
priorityClassName: ""

# =============================================================================
# Termination
# =============================================================================
terminationGracePeriodSeconds: 60

# =============================================================================
# Lifecycle Hooks
# =============================================================================
lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - sleep 5 && kill -SIGTERM 1

# =============================================================================
# Monitoring
# =============================================================================
monitoring:
  # Prometheus ServiceMonitor
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels: {}
    annotations: {}
    relabelings: []
    metricRelabelings: []

  # Prometheus PrometheusRule
  prometheusRule:
    enabled: true
    labels: {}
    rules:
      - alert: GL017CondensyncDown
        expr: up{job="{{ include \"gl-017-condensync.fullname\" . }}"} == 0
        for: 5m
        labels:
          severity: critical
          agent: gl-017
        annotations:
          summary: "GL-017 Condensync {{ $labels.instance }} is down"
          description: "Condenser Optimization Agent has been down for more than 5 minutes"

      - alert: GL017HighErrorRate
        expr: |
          sum(rate(http_requests_total{job="{{ include "gl-017-condensync.fullname" . }}", status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{job="{{ include "gl-017-condensync.fullname" . }}"}[5m]))
          > 0.05
        for: 5m
        labels:
          severity: warning
          agent: gl-017
        annotations:
          summary: "GL-017 Condensync high error rate"
          description: "Error rate is above 5%"

      - alert: GL017HighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="{{ include "gl-017-condensync.fullname" . }}"}[5m])) by (le))
          > 2
        for: 5m
        labels:
          severity: warning
          agent: gl-017
        annotations:
          summary: "GL-017 Condensync high latency"
          description: "95th percentile latency is above 2 seconds"

      - alert: GL017CondenserEfficiencyLow
        expr: condensync_condenser_efficiency < 0.80
        for: 10m
        labels:
          severity: warning
          agent: gl-017
        annotations:
          summary: "Condenser efficiency below threshold"
          description: "Condenser efficiency is {{ $value }} (below 80%)"

      - alert: GL017OptimizationQueueBacklog
        expr: condensync_optimization_queue_length > 100
        for: 5m
        labels:
          severity: warning
          agent: gl-017
        annotations:
          summary: "Optimization queue backlog"
          description: "Optimization queue has {{ $value }} pending items"

  # Grafana Dashboard
  grafanaDashboard:
    enabled: true
    labels:
      grafana_dashboard: "1"
    annotations: {}

  # Prometheus subchart
  prometheus:
    enabled: false

# =============================================================================
# External Dependencies
# =============================================================================
# PostgreSQL subchart
postgresql:
  enabled: false
  auth:
    database: condensync
    username: condensync
    existingSecret: postgresql-credentials
  primary:
    persistence:
      enabled: true
      size: 50Gi

# Redis subchart
redis:
  enabled: false
  auth:
    enabled: true
    existingSecret: redis-credentials
  master:
    persistence:
      enabled: true
      size: 10Gi

# RabbitMQ subchart
rabbitmq:
  enabled: false
  auth:
    username: condensync
    existingPasswordSecret: rabbitmq-credentials
  persistence:
    enabled: true
    size: 10Gi

# =============================================================================
# Testing
# =============================================================================
tests:
  enabled: true
  image:
    repository: curlimages/curl
    tag: latest
