{{/*
GL-017_Condensync Helm Chart - ServiceMonitor Template
Condenser Optimization Agent - Prometheus Monitoring
*/}}
{{- if .Values.monitoring.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "gl-017-condensync.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gl-017-condensync.labels" . | nindent 4 }}
    {{- with .Values.monitoring.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.monitoring.serviceMonitor.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  selector:
    matchLabels:
      {{- include "gl-017-condensync.selectorLabels" . | nindent 6 }}
  endpoints:
    - port: http
      path: /metrics
      interval: {{ .Values.monitoring.serviceMonitor.interval }}
      scrapeTimeout: {{ .Values.monitoring.serviceMonitor.scrapeTimeout }}
      {{- with .Values.monitoring.serviceMonitor.relabelings }}
      relabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.monitoring.serviceMonitor.metricRelabelings }}
      metricRelabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- if .Values.monitoring.serviceMonitor.enabled }}
    - port: metrics
      path: /metrics
      interval: {{ .Values.monitoring.serviceMonitor.interval }}
      scrapeTimeout: {{ .Values.monitoring.serviceMonitor.scrapeTimeout }}
    {{- end }}
  namespaceSelector:
    matchNames:
      - {{ .Release.Namespace }}
{{- end }}

{{/*
PrometheusRule for alerting
*/}}
{{- if .Values.monitoring.prometheusRule.enabled }}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "gl-017-condensync.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gl-017-condensync.labels" . | nindent 4 }}
    {{- with .Values.monitoring.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: gl-017-condensync.rules
      rules:
        {{- with .Values.monitoring.prometheusRule.rules }}
        {{- tpl (toYaml .) $ | nindent 8 }}
        {{- end }}
{{- end }}

{{/*
Grafana Dashboard ConfigMap
*/}}
{{- if .Values.monitoring.grafanaDashboard.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gl-017-condensync.fullname" . }}-dashboard
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gl-017-condensync.labels" . | nindent 4 }}
    {{- with .Values.monitoring.grafanaDashboard.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.monitoring.grafanaDashboard.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  gl-017-condensync-dashboard.json: |
    {
      "annotations": {
        "list": []
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.85 },
                  { "color": "red", "value": 0.95 }
                ]
              },
              "unit": "percentunit"
            }
          },
          "gridPos": { "h": 8, "w": 6, "x": 0, "y": 0 },
          "id": 1,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "expr": "condensync_condenser_efficiency{job=\"{{ include "gl-017-condensync.fullname" . }}\"}",
              "legendFormat": "Efficiency"
            }
          ],
          "title": "Condenser Efficiency",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "red", "value": 80 }
                ]
              },
              "unit": "reqps"
            }
          },
          "gridPos": { "h": 8, "w": 6, "x": 6, "y": 0 },
          "id": 2,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{job=\"{{ include "gl-017-condensync.fullname" . }}\"}[5m]))",
              "legendFormat": "Requests/s"
            }
          ],
          "title": "Request Rate",
          "type": "stat"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["gl-017", "condensync", "greenlang"],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "GL-017 Condensync Dashboard",
      "uid": "gl-017-condensync",
      "version": 1,
      "weekStart": ""
    }
{{- end }}
