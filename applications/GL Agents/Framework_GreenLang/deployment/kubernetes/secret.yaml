# GreenLang Agent Secret Template
# Template Version: 1.0.0
# Customize: Replace ${VARIABLE} placeholders with actual values
#
# WARNING: This is a TEMPLATE. Never commit actual secrets to version control.
# Use external secret management (AWS Secrets Manager, HashiCorp Vault, etc.)
#
# For production deployments, use:
# - ExternalSecrets Operator
# - Sealed Secrets
# - AWS Secrets Manager with IRSA
# - HashiCorp Vault

---
# Basic Secret (For Development Only)
# NOTE: Base64 encode values before applying
# echo -n 'value' | base64
apiVersion: v1
kind: Secret
metadata:
  name: ${AGENT_ID}-secrets
  namespace: ${NAMESPACE}
  labels:
    app: ${AGENT_ID}
    app.kubernetes.io/name: ${AGENT_ID}
    app.kubernetes.io/component: secrets
  annotations:
    # Indicate this is a template
    template.greenlang.io/type: "secret-template"
type: Opaque
data:
  # Database Connection (base64 encoded)
  # postgresql://user:password@host:5432/database
  database-url: cG9zdGdyZXNxbDovL3VzZXI6cGFzc3dvcmRAaG9zdDo1NDMyL2RhdGFiYXNl

  # Redis Connection (base64 encoded)
  # redis://host:6379/0
  redis-url: cmVkaXM6Ly9ob3N0OjYzNzkvMA==

  # API Key (base64 encoded)
  api-key: QVBJX0tFWV9QTEFDRUhPTERFUg==

  # JWT Secret (base64 encoded)
  jwt-secret: SldUX1NFQ1JFVF9QTEFDRUhPTERFUg==

---
# External Secrets Operator - AWS Secrets Manager
# Requires: External Secrets Operator installed
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ${AGENT_ID}-external-secrets
  namespace: ${NAMESPACE}
  labels:
    app: ${AGENT_ID}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: ${AGENT_ID}-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        database-url: "{{ .database_url }}"
        redis-url: "{{ .redis_url }}"
        api-key: "{{ .api_key }}"
        jwt-secret: "{{ .jwt_secret }}"
  data:
    - secretKey: database_url
      remoteRef:
        key: greenlang/${ENVIRONMENT}/${AGENT_ID}
        property: database_url
    - secretKey: redis_url
      remoteRef:
        key: greenlang/${ENVIRONMENT}/${AGENT_ID}
        property: redis_url
    - secretKey: api_key
      remoteRef:
        key: greenlang/${ENVIRONMENT}/${AGENT_ID}
        property: api_key
    - secretKey: jwt_secret
      remoteRef:
        key: greenlang/${ENVIRONMENT}/${AGENT_ID}
        property: jwt_secret

---
# Cluster Secret Store for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# Sealed Secrets (Alternative)
# Requires: Sealed Secrets Controller installed
# Create with: kubeseal --format yaml < secret.yaml > sealed-secret.yaml
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: ${AGENT_ID}-sealed-secrets
#   namespace: ${NAMESPACE}
#   labels:
#     app: ${AGENT_ID}
# spec:
#   encryptedData:
#     database-url: AgA...encrypted...data...
#     redis-url: AgA...encrypted...data...
#     api-key: AgA...encrypted...data...
#   template:
#     metadata:
#       name: ${AGENT_ID}-secrets
#       namespace: ${NAMESPACE}
#       labels:
#         app: ${AGENT_ID}
#     type: Opaque

---
# HashiCorp Vault - Secrets Injection
# Requires: Vault Agent Injector installed
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${AGENT_ID}-vault-sa
  namespace: ${NAMESPACE}
  labels:
    app: ${AGENT_ID}
  annotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/agent-inject-status: "update"
    vault.hashicorp.com/role: "${AGENT_ID}-role"
    vault.hashicorp.com/agent-inject-secret-database: "secret/data/greenlang/${ENVIRONMENT}/${AGENT_ID}/database"
    vault.hashicorp.com/agent-inject-template-database: |
      {{- with secret "secret/data/greenlang/${ENVIRONMENT}/${AGENT_ID}/database" -}}
      export DATABASE_URL="{{ .Data.data.url }}"
      {{- end -}}
    vault.hashicorp.com/agent-inject-secret-redis: "secret/data/greenlang/${ENVIRONMENT}/${AGENT_ID}/redis"
    vault.hashicorp.com/agent-inject-template-redis: |
      {{- with secret "secret/data/greenlang/${ENVIRONMENT}/${AGENT_ID}/redis" -}}
      export REDIS_URL="{{ .Data.data.url }}"
      {{- end -}}

---
# TLS Secret (for HTTPS)
# Create with: kubectl create secret tls ${AGENT_ID}-tls --cert=tls.crt --key=tls.key
apiVersion: v1
kind: Secret
metadata:
  name: ${AGENT_ID}-tls
  namespace: ${NAMESPACE}
  labels:
    app: ${AGENT_ID}
type: kubernetes.io/tls
data:
  # Base64 encoded certificate and key
  tls.crt: LS0t...BASE64_ENCODED_CERTIFICATE...
  tls.key: LS0t...BASE64_ENCODED_PRIVATE_KEY...

---
# Docker Registry Secret
# Create with: kubectl create secret docker-registry registry-credentials ...
apiVersion: v1
kind: Secret
metadata:
  name: registry-credentials
  namespace: ${NAMESPACE}
  labels:
    app.kubernetes.io/part-of: greenlang
type: kubernetes.io/dockerconfigjson
data:
  # Base64 encoded docker config
  .dockerconfigjson: eyJhdXRocyI6eyJnaGNyLmlvIjp7InVzZXJuYW1lIjoiX2pzb25fa2V5IiwicGFzc3dvcmQiOiIuLi4iLCJhdXRoIjoiLi4uIn19fQ==

---
# Secret Rotation CronJob
# Automatically rotate secrets on schedule
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ${AGENT_ID}-secret-rotation
  namespace: ${NAMESPACE}
  labels:
    app: ${AGENT_ID}
spec:
  schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ${AGENT_ID}-secret-rotation-sa
          containers:
            - name: rotate-secrets
              image: amazon/aws-cli:latest
              command:
                - /bin/sh
                - -c
                - |
                  # Rotate API keys in AWS Secrets Manager
                  aws secretsmanager rotate-secret \
                    --secret-id greenlang/${ENVIRONMENT}/${AGENT_ID}/api-key \
                    --rotation-lambda-arn arn:aws:lambda:us-east-1:ACCOUNT:function:secret-rotation
              env:
                - name: AWS_REGION
                  value: us-east-1
          restartPolicy: OnFailure
