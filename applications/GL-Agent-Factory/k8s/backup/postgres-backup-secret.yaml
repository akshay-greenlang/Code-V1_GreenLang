# GreenLang PostgreSQL Backup S3 Credentials Secret
# IMPORTANT: This is a TEMPLATE file - DO NOT commit actual credentials to git!
#
# Usage:
#   1. Copy this file to a secure location outside the repository
#   2. Replace placeholder values with actual credentials
#   3. Apply using: kubectl apply -f postgres-backup-secret.yaml
#
# For production environments, use one of the following approaches:
#   - AWS IAM Roles for Service Accounts (IRSA) - RECOMMENDED
#   - External Secrets Operator with AWS Secrets Manager
#   - HashiCorp Vault with Kubernetes Auth
#   - Sealed Secrets
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-backup-s3-credentials
  namespace: greenlang-production
  labels:
    app.kubernetes.io/name: greenlang
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: greenlang-platform
  annotations:
    description: "S3 credentials for PostgreSQL backup jobs"
    # Rotate credentials every 90 days
    rotate-by: "90d"
    # External secrets operator annotations (if using)
    # externalsecrets.kubernetes.io/refresh-interval: "1h"
type: Opaque
stringData:
  # AWS Credentials for S3 access
  # IMPORTANT: Use IAM roles with minimum required permissions
  # Required IAM permissions:
  #   - s3:PutObject
  #   - s3:GetObject
  #   - s3:DeleteObject
  #   - s3:ListBucket
  # SECURITY: Replace these placeholders with actual credentials or use IRSA (recommended)
  AWS_ACCESS_KEY_ID: "<YOUR_AWS_ACCESS_KEY_ID_HERE>"
  AWS_SECRET_ACCESS_KEY: "<YOUR_AWS_SECRET_ACCESS_KEY_HERE>"

  # Optional: Slack webhook for notifications
  SLACK_WEBHOOK_URL: "https://hooks.slack.com/services/XXXXX/YYYYY/ZZZZZ"

  # Optional: PagerDuty integration key for critical alerts
  PAGERDUTY_INTEGRATION_KEY: ""

---
# External Secret (for AWS Secrets Manager integration)
# Uncomment and configure if using External Secrets Operator
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: postgres-backup-s3-credentials-external
#   namespace: greenlang-production
#   labels:
#     app.kubernetes.io/name: greenlang
#     app.kubernetes.io/component: backup
# spec:
#   refreshInterval: 1h
#   secretStoreRef:
#     name: aws-secrets-manager
#     kind: ClusterSecretStore
#   target:
#     name: postgres-backup-s3-credentials
#     creationPolicy: Owner
#     template:
#       type: Opaque
#   data:
#     - secretKey: AWS_ACCESS_KEY_ID
#       remoteRef:
#         key: greenlang/production/backup/s3
#         property: access_key_id
#     - secretKey: AWS_SECRET_ACCESS_KEY
#       remoteRef:
#         key: greenlang/production/backup/s3
#         property: secret_access_key
#     - secretKey: SLACK_WEBHOOK_URL
#       remoteRef:
#         key: greenlang/production/notifications
#         property: slack_webhook_url

---
# IAM Role for Service Account (IRSA) - RECOMMENDED FOR EKS
# This approach eliminates the need for static AWS credentials
#
# Prerequisites:
#   1. EKS cluster with OIDC provider configured
#   2. IAM role with S3 permissions and trust policy for the service account
#
# Create IAM Role with AWS CLI:
# aws iam create-role \
#   --role-name GreenLangPostgresBackupRole \
#   --assume-role-policy-document file://trust-policy.json
#
# trust-policy.json:
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Principal": {
#         "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/oidc.eks.REGION.amazonaws.com/id/OIDC_ID"
#       },
#       "Action": "sts:AssumeRoleWithWebIdentity",
#       "Condition": {
#         "StringEquals": {
#           "oidc.eks.REGION.amazonaws.com/id/OIDC_ID:sub": "system:serviceaccount:greenlang-production:postgres-backup-sa"
#         }
#       }
#     }
#   ]
# }

# ServiceAccount with IRSA annotation
# apiVersion: v1
# kind: ServiceAccount
# metadata:
#   name: postgres-backup-sa
#   namespace: greenlang-production
#   annotations:
#     eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/GreenLangPostgresBackupRole"
#   labels:
#     app.kubernetes.io/name: greenlang
#     app.kubernetes.io/component: backup

---
# IAM Policy for S3 Backup Access (reference)
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Sid": "AllowBackupBucketAccess",
#       "Effect": "Allow",
#       "Action": [
#         "s3:PutObject",
#         "s3:GetObject",
#         "s3:DeleteObject",
#         "s3:ListBucket",
#         "s3:GetBucketLocation"
#       ],
#       "Resource": [
#         "arn:aws:s3:::greenlang-backups-production",
#         "arn:aws:s3:::greenlang-backups-production/*"
#       ]
#     },
#     {
#       "Sid": "AllowKMSEncryption",
#       "Effect": "Allow",
#       "Action": [
#         "kms:Encrypt",
#         "kms:Decrypt",
#         "kms:GenerateDataKey"
#       ],
#       "Resource": "arn:aws:kms:us-east-1:ACCOUNT_ID:key/KEY_ID"
#     }
#   ]
# }

---
# Sealed Secret template (for GitOps workflows)
# Generate with: kubeseal --format yaml < postgres-backup-secret.yaml > sealed-postgres-backup-secret.yaml
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: postgres-backup-s3-credentials
#   namespace: greenlang-production
# spec:
#   encryptedData:
#     AWS_ACCESS_KEY_ID: AgBy8BmLO... (encrypted)
#     AWS_SECRET_ACCESS_KEY: AgCtr... (encrypted)
#   template:
#     metadata:
#       name: postgres-backup-s3-credentials
#       namespace: greenlang-production
#       labels:
#         app.kubernetes.io/name: greenlang
#         app.kubernetes.io/component: backup
