"""
Golden Tests for {{ cookiecutter.agent_name }}

Auto-generated by GreenLang Agent Factory
Tests agent outputs against known-good reference values.
"""

import pytest
import json
from pathlib import Path

from agent import {{ cookiecutter.agent_class_name }}, {{ cookiecutter.agent_class_name }}Input


@pytest.mark.golden
class TestGoldenOutputs:
    """Golden tests comparing outputs to known-good values."""

    @pytest.fixture
    def golden_dir(self):
        """Path to golden test data directory."""
        return Path(__file__).parent / "golden"

    def test_golden_cases(self, agent, golden_test_cases):
        """Test all golden test cases."""
        if not golden_test_cases:
            pytest.skip("No golden test cases defined")

        for case in golden_test_cases:
            input_data = {{ cookiecutter.agent_class_name }}Input(**case["input"])
            result = agent.process(input_data)

            # Compare against expected output
            expected = case["expected"]

            if "result" in expected:
                assert result.result == expected["result"], \
                    f"Result mismatch for case: {case.get('name', 'unnamed')}"

            if "provenance_hash" in expected:
                assert result.provenance_hash == expected["provenance_hash"], \
                    f"Provenance mismatch for case: {case.get('name', 'unnamed')}"

    def test_golden_emissions_calculation(self, agent):
        """Test emissions calculation against known values."""
        # Example: 100 kWh * 0.5 kgCO2/kWh = 50 kgCO2
        # Customize based on your agent's domain

        # input_data = {{ cookiecutter.agent_class_name }}Input(
        #     activity_value=100,
        #     activity_unit="kWh",
        #     emission_factor=0.5,
        # )
        # result = agent.process(input_data)
        # assert result.result["emissions"] == 50.0

        pytest.skip("Customize this test for your agent's calculations")

    def test_golden_unit_conversion(self, agent):
        """Test unit conversions against known values."""
        # Example unit conversion tests
        # 1 MWh = 1000 kWh
        # 1 tonne = 1000 kg

        pytest.skip("Customize this test for your agent's conversions")


@pytest.mark.golden
class TestRegressionPrevention:
    """Tests to prevent regressions in calculation logic."""

    def test_boundary_values(self, agent):
        """Test calculation with boundary values."""
        boundary_cases = [
            # (input_value, expected_output)
            # (0, 0),        # Zero input
            # (1, result),   # Minimum positive
            # (1e9, result), # Large value
        ]

        for input_val, expected in boundary_cases:
            # input_data = {{ cookiecutter.agent_class_name }}Input(value=input_val)
            # result = agent.process(input_data)
            # assert result.result == expected
            pass

        pytest.skip("Customize boundary tests for your agent")

    def test_precision_preservation(self, agent):
        """Test that floating point precision is preserved."""
        # Test with values that could lose precision
        precise_values = [
            0.1,
            0.01,
            0.001,
            1.23456789,
        ]

        for value in precise_values:
            # input_data = {{ cookiecutter.agent_class_name }}Input(value=value)
            # result = agent.process(input_data)
            # Verify precision is maintained
            pass

        pytest.skip("Customize precision tests for your agent")


@pytest.mark.golden
class TestDeterministicOutput:
    """Tests ensuring deterministic outputs for certification."""

    def test_100_identical_runs(self, agent, sample_input):
        """D01 Certification: 100 runs must produce identical outputs."""
        results = []
        for _ in range(100):
            result = agent.process(sample_input)
            results.append({
                "result": result.result,
                "provenance_hash": result.provenance_hash,
            })

        # All results must be identical
        first = results[0]
        for i, r in enumerate(results[1:], 1):
            assert r["result"] == first["result"], \
                f"Run {i} result differs from first run"
            assert r["provenance_hash"] == first["provenance_hash"], \
                f"Run {i} provenance differs from first run"

    def test_reproducibility_across_instances(self, sample_input):
        """Test that different agent instances produce same results."""
        agent1 = {{ cookiecutter.agent_class_name }}()
        agent2 = {{ cookiecutter.agent_class_name }}()

        result1 = agent1.process(sample_input)
        result2 = agent2.process(sample_input)

        assert result1.result == result2.result
        assert result1.provenance_hash == result2.provenance_hash


def generate_golden_test_file(agent, inputs: list, output_path: Path):
    """
    Utility to generate golden test case file.

    Usage:
        agent = {{ cookiecutter.agent_class_name }}()
        inputs = [{{ cookiecutter.agent_class_name }}Input(...), ...]
        generate_golden_test_file(agent, inputs, Path("tests/golden/test_cases.json"))
    """
    test_cases = []

    for i, input_data in enumerate(inputs):
        result = agent.process(input_data)
        test_cases.append({
            "name": f"golden_case_{i+1}",
            "input": input_data.dict(),
            "expected": {
                "result": result.result,
                "provenance_hash": result.provenance_hash,
                "validation_status": result.validation_status,
            }
        })

    output_path.parent.mkdir(parents=True, exist_ok=True)
    with open(output_path, "w") as f:
        json.dump(test_cases, f, indent=2, default=str)

    print(f"Generated {len(test_cases)} golden test cases at {output_path}")
