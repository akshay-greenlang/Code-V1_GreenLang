"""
Test Configuration for {{ cookiecutter.agent_name }}

Auto-generated by GreenLang Agent Factory
Provides fixtures and configuration for pytest.
"""

import pytest
import json
from pathlib import Path
from typing import Dict, Any
from datetime import datetime

# Import the agent under test
from agent import {{ cookiecutter.agent_class_name }}, {{ cookiecutter.agent_class_name }}Input


@pytest.fixture
def agent():
    """Create a fresh agent instance for each test."""
    return {{ cookiecutter.agent_class_name }}()


@pytest.fixture
def agent_with_config():
    """Create an agent with custom configuration."""
    config = {
        "verbose": True,
        "strict_validation": True,
        "enable_caching": False,
    }
    return {{ cookiecutter.agent_class_name }}(config=config)


@pytest.fixture
def sample_input():
    """Provide sample input data for testing."""
    return {{ cookiecutter.agent_class_name }}Input(
        # Add sample input values for testing
    )


@pytest.fixture
def valid_inputs():
    """Provide multiple valid input scenarios."""
    return [
        {{ cookiecutter.agent_class_name }}Input(
            # Scenario 1: Minimal valid input
        ),
        {{ cookiecutter.agent_class_name }}Input(
            # Scenario 2: Full valid input
        ),
    ]


@pytest.fixture
def invalid_inputs():
    """Provide invalid input scenarios for error testing."""
    return [
        # Each entry is (input_dict, expected_error_message)
        ({}, "Missing required field"),
        ({"invalid_field": "value"}, "Unknown field"),
    ]


@pytest.fixture
def golden_test_cases():
    """Load golden test cases from JSON file."""
    golden_file = Path(__file__).parent / "golden" / "test_cases.json"
    if golden_file.exists():
        with open(golden_file) as f:
            return json.load(f)
    return []


@pytest.fixture
def mock_database(mocker):
    """Mock database connections for isolated testing."""
    mock_db = mocker.MagicMock()
    mock_db.lookup_emission_factor.return_value = 2.5
    mock_db.get_conversion_factor.return_value = 1.0
    return mock_db


@pytest.fixture
def benchmark_inputs():
    """Provide large inputs for performance benchmarking."""
    return [
        {{ cookiecutter.agent_class_name }}Input(
            # Large dataset for benchmarking
        )
        for _ in range(100)
    ]


# Pytest configuration
def pytest_configure(config):
    """Configure pytest with custom markers."""
    config.addinivalue_line(
        "markers", "golden: mark test as a golden test (compares against known outputs)"
    )
    config.addinivalue_line(
        "markers", "compliance: mark test as a compliance validation test"
    )
    config.addinivalue_line(
        "markers", "performance: mark test as a performance benchmark"
    )
    config.addinivalue_line(
        "markers", "integration: mark test as an integration test"
    )


def pytest_collection_modifyitems(config, items):
    """Modify test collection to add markers based on test names."""
    for item in items:
        if "golden" in item.nodeid:
            item.add_marker(pytest.mark.golden)
        if "compliance" in item.nodeid:
            item.add_marker(pytest.mark.compliance)
        if "benchmark" in item.nodeid or "performance" in item.nodeid:
            item.add_marker(pytest.mark.performance)
        if "integration" in item.nodeid:
            item.add_marker(pytest.mark.integration)
