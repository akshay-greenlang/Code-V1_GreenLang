# =============================================================================
# Kubernetes Secret Configuration
# =============================================================================
# This template creates native Kubernetes secrets when external secrets are
# disabled. For production deployments, use External Secrets Operator by
# setting secrets.useExternalSecrets=true and configuring a provider.
#
# WARNING: Inline secrets should only be used for development/testing.
# Never commit real credentials to version control.
#
# External Secrets Templates:
#   - AWS Secrets Manager: templates/external-secret.yaml
#   - HashiCorp Vault: templates/external-secret-vault.yaml
# =============================================================================

{{- if not .Values.secrets.useExternalSecrets }}
# -----------------------------------------------------------------------------
# Application Secrets (Development/Testing Only)
# -----------------------------------------------------------------------------
# This secret is created when external secrets are disabled.
# For production, enable external secrets and configure AWS or Vault provider.
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "greenlang.fullname" . }}-secrets
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
  annotations:
    description: "GreenLang application secrets (inline mode - development only)"
    {{- if or (not .Values.secrets.databaseUrl) (eq .Values.secrets.databaseUrl "") }}
    warning: "Secrets are empty. Configure external secrets for production."
    {{- end }}
type: Opaque
stringData:
  {{- if .Values.secrets.databaseUrl }}
  DATABASE_URL: {{ .Values.secrets.databaseUrl | quote }}
  GREENLANG_DATABASE_URL: {{ .Values.secrets.databaseUrl | quote }}
  {{- else }}
  DATABASE_URL: ""
  GREENLANG_DATABASE_URL: ""
  {{- end }}

  {{- if .Values.secrets.redisUrl }}
  REDIS_URL: {{ .Values.secrets.redisUrl | quote }}
  GREENLANG_REDIS_URL: {{ .Values.secrets.redisUrl | quote }}
  {{- else }}
  REDIS_URL: ""
  GREENLANG_REDIS_URL: ""
  {{- end }}

  {{- if .Values.secrets.jwtSecret }}
  GREENLANG_JWT_SECRET: {{ .Values.secrets.jwtSecret | quote }}
  JWT_SECRET: {{ .Values.secrets.jwtSecret | quote }}
  {{- else }}
  GREENLANG_JWT_SECRET: ""
  JWT_SECRET: ""
  {{- end }}

  {{- if .Values.secrets.anthropicApiKey }}
  ANTHROPIC_API_KEY: {{ .Values.secrets.anthropicApiKey | quote }}
  {{- else }}
  ANTHROPIC_API_KEY: ""
  {{- end }}

  {{- if .Values.secrets.openaiApiKey }}
  OPENAI_API_KEY: {{ .Values.secrets.openaiApiKey | quote }}
  {{- else }}
  OPENAI_API_KEY: ""
  {{- end }}

  {{- if .Values.secrets.dataEncryptionKey }}
  DATA_ENCRYPTION_KEY: {{ .Values.secrets.dataEncryptionKey | quote }}
  {{- else }}
  DATA_ENCRYPTION_KEY: ""
  {{- end }}

{{- if and .Values.postgresql.enabled (not .Values.postgresql.auth.existingSecret) }}
---
# -----------------------------------------------------------------------------
# PostgreSQL Credentials (Development/Testing Only)
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "greenlang.fullname" . }}-postgresql-credentials
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.postgresql.auth.password }}
  postgres-password: {{ .Values.postgresql.auth.password | quote }}
  password: {{ .Values.postgresql.auth.password | quote }}
  {{- else }}
  postgres-password: ""
  password: ""
  {{- end }}
{{- end }}

{{- if and .Values.redis.enabled (not .Values.redis.auth.existingSecret) }}
---
# -----------------------------------------------------------------------------
# Redis Credentials (Development/Testing Only)
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "greenlang.fullname" . }}-redis-credentials
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.redis.auth.password }}
  redis-password: {{ .Values.redis.auth.password | quote }}
  {{- else }}
  redis-password: ""
  {{- end }}
{{- end }}

{{- end }}

# =============================================================================
# External Secrets Routing
# =============================================================================
# When external secrets are enabled, the appropriate provider template is used:
#   - provider: "aws"   -> templates/external-secret.yaml
#   - provider: "vault" -> templates/external-secret-vault.yaml
#
# The external secret templates create:
#   1. ClusterSecretStore - defines connection to the secrets provider
#   2. ExternalSecret - syncs secrets from provider to Kubernetes
#
# The resulting Kubernetes secret has the same name regardless of provider:
#   {{ include "greenlang.fullname" . }}-secrets
# =============================================================================
