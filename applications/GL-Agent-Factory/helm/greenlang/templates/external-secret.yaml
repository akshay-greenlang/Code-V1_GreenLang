# =============================================================================
# AWS Secrets Manager External Secret Configuration
# =============================================================================
# This template creates ExternalSecret resources that sync secrets from
# AWS Secrets Manager to Kubernetes secrets using the External Secrets Operator.
#
# Prerequisites:
#   1. External Secrets Operator installed in the cluster
#   2. ClusterSecretStore configured for AWS Secrets Manager
#   3. AWS IAM permissions for the service account (IRSA recommended)
#
# AWS Secrets Manager Structure:
#   greenlang/<environment>/database     -> { "url": "...", "host": "...", "password": "..." }
#   greenlang/<environment>/redis        -> { "url": "...", "password": "..." }
#   greenlang/<environment>/jwt          -> { "secret": "..." }
#   greenlang/<environment>/llm          -> { "anthropic_key": "...", "openai_key": "..." }
#   greenlang/<environment>/encryption   -> { "key": "..." }
#   greenlang/<environment>/s3           -> { "access_key": "...", "secret_key": "..." }
# =============================================================================

{{- if and .Values.secrets.useExternalSecrets (eq .Values.secrets.provider "aws") }}
---
# -----------------------------------------------------------------------------
# ClusterSecretStore for AWS Secrets Manager
# This defines how to connect to AWS Secrets Manager
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: {{ include "greenlang.fullname" . }}-aws-secretstore
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.secrets.aws.region | default "us-east-1" }}
      {{- if .Values.secrets.aws.role }}
      # Use IRSA (IAM Roles for Service Accounts) - Recommended
      auth:
        jwt:
          serviceAccountRef:
            name: {{ include "greenlang.serviceAccountName" . }}
            namespace: {{ include "greenlang.namespace" . }}
      role: {{ .Values.secrets.aws.role }}
      {{- else if .Values.secrets.aws.accessKeySecret }}
      # Use static credentials (not recommended for production)
      auth:
        secretRef:
          accessKeyIDSecretRef:
            name: {{ .Values.secrets.aws.accessKeySecret }}
            key: access-key-id
            namespace: {{ include "greenlang.namespace" . }}
          secretAccessKeySecretRef:
            name: {{ .Values.secrets.aws.accessKeySecret }}
            key: secret-access-key
            namespace: {{ include "greenlang.namespace" . }}
      {{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - Main Application Secrets
# Syncs all application secrets from AWS Secrets Manager
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-secrets
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
  annotations:
    description: "GreenLang application secrets from AWS Secrets Manager"
spec:
  # How often to sync secrets from AWS Secrets Manager
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-aws-secretstore
    kind: ClusterSecretStore

  # Target Kubernetes secret configuration
  target:
    name: {{ include "greenlang.fullname" . }}-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "greenlang.labels" . | nindent 10 }}
        annotations:
          description: "Auto-synced from AWS Secrets Manager"
          external-secrets.io/managed: "true"

  # Data mappings from AWS Secrets Manager to Kubernetes secret keys
  data:
    # Database credentials
    - secretKey: DATABASE_URL
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: url

    - secretKey: GREENLANG_DATABASE_URL
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: url

    - secretKey: DATABASE_HOST
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: host

    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: password

    # Redis credentials
    - secretKey: REDIS_URL
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: url

    - secretKey: GREENLANG_REDIS_URL
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: url

    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: password

    # JWT Secret
    - secretKey: GREENLANG_JWT_SECRET
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/jwt
        property: secret

    - secretKey: JWT_SECRET
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/jwt
        property: secret

    # LLM API Keys
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/llm
        property: anthropic_key

    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/llm
        property: openai_key

    # Data Encryption Key
    - secretKey: DATA_ENCRYPTION_KEY
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/encryption
        property: key

    {{- if .Values.secrets.aws.includeS3Credentials }}
    # S3 Credentials (optional - prefer IRSA instead)
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/s3
        property: access_key

    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/s3
        property: secret_key
    {{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - Database Credentials (PostgreSQL subchart)
# Separate secret for database authentication if using Bitnami PostgreSQL
# -----------------------------------------------------------------------------
{{- if .Values.postgresql.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-postgresql-credentials
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-aws-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ include "greenlang.fullname" . }}-postgresql-credentials
    creationPolicy: Owner
  data:
    - secretKey: postgres-password
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: postgres_password

    - secretKey: password
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: password

    - secretKey: replication-password
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: replication_password
{{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - Redis Credentials (Redis subchart)
# Separate secret for Redis authentication if using Bitnami Redis
# -----------------------------------------------------------------------------
{{- if .Values.redis.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-redis-credentials
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-aws-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ include "greenlang.fullname" . }}-redis-credentials
    creationPolicy: Owner
  data:
    - secretKey: redis-password
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: password
{{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - TLS Certificate (optional)
# For managing TLS certificates via AWS Secrets Manager
# -----------------------------------------------------------------------------
{{- if and .Values.ingress.enabled .Values.secrets.aws.tlsSecretEnabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-tls
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-aws-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ .Values.ingress.tls.secretName | default (printf "%s-tls" (include "greenlang.fullname" .)) }}
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/tls
        property: certificate

    - secretKey: tls.key
      remoteRef:
        key: {{ .Values.secrets.aws.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/tls
        property: private_key
{{- end }}

{{- end }}
