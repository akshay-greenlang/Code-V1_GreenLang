# GreenLang Agent Factory - Tox Configuration
# Multi-Python version testing
# Documentation: https://tox.wiki/en/latest/config.html

[tox]
envlist =
    py310
    py311
    py312
    lint
    type
    security
    docs
    coverage-report

isolated_build = True
skip_missing_interpreters = True
minversion = 4.0

# =============================================================================
# Base Test Environment
# =============================================================================
[testenv]
description = Run tests with {basepython}
deps =
    pytest>=7.0.0
    pytest-cov>=4.0.0
    pytest-asyncio>=0.21.0
    pytest-xdist>=3.0.0
    pytest-timeout>=2.0.0
    pytest-benchmark>=4.0.0
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/requirements-dev.txt

setenv =
    PYTHONPATH = {toxinidir}
    PYTHONDONTWRITEBYTECODE = 1
    COVERAGE_FILE = {toxinidir}/.coverage.{envname}

commands =
    pytest tests/ \
        --cov=. \
        --cov-report=term-missing \
        --cov-report=xml:{toxinidir}/coverage-{envname}.xml \
        --ignore=tests/integration \
        --ignore=tests/e2e \
        --ignore=tests/golden \
        -v \
        --tb=short \
        {posargs}

# =============================================================================
# Python Version Specific Environments
# =============================================================================
[testenv:py310]
basepython = python3.10

[testenv:py311]
basepython = python3.11

[testenv:py312]
basepython = python3.12

# =============================================================================
# Linting Environment
# =============================================================================
[testenv:lint]
description = Run linting checks
basepython = python3.11
deps =
    ruff>=0.3.0
    black>=24.0.0
    isort>=5.13.0
skip_install = True
commands =
    ruff check . --output-format=full
    black --check --diff .
    isort --check-only --diff .

[testenv:lint-fix]
description = Fix linting issues
basepython = python3.11
deps =
    ruff>=0.3.0
    black>=24.0.0
    isort>=5.13.0
skip_install = True
commands =
    ruff check . --fix
    black .
    isort .

# =============================================================================
# Type Checking Environment
# =============================================================================
[testenv:type]
description = Run type checking with mypy
basepython = python3.11
deps =
    mypy>=1.9.0
    types-requests
    types-PyYAML
    types-python-dateutil
    pydantic>=2.0
    -r{toxinidir}/requirements.txt
commands =
    mypy . \
        --ignore-missing-imports \
        --no-error-summary \
        --show-error-codes \
        --show-column-numbers

# =============================================================================
# Security Environment
# =============================================================================
[testenv:security]
description = Run security checks
basepython = python3.11
deps =
    bandit>=1.7.0
    safety>=3.0.0
    pip-audit>=2.0.0
skip_install = True
commands =
    bandit -r . -ll -f txt --exclude tests
    safety check --full-report
    pip-audit --strict

# =============================================================================
# Documentation Environment
# =============================================================================
[testenv:docs]
description = Build documentation
basepython = python3.11
deps =
    sphinx>=7.0.0
    sphinx-rtd-theme>=2.0.0
    sphinx-autodoc-typehints>=2.0.0
    myst-parser>=2.0.0
    -r{toxinidir}/requirements.txt
commands =
    sphinx-build -b html docs/ docs/_build/html

[testenv:docs-serve]
description = Serve documentation locally
basepython = python3.11
deps = {[testenv:docs]deps}
commands =
    python -m http.server 8080 --directory docs/_build/html

# =============================================================================
# Coverage Report Environment
# =============================================================================
[testenv:coverage-report]
description = Generate combined coverage report
basepython = python3.11
deps =
    coverage[toml]>=7.0.0
skip_install = True
commands =
    coverage combine
    coverage report --show-missing --fail-under=85
    coverage html -d htmlcov
    coverage xml -o coverage.xml

# =============================================================================
# Integration Tests Environment
# =============================================================================
[testenv:integration]
description = Run integration tests
basepython = python3.11
deps =
    {[testenv]deps}
    httpx>=0.27.0
    aiohttp>=3.9.0
setenv =
    {[testenv]setenv}
    INTEGRATION_TESTS = 1
commands =
    pytest tests/integration/ \
        -v \
        --tb=short \
        {posargs}

# =============================================================================
# E2E Tests Environment
# =============================================================================
[testenv:e2e]
description = Run end-to-end tests
basepython = python3.11
deps =
    {[testenv]deps}
    playwright>=1.40.0
setenv =
    {[testenv]setenv}
    E2E_TESTS = 1
commands =
    pytest tests/e2e/ \
        -v \
        --tb=short \
        {posargs}

# =============================================================================
# Golden Tests Environment
# =============================================================================
[testenv:golden]
description = Run golden tests for determinism verification
basepython = python3.11
deps =
    {[testenv]deps}
    deepdiff>=6.0.0
commands =
    pytest tests/golden/ \
        -v \
        --tb=short \
        -x \
        {posargs}

# =============================================================================
# Benchmark Environment
# =============================================================================
[testenv:benchmark]
description = Run performance benchmarks
basepython = python3.11
deps =
    {[testenv]deps}
    pytest-benchmark>=4.0.0
commands =
    pytest tests/ \
        --benchmark-only \
        --benchmark-autosave \
        --benchmark-compare \
        {posargs}

# =============================================================================
# Agent Certification Environment
# =============================================================================
[testenv:certify]
description = Run agent certification tests
basepython = python3.11
deps =
    {[testenv]deps}
setenv =
    {[testenv]setenv}
    CERTIFICATION_MODE = 1
commands =
    pytest tests/ \
        -m certification \
        -v \
        --tb=short \
        {posargs}

# =============================================================================
# Pre-commit Environment
# =============================================================================
[testenv:pre-commit]
description = Run pre-commit hooks
basepython = python3.11
deps = pre-commit>=3.0.0
skip_install = True
commands = pre-commit run --all-files {posargs}

# =============================================================================
# Development Environment
# =============================================================================
[testenv:dev]
description = Development environment with all tools
basepython = python3.11
deps =
    {[testenv]deps}
    {[testenv:lint]deps}
    {[testenv:type]deps}
    {[testenv:security]deps}
    pre-commit>=3.0.0
    ipython>=8.0.0
    ipdb>=0.13.0
commands =
    python -c "print('Development environment ready!')"

# =============================================================================
# Flake8 Configuration (if used)
# =============================================================================
[flake8]
max-line-length = 100
extend-ignore = E203, E501, W503
exclude =
    .git,
    .tox,
    .venv,
    venv,
    dist,
    build,
    __pycache__,
    *.egg-info,
    migrations

# =============================================================================
# isort Configuration
# =============================================================================
[isort]
profile = black
line_length = 100
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
skip =
    .git,
    .tox,
    .venv,
    venv,
    dist,
    build,
    __pycache__,
    migrations
