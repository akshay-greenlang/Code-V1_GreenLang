# ==============================================================================
# GL-VCCI External Secrets Configuration
# Integrates with external secret management systems (Vault, AWS Secrets Manager)
# ==============================================================================

# ==============================================================================
# PREREQUISITE: Install External Secrets Operator
# ==============================================================================
# helm repo add external-secrets https://charts.external-secrets.io
# helm repo update
# helm install external-secrets \
#   external-secrets/external-secrets \
#   -n external-secrets-system \
#   --create-namespace

# ==============================================================================
# SecretStore - HashiCorp Vault
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
spec:
  provider:
    vault:
      server: "https://vault.your-company.com"
      path: "secret"
      version: "v2"
      auth:
        # Option 1: Kubernetes Auth
        kubernetes:
          mountPath: "kubernetes"
          role: "vcci-production-role"
          serviceAccountRef:
            name: vcci-vault-sa

---
# ==============================================================================
# SecretStore - AWS Secrets Manager
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secretsmanager
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        # Option 1: Use IAM Role for Service Account (IRSA) - Recommended for EKS
        jwt:
          serviceAccountRef:
            name: vcci-secrets-sa

        # Option 2: Use AWS credentials (less secure, not recommended)
        # secretRef:
        #   accessKeyIDSecretRef:
        #     name: aws-credentials
        #     key: access-key-id
        #   secretAccessKeySecretRef:
        #     name: aws-credentials
        #     key: secret-access-key

---
# ==============================================================================
# SecretStore - GCP Secret Manager
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcp-secretmanager
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
spec:
  provider:
    gcpsm:
      projectID: "your-gcp-project-id"
      auth:
        # Use Workload Identity (recommended for GKE)
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: vcci-production
          serviceAccountRef:
            name: vcci-secrets-sa

---
# ==============================================================================
# ClusterSecretStore - Vault (Cluster-wide)
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-cluster-backend
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
spec:
  provider:
    vault:
      server: "https://vault.your-company.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "vcci-cluster-role"
          serviceAccountRef:
            name: vcci-vault-sa
            namespace: vcci-production

---
# ==============================================================================
# ExternalSecret - Database Credentials (from Vault)
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vcci-postgres-credentials
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: database
spec:
  refreshInterval: 1h  # Sync every hour
  secretStoreRef:
    name: vault-backend
    kind: SecretStore

  target:
    name: postgres-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Construct DATABASE_URL from individual fields
        DATABASE_URL: "postgresql://{{ .username }}:{{ .password }}@vcci-postgres:5432/vcci"
        POSTGRES_USER: "{{ .username }}"
        POSTGRES_PASSWORD: "{{ .password }}"
        POSTGRES_DB: "vcci"

  data:
    - secretKey: username
      remoteRef:
        key: vcci/production/postgres
        property: username

    - secretKey: password
      remoteRef:
        key: vcci/production/postgres
        property: password

---
# ==============================================================================
# ExternalSecret - Redis Credentials (from AWS Secrets Manager)
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vcci-redis-credentials
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: cache
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore

  target:
    name: redis-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        REDIS_PASSWORD: "{{ .password }}"
        REDIS_URL: "redis://:{{ .password }}@vcci-redis:6379/0"
        CELERY_BROKER_URL: "redis://:{{ .password }}@vcci-redis:6379/1"
        CELERY_RESULT_BACKEND: "redis://:{{ .password }}@vcci-redis:6379/2"

  dataFrom:
    - extract:
        key: vcci/production/redis

---
# ==============================================================================
# ExternalSecret - API Keys (from Vault)
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vcci-api-keys
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 30m  # API keys refresh more frequently
  secretStoreRef:
    name: vault-backend
    kind: SecretStore

  target:
    name: api-keys
    creationPolicy: Owner

  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: vcci/production/api-keys
        property: openai

    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: vcci/production/api-keys
        property: anthropic

    - secretKey: JWT_SECRET
      remoteRef:
        key: vcci/production/api-keys
        property: jwt_secret

    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: vcci/production/api-keys
        property: encryption_key

---
# ==============================================================================
# ExternalSecret - Application Config (from AWS)
# ==============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vcci-app-config
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: config
spec:
  refreshInterval: 2h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore

  target:
    name: app-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: Opaque
      data:
        config.json: |
          {
            "environment": "{{ .environment }}",
            "log_level": "{{ .log_level }}",
            "features": {{ .features | toJson }}
          }

  data:
    - secretKey: environment
      remoteRef:
        key: vcci/production/config
        property: environment

    - secretKey: log_level
      remoteRef:
        key: vcci/production/config
        property: log_level

    - secretKey: features
      remoteRef:
        key: vcci/production/config
        property: features

---
# ==============================================================================
# Service Account for Vault Authentication
# ==============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vcci-vault-sa
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
  annotations:
    # For AWS EKS with IRSA
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/vcci-secrets-role"
    # For GKE with Workload Identity
    iam.gke.io/gcp-service-account: "vcci-secrets@PROJECT_ID.iam.gserviceaccount.com"

---
# ==============================================================================
# Service Account for AWS Secrets Manager
# ==============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vcci-secrets-sa
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: secrets
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/vcci-external-secrets-role"

---
# ==============================================================================
# RBAC - ClusterRole for External Secrets Operator
# ==============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vcci-external-secrets-role
  labels:
    app.kubernetes.io/name: gl-vcci
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  - apiGroups: ["external-secrets.io"]
    resources: ["externalsecrets", "secretstores", "clustersecretstores"]
    verbs: ["get", "list", "watch"]

---
# ==============================================================================
# RBAC - ClusterRoleBinding
# ==============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vcci-external-secrets-binding
  labels:
    app.kubernetes.io/name: gl-vcci
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vcci-external-secrets-role
subjects:
  - kind: ServiceAccount
    name: vcci-vault-sa
    namespace: vcci-production
  - kind: ServiceAccount
    name: vcci-secrets-sa
    namespace: vcci-production

---
# ==============================================================================
# SETUP INSTRUCTIONS
# ==============================================================================
#
# 1. Install External Secrets Operator:
#    helm repo add external-secrets https://charts.external-secrets.io
#    helm install external-secrets external-secrets/external-secrets \
#      -n external-secrets-system --create-namespace
#
# 2. Configure HashiCorp Vault:
#    # Enable Kubernetes auth
#    vault auth enable kubernetes
#
#    # Configure Kubernetes auth
#    vault write auth/kubernetes/config \
#      kubernetes_host=https://kubernetes.default.svc \
#      kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
#
#    # Create policy
#    vault policy write vcci-production - <<EOF
#    path "secret/data/vcci/production/*" {
#      capabilities = ["read", "list"]
#    }
#    EOF
#
#    # Create role
#    vault write auth/kubernetes/role/vcci-production-role \
#      bound_service_account_names=vcci-vault-sa \
#      bound_service_account_namespaces=vcci-production \
#      policies=vcci-production \
#      ttl=1h
#
#    # Store secrets
#    vault kv put secret/vcci/production/postgres username=vcci password=<strong-password>
#    vault kv put secret/vcci/production/redis password=<redis-password>
#    vault kv put secret/vcci/production/api-keys \
#      openai=sk-... \
#      anthropic=sk-ant-... \
#      jwt_secret=<random-secret>
#
# 3. Configure AWS Secrets Manager (for EKS):
#    # Create IAM policy
#    aws iam create-policy \
#      --policy-name VCCISecretsManagerPolicy \
#      --policy-document '{
#        "Version": "2012-10-17",
#        "Statement": [{
#          "Effect": "Allow",
#          "Action": [
#            "secretsmanager:GetSecretValue",
#            "secretsmanager:DescribeSecret"
#          ],
#          "Resource": "arn:aws:secretsmanager:*:*:secret:vcci/production/*"
#        }]
#      }'
#
#    # Create IAM role for service account (IRSA)
#    eksctl create iamserviceaccount \
#      --name vcci-secrets-sa \
#      --namespace vcci-production \
#      --cluster vcci-cluster \
#      --attach-policy-arn arn:aws:iam::ACCOUNT_ID:policy/VCCISecretsManagerPolicy \
#      --approve
#
#    # Store secrets in AWS Secrets Manager
#    aws secretsmanager create-secret \
#      --name vcci/production/redis \
#      --secret-string '{"password":"<redis-password>"}'
#
# 4. Verify External Secrets:
#    kubectl get secretstore -n vcci-production
#    kubectl get externalsecret -n vcci-production
#    kubectl describe externalsecret vcci-postgres-credentials -n vcci-production
#    kubectl get secret postgres-credentials -n vcci-production -o yaml
#
# 5. Test Secret Sync:
#    # Watch for secret updates
#    kubectl get externalsecret -n vcci-production -w
#
#    # Force refresh
#    kubectl annotate externalsecret vcci-api-keys \
#      force-sync=$(date +%s) -n vcci-production
#
# 6. Troubleshooting:
#    kubectl logs -n external-secrets-system -l app.kubernetes.io/name=external-secrets
#    kubectl describe externalsecret <name> -n vcci-production
