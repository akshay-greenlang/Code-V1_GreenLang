# ==============================================================================
# GL-VCCI Istio Destination Rules
# ==============================================================================

# ==============================================================================
# Backend API Destination Rule
# ==============================================================================
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: vcci-backend-api
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: backend-api
spec:
  host: vcci-backend-api.vcci-production.svc.cluster.local

  # Traffic Policy (applies to all subsets unless overridden)
  trafficPolicy:
    # Load Balancing
    loadBalancer:
      consistentHash:
        httpHeaderName: x-user-id  # Sticky sessions based on user ID

    # Connection Pool Settings
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 30s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
        maxRetries: 3

    # Outlier Detection (Circuit Breaker)
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50

    # TLS Settings (mTLS)
    tls:
      mode: ISTIO_MUTUAL

  # Subsets for canary deployment
  subsets:
    - name: stable
      labels:
        version: v1.0.0
        track: stable
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN

    - name: canary
      labels:
        version: v2.0.0
        track: canary
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN

---
# ==============================================================================
# Worker Destination Rule
# ==============================================================================
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: vcci-worker
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: worker
spec:
  host: vcci-worker.vcci-production.svc.cluster.local

  trafficPolicy:
    loadBalancer:
      simple: LEAST_REQUEST  # Send to least loaded worker

    connectionPool:
      tcp:
        maxConnections: 50
      http:
        http2MaxRequests: 500
        maxRequestsPerConnection: 5

    outlierDetection:
      consecutiveErrors: 3
      interval: 60s
      baseEjectionTime: 60s
      maxEjectionPercent: 30

    tls:
      mode: ISTIO_MUTUAL

---
# ==============================================================================
# PostgreSQL Destination Rule
# ==============================================================================
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: vcci-postgres
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: database
spec:
  host: vcci-postgres.vcci-production.svc.cluster.local

  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 10s
        tcpKeepalive:
          time: 7200s
          interval: 75s

    # No outlier detection for database (don't want to eject DB)
    tls:
      mode: DISABLE  # PostgreSQL has its own SSL

---
# ==============================================================================
# Redis Destination Rule
# ==============================================================================
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: vcci-redis
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: cache
spec:
  host: vcci-redis.vcci-production.svc.cluster.local

  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: x-session-id  # Consistent hashing for cache

    connectionPool:
      tcp:
        maxConnections: 1000
        connectTimeout: 5s

    outlierDetection:
      consecutiveErrors: 5
      interval: 10s
      baseEjectionTime: 30s

    tls:
      mode: DISABLE  # Redis doesn't use TLS in this setup

---
# ==============================================================================
# Weaviate Destination Rule
# ==============================================================================
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: vcci-weaviate
  namespace: vcci-production
  labels:
    app.kubernetes.io/name: gl-vcci
    app.kubernetes.io/component: vector-db
spec:
  host: vcci-weaviate.vcci-production.svc.cluster.local

  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100

    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 60s

    tls:
      mode: ISTIO_MUTUAL
