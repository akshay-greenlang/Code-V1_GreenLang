# ============================================================================
# PROMETHEUS ALERTING RULES FOR VCCI SCOPE 3 PLATFORM
# ============================================================================
#
# This file defines critical alerts for production monitoring of the
# GL-VCCI Scope 3 Carbon Intelligence Platform.
#
# Alert Severity Levels:
# - critical: Immediate action required (pages on-call)
# - warning: Attention needed (notifies team)
# - info: Informational (logged only)
#
# Version: 1.0.0
# Author: GreenLang VCCI Team (Monitoring & Observability)
# Date: 2025-11-08
# ============================================================================

groups:
  # ==========================================================================
  # APPLICATION AVAILABILITY ALERTS
  # ==========================================================================

  - name: vcci_availability
    interval: 30s
    rules:
      - alert: VCCIServiceDown
        expr: up{job="vcci-scope3-platform"} == 0
        for: 2m
        labels:
          severity: critical
          component: application
          team: vcci
        annotations:
          summary: "VCCI Scope 3 Platform service is down"
          description: "The VCCI application on {{ $labels.instance }} has been down for more than 2 minutes."
          impact: "Carbon calculations will fail. Supplier engagement campaigns halted. Critical business impact."
          action: "1. Check application logs\n2. Verify service status\n3. Restart service if needed\n4. Check system resources\n5. Verify database connectivity"
          runbook_url: "https://wiki.greenlang.com/vcci/runbooks/service-down"

      - alert: VCCIHealthCheckFailing
        expr: |
          (
            sum(rate(probe_success{job="blackbox-http", instance=~".*vcci.*"}[5m])) by (instance)
            / sum(rate(probe_duration_seconds_count{job="blackbox-http", instance=~".*vcci.*"}[5m])) by (instance)
          ) < 0.9
        for: 5m
        labels:
          severity: critical
          component: health
          team: vcci
        annotations:
          summary: "VCCI health checks failing"
          description: "Health check success rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          impact: "Application may be unhealthy. Requests may fail."
          action: "Check /health/ready and /health/live endpoints for details"

      - alert: VCCIReadinessCheckFailing
        expr: probe_success{instance=~".*vcci.*health/ready.*"} == 0
        for: 3m
        labels:
          severity: warning
          component: health
          team: vcci
        annotations:
          summary: "VCCI readiness check failing"
          description: "Readiness probe is failing - application may not be ready to serve traffic."
          impact: "New requests may be routed to unhealthy instances."
          action: "Check dependency availability (PostgreSQL, Redis, Weaviate)"

  # ==========================================================================
  # PERFORMANCE ALERTS
  # ==========================================================================

  - name: vcci_performance
    interval: 30s
    rules:
      - alert: VCCIHighAPILatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="vcci-scope3-platform"}[5m])) by (le)
          ) > 0.5
        for: 10m
        labels:
          severity: warning
          component: performance
          team: vcci
        annotations:
          summary: "VCCI API latency is high"
          description: "95th percentile API latency is {{ $value | humanizeDuration }} (threshold: 500ms)"
          impact: "Degraded user experience. SLA may be at risk."
          action: "1. Check system resources\n2. Review recent changes\n3. Check database query performance\n4. Monitor agent performance"

      - alert: VCCISlowCarbonCalculation
        expr: |
          histogram_quantile(0.95,
            sum(rate(vcci_calculation_duration_seconds_bucket[5m])) by (le, category)
          ) > 60
        for: 15m
        labels:
          severity: warning
          component: performance
          team: vcci
        annotations:
          summary: "VCCI carbon calculation {{ $labels.category }} is slow"
          description: "Category {{ $labels.category }} calculations taking {{ $value | humanizeDuration }} at p95 (threshold: 60s)"
          impact: "Reduced throughput for carbon calculations."
          action: "1. Check category-specific logs\n2. Review emission factor lookups\n3. Check LLM API latency\n4. Verify data quality"

      - alert: VCCILowCalculationThroughput
        expr: |
          sum(rate(vcci_emissions_calculated_total[5m])) < 5
        for: 15m
        labels:
          severity: warning
          component: performance
          team: vcci
        annotations:
          summary: "VCCI calculation throughput is low"
          description: "Processing only {{ $value | humanize }} calculations/second (threshold: 5 calc/sec)"
          impact: "Reduced capacity for processing supplier data."
          action: "Check for resource constraints or bottlenecks"

  # ==========================================================================
  # ERROR RATE ALERTS
  # ==========================================================================

  - name: vcci_errors
    interval: 30s
    rules:
      - alert: VCCIHighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="vcci-scope3-platform", status=~"5.."}[5m]))
            / sum(rate(http_requests_total{job="vcci-scope3-platform"}[5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: critical
          component: reliability
          team: vcci
        annotations:
          summary: "VCCI API error rate is high"
          description: "{{ $value | humanizePercentage }} of API requests are failing (threshold: 1%)"
          impact: "Multiple operations failing. User impact likely."
          action: "1. Check error logs\n2. Review recent deployments\n3. Check external dependencies\n4. Verify database connectivity"

      - alert: VCCICalculationFailures
        expr: |
          (
            sum(rate(vcci_calculations_total{status="failed"}[5m])) by (category)
            / sum(rate(vcci_calculations_total[5m])) by (category)
          ) > 0.05
        for: 10m
        labels:
          severity: critical
          component: reliability
          team: vcci
        annotations:
          summary: "High calculation failure rate for category {{ $labels.category }}"
          description: "{{ $value | humanizePercentage }} of {{ $labels.category }} calculations failing (threshold: 5%)"
          impact: "Carbon data accuracy compromised. Supplier reports may be incomplete."
          action: "1. Check emission factor availability\n2. Review input data quality\n3. Verify LLM API connectivity\n4. Check calculation logic errors"

      - alert: VCCIEntityResolutionFailures
        expr: |
          (
            sum(rate(vcci_entity_resolution_total{status="failed"}[5m]))
            / sum(rate(vcci_entity_resolution_total[5m]))
          ) > 0.2
        for: 10m
        labels:
          severity: warning
          component: entity_resolution
          team: vcci
        annotations:
          summary: "High entity resolution failure rate"
          description: "{{ $value | humanizePercentage }} of entity resolutions failing (threshold: 20%)"
          impact: "Supplier matching quality degraded. Manual review queue growing."
          action: "1. Check Weaviate connectivity\n2. Review entity MDM data quality\n3. Check LLM API for entity extraction\n4. Verify LEI/DUNS API availability"

      - alert: VCCILLMAPIErrors
        expr: |
          sum(rate(vcci_llm_api_errors_total[5m])) by (provider) > 0.5
        for: 5m
        labels:
          severity: critical
          component: llm
          team: vcci
        annotations:
          summary: "LLM API errors from {{ $labels.provider }}"
          description: "{{ $labels.provider }} API errors occurring at {{ $value | humanize }}/sec"
          impact: "Entity resolution and intelligent features degraded."
          action: "1. Check API key validity\n2. Verify API quota/rate limits\n3. Check network connectivity\n4. Review API error logs"

  # ==========================================================================
  # CARBON-SPECIFIC METRICS ALERTS
  # ==========================================================================

  - name: vcci_carbon_metrics
    interval: 1m
    rules:
      - alert: VCCIEmissionsAnomalyDetected
        expr: |
          (
            rate(vcci_emissions_calculated_total[5m])
            / rate(vcci_emissions_calculated_total[5m] offset 1h)
          ) > 3 or (
            rate(vcci_emissions_calculated_total[5m])
            / rate(vcci_emissions_calculated_total[5m] offset 1h)
          ) < 0.3
        for: 10m
        labels:
          severity: info
          component: business
          team: vcci
        annotations:
          summary: "Anomaly in emissions calculation rate"
          description: "Emissions calculation rate changed by {{ $value | humanize }}x compared to 1h ago"
          impact: "Unusual pattern. May indicate data quality issue or business change."
          action: "Review recent input data and calculation results for anomalies"

      - alert: VCCIHighTier1Dependency
        expr: |
          (
            sum(rate(vcci_emissions_calculated_total{tier="tier1"}[1h]))
            / sum(rate(vcci_emissions_calculated_total[1h]))
          ) < 0.3
        for: 4h
        labels:
          severity: warning
          component: business
          team: vcci
        annotations:
          summary: "Low Tier 1 data coverage"
          description: "Only {{ $value | humanizePercentage }} of emissions from Tier 1 suppliers (target: >30%)"
          impact: "Heavy reliance on Tier 2/3 proxies. Data quality lower than target."
          action: "1. Increase Tier 1 supplier engagement\n2. Review supplier onboarding campaigns\n3. Check data collection workflows"

      - alert: VCCILowSupplierEngagementRate
        expr: |
          vcci_supplier_engagement_rate < 0.4
        for: 6h
        labels:
          severity: warning
          component: business
          team: vcci
        annotations:
          summary: "Supplier engagement rate below target"
          description: "Supplier engagement rate is {{ $value | humanizePercentage }} (target: >40%)"
          impact: "Insufficient primary data collection. Increased reliance on defaults."
          action: "1. Review engagement campaign effectiveness\n2. Check email deliverability\n3. Increase outreach efforts\n4. Review supplier portal adoption"

      - alert: VCCICategoryImbalance
        expr: |
          (
            max(sum(rate(vcci_emissions_calculated_total[1h])) by (category))
            / min(sum(rate(vcci_emissions_calculated_total[1h])) by (category) > 0)
          ) > 10
        for: 4h
        labels:
          severity: info
          component: business
          team: vcci
        annotations:
          summary: "Imbalanced category coverage"
          description: "{{ $value | humanize }}x difference between most and least active categories"
          impact: "May indicate incomplete Scope 3 inventory coverage."
          action: "Review category coverage and data collection priorities"

  # ==========================================================================
  # RESOURCE ALERTS
  # ==========================================================================

  - name: vcci_resources
    interval: 30s
    rules:
      - alert: VCCIHighMemoryUsage
        expr: |
          (
            container_memory_working_set_bytes{namespace="vcci-production", pod=~"vcci-.*"}
            / container_spec_memory_limit_bytes{namespace="vcci-production", pod=~"vcci-.*"}
          ) > 0.85
        for: 10m
        labels:
          severity: warning
          component: resources
          team: vcci
        annotations:
          summary: "VCCI pod memory usage is high"
          description: "Pod {{ $labels.pod }} using {{ $value | humanizePercentage }} of memory limit"
          impact: "Risk of out-of-memory errors. Performance degradation likely."
          action: "1. Check for memory leaks\n2. Review batch sizes\n3. Consider increasing memory limits\n4. Monitor for growth trend"

      - alert: VCCIHighCPUUsage
        expr: |
          rate(container_cpu_usage_seconds_total{namespace="vcci-production", pod=~"vcci-.*"}[5m]) > 0.8
        for: 15m
        labels:
          severity: warning
          component: resources
          team: vcci
        annotations:
          summary: "VCCI pod CPU usage is high"
          description: "Pod {{ $labels.pod }} CPU usage at {{ $value | humanizePercentage }}"
          impact: "Reduced processing capacity. Increased latency likely."
          action: "1. Check for CPU-intensive operations\n2. Review concurrent calculations\n3. Consider horizontal scaling"

      - alert: VCCIDatabaseConnectionPoolExhausted
        expr: |
          (
            pg_stat_database_numbackends{datname="vcci_production"}
            / pg_settings_max_connections
          ) > 0.8
        for: 10m
        labels:
          severity: critical
          component: database
          team: vcci
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Using {{ $value | humanizePercentage }} of max database connections"
          impact: "New requests will fail to get database connections."
          action: "1. Check for connection leaks\n2. Review connection pool configuration\n3. Scale database if needed"

      - alert: VCCIRedisMemoryHigh
        expr: |
          (
            redis_memory_used_bytes{job="vcci-redis"}
            / redis_memory_max_bytes{job="vcci-redis"}
          ) > 0.85
        for: 10m
        labels:
          severity: warning
          component: cache
          team: vcci
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis using {{ $value | humanizePercentage }} of max memory"
          impact: "Cache evictions may increase. Performance may degrade."
          action: "1. Review cache TTL settings\n2. Check for large keys\n3. Consider increasing memory or implementing eviction policy"

      - alert: VCCIWeaviateUnreachable
        expr: |
          up{job="vcci-weaviate"} == 0
        for: 5m
        labels:
          severity: critical
          component: vector_database
          team: vcci
        annotations:
          summary: "Weaviate vector database unreachable"
          description: "Weaviate instance is down or unreachable"
          impact: "Entity resolution will fail. Supplier matching degraded."
          action: "1. Check Weaviate service status\n2. Verify network connectivity\n3. Check Weaviate logs\n4. Restart Weaviate if needed"

  # ==========================================================================
  # QUEUE & WORKER ALERTS
  # ==========================================================================

  - name: vcci_queues
    interval: 30s
    rules:
      - alert: VCCIHighQueueDepth
        expr: |
          celery_queue_length{queue=~"vcci_.*"} > 100
        for: 10m
        labels:
          severity: warning
          component: queue
          team: vcci
        annotations:
          summary: "High queue depth for {{ $labels.queue }}"
          description: "Queue {{ $labels.queue }} has {{ $value }} pending tasks (threshold: 100)"
          impact: "Processing backlog growing. Increased latency for async operations."
          action: "1. Check worker availability\n2. Review task processing times\n3. Consider scaling workers\n4. Check for stuck tasks"

      - alert: VCCICriticalQueueDepth
        expr: |
          celery_queue_length{queue=~"vcci_.*"} > 1000
        for: 5m
        labels:
          severity: critical
          component: queue
          team: vcci
        annotations:
          summary: "CRITICAL: Queue {{ $labels.queue }} severely backed up"
          description: "Queue {{ $labels.queue }} has {{ $value }} pending tasks (critical threshold: 1000)"
          impact: "Severe processing delays. User operations timing out."
          action: "1. Immediate worker scaling required\n2. Check for task failures\n3. Review system resources\n4. Consider emergency task purging if appropriate"

      - alert: VCCIWorkerDown
        expr: |
          celery_workers{queue=~"vcci_.*"} == 0
        for: 5m
        labels:
          severity: critical
          component: worker
          team: vcci
        annotations:
          summary: "No workers available for {{ $labels.queue }}"
          description: "Queue {{ $labels.queue }} has no active workers"
          impact: "Async tasks not processing. Queue backlog growing."
          action: "1. Check worker service status\n2. Review worker logs\n3. Restart workers\n4. Check resource constraints"

  # ==========================================================================
  # DATA QUALITY ALERTS
  # ==========================================================================

  - name: vcci_data_quality
    interval: 1h
    rules:
      - alert: VCCILowDataQualityScore
        expr: |
          vcci_data_quality_score < 70
        for: 2h
        labels:
          severity: warning
          component: data_quality
          team: vcci
        annotations:
          summary: "Data quality score below threshold"
          description: "Overall data quality score is {{ $value }}/100 (threshold: 70)"
          impact: "Carbon calculations may be inaccurate. Reporting quality compromised."
          action: "1. Review data quality dimensions\n2. Check data completeness\n3. Validate emission factors\n4. Improve supplier data collection"

      - alert: VCCIHighMissingDataPoints
        expr: |
          vcci_missing_data_points_total > 1000
        for: 4h
        labels:
          severity: warning
          component: data_quality
          team: vcci
        annotations:
          summary: "High number of missing data points"
          description: "{{ $value }} missing data points detected across all suppliers"
          impact: "Incomplete carbon inventory. Increased uncertainty."
          action: "1. Review data collection workflows\n2. Increase supplier engagement\n3. Check data validation rules"

  # ==========================================================================
  # SUPPLIER ENGAGEMENT ALERTS
  # ==========================================================================

  - name: vcci_engagement
    interval: 1h
    rules:
      - alert: VCCILowEmailDeliverability
        expr: |
          (
            sum(rate(vcci_emails_sent_total{status="bounced"}[1h]))
            / sum(rate(vcci_emails_sent_total[1h]))
          ) > 0.05
        for: 2h
        labels:
          severity: warning
          component: engagement
          team: vcci
        annotations:
          summary: "High email bounce rate"
          description: "{{ $value | humanizePercentage }} of emails bouncing (threshold: 5%)"
          impact: "Supplier engagement campaigns not reaching targets."
          action: "1. Review supplier email addresses\n2. Check SendGrid configuration\n3. Verify sender reputation\n4. Clean email list"

      - alert: VCCILowPortalAdoption
        expr: |
          (
            sum(increase(vcci_portal_logins_total[7d]))
            / sum(vcci_suppliers_invited_total)
          ) < 0.3
        for: 6h
        labels:
          severity: info
          component: engagement
          team: vcci
        annotations:
          summary: "Low supplier portal adoption"
          description: "Only {{ $value | humanizePercentage }} of invited suppliers logged in (target: >30%)"
          impact: "Limited primary data collection. Heavy reliance on defaults."
          action: "1. Increase outreach efforts\n2. Review portal user experience\n3. Send reminder emails\n4. Offer training/support"

  # ==========================================================================
  # SLA ALERTS
  # ==========================================================================

  - name: vcci_sla
    interval: 1m
    rules:
      - alert: VCCISLAViolation
        expr: |
          (
            sum(rate(http_requests_total{job="vcci-scope3-platform", status=~"2.."}[1h]))
            / sum(rate(http_requests_total{job="vcci-scope3-platform"}[1h]))
          ) < 0.99
        for: 15m
        labels:
          severity: critical
          component: sla
          team: vcci
        annotations:
          summary: "VCCI SLA violation - success rate below 99%"
          description: "Success rate is {{ $value | humanizePercentage }} (SLA: 99%)"
          impact: "Service Level Agreement breach. Customer impact likely."
          action: "1. Immediate investigation required\n2. Notify management\n3. Review all recent failures\n4. Prepare incident report"

      - alert: VCCISLALatencyViolation
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="vcci-scope3-platform"}[1h])) by (le)
          ) > 1.0
        for: 30m
        labels:
          severity: warning
          component: sla
          team: vcci
        annotations:
          summary: "VCCI SLA latency violation"
          description: "95th percentile latency is {{ $value | humanizeDuration }} (SLA: 1 second)"
          impact: "Performance SLA breach. User experience degraded."
          action: "Performance optimization required. Review bottlenecks."

# ============================================================================
# ALERT ROUTING (for Alertmanager)
# ============================================================================
#
# Configure in alertmanager.yml:
#
# route:
#   receiver: 'vcci-team'
#   group_by: ['alertname', 'severity']
#   group_wait: 30s
#   group_interval: 5m
#   repeat_interval: 4h
#
#   routes:
#     - match:
#         severity: critical
#       receiver: 'vcci-pagerduty'
#       continue: true
#
#     - match:
#         severity: warning
#       receiver: 'vcci-slack'
#
# receivers:
#   - name: 'vcci-team'
#     email_configs:
#       - to: 'vcci-team@greenlang.com'
#
#   - name: 'vcci-pagerduty'
#     pagerduty_configs:
#       - service_key: '<pagerduty-key>'
#
#   - name: 'vcci-slack'
#     slack_configs:
#       - api_url: '<slack-webhook-url>'
#         channel: '#vcci-alerts'
#         title: 'VCCI Alert: {{ .GroupLabels.alertname }}'
#
# ============================================================================
# ALERT SUMMARY
# ============================================================================
#
# Total Alerts: 37
#
# By Severity:
# - Critical: 16 alerts
# - Warning: 17 alerts
# - Info: 4 alerts
#
# By Category:
# - Availability: 3 alerts
# - Performance: 3 alerts
# - Errors: 4 alerts
# - Carbon Metrics: 4 alerts
# - Resources: 5 alerts
# - Queues: 3 alerts
# - Data Quality: 2 alerts
# - Engagement: 2 alerts
# - SLA: 2 alerts
#
# ============================================================================
