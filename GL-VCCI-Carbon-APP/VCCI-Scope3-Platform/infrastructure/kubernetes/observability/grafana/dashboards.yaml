---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: vcci-observability
  labels:
    app: grafana
data:
  grafana.ini: |
    [server]
    domain = monitoring.vcci.greenlang.io
    root_url = %(protocol)s://%(domain)s/

    [security]
    admin_user = ${GF_SECURITY_ADMIN_USER}
    admin_password = ${GF_SECURITY_ADMIN_PASSWORD}

    [auth]
    disable_login_form = false

    [users]
    allow_sign_up = false

    [database]
    type = postgres
    host = postgresql.vcci-platform.svc.cluster.local:5432
    name = grafana
    user = grafana
    password = ${GF_DATABASE_PASSWORD}

    [session]
    provider = postgres
    provider_config = user=grafana password=${GF_DATABASE_PASSWORD} host=postgresql.vcci-platform.svc.cluster.local port=5432 dbname=grafana sslmode=disable

    [analytics]
    reporting_enabled = false
    check_for_updates = false

  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus.vcci-observability.svc.cluster.local:9090
        isDefault: true
        editable: false

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: vcci-observability
  labels:
    app: grafana
data:
  platform-overview.json: |
    {
      "dashboard": {
        "title": "VCCI Platform Overview",
        "tags": ["vcci", "platform"],
        "timezone": "UTC",
        "panels": [
          {
            "title": "API Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])"
              }
            ]
          },
          {
            "title": "API Latency (p95)",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
              }
            ]
          },
          {
            "title": "CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)"
              }
            ]
          },
          {
            "title": "Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100"
              }
            ]
          }
        ]
      }
    }
