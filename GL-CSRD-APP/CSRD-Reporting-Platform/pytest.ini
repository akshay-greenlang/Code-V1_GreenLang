[pytest]
################################################################################
# GL-CSRD Comprehensive Pytest Configuration
# Test Suite: 975 tests across 14 files
# Target Coverage: 90%+
################################################################################

# Test discovery patterns
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Test paths
testpaths = tests

# Minimum Python version
minversion = 8.0

################################################################################
# TEST MARKERS - Complete CSRD Test Classification
################################################################################

markers =
    # Test Types
    unit: Unit tests (fast, isolated, single component)
    integration: Integration tests (multiple components working together)
    e2e: End-to-end workflow tests (complete pipeline execution)

    # Priority Levels
    critical: Critical tests - MUST PASS (zero hallucination, compliance)
    high: High priority tests (core functionality)
    medium: Medium priority tests (standard features)
    low: Low priority tests (nice-to-have features)

    # Performance & Speed
    slow: Slow tests (>1 second execution time)
    fast: Fast tests (<0.1 second execution time)
    performance: Performance benchmarking tests
    stress: Stress tests (high load, edge cases)

    # ESRS Standards (12 standards)
    esrs1: ESRS 1 - General Requirements
    esrs2: ESRS 2 - General Disclosures
    esrs_e1: ESRS E1 - Climate Change
    esrs_e2: ESRS E2 - Pollution
    esrs_e3: ESRS E3 - Water and Marine Resources
    esrs_e4: ESRS E4 - Biodiversity and Ecosystems
    esrs_e5: ESRS E5 - Resource Use and Circular Economy
    esrs_s1: ESRS S1 - Own Workforce
    esrs_s2: ESRS S2 - Workers in Value Chain
    esrs_s3: ESRS S3 - Affected Communities
    esrs_s4: ESRS S4 - Consumers and End-users
    esrs_g1: ESRS G1 - Business Conduct

    # Agent Components (11 agents)
    calculator: Calculator Agent tests (109 tests - zero hallucination)
    reporting: Reporting Agent tests (133 tests - XBRL/ESEF)
    audit: Audit Agent tests (115 tests - compliance)
    intake: Intake Agent tests (107 tests - data ingestion)
    provenance: Provenance System tests (101 tests - audit trail)
    aggregator: Aggregator Agent tests (75 tests - framework mapping)
    materiality: Materiality Agent tests (45 tests - double materiality)

    # Infrastructure & Interfaces
    cli: CLI Interface tests (69 tests)
    sdk: SDK tests (61 tests)
    pipeline: Pipeline Integration tests (59 tests)
    validation: Validation System tests (55 tests)
    encryption: Encryption tests (24 tests)
    security: Security tests (16 tests)

    # Functionality Categories
    calculations: Calculation and formula tests
    data_ingestion: Data ingestion and parsing tests
    xbrl: XBRL/ESEF generation tests
    compliance: Regulatory compliance tests
    api: API endpoint tests
    database: Database operation tests

    # Framework Integration
    tcfd: TCFD framework integration
    gri: GRI Standards integration
    sasb: SASB Standards integration

    # Special Test Types
    regression: Regression tests (prevent bugs from returning)
    smoke: Smoke tests (basic functionality check)
    sanity: Sanity tests (quick health check)

################################################################################
# DEFAULT OPTIONS
################################################################################

addopts =
    # Verbosity and output
    -v
    --strict-markers
    --strict-config
    --tb=short
    --color=yes

    # Show test durations
    --durations=10
    --durations-min=1.0

    # Show local variables in tracebacks
    -l

    # Show summary of all test outcomes
    -ra

    # Warnings
    --maxfail=10

    # Output
    --capture=no
    --show-capture=all

################################################################################
# COVERAGE SETTINGS
################################################################################

[coverage:run]
source =
    agents
    cli
    sdk
    provenance
    connectors
    csrd_pipeline

omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */venv/*
    */virtualenv/*
    */.venv/*
    */site-packages/*
    setup.py
    */migrations/*

branch = True
parallel = True
concurrency = multiprocessing

[coverage:report]
precision = 2
show_missing = True
skip_covered = False
skip_empty = False

# Fail if coverage is below threshold
fail_under = 85

# Exclude specific patterns from coverage
exclude_lines =
    # Standard pragma
    pragma: no cover

    # Don't complain about missing debug code
    def __repr__
    def __str__

    # Don't complain if tests don't hit defensive assertion code
    raise AssertionError
    raise NotImplementedError

    # Don't complain if non-runnable code isn't run
    if 0:
    if False:
    if __name__ == .__main__.:

    # Don't complain about type checking code
    if TYPE_CHECKING:
    if typing.TYPE_CHECKING:

    # Don't complain about abstract methods
    @abstractmethod
    @abc.abstractmethod

[coverage:html]
directory = htmlcov
title = GL-CSRD Test Coverage Report

[coverage:json]
output = test-reports/coverage.json
pretty_print = True

################################################################################
# TEST OUTPUT & LOGGING
################################################################################

console_output_style = progress
log_cli = False
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = test-reports/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

################################################################################
# WARNINGS & FILTERS
################################################################################

filterwarnings =
    # Ignore deprecation warnings
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning

    # Ignore specific library warnings
    ignore::UserWarning:openpyxl
    ignore::FutureWarning:pandas

    # Convert some warnings to errors (strict mode)
    error::RuntimeWarning

    # Ignore cryptography warnings
    ignore:.*cryptography.*:DeprecationWarning

################################################################################
# PARALLEL EXECUTION (pytest-xdist)
################################################################################

# When using -n auto or -n <num>
[pytest-xdist]
looponfail = False
rsyncignore = .git .tox *.pyc *.egg-info

################################################################################
# TIMEOUTS
################################################################################

# Maximum time for a single test (requires pytest-timeout)
timeout = 300
timeout_method = thread

################################################################################
# TEST CATEGORIES - Quick Reference
################################################################################

# Run fast tests only:
#   pytest -m "not slow"
#
# Run critical tests only:
#   pytest -m critical
#
# Run specific ESRS standard:
#   pytest -m esrs_e1
#
# Run specific agent:
#   pytest -m calculator
#
# Run with coverage:
#   pytest --cov --cov-report=html
#
# Run in parallel:
#   pytest -n auto
#
# Run by agent priority:
#   pytest tests/test_calculator_agent.py tests/test_reporting_agent.py
#
################################################################################
