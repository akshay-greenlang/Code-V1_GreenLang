# ============================================================================
# AGENT SPECIFICATION: XBRL REPORTING & PACKAGING AGENT
# AgentSpec V2.0 Compliant
# ============================================================================

# ----------------------------------------------------------------------------
# SECTION 1: AGENT METADATA
# ----------------------------------------------------------------------------
agent_metadata:
  agent_id: "csrd_reporting_agent"
  agent_name: "ReportingAgent"
  display_name: "XBRL Reporting & Packaging Agent"
  version: "1.1.0"
  domain: "CSRD/ESG Reporting"
  subdomain: "Report Generation & ESEF Packaging"
  agent_type: "report-generator"
  complexity: "high"
  priority: "critical"
  status: "production"
  deterministic: false  # Hybrid: deterministic XBRL + AI narratives
  llm_usage: true  # Only for narrative generation
  zero_hallucination: false  # AI narratives require human review
  requires_human_review: true

# ----------------------------------------------------------------------------
# SECTION 2: DESCRIPTION
# ----------------------------------------------------------------------------
description:
  purpose: |
    Generate ESEF-compliant CSRD reports with XBRL tagging and AI-assisted
    narrative sections.

  strategic_context:
    global_impact: "Enables compliant digital CSRD reporting for EU companies"
    opportunity: "Reduce report generation time from 2 weeks to 2 hours (95% reduction)"
    market_size: "ESEF/XBRL reporting market estimated at â‚¬3B annually"
    technology_maturity: "TRL 8 (System complete and qualified)"

  capabilities:
    - "XBRL digital tagging (1,000+ ESRS data points)"
    - "ESEF package generation (.zip)"
    - "Management report generation (PDF)"
    - "Narrative section drafting (AI-assisted, requires review)"
    - "Multi-language support (EN, DE, FR, ES)"
    - "iXBRL inline tagging"

  key_features:
    - "<5 min processing time for complete report"
    - "Full ESEF compliance (deterministic)"
    - "AI-generated narratives (requires review)"
    - "Multi-language report generation"
    - "Hybrid mode: deterministic tagging + AI narratives"

  dependencies:
    - agent_id: "aggregator_agent"
      relationship: "receives_data_from"
      data: "aggregated_esg_data"
    - agent_id: "materiality_agent"
      relationship: "receives_data_from"
      data: "materiality_matrix"
    - agent_id: "audit_agent"
      relationship: "provides_data_to"
      data: "csrd_report_package"

  important_warnings:
    - "HYBRID MODE: XBRL tagging is deterministic, narrative generation uses AI"
    - "MANDATORY REVIEW: AI-generated narratives must be reviewed by sustainability team"
    - "NOT FULLY DETERMINISTIC: Same input may produce different narratives (but same XBRL)"

# ----------------------------------------------------------------------------
# INPUTS
# ----------------------------------------------------------------------------
inputs:
  primary_inputs:
    - name: "aggregated_esg_data"
      type: "json"
      required: true
      source: "Output from AggregatorAgent"

    - name: "materiality_matrix"
      type: "json"
      required: true
      source: "Output from MaterialityAgent"

    - name: "company_profile"
      type: "json"
      required: true

  reference_data:
    - name: "esrs_xbrl_taxonomy"
      path: "data/esrs_xbrl_taxonomy_v1.xsd"
      description: "ESRS XBRL taxonomy (1,000+ tags)"
      required: true

# ----------------------------------------------------------------------------
# OUTPUTS
# ----------------------------------------------------------------------------
outputs:
  - name: "csrd_report_package"
    format: "zip"
    description: "Complete ESEF submission package"
    contents:
      - "sustainability_statement.xhtml (iXBRL)"
      - "management_report.pdf"
      - "xbrl_instance.xml"
      - "metadata.json"
      - "digital_signature.p7s (optional)"

  - name: "management_report"
    format: "pdf"
    description: "Human-readable PDF report"

  - name: "xbrl_validation_report"
    format: "json"
    description: "XBRL taxonomy validation results"

# ----------------------------------------------------------------------------
# SECTION 3: TOOLS
# ----------------------------------------------------------------------------
tools:
  tools_list:
    - tool_id: "xbrl_tagger"
      name: "xbrl-tagger"
      deterministic: true  # XBRL tagging IS deterministic
      category: "formatting"
      description: "Map ESRS metrics to XBRL tags"

      parameters:
        type: "object"
        properties:
          metric_code: {type: "string", description: "ESRS metric code"}
          value: {type: "number", description: "Metric value"}
          context: {type: "object", description: "XBRL context"}
        required: ["metric_code", "value"]

      returns:
        type: "object"
        properties:
          xbrl_tag: {type: "string", description: "XBRL tag element"}
          ixbrl_element: {type: "string", description: "iXBRL HTML element"}

      implementation:
        method: "Taxonomy lookup and iXBRL generation"
        taxonomy: "data/esrs_xbrl_taxonomy_v1.xsd"
        calculation_method: "Direct mapping via taxonomy"
        accuracy: "100% deterministic"
        validation: "Arelle XBRL validator"
        standards: ["ESRS XBRL Taxonomy", "ESEF Regulation"]

    - tool_id: "narrative_generator"
      name: "narrative-generator"
      deterministic: false  # AI-powered
      category: "ai-generation"
      description: "AI-assisted narrative drafting"
      requires_review: true

      parameters:
        type: "object"
        properties:
          section: {type: "string", description: "Governance|Strategy|Risk|Metrics"}
          data_context: {type: "object", description: "ESG data for context"}
        required: ["section", "data_context"]

      returns:
        type: "object"
        properties:
          narrative: {type: "string", description: "AI-generated narrative"}
          confidence: {type: "number", description: "AI confidence 0-1"}

      implementation:
        method: "LLM-based narrative generation"
        model: "gpt-4o"
        temperature: 0.5  # Moderate creativity for narratives
        calculation_method: "Template-based generation with context injection"
        accuracy: "Requires human review - not deterministic"
        validation: "Sustainability team review mandatory"
        standards: ["ESRS Narrative Requirements"]

    - tool_id: "esef_packager"
      name: "esef-packager"
      deterministic: true
      category: "packaging"
      description: "Generate ESEF-compliant ZIP package"

      parameters:
        type: "object"
        properties:
          ixbrl_doc: {type: "string", description: "iXBRL document"}
          metadata: {type: "object", description: "Report metadata"}
        required: ["ixbrl_doc", "metadata"]

      returns:
        type: "object"
        properties:
          package_path: {type: "string", description: "Path to ZIP file"}

      implementation:
        method: "ZIP packaging per ESEF spec"
        calculation_method: "Deterministic file packaging"
        accuracy: "100% deterministic"
        validation: "ESEF validation tool"
        standards: ["ESEF Regulation (EU 2019/815)"]

    - tool_id: "pdf_generator"
      name: "pdf-generator"
      deterministic: true
      category: "formatting"
      description: "Generate PDF management report"

      parameters:
        type: "object"
        properties:
          content: {type: "object", description: "Report content"}
        required: ["content"]

      returns:
        type: "object"
        properties:
          pdf_path: {type: "string", description: "Path to PDF file"}

      implementation:
        method: "HTML to PDF conversion"
        calculation_method: "Deterministic rendering"
        accuracy: "100% deterministic"
        validation: "PDF/A compliance check"
        standards: ["PDF/A-3"]

# ----------------------------------------------------------------------------
# SECTION 4: AI INTEGRATION
# ----------------------------------------------------------------------------
ai_integration:
  enabled: true  # For narrative generation only
  hybrid_mode: true  # Mixed deterministic + AI
  deterministic_tools:
    - "xbrl-tagger"  # temperature=0.0
    - "esef-packager"  # temperature=0.0
    - "pdf-generator"  # temperature=0.0
  ai_powered_tools:
    - "narrative-generator"  # temperature=0.5, requires review
  model: "gpt-4o"
  temperature: 0.5  # For narrative generation only
  seed: null  # AI narratives are creative, not deterministic
  provenance_tracking: true
  tool_choice: "auto"
  max_iterations: 5
  budget_usd: 2.00
  requires_human_review: true
  hallucination_risk: "MODERATE"
  human_review_checklist:
    - "Narratives accurate and aligned with data?"
    - "Governance disclosures complete?"
    - "Strategy section clear?"
    - "Risk management adequately described?"
    - "No misleading statements?"

# ----------------------------------------------------------------------------
# SECTION 5: SUB-AGENTS
# ----------------------------------------------------------------------------
sub_agents:
  enabled: false
  coordination_pattern: "N/A"
  sub_agent_list: []
  rationale: "This is a leaf-level agent with no sub-agents"

# ----------------------------------------------------------------------------
# PROCESSING WORKFLOW
# ----------------------------------------------------------------------------
processing_workflow:
  step_1_xbrl_tagging:
    name: "XBRL Digital Tagging"
    method: "Deterministic mapping"
    process: |
      FOR each ESRS metric:
        xbrl_tag = esrs_xbrl_taxonomy[metric_code]
        create_ixbrl_element(xbrl_tag, metric_value, context, unit)

  step_2_narrative_generation:
    name: "AI-Assisted Narrative Drafting"
    llm_model: "gpt-4o"
    requires_review: true
    sections:
      - "Governance disclosure"
      - "Strategy disclosure"
      - "Risk management disclosure"
      - "Topic-specific narratives"

  step_3_esef_packaging:
    name: "Generate ESEF Package"
    method: "Deterministic"
    output: ".zip file with all required components"

  step_4_pdf_generation:
    name: "Generate PDF Report"
    method: "Deterministic"

  step_5_xbrl_validation:
    name: "Validate XBRL"
    tool: "Arelle validator"
    checks:
      - "Schema compliance"
      - "Calculation consistency"
      - "Context validity"

# ----------------------------------------------------------------------------
# SECTION 6: TESTING
# ----------------------------------------------------------------------------
testing:
  test_coverage_target: 0.80

  test_categories:
    - category: "unit_tests"
      description: "Test individual tools (deterministic and AI mocked)"
      count: 20
      examples:
        - "test_xbrl_tagger_deterministic"
        - "test_esef_packager_deterministic"
        - "test_pdf_generator"
        - "test_narrative_generator_mocked"

    - category: "integration_tests"
      description: "Test full reporting workflows"
      count: 8
      examples:
        - "test_complete_report_generation"
        - "test_xbrl_validation_passes"
        - "test_esef_package_compliance"

    - category: "determinism_tests"
      description: "Verify deterministic components only"
      count: 5
      examples:
        - "test_xbrl_tagging_reproducible"
        - "test_esef_packaging_deterministic"
      note: "Narrative generation is NOT tested for determinism"

    - category: "boundary_tests"
      description: "Test edge cases"
      count: 10
      examples:
        - "test_missing_xbrl_taxonomy"
        - "test_invalid_metric_codes"
        - "test_large_report_generation"

  performance_requirements:
    max_latency_ms: 300000  # 5 minutes
    max_cost_usd: 2.00
    accuracy_target: 0.90  # 90% for hybrid mode
    xbrl_compliance: 1.0  # 100% XBRL compliance

# ----------------------------------------------------------------------------
# SECTION 7: DEPLOYMENT
# ----------------------------------------------------------------------------
deployment:
  pack_id: "csrd/reporting_agent"
  pack_version: "1.1.0"

  resource_requirements:
    memory_mb: 2048
    cpu_cores: 2
    gpu_required: false
    storage_mb: 1000

  dependencies:
    python_packages:
      - "openai>=1.0,<2.0"
      - "lxml>=4.9,<5.0"
      - "reportlab>=3.6,<4.0"
      - "pydantic>=2.0,<3.0"

    greenlang_modules:
      - "greenlang.agents.base"
      - "greenlang.intelligence"
      - "greenlang.core.xbrl"

  api_endpoints:
    - endpoint: "/api/v1/csrd/reporting/execute"
      method: "POST"
      authentication: "required"
      rate_limit: "10 req/hour"

  environment_config:
    - name: "OPENAI_API_KEY"
      required: true
      description: "OpenAI API key for narrative generation"
    - name: "ESRS_XBRL_TAXONOMY_PATH"
      required: true
      description: "Path to ESRS XBRL taxonomy"

# ----------------------------------------------------------------------------
# SECTION 8: DOCUMENTATION
# ----------------------------------------------------------------------------
documentation:
  readme_path: "docs/agents/reporting_agent/README.md"
  api_docs_path: "docs/agents/reporting_agent/API.md"

  example_use_cases:
    - title: "Complete CSRD Report Generation"
      description: "Generate full ESEF package"
      output_summary: "XBRL-tagged report with AI narratives ready for submission"

    - title: "Multi-Language Report"
      description: "Generate report in multiple languages"
      output_summary: "Reports in EN, DE, FR generated with localized narratives"

  guides:
    - "Getting Started with ReportingAgent"
    - "XBRL Tagging Guide"
    - "Reviewing AI-Generated Narratives"
    - "ESEF Compliance Checklist"

# ----------------------------------------------------------------------------
# SECTION 9: COMPLIANCE
# ----------------------------------------------------------------------------
compliance:
  zero_secrets: true

  standards:
    - "ESRS Set 1"
    - "ESEF Regulation (EU 2019/815)"
    - "XBRL International Standards"
    - "CSRD Directive (EU 2022/2464)"

  security:
    secret_scanning: "GL-SecScan validated"
    vulnerability_scanning: "pip-audit clean"
    sbom_generated: true
    code_signing: false

  data_privacy:
    pii_handling: "No PII processed"
    data_retention: "As per company policy"
    encryption: "Data in transit: TLS 1.3"

  ai_governance:
    model_registry: "Approved models: GPT-4o"
    human_review_mandatory: true
    output_validation: "Sustainability team review required for narratives"
    bias_monitoring: "Track narrative quality across sectors"
    explainability: "Narrative sources documented"

# ----------------------------------------------------------------------------
# PERFORMANCE
# ----------------------------------------------------------------------------
performance:
  target_processing_time: "<5 min"
  xbrl_tagging_speed: "<1 min for 1,000 tags"

guarantees:
  xbrl_compliance: true
  esef_compliance: true
  human_review_required: true
  hybrid_mode: "deterministic_xbrl + ai_narratives"

# ----------------------------------------------------------------------------
# SECTION 10: METADATA
# ----------------------------------------------------------------------------
metadata:
  created_date: "2025-10-18"
  last_modified: "2025-10-18"
  review_status: "Upgraded to AgentSpec V2.0"

  authors:
    - name: "CSRD Platform Team"
      role: "Development"

  reviewers:
    - name: "Head of AI & Climate Intelligence"
      role: "Technical Review"
      status: "Pending"

  change_log:
    - version: "1.1.0"
      date: "2025-10-18"
      changes: "Upgraded to AgentSpec V2.0 compliance - Added agent_metadata, enhanced description, upgraded tools section, added ai_integration (hybrid mode), sub_agents, testing, deployment, documentation, compliance, and metadata sections"
      author: "CSRD Platform Team"
      breaking_changes: false

    - version: "1.0.0"
      date: "2025-10-18"
      changes: "Initial release with hybrid deterministic XBRL + AI narratives"
      author: "CSRD Platform Team"
      breaking_changes: false
