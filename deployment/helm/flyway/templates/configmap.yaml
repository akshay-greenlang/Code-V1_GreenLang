{{/*
=============================================================================
GreenLang Flyway ConfigMap Template
=============================================================================
*/}}

{{- $fullName := include "flyway.fullname" . -}}
{{- $labels := include "flyway.labels" . -}}

# =============================================================================
# Flyway Configuration ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: configuration
data:
  # Database connection info (non-sensitive)
  db_host: {{ .Values.database.host | quote }}
  db_port: {{ .Values.database.port | quote }}
  db_name: {{ .Values.database.name | quote }}
  jdbc_url: {{ include "flyway.jdbcUrl" . | quote }}

  # Environment
  environment: {{ .Values.global.environment | quote }}

  # TimescaleDB settings
  retention_days: {{ .Values.timescaledb.retentionDays | quote }}
  compression_after_days: {{ .Values.timescaledb.compressionAfterDays | quote }}
  chunk_interval: {{ .Values.timescaledb.chunkInterval | quote }}

  # AWS region
  aws_region: {{ .Values.aws.region | quote }}

  # Flyway configuration file
  flyway.conf: |
    # =============================================================================
    # GreenLang Flyway Configuration
    # Generated by Helm chart
    # =============================================================================

    # Database Connection (values from environment variables)
    flyway.url=${FLYWAY_URL}
    flyway.user=${FLYWAY_USER}
    flyway.password=${FLYWAY_PASSWORD}
    flyway.connectRetries={{ .Values.database.connectRetries }}
    flyway.connectRetriesInterval={{ .Values.database.connectRetriesInterval }}

    # Schema Configuration
    flyway.schemas={{ join "," .Values.migration.schemas }}
    flyway.defaultSchema={{ .Values.migration.defaultSchema }}
    flyway.createSchemas={{ .Values.migration.createSchemas }}

    # Migration Locations
    flyway.locations={{ join "," .Values.migration.locations }}

    # Baseline Configuration
    flyway.baselineOnMigrate={{ .Values.migration.baselineOnMigrate }}
    flyway.baselineVersion={{ .Values.migration.baselineVersion }}
    flyway.baselineDescription={{ .Values.migration.baselineDescription }}

    # Validation
    flyway.validateOnMigrate={{ .Values.migration.validateOnMigrate }}
    flyway.validateMigrationNaming={{ .Values.migration.validateMigrationNaming }}
    flyway.cleanOnValidationError={{ .Values.migration.cleanOnValidationError }}

    # Execution
    flyway.outOfOrder={{ .Values.migration.outOfOrder }}
    flyway.mixed={{ .Values.migration.mixed }}
    flyway.group={{ .Values.migration.group }}
    flyway.lockRetryCount={{ .Values.migration.lockRetryCount }}

    # Naming Conventions
    flyway.sqlMigrationPrefix=V
    flyway.repeatableSqlMigrationPrefix=R
    flyway.sqlMigrationSeparator=__
    flyway.sqlMigrationSuffixes=.sql

    # Encoding
    flyway.encoding=UTF-8

    # Placeholders
    flyway.placeholderReplacement=true
    flyway.placeholderPrefix=${
    flyway.placeholderSuffix=}
    flyway.placeholders.environment=${ENVIRONMENT}
    flyway.placeholders.retention_days=${RETENTION_DAYS}
    flyway.placeholders.compression_after_days=${COMPRESSION_AFTER_DAYS}
    flyway.placeholders.chunk_interval=${CHUNK_INTERVAL}
    flyway.placeholders.compression_segmentby={{ .Values.timescaledb.compressionSegmentBy }}
    flyway.placeholders.compression_orderby={{ .Values.timescaledb.compressionOrderBy }}

    # Safety
    flyway.cleanDisabled={{ .Values.migration.cleanDisabled }}
    flyway.failOnMissingLocations={{ .Values.migration.failOnMissingLocations }}

    # Output
    flyway.outputType={{ .Values.monitoring.logging.format }}

    {{- with .Values.extraConfig }}
    # Extra Configuration
    {{- range $key, $value := . }}
    {{ $key }}={{ $value }}
    {{- end }}
    {{- end }}

---
# =============================================================================
# SQL Migrations ConfigMap (for development/testing)
# =============================================================================
{{- if .Values.sqlMigrations.configMap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.sqlMigrations.configMap.name | default (printf "%s-sql" $fullName) }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: migrations
data:
  # README for migrations
  README.md: |
    # SQL Migrations

    In production, SQL migration files should be:
    1. Baked into a custom Flyway Docker image, OR
    2. Stored in S3 and referenced via flyway.locations

    This ConfigMap is a placeholder for development/testing.

    ## Available Migrations:
    - V001__initial_schema.sql - Core tables, audit triggers, indexes
    - V002__timescaledb_setup.sql - TimescaleDB extension, hypertables, compression
    - V003__emission_tables.sql - Emission measurements, factors, continuous aggregates
    - V004__sensor_data.sql - Sensor readings, device registry, calibration
    - V005__audit_tables.sql - Audit log, user activity, API requests

  {{- with .Values.sqlMigrations.inline }}
  {{- range $name, $content := . }}
  {{ $name }}: |
    {{- $content | nindent 4 }}
  {{- end }}
  {{- end }}
{{- end }}

---
# =============================================================================
# Helper Templates
# =============================================================================
{{- define "flyway.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default "flyway" .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{- define "flyway.labels" -}}
helm.sh/chart: {{ include "flyway.chart" . }}
{{ include "flyway.selectorLabels" . }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
app.kubernetes.io/part-of: greenlang
{{- end }}

{{- define "flyway.selectorLabels" -}}
app.kubernetes.io/name: {{ include "flyway.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app: flyway
component: database-migration
{{- end }}

{{- define "flyway.name" -}}
{{- default "flyway" .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{- define "flyway.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{- define "flyway.jdbcUrl" -}}
{{- if .Values.database.jdbcUrl }}
{{- .Values.database.jdbcUrl }}
{{- else }}
{{- printf "jdbc:postgresql://%s:%s/%s?sslmode=%s" .Values.database.host (toString .Values.database.port) .Values.database.name .Values.database.sslMode }}
{{- end }}
{{- end }}
