# =============================================================================
# Kong API Gateway - Production Defaults
# GreenLang Climate OS | infra-006
# =============================================================================

# ---------------------------------------------------------------------------
# Kong subchart configuration
# ---------------------------------------------------------------------------
kong:
  enabled: true

  image:
    repository: kong
    tag: "3.6"
    pullPolicy: IfNotPresent

  replicaCount: 3

  # -------------------------------------------------------------------------
  # Kong environment variables
  # -------------------------------------------------------------------------
  env:
    database: "off"
    declarative_config: /kong-config/kong.yaml
    proxy_listen: "0.0.0.0:8000 reuseport backlog=16384, 0.0.0.0:8443 http2 ssl reuseport backlog=16384"
    status_listen: "0.0.0.0:8100"
    admin_listen: "127.0.0.1:8001"
    nginx_worker_processes: "auto"
    log_level: "warn"
    plugins: "bundled,gl-tenant-isolation"
    proxy_access_log: "/dev/stdout"
    proxy_error_log: "/dev/stderr"
    admin_access_log: "off"
    admin_error_log: "/dev/stderr"
    # -------------------------------------------------------------------------
    # TLS 1.3 Configuration (SEC-004)
    # -------------------------------------------------------------------------
    nginx_proxy_ssl_protocols: "TLSv1.2 TLSv1.3"
    nginx_proxy_ssl_ciphers: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"
    nginx_proxy_ssl_prefer_server_ciphers: "on"
    nginx_proxy_ssl_session_timeout: "1d"
    nginx_proxy_ssl_session_cache: "shared:SSL:50m"
    nginx_proxy_ssl_session_tickets: "off"

  # -------------------------------------------------------------------------
  # Proxy service
  # -------------------------------------------------------------------------
  proxy:
    enabled: true
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
      service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    http:
      enabled: true
      containerPort: 8000
      servicePort: 80
    tls:
      enabled: true
      containerPort: 8443
      servicePort: 443
      parameters:
        - http2

  # -------------------------------------------------------------------------
  # Admin API service (locked to loopback in production)
  # -------------------------------------------------------------------------
  admin:
    enabled: false
    type: ClusterIP
    http:
      enabled: true
      containerPort: 8001
      servicePort: 8001

  # -------------------------------------------------------------------------
  # Status endpoint
  # -------------------------------------------------------------------------
  status:
    enabled: true
    http:
      enabled: true
      containerPort: 8100

  # -------------------------------------------------------------------------
  # Ingress controller
  # -------------------------------------------------------------------------
  ingressController:
    enabled: true
    installCRDs: false
    env:
      publish_service: "greenlang/kong-gateway-kong-proxy"
      kong_admin_url: "http://localhost:8001"

  # -------------------------------------------------------------------------
  # Resource allocation
  # -------------------------------------------------------------------------
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

  # -------------------------------------------------------------------------
  # Horizontal Pod Autoscaler
  # -------------------------------------------------------------------------
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70

  # -------------------------------------------------------------------------
  # Pod Disruption Budget
  # -------------------------------------------------------------------------
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  # -------------------------------------------------------------------------
  # Node scheduling
  # -------------------------------------------------------------------------
  nodeSelector:
    node-role.kubernetes.io/infra: "true"

  tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "infra"
      effect: "NoSchedule"

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - kong-gateway
            topologyKey: kubernetes.io/hostname

  # -------------------------------------------------------------------------
  # Service monitor (Prometheus)
  # -------------------------------------------------------------------------
  serviceMonitor:
    enabled: true
    namespace: monitoring
    interval: 15s
    labels:
      release: prometheus

  # -------------------------------------------------------------------------
  # Extra volume mounts for declarative config and custom plugins
  # -------------------------------------------------------------------------
  extraVolumeMounts:
    - name: kong-declarative-config
      mountPath: /kong-config
      readOnly: true
    - name: kong-custom-plugins
      mountPath: /opt/kong/plugins/gl-tenant-isolation
      readOnly: true

  extraVolumes:
    - name: kong-declarative-config
      configMap:
        name: kong-declarative-config
    - name: kong-custom-plugins
      configMap:
        name: kong-custom-plugins

# ---------------------------------------------------------------------------
# Redis configuration (rate limiting backend)
# ---------------------------------------------------------------------------
redis:
  host: "redis-master.greenlang.svc.cluster.local"
  port: 6379
  database: 3
  existingSecret: "kong-redis-credentials"
  secretKeys:
    password: "redis-password"

# ---------------------------------------------------------------------------
# Custom plugin configuration
# ---------------------------------------------------------------------------
customPlugins:
  glTenantIsolation:
    enabled: true
    configMapName: kong-custom-plugins

# ---------------------------------------------------------------------------
# Declarative configuration
# ---------------------------------------------------------------------------
declarativeConfig:
  enabled: true
  configMapName: kong-declarative-config

# ---------------------------------------------------------------------------
# JWT signing key (stored in Secret)
# ---------------------------------------------------------------------------
jwt:
  existingSecret: "kong-jwt-signing-key"
  secretKeys:
    key: "jwt-signing-key"

# ---------------------------------------------------------------------------
# TLS certificates
# ---------------------------------------------------------------------------
tls:
  enabled: true
  certManager:
    enabled: true
    issuerRef:
      name: letsencrypt-prod
      kind: ClusterIssuer

# ---------------------------------------------------------------------------
# Global metadata
# ---------------------------------------------------------------------------
global:
  environment: production
  project: greenlang
  component: api-gateway
