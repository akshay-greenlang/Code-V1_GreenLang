{{/*
=============================================================================
Kong API Gateway - Deployment
GreenLang Climate OS | infra-006
=============================================================================
*/}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "kong-gateway.fullname" . }}
  namespace: {{ include "kong-gateway.namespace" . }}
  labels:
    {{- include "kong-gateway.labels" . | nindent 4 }}
  annotations:
    {{- include "kong-gateway.annotations" . | nindent 4 }}
spec:
  {{- if not .Values.kong.autoscaling.enabled }}
  replicas: {{ .Values.kong.replicaCount }}
  {{- end }}
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      {{- include "kong-gateway.selectorLabels" . | nindent 6 }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        {{- include "kong-gateway.labels" . | nindent 8 }}
      annotations:
        {{- include "kong-gateway.annotations" . | nindent 8 }}
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}
        prometheus.io/scrape: "true"
        prometheus.io/port: "8100"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: {{ include "kong-gateway.serviceAccountName" . }}
      terminationGracePeriodSeconds: 45

      # -----------------------------------------------------------------------
      # Pod-level security context
      # -----------------------------------------------------------------------
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # -----------------------------------------------------------------------
      # Init containers
      # -----------------------------------------------------------------------
      initContainers:
        - name: wait-for-redis
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for Redis at {{ .Values.redis.host }}:{{ .Values.redis.port }}..."
              until nc -z -w 5 {{ .Values.redis.host }} {{ .Values.redis.port }}; do
                echo "Redis not ready, sleeping 3s..."
                sleep 3
              done
              echo "Redis is available."
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
            limits:
              cpu: "100m"
              memory: "64Mi"

      # -----------------------------------------------------------------------
      # Containers
      # -----------------------------------------------------------------------
      containers:
        # -- Kong Gateway -------------------------------------------------------
        - name: kong-gateway
          image: {{ include "kong-gateway.image" . }}
          imagePullPolicy: {{ .Values.kong.image.pullPolicy }}

          ports:
            - name: proxy
              containerPort: 8000
              protocol: TCP
            - name: proxy-tls
              containerPort: 8443
              protocol: TCP
            - name: status
              containerPort: 8100
              protocol: TCP
            - name: admin
              containerPort: 8001
              protocol: TCP

          # -- Environment variables --------------------------------------------
          env:
            - name: KONG_DATABASE
              value: {{ .Values.kong.env.database | quote }}
            - name: KONG_DECLARATIVE_CONFIG
              value: {{ .Values.kong.env.declarative_config | quote }}
            - name: KONG_PROXY_LISTEN
              value: {{ .Values.kong.env.proxy_listen | quote }}
            - name: KONG_STATUS_LISTEN
              value: {{ .Values.kong.env.status_listen | quote }}
            - name: KONG_ADMIN_LISTEN
              value: {{ .Values.kong.env.admin_listen | quote }}
            - name: KONG_NGINX_WORKER_PROCESSES
              value: {{ .Values.kong.env.nginx_worker_processes | quote }}
            - name: KONG_LOG_LEVEL
              value: {{ .Values.kong.env.log_level | quote }}
            - name: KONG_PLUGINS
              value: {{ .Values.kong.env.plugins | quote }}
            - name: KONG_PROXY_ACCESS_LOG
              value: {{ .Values.kong.env.proxy_access_log | quote }}
            - name: KONG_PROXY_ERROR_LOG
              value: {{ .Values.kong.env.proxy_error_log | quote }}
            - name: KONG_ADMIN_ACCESS_LOG
              value: {{ .Values.kong.env.admin_access_log | quote }}
            - name: KONG_ADMIN_ERROR_LOG
              value: {{ .Values.kong.env.admin_error_log | quote }}
            - name: KONG_LUA_PACKAGE_PATH
              value: "/opt/kong/plugins/?.lua;/opt/kong/plugins/?/init.lua;;"
            - name: KONG_NGINX_PROXY_PROXY_BUFFER_SIZE
              value: "128k"
            - name: KONG_NGINX_PROXY_PROXY_BUFFERS
              value: "4 256k"
            # -- Redis for rate limiting ----------------------------------------
            - name: KONG_REDIS_HOST
              value: {{ .Values.redis.host | quote }}
            - name: KONG_REDIS_PORT
              value: {{ .Values.redis.port | quote }}
            - name: KONG_REDIS_DATABASE
              value: {{ .Values.redis.database | quote }}
            - name: KONG_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.redis.existingSecret }}
                  key: {{ .Values.redis.secretKeys.password }}

          # -- Volume mounts ----------------------------------------------------
          volumeMounts:
            - name: kong-declarative-config
              mountPath: /kong-config
              readOnly: true
            - name: kong-custom-plugins
              mountPath: /opt/kong/plugins/gl-tenant-isolation
              readOnly: true
            - name: tmp-volume
              mountPath: /tmp
            - name: kong-prefix
              mountPath: /kong_prefix

          # -- Security context (container level) -------------------------------
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

          # -- Probes -----------------------------------------------------------
          startupProbe:
            httpGet:
              path: /status
              port: status
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 30
            timeoutSeconds: 3

          livenessProbe:
            httpGet:
              path: /status
              port: status
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

          readinessProbe:
            httpGet:
              path: /status/ready
              port: status
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
            successThreshold: 1

          # -- Resources --------------------------------------------------------
          resources:
            {{- toYaml .Values.kong.resources | nindent 12 }}

        # -- Kong Ingress Controller (sidecar) ---------------------------------
        {{- if .Values.kong.ingressController.enabled }}
        - name: ingress-controller
          image: kong/kubernetes-ingress-controller:3.1
          imagePullPolicy: IfNotPresent
          args:
            - --kong-admin-url=http://localhost:8001
            - --publish-service={{ include "kong-gateway.namespace" . }}/{{ include "kong-gateway.fullname" . }}-proxy
            - --election-id={{ include "kong-gateway.fullname" . }}-leader
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CONTROLLER_KONG_ADMIN_URL
              value: "http://localhost:8001"
          ports:
            - name: health
              containerPort: 10254
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: health
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /readyz
              port: health
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
        {{- end }}

      # -----------------------------------------------------------------------
      # Volumes
      # -----------------------------------------------------------------------
      volumes:
        - name: kong-declarative-config
          configMap:
            name: {{ include "kong-gateway.fullname" . }}-declarative-config
        - name: kong-custom-plugins
          configMap:
            name: {{ include "kong-gateway.fullname" . }}-custom-plugins
        - name: tmp-volume
          emptyDir:
            sizeLimit: 128Mi
        - name: kong-prefix
          emptyDir:
            sizeLimit: 256Mi

      # -----------------------------------------------------------------------
      # Scheduling constraints
      # -----------------------------------------------------------------------
      {{- with .Values.kong.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.kong.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- if .Values.kong.affinity }}
      affinity:
        {{- toYaml .Values.kong.affinity | nindent 8 }}
      {{- else }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "kong-gateway.selectorLabels" . | nindent 20 }}
                topologyKey: kubernetes.io/hostname
      {{- end }}

      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              {{- include "kong-gateway.selectorLabels" . | nindent 14 }}
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              {{- include "kong-gateway.selectorLabels" . | nindent 14 }}
