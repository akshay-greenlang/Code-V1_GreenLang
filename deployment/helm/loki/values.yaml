# =============================================================================
# GreenLang Loki - Production Values
# GreenLang Climate OS | INFRA-009
# =============================================================================
# Simple Scalable Deployment mode for production workloads.
# S3-backed storage with TSDB schema, multi-tenant auth, and compliance-aware
# per-stream retention policies for EUDR, CBAM, SB-253, and CSRD logs.
# =============================================================================

# ---------------------------------------------------------------------------
# Deployment mode
# ---------------------------------------------------------------------------
# SimpleScalable separates Loki into write, read, and backend components
# for independent scaling. Suitable for medium-to-large production clusters.
deploymentMode: SimpleScalable

# ---------------------------------------------------------------------------
# Loki configuration
# ---------------------------------------------------------------------------
loki:
  # -------------------------------------------------------------------------
  # Authentication
  # -------------------------------------------------------------------------
  # Multi-tenant mode requires X-Scope-OrgID header on all requests.
  # Each GreenLang environment and compliance service gets its own tenant.
  auth_enabled: true

  # -------------------------------------------------------------------------
  # Schema configuration
  # -------------------------------------------------------------------------
  schemaConfig:
    configs:
      - from: "2026-03-01"
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  # -------------------------------------------------------------------------
  # Storage configuration
  # -------------------------------------------------------------------------
  storage:
    type: s3
    bucketNames:
      chunks: gl-loki-chunks-prod
      ruler: gl-loki-ruler-prod
    s3:
      region: eu-west-1
      # Endpoint and credentials are supplied via IRSA (IAM Roles for Service Accounts).
      # Do not set access_key / secret_key here.

  # -------------------------------------------------------------------------
  # Common configuration
  # -------------------------------------------------------------------------
  commonConfig:
    replication_factor: 3
    ring:
      kvstore:
        store: memberlist

  # -------------------------------------------------------------------------
  # Ingester configuration
  # -------------------------------------------------------------------------
  ingester:
    chunk_idle_period: 30m
    chunk_target_size: 1572864
    max_chunk_age: 2h
    chunk_encoding: snappy
    wal:
      enabled: true

  # -------------------------------------------------------------------------
  # Limits configuration
  # -------------------------------------------------------------------------
  limits_config:
    # -- Global retention period (default for tenants without overrides)
    retention_period: 720h  # 30 days

    # -- Ingestion limits
    ingestion_rate_mb: 20
    ingestion_burst_size_mb: 40
    per_stream_rate_limit: 3MB
    per_stream_rate_limit_burst: 15MB

    # -- Stream limits
    max_global_streams_per_user: 15000
    max_label_names_per_series: 15

    # -- Query limits
    max_entries_limit_per_query: 5000
    max_query_length: 721h
    max_query_parallelism: 16
    split_queries_by_interval: 30m

    # -- Structured metadata (Loki 3.x feature for OTLP attributes)
    allow_structured_metadata: true

    # -- Sample age limits
    reject_old_samples: true
    reject_old_samples_max_age: 168h  # 7 days

    # -- Per-stream retention overrides -----------------------------------
    # Compliance and audit logs are retained longer than the global default
    # to satisfy regulatory requirements (EUDR, CBAM, SB-253, CSRD).
    retention_stream:
      # GreenLang application logs - standard 30-day retention
      - selector: '{namespace="greenlang"}'
        priority: 1
        period: 720h  # 30 days

      # Error logs across all services - 90-day retention for RCA
      - selector: '{level="error"}'
        priority: 2
        period: 2160h  # 90 days

      # Compliance service logs - 90-day retention
      - selector: '{service=~"eudr|cbam|sb253|csrd"}'
        priority: 3
        period: 2160h  # 90 days

      # Audit logs - 1-year retention (regulatory requirement)
      - selector: '{audit="true"}'
        priority: 4
        period: 8760h  # 365 days

      # Default catch-all - 7 days for unmatched streams
      - selector: '{}'
        priority: 0
        period: 168h  # 7 days

  # -------------------------------------------------------------------------
  # Compactor configuration
  # -------------------------------------------------------------------------
  compactor:
    working_directory: /var/loki/compactor
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    compaction_interval: 10m
    delete_request_store: s3

  # -------------------------------------------------------------------------
  # Query range configuration
  # -------------------------------------------------------------------------
  query_range:
    results_cache:
      cache:
        embedded_cache:
          enabled: true
          max_size_mb: 100
    align_queries_with_step: true
    cache_results: true
    parallelise_shardable_queries: true

  # -------------------------------------------------------------------------
  # Ruler configuration
  # -------------------------------------------------------------------------
  ruler:
    storage:
      type: s3
    alertmanager_url: http://alertmanager:9093
    enable_api: true
    ring:
      kvstore:
        store: memberlist

  # -------------------------------------------------------------------------
  # Analytics
  # -------------------------------------------------------------------------
  analytics:
    reporting_enabled: false

# ---------------------------------------------------------------------------
# Write path (ingesters)
# ---------------------------------------------------------------------------
write:
  replicas: 3
  persistence:
    size: 10Gi
    storageClass: gp3
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

# ---------------------------------------------------------------------------
# Read path (queriers + query-frontend)
# ---------------------------------------------------------------------------
read:
  replicas: 3
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 80
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

# ---------------------------------------------------------------------------
# Backend (compactor + ruler + index-gateway)
# ---------------------------------------------------------------------------
backend:
  replicas: 2
  persistence:
    size: 10Gi
    storageClass: gp3
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "2Gi"

# ---------------------------------------------------------------------------
# Gateway (nginx reverse proxy)
# ---------------------------------------------------------------------------
gateway:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# ---------------------------------------------------------------------------
# Single binary (disabled in SimpleScalable mode)
# ---------------------------------------------------------------------------
singleBinary:
  replicas: 0

# ---------------------------------------------------------------------------
# Service account (IRSA for S3 access)
# ---------------------------------------------------------------------------
serviceAccount:
  create: true
  annotations:
    # Replace with the actual IAM role ARN created by the loki-storage Terraform module
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/gl-loki-irsa-prod"

# ---------------------------------------------------------------------------
# Monitoring
# ---------------------------------------------------------------------------
monitoring:
  serviceMonitor:
    enabled: true
    labels:
      release: prometheus
  selfMonitoring:
    enabled: false

# ---------------------------------------------------------------------------
# Per-tenant overrides
# ---------------------------------------------------------------------------
# Tenant-specific limits allow compliance tenants higher ingestion rates
# and longer retention, while keeping dev/staging costs controlled.
overrides:
  greenlang-prod:
    ingestion_rate_mb: 20
    ingestion_burst_size_mb: 40
    max_global_streams_per_user: 15000
    retention_period: 720h  # 30 days

  greenlang-staging:
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    max_global_streams_per_user: 5000
    retention_period: 168h  # 7 days

  greenlang-dev:
    ingestion_rate_mb: 5
    ingestion_burst_size_mb: 10
    max_global_streams_per_user: 2000
    retention_period: 72h  # 3 days

  compliance-audit:
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    max_global_streams_per_user: 5000
    retention_period: 8760h  # 365 days (regulatory)
