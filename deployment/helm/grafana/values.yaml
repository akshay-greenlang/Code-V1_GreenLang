# =============================================================================
# GreenLang Grafana - Base Values
# GreenLang Climate OS | OBS-002
# =============================================================================
# Production-grade Grafana 11.4 with PostgreSQL, Redis, OAuth2, HA,
# sidecar provisioning, image renderer, and unified alerting.
# =============================================================================

global:
  environment: prod
  clusterName: greenlang-prod
  awsRegion: eu-west-1
  domain: grafana.greenlang.io

grafana:
  enabled: true
  image:
    repository: grafana/grafana
    tag: "11.4.0"
    pullPolicy: IfNotPresent
  replicas: 2
  serviceAccount:
    create: true
    name: grafana
    annotations:
      eks.amazonaws.com/role-arn: ""
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 472
    runAsGroup: 472
    fsGroup: 472
    seccompProfile:
      type: RuntimeDefault
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
  persistence:
    enabled: true
    storageClassName: gp3
    accessModes:
      - ReadWriteOnce
    size: 20Gi
  database:
    type: postgres
    host: ""
    port: 5432
    name: grafana
    user: grafana
    passwordSecretName: grafana-db-credentials
    passwordSecretKey: password
    sslMode: verify-full
    caCertPath: /etc/ssl/certs/rds-ca-bundle.pem
    maxOpenConn: 50
    maxIdleConn: 25
    connMaxLifetime: 14400
  redis:
    enabled: true
    host: ""
    port: 6379
    db: 2
    ssl: true
    poolSize: 100
  oauth:
    enabled: true
    name: "GreenLang SSO"
    allowSignUp: true
    autoLogin: false
    clientId: ""
    clientSecret: ""
    scopes: "openid profile email groups"
    authUrl: ""
    tokenUrl: ""
    apiUrl: ""
    roleAttributePath: "contains(groups[*], 'platform-admins') && 'Admin' || contains(groups[*], 'platform-editors') && 'Editor' || 'Viewer'"
    groupsAttributePath: "groups"
    allowedGroups: "platform-admins platform-editors platform-viewers"
    usePkce: true
    useRefreshToken: true
  sidecar:
    enabled: true
    image:
      repository: kiwigrid/k8s-sidecar
      tag: "1.27.6"
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: ALL
      folderAnnotation: grafana_folder
      provider:
        foldersFromFilesStructure: true
    datasources:
      enabled: true
      label: grafana_datasource
      labelValue: "1"
      searchNamespace: ALL
  datasources:
    thanos:
      enabled: true
      url: http://thanos-query.monitoring.svc:9090
      isDefault: true
      timeInterval: "15s"
      queryTimeout: "60s"
    prometheus:
      enabled: true
      url: http://gl-prometheus-server.monitoring.svc:9090
      isDefault: false
      timeInterval: "15s"
      queryTimeout: "30s"
    loki:
      enabled: true
      url: http://loki-read.monitoring.svc:3100
      maxLines: 5000
    jaeger:
      enabled: true
      url: http://jaeger-query.monitoring.svc:16686
    alertmanager:
      enabled: true
      url: http://gl-prometheus-alertmanager.monitoring.svc:9093
    postgresql:
      enabled: true
      host: ""
      port: 5432
      database: greenlang
      user: grafana_reader
      passwordSecretName: grafana-datasource-postgres
      passwordSecretKey: password
      sslMode: verify-full
      timescaledb: true
    cloudwatch:
      enabled: true
      defaultRegion: eu-west-1
      assumeRoleArn: ""
    tempo:
      enabled: true
      name: Tempo
      type: tempo
      url: http://tempo-querier.monitoring.svc:3200
      access: proxy
      isDefault: false
      jsonData:
        tracesToLogs:
          datasourceUid: loki
          spanStartTimeShift: "-1m"
          spanEndTimeShift: "1m"
          tags:
            - key: service.name
              value: service_name
          filterByTraceID: true
          filterBySpanID: true
          mapTagNamesEnabled: true
          mappedTags:
            - key: gl.tenant_id
              value: tenant_id
        tracesToMetrics:
          datasourceUid: thanos
          spanStartTimeShift: "-5m"
          spanEndTimeShift: "5m"
          tags:
            - key: service.name
              value: service
          queries:
            - name: "Request Rate"
              query: "sum(rate(traces_spanmetrics_calls_total{$$__tags}[5m]))"
            - name: "Error Rate"
              query: "sum(rate(traces_spanmetrics_calls_total{$$__tags,status_code=\"STATUS_CODE_ERROR\"}[5m]))"
            - name: "Duration P95"
              query: "histogram_quantile(0.95, sum(rate(traces_spanmetrics_duration_seconds_bucket{$$__tags}[5m])) by (le))"
        serviceMap:
          datasourceUid: thanos
        nodeGraph:
          enabled: true
        search:
          hide: false
        traceQuery:
          timeShiftEnabled: true
          spanStartTimeShift: "-30m"
          spanEndTimeShift: "30m"
        lokiSearch:
          datasourceUid: loki
  unifiedAlerting:
    enabled: true
    executeAlerts: true
    evaluationTimeout: 30s
    maxAttempts: 3
    minInterval: 10s
    ha:
      enabled: true
      listenPort: 9094
      peerService: grafana-headless
      peerPort: 9094
      peerTimeout: 15s
      gossipInterval: 200ms
  notifiers:
    enabled: true
    contactPoints:
      pagerduty:
        enabled: true
        integrationKeySecretName: grafana-pagerduty
        integrationKeySecretKey: integration-key
      slack:
        enabled: true
        criticalWebhookSecretName: grafana-slack
        criticalWebhookSecretKey: webhook-critical
        warningWebhookSecretName: grafana-slack
        warningWebhookSecretKey: webhook-warning
      email:
        enabled: true
        addresses: "platform-team@greenlang.io"
  dashboardProviders:
    - name: executive
      folder: "00-Executive"
      path: /var/lib/grafana/dashboards/executive
    - name: infrastructure
      folder: "01-Infrastructure"
      path: /var/lib/grafana/dashboards/infrastructure
    - name: datastores
      folder: "02-Data-Stores"
      path: /var/lib/grafana/dashboards/datastores
    - name: observability
      folder: "03-Observability"
      path: /var/lib/grafana/dashboards/observability
    - name: security
      folder: "04-Security"
      path: /var/lib/grafana/dashboards/security
    - name: applications
      folder: "05-Applications"
      path: /var/lib/grafana/dashboards/applications
    - name: alerts
      folder: "06-Alerts"
      path: /var/lib/grafana/dashboards/alerts
  smtp:
    enabled: true
    host: ""
    port: 587
    user: ""
    passwordSecretName: grafana-smtp
    passwordSecretKey: password
    fromAddress: grafana@greenlang.io
    fromName: "GreenLang Observability"
    startTlsPolicy: MandatoryStartTLS
  featureToggles:
    - publicDashboards
    - correlations
    - traceToMetrics
    - nestedFolders
    - dashboardScene
    - newTraceViewHeader
    - traceqlSearch
    - metricsSummary
    - lokiQuerySplitting
  security:
    adminUser: admin
    adminPasswordSecretName: grafana-admin
    adminPasswordSecretKey: password
    secretKeySecretName: grafana-admin
    secretKeySecretKey: secret-key
    disableGravatar: true
    cookieSecure: true
    cookieSamesite: strict
    allowEmbedding: false
    strictTransportSecurity: true
    strictTransportSecurityMaxAge: 63072000
    strictTransportSecurityPreload: true
    strictTransportSecuritySubdomains: true
    xContentTypeOptions: true
    xXssProtection: true
    contentSecurityPolicy: true
    angularSupportEnabled: false
  metrics:
    enabled: true
    intervalSeconds: 10
    basicAuth:
      enabled: true
      usernameSecretName: grafana-metrics
      usernameSecretKey: username
      passwordSecretName: grafana-metrics
      passwordSecretKey: password
  rendering:
    enabled: true
    serverUrl: http://grafana-image-renderer:8081/render
    callbackUrl: http://grafana:3000/
    concurrentLimit: 10
  livenessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: grafana
            topologyKey: kubernetes.io/hostname
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: grafana
  tolerations: []
  nodeSelector: {}
  extraEnvVars: []
  extraVolumeMounts: []
  extraVolumes: []

# =============================================================================
# Image Renderer
# =============================================================================
renderer:
  enabled: true
  image:
    repository: grafana/grafana-image-renderer
    tag: "3.11.3"
    pullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi
  service:
    port: 8081
  env:
    BROWSER_TZ: UTC
    RENDERING_CLUSTERING_MODE: browser
    RENDERING_CLUSTERING_MAX_CONCURRENCY: "5"
    RENDERING_VERBOSE_LOGGING: "false"
    LOG_LEVEL: info
  securityContext:
    runAsNonRoot: true
    runAsUser: 472
    runAsGroup: 472
    seccompProfile:
      type: RuntimeDefault

# =============================================================================
# Ingress
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
  hosts:
    - host: grafana.greenlang.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: grafana-tls
      hosts:
        - grafana.greenlang.io

# =============================================================================
# Autoscaling
# =============================================================================
hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

# =============================================================================
# Pod Disruption Budget
# =============================================================================
pdb:
  enabled: true
  minAvailable: 1

# =============================================================================
# Network Policy
# =============================================================================
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kong
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - port: 3000
          protocol: TCP
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - port: 9094
          protocol: TCP

# =============================================================================
# Service Monitor
# =============================================================================
serviceMonitor:
  enabled: true
  interval: 15s
  scrapeTimeout: 10s
  labels:
    release: gl-prometheus
  metricRelabelings: []

# =============================================================================
# Secrets
# =============================================================================
secrets:
  create: true
  adminPassword: ""
  secretKey: ""
  oauthClientSecret: ""
  dbPassword: ""
  smtpPassword: ""