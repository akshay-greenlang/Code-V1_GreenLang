{{/*
Fluent Bit ConfigMap - Log collection and forwarding configuration
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-fluentbit-config
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
        Health_Check  On
        HC_Errors_Count 5
        HC_Retry_Failure_Count 5
        HC_Period     30

    # Input: Container logs
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*greenlang*.log
        Parser            docker
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On
        Refresh_Interval  10
        Read_from_Head    True

    # Input: Application logs
    [INPUT]
        Name              tail
        Tag               app.*
        Path              /app/logs/*.log
        Parser            json
        DB                /var/log/flb_app.db
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On
        Refresh_Interval  5

    # Input: Agent execution logs
    [INPUT]
        Name              tail
        Tag               agent.*
        Path              /app/logs/agents/*.log
        Parser            json
        DB                /var/log/flb_agent.db
        Mem_Buf_Limit     100MB
        Skip_Long_Lines   On
        Refresh_Interval  5

    # Filter: Kubernetes metadata enrichment
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
        Labels              On
        Annotations         Off
        Buffer_Size         0

    # Filter: Add environment labels
    [FILTER]
        Name   record_modifier
        Match  *
        Record environment {{ .Values.global.environment }}
        Record cluster {{ .Values.global.clusterName | default "greenlang-prod" }}
        Record namespace {{ include "greenlang-agents.namespace" . }}

    # Filter: Parse JSON logs
    [FILTER]
        Name         parser
        Match        app.*
        Key_Name     log
        Parser       json
        Reserve_Data True

    # Filter: Lift nested fields
    [FILTER]
        Name         nest
        Match        *
        Operation    lift
        Nested_under log_processed
        Add_prefix

    # Filter: Add trace correlation
    [FILTER]
        Name         modify
        Match        *
        Rename       trace_id traceId
        Rename       span_id spanId
        Rename       request_id requestId

    # Output: Elasticsearch (production)
    {{- if .Values.logging.elasticsearch.enabled }}
    [OUTPUT]
        Name            es
        Match           *
        Host            {{ .Values.logging.elasticsearch.host | default "elasticsearch" }}
        Port            {{ .Values.logging.elasticsearch.port | default 9200 }}
        Index           greenlang-logs
        Type            _doc
        Logstash_Format On
        Logstash_Prefix greenlang-{{ .Values.global.environment }}
        Retry_Limit     5
        Replace_Dots    On
        Suppress_Type_Name On
        {{- if .Values.logging.elasticsearch.tls }}
        tls             On
        tls.verify      On
        tls.ca_file     /fluent-bit/ssl/ca.crt
        {{- end }}
        {{- if .Values.logging.elasticsearch.auth }}
        HTTP_User       ${ES_USERNAME}
        HTTP_Passwd     ${ES_PASSWORD}
        {{- end }}
    {{- end }}

    # Output: CloudWatch (AWS)
    {{- if .Values.logging.cloudwatch.enabled }}
    [OUTPUT]
        Name                cloudwatch_logs
        Match               *
        region              {{ .Values.logging.cloudwatch.region | default "us-east-1" }}
        log_group_name      /greenlang/{{ .Values.global.environment }}/agents
        log_stream_prefix   agent-
        auto_create_group   true
        log_retention_days  {{ .Values.logging.cloudwatch.retentionDays | default 30 }}
        extra_user_agent    fluent-bit-greenlang
    {{- end }}

    # Output: Loki (Grafana Stack)
    {{- if .Values.logging.loki.enabled }}
    [OUTPUT]
        Name        loki
        Match       *
        Host        {{ .Values.logging.loki.host | default "loki" }}
        Port        {{ .Values.logging.loki.port | default 3100 }}
        Labels      job=greenlang-agents, environment={{ .Values.global.environment }}
        Label_keys  $pod,$namespace,$container
        Remove_keys kubernetes
        Line_Format json
    {{- end }}

    # Output: Stdout (for debugging)
    {{- if eq .Values.global.environment "development" }}
    [OUTPUT]
        Name   stdout
        Match  *
        Format json_lines
    {{- end }}

  parsers.conf: |
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On

    [PARSER]
        Name        json
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%LZ
        Time_Keep   On

    [PARSER]
        Name        syslog
        Format      regex
        Regex       ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
        Time_Key    time
        Time_Format %b %d %H:%M:%S

    [PARSER]
        Name        greenlang_agent
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%LZ
        Types       duration:float execution_time:float

    [PARSER]
        Name        nginx
        Format      regex
        Regex       ^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
        Time_Key    time
        Time_Format %d/%b/%Y:%H:%M:%S %z
