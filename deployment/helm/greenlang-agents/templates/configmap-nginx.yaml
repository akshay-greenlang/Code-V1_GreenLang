{{/*
NGINX ConfigMap - Reverse proxy configuration
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-nginx-config
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes auto;
    pid /tmp/nginx.pid;
    error_log /var/log/nginx/error.log warn;

    events {
        worker_connections 4096;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging format with request ID for tracing
        log_format json_combined escape=json
        '{'
            '"time_local":"$time_local",'
            '"remote_addr":"$remote_addr",'
            '"remote_user":"$remote_user",'
            '"request":"$request",'
            '"status": "$status",'
            '"body_bytes_sent":"$body_bytes_sent",'
            '"request_time":"$request_time",'
            '"http_referrer":"$http_referer",'
            '"http_user_agent":"$http_user_agent",'
            '"request_id":"$request_id",'
            '"upstream_response_time":"$upstream_response_time",'
            '"upstream_addr":"$upstream_addr"'
        '}';

        access_log /var/log/nginx/access.log json_combined;

        # Performance optimizations
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Rate limiting zones
        limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
        limit_req_zone $binary_remote_addr zone=agent_limit:10m rate=50r/s;
        limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

        # Upstream definitions
        upstream api_gateway {
            zone api_gateway 64k;
            server {{ include "greenlang-agents.fullname" . }}-api-gateway:8000 max_fails=3 fail_timeout=30s;
            keepalive 32;
        }

        upstream agent_runner {
            zone agent_runner 64k;
            server {{ include "greenlang-agents.fullname" . }}-agent-runner:8000 max_fails=3 fail_timeout=30s;
            keepalive 32;
        }

        upstream scheduler {
            zone scheduler 64k;
            server {{ include "greenlang-agents.fullname" . }}-scheduler:8000 max_fails=3 fail_timeout=30s;
            keepalive 16;
        }

        upstream worker {
            zone worker 64k;
            server {{ include "greenlang-agents.fullname" . }}-worker:8000 max_fails=3 fail_timeout=30s;
            keepalive 32;
        }

        server {
            listen 8080;
            server_name _;

            # Health check endpoint
            location /nginx-health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }

            # Metrics endpoint (stub_status)
            location /nginx-status {
                stub_status;
                access_log off;
                allow 10.0.0.0/8;
                allow 172.16.0.0/12;
                allow 192.168.0.0/16;
                deny all;
            }

            # API Gateway routes
            location / {
                limit_req zone=api_limit burst=200 nodelay;
                limit_conn conn_limit 100;

                proxy_pass http://api_gateway;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Request-ID $request_id;
                proxy_set_header Connection "";

                proxy_connect_timeout 10s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;

                proxy_buffering on;
                proxy_buffer_size 16k;
                proxy_buffers 4 32k;
                proxy_busy_buffers_size 64k;
            }

            # Agent execution routes (longer timeout)
            location /api/v1/agents {
                limit_req zone=agent_limit burst=100 nodelay;

                proxy_pass http://agent_runner;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Request-ID $request_id;
                proxy_set_header Connection "";

                proxy_connect_timeout 10s;
                proxy_send_timeout 300s;
                proxy_read_timeout 300s;
            }

            # Task/Scheduler routes
            location /api/v1/tasks {
                limit_req zone=api_limit burst=100 nodelay;

                proxy_pass http://scheduler;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Request-ID $request_id;
                proxy_set_header Connection "";

                proxy_connect_timeout 10s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            # Batch processing routes (longest timeout)
            location /api/v1/batch {
                limit_req zone=agent_limit burst=50 nodelay;

                proxy_pass http://worker;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Request-ID $request_id;
                proxy_set_header Connection "";

                proxy_connect_timeout 10s;
                proxy_send_timeout 600s;
                proxy_read_timeout 600s;

                client_max_body_size 50m;
            }
        }
    }
