apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis-ha.configmapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "redis-ha.labels" . | nindent 4 }}
data:
  redis.conf: |
    # Redis configuration file for HA deployment
    # Generated by Helm chart {{ include "redis-ha.chart" . }}

    # Network
    bind 0.0.0.0
    port {{ .Values.redis.port }}
    tcp-keepalive {{ .Values.redis.config.tcp_keepalive | default "300" }}
    timeout {{ .Values.redis.config.timeout | default "0" }}
    tcp-backlog {{ .Values.redis.config.tcp_backlog | default "511" }}

    # General
    daemonize no
    loglevel notice
    logfile ""
    databases {{ .Values.redis.config.databases | default "16" }}

    # Memory management
    maxmemory {{ .Values.redis.config.maxmemory | default "3gb" }}
    maxmemory-policy {{ .Values.redis.config.maxmemory_policy | default "volatile-lru" }}

    # Persistence - RDB
    {{- if .Values.redis.config.save }}
    save {{ .Values.redis.config.save }}
    {{- else }}
    save 900 1
    save 300 10
    save 60 10000
    {{- end }}
    stop-writes-on-bgsave-error yes
    rdbcompression {{ .Values.redis.config.rdbcompression | default "yes" }}
    rdbchecksum {{ .Values.redis.config.rdbchecksum | default "yes" }}
    dbfilename dump.rdb
    dir /data

    # Persistence - AOF
    appendonly {{ .Values.redis.config.appendonly | default "yes" }}
    appendfilename "appendonly.aof"
    appendfsync {{ .Values.redis.config.appendfsync | default "everysec" }}
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage {{ .Values.redis.config.auto_aof_rewrite_percentage | default "100" }}
    auto-aof-rewrite-min-size {{ .Values.redis.config.auto_aof_rewrite_min_size | default "64mb" }}
    aof-load-truncated yes
    aof-use-rdb-preamble yes

    # Replication
    replica-serve-stale-data {{ .Values.redis.config.replica_serve_stale_data | default "yes" }}
    replica-read-only {{ .Values.redis.config.replica_read_only | default "yes" }}
    repl-diskless-sync no
    repl-diskless-sync-delay 5
    repl-ping-replica-period 10
    repl-timeout 60
    repl-disable-tcp-nodelay no
    replica-priority 100
    {{- if .Values.redis.config.min_replicas_to_write }}
    min-replicas-to-write {{ .Values.redis.config.min_replicas_to_write }}
    {{- end }}
    {{- if .Values.redis.config.min_replicas_max_lag }}
    min-replicas-max-lag {{ .Values.redis.config.min_replicas_max_lag }}
    {{- end }}

    # Security
    protected-mode {{ .Values.redis.config.protected_mode | default "yes" }}

    # Limits
    maxclients 10000

    # Slow log
    slowlog-log-slower-than {{ .Values.redis.config.slowlog_log_slower_than | default "10000" }}
    slowlog-max-len {{ .Values.redis.config.slowlog_max_len | default "128" }}

    # Latency monitoring
    latency-monitor-threshold {{ .Values.redis.config.latency_monitor_threshold | default "100" }}

    # Event notification
    notify-keyspace-events ""

    # Advanced config
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-size -2
    list-compress-depth 0
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    hll-sparse-max-bytes 3000
    stream-node-max-bytes 4096
    stream-node-max-entries 100
    activerehashing yes
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60
    hz 10
    dynamic-hz yes
    aof-rewrite-incremental-fsync yes
    rdb-save-incremental-fsync yes

  sentinel.conf: |
    # Sentinel configuration file for HA deployment
    # Generated by Helm chart {{ include "redis-ha.chart" . }}

    port {{ .Values.sentinel.port }}
    dir /data

    # Sentinel monitoring configuration
    # sentinel monitor <master-name> <ip> <port> <quorum>
    # The actual master IP will be set by the init container
    sentinel monitor mymaster 127.0.0.1 {{ .Values.redis.port }} {{ .Values.sentinel.quorum }}

    # Sentinel configuration options
    sentinel down-after-milliseconds mymaster {{ .Values.sentinel.downAfterMilliseconds }}
    sentinel failover-timeout mymaster {{ .Values.sentinel.failoverTimeout }}
    sentinel parallel-syncs mymaster {{ .Values.sentinel.parallelSyncs }}

    # Kubernetes DNS resolution
    sentinel resolve-hostnames {{ .Values.sentinel.resolveHostnames }}
    sentinel announce-hostnames {{ .Values.sentinel.announceHostnames }}

    # Notification and client reconfiguration scripts (disabled by default)
    # sentinel notification-script mymaster /path/to/script.sh
    # sentinel client-reconfig-script mymaster /path/to/script.sh

    # Deny potentially dangerous commands
    sentinel deny-scripts-reconfig yes

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis-ha.scriptsConfigmapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "redis-ha.labels" . | nindent 4 }}
data:
  start-redis.sh: |
    #!/bin/bash
    set -e

    REDIS_PORT={{ .Values.redis.port }}
    SENTINEL_PORT={{ .Values.sentinel.port }}
    DATA_DIR="/data"
    CONFIG_DIR="/etc/redis"
    REDIS_CONF="${DATA_DIR}/redis.conf"
    SENTINEL_CONF="${DATA_DIR}/sentinel.conf"
    HEADLESS_SERVICE="{{ include "redis-ha.headlessServiceName" . }}.{{ .Release.Namespace }}.svc.cluster.local"

    # Copy base configs
    cp ${CONFIG_DIR}/redis.conf ${REDIS_CONF}
    cp ${CONFIG_DIR}/sentinel.conf ${SENTINEL_CONF}

    # Get pod ordinal index
    HOSTNAME=$(hostname)
    ORDINAL=${HOSTNAME##*-}

    echo "Starting Redis on ${HOSTNAME} (ordinal: ${ORDINAL})"

    {{- if .Values.auth.enabled }}
    # Add auth to configs
    echo "requirepass ${REDIS_PASSWORD}" >> ${REDIS_CONF}
    echo "masterauth ${REDIS_PASSWORD}" >> ${REDIS_CONF}
    echo "sentinel auth-pass mymaster ${REDIS_PASSWORD}" >> ${SENTINEL_CONF}
    {{- end }}

    # Determine if this pod should be master or replica
    if [ "${ORDINAL}" = "0" ]; then
      echo "This pod is the initial master"
      # First pod starts as master (no replicaof directive)
    else
      echo "This pod is a replica"
      # Replicas connect to the first pod initially
      MASTER_HOST="{{ include "redis-ha.fullname" . }}-0.${HEADLESS_SERVICE}"
      echo "replicaof ${MASTER_HOST} ${REDIS_PORT}" >> ${REDIS_CONF}
    fi

    # Update sentinel config with master
    MASTER_HOST="{{ include "redis-ha.fullname" . }}-0.${HEADLESS_SERVICE}"
    sed -i "s/sentinel monitor mymaster 127.0.0.1/sentinel monitor mymaster ${MASTER_HOST}/" ${SENTINEL_CONF}

    # Announce this pod's hostname
    POD_HOST="${HOSTNAME}.${HEADLESS_SERVICE}"
    echo "replica-announce-ip ${POD_HOST}" >> ${REDIS_CONF}
    echo "replica-announce-port ${REDIS_PORT}" >> ${REDIS_CONF}
    echo "sentinel announce-ip ${POD_HOST}" >> ${SENTINEL_CONF}
    echo "sentinel announce-port ${SENTINEL_PORT}" >> ${SENTINEL_CONF}

    echo "Redis configuration complete. Starting Redis server..."
    exec redis-server ${REDIS_CONF}

  start-sentinel.sh: |
    #!/bin/bash
    set -e

    SENTINEL_PORT={{ .Values.sentinel.port }}
    DATA_DIR="/data"
    SENTINEL_CONF="${DATA_DIR}/sentinel.conf"

    # Wait for Redis to be ready
    echo "Waiting for Redis to be ready..."
    sleep 10

    echo "Starting Sentinel..."
    exec redis-sentinel ${SENTINEL_CONF}

  readiness-check.sh: |
    #!/bin/bash
    set -e

    REDIS_PORT={{ .Values.redis.port }}
    {{- if .Values.auth.enabled }}
    REDIS_CLI="redis-cli -a ${REDIS_PASSWORD} --no-auth-warning"
    {{- else }}
    REDIS_CLI="redis-cli"
    {{- end }}

    # Check if Redis is responding
    response=$(${REDIS_CLI} -p ${REDIS_PORT} ping)
    if [ "${response}" != "PONG" ]; then
      echo "Redis not responding to PING"
      exit 1
    fi

    # Check replication status (allow master or connected replica)
    role=$(${REDIS_CLI} -p ${REDIS_PORT} info replication | grep role | cut -d: -f2 | tr -d '\r')
    if [ "${role}" = "master" ]; then
      echo "Redis is master and ready"
      exit 0
    elif [ "${role}" = "slave" ]; then
      link_status=$(${REDIS_CLI} -p ${REDIS_PORT} info replication | grep master_link_status | cut -d: -f2 | tr -d '\r')
      if [ "${link_status}" = "up" ]; then
        echo "Redis is replica with master link up"
        exit 0
      else
        echo "Redis replica master link is down"
        exit 1
      fi
    fi

    echo "Unknown Redis role: ${role}"
    exit 1

  liveness-check.sh: |
    #!/bin/bash
    set -e

    REDIS_PORT={{ .Values.redis.port }}
    {{- if .Values.auth.enabled }}
    REDIS_CLI="redis-cli -a ${REDIS_PASSWORD} --no-auth-warning"
    {{- else }}
    REDIS_CLI="redis-cli"
    {{- end }}

    # Simple ping check for liveness
    response=$(${REDIS_CLI} -p ${REDIS_PORT} ping)
    if [ "${response}" = "PONG" ]; then
      exit 0
    fi
    exit 1

  sentinel-readiness.sh: |
    #!/bin/bash
    set -e

    SENTINEL_PORT={{ .Values.sentinel.port }}
    {{- if .Values.auth.enabled }}
    REDIS_CLI="redis-cli -a ${REDIS_PASSWORD} --no-auth-warning"
    {{- else }}
    REDIS_CLI="redis-cli"
    {{- end }}

    # Check Sentinel is responding
    response=$(${REDIS_CLI} -p ${SENTINEL_PORT} ping)
    if [ "${response}" != "PONG" ]; then
      echo "Sentinel not responding"
      exit 1
    fi

    # Check master is known
    master_info=$(${REDIS_CLI} -p ${SENTINEL_PORT} sentinel master mymaster 2>/dev/null)
    if [ -z "${master_info}" ]; then
      echo "Sentinel has no master info"
      exit 1
    fi

    echo "Sentinel is ready"
    exit 0
