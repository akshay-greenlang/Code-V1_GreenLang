{{/*
PostgreSQL Configuration ConfigMap
Custom postgresql.conf settings for TimescaleDB optimization
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "timescaledb-ha.postgresConfigMapName" . }}
  namespace: {{ include "timescaledb-ha.namespace" . }}
  labels:
    {{- include "timescaledb-ha.labels" . | nindent 4 }}
data:
  postgresql.conf: |
    # =============================================================================
    # PostgreSQL Configuration for TimescaleDB HA
    # Generated by Helm chart {{ .Chart.Name }}-{{ .Chart.Version }}
    # =============================================================================

    # -----------------------------------------------------------------------------
    # Connection Settings
    # -----------------------------------------------------------------------------
    listen_addresses = '*'
    port = 5432
    max_connections = {{ .Values.postgresql.parameters.max_connections | default 200 }}

    # -----------------------------------------------------------------------------
    # Memory Configuration
    # -----------------------------------------------------------------------------
    shared_buffers = {{ .Values.postgresql.parameters.shared_buffers | default "2GB" }}
    effective_cache_size = {{ .Values.postgresql.parameters.effective_cache_size | default "6GB" }}
    work_mem = {{ .Values.postgresql.parameters.work_mem | default "64MB" }}
    maintenance_work_mem = {{ .Values.postgresql.parameters.maintenance_work_mem | default "512MB" }}

    # Use huge pages if available (for better TLB performance)
    {{- if .Values.postgresql.parameters.huge_pages }}
    huge_pages = {{ .Values.postgresql.parameters.huge_pages }}
    {{- else }}
    huge_pages = try
    {{- end }}

    # -----------------------------------------------------------------------------
    # Disk Settings
    # -----------------------------------------------------------------------------
    {{- if .Values.persistence.wal.enabled }}
    # Separate WAL directory for better I/O performance
    # Note: WAL directory is configured via PGDATA/pg_wal symlink
    {{- end }}

    # -----------------------------------------------------------------------------
    # WAL (Write-Ahead Logging) Configuration
    # -----------------------------------------------------------------------------
    wal_level = {{ .Values.postgresql.parameters.wal_level | default "replica" }}
    wal_buffers = {{ .Values.postgresql.parameters.wal_buffers | default "64MB" }}
    min_wal_size = {{ .Values.postgresql.parameters.min_wal_size | default "1GB" }}
    max_wal_size = {{ .Values.postgresql.parameters.max_wal_size | default "4GB" }}
    checkpoint_completion_target = {{ .Values.postgresql.parameters.checkpoint_completion_target | default 0.9 }}
    {{- if .Values.postgresql.parameters.checkpoint_timeout }}
    checkpoint_timeout = {{ .Values.postgresql.parameters.checkpoint_timeout }}
    {{- end }}

    # Archive mode (required for point-in-time recovery)
    {{- if .Values.backup.enabled }}
    archive_mode = on
    archive_command = 'pgbackrest --stanza=main archive-push %p'
    archive_timeout = 60
    {{- else }}
    archive_mode = off
    {{- end }}

    # -----------------------------------------------------------------------------
    # Replication Configuration
    # -----------------------------------------------------------------------------
    max_wal_senders = {{ .Values.postgresql.parameters.max_wal_senders | default 10 }}
    max_replication_slots = {{ .Values.postgresql.parameters.max_replication_slots | default 10 }}
    hot_standby = {{ .Values.postgresql.parameters.hot_standby | default "on" }}
    wal_keep_size = {{ .Values.postgresql.parameters.wal_keep_size | default "1GB" }}

    {{- if .Values.patroni.synchronous.enabled }}
    # Synchronous replication settings
    synchronous_commit = {{ .Values.patroni.synchronous.mode | default "on" }}
    synchronous_standby_names = '*'
    {{- end }}

    # Standby settings
    hot_standby_feedback = on
    max_standby_archive_delay = 30s
    max_standby_streaming_delay = 30s

    # -----------------------------------------------------------------------------
    # Query Planner Configuration
    # -----------------------------------------------------------------------------
    random_page_cost = {{ .Values.postgresql.parameters.random_page_cost | default 1.1 }}
    effective_io_concurrency = {{ .Values.postgresql.parameters.effective_io_concurrency | default 200 }}

    # Parallel query settings
    {{- if .Values.postgresql.parameters.max_parallel_workers_per_gather }}
    max_parallel_workers_per_gather = {{ .Values.postgresql.parameters.max_parallel_workers_per_gather }}
    {{- end }}
    {{- if .Values.postgresql.parameters.max_parallel_workers }}
    max_parallel_workers = {{ .Values.postgresql.parameters.max_parallel_workers }}
    {{- end }}
    {{- if .Values.postgresql.parameters.max_parallel_maintenance_workers }}
    max_parallel_maintenance_workers = {{ .Values.postgresql.parameters.max_parallel_maintenance_workers }}
    {{- end }}
    {{- if .Values.postgresql.parameters.parallel_tuple_cost }}
    parallel_tuple_cost = {{ .Values.postgresql.parameters.parallel_tuple_cost }}
    {{- end }}
    {{- if .Values.postgresql.parameters.parallel_setup_cost }}
    parallel_setup_cost = {{ .Values.postgresql.parameters.parallel_setup_cost }}
    {{- end }}

    # JIT compilation
    jit = on
    jit_above_cost = 100000
    jit_inline_above_cost = 500000
    jit_optimize_above_cost = 500000

    # -----------------------------------------------------------------------------
    # Autovacuum Configuration
    # -----------------------------------------------------------------------------
    autovacuum = on
    autovacuum_max_workers = {{ .Values.postgresql.parameters.autovacuum_max_workers | default 4 }}
    autovacuum_naptime = {{ .Values.postgresql.parameters.autovacuum_naptime | default "10s" }}
    autovacuum_vacuum_scale_factor = {{ .Values.postgresql.parameters.autovacuum_vacuum_scale_factor | default 0.05 }}
    autovacuum_analyze_scale_factor = {{ .Values.postgresql.parameters.autovacuum_analyze_scale_factor | default 0.02 }}
    autovacuum_vacuum_threshold = 50
    autovacuum_analyze_threshold = 50
    {{- if .Values.postgresql.parameters.autovacuum_vacuum_cost_delay }}
    autovacuum_vacuum_cost_delay = {{ .Values.postgresql.parameters.autovacuum_vacuum_cost_delay }}
    {{- end }}
    {{- if .Values.postgresql.parameters.autovacuum_vacuum_cost_limit }}
    autovacuum_vacuum_cost_limit = {{ .Values.postgresql.parameters.autovacuum_vacuum_cost_limit }}
    {{- end }}

    # -----------------------------------------------------------------------------
    # Logging Configuration
    # -----------------------------------------------------------------------------
    logging_collector = on
    log_destination = 'stderr'
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_truncate_on_rotation = off

    # What to log
    log_min_duration_statement = {{ .Values.postgresql.parameters.log_min_duration_statement | default 1000 }}
    log_checkpoints = {{ .Values.postgresql.parameters.log_checkpoints | default "on" }}
    log_connections = {{ .Values.postgresql.parameters.log_connections | default "on" }}
    log_disconnections = {{ .Values.postgresql.parameters.log_disconnections | default "on" }}
    log_lock_waits = {{ .Values.postgresql.parameters.log_lock_waits | default "on" }}
    log_temp_files = {{ .Values.postgresql.parameters.log_temp_files | default 0 }}
    {{- if .Values.postgresql.parameters.log_autovacuum_min_duration }}
    log_autovacuum_min_duration = {{ .Values.postgresql.parameters.log_autovacuum_min_duration }}
    {{- end }}

    # Log format
    log_line_prefix = '%m [%p] %q%u@%d '
    log_timezone = 'UTC'

    # Log statements
    log_statement = 'ddl'
    log_duration = off

    # -----------------------------------------------------------------------------
    # TimescaleDB Configuration
    # -----------------------------------------------------------------------------
    shared_preload_libraries = 'timescaledb,pg_stat_statements'

    # TimescaleDB specific settings
    timescaledb.max_background_workers = {{ .Values.postgresql.parameters | dig "timescaledb.max_background_workers" "8" }}
    timescaledb.telemetry_level = {{ .Values.postgresql.parameters | dig "timescaledb.telemetry_level" "off" }}

    # -----------------------------------------------------------------------------
    # Statistics and Monitoring
    # -----------------------------------------------------------------------------
    track_activities = on
    track_counts = on
    track_io_timing = on
    track_functions = all
    track_activity_query_size = 2048

    # pg_stat_statements configuration
    {{- if .Values.postgresql.parameters | dig "pg_stat_statements.max" "" }}
    pg_stat_statements.max = {{ .Values.postgresql.parameters | dig "pg_stat_statements.max" "10000" }}
    {{- else }}
    pg_stat_statements.max = 10000
    {{- end }}
    {{- if .Values.postgresql.parameters | dig "pg_stat_statements.track" "" }}
    pg_stat_statements.track = {{ .Values.postgresql.parameters | dig "pg_stat_statements.track" "all" }}
    {{- else }}
    pg_stat_statements.track = all
    {{- end }}
    pg_stat_statements.track_utility = on

    # -----------------------------------------------------------------------------
    # Security Configuration
    # -----------------------------------------------------------------------------
    password_encryption = scram-sha-256
    ssl = {{ if .Values.tls.enabled }}on{{ else }}off{{ end }}
    {{- if .Values.tls.enabled }}
    ssl_cert_file = '/etc/ssl/postgresql/tls.crt'
    ssl_key_file = '/etc/ssl/postgresql/tls.key'
    ssl_prefer_server_ciphers = on
    ssl_min_protocol_version = 'TLSv1.2'
    ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
    {{- end }}

    # -----------------------------------------------------------------------------
    # Miscellaneous
    # -----------------------------------------------------------------------------
    datestyle = 'iso, mdy'
    timezone = 'UTC'
    lc_messages = 'en_US.UTF-8'
    lc_monetary = 'en_US.UTF-8'
    lc_numeric = 'en_US.UTF-8'
    lc_time = 'en_US.UTF-8'
    default_text_search_config = 'pg_catalog.english'

    # Prevent statement timeouts during maintenance
    statement_timeout = 0
    lock_timeout = 0
    idle_in_transaction_session_timeout = 600000

    # Exit on corruption detection
    data_checksums = on
    # Note: data_checksums is enabled during initdb, not runtime configurable

  {{- if .Values.metrics.enabled }}
  # Custom queries for postgres_exporter
  queries.yaml: |
    {{- .Values.metrics.customQueries | nindent 4 }}

    # Additional TimescaleDB specific queries
    timescaledb_chunks:
      query: |
        SELECT
          hypertable_schema,
          hypertable_name,
          chunk_schema,
          chunk_name,
          pg_size_pretty(chunk_total_bytes) as total_size,
          chunk_total_bytes as total_bytes
        FROM timescaledb_information.chunks
        ORDER BY chunk_total_bytes DESC
        LIMIT 20
      metrics:
        - hypertable_schema:
            usage: "LABEL"
            description: "Schema of the hypertable"
        - hypertable_name:
            usage: "LABEL"
            description: "Name of the hypertable"
        - chunk_name:
            usage: "LABEL"
            description: "Name of the chunk"
        - total_bytes:
            usage: "GAUGE"
            description: "Total bytes of the chunk"

    timescaledb_compression:
      query: |
        SELECT
          hypertable_schema,
          hypertable_name,
          COALESCE(before_compression_total_bytes, 0) as before_compression_bytes,
          COALESCE(after_compression_total_bytes, 0) as after_compression_bytes,
          CASE
            WHEN before_compression_total_bytes > 0
            THEN ROUND((1 - (after_compression_total_bytes::numeric / before_compression_total_bytes::numeric)) * 100, 2)
            ELSE 0
          END as compression_ratio
        FROM timescaledb_information.hypertables
        WHERE compression_enabled = true
      metrics:
        - hypertable_schema:
            usage: "LABEL"
            description: "Schema of the hypertable"
        - hypertable_name:
            usage: "LABEL"
            description: "Name of the hypertable"
        - before_compression_bytes:
            usage: "GAUGE"
            description: "Bytes before compression"
        - after_compression_bytes:
            usage: "GAUGE"
            description: "Bytes after compression"
        - compression_ratio:
            usage: "GAUGE"
            description: "Compression ratio percentage"

    timescaledb_continuous_aggregates:
      query: |
        SELECT
          view_schema,
          view_name,
          materialization_hypertable_schema,
          materialization_hypertable_name,
          CASE WHEN materialized_only THEN 1 ELSE 0 END as materialized_only,
          CASE WHEN finalized THEN 1 ELSE 0 END as finalized
        FROM timescaledb_information.continuous_aggregates
      metrics:
        - view_schema:
            usage: "LABEL"
            description: "Schema of the continuous aggregate view"
        - view_name:
            usage: "LABEL"
            description: "Name of the continuous aggregate view"
        - materialized_only:
            usage: "GAUGE"
            description: "Whether the aggregate is materialized only"
        - finalized:
            usage: "GAUGE"
            description: "Whether the aggregate is finalized"
  {{- end }}
