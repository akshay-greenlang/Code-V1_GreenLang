{{/*
Secret containing database credentials
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "timescaledb-ha.secretName" . }}
  namespace: {{ include "timescaledb-ha.namespace" . }}
  labels:
    {{- include "timescaledb-ha.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-delete-policy": before-hook-creation
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{/*
  Generate or use provided passwords
  */}}
  {{- $postgresPassword := .Values.postgresql.password | default (include "timescaledb-ha.randomPassword" .) }}
  {{- $replicationPassword := .Values.postgresql.replication.password | default (include "timescaledb-ha.randomPassword" .) }}
  {{- $patroniPassword := include "timescaledb-ha.randomPassword" . }}
  {{- $pgbouncerPassword := include "timescaledb-ha.randomPassword" . }}

  # PostgreSQL superuser password
  postgres-password: {{ $postgresPassword | b64enc | quote }}

  # Replication user password
  replication-password: {{ $replicationPassword | b64enc | quote }}

  # Patroni REST API password
  patroni-restapi-password: {{ $patroniPassword | b64enc | quote }}

  {{- if .Values.pgbouncer.enabled }}
  # PgBouncer admin password
  pgbouncer-admin-password: {{ $pgbouncerPassword | b64enc | quote }}
  {{- end }}

  # Connection strings for convenience
  # Primary read-write connection string
  database-url: {{ printf "postgresql://%s:%s@%s:%d/%s?sslmode=prefer" .Values.postgresql.username $postgresPassword (include "timescaledb-ha.primaryServiceName" .) (.Values.service.primary.port | int) .Values.postgresql.database | b64enc | quote }}

  # Replica read-only connection string
  {{- if .Values.service.replica.enabled }}
  database-url-replica: {{ printf "postgresql://%s:%s@%s:%d/%s?sslmode=prefer" .Values.postgresql.username $postgresPassword (include "timescaledb-ha.replicaServiceName" .) (.Values.service.replica.port | int) .Values.postgresql.database | b64enc | quote }}
  {{- end }}

  {{- if .Values.pgbouncer.enabled }}
  # PgBouncer connection string
  database-url-pgbouncer: {{ printf "postgresql://%s:%s@%s:%d/%s?sslmode=prefer" .Values.postgresql.username $postgresPassword (include "timescaledb-ha.pgbouncerServiceName" .) (.Values.service.pgbouncer.port | int) .Values.postgresql.database | b64enc | quote }}
  {{- end }}

---
{{/*
Metrics queries ConfigMap (for postgres_exporter)
*/}}
{{- if .Values.metrics.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "timescaledb-ha.fullname" . }}-metrics-queries
  namespace: {{ include "timescaledb-ha.namespace" . }}
  labels:
    {{- include "timescaledb-ha.labels" . | nindent 4 }}
data:
  queries.yaml: |
    # Core PostgreSQL queries
    pg_replication:
      query: |
        SELECT
          CASE
            WHEN NOT pg_is_in_recovery() THEN 0
            ELSE GREATEST(0, EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())))
          END AS lag
      master: true
      metrics:
        - lag:
            usage: "GAUGE"
            description: "Replication lag behind master in seconds"

    pg_postmaster:
      query: |
        SELECT pg_postmaster_start_time as start_time_seconds from pg_postmaster_start_time()
      master: true
      metrics:
        - start_time_seconds:
            usage: "GAUGE"
            description: "Time at which postmaster started"

    pg_stat_user_tables:
      query: |
        SELECT
          schemaname,
          relname,
          seq_scan,
          seq_tup_read,
          idx_scan,
          idx_tup_fetch,
          n_tup_ins,
          n_tup_upd,
          n_tup_del,
          n_live_tup,
          n_dead_tup,
          last_vacuum,
          last_autovacuum,
          last_analyze,
          last_autoanalyze,
          vacuum_count,
          autovacuum_count,
          analyze_count,
          autoanalyze_count
        FROM pg_stat_user_tables
      metrics:
        - schemaname:
            usage: "LABEL"
            description: "Schema name"
        - relname:
            usage: "LABEL"
            description: "Table name"
        - seq_scan:
            usage: "COUNTER"
            description: "Sequential scans initiated"
        - seq_tup_read:
            usage: "COUNTER"
            description: "Tuples read via sequential scans"
        - idx_scan:
            usage: "COUNTER"
            description: "Index scans initiated"
        - idx_tup_fetch:
            usage: "COUNTER"
            description: "Tuples fetched via index scans"
        - n_tup_ins:
            usage: "COUNTER"
            description: "Tuples inserted"
        - n_tup_upd:
            usage: "COUNTER"
            description: "Tuples updated"
        - n_tup_del:
            usage: "COUNTER"
            description: "Tuples deleted"
        - n_live_tup:
            usage: "GAUGE"
            description: "Live tuples"
        - n_dead_tup:
            usage: "GAUGE"
            description: "Dead tuples"

    pg_database:
      query: |
        SELECT
          datname,
          pg_database_size(datname) as size_bytes,
          numbackends,
          xact_commit,
          xact_rollback,
          blks_read,
          blks_hit,
          tup_returned,
          tup_fetched,
          tup_inserted,
          tup_updated,
          tup_deleted,
          deadlocks
        FROM pg_stat_database
        WHERE datname NOT IN ('template0', 'template1')
      metrics:
        - datname:
            usage: "LABEL"
            description: "Database name"
        - size_bytes:
            usage: "GAUGE"
            description: "Database size in bytes"
        - numbackends:
            usage: "GAUGE"
            description: "Number of connected backends"
        - xact_commit:
            usage: "COUNTER"
            description: "Transactions committed"
        - xact_rollback:
            usage: "COUNTER"
            description: "Transactions rolled back"
        - blks_read:
            usage: "COUNTER"
            description: "Blocks read"
        - blks_hit:
            usage: "COUNTER"
            description: "Blocks hit in cache"
        - deadlocks:
            usage: "COUNTER"
            description: "Number of deadlocks"

    pg_locks:
      query: |
        SELECT
          mode,
          count(*) as count
        FROM pg_locks
        WHERE NOT granted
        GROUP BY mode
      metrics:
        - mode:
            usage: "LABEL"
            description: "Lock mode"
        - count:
            usage: "GAUGE"
            description: "Number of locks waiting"

    pg_connections:
      query: |
        SELECT
          state,
          usename,
          count(*) as count
        FROM pg_stat_activity
        WHERE pid <> pg_backend_pid()
        GROUP BY state, usename
      metrics:
        - state:
            usage: "LABEL"
            description: "Connection state"
        - usename:
            usage: "LABEL"
            description: "Username"
        - count:
            usage: "GAUGE"
            description: "Number of connections"

    # TimescaleDB specific queries
    timescaledb_hypertables:
      query: |
        SELECT
          hypertable_schema,
          hypertable_name,
          num_chunks,
          num_dimensions,
          COALESCE(compression_enabled::int, 0) as compression_enabled,
          COALESCE(total_bytes, 0) as total_bytes,
          COALESCE(index_bytes, 0) as index_bytes,
          COALESCE(toast_bytes, 0) as toast_bytes,
          COALESCE(table_bytes, 0) as table_bytes
        FROM timescaledb_information.hypertables h
        LEFT JOIN timescaledb_information.hypertable_size_info s
        ON h.hypertable_schema = s.hypertable_schema
        AND h.hypertable_name = s.hypertable_name
      metrics:
        - hypertable_schema:
            usage: "LABEL"
            description: "Schema of the hypertable"
        - hypertable_name:
            usage: "LABEL"
            description: "Name of the hypertable"
        - num_chunks:
            usage: "GAUGE"
            description: "Number of chunks"
        - num_dimensions:
            usage: "GAUGE"
            description: "Number of dimensions"
        - compression_enabled:
            usage: "GAUGE"
            description: "Compression enabled (1) or not (0)"
        - total_bytes:
            usage: "GAUGE"
            description: "Total size in bytes"

    timescaledb_jobs:
      query: |
        SELECT
          job_id,
          application_name,
          job_status,
          EXTRACT(EPOCH FROM last_successful_finish)::bigint as last_successful_finish_epoch,
          EXTRACT(EPOCH FROM last_run_started_at)::bigint as last_run_started_epoch,
          last_run_status,
          total_runs,
          total_successes,
          total_failures
        FROM timescaledb_information.job_stats
      metrics:
        - job_id:
            usage: "LABEL"
            description: "Job ID"
        - application_name:
            usage: "LABEL"
            description: "Application name"
        - job_status:
            usage: "LABEL"
            description: "Job status"
        - last_run_status:
            usage: "LABEL"
            description: "Last run status"
        - total_runs:
            usage: "COUNTER"
            description: "Total number of runs"
        - total_successes:
            usage: "COUNTER"
            description: "Total successful runs"
        - total_failures:
            usage: "COUNTER"
            description: "Total failed runs"
{{- end }}
