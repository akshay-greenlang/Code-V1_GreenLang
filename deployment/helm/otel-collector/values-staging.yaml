# =============================================================================
# GreenLang OpenTelemetry Collector - Staging Values
# GreenLang Climate OS | OBS-003
# =============================================================================
# Staging configuration mirrors production with reduced scale:
#   - 2 replicas (HA enabled)
#   - Moderate resources (512Mi / 500m CPU)
#   - Full tail sampling (same policies as production)
#   - HPA enabled (2-4 replicas)
#   - PDB enabled (minAvailable: 1)
#   - Network policies enabled
# =============================================================================

# ---------------------------------------------------------------------------
# Global Configuration
# ---------------------------------------------------------------------------
global:
  environment: staging
  clusterName: greenlang-staging
  awsRegion: eu-west-1

# ---------------------------------------------------------------------------
# OpenTelemetry Collector
# ---------------------------------------------------------------------------
otelCollector:
  replicas: 2

  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi

  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
            max_recv_msg_size_mib: 4
            keepalive:
              server_parameters:
                max_connection_age: 300s
                max_connection_age_grace: 60s
          http:
            endpoint: 0.0.0.0:4318
            cors:
              allowed_origins:
                - "https://*.staging.greenlang.io"
              allowed_headers:
                - "*"

      jaeger:
        protocols:
          grpc:
            endpoint: "0.0.0.0:14250"
          thrift_http:
            endpoint: "0.0.0.0:14268"

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 768
        spike_limit_mib: 256

      resource:
        attributes:
          - key: service.environment
            value: "${ENVIRONMENT}"
            action: upsert
          - key: service.cluster
            value: "greenlang-${ENVIRONMENT}"
            action: upsert
          - key: service.platform
            value: greenlang-climate-os
            action: insert
          - key: deployment.environment
            value: "${ENVIRONMENT}"
            action: insert

      attributes/redact:
        actions:
          - key: http.request.header.authorization
            action: delete
          - key: http.request.header.cookie
            action: delete
          - key: http.request.header.set_cookie
            action: delete
          - key: http.request.header.x_api_key
            action: delete
          - key: db.statement
            action: hash
          - key: http.request.body
            action: delete
          - key: http.response.body
            action: delete
          - key: http.url
            action: hash
          - key: messaging.message.payload
            action: delete

      filter/health:
        error_mode: ignore
        traces:
          span:
            - 'attributes["http.target"] == "/health"'
            - 'attributes["http.target"] == "/ready"'
            - 'attributes["http.target"] == "/ping"'
            - 'attributes["http.target"] == "/metrics"'
            - 'attributes["http.target"] == "/livez"'
            - 'attributes["http.target"] == "/readyz"'

      # Full tail sampling - same policies as production
      tail_sampling:
        decision_wait: 10s
        num_traces: 20000
        expected_new_traces_per_sec: 200
        policies:
          - name: errors
            type: status_code
            status_code:
              status_codes: [ERROR]
          - name: slow-traces
            type: latency
            latency:
              threshold_ms: 2000
          - name: compliance-agents
            type: string_attribute
            string_attribute:
              key: service.name
              values:
                - eudr-agent
                - cbam-agent
                - sb253-agent
                - csrd-agent
                - vcci-agent
                - taxonomy-agent
          - name: auth-failures
            type: string_attribute
            string_attribute:
              key: gl.auth.result
              values:
                - denied
                - failed
                - revoked
          - name: api-services
            type: probabilistic
            probabilistic:
              sampling_percentage: 50
          - name: default
            type: probabilistic
            probabilistic:
              sampling_percentage: 10

      batch:
        timeout: 2s
        send_batch_size: 512
        send_batch_max_size: 1024

      batch/metrics:
        timeout: 5s
        send_batch_size: 256
        send_batch_max_size: 512

      batch/logs:
        timeout: 3s
        send_batch_size: 256
        send_batch_max_size: 512

    exporters:
      otlp/tempo:
        endpoint: tempo-distributor.monitoring.svc.cluster.local:4317
        tls:
          insecure: true
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s
        sending_queue:
          enabled: true
          num_consumers: 5
          queue_size: 2000

      prometheus:
        endpoint: 0.0.0.0:8889
        namespace: gl_otel
        resource_to_telemetry_conversion:
          enabled: true
        enable_open_metrics: true

      loki:
        endpoint: http://loki-gateway.monitoring.svc.cluster.local:3100/loki/api/v1/push
        labels:
          attributes:
            service.name: service
            service.namespace: namespace
            severity: level

    extensions:
      health_check:
        endpoint: "0.0.0.0:13133"
        path: /health
        check_collector_pipeline:
          enabled: true
          interval: 5m
          exporter_failure_threshold: 5
      pprof:
        endpoint: "0.0.0.0:1777"
      zpages:
        endpoint: "0.0.0.0:55679"

    service:
      extensions: [health_check, pprof, zpages]

      pipelines:
        traces:
          receivers: [otlp, jaeger]
          processors: [memory_limiter, resource, attributes/redact, filter/health, tail_sampling, batch]
          exporters: [otlp/tempo]

        metrics:
          receivers: [otlp]
          processors: [memory_limiter, resource, batch/metrics]
          exporters: [prometheus]

        logs:
          receivers: [otlp]
          processors: [memory_limiter, resource, batch/logs]
          exporters: [loki]

      telemetry:
        logs:
          level: info
          encoding: json
        metrics:
          level: detailed
          address: 0.0.0.0:8888

# ---------------------------------------------------------------------------
# HPA - Enabled with staging scale
# ---------------------------------------------------------------------------
hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 4
  targetCPUUtilization: 70
  targetMemoryUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 50
          periodSeconds: 30
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
      selectPolicy: Min

# ---------------------------------------------------------------------------
# PDB
# ---------------------------------------------------------------------------
pdb:
  enabled: true
  minAvailable: 1

# ---------------------------------------------------------------------------
# Network Policy
# ---------------------------------------------------------------------------
networkPolicy:
  enabled: true

# ---------------------------------------------------------------------------
# Service Monitor
# ---------------------------------------------------------------------------
serviceMonitor:
  enabled: true
  interval: 30s

# ---------------------------------------------------------------------------
# Affinity - Prefer zone spread
# ---------------------------------------------------------------------------
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - greenlang-otel-collector
          topologyKey: kubernetes.io/hostname
