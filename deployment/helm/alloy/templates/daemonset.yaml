# =============================================================================
# GreenLang Alloy - DaemonSet
# GreenLang Climate OS | INFRA-009
# =============================================================================
# Runs one Alloy pod per node to collect container logs from /var/log/pods
# and Docker container logs. Exposes OTLP endpoints for direct log ingestion.
# =============================================================================

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Release.Name }}-alloy
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: alloy
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/part-of: greenlang-logging
    app.kubernetes.io/component: log-collector
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: alloy
      app.kubernetes.io/instance: {{ .Release.Name }}
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: alloy
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/part-of: greenlang-logging
        app.kubernetes.io/component: log-collector
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
    spec:
      serviceAccountName: {{ .Release.Name }}-alloy
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      # -----------------------------------------------------------------------
      # Security context (pod level)
      # -----------------------------------------------------------------------
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001

      containers:
        - name: alloy
          image: "grafana/alloy:v{{ .Chart.AppVersion }}"
          imagePullPolicy: IfNotPresent
          args:
            - run
            - /etc/alloy/config.alloy
            - --server.http.listen-addr=0.0.0.0:12345
            - --storage.path=/var/lib/alloy/data
          ports:
            - name: otlp-grpc
              containerPort: 4317
              protocol: TCP
            - name: otlp-http
              containerPort: 4318
              protocol: TCP
            - name: alloy-ui
              containerPort: 12345
              protocol: TCP

          # -------------------------------------------------------------------
          # Container security context
          # -------------------------------------------------------------------
          securityContext:
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

          # -------------------------------------------------------------------
          # Resource limits
          # -------------------------------------------------------------------
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          # -------------------------------------------------------------------
          # Health checks
          # -------------------------------------------------------------------
          livenessProbe:
            httpGet:
              path: /-/ready
              port: 12345
            initialDelaySeconds: 15
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /-/ready
              port: 12345
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          # -------------------------------------------------------------------
          # Volume mounts
          # -------------------------------------------------------------------
          volumeMounts:
            - name: config
              mountPath: /etc/alloy
              readOnly: true
            - name: varlog
              mountPath: /var/log
              readOnly: true
            - name: dockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: run
              mountPath: /run
              readOnly: true
            - name: data
              mountPath: /var/lib/alloy/data
            - name: tmp
              mountPath: /tmp

      # -----------------------------------------------------------------------
      # Volumes
      # -----------------------------------------------------------------------
      volumes:
        - name: config
          configMap:
            name: alloy-config
        - name: varlog
          hostPath:
            path: /var/log
            type: Directory
        - name: dockercontainers
          hostPath:
            path: /var/lib/docker/containers
            type: DirectoryOrCreate
        - name: run
          hostPath:
            path: /run
            type: Directory
        - name: data
          emptyDir: {}
        - name: tmp
          emptyDir: {}
