# =============================================================================
# GreenLang Process Heat Agents - Keycloak OAuth2/OIDC Deployment
# =============================================================================
# TASK-152: Implement OAuth2/OIDC (Keycloak) for Process Heat Agents
#
# This deployment provides:
#   - Keycloak identity and access management server
#   - PostgreSQL database backend for persistence
#   - High availability with clustered mode (2+ replicas)
#   - TLS/SSL termination with cert-manager
#   - Health checks (liveness, readiness, startup)
#   - Admin console access with secure credentials
#
# Security Considerations:
#   - All secrets managed via Kubernetes Secrets (external-secrets recommended)
#   - TLS 1.3 enforced for all connections
#   - Admin credentials rotated via external secrets manager
#   - Network policies restrict access to authorized services only
#   - Pod Security Standards: restricted
#
# OWASP Compliance:
#   - A02:2021 Cryptographic Failures - TLS 1.3, secure key storage
#   - A07:2021 Authentication Failures - Keycloak best practices
#   - A09:2021 Security Logging - Audit logging enabled
# =============================================================================

---
# =============================================================================
# NAMESPACE: greenlang-security
# =============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: greenlang-security
  labels:
    name: greenlang-security
    environment: production
    app.kubernetes.io/part-of: greenlang-platform
    app.kubernetes.io/component: security
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/enforce-version: latest
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
    istio-injection: enabled
  annotations:
    greenlang.io/owner: security-team
    greenlang.io/compliance: "soc2,gdpr,iso27001"
    description: "Namespace for GreenLang security infrastructure"

---
# =============================================================================
# SECRET: PostgreSQL Credentials
# =============================================================================
# NOTE: In production, use external-secrets-operator to sync from Vault/AWS SM
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-postgresql-credentials
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
    app.kubernetes.io/part-of: greenlang-platform
    app.kubernetes.io/component: database
  annotations:
    description: "PostgreSQL credentials for Keycloak - managed by external-secrets"
    # external-secrets.io/refresh-interval: "1h"
type: Opaque
stringData:
  # In production, these would be populated by external-secrets-operator
  POSTGRES_USER: keycloak
  POSTGRES_PASSWORD: "${KEYCLOAK_DB_PASSWORD}"  # Placeholder - inject at deploy time
  POSTGRES_DB: keycloak
  POSTGRES_HOST: keycloak-postgresql
  POSTGRES_PORT: "5432"

---
# =============================================================================
# SECRET: Keycloak Admin Credentials
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-admin-credentials
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/part-of: greenlang-platform
    app.kubernetes.io/component: identity
  annotations:
    description: "Keycloak admin credentials - managed by external-secrets"
type: Opaque
stringData:
  KEYCLOAK_ADMIN: admin
  KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD}"  # Placeholder

---
# =============================================================================
# SECRET: TLS Certificate for Keycloak
# =============================================================================
# NOTE: In production, use cert-manager with Let's Encrypt or internal CA
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-tls
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: tls
  annotations:
    cert-manager.io/issuer-name: letsencrypt-prod
    cert-manager.io/issuer-kind: ClusterIssuer
type: kubernetes.io/tls
data:
  # Placeholder - cert-manager will populate these
  tls.crt: ""
  tls.key: ""

---
# =============================================================================
# CONFIGMAP: PostgreSQL Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-postgresql-config
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
    app.kubernetes.io/component: database
data:
  # PostgreSQL configuration for Keycloak workload
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    max_connections = 200
    superuser_reserved_connections = 3

    # Memory Settings (tune based on pod resources)
    shared_buffers = 256MB
    effective_cache_size = 768MB
    work_mem = 16MB
    maintenance_work_mem = 64MB

    # Write-Ahead Log
    wal_level = replica
    max_wal_senders = 3
    wal_keep_size = 128MB

    # Query Planner
    random_page_cost = 1.1
    effective_io_concurrency = 200

    # Logging
    logging_collector = on
    log_directory = 'pg_log'
    log_filename = 'postgresql-%Y-%m-%d.log'
    log_statement = 'ddl'
    log_min_duration_statement = 1000

    # SSL/TLS
    ssl = on
    ssl_cert_file = '/etc/postgresql/tls/tls.crt'
    ssl_key_file = '/etc/postgresql/tls/tls.key'
    ssl_min_protocol_version = 'TLSv1.3'

  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     scram-sha-256
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             ::1/128                 scram-sha-256
    hostssl keycloak        keycloak        10.0.0.0/8              scram-sha-256
    hostssl replication     replication     10.0.0.0/8              scram-sha-256

---
# =============================================================================
# CONFIGMAP: Keycloak Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: identity
data:
  # Keycloak configuration
  KC_DB: postgres
  KC_DB_URL_DATABASE: keycloak
  KC_DB_URL_HOST: keycloak-postgresql
  KC_DB_URL_PORT: "5432"
  KC_DB_SCHEMA: public

  # HTTP/HTTPS Configuration
  KC_HTTP_ENABLED: "false"
  KC_HTTPS_PORT: "8443"
  KC_HOSTNAME_STRICT: "true"
  KC_HOSTNAME_STRICT_HTTPS: "true"
  KC_HOSTNAME: auth.greenlang.io
  KC_HOSTNAME_ADMIN: auth-admin.greenlang.io

  # Proxy Configuration (for Istio/Ingress)
  KC_PROXY: edge
  KC_HTTP_RELATIVE_PATH: /

  # Clustering Configuration (JGroups/Infinispan)
  KC_CACHE: ispn
  KC_CACHE_STACK: kubernetes
  JAVA_OPTS_APPEND: >-
    -Djgroups.dns.query=keycloak-headless.greenlang-security.svc.cluster.local
    -Djava.net.preferIPv4Stack=true
    -Djava.awt.headless=true
    -Xms512m
    -Xmx1024m
    -XX:+UseG1GC
    -XX:MaxGCPauseMillis=200

  # Metrics and Health
  KC_HEALTH_ENABLED: "true"
  KC_METRICS_ENABLED: "true"

  # Logging
  KC_LOG_LEVEL: INFO
  KC_LOG_CONSOLE_OUTPUT: json

  # Features
  KC_FEATURES: preview,token-exchange,admin-fine-grained-authz

---
# =============================================================================
# SERVICE: PostgreSQL Headless (for StatefulSet)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: keycloak-postgresql-headless
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
    app.kubernetes.io/component: database
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: postgresql
      port: 5432
      targetPort: postgresql
  selector:
    app.kubernetes.io/name: keycloak-postgresql

---
# =============================================================================
# SERVICE: PostgreSQL
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: keycloak-postgresql
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
    app.kubernetes.io/component: database
spec:
  type: ClusterIP
  ports:
    - name: postgresql
      port: 5432
      targetPort: postgresql
  selector:
    app.kubernetes.io/name: keycloak-postgresql

---
# =============================================================================
# STATEFULSET: PostgreSQL for Keycloak
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keycloak-postgresql
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
    app.kubernetes.io/part-of: greenlang-platform
    app.kubernetes.io/component: database
  annotations:
    description: "PostgreSQL database for Keycloak identity server"
spec:
  serviceName: keycloak-postgresql-headless
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak-postgresql
  template:
    metadata:
      labels:
        app.kubernetes.io/name: keycloak-postgresql
        app.kubernetes.io/part-of: greenlang-platform
        app.kubernetes.io/component: database
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
    spec:
      serviceAccountName: keycloak-postgresql-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 70  # postgres user
        runAsGroup: 70
        fsGroup: 70
        seccompProfile:
          type: RuntimeDefault

      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: keycloak-postgresql
              topologyKey: kubernetes.io/hostname

      containers:
        - name: postgresql
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          ports:
            - name: postgresql
              containerPort: 5432
          envFrom:
            - secretRef:
                name: keycloak-postgresql-credentials
          env:
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql
            - name: tls
              mountPath: /etc/postgresql/tls
              readOnly: true
            - name: tmp
              mountPath: /tmp
            - name: run
              mountPath: /var/run/postgresql
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

        # PostgreSQL Exporter for Prometheus
        - name: postgres-exporter
          image: prometheuscommunity/postgres-exporter:v0.15.0
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          ports:
            - name: metrics
              containerPort: 9187
          env:
            - name: DATA_SOURCE_URI
              value: "localhost:5432/keycloak?sslmode=disable"
            - name: DATA_SOURCE_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-postgresql-credentials
                  key: POSTGRES_USER
            - name: DATA_SOURCE_PASS
              valueFrom:
                secretKeyRef:
                  name: keycloak-postgresql-credentials
                  key: POSTGRES_PASSWORD
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi

      volumes:
        - name: config
          configMap:
            name: keycloak-postgresql-config
        - name: tls
          secret:
            secretName: keycloak-tls
            defaultMode: 0400
        - name: tmp
          emptyDir: {}
        - name: run
          emptyDir: {}

  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/name: keycloak-postgresql
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: greenlang-production-ssd
        resources:
          requests:
            storage: 20Gi

---
# =============================================================================
# SERVICE ACCOUNT: PostgreSQL
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keycloak-postgresql-sa
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
automountServiceAccountToken: false

---
# =============================================================================
# SERVICE: Keycloak Headless (for clustering)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: keycloak-headless
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: identity
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: https
      port: 8443
      targetPort: https
    - name: jgroups
      port: 7600
      targetPort: jgroups
  selector:
    app.kubernetes.io/name: keycloak
  publishNotReadyAddresses: true

---
# =============================================================================
# SERVICE: Keycloak
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: identity
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8443"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
    - name: https
      port: 8443
      targetPort: https
    - name: http
      port: 8080
      targetPort: http
  selector:
    app.kubernetes.io/name: keycloak

---
# =============================================================================
# STATEFULSET: Keycloak (High Availability)
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keycloak
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/part-of: greenlang-platform
    app.kubernetes.io/component: identity
    app.kubernetes.io/version: "24.0"
  annotations:
    description: "Keycloak identity and access management server for GreenLang"
spec:
  serviceName: keycloak-headless
  replicas: 3  # High availability with 3 replicas
  podManagementPolicy: Parallel
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  template:
    metadata:
      labels:
        app.kubernetes.io/name: keycloak
        app.kubernetes.io/part-of: greenlang-platform
        app.kubernetes.io/component: identity
        sidecar.istio.io/inject: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8443"
        prometheus.io/path: "/metrics"
        prometheus.io/scheme: "https"
    spec:
      serviceAccountName: keycloak-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # Anti-affinity for HA - spread across nodes
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: keycloak
              topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: keycloak
                topologyKey: topology.kubernetes.io/zone

      # Topology spread for zone distribution
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak

      initContainers:
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgresql
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          command:
            - /bin/sh
            - -c
            - |
              until nc -z keycloak-postgresql 5432; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready"
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi

      containers:
        - name: keycloak
          image: quay.io/keycloak/keycloak:24.0
          imagePullPolicy: IfNotPresent
          args:
            - start
            - --optimized
            - --cache-config-file=/opt/keycloak/conf/cache-ispn.xml
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # Keycloak needs write access
            capabilities:
              drop:
                - ALL
          ports:
            - name: https
              containerPort: 8443
              protocol: TCP
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: jgroups
              containerPort: 7600
              protocol: TCP
            - name: management
              containerPort: 9000
              protocol: TCP
          envFrom:
            - configMapRef:
                name: keycloak-config
            - secretRef:
                name: keycloak-admin-credentials
          env:
            - name: KC_DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: keycloak-postgresql-credentials
                  key: POSTGRES_USER
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-postgresql-credentials
                  key: POSTGRES_PASSWORD
            - name: KC_HTTPS_CERTIFICATE_FILE
              value: /opt/keycloak/conf/tls/tls.crt
            - name: KC_HTTPS_CERTIFICATE_KEY_FILE
              value: /opt/keycloak/conf/tls/tls.key
            - name: KEYCLOAK_FRONTEND_URL
              value: https://auth.greenlang.io
            - name: KC_SPI_STICKY_SESSION_ENCODER_INFINISPAN_SHOULD_ATTACH_ROUTE
              value: "false"
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 2Gi
          volumeMounts:
            - name: tls
              mountPath: /opt/keycloak/conf/tls
              readOnly: true
            - name: cache-config
              mountPath: /opt/keycloak/conf/cache-ispn.xml
              subPath: cache-ispn.xml
              readOnly: true
            - name: realm-config
              mountPath: /opt/keycloak/data/import
              readOnly: true
            - name: tmp
              mountPath: /tmp

          # Startup probe - allow time for initial start
          startupProbe:
            httpGet:
              path: /health/started
              port: 9000
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 60  # Allow 5 minutes for startup

          # Liveness probe - restart if unhealthy
          livenessProbe:
            httpGet:
              path: /health/live
              port: 9000
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3

          # Readiness probe - remove from LB if not ready
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 9000
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

      volumes:
        - name: tls
          secret:
            secretName: keycloak-tls
            defaultMode: 0400
        - name: cache-config
          configMap:
            name: keycloak-cache-config
        - name: realm-config
          configMap:
            name: keycloak-realm-config
        - name: tmp
          emptyDir: {}

      terminationGracePeriodSeconds: 60

---
# =============================================================================
# SERVICE ACCOUNT: Keycloak
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keycloak-sa
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
automountServiceAccountToken: false

---
# =============================================================================
# CONFIGMAP: Keycloak Infinispan Cache Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-cache-config
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: cache
data:
  cache-ispn.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <infinispan
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="urn:infinispan:config:14.0 https://infinispan.org/schemas/infinispan-config-14.0.xsd"
            xmlns="urn:infinispan:config:14.0">

        <jgroups>
            <stack name="kubernetes" extends="tcp">
                <TCP bind_addr="${env.POD_IP:127.0.0.1}"
                     bind_port="7600"
                     port_range="0"/>
                <dns.DNS_PING dns_query="keycloak-headless.greenlang-security.svc.cluster.local"
                              dns_record_type="A"
                              num_discovery_runs="3"/>
            </stack>
        </jgroups>

        <cache-container name="keycloak">
            <transport lock-timeout="60000" stack="kubernetes"/>

            <local-cache name="realms">
                <encoding>
                    <key media-type="application/x-java-object"/>
                    <value media-type="application/x-java-object"/>
                </encoding>
                <memory max-count="10000"/>
            </local-cache>

            <local-cache name="users">
                <encoding>
                    <key media-type="application/x-java-object"/>
                    <value media-type="application/x-java-object"/>
                </encoding>
                <memory max-count="10000"/>
            </local-cache>

            <distributed-cache name="sessions" owners="2">
                <expiration lifespan="-1"/>
            </distributed-cache>

            <distributed-cache name="authenticationSessions" owners="2">
                <expiration lifespan="-1"/>
            </distributed-cache>

            <distributed-cache name="offlineSessions" owners="2">
                <expiration lifespan="-1"/>
            </distributed-cache>

            <distributed-cache name="clientSessions" owners="2">
                <expiration lifespan="-1"/>
            </distributed-cache>

            <distributed-cache name="offlineClientSessions" owners="2">
                <expiration lifespan="-1"/>
            </distributed-cache>

            <distributed-cache name="loginFailures" owners="2">
                <expiration lifespan="-1"/>
            </distributed-cache>

            <local-cache name="authorization">
                <encoding>
                    <key media-type="application/x-java-object"/>
                    <value media-type="application/x-java-object"/>
                </encoding>
                <memory max-count="10000"/>
            </local-cache>

            <replicated-cache name="work">
                <expiration lifespan="-1"/>
            </replicated-cache>

            <local-cache name="keys">
                <encoding>
                    <key media-type="application/x-java-object"/>
                    <value media-type="application/x-java-object"/>
                </encoding>
                <expiration max-idle="3600000"/>
                <memory max-count="1000"/>
            </local-cache>

            <distributed-cache name="actionTokens" owners="2">
                <encoding>
                    <key media-type="application/x-java-object"/>
                    <value media-type="application/x-java-object"/>
                </encoding>
                <expiration max-idle="-1" interval="300000"/>
                <memory max-count="-1"/>
            </distributed-cache>
        </cache-container>
    </infinispan>

---
# =============================================================================
# HORIZONTAL POD AUTOSCALER: Keycloak
# =============================================================================
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: keycloak-hpa
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: keycloak
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Pods
          value: 2
          periodSeconds: 30

---
# =============================================================================
# POD DISRUPTION BUDGET: Keycloak
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: keycloak-pdb
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak

---
# =============================================================================
# POD DISRUPTION BUDGET: PostgreSQL
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: keycloak-postgresql-pdb
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak-postgresql

---
# =============================================================================
# NETWORK POLICY: Keycloak
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: keycloak-network-policy
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Istio ingress gateway
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
      ports:
        - protocol: TCP
          port: 8443
    # Allow from GreenLang production (API)
    - from:
        - namespaceSelector:
            matchLabels:
              name: greenlang-production
      ports:
        - protocol: TCP
          port: 8443
    # Allow from GreenLang agents
    - from:
        - namespaceSelector:
            matchLabels:
              name: greenlang-agents
      ports:
        - protocol: TCP
          port: 8443
    # Allow inter-pod communication (clustering)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak
      ports:
        - protocol: TCP
          port: 7600
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8443
  egress:
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak-postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow inter-pod communication (clustering)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak
      ports:
        - protocol: TCP
          port: 7600
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# =============================================================================
# NETWORK POLICY: PostgreSQL
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: keycloak-postgresql-network-policy
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak-postgresql
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: keycloak-postgresql
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Keycloak only
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak
      ports:
        - protocol: TCP
          port: 5432
    # Allow replication between PostgreSQL pods
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak-postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9187
  egress:
    # Allow replication between PostgreSQL pods
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak-postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# =============================================================================
# INGRESS: Keycloak (via Istio Gateway)
# =============================================================================
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: keycloak-vs
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
spec:
  hosts:
    - auth.greenlang.io
    - auth-admin.greenlang.io
  gateways:
    - istio-system/greenlang-gateway
  http:
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: keycloak
            port:
              number: 8443
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: connect-failure,reset,retriable-4xx,503

---
# =============================================================================
# CERTIFICATE: Keycloak TLS (cert-manager)
# =============================================================================
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: keycloak-certificate
  namespace: greenlang-security
  labels:
    app.kubernetes.io/name: keycloak
spec:
  secretName: keycloak-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: auth.greenlang.io
  dnsNames:
    - auth.greenlang.io
    - auth-admin.greenlang.io
  privateKey:
    algorithm: ECDSA
    size: 256
