{{/*
GreenLang Infrastructure Helm Chart - Executor and Worker Deployments
*/}}

{{- if .Values.executor.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "greenlang.fullname" . }}-executor
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.executor.labels" . | nindent 4 }}
spec:
  {{- if not .Values.executor.autoscaling.enabled }}
  replicas: {{ .Values.executor.replicaCount | default 3 }}
  {{- end }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      {{- include "greenlang.selectorLabels" . | nindent 6 }}
      component: executor
  template:
    metadata:
      labels:
        {{- include "greenlang.executor.labels" . | nindent 8 }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{ .Values.executor.service.metricsPort | default 9090 }}"
        prometheus.io/path: "/metrics"
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
    spec:
      serviceAccountName: {{ include "greenlang.serviceAccountName" . }}

      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- range .Values.image.pullSecrets }}
        - name: {{ . }}
        {{- end }}
      {{- end }}

      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      {{- if .Values.topologySpreadConstraints.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpreadConstraints.maxSkew | default 1 }}
          topologyKey: {{ .Values.topologySpreadConstraints.topologyKey | default "topology.kubernetes.io/zone" }}
          whenUnsatisfiable: {{ .Values.topologySpreadConstraints.whenUnsatisfiable | default "DoNotSchedule" }}
          labelSelector:
            matchLabels:
              {{- include "greenlang.selectorLabels" . | nindent 14 }}
              component: executor
      {{- end }}

      {{- if eq .Values.affinity.podAntiAffinity "required" }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "greenlang.selectorLabels" . | nindent 18 }}
                  component: executor
              topologyKey: kubernetes.io/hostname
      {{- else if eq .Values.affinity.podAntiAffinity "preferred" }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "greenlang.selectorLabels" . | nindent 20 }}
                    component: executor
                topologyKey: kubernetes.io/hostname
      {{- end }}

      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      containers:
        - name: executor
          image: {{ include "greenlang.executor.image" . }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL

          ports:
            - name: http
              containerPort: {{ .Values.executor.service.targetPort | default 8080 }}
              protocol: TCP
            - name: metrics
              containerPort: {{ .Values.executor.service.metricsPort | default 9090 }}
              protocol: TCP

          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            {{- range .Values.env }}
            - name: {{ .name }}
              value: {{ .value | quote }}
            {{- end }}

          {{- with .Values.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1

          startupProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 30

          resources:
            {{- toYaml .Values.executor.resources | nindent 12 }}

          volumeMounts:
            - name: config
              mountPath: /app/config
              readOnly: true
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/.cache

      volumes:
        - name: config
          configMap:
            name: {{ include "greenlang.fullname" . }}-config
        - name: tmp
          emptyDir:
            sizeLimit: 100Mi
        - name: cache
          emptyDir:
            sizeLimit: 500Mi
{{- end }}

{{- if .Values.worker.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "greenlang.fullname" . }}-worker
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.worker.labels" . | nindent 4 }}
spec:
  {{- if not .Values.worker.autoscaling.enabled }}
  replicas: {{ .Values.worker.replicaCount | default 5 }}
  {{- end }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 0
  selector:
    matchLabels:
      {{- include "greenlang.selectorLabels" . | nindent 6 }}
      component: worker
  template:
    metadata:
      labels:
        {{- include "greenlang.worker.labels" . | nindent 8 }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
    spec:
      serviceAccountName: {{ include "greenlang.serviceAccountName" . }}
      terminationGracePeriodSeconds: 300

      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- range .Values.image.pullSecrets }}
        - name: {{ . }}
        {{- end }}
      {{- end }}

      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      {{- if .Values.topologySpreadConstraints.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpreadConstraints.maxSkew | default 1 }}
          topologyKey: {{ .Values.topologySpreadConstraints.topologyKey | default "topology.kubernetes.io/zone" }}
          whenUnsatisfiable: {{ .Values.topologySpreadConstraints.whenUnsatisfiable | default "DoNotSchedule" }}
          labelSelector:
            matchLabels:
              {{- include "greenlang.selectorLabels" . | nindent 14 }}
              component: worker
      {{- end }}

      {{- if eq .Values.affinity.podAntiAffinity "required" }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "greenlang.selectorLabels" . | nindent 18 }}
                  component: worker
              topologyKey: kubernetes.io/hostname
      {{- else if eq .Values.affinity.podAntiAffinity "preferred" }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "greenlang.selectorLabels" . | nindent 20 }}
                    component: worker
                topologyKey: kubernetes.io/hostname
      {{- end }}

      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      containers:
        - name: worker
          image: {{ include "greenlang.worker.image" . }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP

          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: MAX_CONCURRENT_TASKS
              value: {{ .Values.worker.config.maxConcurrentTasks | default "10" | quote }}
            - name: TASK_TIMEOUT
              value: {{ .Values.worker.config.taskTimeout | default "3600" | quote }}
            - name: HEARTBEAT_INTERVAL
              value: {{ .Values.worker.config.heartbeatInterval | default "5" | quote }}
            {{- range .Values.env }}
            - name: {{ .name }}
              value: {{ .value | quote }}
            {{- end }}

          {{- with .Values.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1

          startupProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 30

          resources:
            {{- toYaml .Values.worker.resources | nindent 12 }}

          volumeMounts:
            - name: config
              mountPath: /app/config
              readOnly: true
            - name: tmp
              mountPath: /tmp
            - name: work
              mountPath: /app/work
            - name: cache
              mountPath: /app/.cache

      volumes:
        - name: config
          configMap:
            name: {{ include "greenlang.fullname" . }}-config
        - name: tmp
          emptyDir:
            sizeLimit: 500Mi
        - name: work
          emptyDir:
            sizeLimit: {{ .Values.worker.resources.requests.ephemeral-storage | default "2Gi" }}
        - name: cache
          emptyDir:
            sizeLimit: 1Gi
{{- end }}
