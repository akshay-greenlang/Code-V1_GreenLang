##############################################
# GreenLang Secrets Management Alerts
# SEC-006: Monitoring for ESO and Vault Agent
##############################################

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: secrets-management-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/name: secrets-management-alerts
    app.kubernetes.io/component: alerting
    app.kubernetes.io/part-of: greenlang
    prometheus: kube-prometheus
    release: prometheus
spec:
  groups:
    # External Secrets Operator Alerts
    - name: external-secrets-operator
      interval: 30s
      rules:
        # ExternalSecret sync failure
        - alert: ExternalSecretSyncFailed
          expr: |
            externalsecret_status_condition{condition="Ready", status="False"} == 1
          for: 5m
          labels:
            severity: critical
            component: external-secrets
            service: secrets-management
          annotations:
            summary: "ExternalSecret {{ $labels.namespace }}/{{ $labels.name }} sync failed"
            description: "ExternalSecret {{ $labels.namespace }}/{{ $labels.name }} has been in failed state for more than 5 minutes. Check ESO logs and Vault connectivity."
            runbook_url: "https://docs.greenlang.io/runbooks/external-secret-sync-failed"

        # ExternalSecret not synced for extended period
        - alert: ExternalSecretStale
          expr: |
            time() - externalsecret_status_sync_time > 3600
          for: 15m
          labels:
            severity: warning
            component: external-secrets
            service: secrets-management
          annotations:
            summary: "ExternalSecret {{ $labels.namespace }}/{{ $labels.name }} is stale"
            description: "ExternalSecret {{ $labels.namespace }}/{{ $labels.name }} has not synced for over 1 hour."
            runbook_url: "https://docs.greenlang.io/runbooks/external-secret-stale"

        # High ExternalSecret sync latency
        - alert: ExternalSecretHighSyncLatency
          expr: |
            histogram_quantile(0.95, sum(rate(externalsecret_sync_duration_seconds_bucket[5m])) by (le, namespace)) > 10
          for: 10m
          labels:
            severity: warning
            component: external-secrets
            service: secrets-management
          annotations:
            summary: "High ExternalSecret sync latency in {{ $labels.namespace }}"
            description: "95th percentile sync latency is {{ $value | humanizeDuration }} in namespace {{ $labels.namespace }}."

        # SecretStore unhealthy
        - alert: SecretStoreUnhealthy
          expr: |
            secretstore_status_condition{condition="Ready", status="False"} == 1
          for: 5m
          labels:
            severity: critical
            component: external-secrets
            service: secrets-management
          annotations:
            summary: "SecretStore {{ $labels.namespace }}/{{ $labels.name }} is unhealthy"
            description: "SecretStore {{ $labels.namespace }}/{{ $labels.name }} is not ready. Check provider connectivity."
            runbook_url: "https://docs.greenlang.io/runbooks/secret-store-unhealthy"

        # ClusterSecretStore unhealthy
        - alert: ClusterSecretStoreUnhealthy
          expr: |
            clustersecretstore_status_condition{condition="Ready", status="False"} == 1
          for: 5m
          labels:
            severity: critical
            component: external-secrets
            service: secrets-management
          annotations:
            summary: "ClusterSecretStore {{ $labels.name }} is unhealthy"
            description: "ClusterSecretStore {{ $labels.name }} is not ready. This affects all namespaces using this store."
            runbook_url: "https://docs.greenlang.io/runbooks/cluster-secret-store-unhealthy"

        # ESO controller pod not ready
        - alert: ExternalSecretsOperatorDown
          expr: |
            up{job="external-secrets"} == 0
          for: 5m
          labels:
            severity: critical
            component: external-secrets
            service: secrets-management
          annotations:
            summary: "External Secrets Operator is down"
            description: "External Secrets Operator has been down for more than 5 minutes. Secrets will not sync."
            runbook_url: "https://docs.greenlang.io/runbooks/eso-down"

    # Vault Agent Injector Alerts
    - name: vault-agent-injector
      interval: 30s
      rules:
        # Vault Agent Injector pod not ready
        - alert: VaultAgentInjectorDown
          expr: |
            up{job="vault-agent-injector"} == 0
          for: 5m
          labels:
            severity: critical
            component: vault-agent
            service: secrets-management
          annotations:
            summary: "Vault Agent Injector is down"
            description: "Vault Agent Injector has been down for more than 5 minutes. New pods will not receive secrets."
            runbook_url: "https://docs.greenlang.io/runbooks/vault-injector-down"

        # Vault Agent injection failures
        - alert: VaultAgentInjectionFailure
          expr: |
            increase(vault_agent_injector_injection_failures_total[5m]) > 0
          for: 5m
          labels:
            severity: critical
            component: vault-agent
            service: secrets-management
          annotations:
            summary: "Vault Agent injection failures detected"
            description: "{{ $value }} injection failures in the last 5 minutes. Pods may be starting without secrets."
            runbook_url: "https://docs.greenlang.io/runbooks/vault-injection-failure"

        # High injection latency
        - alert: VaultAgentHighInjectionLatency
          expr: |
            histogram_quantile(0.95, sum(rate(vault_agent_injector_injection_duration_seconds_bucket[5m])) by (le)) > 5
          for: 10m
          labels:
            severity: warning
            component: vault-agent
            service: secrets-management
          annotations:
            summary: "High Vault Agent injection latency"
            description: "95th percentile injection latency is {{ $value | humanizeDuration }}. Pod startup may be delayed."

    # Vault Server Alerts
    - name: vault-server
      interval: 30s
      rules:
        # Vault server unreachable
        - alert: VaultServerUnreachable
          expr: |
            vault_up == 0
          for: 2m
          labels:
            severity: critical
            component: vault
            service: secrets-management
          annotations:
            summary: "Vault server is unreachable"
            description: "Cannot reach Vault server at {{ $labels.instance }}. All secret operations will fail."
            runbook_url: "https://docs.greenlang.io/runbooks/vault-unreachable"

        # Vault sealed
        - alert: VaultSealed
          expr: |
            vault_core_unsealed == 0
          for: 1m
          labels:
            severity: critical
            component: vault
            service: secrets-management
          annotations:
            summary: "Vault is sealed"
            description: "Vault server {{ $labels.instance }} is sealed. Manual or auto-unseal required."
            runbook_url: "https://docs.greenlang.io/runbooks/vault-sealed"

        # Vault standby (not leader in HA)
        - alert: VaultNoActiveNode
          expr: |
            sum(vault_core_active) == 0
          for: 2m
          labels:
            severity: critical
            component: vault
            service: secrets-management
          annotations:
            summary: "No active Vault node"
            description: "No Vault node is active in the cluster. HA failover may have failed."
            runbook_url: "https://docs.greenlang.io/runbooks/vault-no-active"

        # High token creation rate (possible abuse)
        - alert: VaultHighTokenCreationRate
          expr: |
            rate(vault_token_create_count[5m]) > 100
          for: 5m
          labels:
            severity: warning
            component: vault
            service: secrets-management
          annotations:
            summary: "High Vault token creation rate"
            description: "Token creation rate is {{ $value }}/s. This may indicate misconfiguration or abuse."

        # Vault audit log failures
        - alert: VaultAuditLogFailure
          expr: |
            increase(vault_audit_log_request_failure[5m]) > 0
          for: 1m
          labels:
            severity: critical
            component: vault
            service: secrets-management
          annotations:
            summary: "Vault audit log failure"
            description: "Vault audit logging is failing. Compliance requirements may be violated."
            runbook_url: "https://docs.greenlang.io/runbooks/vault-audit-failure"

        # Vault lease expiration warning
        - alert: VaultLeaseExpirationWarning
          expr: |
            vault_expire_num_leases > 10000
          for: 10m
          labels:
            severity: warning
            component: vault
            service: secrets-management
          annotations:
            summary: "High number of Vault leases"
            description: "{{ $value }} active leases. Consider reviewing lease TTLs or increasing revocation frequency."

    # Secret Rotation Alerts
    - name: secret-rotation
      interval: 60s
      rules:
        # Secret not rotated for extended period
        - alert: SecretRotationOverdue
          expr: |
            time() - secret_last_rotation_timestamp > 86400 * 90
          for: 1h
          labels:
            severity: warning
            component: secret-rotation
            service: secrets-management
          annotations:
            summary: "Secret {{ $labels.secret_name }} rotation overdue"
            description: "Secret {{ $labels.namespace }}/{{ $labels.secret_name }} has not been rotated in over 90 days."
            runbook_url: "https://docs.greenlang.io/runbooks/secret-rotation-overdue"

        # Secret rotation failure
        - alert: SecretRotationFailed
          expr: |
            increase(secret_rotation_failures_total[1h]) > 0
          for: 5m
          labels:
            severity: critical
            component: secret-rotation
            service: secrets-management
          annotations:
            summary: "Secret rotation failed"
            description: "Secret rotation failed {{ $value }} times in the last hour."
            runbook_url: "https://docs.greenlang.io/runbooks/secret-rotation-failed"

    # Security Alerts
    - name: secrets-security
      interval: 30s
      rules:
        # Unauthorized secret access attempt
        - alert: UnauthorizedSecretAccess
          expr: |
            increase(vault_core_handle_request_count{status="403"}[5m]) > 10
          for: 5m
          labels:
            severity: warning
            component: vault
            service: secrets-management
            security: true
          annotations:
            summary: "Multiple unauthorized secret access attempts"
            description: "{{ $value }} unauthorized access attempts in the last 5 minutes. Check for potential security incident."
            runbook_url: "https://docs.greenlang.io/runbooks/unauthorized-secret-access"

        # Secret access from unknown source
        - alert: SecretAccessFromUnknownSource
          expr: |
            increase(vault_secret_access_from_unknown_source_total[5m]) > 0
          for: 1m
          labels:
            severity: critical
            component: vault
            service: secrets-management
            security: true
          annotations:
            summary: "Secret access from unknown source"
            description: "Secrets accessed from unrecognized source IP or service account."
            runbook_url: "https://docs.greenlang.io/runbooks/unknown-secret-access"

        # Bulk secret read (possible exfiltration)
        - alert: BulkSecretRead
          expr: |
            rate(vault_secret_kv_count{operation="read"}[5m]) > 50
          for: 5m
          labels:
            severity: warning
            component: vault
            service: secrets-management
            security: true
          annotations:
            summary: "Bulk secret read detected"
            description: "High rate of secret reads detected ({{ $value }}/s). Investigate for possible exfiltration."
            runbook_url: "https://docs.greenlang.io/runbooks/bulk-secret-read"
