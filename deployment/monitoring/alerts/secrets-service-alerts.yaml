# =============================================================================
# GreenLang Climate OS - Secrets Service Prometheus Alert Rules
# =============================================================================
# PRD: SEC-006 Deploy Secrets Management
# Defines alerting rules for Vault health, secret operations, rotation monitoring,
# lease management, and External Secrets Operator sync status.
# =============================================================================

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: secrets-service-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/name: secrets-service
    app.kubernetes.io/part-of: greenlang
    prometheus: kube-prometheus
    role: alert-rules
    greenlang.io/component: sec-006
spec:
  groups:
    # =========================================================================
    # Group 1: Vault Health Alerts
    # =========================================================================
    - name: secrets_service.vault_health
      interval: 30s
      rules:
        # ---------------------------------------------------------------------
        # VaultSealed
        # Fires when Vault is in sealed state. All secrets operations will fail.
        # This is a critical infrastructure emergency requiring immediate action.
        # ---------------------------------------------------------------------
        - alert: VaultSealed
          expr: |
            vault_core_sealed == 1
          for: 1m
          labels:
            severity: critical
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "HashiCorp Vault is sealed"
            description: >-
              Vault has been in a sealed state for over 1 minute. All secrets
              operations are failing. This affects database connections, API
              authentication, and certificate issuance for all applications.
              Unseal Vault immediately using the unseal keys or auto-unseal
              mechanism. Check for pod restarts, node failures, or network
              partitions that may have caused the seal event.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/vault-sealed"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # VaultUnavailable
        # Fires when Vault instances are not responding to health checks.
        # ---------------------------------------------------------------------
        - alert: VaultUnavailable
          expr: |
            up{job="vault"} == 0
          for: 2m
          labels:
            severity: critical
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Vault instance is unavailable"
            description: >-
              Vault at {{ $labels.instance }} has been unreachable for 2 minutes.
              No secrets can be read or written until connectivity is restored.
              Check Vault pod status (kubectl get pods -l app=vault), network
              policies, and underlying storage backend (Consul/Raft) health.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/vault-unavailable"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # VaultHighLatency
        # Fires when Vault request latency exceeds acceptable thresholds.
        # May indicate storage backend issues or resource constraints.
        # ---------------------------------------------------------------------
        - alert: VaultHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(vault_core_handle_request_bucket[5m])) by (le)
            ) > 0.1
          for: 5m
          labels:
            severity: warning
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Vault request latency P99 exceeds 100ms"
            description: >-
              Vault request latency P99 is {{ $value | printf "%.3f" }}s,
              exceeding the 100ms threshold for 5 minutes. High latency impacts
              application performance and may cause request timeouts. Check
              Vault resource utilization, storage backend performance (Consul/
              Raft replication), and network latency between Vault and clients.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/vault-high-latency"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # VaultTokenRenewalFailed
        # Fires when the application's Vault token renewal is failing.
        # Will eventually lead to authentication failures.
        # ---------------------------------------------------------------------
        - alert: VaultTokenRenewalFailed
          expr: |
            rate(gl_vault_auth_renewals_total{status="failure"}[5m]) > 0
          for: 2m
          labels:
            severity: critical
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Vault authentication token renewal failures detected"
            description: >-
              Vault token renewal is failing at
              {{ $value | printf "%.2f" }}/sec. The application will lose
              access to secrets when the current token expires. Check the Vault
              authentication method (Kubernetes auth, AppRole), token policies,
              and Vault audit logs for denial reasons. Immediate action required
              to prevent service disruption.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/token-renewal-failed"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

    # =========================================================================
    # Group 2: Operations Alerts
    # =========================================================================
    - name: secrets_service.operations
      interval: 30s
      rules:
        # ---------------------------------------------------------------------
        # SecretsOperationFailures
        # Fires when secret operation failure rate exceeds 1%.
        # May indicate permission issues, quota limits, or backend problems.
        # ---------------------------------------------------------------------
        - alert: SecretsOperationFailures
          expr: |
            (
              sum(rate(gl_secrets_operations_total{result="failure"}[5m]))
              /
              sum(rate(gl_secrets_operations_total[5m]))
            ) > 0.01
          for: 5m
          labels:
            severity: warning
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Secrets operation failure rate exceeds 1%"
            description: >-
              {{ $value | humanizePercentage }} of secrets operations are
              failing over the last 5 minutes. Check the Failed Operations
              panel in the dashboard to identify affected operations and
              secret types. Common causes include: Vault policy denials,
              secret engine misconfigurations, or backend storage issues.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/operation-failures"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # SecretAccessDenied
        # Fires when access denied events exceed threshold.
        # May indicate misconfigured policies or unauthorized access attempts.
        # ---------------------------------------------------------------------
        - alert: SecretAccessDenied
          expr: |
            sum(rate(gl_secrets_operations_total{result="denied"}[5m])) * 300 > 10
          for: 3m
          labels:
            severity: warning
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "High rate of secret access denials"
            description: >-
              More than 10 secret access denials in the last 5 minutes.
              Current rate: {{ $value | printf "%.0f" }} denials/5min.
              This may indicate policy misconfigurations, applications
              attempting to access unauthorized secrets, or a potential
              security probe. Review Vault audit logs and the Failed
              Operations dashboard panel.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/access-denied"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # LeaseExpiringCritical
        # Fires when any secret lease has less than 1 hour remaining.
        # Dynamic secrets may stop working when leases expire.
        # ---------------------------------------------------------------------
        - alert: LeaseExpiringCritical
          expr: |
            gl_vault_lease_ttl_seconds < 3600
          for: 5m
          labels:
            severity: critical
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Secret lease expiring within 1 hour"
            description: >-
              Secret lease for {{ $labels.secret_type }} at path
              {{ $labels.path }} has only {{ $value | printf "%.0f" }} seconds
              remaining (< 1 hour). If the lease expires without renewal, the
              associated dynamic credentials will be revoked. Check the lease
              renewal mechanism, Vault connectivity, and ensure the application
              is properly renewing leases.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/lease-expiring"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

    # =========================================================================
    # Group 3: Rotation Alerts
    # =========================================================================
    - name: secrets_service.rotation
      interval: 60s
      rules:
        # ---------------------------------------------------------------------
        # RotationFailed
        # Fires when secret rotation is failing. Stale secrets increase
        # security risk and may violate compliance requirements.
        # ---------------------------------------------------------------------
        - alert: RotationFailed
          expr: |
            rate(gl_secrets_rotation_total{status="failure"}[5m]) > 0
          for: 2m
          labels:
            severity: critical
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Secret rotation failures detected"
            description: >-
              Secret rotation for {{ $labels.secret_type }} is failing.
              Rotation failures at {{ $value | printf "%.2f" }}/sec mean
              credentials are not being refreshed per security policy.
              This may violate compliance requirements (SOC 2, PCI DSS)
              and increases security risk from stale credentials. Check
              Vault connectivity, rotation scripts, and destination systems.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/rotation-failed"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # RotationOverdue
        # Fires when secrets have not been rotated within 1.5x the expected
        # rotation interval.
        # ---------------------------------------------------------------------
        - alert: RotationOverdue
          expr: |
            (
              time() - gl_secrets_rotation_last_success_timestamp
            ) > 129600
          for: 10m
          labels:
            severity: warning
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "Secret rotation overdue (>36 hours since last rotation)"
            description: >-
              Secret type {{ $labels.secret_type }} has not been successfully
              rotated in {{ $value | humanizeDuration }}. The expected rotation
              interval is 24 hours. Stale secrets increase security risk and
              may violate compliance requirements. Check the rotation scheduler,
              Vault connectivity, and any rotation script errors.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/rotation-overdue"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # CertificateExpiring
        # Fires when TLS certificates have less than 7 days remaining.
        # Expired certificates cause service outages.
        # ---------------------------------------------------------------------
        - alert: CertificateExpiring
          expr: |
            gl_vault_lease_ttl_seconds{secret_type="certificate"} < 604800
          for: 30m
          labels:
            severity: warning
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "TLS certificate expiring within 7 days"
            description: >-
              Certificate at {{ $labels.path }} expires in
              {{ $value | humanizeDuration }}. Certificates should be
              automatically renewed well before expiration. Check the
              cert-manager or Vault PKI automatic renewal configuration.
              If not renewed, services using this certificate will
              experience TLS handshake failures.
            runbook_url: "https://runbooks.greenlang.io/secrets-service/certificate-expiring"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

    # =========================================================================
    # Group 4: External Secrets Operator (ESO) Alerts
    # =========================================================================
    - name: secrets_service.eso
      interval: 30s
      rules:
        # ---------------------------------------------------------------------
        # ESOSyncFailed
        # Fires when External Secrets Operator is failing to sync secrets
        # from Vault to Kubernetes.
        # ---------------------------------------------------------------------
        - alert: ESOSyncFailed
          expr: |
            rate(gl_eso_sync_total{status="failure"}[5m]) > 0
          for: 3m
          labels:
            severity: critical
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "External Secrets Operator sync failures"
            description: >-
              ESO is failing to sync secret {{ $labels.secret }} from Vault
              to Kubernetes. Failure rate: {{ $value | printf "%.2f" }}/sec.
              Applications depending on this ExternalSecret will not receive
              updated credentials. Check the ESO controller logs, Vault
              connectivity, and the ExternalSecret resource status:
              kubectl describe externalsecret {{ $labels.secret }}
            runbook_url: "https://runbooks.greenlang.io/secrets-service/eso-sync-failed"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"

        # ---------------------------------------------------------------------
        # ESOStale
        # Fires when ESO has not successfully synced in over 5 minutes.
        # Kubernetes secrets may be out of sync with Vault.
        # ---------------------------------------------------------------------
        - alert: ESOStale
          expr: |
            (time() - gl_eso_sync_last_success_timestamp) > 300
          for: 5m
          labels:
            severity: warning
            team: platform-security
            component: secrets-service
            prd: SEC-006
          annotations:
            summary: "External Secret sync stale (>5 min since last success)"
            description: >-
              ExternalSecret {{ $labels.secret }} has not synced successfully
              in {{ $value | humanizeDuration }}. The Kubernetes Secret may
              contain stale credentials. Check ESO controller health, Vault
              connectivity, and the refresh interval configuration:
              kubectl get externalsecret {{ $labels.secret }} -o yaml
            runbook_url: "https://runbooks.greenlang.io/secrets-service/eso-stale"
            dashboard_url: "https://grafana.greenlang.io/d/greenlang-secrets-service"
