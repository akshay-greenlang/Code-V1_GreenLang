# =============================================================================
# GreenLang Climate OS - Loki Log-Based Prometheus Recording Rules
# =============================================================================
# PRD: INFRA-009 Centralized Logging & Log-Based Alerting
# These recording rules pre-compute commonly used log metrics via Loki Ruler
# and export them to Prometheus via remote_write. This reduces query load on
# Loki for dashboards and alerts that reference log-derived metrics.
# =============================================================================

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: loki-recording-rules
  namespace: monitoring
  labels:
    app.kubernetes.io/name: loki
    app.kubernetes.io/part-of: greenlang
    prometheus: kube-prometheus
    role: recording-rules
    greenlang.io/component: infra-009
spec:
  groups:
    # =========================================================================
    # Group: Log Recording Rules
    # Pre-computed log metrics at 1-minute intervals for fast dashboard queries.
    # These are evaluated by Loki Ruler and remote_written to Prometheus.
    # =========================================================================
    - name: greenlang-log-recording-rules
      interval: 1m
      rules:
        # -------------------------------------------------------------------
        # Error rate per service over 5-minute window.
        # Used by: log-exploration dashboard, HighErrorRate alert.
        # -------------------------------------------------------------------
        - record: greenlang:log_error_rate:5m
          expr: |
            sum by (app) (
              rate(
                {namespace="greenlang"} | json | level="error" [5m]
              )
            )

        # -------------------------------------------------------------------
        # Warning rate per service over 5-minute window.
        # Used by: log-exploration dashboard, HighWarningRate alert.
        # -------------------------------------------------------------------
        - record: greenlang:log_warning_rate:5m
          expr: |
            sum by (app) (
              rate(
                {namespace="greenlang"} | json | level="warning" [5m]
              )
            )

        # -------------------------------------------------------------------
        # Log volume in bytes per service over 1-minute window.
        # Used by: capacity planning, cost allocation dashboards.
        # -------------------------------------------------------------------
        - record: greenlang:log_volume_bytes:1m
          expr: |
            sum by (app) (
              bytes_rate(
                {namespace="greenlang"} [1m]
              )
            )

        # -------------------------------------------------------------------
        # Total log lines per service over 1-minute window.
        # Used by: log volume dashboards, error ratio computation.
        # -------------------------------------------------------------------
        - record: greenlang:log_lines_total:1m
          expr: |
            sum by (app) (
              rate(
                {namespace="greenlang"} [1m]
              )
            )

        # -------------------------------------------------------------------
        # Error ratio (errors / total) per service over 5-minute window.
        # Expresses the percentage of log lines that are errors.
        # Used by: service health dashboards, SLO tracking.
        # -------------------------------------------------------------------
        - record: greenlang:log_error_ratio:5m
          expr: |
            (
              sum by (app) (
                rate(
                  {namespace="greenlang"} | json | level="error" [5m]
                )
              )
            )
            /
            (
              sum by (app) (
                rate(
                  {namespace="greenlang"} [5m]
                )
              )
            )

        # -------------------------------------------------------------------
        # API request duration p99 from access logs over 5-minute window.
        # Parses duration_ms from structured access log JSON.
        # Used by: API performance dashboards.
        # -------------------------------------------------------------------
        - record: greenlang:api_request_duration_p99:5m
          expr: |
            quantile_over_time(0.99,
              {namespace="greenlang", app=~".*api.*"}
                | json
                | unwrap duration_ms [5m]
            ) by (app)

        # -------------------------------------------------------------------
        # API request duration p95 from access logs over 5-minute window.
        # -------------------------------------------------------------------
        - record: greenlang:api_request_duration_p95:5m
          expr: |
            quantile_over_time(0.95,
              {namespace="greenlang", app=~".*api.*"}
                | json
                | unwrap duration_ms [5m]
            ) by (app)

        # -------------------------------------------------------------------
        # API 5xx error rate from access logs over 5-minute window.
        # Counts log lines where status_code >= 500.
        # Used by: API error dashboards, SLO burn rate.
        # -------------------------------------------------------------------
        - record: greenlang:api_5xx_rate:5m
          expr: |
            sum by (app) (
              rate(
                {namespace="greenlang", app=~".*api.*"}
                  | json
                  | status_code >= 500 [5m]
              )
            )

    # =========================================================================
    # Group: Compliance Recording Rules
    # Pre-computed compliance metrics at 5-minute intervals. These track
    # processing success rates and audit event volumes for regulatory services.
    # =========================================================================
    - name: greenlang-compliance-recording-rules
      interval: 5m
      rules:
        # -------------------------------------------------------------------
        # Compliance processing success rate per service over 15 minutes.
        # Computed as: (total - errors) / total for each compliance agent.
        # Used by: compliance SLA dashboards.
        # -------------------------------------------------------------------
        - record: greenlang:compliance_processing_success_rate:15m
          expr: |
            (
              sum by (app) (
                count_over_time(
                  {namespace="greenlang", app=~"csrd-agent|cbam-agent|eudr-agent|sb253-agent"} | json [15m]
                )
              )
              -
              sum by (app) (
                count_over_time(
                  {namespace="greenlang", app=~"csrd-agent|cbam-agent|eudr-agent|sb253-agent"} | json | level="error" [15m]
                )
              )
            )
            /
            sum by (app) (
              count_over_time(
                {namespace="greenlang", app=~"csrd-agent|cbam-agent|eudr-agent|sb253-agent"} | json [15m]
              )
            )

        # -------------------------------------------------------------------
        # Audit events per tenant per hour.
        # Counts log entries containing "audit" from compliance services,
        # grouped by tenant_id. Used for regulatory audit trail completeness.
        # -------------------------------------------------------------------
        - record: greenlang:audit_events_total:1h
          expr: |
            sum by (app, tenant_id) (
              count_over_time(
                {namespace="greenlang", app=~"csrd-agent|cbam-agent|eudr-agent|sb253-agent"}
                  |= "audit"
                  | json [1h]
              )
            )
