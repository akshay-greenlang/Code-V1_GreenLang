# GreenLang Artifact Storage Architecture Guide

## Document Information

| Field | Value |
|-------|-------|
| Version | 1.0 |
| Last Updated | 2026-02-03 |
| Owner | Platform Engineering |
| Classification | Internal |

---

## Table of Contents

1. [Overview](#overview)
2. [Storage Architecture](#storage-architecture)
3. [Bucket Topology](#bucket-topology)
4. [Data Flow Diagrams](#data-flow-diagrams)
5. [Multi-Tier Storage Strategy](#multi-tier-storage-strategy)
6. [Data Lake Zones](#data-lake-zones)
7. [Integration Patterns](#integration-patterns)
8. [Performance Considerations](#performance-considerations)
9. [Cost Optimization Strategies](#cost-optimization-strategies)
10. [Security Architecture](#security-architecture)

---

## Overview

### Purpose

GreenLang's artifact storage infrastructure provides a scalable, secure, and cost-effective solution for storing all data artifacts generated by GreenLang applications. This includes calculation results, reports, ML models, emission factor databases, audit trails, and regulatory submission packages.

### Scope

This document covers:

- Amazon S3 bucket architecture and topology
- Data flow patterns for uploads, downloads, and archival
- Multi-tier storage strategy using S3 storage classes
- Data Lake zone architecture
- Integration patterns with GreenLang applications
- Performance and cost optimization strategies

### Key Design Principles

1. **Security First**: All data encrypted at rest and in transit
2. **Cost Optimization**: Intelligent tiering and lifecycle policies
3. **High Availability**: Cross-region replication for critical data
4. **Compliance Ready**: Audit trails and retention policies
5. **Developer Friendly**: Simple SDKs and consistent APIs

---

## Storage Architecture

### High-Level Architecture Diagram

```
                                    GreenLang Artifact Storage Architecture
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|   +-------------------+     +-------------------+     +-------------------+                        |
|   |  CBAM Agent       |     |  CSRD Agent       |     |  SF6 Agent        |                        |
|   |  Application      |     |  Application      |     |  Application      |                        |
|   +--------+----------+     +--------+----------+     +--------+----------+                        |
|            |                         |                         |                                   |
|            v                         v                         v                                   |
|   +-----------------------------------------------------------------------------------+            |
|   |                        API Gateway / Application Load Balancer                     |           |
|   +-----------------------------------------------------------------------------------+            |
|            |                         |                         |                                   |
|            v                         v                         v                                   |
|   +-----------------------------------------------------------------------------------+            |
|   |                           GreenLang Storage Service                                |           |
|   |   +-------------+   +-------------+   +-------------+   +-------------+           |           |
|   |   | Upload Svc  |   | Download Svc|   | Archive Svc |   | Presign Svc |           |           |
|   |   +-------------+   +-------------+   +-------------+   +-------------+           |           |
|   +-----------------------------------------------------------------------------------+            |
|            |                         |                         |                                   |
|            v                         v                         v                                   |
|   +-----------------------------------------------------------------------------------+            |
|   |                              Amazon S3                                             |           |
|   |   +---------------+   +---------------+   +---------------+   +---------------+   |           |
|   |   | Landing Zone  |   | Bronze Zone   |   | Silver Zone   |   | Gold Zone     |   |           |
|   |   | (Raw Uploads) |   | (Validated)   |   | (Processed)   |   | (Analytics)   |   |           |
|   |   +---------------+   +---------------+   +---------------+   +---------------+   |           |
|   |                                                                                    |           |
|   |   +---------------+   +---------------+   +---------------+   +---------------+   |           |
|   |   | ML Models     |   | Reports       |   | Audit Logs    |   | Archive       |   |           |
|   |   +---------------+   +---------------+   +---------------+   +---------------+   |           |
|   +-----------------------------------------------------------------------------------+            |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Component Overview

#### Storage Service Layer

The GreenLang Storage Service provides a unified interface for all storage operations:

| Component | Purpose | Technology |
|-----------|---------|------------|
| Upload Service | Handles file uploads with validation | FastAPI + aioboto3 |
| Download Service | Manages file downloads and streaming | FastAPI + aioboto3 |
| Archive Service | Handles data archival and retrieval | AWS Step Functions |
| Presign Service | Generates presigned URLs | Lambda + boto3 |

#### Storage Backend

Amazon S3 serves as the primary storage backend with the following characteristics:

- **Durability**: 99.999999999% (11 9's)
- **Availability**: 99.99% (Standard class)
- **Scalability**: Unlimited storage capacity
- **Performance**: Up to 5,500 GET/s and 3,500 PUT/s per prefix

---

## Bucket Topology

### Bucket Naming Convention

All buckets follow the pattern:

```
greenlang-{environment}-{region}-{purpose}-{classification}
```

Where:
- `environment`: dev, staging, prod
- `region`: AWS region code (us-east-1, eu-west-1)
- `purpose`: functional purpose (data-lake, reports, models)
- `classification`: data classification (public, internal, confidential)

### Production Bucket Topology

```
                              GreenLang Production Bucket Topology
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Primary Region (eu-west-1)                        DR Region (eu-central-1)                        |
|  +------------------------------------+            +------------------------------------+           |
|  |                                    |            |                                    |           |
|  |  greenlang-prod-eu-west-1-         |   CRR     |  greenlang-prod-eu-central-1-      |           |
|  |  data-lake-confidential            |---------->|  data-lake-confidential-replica     |           |
|  |                                    |            |                                    |           |
|  +------------------------------------+            +------------------------------------+           |
|                                                                                                    |
|  +------------------------------------+            +------------------------------------+           |
|  |                                    |   CRR     |                                    |           |
|  |  greenlang-prod-eu-west-1-         |---------->|  greenlang-prod-eu-central-1-      |           |
|  |  reports-confidential              |            |  reports-confidential-replica      |           |
|  |                                    |            |                                    |           |
|  +------------------------------------+            +------------------------------------+           |
|                                                                                                    |
|  +------------------------------------+            +------------------------------------+           |
|  |                                    |   CRR     |                                    |           |
|  |  greenlang-prod-eu-west-1-         |---------->|  greenlang-prod-eu-central-1-      |           |
|  |  models-internal                   |            |  models-internal-replica           |           |
|  |                                    |            |                                    |           |
|  +------------------------------------+            +------------------------------------+           |
|                                                                                                    |
|  +------------------------------------+                                                            |
|  |                                    |                                                            |
|  |  greenlang-prod-eu-west-1-         |  (No replication - logs only)                             |
|  |  audit-logs-confidential           |                                                            |
|  |                                    |                                                            |
|  +------------------------------------+                                                            |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Bucket Inventory

| Bucket Name | Purpose | Storage Class | Replication | Retention |
|-------------|---------|---------------|-------------|-----------|
| greenlang-prod-eu-west-1-data-lake-confidential | Data Lake storage | Intelligent Tiering | Yes | 7 years |
| greenlang-prod-eu-west-1-reports-confidential | Generated reports | Standard | Yes | 10 years |
| greenlang-prod-eu-west-1-models-internal | ML models | Standard | Yes | 2 years |
| greenlang-prod-eu-west-1-audit-logs-confidential | Audit trails | Glacier IR | No | 10 years |
| greenlang-prod-eu-west-1-temp-internal | Temporary uploads | Standard | No | 24 hours |
| greenlang-prod-eu-west-1-cache-internal | Emission factor cache | Standard-IA | No | 30 days |

---

## Data Flow Diagrams

### Upload Flow

```
                                    Data Upload Flow
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Client                  API Gateway           Storage Service         S3                          |
|    |                         |                      |                   |                          |
|    |  1. Request upload URL  |                      |                   |                          |
|    |------------------------>|                      |                   |                          |
|    |                         |  2. Generate presign |                   |                          |
|    |                         |--------------------->|                   |                          |
|    |                         |                      |  3. Create presigned URL                     |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |<---------------------|                   |                          |
|    |<------------------------|                      |                   |                          |
|    |                         |                      |                   |                          |
|    |  4. Upload file directly to S3               |                   |                          |
|    |------------------------------------------------------------->|                              |
|    |<-------------------------------------------------------------|                              |
|    |                         |                      |                   |                          |
|    |  5. Confirm upload      |                      |                   |                          |
|    |------------------------>|                      |                   |                          |
|    |                         |  6. Validate object  |                   |                          |
|    |                         |--------------------->|                   |                          |
|    |                         |                      |  7. Check object  |                          |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |                      |  8. Trigger processing                       |
|    |                         |                      |------------------>|  S3 Event               |
|    |                         |<---------------------|                   |                          |
|    |<------------------------|                      |                   |                          |
|    |                         |                      |                   |                          |
+--------------------------------------------------------------------------------------------------+
```

### Download Flow

```
                                    Data Download Flow
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  Client                  API Gateway           Storage Service         S3                          |
|    |                         |                      |                   |                          |
|    |  1. Request download    |                      |                   |                          |
|    |------------------------>|                      |                   |                          |
|    |                         |  2. Check permissions|                   |                          |
|    |                         |--------------------->|                   |                          |
|    |                         |                      |  3. Verify access |                          |
|    |                         |                      |------------------>|  IAM/Policy             |
|    |                         |                      |<------------------|                          |
|    |                         |                      |                   |                          |
|    |                         |                      |  4. Check storage class                      |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |                      |                   |                          |
|    |                         |      [If Glacier]    |  5. Initiate restore                         |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |                      |                   |                          |
|    |                         |      [If Standard]   |  6. Generate presigned URL                   |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |<---------------------|                   |                          |
|    |<------------------------|                      |                   |                          |
|    |                         |                      |                   |                          |
|    |  7. Download from S3 directly                 |                   |                          |
|    |------------------------------------------------------------->|                              |
|    |<-------------------------------------------------------------|                              |
|    |                         |                      |                   |                          |
+--------------------------------------------------------------------------------------------------+
```

### Archive Flow

```
                                    Data Archive Flow
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  S3 Event              Step Functions          Storage Service         S3                          |
|    |                         |                      |                   |                          |
|    |  1. Object lifecycle    |                      |                   |                          |
|    |     trigger (90 days)   |                      |                   |                          |
|    |------------------------>|                      |                   |                          |
|    |                         |  2. Check archive    |                   |                          |
|    |                         |     eligibility      |                   |                          |
|    |                         |--------------------->|                   |                          |
|    |                         |                      |  3. Verify no     |                          |
|    |                         |                      |     active refs   |                          |
|    |                         |                      |------------------>|  DynamoDB               |
|    |                         |                      |<------------------|                          |
|    |                         |<---------------------|                   |                          |
|    |                         |                      |                   |                          |
|    |                         |  4. Create archive   |                   |                          |
|    |                         |     manifest         |                   |                          |
|    |                         |--------------------->|                   |                          |
|    |                         |                      |  5. Copy to       |                          |
|    |                         |                      |     Glacier       |                          |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |                      |  6. Update        |                          |
|    |                         |                      |     metadata      |                          |
|    |                         |                      |------------------>|  DynamoDB               |
|    |                         |                      |<------------------|                          |
|    |                         |<---------------------|                   |                          |
|    |                         |  7. Delete original  |                   |                          |
|    |                         |     (optional)       |                   |                          |
|    |                         |--------------------->|                   |                          |
|    |                         |                      |------------------>|                          |
|    |                         |                      |<------------------|                          |
|    |                         |<---------------------|                   |                          |
|    |<------------------------|                      |                   |                          |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

---

## Multi-Tier Storage Strategy

### Storage Class Selection

GreenLang uses multiple S3 storage classes to optimize cost while maintaining performance:

```
                              Storage Class Decision Tree
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|                                    [Object Created]                                                |
|                                          |                                                         |
|                                          v                                                         |
|                               +---------------------+                                              |
|                               | Access Pattern?     |                                              |
|                               +---------------------+                                              |
|                                    |           |                                                   |
|                         Frequent   |           |  Infrequent                                       |
|                                    v           v                                                   |
|                    +---------------+           +---------------+                                   |
|                    | S3 Standard   |           | Size > 128KB? |                                   |
|                    +---------------+           +---------------+                                   |
|                                                    |       |                                       |
|                                             Yes    |       |  No                                   |
|                                                    v       v                                       |
|                                     +---------------+   +---------------+                          |
|                                     | S3 Standard-IA|   | S3 Standard   |                          |
|                                     +---------------+   +---------------+                          |
|                                          |                                                         |
|                                          v                                                         |
|                               +---------------------+                                              |
|                               | After 90 days       |                                              |
|                               | Still accessed?     |                                              |
|                               +---------------------+                                              |
|                                    |           |                                                   |
|                              Yes   |           |  No                                               |
|                                    v           v                                                   |
|                    +---------------+           +-------------------+                               |
|                    | Keep in IA    |           | Glacier Instant   |                               |
|                    +---------------+           | Retrieval         |                               |
|                                                +-------------------+                               |
|                                                         |                                          |
|                                                         v                                          |
|                                              +---------------------+                               |
|                                              | After 365 days      |                               |
|                                              | Compliance required?|                               |
|                                              +---------------------+                               |
|                                                   |           |                                    |
|                                             Yes   |           |  No                                |
|                                                   v           v                                    |
|                                   +---------------+           +---------------+                    |
|                                   | Glacier Deep  |           | Delete        |                    |
|                                   | Archive       |           +---------------+                    |
|                                   +---------------+                                                |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Storage Tier Specifications

| Tier | Storage Class | Use Case | Min Duration | Retrieval Time | Cost (per GB/month) |
|------|--------------|----------|--------------|----------------|---------------------|
| Hot | S3 Standard | Active data | None | Milliseconds | $0.023 |
| Warm | S3 Standard-IA | Infrequent access | 30 days | Milliseconds | $0.0125 |
| Cool | Glacier Instant Retrieval | Archive with quick access | 90 days | Milliseconds | $0.004 |
| Cold | Glacier Flexible Retrieval | Compliance archive | 90 days | 1-12 hours | $0.0036 |
| Frozen | Glacier Deep Archive | Long-term archive | 180 days | 12-48 hours | $0.00099 |

### Intelligent Tiering Configuration

For Data Lake buckets, Intelligent Tiering automatically optimizes storage costs:

```yaml
intelligent_tiering_configuration:
  name: "data-lake-tiering"
  status: "Enabled"
  tiering:
    - access_tier: ARCHIVE_ACCESS
      days: 90
    - access_tier: DEEP_ARCHIVE_ACCESS
      days: 180
  filter:
    prefix: "silver/"
    tags:
      - key: "tiering-enabled"
        value: "true"
```

---

## Data Lake Zones

### Zone Architecture

```
                              Data Lake Zone Architecture
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  +--------------------------------------------------------------------------------+               |
|  |                              Data Lake Bucket                                   |               |
|  |                                                                                 |               |
|  |  +---------------------------+    +---------------------------+                 |               |
|  |  |      Landing Zone         |    |       Bronze Zone         |                 |               |
|  |  |  /landing/                |    |  /bronze/                 |                 |               |
|  |  |                           |    |                           |                 |               |
|  |  |  - Raw uploads            |--->|  - Schema validated       |                 |               |
|  |  |  - Unvalidated data       |    |  - Standardized format    |                 |               |
|  |  |  - Temporary storage      |    |  - Partitioned by date    |                 |               |
|  |  |  - 24hr retention         |    |  - Original fidelity      |                 |               |
|  |  |                           |    |                           |                 |               |
|  |  +---------------------------+    +---------------------------+                 |               |
|  |              |                                |                                  |               |
|  |              v                                v                                  |               |
|  |  +---------------------------+    +---------------------------+                 |               |
|  |  |       Silver Zone         |    |        Gold Zone          |                 |               |
|  |  |  /silver/                 |    |  /gold/                   |                 |               |
|  |  |                           |    |                           |                 |               |
|  |  |  - Cleaned data           |--->|  - Business aggregations  |                 |               |
|  |  |  - Deduped records        |    |  - Analytics ready        |                 |               |
|  |  |  - Enriched with metadata |    |  - Precomputed metrics    |                 |               |
|  |  |  - Parquet format         |    |  - Dashboard optimized    |                 |               |
|  |  |                           |    |                           |                 |               |
|  |  +---------------------------+    +---------------------------+                 |               |
|  |                                                                                 |               |
|  +--------------------------------------------------------------------------------+               |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Zone Specifications

#### Landing Zone

**Purpose**: Temporary staging area for raw uploads

**Characteristics**:
- Prefix: `/landing/{tenant_id}/{upload_id}/`
- Format: Original format (CSV, Excel, JSON, XML)
- Retention: 24 hours
- Access: Write by upload service, read by validation service
- Encryption: SSE-S3

**Example Path**:
```
s3://greenlang-prod-eu-west-1-data-lake-confidential/landing/tenant-123/upload-abc/shipments.csv
```

#### Bronze Zone

**Purpose**: Validated raw data with standardized schema

**Characteristics**:
- Prefix: `/bronze/{application}/{year}/{month}/{day}/`
- Format: Parquet (original fidelity)
- Retention: 7 years
- Access: Read by transformation services
- Encryption: SSE-KMS (CMK)
- Partitioning: By date and tenant

**Example Path**:
```
s3://greenlang-prod-eu-west-1-data-lake-confidential/bronze/cbam/2026/02/03/tenant-123/shipments.parquet
```

#### Silver Zone

**Purpose**: Cleaned, enriched, and deduplicated data

**Characteristics**:
- Prefix: `/silver/{application}/{domain}/`
- Format: Delta Lake (Parquet + transaction log)
- Retention: 7 years
- Access: Read by analytics services
- Encryption: SSE-KMS (CMK)
- Features: ACID transactions, time travel

**Example Path**:
```
s3://greenlang-prod-eu-west-1-data-lake-confidential/silver/cbam/emissions/
```

#### Gold Zone

**Purpose**: Business-ready aggregations and analytics

**Characteristics**:
- Prefix: `/gold/{domain}/{metric}/`
- Format: Delta Lake or Parquet
- Retention: 7 years
- Access: Read by dashboards and APIs
- Encryption: SSE-KMS (CMK)
- Features: Precomputed metrics, materialized views

**Example Path**:
```
s3://greenlang-prod-eu-west-1-data-lake-confidential/gold/sustainability/emissions_by_scope/
```

---

## Integration Patterns

### Pattern 1: Direct Upload with Presigned URL

Best for: Large files, client-side uploads

```
Client -> API -> Presign Service -> S3 (presigned URL) -> Client -> S3 (direct upload)
```

**Implementation**:
```python
# Server-side: Generate presigned URL
presigned_url = s3_client.generate_presigned_url(
    'put_object',
    Params={
        'Bucket': bucket,
        'Key': key,
        'ContentType': content_type,
        'Metadata': {'tenant-id': tenant_id}
    },
    ExpiresIn=3600
)

# Client-side: Upload directly to S3
response = requests.put(presigned_url, data=file_data)
```

### Pattern 2: Server-Side Upload

Best for: Small files, data transformation required

```
Client -> API -> Storage Service -> S3
```

**Implementation**:
```python
# Server-side upload with transformation
async def upload_with_transform(file_data, transform_fn):
    transformed = await transform_fn(file_data)
    await s3_client.put_object(
        Bucket=bucket,
        Key=key,
        Body=transformed,
        Metadata={'transformed': 'true'}
    )
```

### Pattern 3: Event-Driven Processing

Best for: Asynchronous processing pipelines

```
S3 Event -> EventBridge -> Lambda/Step Functions -> S3
```

**Event Configuration**:
```json
{
  "source": ["aws.s3"],
  "detail-type": ["Object Created"],
  "detail": {
    "bucket": {"name": ["greenlang-prod-eu-west-1-data-lake-confidential"]},
    "object": {"key": [{"prefix": "landing/"}]}
  }
}
```

### Pattern 4: Cross-Application Data Sharing

Best for: Sharing data between GreenLang applications

```
App A -> S3 (shared prefix) -> App B (read access)
```

**Bucket Policy**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:role/cbam-service-role"},
      "Action": ["s3:GetObject"],
      "Resource": "arn:aws:s3:::greenlang-prod-eu-west-1-data-lake-confidential/shared/emission-factors/*"
    }
  ]
}
```

---

## Performance Considerations

### Request Rate Optimization

S3 supports up to 3,500 PUT/s and 5,500 GET/s per prefix. For high-throughput workloads:

**Use Prefix Partitioning**:
```
# Instead of:
s3://bucket/data/file1.parquet
s3://bucket/data/file2.parquet

# Use:
s3://bucket/data/a1/file1.parquet
s3://bucket/data/b2/file2.parquet
```

**Implementation**:
```python
import hashlib

def generate_distributed_key(base_key: str) -> str:
    """Generate key with hash prefix for even distribution."""
    hash_prefix = hashlib.md5(base_key.encode()).hexdigest()[:2]
    return f"{hash_prefix}/{base_key}"
```

### Transfer Acceleration

Enable S3 Transfer Acceleration for uploads from distant regions:

```python
# Enable Transfer Acceleration
s3_client = boto3.client(
    's3',
    config=Config(s3={'use_accelerate_endpoint': True})
)
```

### Multipart Upload Thresholds

| File Size | Strategy |
|-----------|----------|
| < 5 MB | Single PUT |
| 5 MB - 100 MB | Multipart (5 MB parts) |
| 100 MB - 1 GB | Multipart (10 MB parts) |
| > 1 GB | Multipart (100 MB parts) with parallel uploads |

### Caching Strategy

For frequently accessed data (emission factors, reference data):

```
CloudFront -> S3 (cache-control headers)
```

**Cache Headers**:
```python
s3_client.put_object(
    Bucket=bucket,
    Key=key,
    Body=data,
    CacheControl='max-age=86400'  # 24 hours
)
```

---

## Cost Optimization Strategies

### Lifecycle Policies

```json
{
  "Rules": [
    {
      "ID": "landing-cleanup",
      "Filter": {"Prefix": "landing/"},
      "Status": "Enabled",
      "Expiration": {"Days": 1}
    },
    {
      "ID": "bronze-to-ia",
      "Filter": {"Prefix": "bronze/"},
      "Status": "Enabled",
      "Transitions": [
        {"Days": 30, "StorageClass": "STANDARD_IA"},
        {"Days": 90, "StorageClass": "GLACIER_IR"},
        {"Days": 365, "StorageClass": "DEEP_ARCHIVE"}
      ]
    },
    {
      "ID": "delete-incomplete-uploads",
      "Status": "Enabled",
      "AbortIncompleteMultipartUpload": {"DaysAfterInitiation": 7}
    }
  ]
}
```

### Cost Allocation Tags

All buckets must have the following tags for cost allocation:

| Tag Key | Description | Example Values |
|---------|-------------|----------------|
| greenlang:application | Application owner | cbam, csrd, sf6 |
| greenlang:environment | Environment | dev, staging, prod |
| greenlang:cost-center | Finance cost center | platform-123 |
| greenlang:data-classification | Data classification | public, internal, confidential |

### Request Cost Reduction

- Use S3 Select for querying within objects
- Implement client-side filtering before upload
- Batch small files into larger archives
- Use range requests for partial reads

---

## Security Architecture

### Encryption

**At Rest**:
- Default: SSE-S3 (AES-256)
- Confidential data: SSE-KMS with CMK
- Bucket key enabled to reduce KMS costs

**In Transit**:
- TLS 1.2+ required
- Bucket policy enforces HTTPS

### Access Control

**IAM Policies**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::greenlang-prod-*/${aws:PrincipalTag/tenant-id}/*",
      "Condition": {
        "StringEquals": {
          "s3:ExistingObjectTag/tenant-id": "${aws:PrincipalTag/tenant-id}"
        }
      }
    }
  ]
}
```

**Bucket Policy**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::greenlang-prod-*",
        "arn:aws:s3:::greenlang-prod-*/*"
      ],
      "Condition": {
        "Bool": {"aws:SecureTransport": "false"}
      }
    }
  ]
}
```

### Audit Logging

All S3 access is logged to the audit bucket:

```
Source Bucket -> Server Access Logs -> Audit Bucket -> Athena (analysis)
```

---

## Appendix

### Reference Architecture Diagram

```
+--------------------------------------------------------------------------------------------------+
|                                 GreenLang Complete Storage Architecture                           |
+--------------------------------------------------------------------------------------------------+
|                                                                                                    |
|  External                    GreenLang Platform                   AWS Services                    |
|  +--------+                  +------------------+                 +------------------+            |
|  |        |                  |                  |                 |                  |            |
|  | Users  |----------------->| API Gateway      |---------------->| S3               |            |
|  |        |                  |                  |                 |                  |            |
|  +--------+                  +------------------+                 +------------------+            |
|                                      |                                    |                       |
|  +--------+                  +------------------+                 +------------------+            |
|  |        |                  |                  |                 |                  |            |
|  | ERPs   |----------------->| Integration Hub  |---------------->| Lambda           |            |
|  |        |                  |                  |                 |                  |            |
|  +--------+                  +------------------+                 +------------------+            |
|                                      |                                    |                       |
|  +--------+                  +------------------+                 +------------------+            |
|  |        |                  |                  |                 |                  |            |
|  | APIs   |----------------->| Agent Services   |---------------->| Step Functions   |            |
|  |        |                  |                  |                 |                  |            |
|  +--------+                  +------------------+                 +------------------+            |
|                                      |                                    |                       |
|                              +------------------+                 +------------------+            |
|                              |                  |                 |                  |            |
|                              | Storage Service  |---------------->| EventBridge      |            |
|                              |                  |                 |                  |            |
|                              +------------------+                 +------------------+            |
|                                                                                                    |
+--------------------------------------------------------------------------------------------------+
```

### Glossary

| Term | Definition |
|------|------------|
| CRR | Cross-Region Replication |
| CMK | Customer Managed Key |
| IAM | Identity and Access Management |
| IRSA | IAM Roles for Service Accounts |
| SSE | Server-Side Encryption |
| KMS | Key Management Service |

### Related Documents

- [Developer Integration Guide](developer-guide.md)
- [Operations Runbook](operations-runbook.md)
- [Disaster Recovery Plan](disaster-recovery.md)
- [Cost Optimization Guide](cost-optimization.md)
- [Compliance Guide](compliance-guide.md)
- [Access Procedures](access-procedures.md)
- [Naming Conventions](naming-conventions.md)

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-02-03 | Platform Engineering | Initial release |
