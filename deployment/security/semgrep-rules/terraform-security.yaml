# Terraform Security Semgrep Rules
#
# IaC security rules for GreenLang Terraform configurations
# Covers: AWS security, encryption, IAM, networking, logging
#
# Author: GreenLang Security Team
# Version: 1.0.0
# Compliance: SOC 2 CC6.1, ISO 27001 A.13.1.1

rules:
  # ==========================================================================
  # S3 BUCKET SECURITY
  # ==========================================================================

  - id: terraform-s3-bucket-public-acl
    patterns:
      - pattern-either:
          - pattern: |
              resource "aws_s3_bucket_acl" $NAME {
                ...
                acl = "public-read"
                ...
              }
          - pattern: |
              resource "aws_s3_bucket_acl" $NAME {
                ...
                acl = "public-read-write"
                ...
              }
    message: |
      S3 bucket has public ACL. GreenLang requires all S3 buckets to be private.
      Use aws_s3_bucket_public_access_block to enforce private access.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284"
      compliance: ["SOC2-CC6.1", "ISO27001-A.9.1.1"]

  - id: terraform-s3-missing-encryption
    patterns:
      - pattern: |
          resource "aws_s3_bucket" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_s3_bucket_server_side_encryption_configuration" $ANY {
            bucket = $NAME.id
            ...
          }
    message: |
      S3 bucket missing server-side encryption configuration. Enable SSE-S3 or
      SSE-KMS encryption for all buckets containing GreenLang data.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-311"
      compliance: ["SOC2-CC6.1"]

  - id: terraform-s3-missing-versioning
    patterns:
      - pattern: |
          resource "aws_s3_bucket" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_s3_bucket_versioning" $ANY {
            bucket = $NAME.id
            versioning_configuration {
              status = "Enabled"
            }
          }
    message: |
      S3 bucket missing versioning. Enable versioning for data protection
      and recovery capabilities.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-693"

  - id: terraform-s3-missing-logging
    patterns:
      - pattern: |
          resource "aws_s3_bucket" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_s3_bucket_logging" $ANY {
            bucket = $NAME.id
            ...
          }
    message: |
      S3 bucket missing access logging. Enable logging for audit trail
      and compliance requirements.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      compliance: ["SOC2-CC7.2"]

  # ==========================================================================
  # RDS SECURITY
  # ==========================================================================

  - id: terraform-rds-public-access
    patterns:
      - pattern: |
          resource "aws_db_instance" $NAME {
            ...
            publicly_accessible = true
            ...
          }
    message: |
      RDS instance publicly accessible. GreenLang databases must be private
      and accessible only through VPC networking.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284"

  - id: terraform-rds-missing-encryption
    patterns:
      - pattern: |
          resource "aws_db_instance" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_db_instance" $NAME {
            ...
            storage_encrypted = true
            ...
          }
    message: |
      RDS instance missing storage encryption. Enable encryption at rest
      for all database instances.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-311"

  - id: terraform-rds-missing-backup
    patterns:
      - pattern: |
          resource "aws_db_instance" $NAME {
            ...
            backup_retention_period = 0
            ...
          }
    message: |
      RDS backup disabled. Enable automated backups with retention period
      of at least 7 days for production databases.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-693"

  - id: terraform-rds-missing-multi-az
    patterns:
      - pattern: |
          resource "aws_db_instance" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_db_instance" $NAME {
            ...
            multi_az = true
            ...
          }
    message: |
      RDS instance not configured for Multi-AZ. Enable Multi-AZ for production
      databases to ensure high availability.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: reliability

  # ==========================================================================
  # IAM SECURITY
  # ==========================================================================

  - id: terraform-iam-wildcard-action
    patterns:
      - pattern-regex: '"Action"\s*:\s*"\*"'
      - pattern-regex: 'actions\s*=\s*\[\s*"\*"\s*\]'
    message: |
      IAM policy with wildcard (*) action. Use least-privilege principle
      and specify only required actions.
    languages: [hcl, json]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250"
      compliance: ["SOC2-CC6.1"]

  - id: terraform-iam-wildcard-resource
    patterns:
      - pattern-regex: '"Resource"\s*:\s*"\*"'
      - pattern-regex: 'resources\s*=\s*\[\s*"\*"\s*\]'
    message: |
      IAM policy with wildcard (*) resource. Scope permissions to specific
      resources using ARNs.
    languages: [hcl, json]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-250"

  - id: terraform-iam-admin-policy
    patterns:
      - pattern-either:
          - pattern-regex: 'arn:aws:iam::aws:policy/AdministratorAccess'
          - pattern-regex: '"Effect"\s*:\s*"Allow"[^}]*"Action"\s*:\s*"\*"[^}]*"Resource"\s*:\s*"\*"'
    message: |
      IAM entity has administrator access. Avoid full admin permissions;
      use specific policies with least-privilege access.
    languages: [hcl, json]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250"
      compliance: ["SOC2-CC6.1"]

  - id: terraform-iam-assume-role-any-principal
    patterns:
      - pattern: |
          assume_role_policy = $POLICY
      - pattern-regex: '"Principal"\s*:\s*"\*"'
    message: |
      IAM role allows any principal to assume it. Restrict the Principal
      to specific AWS accounts, services, or users.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284"

  # ==========================================================================
  # NETWORKING SECURITY
  # ==========================================================================

  - id: terraform-security-group-open-ingress
    patterns:
      - pattern: |
          resource "aws_security_group_rule" $NAME {
            ...
            type        = "ingress"
            cidr_blocks = ["0.0.0.0/0"]
            ...
          }
      - pattern-not: |
          resource "aws_security_group_rule" $NAME {
            ...
            type        = "ingress"
            cidr_blocks = ["0.0.0.0/0"]
            from_port   = 443
            to_port     = 443
            ...
          }
      - pattern-not: |
          resource "aws_security_group_rule" $NAME {
            ...
            type        = "ingress"
            cidr_blocks = ["0.0.0.0/0"]
            from_port   = 80
            to_port     = 80
            ...
          }
    message: |
      Security group allows unrestricted ingress. Limit ingress to specific
      CIDR blocks unless this is an intentional public-facing resource.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284"

  - id: terraform-security-group-ssh-open
    patterns:
      - pattern: |
          resource "aws_security_group_rule" $NAME {
            ...
            type        = "ingress"
            from_port   = 22
            to_port     = 22
            cidr_blocks = ["0.0.0.0/0"]
            ...
          }
    message: |
      SSH port open to the world. Restrict SSH access to specific IP ranges
      or use AWS Systems Manager Session Manager.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284"

  - id: terraform-security-group-rdp-open
    patterns:
      - pattern: |
          resource "aws_security_group_rule" $NAME {
            ...
            type        = "ingress"
            from_port   = 3389
            to_port     = 3389
            cidr_blocks = ["0.0.0.0/0"]
            ...
          }
    message: |
      RDP port open to the world. Restrict RDP access to specific IP ranges
      or use AWS Systems Manager Session Manager.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284"

  - id: terraform-vpc-flow-logs-missing
    patterns:
      - pattern: |
          resource "aws_vpc" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_flow_log" $ANY {
            vpc_id = $NAME.id
            ...
          }
    message: |
      VPC missing flow logs. Enable VPC flow logs for network traffic
      monitoring and security analysis.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      compliance: ["SOC2-CC7.2"]

  # ==========================================================================
  # ENCRYPTION AND SECRETS
  # ==========================================================================

  - id: terraform-hardcoded-secret
    patterns:
      - pattern-regex: '(password|secret|api_key|access_key)\s*=\s*"[^"$]+'
    message: |
      Hardcoded secret in Terraform. Use AWS Secrets Manager, SSM Parameter Store,
      or Terraform variables with sensitive = true.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798"
      owasp: "A07:2021"

  - id: terraform-kms-key-rotation-disabled
    patterns:
      - pattern: |
          resource "aws_kms_key" $NAME {
            ...
            enable_key_rotation = false
            ...
          }
    message: |
      KMS key rotation disabled. Enable automatic key rotation for
      compliance and security best practices.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-320"

  - id: terraform-ebs-unencrypted
    patterns:
      - pattern: |
          resource "aws_ebs_volume" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_ebs_volume" $NAME {
            ...
            encrypted = true
            ...
          }
    message: |
      EBS volume not encrypted. Enable encryption for all EBS volumes
      storing GreenLang data.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-311"

  # ==========================================================================
  # LOGGING AND MONITORING
  # ==========================================================================

  - id: terraform-cloudtrail-missing-encryption
    patterns:
      - pattern: |
          resource "aws_cloudtrail" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_cloudtrail" $NAME {
            ...
            kms_key_id = ...
            ...
          }
    message: |
      CloudTrail logs not encrypted with KMS. Enable KMS encryption for
      CloudTrail logs.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-311"

  - id: terraform-cloudtrail-missing-validation
    patterns:
      - pattern: |
          resource "aws_cloudtrail" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_cloudtrail" $NAME {
            ...
            enable_log_file_validation = true
            ...
          }
    message: |
      CloudTrail log file validation disabled. Enable validation to detect
      tampering with log files.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      compliance: ["SOC2-CC7.2"]

  - id: terraform-alb-access-logs-missing
    patterns:
      - pattern: |
          resource "aws_lb" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_lb" $NAME {
            ...
            access_logs {
              enabled = true
              ...
            }
            ...
          }
    message: |
      ALB access logs disabled. Enable access logs for compliance and
      security monitoring.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      compliance: ["SOC2-CC7.2"]

  # ==========================================================================
  # EKS SECURITY
  # ==========================================================================

  - id: terraform-eks-public-endpoint
    patterns:
      - pattern: |
          resource "aws_eks_cluster" $NAME {
            ...
            vpc_config {
              ...
              endpoint_public_access = true
              ...
            }
            ...
          }
    message: |
      EKS cluster has public endpoint access. Restrict to private endpoint
      or limit public access CIDR blocks.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284"

  - id: terraform-eks-secrets-encryption-missing
    patterns:
      - pattern: |
          resource "aws_eks_cluster" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_eks_cluster" $NAME {
            ...
            encryption_config {
              ...
            }
            ...
          }
    message: |
      EKS cluster missing secrets encryption. Enable envelope encryption
      for Kubernetes secrets using KMS.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-311"

  - id: terraform-eks-logging-disabled
    patterns:
      - pattern: |
          resource "aws_eks_cluster" $NAME {
            ...
          }
      - pattern-not: |
          resource "aws_eks_cluster" $NAME {
            ...
            enabled_cluster_log_types = [...]
            ...
          }
    message: |
      EKS cluster logging disabled. Enable control plane logging for
      security monitoring and troubleshooting.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      compliance: ["SOC2-CC7.2"]

  # ==========================================================================
  # LAMBDA SECURITY
  # ==========================================================================

  - id: terraform-lambda-public-access
    patterns:
      - pattern: |
          resource "aws_lambda_permission" $NAME {
            ...
            principal = "*"
            ...
          }
    message: |
      Lambda function allows invocation from any principal. Restrict
      to specific AWS services or accounts.
    languages: [hcl]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284"

  - id: terraform-lambda-env-secrets
    patterns:
      - pattern-regex: 'environment\s*\{[^}]*(PASSWORD|SECRET|API_KEY|TOKEN)[^}]*\}'
    message: |
      Lambda environment variable may contain secrets. Use AWS Secrets Manager
      or SSM Parameter Store for sensitive values.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-798"
