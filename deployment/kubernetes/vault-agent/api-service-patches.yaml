##############################################
# GreenLang API Service Vault Agent Patches
# SEC-006: Phase 4 - Vault Agent Injector Configuration
# Strategic merge patches for greenlang-api deployment
##############################################

---
# Strategic Merge Patch for greenlang-api Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: greenlang-api
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: greenlang
spec:
  template:
    metadata:
      annotations:
        # Enable Vault Agent injection
        vault.hashicorp.com/agent-inject: "true"

        # Vault role for authentication
        vault.hashicorp.com/role: "greenlang-api"

        # Agent configuration
        vault.hashicorp.com/agent-pre-populate-only: "false"
        vault.hashicorp.com/agent-init-first: "true"
        vault.hashicorp.com/agent-cache-enable: "true"
        vault.hashicorp.com/agent-cache-use-auto-auth-token: "true"

        # TLS configuration
        vault.hashicorp.com/tls-skip-verify: "false"
        vault.hashicorp.com/ca-cert: "/vault/tls/ca.crt"

        # Resource limits for agent sidecar
        vault.hashicorp.com/agent-limits-cpu: "100m"
        vault.hashicorp.com/agent-limits-mem: "128Mi"
        vault.hashicorp.com/agent-requests-cpu: "50m"
        vault.hashicorp.com/agent-requests-mem: "64Mi"

        # Security settings
        vault.hashicorp.com/agent-revoke-on-shutdown: "true"
        vault.hashicorp.com/agent-run-as-user: "100"
        vault.hashicorp.com/agent-run-as-group: "1000"

        # PostgreSQL Credentials (JSON format)
        vault.hashicorp.com/agent-inject-secret-database.json: "secret/data/greenlang/database/postgresql"
        vault.hashicorp.com/agent-inject-template-database.json: |
          {{- with secret "secret/data/greenlang/database/postgresql" -}}
          {
            "username": "{{ .Data.data.username }}",
            "password": "{{ .Data.data.password }}",
            "host": "{{ .Data.data.host }}",
            "port": {{ .Data.data.port }},
            "database": "{{ .Data.data.database }}",
            "sslmode": "{{ .Data.data.sslmode | default "require" }}"
          }
          {{- end -}}
        vault.hashicorp.com/agent-inject-perms-database.json: "0400"

        # Database URL (for connection string)
        vault.hashicorp.com/agent-inject-secret-database-url: "secret/data/greenlang/database/postgresql"
        vault.hashicorp.com/agent-inject-template-database-url: |
          {{- with secret "secret/data/greenlang/database/postgresql" -}}
          postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@{{ .Data.data.host }}:{{ .Data.data.port }}/{{ .Data.data.database }}?sslmode={{ .Data.data.sslmode | default "require" }}
          {{- end -}}
        vault.hashicorp.com/agent-inject-perms-database-url: "0400"

        # Redis Credentials (JSON format)
        vault.hashicorp.com/agent-inject-secret-redis.json: "secret/data/greenlang/database/redis"
        vault.hashicorp.com/agent-inject-template-redis.json: |
          {{- with secret "secret/data/greenlang/database/redis" -}}
          {
            "host": "{{ .Data.data.host }}",
            "port": {{ .Data.data.port }},
            "password": "{{ .Data.data.password }}",
            "database": {{ .Data.data.database | default 0 }},
            "ssl": {{ .Data.data.ssl | default true }}
          }
          {{- end -}}
        vault.hashicorp.com/agent-inject-perms-redis.json: "0400"

        # JWT Signing Keys
        vault.hashicorp.com/agent-inject-secret-jwt-private-key.pem: "secret/data/greenlang/auth/jwt-signing"
        vault.hashicorp.com/agent-inject-template-jwt-private-key.pem: |
          {{- with secret "secret/data/greenlang/auth/jwt-signing" -}}
          {{ .Data.data.private_key }}
          {{- end -}}
        vault.hashicorp.com/agent-inject-perms-jwt-private-key.pem: "0400"

        vault.hashicorp.com/agent-inject-secret-jwt-public-key.pem: "secret/data/greenlang/auth/jwt-signing"
        vault.hashicorp.com/agent-inject-template-jwt-public-key.pem: |
          {{- with secret "secret/data/greenlang/auth/jwt-signing" -}}
          {{ .Data.data.public_key }}
          {{- end -}}
        vault.hashicorp.com/agent-inject-perms-jwt-public-key.pem: "0444"

        # Internal API Keys
        vault.hashicorp.com/agent-inject-secret-api-keys.json: "secret/data/greenlang/api-keys/internal"
        vault.hashicorp.com/agent-inject-template-api-keys.json: |
          {{- with secret "secret/data/greenlang/api-keys/internal" -}}
          {
            "internal_api_key": "{{ .Data.data.internal_api_key }}",
            "webhook_secret": "{{ .Data.data.webhook_secret }}",
            "admin_api_key": "{{ .Data.data.admin_api_key }}"
          }
          {{- end -}}
        vault.hashicorp.com/agent-inject-perms-api-keys.json: "0400"

    spec:
      serviceAccountName: greenlang-api

      volumes:
        - name: vault-tls
          secret:
            secretName: vault-tls

      containers:
        - name: api
          env:
            - name: VAULT_SECRETS_PATH
              value: "/vault/secrets"
            - name: DATABASE_CREDENTIALS_FILE
              value: "/vault/secrets/database.json"
            - name: DATABASE_URL_FILE
              value: "/vault/secrets/database-url"
            - name: REDIS_CREDENTIALS_FILE
              value: "/vault/secrets/redis.json"
            - name: JWT_PRIVATE_KEY_FILE
              value: "/vault/secrets/jwt-private-key.pem"
            - name: JWT_PUBLIC_KEY_FILE
              value: "/vault/secrets/jwt-public-key.pem"
            - name: API_KEYS_FILE
              value: "/vault/secrets/api-keys.json"
          volumeMounts:
            - name: vault-tls
              mountPath: /vault/tls
              readOnly: true

---
# Service Account for greenlang-api (with Vault auth)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: greenlang-api
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: greenlang
  annotations:
    # IRSA annotation (backup for AWS auth)
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-api-role

---
# Kustomize Strategic Merge Patch
# Apply this patch using: kustomize build with patchesStrategicMerge
apiVersion: apps/v1
kind: Deployment
metadata:
  name: greenlang-api
  namespace: greenlang
spec:
  template:
    metadata:
      annotations:
        # This is a placeholder for Kustomize patching
        vault.hashicorp.com/agent-inject: "true"
