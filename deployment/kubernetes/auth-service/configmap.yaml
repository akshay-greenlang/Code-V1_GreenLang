# =============================================================================
# GreenLang Auth Service - ConfigMap
# =============================================================================
# Configuration for JWT settings, security policies, rate limiting, and
# account lockout parameters.
# PRD: SEC-001
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-service-config
  namespace: greenlang-auth
  labels:
    app.kubernetes.io/name: auth-service
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: greenlang
  annotations:
    description: "Auth Service configuration - JWT, security, rate limiting"
    prd: SEC-001
data:
  # Environment
  ENVIRONMENT: "production"

  # Logging
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"

  # Metrics
  METRICS_PORT: "9090"
  METRICS_PATH: "/metrics"

  # Tracing
  TRACING_ENABLED: "true"
  TRACING_SAMPLE_RATE: "0.1"
  OTEL_ENDPOINT: "http://otel-collector.monitoring.svc.cluster.local:4317"
  OTEL_SERVICE_NAME: "auth-service"

  # JWT Configuration
  JWT_ISSUER: "https://auth.greenlang.io"
  JWT_AUDIENCE: "https://api.greenlang.io"
  JWT_ALGORITHM: "RS256"
  ACCESS_TOKEN_TTL: "3600"
  REFRESH_TOKEN_TTL: "604800"

  # Security - Account lockout
  MAX_FAILED_ATTEMPTS: "5"
  LOCKOUT_DURATION: "900"

  # Security - Password policy
  PASSWORD_MIN_LENGTH: "12"
  PASSWORD_REQUIRE_UPPERCASE: "true"
  PASSWORD_REQUIRE_LOWERCASE: "true"
  PASSWORD_REQUIRE_DIGITS: "true"
  PASSWORD_REQUIRE_SPECIAL: "true"
  PASSWORD_MAX_AGE_DAYS: "90"

  # Rate limiting
  RATE_LIMIT_LOGIN: "10"
  RATE_LIMIT_LOGIN_WINDOW: "60"
  RATE_LIMIT_TOKEN_REFRESH: "30"
  RATE_LIMIT_TOKEN_REFRESH_WINDOW: "60"
  RATE_LIMIT_PASSWORD_RESET: "3"
  RATE_LIMIT_PASSWORD_RESET_WINDOW: "3600"

  # Token blacklist
  TOKEN_BLACKLIST_CLEANUP_INTERVAL: "21600"
  TOKEN_BLACKLIST_MAX_SIZE: "1000000"

  # Session management
  MAX_CONCURRENT_SESSIONS: "5"
  SESSION_IDLE_TIMEOUT: "1800"

  # MFA Configuration
  MFA_ENABLED: "true"
  MFA_TOTP_ISSUER: "GreenLang"
  MFA_TOTP_DIGITS: "6"
  MFA_TOTP_PERIOD: "30"

  # Auth service configuration file
  auth-config.yaml: |
    auth:
      version: "1.0.0"
      environment: production

      jwt:
        issuer: "https://auth.greenlang.io"
        audience: "https://api.greenlang.io"
        algorithm: RS256
        access_token_ttl_seconds: 3600
        refresh_token_ttl_seconds: 604800
        clock_skew_seconds: 30
        key_rotation_interval_days: 90

      security:
        max_failed_attempts: 5
        lockout_duration_seconds: 900
        password_min_length: 12
        bcrypt_rounds: 12
        brute_force_detection:
          enabled: true
          threshold: 20
          window_seconds: 300
          block_duration_seconds: 3600

      rate_limiting:
        login:
          requests: 10
          window_seconds: 60
        token_refresh:
          requests: 30
          window_seconds: 60
        password_reset:
          requests: 3
          window_seconds: 3600

      token_lifecycle:
        blacklist_cleanup_interval_seconds: 21600
        refresh_rotation: true
        family_revocation: true
        max_blacklist_size: 1000000

      session:
        max_concurrent: 5
        idle_timeout_seconds: 1800
        absolute_timeout_seconds: 86400
