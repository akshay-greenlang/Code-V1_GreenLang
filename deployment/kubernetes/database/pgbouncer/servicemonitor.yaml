# ServiceMonitor for PgBouncer Prometheus Monitoring
# Configures Prometheus to scrape PgBouncer exporter metrics
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: pgbouncer
  namespace: greenlang-database
  labels:
    app: pgbouncer
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: greenlang
    # Label for Prometheus Operator to discover this ServiceMonitor
    release: prometheus
    prometheus: greenlang
  annotations:
    description: "ServiceMonitor for PgBouncer connection pooler metrics"
spec:
  # Job label for Prometheus
  jobLabel: pgbouncer

  # Selector for the service to monitor
  selector:
    matchLabels:
      app: pgbouncer

  # Namespace selector
  namespaceSelector:
    matchNames:
      - greenlang-database

  # Endpoints to scrape
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      scheme: http

      # Metric relabeling to add custom labels
      metricRelabelings:
        # Add environment label
        - sourceLabels: [__name__]
          targetLabel: environment
          replacement: production

        # Drop high-cardinality metrics if needed
        # - sourceLabels: [__name__]
        #   regex: 'pgbouncer_.*_seconds_bucket'
        #   action: drop

      # Relabeling for discovery
      relabelings:
        # Add pod name as label
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod

        # Add node name as label
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node

        # Add namespace as label
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace

---
# PrometheusRule for PgBouncer alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: pgbouncer-alerts
  namespace: greenlang-database
  labels:
    app: pgbouncer
    app.kubernetes.io/name: pgbouncer
    prometheus: greenlang
    role: alert-rules
  annotations:
    description: "Alerting rules for PgBouncer connection pooler"
spec:
  groups:
    - name: pgbouncer.rules
      interval: 30s
      rules:
        # High client connection usage
        - alert: PgBouncerHighClientConnections
          expr: |
            (sum(pgbouncer_pools_client_active_connections) / sum(pgbouncer_config_max_client_conn)) * 100 > 80
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer client connections high"
            description: "PgBouncer client connections are at {{ $value | printf \"%.1f\" }}% of maximum capacity"
            runbook_url: "https://runbooks.greenlang.io/pgbouncer/high-connections"

        # Critical client connection usage
        - alert: PgBouncerCriticalClientConnections
          expr: |
            (sum(pgbouncer_pools_client_active_connections) / sum(pgbouncer_config_max_client_conn)) * 100 > 95
          for: 2m
          labels:
            severity: critical
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer client connections critical"
            description: "PgBouncer client connections are at {{ $value | printf \"%.1f\" }}% of maximum capacity - immediate action required"
            runbook_url: "https://runbooks.greenlang.io/pgbouncer/critical-connections"

        # High server connection usage
        - alert: PgBouncerHighServerConnections
          expr: |
            (sum(pgbouncer_pools_server_active_connections) / sum(pgbouncer_config_default_pool_size * pgbouncer_databases_database_pool_size)) * 100 > 80
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer server connections high"
            description: "PgBouncer server connections to PostgreSQL are at {{ $value | printf \"%.1f\" }}% of pool capacity"

        # Clients waiting for connections
        - alert: PgBouncerClientsWaiting
          expr: |
            sum(pgbouncer_pools_client_waiting_connections) > 10
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer has clients waiting for connections"
            description: "{{ $value }} clients are waiting for available connections from the pool"

        # Critical clients waiting
        - alert: PgBouncerCriticalClientsWaiting
          expr: |
            sum(pgbouncer_pools_client_waiting_connections) > 50
          for: 2m
          labels:
            severity: critical
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer has critical number of clients waiting"
            description: "{{ $value }} clients are waiting for connections - pool exhaustion imminent"

        # PgBouncer pod down
        - alert: PgBouncerPodDown
          expr: |
            up{job="pgbouncer"} == 0
          for: 1m
          labels:
            severity: critical
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer pod is down"
            description: "PgBouncer pod {{ $labels.pod }} is not responding"

        # Insufficient PgBouncer replicas
        - alert: PgBouncerInsufficientReplicas
          expr: |
            kube_deployment_status_replicas_available{deployment="pgbouncer", namespace="greenlang-database"} < 2
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "Insufficient PgBouncer replicas"
            description: "Only {{ $value }} PgBouncer replicas available, minimum is 2 for HA"

        # High query wait time
        - alert: PgBouncerHighQueryWaitTime
          expr: |
            avg(pgbouncer_stats_queries_duration_seconds{quantile="0.99"}) > 1
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer query wait time is high"
            description: "99th percentile query wait time is {{ $value | printf \"%.2f\" }} seconds"

        # Database pool errors
        - alert: PgBouncerPoolErrors
          expr: |
            rate(pgbouncer_stats_queries_pooled_total{state="error"}[5m]) > 0
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer experiencing pool errors"
            description: "PgBouncer is encountering errors when pooling queries"

        # High memory usage
        - alert: PgBouncerHighMemoryUsage
          expr: |
            (container_memory_working_set_bytes{container="pgbouncer", namespace="greenlang-database"} / container_spec_memory_limit_bytes{container="pgbouncer", namespace="greenlang-database"}) * 100 > 80
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer memory usage is high"
            description: "PgBouncer container memory usage is at {{ $value | printf \"%.1f\" }}%"

        # High CPU usage
        - alert: PgBouncerHighCPUUsage
          expr: |
            (rate(container_cpu_usage_seconds_total{container="pgbouncer", namespace="greenlang-database"}[5m]) / container_spec_cpu_quota{container="pgbouncer", namespace="greenlang-database"} * container_spec_cpu_period{container="pgbouncer", namespace="greenlang-database"}) * 100 > 80
          for: 5m
          labels:
            severity: warning
            service: pgbouncer
            team: platform
          annotations:
            summary: "PgBouncer CPU usage is high"
            description: "PgBouncer container CPU usage is at {{ $value | printf \"%.1f\" }}%"

    - name: pgbouncer.recording
      interval: 30s
      rules:
        # Recording rules for dashboards
        - record: pgbouncer:client_connections:total
          expr: sum(pgbouncer_pools_client_active_connections)

        - record: pgbouncer:server_connections:total
          expr: sum(pgbouncer_pools_server_active_connections)

        - record: pgbouncer:waiting_clients:total
          expr: sum(pgbouncer_pools_client_waiting_connections)

        - record: pgbouncer:connection_utilization:percent
          expr: |
            (sum(pgbouncer_pools_client_active_connections) / sum(pgbouncer_config_max_client_conn)) * 100

        - record: pgbouncer:queries_per_second:rate5m
          expr: sum(rate(pgbouncer_stats_queries_total[5m]))

        - record: pgbouncer:bytes_sent_per_second:rate5m
          expr: sum(rate(pgbouncer_stats_sent_bytes_total[5m]))

        - record: pgbouncer:bytes_received_per_second:rate5m
          expr: sum(rate(pgbouncer_stats_received_bytes_total[5m]))

---
# GrafanaDashboard for PgBouncer (optional - requires Grafana Operator)
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: pgbouncer-dashboard
  namespace: greenlang-database
  labels:
    app: pgbouncer
    grafana_dashboard: "1"
spec:
  resyncPeriod: 30s
  instanceSelector:
    matchLabels:
      dashboards: "greenlang"
  json: |
    {
      "title": "PgBouncer - GreenLang",
      "uid": "pgbouncer-greenlang",
      "tags": ["pgbouncer", "database", "greenlang"],
      "timezone": "browser",
      "refresh": "30s",
      "panels": [
        {
          "title": "Client Connections",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
          "targets": [
            {
              "expr": "pgbouncer:client_connections:total",
              "legendFormat": "Active Clients"
            }
          ]
        },
        {
          "title": "Server Connections",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
          "targets": [
            {
              "expr": "pgbouncer:server_connections:total",
              "legendFormat": "Active Servers"
            }
          ]
        },
        {
          "title": "Waiting Clients",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
          "targets": [
            {
              "expr": "pgbouncer:waiting_clients:total",
              "legendFormat": "Waiting"
            }
          ]
        },
        {
          "title": "Connection Utilization",
          "type": "gauge",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
          "targets": [
            {
              "expr": "pgbouncer:connection_utilization:percent",
              "legendFormat": "Utilization %"
            }
          ]
        },
        {
          "title": "Queries per Second",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
          "targets": [
            {
              "expr": "pgbouncer:queries_per_second:rate5m",
              "legendFormat": "QPS"
            }
          ]
        },
        {
          "title": "Network Traffic",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
          "targets": [
            {
              "expr": "pgbouncer:bytes_sent_per_second:rate5m",
              "legendFormat": "Sent"
            },
            {
              "expr": "pgbouncer:bytes_received_per_second:rate5m",
              "legendFormat": "Received"
            }
          ]
        }
      ]
    }
