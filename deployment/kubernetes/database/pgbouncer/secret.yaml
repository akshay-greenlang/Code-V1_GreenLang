# PgBouncer Secrets Configuration
# Uses External Secrets Operator for secure credential management
# DO NOT store actual credentials in this file - use External Secrets
---
# External Secret for PostgreSQL credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbouncer-secrets
  namespace: greenlang-database
  labels:
    app: pgbouncer
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: greenlang
  annotations:
    description: "External secret for PgBouncer PostgreSQL credentials"
spec:
  # Refresh interval for secret synchronization
  refreshInterval: 1h

  # Secret store reference (AWS Secrets Manager, HashiCorp Vault, etc.)
  secretStoreRef:
    name: greenlang-secret-store
    kind: ClusterSecretStore

  # Target Kubernetes secret configuration
  target:
    name: pgbouncer-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app: pgbouncer
      data:
        # PostgreSQL host
        postgresql-host: "{{ .postgresql_host }}"

        # PostgreSQL admin credentials
        postgresql-username: "{{ .postgresql_username }}"
        postgresql-password: "{{ .postgresql_password }}"

        # PgBouncer auth user (for auth_query)
        pgbouncer-auth-user: "{{ .pgbouncer_auth_user }}"

        # Exporter database URL for Prometheus exporter
        exporter-database-url: "postgresql://{{ .pgbouncer_stats_user }}:{{ .pgbouncer_stats_password }}@localhost:5432/pgbouncer?sslmode=disable"

        # Application connection string
        connection-string: "postgresql://{{ .app_username }}:{{ .app_password }}@pgbouncer.greenlang-database:5432/greenlang"

  # Data mapping from external secret store
  data:
    # PostgreSQL host
    - secretKey: postgresql_host
      remoteRef:
        key: greenlang/database/postgresql
        property: host

    # PostgreSQL admin username
    - secretKey: postgresql_username
      remoteRef:
        key: greenlang/database/postgresql
        property: admin_username

    # PostgreSQL admin password
    - secretKey: postgresql_password
      remoteRef:
        key: greenlang/database/postgresql
        property: admin_password

    # PgBouncer auth user
    - secretKey: pgbouncer_auth_user
      remoteRef:
        key: greenlang/database/pgbouncer
        property: auth_user

    # PgBouncer stats user
    - secretKey: pgbouncer_stats_user
      remoteRef:
        key: greenlang/database/pgbouncer
        property: stats_user

    # PgBouncer stats password
    - secretKey: pgbouncer_stats_password
      remoteRef:
        key: greenlang/database/pgbouncer
        property: stats_password

    # Application username
    - secretKey: app_username
      remoteRef:
        key: greenlang/database/application
        property: username

    # Application password
    - secretKey: app_password
      remoteRef:
        key: greenlang/database/application
        property: password

---
# External Secret for TLS certificates (optional)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbouncer-tls
  namespace: greenlang-database
  labels:
    app: pgbouncer
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: greenlang-secret-store
    kind: ClusterSecretStore

  target:
    name: pgbouncer-tls
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
      metadata:
        labels:
          app: pgbouncer

  data:
    - secretKey: tls.crt
      remoteRef:
        key: greenlang/database/pgbouncer-tls
        property: certificate

    - secretKey: tls.key
      remoteRef:
        key: greenlang/database/pgbouncer-tls
        property: private_key

    - secretKey: ca.crt
      remoteRef:
        key: greenlang/database/pgbouncer-tls
        property: ca_certificate

---
# ClusterSecretStore configuration (for reference)
# This should be created once per cluster by platform team
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: greenlang-secret-store
# spec:
#   provider:
#     # AWS Secrets Manager
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: external-secrets-sa
#             namespace: external-secrets
#
#     # OR HashiCorp Vault
#     # vault:
#     #   server: "https://vault.greenlang.io:8200"
#     #   path: "secret"
#     #   version: "v2"
#     #   auth:
#     #     kubernetes:
#     #       mountPath: "kubernetes"
#     #       role: "greenlang-database"
#
#     # OR Azure Key Vault
#     # azurekv:
#     #   vaultUrl: "https://greenlang-kv.vault.azure.net"
#     #   authType: ManagedIdentity

---
# Sealed Secret alternative (for GitOps without External Secrets Operator)
# This is encrypted and can be safely stored in Git
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: pgbouncer-secrets-sealed
#   namespace: greenlang-database
# spec:
#   encryptedData:
#     postgresql-host: AgBy8h...encrypted...
#     postgresql-username: AgBy8h...encrypted...
#     postgresql-password: AgBy8h...encrypted...
#   template:
#     metadata:
#       name: pgbouncer-secrets
#       namespace: greenlang-database
#       labels:
#         app: pgbouncer
#     type: Opaque

---
# Secret template for local development/testing ONLY
# DO NOT use in production - use External Secrets instead
# apiVersion: v1
# kind: Secret
# metadata:
#   name: pgbouncer-secrets-dev
#   namespace: greenlang-database
#   labels:
#     app: pgbouncer
#     environment: development
#   annotations:
#     description: "Development secrets - DO NOT USE IN PRODUCTION"
# type: Opaque
# stringData:
#   postgresql-host: "postgresql.greenlang-database.svc.cluster.local"
#   postgresql-username: "postgres"
#   postgresql-password: "CHANGE_ME_IN_PRODUCTION"
#   pgbouncer-auth-user: "pgbouncer"
#   exporter-database-url: "postgresql://pgbouncer_stats:CHANGE_ME@localhost:5432/pgbouncer?sslmode=disable"
#   connection-string: "postgresql://greenlang_app:CHANGE_ME@pgbouncer.greenlang-database:5432/greenlang"
