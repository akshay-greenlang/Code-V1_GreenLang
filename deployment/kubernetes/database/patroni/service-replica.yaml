---
# Replica (Read) Service for Patroni PostgreSQL Cluster
# Routes traffic to replica nodes for read-only operations
apiVersion: v1
kind: Service
metadata:
  name: patroni-replica
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
    component: database
    role: replica
    part-of: greenlang
  annotations:
    description: "Replica PostgreSQL service for read-only operations"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9187"
spec:
  type: ClusterIP
  # Round-robin load balancing across replicas
  sessionAffinity: None
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
    - name: patroni-api
      port: 8008
      targetPort: 8008
      protocol: TCP
    - name: metrics
      port: 9187
      targetPort: 9187
      protocol: TCP
  selector:
    app: patroni
    cluster-name: greenlang-cluster
    # This label is set by Patroni on replica nodes
    role: replica

---
# Service for all cluster members (includes primary and replicas)
# Useful for read operations that can tolerate slightly stale data
apiVersion: v1
kind: Service
metadata:
  name: patroni-all
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
    component: database
    role: all
    part-of: greenlang
  annotations:
    description: "Service for all PostgreSQL cluster members (primary + replicas)"
spec:
  type: ClusterIP
  sessionAffinity: None
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
    - name: patroni-api
      port: 8008
      targetPort: 8008
      protocol: TCP
    - name: metrics
      port: 9187
      targetPort: 9187
      protocol: TCP
  selector:
    app: patroni
    cluster-name: greenlang-cluster
    # No role selector - matches all pods

---
# External LoadBalancer for Replicas (optional - for external read access)
apiVersion: v1
kind: Service
metadata:
  name: patroni-replica-external
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
    component: database
    role: replica-external
    part-of: greenlang
  annotations:
    description: "External LoadBalancer for replica PostgreSQL read access"
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    cloud.google.com/load-balancer-type: "Internal"
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
  selector:
    app: patroni
    cluster-name: greenlang-cluster
    role: replica

---
# Synchronous Standby Service
# Routes to sync standby for read-your-writes consistency
apiVersion: v1
kind: Service
metadata:
  name: patroni-sync-standby
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
    component: database
    role: sync-standby
    part-of: greenlang
  annotations:
    description: "Synchronous standby service for consistent reads"
spec:
  type: ClusterIP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
  selector:
    app: patroni
    cluster-name: greenlang-cluster
    # Patroni sets this label on sync standby
    replication_state: sync

---
# Service Monitor for Prometheus Operator
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: patroni-monitor
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
    component: monitoring
    release: prometheus
spec:
  jobLabel: patroni
  selector:
    matchLabels:
      app: patroni
      cluster-name: greenlang-cluster
  namespaceSelector:
    matchNames:
      - greenlang-db
  endpoints:
    # Patroni API metrics
    - port: patroni-api
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      scheme: http
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_label_role]
          targetLabel: role
    # PostgreSQL exporter metrics
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      scheme: http
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_label_role]
          targetLabel: role

---
# Pod Monitor for individual pod metrics
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: patroni-pod-monitor
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
    component: monitoring
spec:
  selector:
    matchLabels:
      app: patroni
      cluster-name: greenlang-cluster
  namespaceSelector:
    matchNames:
      - greenlang-db
  podMetricsEndpoints:
    - port: patroni-api
      path: /metrics
      interval: 30s
    - port: metrics
      path: /metrics
      interval: 30s

---
# PodDisruptionBudget to ensure HA during maintenance
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: patroni-pdb
  namespace: greenlang-db
  labels:
    app: patroni
    cluster-name: greenlang-cluster
spec:
  # Ensure at least 2 pods are always available (quorum)
  minAvailable: 2
  selector:
    matchLabels:
      app: patroni
      cluster-name: greenlang-cluster
