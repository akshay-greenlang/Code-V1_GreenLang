#------------------------------------------------------------------------------
# ExternalSecret for Redis Password
# Syncs Redis AUTH password from AWS Secrets Manager to Kubernetes Secret
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-credentials
    app.kubernetes.io/component: secret
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
  annotations:
    # Helm annotations for GitOps compatibility
    argocd.argoproj.io/sync-wave: "-1"
    helm.sh/hook-weight: "-1"
spec:
  # Refresh interval - how often to sync from AWS
  refreshInterval: 1h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: greenlang-redis-aws-secrets
    kind: ClusterSecretStore

  # Target Kubernetes Secret configuration
  target:
    name: redis-credentials
    creationPolicy: Owner
    deletionPolicy: Retain

    # Template for the Kubernetes Secret
    template:
      type: Opaque

      metadata:
        labels:
          app.kubernetes.io/name: redis-credentials
          app.kubernetes.io/component: secret
          app.kubernetes.io/part-of: greenlang
        annotations:
          description: "Redis authentication credentials synced from AWS Secrets Manager"
          last-synced: "{{ .now | date \"2006-01-02T15:04:05Z07:00\" }}"

      # Data template with additional processing
      data:
        # Direct password value
        REDIS_PASSWORD: "{{ .password }}"

        # Username (default for Redis)
        REDIS_USERNAME: "{{ .username }}"

        # Host and port for application configuration
        REDIS_HOST: "{{ .host }}"
        REDIS_PORT: "{{ .port }}"

        # SSL enabled flag
        REDIS_SSL: "{{ .ssl_enabled }}"

  # Data mapping from AWS Secrets Manager
  data:
    # Map each JSON key from the secret
    - secretKey: password
      remoteRef:
        key: greenlang/redis/auth
        property: password

    - secretKey: username
      remoteRef:
        key: greenlang/redis/auth
        property: username

    - secretKey: host
      remoteRef:
        key: greenlang/redis/auth
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/redis/auth
        property: port

    - secretKey: ssl_enabled
      remoteRef:
        key: greenlang/redis/auth
        property: ssl_enabled

---
#------------------------------------------------------------------------------
# ExternalSecret for Staging Environment
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: greenlang-staging
  labels:
    app.kubernetes.io/name: redis-credentials
    app.kubernetes.io/component: secret
    app.kubernetes.io/part-of: greenlang
    environment: staging
spec:
  refreshInterval: 30m

  secretStoreRef:
    name: greenlang-redis-aws-secrets-staging
    kind: ClusterSecretStore

  target:
    name: redis-credentials
    creationPolicy: Owner
    deletionPolicy: Retain

    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: redis-credentials
          environment: staging

  data:
    - secretKey: password
      remoteRef:
        key: greenlang-staging/redis/auth
        property: password

    - secretKey: username
      remoteRef:
        key: greenlang-staging/redis/auth
        property: username

    - secretKey: host
      remoteRef:
        key: greenlang-staging/redis/auth
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang-staging/redis/auth
        property: port

---
#------------------------------------------------------------------------------
# PushSecret - Reverse sync from K8s to AWS (optional)
# Use this to initialize secrets from existing K8s secrets
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: redis-push-secret
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-push-secret
    app.kubernetes.io/component: secret-sync
spec:
  # Delete secret from AWS when PushSecret is deleted
  deletionPolicy: Delete

  # How often to sync to AWS
  refreshInterval: 1h

  # Reference to the secret store
  secretStoreRefs:
    - name: greenlang-redis-aws-secrets
      kind: ClusterSecretStore

  # Source Kubernetes Secret
  selector:
    secret:
      name: redis-credentials-manual

  # Data mapping
  data:
    - match:
        secretKey: password
        remoteRef:
          remoteKey: greenlang/redis/auth
          property: password
