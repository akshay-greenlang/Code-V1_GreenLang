#------------------------------------------------------------------------------
# ClusterSecretStore for AWS Secrets Manager
# Provides cluster-wide access to AWS Secrets Manager via IRSA
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: greenlang-redis-aws-secrets
  labels:
    app.kubernetes.io/name: redis-secret-store
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
spec:
  # Provider configuration for AWS Secrets Manager
  provider:
    aws:
      service: SecretsManager

      # AWS Region where secrets are stored
      region: us-east-1

      # Authentication via IRSA (IAM Roles for Service Accounts)
      auth:
        jwt:
          serviceAccountRef:
            # Service account with IRSA annotation
            name: external-secrets-redis
            namespace: external-secrets

      # Optional: Filter secrets by tags
      # additionalRoles: []

  # Conditions for the store
  conditions:
    - type: Ready
      status: "True"
      reason: Configured
      message: "AWS Secrets Manager connection configured"

---
#------------------------------------------------------------------------------
# Service Account for External Secrets with IRSA
#------------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-redis
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets-redis
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang
  annotations:
    # This ARN is provided by Terraform output: iam_role_arn
    # Replace with actual ARN from terraform output
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-eks-redis-secrets

    # Optional: Restrict STS session duration
    eks.amazonaws.com/sts-regional-endpoints: "true"
    eks.amazonaws.com/token-expiration: "86400"

---
#------------------------------------------------------------------------------
# ClusterSecretStore for Staging Environment
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: greenlang-redis-aws-secrets-staging
  labels:
    app.kubernetes.io/name: redis-secret-store-staging
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
    environment: staging
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1

      # Use different service account for staging
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-redis-staging
            namespace: external-secrets

---
#------------------------------------------------------------------------------
# SecretStore (Namespace-scoped alternative)
# Use this if you need namespace-level isolation
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: redis-aws-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-secret-store
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: greenlang
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1

      auth:
        jwt:
          serviceAccountRef:
            name: redis-secrets-sa
            # Namespace is implicit (same as SecretStore)

---
#------------------------------------------------------------------------------
# Service Account for namespace-scoped SecretStore
#------------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: redis-secrets-sa
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-secrets-sa
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-eks-redis-secrets
