#------------------------------------------------------------------------------
# ExternalSecret for Complete Redis Connection URL
# Provides a ready-to-use connection string for applications
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-connection-url
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-connection-url
    app.kubernetes.io/component: secret
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
  annotations:
    description: "Complete Redis connection URL with authentication"
    argocd.argoproj.io/sync-wave: "-1"
spec:
  # Refresh every hour to pick up any credential changes
  refreshInterval: 1h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: greenlang-redis-aws-secrets
    kind: ClusterSecretStore

  # Target Kubernetes Secret
  target:
    name: redis-connection-url
    creationPolicy: Owner
    deletionPolicy: Retain

    template:
      type: Opaque

      metadata:
        labels:
          app.kubernetes.io/name: redis-connection-url
          app.kubernetes.io/component: connection-secret
          app.kubernetes.io/part-of: greenlang
        annotations:
          description: "Redis connection URL for application configuration"

      # Multiple URL formats for different clients
      data:
        # Standard Redis URL (pre-built from AWS)
        REDIS_URL: "{{ .connection_url }}"

        # URL for clients that don't support rediss:// scheme
        REDIS_URL_TCP: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}"

        # URL with SSL explicitly in query string
        REDIS_URL_WITH_SSL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}?ssl=true&ssl_cert_reqs=required"

        # Celery broker URL format
        CELERY_BROKER_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/0"

        # Django cache backend URL
        DJANGO_REDIS_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/1"

        # Sidekiq URL format
        SIDEKIQ_REDIS_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/2"

        # URL-encoded password for URLs with special characters
        REDIS_URL_ENCODED: "redis://{{ .username }}:{{ .password | urlquery }}@{{ .host }}:{{ .port }}"

        # Connection parameters as JSON (for apps that need structured config)
        REDIS_CONFIG_JSON: |
          {
            "host": "{{ .host }}",
            "port": {{ .port }},
            "username": "{{ .username }}",
            "password": "{{ .password }}",
            "ssl": {{ .ssl_enabled }},
            "db": 0
          }

  # Fetch all required fields from AWS Secrets Manager
  data:
    - secretKey: connection_url
      remoteRef:
        key: greenlang/redis/auth
        property: connection_url

    - secretKey: password
      remoteRef:
        key: greenlang/redis/auth
        property: password

    - secretKey: username
      remoteRef:
        key: greenlang/redis/auth
        property: username

    - secretKey: host
      remoteRef:
        key: greenlang/redis/auth
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/redis/auth
        property: port

    - secretKey: ssl_enabled
      remoteRef:
        key: greenlang/redis/auth
        property: ssl_enabled

---
#------------------------------------------------------------------------------
# ExternalSecret for Redis Sentinel Configuration
# For high-availability Redis setups
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-sentinel-url
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-sentinel-url
    app.kubernetes.io/component: secret
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-redis-aws-secrets
    kind: ClusterSecretStore

  target:
    name: redis-sentinel-url
    creationPolicy: Owner

    template:
      type: Opaque
      data:
        # Sentinel URL format
        REDIS_SENTINEL_URL: "redis-sentinel://{{ .username }}:{{ .password }}@{{ .sentinel_host }}:{{ .sentinel_port }}/mymaster"

        # Sentinel master name
        REDIS_SENTINEL_MASTER: "mymaster"

        # For Python redis-py-cluster
        REDIS_SENTINEL_CONFIG: |
          sentinels:
            - host: {{ .sentinel_host }}
              port: {{ .sentinel_port }}
          master_name: mymaster
          password: {{ .password }}

  data:
    - secretKey: password
      remoteRef:
        key: greenlang/redis/auth
        property: password

    - secretKey: username
      remoteRef:
        key: greenlang/redis/auth
        property: username

    - secretKey: sentinel_host
      remoteRef:
        key: greenlang/redis/sentinel
        property: host
        decodingStrategy: Auto
      # Use default value if sentinel secret doesn't exist

    - secretKey: sentinel_port
      remoteRef:
        key: greenlang/redis/sentinel
        property: port
        decodingStrategy: Auto

---
#------------------------------------------------------------------------------
# ExternalSecret for Redis Cluster Configuration
# For Redis Cluster mode
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-cluster-url
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-cluster-url
    app.kubernetes.io/component: secret
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-redis-aws-secrets
    kind: ClusterSecretStore

  target:
    name: redis-cluster-url
    creationPolicy: Owner

    template:
      type: Opaque
      data:
        # Cluster URL for ioredis
        REDIS_CLUSTER_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}"

        # Cluster nodes configuration
        REDIS_CLUSTER_NODES: "{{ .host }}:{{ .port }}"

        # Password for cluster authentication
        REDIS_CLUSTER_PASSWORD: "{{ .password }}"

  data:
    - secretKey: password
      remoteRef:
        key: greenlang/redis/auth
        property: password

    - secretKey: username
      remoteRef:
        key: greenlang/redis/auth
        property: username

    - secretKey: host
      remoteRef:
        key: greenlang/redis/auth
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/redis/auth
        property: port

---
#------------------------------------------------------------------------------
# ExternalSecret for Application-Specific Redis Database
# Different databases for different services
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-app-connections
  namespace: greenlang
  labels:
    app.kubernetes.io/name: redis-app-connections
    app.kubernetes.io/component: secret
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-redis-aws-secrets
    kind: ClusterSecretStore

  target:
    name: redis-app-connections
    creationPolicy: Owner

    template:
      type: Opaque
      data:
        # Cache database (db 0)
        REDIS_CACHE_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/0"

        # Session storage (db 1)
        REDIS_SESSION_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/1"

        # Celery broker (db 2)
        REDIS_CELERY_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/2"

        # Rate limiting (db 3)
        REDIS_RATELIMIT_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/3"

        # Pub/Sub channel (db 4)
        REDIS_PUBSUB_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/4"

        # Temporary data (db 5)
        REDIS_TEMP_URL: "redis://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/5"

  data:
    - secretKey: password
      remoteRef:
        key: greenlang/redis/auth
        property: password

    - secretKey: username
      remoteRef:
        key: greenlang/redis/auth
        property: username

    - secretKey: host
      remoteRef:
        key: greenlang/redis/auth
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/redis/auth
        property: port
