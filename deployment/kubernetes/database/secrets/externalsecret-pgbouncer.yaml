##############################################
# GreenLang PgBouncer External Secrets
# Sync PgBouncer credentials and userlist
##############################################

---
# PgBouncer Authentication Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbouncer-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbouncer-credentials
    app.kubernetes.io/component: pgbouncer-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: pgbouncer-auth
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbouncer-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbouncer-credentials
          app.kubernetes.io/component: pgbouncer-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # PgBouncer auth user credentials
        AUTH_USER: "{{ .auth_user }}"
        AUTH_PASSWORD: "{{ .auth_password }}"
        # Admin configuration
        ADMIN_USERS: "{{ .admin_users }}"
        STATS_USERS: "{{ .stats_users }}"

  data:
    - secretKey: auth_user
      remoteRef:
        key: greenlang/database/pgbouncer
        property: auth_user

    - secretKey: auth_password
      remoteRef:
        key: greenlang/database/pgbouncer
        property: auth_password

    - secretKey: admin_users
      remoteRef:
        key: greenlang/database/pgbouncer
        property: admin_users

    - secretKey: stats_users
      remoteRef:
        key: greenlang/database/pgbouncer
        property: stats_users

---
# PgBouncer Userlist.txt
# Transforms credentials into PgBouncer userlist format
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbouncer-userlist
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbouncer-userlist
    app.kubernetes.io/component: pgbouncer-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: pgbouncer-userlist
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbouncer-userlist
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbouncer-userlist
          app.kubernetes.io/component: pgbouncer-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # userlist.txt format: "username" "password"
        # Each line is a user entry
        userlist.txt: |
          {{ .userlist }}

  data:
    - secretKey: userlist
      remoteRef:
        key: greenlang/database/pgbouncer
        property: userlist

---
# PgBouncer Configuration Secret
# Complete pgbouncer.ini configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbouncer-config
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbouncer-config
    app.kubernetes.io/component: pgbouncer-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: pgbouncer-config
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbouncer-config
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbouncer-config
          app.kubernetes.io/component: pgbouncer-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        pgbouncer.ini: |
          [databases]
          greenlang = host={{ .db_host }} port={{ .db_port }} dbname={{ .db_name }}
          * = host={{ .db_host }} port={{ .db_port }}

          [pgbouncer]
          listen_addr = 0.0.0.0
          listen_port = 6432
          auth_type = scram-sha-256
          auth_file = /etc/pgbouncer/userlist.txt
          auth_user = {{ .auth_user }}
          auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

          ; Admin access
          admin_users = {{ .admin_users }}
          stats_users = {{ .stats_users }}

          ; Pool settings
          pool_mode = transaction
          max_client_conn = 1000
          default_pool_size = 25
          min_pool_size = 5
          reserve_pool_size = 5
          reserve_pool_timeout = 3

          ; Connection settings
          server_reset_query = DISCARD ALL
          server_check_query = SELECT 1
          server_check_delay = 30
          server_connect_timeout = 15
          server_login_retry = 15
          server_lifetime = 3600
          server_idle_timeout = 600
          client_login_timeout = 60

          ; Logging
          log_connections = 1
          log_disconnections = 1
          log_pooler_errors = 1
          stats_period = 60

          ; TLS settings
          client_tls_sslmode = prefer
          client_tls_key_file = /etc/pgbouncer/tls/tls.key
          client_tls_cert_file = /etc/pgbouncer/tls/tls.crt

          ; Security
          ignore_startup_parameters = extra_float_digits,application_name

  data:
    - secretKey: db_host
      remoteRef:
        key: greenlang/database/master
        property: host

    - secretKey: db_port
      remoteRef:
        key: greenlang/database/master
        property: port

    - secretKey: db_name
      remoteRef:
        key: greenlang/database/master
        property: dbname

    - secretKey: auth_user
      remoteRef:
        key: greenlang/database/pgbouncer
        property: auth_user

    - secretKey: admin_users
      remoteRef:
        key: greenlang/database/pgbouncer
        property: admin_users

    - secretKey: stats_users
      remoteRef:
        key: greenlang/database/pgbouncer
        property: stats_users

---
# PgBouncer Combined Secret for Deployment
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbouncer-all
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbouncer-all
    app.kubernetes.io/component: pgbouncer-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: pgbouncer-combined
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbouncer-all
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbouncer-all
          app.kubernetes.io/component: pgbouncer-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Auth credentials
        PGBOUNCER_AUTH_USER: "{{ .auth_user }}"
        PGBOUNCER_AUTH_PASSWORD: "{{ .auth_password }}"
        # Database connection
        PGBOUNCER_DATABASE_HOST: "{{ .db_host }}"
        PGBOUNCER_DATABASE_PORT: "{{ .db_port }}"
        PGBOUNCER_DATABASE_NAME: "{{ .db_name }}"
        # Admin configuration
        PGBOUNCER_ADMIN_USERS: "{{ .admin_users }}"
        PGBOUNCER_STATS_USERS: "{{ .stats_users }}"
        # Userlist file content
        userlist.txt: |
          {{ .userlist }}

  data:
    - secretKey: auth_user
      remoteRef:
        key: greenlang/database/pgbouncer
        property: auth_user

    - secretKey: auth_password
      remoteRef:
        key: greenlang/database/pgbouncer
        property: auth_password

    - secretKey: admin_users
      remoteRef:
        key: greenlang/database/pgbouncer
        property: admin_users

    - secretKey: stats_users
      remoteRef:
        key: greenlang/database/pgbouncer
        property: stats_users

    - secretKey: userlist
      remoteRef:
        key: greenlang/database/pgbouncer
        property: userlist

    - secretKey: db_host
      remoteRef:
        key: greenlang/database/master
        property: host

    - secretKey: db_port
      remoteRef:
        key: greenlang/database/master
        property: port

    - secretKey: db_name
      remoteRef:
        key: greenlang/database/master
        property: dbname
