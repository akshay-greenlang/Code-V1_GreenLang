##############################################
# GreenLang pgBackRest External Secrets
# Sync backup credentials and encryption keys
##############################################

---
# pgBackRest Encryption and S3 Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbackrest-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbackrest-credentials
    app.kubernetes.io/component: backup-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: backup-encryption
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbackrest-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbackrest-credentials
          app.kubernetes.io/component: backup-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Encryption configuration
        PGBACKREST_REPO1_CIPHER_PASS: "{{ .repo1_cipher_pass }}"
        PGBACKREST_REPO1_CIPHER_TYPE: "{{ .repo1_cipher_type }}"
        # S3 credentials
        AWS_ACCESS_KEY_ID: "{{ .repo1_s3_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ .repo1_s3_key_secret }}"
        # S3 configuration
        PGBACKREST_REPO1_S3_BUCKET: "{{ .repo1_s3_bucket }}"
        PGBACKREST_REPO1_S3_REGION: "{{ .repo1_s3_region }}"
        PGBACKREST_REPO1_PATH: "{{ .repo1_path }}"
        # Retention settings
        PGBACKREST_REPO1_RETENTION_FULL: "{{ .retention_full }}"
        PGBACKREST_REPO1_RETENTION_DIFF: "{{ .retention_diff }}"

  data:
    - secretKey: repo1_cipher_pass
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_cipher_pass

    - secretKey: repo1_cipher_type
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_cipher_type

    - secretKey: repo1_s3_key
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_key

    - secretKey: repo1_s3_key_secret
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_key_secret

    - secretKey: repo1_s3_bucket
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_bucket

    - secretKey: repo1_s3_region
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_region

    - secretKey: repo1_path
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_path

    - secretKey: retention_full
      remoteRef:
        key: greenlang/database/pgbackrest
        property: retention_full

    - secretKey: retention_diff
      remoteRef:
        key: greenlang/database/pgbackrest
        property: retention_diff

---
# pgBackRest Configuration File Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbackrest-config
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbackrest-config
    app.kubernetes.io/component: backup-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: backup-config
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbackrest-config
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbackrest-config
          app.kubernetes.io/component: backup-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # pgbackrest.conf file content
        pgbackrest.conf: |
          [global]
          # Repository configuration
          repo1-type=s3
          repo1-path={{ .repo1_path }}
          repo1-s3-bucket={{ .repo1_s3_bucket }}
          repo1-s3-region={{ .repo1_s3_region }}
          repo1-s3-key={{ .repo1_s3_key }}
          repo1-s3-key-secret={{ .repo1_s3_key_secret }}
          repo1-s3-endpoint=s3.{{ .repo1_s3_region }}.amazonaws.com

          # Encryption configuration
          repo1-cipher-type={{ .repo1_cipher_type }}
          repo1-cipher-pass={{ .repo1_cipher_pass }}

          # Retention configuration
          repo1-retention-full={{ .retention_full }}
          repo1-retention-diff={{ .retention_diff }}

          # Performance settings
          process-max=4
          compress-type=lz4
          compress-level=6

          # Logging
          log-level-console=info
          log-level-file=detail

          # Parallel backup settings
          backup-standby=y

          [greenlang]
          # PostgreSQL cluster configuration
          pg1-path=/var/lib/postgresql/data
          pg1-port=5432

  data:
    - secretKey: repo1_cipher_pass
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_cipher_pass

    - secretKey: repo1_cipher_type
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_cipher_type

    - secretKey: repo1_s3_key
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_key

    - secretKey: repo1_s3_key_secret
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_key_secret

    - secretKey: repo1_s3_bucket
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_bucket

    - secretKey: repo1_s3_region
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_region

    - secretKey: repo1_path
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_path

    - secretKey: retention_full
      remoteRef:
        key: greenlang/database/pgbackrest
        property: retention_full

    - secretKey: retention_diff
      remoteRef:
        key: greenlang/database/pgbackrest
        property: retention_diff

---
# S3 Credentials for AWS SDK (separate secret)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbackrest-s3-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbackrest-s3-credentials
    app.kubernetes.io/component: backup-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: s3-credentials
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbackrest-s3-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      # AWS credentials file format
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbackrest-s3-credentials
          app.kubernetes.io/component: backup-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Standard AWS SDK environment variables
        AWS_ACCESS_KEY_ID: "{{ .repo1_s3_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ .repo1_s3_key_secret }}"
        AWS_DEFAULT_REGION: "{{ .repo1_s3_region }}"
        # AWS credentials file format
        credentials: |
          [default]
          aws_access_key_id = {{ .repo1_s3_key }}
          aws_secret_access_key = {{ .repo1_s3_key_secret }}
        # AWS config file format
        config: |
          [default]
          region = {{ .repo1_s3_region }}
          output = json

  data:
    - secretKey: repo1_s3_key
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_key

    - secretKey: repo1_s3_key_secret
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_key_secret

    - secretKey: repo1_s3_region
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_s3_region

---
# Encryption Key Only (for restore operations)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbackrest-encryption-key
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbackrest-encryption-key
    app.kubernetes.io/component: backup-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: encryption-key
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: pgbackrest-encryption-key
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbackrest-encryption-key
          app.kubernetes.io/component: backup-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Encryption passphrase
        cipher-pass: "{{ .repo1_cipher_pass }}"
        cipher-type: "{{ .repo1_cipher_type }}"

  data:
    - secretKey: repo1_cipher_pass
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_cipher_pass

    - secretKey: repo1_cipher_type
      remoteRef:
        key: greenlang/database/pgbackrest
        property: repo1_cipher_type

---
# Service Account for pgBackRest pod (IRSA)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pgbackrest
  namespace: greenlang
  labels:
    app.kubernetes.io/name: pgbackrest
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: greenlang
  annotations:
    # Replace with actual IAM role ARN from Terraform output
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-backup-operator
