##############################################
# GreenLang PostgreSQL External Secrets
# Sync credentials from AWS Secrets Manager
##############################################

---
# Master Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgresql-master-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: postgresql-master-credentials
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database-master
spec:
  # Refresh interval for syncing secrets
  refreshInterval: 1h

  # Reference to the SecretStore
  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  # Target Kubernetes Secret configuration
  target:
    name: postgresql-master-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: postgresql-master-credentials
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          secret-rotated-at: "{{ .timestamp }}"
      data:
        # PostgreSQL environment variables format
        PGUSER: "{{ .username }}"
        PGPASSWORD: "{{ .password }}"
        PGHOST: "{{ .host }}"
        PGPORT: "{{ .port }}"
        PGDATABASE: "{{ .dbname }}"
        # Connection string format
        DATABASE_URL: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .dbname }}"
        # Patroni format
        PATRONI_SUPERUSER_USERNAME: "{{ .username }}"
        PATRONI_SUPERUSER_PASSWORD: "{{ .password }}"

  # Data to fetch from AWS Secrets Manager
  data:
    - secretKey: username
      remoteRef:
        key: greenlang/database/master
        property: username

    - secretKey: password
      remoteRef:
        key: greenlang/database/master
        property: password

    - secretKey: host
      remoteRef:
        key: greenlang/database/master
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/database/master
        property: port

    - secretKey: dbname
      remoteRef:
        key: greenlang/database/master
        property: dbname

    - secretKey: timestamp
      remoteRef:
        key: greenlang/database/master
        metadataPolicy: Fetch
        property: createdDate

---
# Application Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgresql-app-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: postgresql-app-credentials
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database-application
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: postgresql-app-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: postgresql-app-credentials
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Standard PostgreSQL environment variables
        PGUSER: "{{ .username }}"
        PGPASSWORD: "{{ .password }}"
        PGHOST: "{{ .host }}"
        PGPORT: "{{ .port }}"
        PGDATABASE: "{{ .dbname }}"
        # Full connection string
        DATABASE_URL: "{{ .connectionString }}"
        # Django format
        DJANGO_DATABASE_URL: "{{ .connectionString }}"
        # SQLAlchemy format
        SQLALCHEMY_DATABASE_URI: "{{ .connectionString }}"

  data:
    - secretKey: username
      remoteRef:
        key: greenlang/database/application
        property: username

    - secretKey: password
      remoteRef:
        key: greenlang/database/application
        property: password

    - secretKey: host
      remoteRef:
        key: greenlang/database/application
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/database/application
        property: port

    - secretKey: dbname
      remoteRef:
        key: greenlang/database/application
        property: dbname

    - secretKey: connectionString
      remoteRef:
        key: greenlang/database/application
        property: connectionString

---
# Replication User Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgresql-replication-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: postgresql-replication-credentials
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database-replication
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: postgresql-replication-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: postgresql-replication-credentials
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Replication configuration
        REPLICATION_USER: "{{ .username }}"
        REPLICATION_PASSWORD: "{{ .password }}"
        REPLICATION_SLOT: "{{ .replication_slot }}"
        # Patroni replication format
        PATRONI_REPLICATION_USERNAME: "{{ .username }}"
        PATRONI_REPLICATION_PASSWORD: "{{ .password }}"

  data:
    - secretKey: username
      remoteRef:
        key: greenlang/database/replication
        property: username

    - secretKey: password
      remoteRef:
        key: greenlang/database/replication
        property: password

    - secretKey: replication_slot
      remoteRef:
        key: greenlang/database/replication
        property: replication_slot

---
# Combined PostgreSQL Credentials Secret
# For applications that need all credentials in one secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgresql-all-credentials
  namespace: greenlang
  labels:
    app.kubernetes.io/name: postgresql-all-credentials
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database-combined
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: greenlang-database-secrets
    kind: SecretStore

  target:
    name: postgresql-all-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: postgresql-all-credentials
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
      data:
        # Master credentials
        master-username: "{{ .master_username }}"
        master-password: "{{ .master_password }}"
        # Application credentials
        app-username: "{{ .app_username }}"
        app-password: "{{ .app_password }}"
        app-connection-string: "{{ .app_connection_string }}"
        # Replication credentials
        replication-username: "{{ .repl_username }}"
        replication-password: "{{ .repl_password }}"
        # Connection details
        database-host: "{{ .host }}"
        database-port: "{{ .port }}"
        database-name: "{{ .dbname }}"

  data:
    # Master credentials
    - secretKey: master_username
      remoteRef:
        key: greenlang/database/master
        property: username

    - secretKey: master_password
      remoteRef:
        key: greenlang/database/master
        property: password

    # Application credentials
    - secretKey: app_username
      remoteRef:
        key: greenlang/database/application
        property: username

    - secretKey: app_password
      remoteRef:
        key: greenlang/database/application
        property: password

    - secretKey: app_connection_string
      remoteRef:
        key: greenlang/database/application
        property: connectionString

    # Replication credentials
    - secretKey: repl_username
      remoteRef:
        key: greenlang/database/replication
        property: username

    - secretKey: repl_password
      remoteRef:
        key: greenlang/database/replication
        property: password

    # Connection details
    - secretKey: host
      remoteRef:
        key: greenlang/database/master
        property: host

    - secretKey: port
      remoteRef:
        key: greenlang/database/master
        property: port

    - secretKey: dbname
      remoteRef:
        key: greenlang/database/master
        property: dbname
