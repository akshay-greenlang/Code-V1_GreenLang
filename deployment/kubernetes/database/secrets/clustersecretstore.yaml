##############################################
# GreenLang ClusterSecretStore Configuration
# AWS Secrets Manager Provider with IRSA
##############################################

---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: greenlang-aws-secrets-manager
  labels:
    app.kubernetes.io/name: greenlang-secret-store
    app.kubernetes.io/component: secrets
    app.kubernetes.io/managed-by: external-secrets
spec:
  provider:
    aws:
      service: SecretsManager
      # AWS Region where secrets are stored
      region: us-east-1

      # Authentication via IAM Roles for Service Accounts (IRSA)
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# Service Account for External Secrets Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: service-account
  annotations:
    # Replace with actual IAM role ARN from Terraform output
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-external-secrets-operator

---
# Namespace-scoped SecretStore for GreenLang namespace
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: greenlang-database-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-secret-store
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1

      # Use the service account in the greenlang namespace
      auth:
        jwt:
          serviceAccountRef:
            name: greenlang-db-secrets
            namespace: greenlang

---
# Service Account for GreenLang namespace
apiVersion: v1
kind: ServiceAccount
metadata:
  name: greenlang-db-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-db-secrets
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang
  annotations:
    # Replace with actual IAM role ARN from Terraform output
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-eks-secrets-role

---
# RBAC for External Secrets Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets-greenlang
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: rbac
rules:
  - apiGroups: ["external-secrets.io"]
    resources:
      - externalsecrets
      - externalsecrets/status
      - secretstores
      - secretstores/status
      - clustersecretstores
      - clustersecretstores/status
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources:
      - secrets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources:
      - serviceaccounts
      - serviceaccounts/token
    verbs: ["get", "list", "watch", "create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets-greenlang
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-secrets-greenlang
subjects:
  - kind: ServiceAccount
    name: external-secrets-sa
    namespace: external-secrets

---
# NetworkPolicy for External Secrets access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  policyTypes:
    - Egress
  egress:
    # Allow HTTPS to AWS Secrets Manager
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
