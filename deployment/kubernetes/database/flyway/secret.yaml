# =============================================================================
# GreenLang Flyway Secrets
# =============================================================================
# Description: Secrets for Flyway database migrations
# WARNING: This is a TEMPLATE. Never commit actual credentials to git.
#          Use external secrets management (AWS Secrets Manager, Vault, etc.)
# =============================================================================

# -----------------------------------------------------------------------------
# Database Credentials Secret (Template)
# -----------------------------------------------------------------------------
# IMPORTANT: Replace placeholder values before deployment
# In production, use external-secrets or sealed-secrets

apiVersion: v1
kind: Secret
metadata:
  name: flyway-credentials
  namespace: greenlang
  labels:
    app: flyway
    component: database-migration
    app.kubernetes.io/name: flyway
    app.kubernetes.io/component: credentials
    app.kubernetes.io/part-of: greenlang
  annotations:
    # Mark as template - do not use directly
    template: "true"
    description: "Database credentials for Flyway migrations"
type: Opaque
stringData:
  # Database username for migrations
  # This user should have CREATE, ALTER, DROP privileges on all schemas
  username: "greenlang_migrations"

  # Database password
  # REPLACE THIS with actual password from secrets manager
  password: "REPLACE_WITH_ACTUAL_PASSWORD"

---
# -----------------------------------------------------------------------------
# AWS Credentials Secret (Template - for S3 migrations)
# -----------------------------------------------------------------------------

apiVersion: v1
kind: Secret
metadata:
  name: flyway-aws-credentials
  namespace: greenlang
  labels:
    app: flyway
    component: database-migration
  annotations:
    template: "true"
    description: "AWS credentials for S3-based migrations"
type: Opaque
stringData:
  # AWS credentials for accessing S3 migration bucket
  # REPLACE with actual credentials or use IAM roles
  access_key_id: "REPLACE_WITH_ACCESS_KEY_ID"
  secret_access_key: "REPLACE_WITH_SECRET_ACCESS_KEY"

---
# =============================================================================
# External Secrets Configuration (Recommended for Production)
# =============================================================================
# Uses external-secrets operator to sync from AWS Secrets Manager

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: flyway-credentials
  namespace: greenlang
  labels:
    app: flyway
    component: database-migration
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: flyway-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app: flyway
          component: database-migration

  data:
    - secretKey: username
      remoteRef:
        key: greenlang/database/migrations
        property: username

    - secretKey: password
      remoteRef:
        key: greenlang/database/migrations
        property: password

---
# External secret for AWS credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: flyway-aws-credentials
  namespace: greenlang
  labels:
    app: flyway
    component: database-migration
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: flyway-aws-credentials
    creationPolicy: Owner

  data:
    - secretKey: access_key_id
      remoteRef:
        key: greenlang/aws/flyway-s3
        property: access_key_id

    - secretKey: secret_access_key
      remoteRef:
        key: greenlang/aws/flyway-s3
        property: secret_access_key

---
# =============================================================================
# Sealed Secrets Configuration (Alternative for GitOps)
# =============================================================================
# Uses Bitnami sealed-secrets for encrypted secrets in git

# To create a sealed secret:
# 1. Create a regular secret YAML (not committed)
# 2. Use kubeseal to encrypt it:
#    kubeseal --controller-name=sealed-secrets \
#             --controller-namespace=kube-system \
#             --format yaml < secret.yaml > sealed-secret.yaml

# Example sealed secret structure (encrypted values are placeholders):
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: flyway-credentials-sealed
  namespace: greenlang
  annotations:
    sealedsecrets.bitnami.com/cluster-wide: "false"
spec:
  encryptedData:
    username: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEq...  # Encrypted
    password: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEq...  # Encrypted
  template:
    type: Opaque
    metadata:
      name: flyway-credentials
      namespace: greenlang
      labels:
        app: flyway
        component: database-migration

---
# =============================================================================
# Environment-Specific Secrets (Templates)
# =============================================================================

# Development
apiVersion: v1
kind: Secret
metadata:
  name: flyway-credentials
  namespace: greenlang-dev
  labels:
    app: flyway
    environment: development
  annotations:
    template: "true"
type: Opaque
stringData:
  username: "greenlang_migrations_dev"
  password: "REPLACE_WITH_DEV_PASSWORD"

---
# Staging
apiVersion: v1
kind: Secret
metadata:
  name: flyway-credentials
  namespace: greenlang-staging
  labels:
    app: flyway
    environment: staging
  annotations:
    template: "true"
type: Opaque
stringData:
  username: "greenlang_migrations_staging"
  password: "REPLACE_WITH_STAGING_PASSWORD"

---
# =============================================================================
# Cluster Secret Store for External Secrets
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets

---
# =============================================================================
# Service Account for External Secrets (with IRSA)
# =============================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets
  namespace: external-secrets
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-external-secrets

---
# =============================================================================
# Network Policy for Secrets Access
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: flyway-secrets-access
  namespace: greenlang
spec:
  podSelector:
    matchLabels:
      app: flyway
  policyTypes:
    - Egress
  egress:
    # Allow access to Kubernetes API for secrets
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              component: kube-apiserver
      ports:
        - port: 443
          protocol: TCP
    # Allow access to external secrets webhook
    - to:
        - namespaceSelector:
            matchLabels:
              name: external-secrets
      ports:
        - port: 443
          protocol: TCP
