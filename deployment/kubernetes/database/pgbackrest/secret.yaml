# pgBackRest External Secrets Configuration
# Uses External Secrets Operator to fetch secrets from AWS Secrets Manager
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pgbackrest-secrets
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: pgbackrest
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: greenlang
  annotations:
    description: "External secrets for pgBackRest backup and recovery operations"
spec:
  # Refresh interval for secrets
  refreshInterval: 1h

  # Secret store reference
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager

  # Target Kubernetes secret
  target:
    name: pgbackrest-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pgbackrest
          app.kubernetes.io/component: secrets
        annotations:
          description: "Secrets for pgBackRest backup operations"

  # Data to fetch from AWS Secrets Manager
  data:
    # S3 credentials for backup repository
    - secretKey: aws-access-key-id
      remoteRef:
        key: greenlang/pgbackrest/s3-credentials
        property: access_key_id

    - secretKey: aws-secret-access-key
      remoteRef:
        key: greenlang/pgbackrest/s3-credentials
        property: secret_access_key

    # Encryption passphrase for backup encryption (AES-256-CBC)
    - secretKey: encryption-passphrase
      remoteRef:
        key: greenlang/pgbackrest/encryption
        property: passphrase

    # PostgreSQL credentials
    - secretKey: pg-username
      remoteRef:
        key: greenlang/postgresql/credentials
        property: username

    - secretKey: pg-password
      remoteRef:
        key: greenlang/postgresql/credentials
        property: password

    # Notification webhook (optional)
    - secretKey: slack-webhook-url
      remoteRef:
        key: greenlang/notifications/slack
        property: webhook_url

---
# ClusterSecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# Alternative: Manual Secret Template (for non-ESO environments)
# IMPORTANT: This is for reference only. In production, use External Secrets Operator.
# Uncomment and customize if ESO is not available.
#
# apiVersion: v1
# kind: Secret
# metadata:
#   name: pgbackrest-secrets
#   namespace: greenlang-database
#   labels:
#     app.kubernetes.io/name: pgbackrest
#     app.kubernetes.io/component: secrets
# type: Opaque
# stringData:
#   # AWS S3 credentials
#   aws-access-key-id: "AKIAIOSFODNN7EXAMPLE"
#   aws-secret-access-key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
#
#   # Encryption passphrase (generate with: openssl rand -base64 32)
#   encryption-passphrase: "your-secure-passphrase-here"
#
#   # PostgreSQL credentials
#   pg-username: "postgres"
#   pg-password: "your-postgres-password"
#
#   # Slack webhook URL (optional)
#   slack-webhook-url: "https://hooks.slack.com/services/xxx/yyy/zzz"

---
# SealedSecret alternative (for Bitnami Sealed Secrets)
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: pgbackrest-secrets
#   namespace: greenlang-database
# spec:
#   encryptedData:
#     aws-access-key-id: AgBy3i4OJSWK+...
#     aws-secret-access-key: AgBy3i4OJSWK+...
#     encryption-passphrase: AgBy3i4OJSWK+...
#     pg-username: AgBy3i4OJSWK+...
#     pg-password: AgBy3i4OJSWK+...
#   template:
#     metadata:
#       name: pgbackrest-secrets
#       namespace: greenlang-database
#     type: Opaque

---
# NetworkPolicy to restrict secret access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: pgbackrest-secrets-access
  namespace: greenlang-database
  labels:
    app.kubernetes.io/name: pgbackrest
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: pgbackrest
  policyTypes:
    - Egress
  egress:
    # Allow access to AWS Secrets Manager
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443

    # Allow access to S3
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443

    # Allow access to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: greenlang-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# RBAC for secret access
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pgbackrest-secrets-reader
  namespace: greenlang-database
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["pgbackrest-secrets"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pgbackrest-secrets-reader-binding
  namespace: greenlang-database
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pgbackrest-secrets-reader
subjects:
  - kind: ServiceAccount
    name: pgbackrest-backup-sa
    namespace: greenlang-database
  - kind: ServiceAccount
    name: pgbackrest-restore-sa
    namespace: greenlang-database
