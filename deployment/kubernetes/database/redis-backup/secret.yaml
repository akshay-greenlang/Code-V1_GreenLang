# Redis Backup Secrets using External Secrets Operator
# Retrieves AWS credentials and Redis password from AWS Secrets Manager
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-backup-secrets
  namespace: greenlang
  labels:
    app: redis
    component: backup
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: redis-backup-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app: redis
          component: backup
      data:
        # AWS credentials for S3 access
        AWS_ACCESS_KEY_ID: "{{ .aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ .aws_secret_access_key }}"
        # Redis authentication
        REDIS_PASSWORD: "{{ .redis_password }}"
        # Optional: Encryption key for client-side encryption
        ENCRYPTION_KEY: "{{ .encryption_key }}"

  data:
    - secretKey: aws_access_key_id
      remoteRef:
        key: greenlang/redis-backup
        property: aws_access_key_id

    - secretKey: aws_secret_access_key
      remoteRef:
        key: greenlang/redis-backup
        property: aws_secret_access_key

    - secretKey: redis_password
      remoteRef:
        key: greenlang/redis
        property: password

    - secretKey: encryption_key
      remoteRef:
        key: greenlang/redis-backup
        property: encryption_key

---
# Alternative: Manual Secret (for environments without External Secrets Operator)
# IMPORTANT: In production, use External Secrets or sealed-secrets
# This is provided as a template - DO NOT commit actual credentials
apiVersion: v1
kind: Secret
metadata:
  name: redis-backup-credentials-manual
  namespace: greenlang
  labels:
    app: redis
    component: backup
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/component: secrets
  annotations:
    description: "Manual secret template - replace with sealed-secrets in production"
type: Opaque
stringData:
  # Replace these placeholder values with actual credentials
  # Use: kubectl create secret generic redis-backup-credentials \
  #        --from-literal=AWS_ACCESS_KEY_ID=<key> \
  #        --from-literal=AWS_SECRET_ACCESS_KEY=<secret> \
  #        --from-literal=REDIS_PASSWORD=<password>
  AWS_ACCESS_KEY_ID: "REPLACE_WITH_ACTUAL_ACCESS_KEY"
  AWS_SECRET_ACCESS_KEY: "REPLACE_WITH_ACTUAL_SECRET_KEY"
  REDIS_PASSWORD: "REPLACE_WITH_REDIS_PASSWORD"
  ENCRYPTION_KEY: "REPLACE_WITH_32_BYTE_BASE64_KEY"

---
# ServiceAccount for backup jobs with IAM role annotation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: redis-backup-sa
  namespace: greenlang
  labels:
    app: redis
    component: backup
  annotations:
    # For IRSA (IAM Roles for Service Accounts) - preferred method
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/greenlang-redis-backup-role"

---
# Role for backup jobs to access Redis and secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: redis-backup-role
  namespace: greenlang
  labels:
    app: redis
    component: backup
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["redis-backup-credentials", "redis-backup-credentials-manual"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["redis-backup-config"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: redis-backup-rolebinding
  namespace: greenlang
  labels:
    app: redis
    component: backup
subjects:
  - kind: ServiceAccount
    name: redis-backup-sa
    namespace: greenlang
roleRef:
  kind: Role
  name: redis-backup-role
  apiGroup: rbac.authorization.k8s.io
