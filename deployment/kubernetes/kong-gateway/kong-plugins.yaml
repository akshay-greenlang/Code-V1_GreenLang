# =============================================================================
# GreenLang Climate OS - Kong Plugin CRDs
# =============================================================================
# PRD: INFRA-006 API Gateway (Kong)
# =============================================================================

# Global Rate Limiting Plugin (applied to all routes)
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: global-rate-limit
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "true"
plugin: rate-limiting
config:
  minute: 1000
  hour: 50000
  policy: redis
  redis_host: redis-master.greenlang.svc.cluster.local
  redis_port: 6379
  redis_database: 3
  redis_timeout: 2000
  fault_tolerant: true
  hide_client_headers: false
  error_code: 429
  error_message: "Rate limit exceeded"

---
# Global Prometheus Metrics
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: prometheus-metrics
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "true"
plugin: prometheus
config:
  per_consumer: true
  status_code_metrics: true
  latency_metrics: true
  bandwidth_metrics: true
  upstream_health_metrics: true

---
# Global CORS Plugin
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: global-cors
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "true"
plugin: cors
config:
  origins:
    - "https://app.greenlang.io"
    - "https://admin.greenlang.io"
    - "https://api.greenlang.io"
  methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - OPTIONS
  headers:
    - Authorization
    - Content-Type
    - X-Request-ID
    - X-API-Version
    - Accept
  exposed_headers:
    - X-Request-ID
    - X-Response-Time
    - X-RateLimit-Limit
    - X-RateLimit-Remaining
    - X-RateLimit-Reset
  max_age: 3600
  credentials: true

---
# Global Security Headers
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: security-headers
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "true"
plugin: response-transformer
config:
  add:
    headers:
      - "Strict-Transport-Security:max-age=31536000; includeSubDomains; preload"
      - "X-Content-Type-Options:nosniff"
      - "X-Frame-Options:SAMEORIGIN"
      - "X-XSS-Protection:1; mode=block"
      - "Referrer-Policy:strict-origin-when-cross-origin"
  remove:
    headers:
      - "Server"
      - "X-Powered-By"

---
# JWT Authentication Plugin (per-route)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: jwt-auth
  namespace: kong
plugin: jwt
config:
  uri_param_names:
    - jwt
  header_names:
    - Authorization
  claims_to_verify:
    - exp
  run_on_preflight: true

---
# Strict Rate Limit for Batch Endpoints
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: batch-rate-limit
  namespace: kong
plugin: rate-limiting
config:
  minute: 100
  policy: redis
  redis_host: redis-master.greenlang.svc.cluster.local
  redis_port: 6379
  redis_database: 3
  fault_tolerant: true
  error_code: 429
  error_message: "Batch rate limit exceeded. Max 100 requests/minute."

---
# Admin ACL Plugin
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: admin-acl
  namespace: kong
plugin: acl
config:
  allow:
    - admin
  hide_groups_header: false

---
# Admin IP Restriction
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: admin-ip-restriction
  namespace: kong
plugin: ip-restriction
config:
  allow:
    - "10.0.0.0/8"
    - "172.16.0.0/12"

---
# Bot Detection
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: bot-detection
  namespace: kong
plugin: bot-detection
config:
  deny:
    - "Scrapy"
    - "SemrushBot"
    - "AhrefsBot"
    - "MJ12bot"
    - "DotBot"

---
# Request Size Limiting (default 10MB)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: request-size-default
  namespace: kong
plugin: request-size-limiting
config:
  allowed_payload_size: 10
  size_unit: megabytes
  require_content_length: false

---
# Request Size Limiting (batch 50MB)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: request-size-batch
  namespace: kong
plugin: request-size-limiting
config:
  allowed_payload_size: 50
  size_unit: megabytes
  require_content_length: false

---
# HTTP Log Plugin
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: http-log
  namespace: kong
plugin: http-log
config:
  http_endpoint: http://fluentbit.monitoring.svc.cluster.local:9880/kong.logs
  method: POST
  content_type: application/json
  timeout: 5000
  keepalive: 60000
  retry_count: 3

---
# Tenant Isolation Plugin
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: tenant-isolation
  namespace: kong
plugin: gl-tenant-isolation
config:
  require_tenant: false
  expose_header: true
  tenant_claim: tenant_id
