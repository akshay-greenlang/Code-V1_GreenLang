# =============================================================================
# GreenLang Tempo - NetworkPolicy
# GreenLang Climate OS | OBS-003
# =============================================================================
# Restricts network traffic to and from Grafana Tempo components.
#
# INGRESS allowed:
#   - OTel Collector pods      -> Tempo distributor (4317 OTLP gRPC, 14268 Jaeger)
#   - Grafana pods             -> Tempo query-frontend (3200 HTTP API)
#   - Tempo pods (memberlist)  -> Tempo pods (7946 gossip ring)
#   - Tempo pods (gRPC)        -> Tempo pods (9095 inter-component gRPC)
#   - Prometheus pods          -> Tempo pods (3200 /metrics)
#
# EGRESS allowed:
#   - Tempo -> S3          (443 HTTPS for trace block storage)
#   - Tempo -> Tempo       (7946 memberlist, 9095 gRPC inter-component)
#   - Tempo -> kube-dns    (53 TCP/UDP)
#
# All other traffic is denied by default.
# =============================================================================

---
# ---------------------------------------------------------------------------
# Tempo components - ingress rules
# ---------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tempo-ingress
  namespace: monitoring
  labels:
    app.kubernetes.io/name: tempo
    app.kubernetes.io/part-of: greenlang-observability
    app.kubernetes.io/managed-by: kubectl
    greenlang.io/obs: "003"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: tempo
  policyTypes:
    - Ingress
  ingress:
    # Allow OTel Collector to push traces to Tempo distributor
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: otel-collector
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 4317   # OTLP gRPC
        - protocol: TCP
          port: 4318   # OTLP HTTP
        - protocol: TCP
          port: 14268  # Jaeger thrift HTTP (legacy)

    # Allow Grafana to query traces via Tempo API
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 3200   # Tempo HTTP API (query-frontend)
        - protocol: TCP
          port: 9095   # Tempo gRPC (query path)

    # Allow Prometheus to scrape Tempo metrics
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 3200   # /metrics endpoint

    # Allow internal communication between Tempo components
    # (memberlist gossip ring and inter-component gRPC)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: tempo
      ports:
        - protocol: TCP
          port: 7946   # Memberlist gossip
        - protocol: UDP
          port: 7946   # Memberlist gossip (UDP)
        - protocol: TCP
          port: 9095   # gRPC inter-component
        - protocol: TCP
          port: 3200   # HTTP (gateway -> components)

---
# ---------------------------------------------------------------------------
# Tempo components - egress rules
# ---------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tempo-egress
  namespace: monitoring
  labels:
    app.kubernetes.io/name: tempo
    app.kubernetes.io/part-of: greenlang-observability
    app.kubernetes.io/managed-by: kubectl
    greenlang.io/obs: "003"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: tempo
  policyTypes:
    - Egress
  egress:
    # Allow egress to S3 (HTTPS) for trace block storage
    # S3 uses HTTPS on port 443. We allow 0.0.0.0/0 because AWS S3
    # endpoints resolve to dynamic IP ranges.
    - ports:
        - protocol: TCP
          port: 443

    # Allow internal communication between Tempo components
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: tempo
      ports:
        - protocol: TCP
          port: 7946   # Memberlist gossip
        - protocol: UDP
          port: 7946   # Memberlist gossip (UDP)
        - protocol: TCP
          port: 9095   # gRPC inter-component
        - protocol: TCP
          port: 3200   # HTTP (gateway -> read/write)

    # Allow DNS resolution (kube-dns / CoreDNS)
    - ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
