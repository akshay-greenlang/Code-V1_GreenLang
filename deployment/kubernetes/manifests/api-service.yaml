---
# LoadBalancer service for external access to API
apiVersion: v1
kind: Service
metadata:
  name: greenlang-api-lb
  namespace: greenlang
  labels:
    app: greenlang
    component: api
    tier: frontend
  annotations:
    # AWS Load Balancer annotations
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout: "300"
    # Replace with actual AWS ACM certificate ARN
    # Example: arn:aws:acm:us-east-1:123456789012:certificate/abc12345-1234-1234-1234-abc123456789
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "${AWS_ACM_CERTIFICATE_ARN}"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    # Health check annotations
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "8080"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/health"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "10"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "5"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
  ports:
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
  selector:
    app: greenlang
    component: executor
  externalTrafficPolicy: Local  # Preserve source IP

---
# ClusterIP service for internal communication
apiVersion: v1
kind: Service
metadata:
  name: greenlang-api
  namespace: greenlang
  labels:
    app: greenlang
    component: api
    tier: frontend
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: grpc
      port: 9000
      targetPort: 9000
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: greenlang
    component: executor

---
# NodePort service for direct node access (useful for testing)
apiVersion: v1
kind: Service
metadata:
  name: greenlang-api-nodeport
  namespace: greenlang
  labels:
    app: greenlang
    component: api
    tier: frontend
spec:
  type: NodePort
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      nodePort: 30080
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      nodePort: 30090
      protocol: TCP
  selector:
    app: greenlang
    component: executor

---
# Headless service for StatefulSet DNS (if needed)
apiVersion: v1
kind: Service
metadata:
  name: greenlang-api-headless
  namespace: greenlang
  labels:
    app: greenlang
    component: api
    tier: frontend
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app: greenlang
    component: executor

---
# Metrics service for Prometheus scraping
apiVersion: v1
kind: Service
metadata:
  name: greenlang-metrics
  namespace: greenlang
  labels:
    app: greenlang
    component: metrics
spec:
  type: ClusterIP
  ports:
    - name: executor-metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
    - name: worker-metrics
      port: 9091
      targetPort: 9090
      protocol: TCP
    - name: redis-metrics
      port: 9121
      targetPort: 9121
      protocol: TCP
  selector:
    app: greenlang

---
# Service for WebSocket connections (if needed)
apiVersion: v1
kind: Service
metadata:
  name: greenlang-websocket
  namespace: greenlang
  labels:
    app: greenlang
    component: websocket
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout: "3600"
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
  ports:
    - name: ws
      port: 8081
      targetPort: 8081
      protocol: TCP
  selector:
    app: greenlang
    component: executor
