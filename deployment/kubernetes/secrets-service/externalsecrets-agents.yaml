##############################################
# GreenLang Agent Factory External Secrets
# SEC-006: Phase 3 - ESO Integration
# Secrets for agent-factory service
##############################################

---
# PostgreSQL Credentials for Agent Factory
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-factory-postgresql
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agent-factory-postgresql
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database
    service: agent-factory
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: agent-factory-postgresql
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: agent-factory-postgresql
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Standard PostgreSQL environment variables
        PGUSER: "{{ .username }}"
        PGPASSWORD: "{{ .password }}"
        PGHOST: "{{ .host }}"
        PGPORT: "{{ .port }}"
        PGDATABASE: "{{ .database }}"
        PGSSLMODE: "require"
        # Full connection string
        DATABASE_URL: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode=require"
        # Async connection string for asyncpg
        DATABASE_URL_ASYNC: "postgresql+asyncpg://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?ssl=require"

  data:
    - secretKey: username
      remoteRef:
        key: secret/data/greenlang/agents/database
        property: username

    - secretKey: password
      remoteRef:
        key: secret/data/greenlang/agents/database
        property: password

    - secretKey: host
      remoteRef:
        key: secret/data/greenlang/agents/database
        property: host

    - secretKey: port
      remoteRef:
        key: secret/data/greenlang/agents/database
        property: port

    - secretKey: database
      remoteRef:
        key: secret/data/greenlang/agents/database
        property: database

---
# S3 Credentials for Agent Artifacts
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-factory-s3
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agent-factory-s3
    app.kubernetes.io/component: storage-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: storage
    service: agent-factory
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: agent-factory-s3
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: agent-factory-s3
          app.kubernetes.io/component: storage-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # AWS credentials
        AWS_ACCESS_KEY_ID: "{{ .access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ .secret_key }}"
        AWS_DEFAULT_REGION: "{{ .region | default \"us-east-1\" }}"
        # S3 bucket configuration
        S3_BUCKET_ARTIFACTS: "{{ .artifacts_bucket }}"
        S3_BUCKET_MODELS: "{{ .models_bucket }}"
        S3_BUCKET_LOGS: "{{ .logs_bucket }}"
        # S3 endpoint (for S3-compatible storage or localstack)
        S3_ENDPOINT_URL: "{{ .endpoint_url }}"

  data:
    - secretKey: access_key
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: access_key

    - secretKey: secret_key
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: secret_key

    - secretKey: region
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: region

    - secretKey: artifacts_bucket
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: artifacts_bucket

    - secretKey: models_bucket
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: models_bucket

    - secretKey: logs_bucket
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: logs_bucket

    - secretKey: endpoint_url
      remoteRef:
        key: secret/data/greenlang/agents/s3
        property: endpoint_url

---
# Agent Pack Signing Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-factory-signing-keys
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agent-factory-signing-keys
    app.kubernetes.io/component: signing-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: signing
    service: agent-factory
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: agent-factory-signing-keys
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: agent-factory-signing-keys
          app.kubernetes.io/component: signing-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Ed25519 signing key for agent packs
        PACK_SIGNING_PRIVATE_KEY: "{{ .private_key }}"
        PACK_SIGNING_PUBLIC_KEY: "{{ .public_key }}"
        # Key ID for rotation support
        PACK_SIGNING_KEY_ID: "{{ .key_id }}"
        # Previous public keys for verification (JSON array)
        PACK_SIGNING_PREVIOUS_KEYS: "{{ .previous_keys | default \"[]\" }}"

  data:
    - secretKey: private_key
      remoteRef:
        key: secret/data/greenlang/agents/signing
        property: private_key

    - secretKey: public_key
      remoteRef:
        key: secret/data/greenlang/agents/signing
        property: public_key

    - secretKey: key_id
      remoteRef:
        key: secret/data/greenlang/agents/signing
        property: key_id

    - secretKey: previous_keys
      remoteRef:
        key: secret/data/greenlang/agents/signing
        property: previous_keys

---
# Transit Key Access for Agent Encryption
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-factory-transit
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agent-factory-transit
    app.kubernetes.io/component: encryption-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: encryption
    service: agent-factory
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-transit
    kind: ClusterSecretStore

  target:
    name: agent-factory-transit
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: agent-factory-transit
          app.kubernetes.io/component: encryption-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Vault transit configuration
        VAULT_TRANSIT_KEY: "agent-encryption"
        VAULT_TRANSIT_MOUNT: "transit"
        VAULT_ADDR: "https://vault.vault.svc.cluster.local:8200"
        # Token for transit operations (use Kubernetes auth in practice)
        # VAULT_TOKEN: "{{ .token }}"

  data: []  # Transit key is accessed via Vault API, not stored as secret

---
# LLM API Keys for Agents
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-factory-llm-keys
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agent-factory-llm-keys
    app.kubernetes.io/component: llm-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: api-keys
    service: agent-factory
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: agent-factory-llm-keys
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: agent-factory-llm-keys
          app.kubernetes.io/component: llm-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # OpenAI
        OPENAI_API_KEY: "{{ .openai_api_key }}"
        OPENAI_ORG_ID: "{{ .openai_org_id }}"
        # Anthropic
        ANTHROPIC_API_KEY: "{{ .anthropic_api_key }}"
        # Azure OpenAI
        AZURE_OPENAI_API_KEY: "{{ .azure_openai_api_key }}"
        AZURE_OPENAI_ENDPOINT: "{{ .azure_openai_endpoint }}"
        AZURE_OPENAI_API_VERSION: "{{ .azure_openai_api_version | default \"2024-02-01\" }}"
        # Cohere
        COHERE_API_KEY: "{{ .cohere_api_key }}"

  data:
    - secretKey: openai_api_key
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: openai_api_key

    - secretKey: openai_org_id
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: openai_org_id

    - secretKey: anthropic_api_key
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: anthropic_api_key

    - secretKey: azure_openai_api_key
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: azure_openai_api_key

    - secretKey: azure_openai_endpoint
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: azure_openai_endpoint

    - secretKey: azure_openai_api_version
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: azure_openai_api_version

    - secretKey: cohere_api_key
      remoteRef:
        key: secret/data/greenlang/agents/llm
        property: cohere_api_key

---
# Combined Agent Factory Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-factory-all-secrets
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agent-factory-all-secrets
    app.kubernetes.io/component: combined-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: combined
    service: agent-factory
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: agent-factory-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: agent-factory-secrets
          app.kubernetes.io/component: combined-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"

  dataFrom:
    - extract:
        key: secret/data/greenlang/agents/database
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "DB_$1"

    - extract:
        key: secret/data/greenlang/agents/s3
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "S3_$1"

    - extract:
        key: secret/data/greenlang/agents/llm
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "LLM_$1"
