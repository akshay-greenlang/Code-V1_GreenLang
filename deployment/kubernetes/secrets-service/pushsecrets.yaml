##############################################
# GreenLang PushSecrets Configuration
# SEC-006: Phase 3 - ESO Integration
# Push application-generated secrets to Vault
##############################################

---
# PushSecret for Application-Generated API Tokens
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: push-generated-tokens
  namespace: greenlang
  labels:
    app.kubernetes.io/name: push-generated-tokens
    app.kubernetes.io/component: push-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  # Refresh interval for syncing
  refreshInterval: 1m

  # Secret store to push to
  secretStoreRefs:
    - name: vault-backend
      kind: ClusterSecretStore

  # Selector for source secrets
  selector:
    secret:
      name: greenlang-generated-tokens

  # Data to push
  data:
    # Push service account tokens
    - match:
        secretKey: service-account-tokens
        remoteRef:
          remoteKey: secret/data/greenlang/generated/service-tokens
          property: tokens

    # Push API gateway tokens
    - match:
        secretKey: api-gateway-tokens
        remoteRef:
          remoteKey: secret/data/greenlang/generated/api-gateway-tokens
          property: tokens

  # Update policy
  updatePolicy: Replace

  # Deletion policy (what to do when PushSecret is deleted)
  deletionPolicy: Delete

---
# PushSecret for Certificate Renewal Sync
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: push-renewed-certificates
  namespace: greenlang
  labels:
    app.kubernetes.io/name: push-renewed-certificates
    app.kubernetes.io/component: push-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 5m

  secretStoreRefs:
    - name: vault-backend
      kind: ClusterSecretStore

  # Selector for cert-manager generated certificates
  selector:
    secret:
      name: greenlang-tls

  data:
    # Push TLS certificate
    - match:
        secretKey: tls.crt
        remoteRef:
          remoteKey: secret/data/greenlang/certificates/tls
          property: certificate

    # Push TLS private key
    - match:
        secretKey: tls.key
        remoteRef:
          remoteKey: secret/data/greenlang/certificates/tls
          property: private_key

    # Push CA certificate
    - match:
        secretKey: ca.crt
        remoteRef:
          remoteKey: secret/data/greenlang/certificates/tls
          property: ca_certificate

  updatePolicy: Replace
  deletionPolicy: None  # Keep certificates in Vault even if K8s secret is deleted

---
# PushSecret for mTLS Client Certificates
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: push-mtls-certificates
  namespace: greenlang
  labels:
    app.kubernetes.io/name: push-mtls-certificates
    app.kubernetes.io/component: push-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 5m

  secretStoreRefs:
    - name: vault-backend
      kind: ClusterSecretStore

  selector:
    secret:
      name: greenlang-mtls-client

  data:
    - match:
        secretKey: tls.crt
        remoteRef:
          remoteKey: secret/data/greenlang/certificates/mtls-client
          property: certificate

    - match:
        secretKey: tls.key
        remoteRef:
          remoteKey: secret/data/greenlang/certificates/mtls-client
          property: private_key

  updatePolicy: Replace
  deletionPolicy: None

---
# PushSecret for Dynamically Generated Encryption Keys
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: push-encryption-keys
  namespace: greenlang
  labels:
    app.kubernetes.io/name: push-encryption-keys
    app.kubernetes.io/component: push-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 1m

  secretStoreRefs:
    - name: vault-backend
      kind: ClusterSecretStore

  selector:
    secret:
      name: greenlang-data-keys

  data:
    # Data encryption key (DEK)
    - match:
        secretKey: data-encryption-key
        remoteRef:
          remoteKey: secret/data/greenlang/generated/data-keys
          property: dek

    # Key encryption key reference
    - match:
        secretKey: key-encryption-key-id
        remoteRef:
          remoteKey: secret/data/greenlang/generated/data-keys
          property: kek_id

  updatePolicy: Replace
  deletionPolicy: Delete

---
# PushSecret for Agent Factory Generated Signing Keys
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: push-agent-signing-keys
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: push-agent-signing-keys
    app.kubernetes.io/component: push-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 5m

  secretStoreRefs:
    - name: vault-backend
      kind: ClusterSecretStore

  selector:
    secret:
      name: agent-pack-signing-keys

  data:
    # New pack signing public key (when rotated)
    - match:
        secretKey: public-key
        remoteRef:
          remoteKey: secret/data/greenlang/agents/signing/current
          property: public_key

    # Key metadata
    - match:
        secretKey: key-id
        remoteRef:
          remoteKey: secret/data/greenlang/agents/signing/current
          property: key_id

  updatePolicy: Replace
  deletionPolicy: None

---
# Source Secret Template (for application to generate tokens)
apiVersion: v1
kind: Secret
metadata:
  name: greenlang-generated-tokens
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-generated-tokens
    app.kubernetes.io/component: generated-secrets
    app.kubernetes.io/part-of: greenlang
  annotations:
    description: "Application-generated tokens to be pushed to Vault"
type: Opaque
stringData:
  # Placeholder - application will update these
  service-account-tokens: "{}"
  api-gateway-tokens: "{}"

---
# Source Secret for Data Keys
apiVersion: v1
kind: Secret
metadata:
  name: greenlang-data-keys
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-data-keys
    app.kubernetes.io/component: generated-secrets
    app.kubernetes.io/part-of: greenlang
  annotations:
    description: "Data encryption keys generated by key management service"
type: Opaque
stringData:
  # Placeholder - key management service will update these
  data-encryption-key: ""
  key-encryption-key-id: ""
