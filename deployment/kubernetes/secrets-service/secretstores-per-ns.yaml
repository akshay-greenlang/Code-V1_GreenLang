##############################################
# GreenLang Namespace-Scoped SecretStores
# SEC-006: Phase 3 - ESO Integration
# Per-namespace SecretStores for isolation
##############################################

---
# SecretStore for greenlang namespace (main application)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-greenlang
  namespace: greenlang
  labels:
    app.kubernetes.io/name: vault-greenlang
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
spec:
  # Retry configuration
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "greenlang-app"
          serviceAccountRef:
            name: "greenlang-vault-auth"

      timeout: "30s"

---
# Service Account for greenlang namespace Vault auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: greenlang-vault-auth
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-vault-auth
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang

---
# SecretStore for monitoring namespace
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-monitoring
  namespace: monitoring
  labels:
    app.kubernetes.io/name: vault-monitoring
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
spec:
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "monitoring"
          serviceAccountRef:
            name: "monitoring-vault-auth"

      timeout: "30s"

---
# Service Account for monitoring namespace Vault auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: monitoring-vault-auth
  namespace: monitoring
  labels:
    app.kubernetes.io/name: monitoring-vault-auth
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang

---
# SecretStore for logging namespace
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-logging
  namespace: logging
  labels:
    app.kubernetes.io/name: vault-logging
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
spec:
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "logging"
          serviceAccountRef:
            name: "logging-vault-auth"

      timeout: "30s"

---
# Service Account for logging namespace Vault auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: logging-vault-auth
  namespace: logging
  labels:
    app.kubernetes.io/name: logging-vault-auth
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang

---
# SecretStore for greenlang-agents namespace
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-agents
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: vault-agents
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
spec:
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "greenlang-agents"
          serviceAccountRef:
            name: "agents-vault-auth"

      timeout: "30s"

---
# Service Account for greenlang-agents namespace Vault auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: agents-vault-auth
  namespace: greenlang-agents
  labels:
    app.kubernetes.io/name: agents-vault-auth
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang

---
# SecretStore for ingress-nginx namespace
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-ingress
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: vault-ingress
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
spec:
  retrySettings:
    maxRetries: 3
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "ingress"
          serviceAccountRef:
            name: "ingress-vault-auth"

      timeout: "30s"

---
# Service Account for ingress-nginx namespace Vault auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress-vault-auth
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-vault-auth
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang

---
# SecretStore for cert-manager namespace
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-certmanager
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: vault-certmanager
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
spec:
  retrySettings:
    maxRetries: 3
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "pki_int"
      version: "v1"

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "cert-manager"
          serviceAccountRef:
            name: "certmanager-vault-auth"

      timeout: "30s"

---
# Service Account for cert-manager namespace Vault auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: certmanager-vault-auth
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: certmanager-vault-auth
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: greenlang

---
# External Secrets for Monitoring namespace (Grafana, Prometheus, etc.)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: monitoring-grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: monitoring-grafana
    app.kubernetes.io/component: monitoring-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: vault-monitoring
    kind: SecretStore

  target:
    name: grafana-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        admin-user: "{{ .admin_user }}"
        admin-password: "{{ .admin_password }}"
        # SMTP for alerting
        smtp-user: "{{ .smtp_user }}"
        smtp-password: "{{ .smtp_password }}"
        # OAuth for SSO
        oauth-client-id: "{{ .oauth_client_id }}"
        oauth-client-secret: "{{ .oauth_client_secret }}"

  data:
    - secretKey: admin_user
      remoteRef:
        key: secret/data/greenlang/monitoring/grafana
        property: admin_user

    - secretKey: admin_password
      remoteRef:
        key: secret/data/greenlang/monitoring/grafana
        property: admin_password

    - secretKey: smtp_user
      remoteRef:
        key: secret/data/greenlang/monitoring/grafana
        property: smtp_user

    - secretKey: smtp_password
      remoteRef:
        key: secret/data/greenlang/monitoring/grafana
        property: smtp_password

    - secretKey: oauth_client_id
      remoteRef:
        key: secret/data/greenlang/monitoring/grafana
        property: oauth_client_id

    - secretKey: oauth_client_secret
      remoteRef:
        key: secret/data/greenlang/monitoring/grafana
        property: oauth_client_secret

---
# External Secrets for Logging namespace (Loki, etc.)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: logging-loki-s3
  namespace: logging
  labels:
    app.kubernetes.io/name: logging-loki-s3
    app.kubernetes.io/component: logging-secrets
    app.kubernetes.io/part-of: greenlang
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: vault-logging
    kind: SecretStore

  target:
    name: loki-s3-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        AWS_ACCESS_KEY_ID: "{{ .access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ .secret_key }}"
        S3_BUCKET: "{{ .bucket }}"
        S3_REGION: "{{ .region }}"

  data:
    - secretKey: access_key
      remoteRef:
        key: secret/data/greenlang/logging/s3
        property: access_key

    - secretKey: secret_key
      remoteRef:
        key: secret/data/greenlang/logging/s3
        property: secret_key

    - secretKey: bucket
      remoteRef:
        key: secret/data/greenlang/logging/s3
        property: bucket

    - secretKey: region
      remoteRef:
        key: secret/data/greenlang/logging/s3
        property: region
