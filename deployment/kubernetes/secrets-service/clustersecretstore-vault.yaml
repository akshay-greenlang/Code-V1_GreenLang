##############################################
# GreenLang ClusterSecretStore - Vault Backend
# SEC-006: Phase 3 - ESO Integration with HashiCorp Vault
##############################################

---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
  labels:
    app.kubernetes.io/name: vault-backend
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
  annotations:
    description: "Primary Vault backend for GreenLang secrets"
    security.greenlang.io/classification: "critical"
spec:
  # Retry configuration for resilience
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"

  provider:
    vault:
      # Vault server address
      server: "https://vault.vault.svc.cluster.local:8200"

      # Vault namespace (for Vault Enterprise, leave empty for OSS)
      # namespace: "greenlang"

      # API version for KV secrets engine
      version: "v2"

      # Default path for kv-v2 secrets
      path: "secret"

      # TLS configuration
      caBundle: ""  # Base64 encoded CA bundle, or use caProvider
      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      # Kubernetes authentication
      auth:
        kubernetes:
          # Vault auth path
          mountPath: "kubernetes"

          # Kubernetes auth role (uses ESO service account)
          role: "external-secrets-operator"

          # Service account for authentication
          serviceAccountRef:
            name: "external-secrets-vault-auth"
            namespace: "external-secrets"

          # Secret containing the service account token (optional, uses projected token if not set)
          # secretRef:
          #   name: "vault-auth-token"
          #   key: "token"

      # Connection timeout
      timeout: "30s"

      # Read your writes consistency (Vault Enterprise feature)
      # readYourWrites: true

      # Forward inconsistent reads to active node
      # forwardInconsistent: true

---
# ClusterSecretStore for Vault Database Secrets Engine
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-database
  labels:
    app.kubernetes.io/name: vault-database
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
  annotations:
    description: "Vault Database secrets engine for dynamic credentials"
spec:
  retrySettings:
    maxRetries: 5
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "database"
      version: "v1"  # Database engine uses v1 API

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets-database"
          serviceAccountRef:
            name: "external-secrets-vault-auth"
            namespace: "external-secrets"

      timeout: "30s"

---
# ClusterSecretStore for Vault Transit Secrets Engine
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-transit
  labels:
    app.kubernetes.io/name: vault-transit
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
  annotations:
    description: "Vault Transit secrets engine for encryption operations"
spec:
  retrySettings:
    maxRetries: 3
    retryInterval: "5s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "transit"
      version: "v1"  # Transit engine uses v1 API

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets-transit"
          serviceAccountRef:
            name: "external-secrets-vault-auth"
            namespace: "external-secrets"

      timeout: "15s"

---
# ClusterSecretStore for Vault PKI Secrets Engine
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-pki
  labels:
    app.kubernetes.io/name: vault-pki
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: greenlang
    app.kubernetes.io/managed-by: external-secrets
  annotations:
    description: "Vault PKI secrets engine for certificate management"
spec:
  retrySettings:
    maxRetries: 3
    retryInterval: "10s"

  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "pki_int"
      version: "v1"  # PKI engine uses v1 API

      caProvider:
        type: "Secret"
        name: "vault-tls"
        namespace: "vault"
        key: "ca.crt"

      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets-pki"
          serviceAccountRef:
            name: "external-secrets-vault-auth"
            namespace: "external-secrets"

      timeout: "30s"

---
# Service Account for ESO Vault authentication
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-vault-auth
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: vault-auth
    app.kubernetes.io/part-of: greenlang
  annotations:
    # IRSA annotation for AWS authentication (backup auth method)
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-external-secrets-vault

---
# RBAC for ESO to use the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets-vault-auth
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: vault-auth
    app.kubernetes.io/part-of: greenlang
rules:
  - apiGroups: [""]
    resources: ["serviceaccounts/token"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets-vault-auth
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: vault-auth
    app.kubernetes.io/part-of: greenlang
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-secrets-vault-auth
subjects:
  - kind: ServiceAccount
    name: external-secrets
    namespace: external-secrets
