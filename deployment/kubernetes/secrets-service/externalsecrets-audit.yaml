##############################################
# GreenLang Audit Service External Secrets
# SEC-006: Phase 3 - ESO Integration
# Secrets for audit-service
##############################################

---
# PostgreSQL Credentials for Audit Service
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: audit-service-postgresql
  namespace: greenlang
  labels:
    app.kubernetes.io/name: audit-service-postgresql
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database
    service: audit-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: audit-service-postgresql
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: audit-service-postgresql
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          # Audit secrets require special handling
          security.greenlang.io/audit-required: "true"
      data:
        # Standard PostgreSQL environment variables
        PGUSER: "{{ .username }}"
        PGPASSWORD: "{{ .password }}"
        PGHOST: "{{ .host }}"
        PGPORT: "{{ .port }}"
        PGDATABASE: "{{ .database }}"
        PGSSLMODE: "require"
        # Full connection string
        DATABASE_URL: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode=require"
        # TimescaleDB-specific connection string
        TIMESCALE_URL: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode=require&options=-c%20timezone%3DUTC"

  data:
    - secretKey: username
      remoteRef:
        key: secret/data/greenlang/audit/database
        property: username

    - secretKey: password
      remoteRef:
        key: secret/data/greenlang/audit/database
        property: password

    - secretKey: host
      remoteRef:
        key: secret/data/greenlang/audit/database
        property: host

    - secretKey: port
      remoteRef:
        key: secret/data/greenlang/audit/database
        property: port

    - secretKey: database
      remoteRef:
        key: secret/data/greenlang/audit/database
        property: database

---
# S3 Credentials for Audit Log Archival
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: audit-service-s3
  namespace: greenlang
  labels:
    app.kubernetes.io/name: audit-service-s3
    app.kubernetes.io/component: storage-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: storage
    service: audit-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: audit-service-s3
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: audit-service-s3
          app.kubernetes.io/component: storage-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          security.greenlang.io/audit-required: "true"
      data:
        # AWS credentials for audit log archival
        AWS_ACCESS_KEY_ID: "{{ .access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ .secret_key }}"
        AWS_DEFAULT_REGION: "{{ .region | default \"us-east-1\" }}"
        # S3 bucket for audit logs (with Object Lock enabled)
        S3_AUDIT_BUCKET: "{{ .audit_bucket }}"
        S3_AUDIT_PREFIX: "{{ .audit_prefix | default \"audit-logs\" }}"
        # S3 bucket for compliance reports
        S3_COMPLIANCE_BUCKET: "{{ .compliance_bucket }}"
        # Glacier archive bucket
        S3_ARCHIVE_BUCKET: "{{ .archive_bucket }}"
        # KMS key for S3 encryption
        S3_KMS_KEY_ID: "{{ .kms_key_id }}"

  data:
    - secretKey: access_key
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: access_key

    - secretKey: secret_key
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: secret_key

    - secretKey: region
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: region

    - secretKey: audit_bucket
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: audit_bucket

    - secretKey: audit_prefix
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: audit_prefix

    - secretKey: compliance_bucket
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: compliance_bucket

    - secretKey: archive_bucket
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: archive_bucket

    - secretKey: kms_key_id
      remoteRef:
        key: secret/data/greenlang/audit/s3
        property: kms_key_id

---
# PII Encryption Key for Audit Service
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: audit-service-pii-encryption
  namespace: greenlang
  labels:
    app.kubernetes.io/name: audit-service-pii-encryption
    app.kubernetes.io/component: encryption-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: encryption
    service: audit-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: audit-service-pii-encryption
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: audit-service-pii-encryption
          app.kubernetes.io/component: encryption-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          security.greenlang.io/pii-key: "true"
          security.greenlang.io/audit-required: "true"
      data:
        # AES-256-GCM key for PII encryption at rest
        PII_ENCRYPTION_KEY: "{{ .encryption_key }}"
        # Key ID for rotation support
        PII_KEY_ID: "{{ .key_id }}"
        # Previous keys for decryption during rotation (JSON array)
        PII_PREVIOUS_KEYS: "{{ .previous_keys | default \"[]\" }}"
        # HMAC key for PII hashing (for searching encrypted fields)
        PII_HMAC_KEY: "{{ .hmac_key }}"

  data:
    - secretKey: encryption_key
      remoteRef:
        key: secret/data/greenlang/audit/pii-encryption
        property: encryption_key

    - secretKey: key_id
      remoteRef:
        key: secret/data/greenlang/audit/pii-encryption
        property: key_id

    - secretKey: previous_keys
      remoteRef:
        key: secret/data/greenlang/audit/pii-encryption
        property: previous_keys

    - secretKey: hmac_key
      remoteRef:
        key: secret/data/greenlang/audit/pii-encryption
        property: hmac_key

---
# Audit Service SIEM Integration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: audit-service-siem
  namespace: greenlang
  labels:
    app.kubernetes.io/name: audit-service-siem
    app.kubernetes.io/component: siem-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: integration
    service: audit-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: audit-service-siem
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: audit-service-siem
          app.kubernetes.io/component: siem-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Splunk HEC token
        SPLUNK_HEC_TOKEN: "{{ .splunk_hec_token }}"
        SPLUNK_HEC_URL: "{{ .splunk_hec_url }}"
        # Datadog API key
        DATADOG_API_KEY: "{{ .datadog_api_key }}"
        DATADOG_APP_KEY: "{{ .datadog_app_key }}"
        # AWS Security Hub
        SECURITY_HUB_ENABLED: "{{ .security_hub_enabled | default \"true\" }}"

  data:
    - secretKey: splunk_hec_token
      remoteRef:
        key: secret/data/greenlang/audit/siem
        property: splunk_hec_token

    - secretKey: splunk_hec_url
      remoteRef:
        key: secret/data/greenlang/audit/siem
        property: splunk_hec_url

    - secretKey: datadog_api_key
      remoteRef:
        key: secret/data/greenlang/audit/siem
        property: datadog_api_key

    - secretKey: datadog_app_key
      remoteRef:
        key: secret/data/greenlang/audit/siem
        property: datadog_app_key

    - secretKey: security_hub_enabled
      remoteRef:
        key: secret/data/greenlang/audit/siem
        property: security_hub_enabled

---
# Combined Audit Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: audit-service-all-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: audit-service-all-secrets
    app.kubernetes.io/component: combined-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: combined
    service: audit-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: audit-service-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: audit-service-secrets
          app.kubernetes.io/component: combined-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          security.greenlang.io/audit-required: "true"

  dataFrom:
    - extract:
        key: secret/data/greenlang/audit/database
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "DB_$1"

    - extract:
        key: secret/data/greenlang/audit/s3
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "S3_$1"

    - extract:
        key: secret/data/greenlang/audit/pii-encryption
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "PII_$1"
