##############################################
# GreenLang API External Secrets
# SEC-006: Phase 3 - ESO Integration
# Secrets for greenlang-api service
##############################################

---
# PostgreSQL Credentials for GreenLang API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: greenlang-api-postgresql
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api-postgresql
    app.kubernetes.io/component: database-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: database
    service: greenlang-api
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: greenlang-api-postgresql
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: greenlang-api-postgresql
          app.kubernetes.io/component: database-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Standard PostgreSQL environment variables
        PGUSER: "{{ .username }}"
        PGPASSWORD: "{{ .password }}"
        PGHOST: "{{ .host }}"
        PGPORT: "{{ .port }}"
        PGDATABASE: "{{ .database }}"
        PGSSLMODE: "{{ .sslmode | default \"require\" }}"
        # Full connection string for applications
        DATABASE_URL: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode={{ .sslmode | default \"require\" }}"
        # Async connection string for asyncpg
        DATABASE_URL_ASYNC: "postgresql+asyncpg://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?ssl=require"
        # SQLAlchemy format
        SQLALCHEMY_DATABASE_URI: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode={{ .sslmode | default \"require\" }}"

  data:
    - secretKey: username
      remoteRef:
        key: secret/data/greenlang/database/postgresql
        property: username

    - secretKey: password
      remoteRef:
        key: secret/data/greenlang/database/postgresql
        property: password

    - secretKey: host
      remoteRef:
        key: secret/data/greenlang/database/postgresql
        property: host

    - secretKey: port
      remoteRef:
        key: secret/data/greenlang/database/postgresql
        property: port

    - secretKey: database
      remoteRef:
        key: secret/data/greenlang/database/postgresql
        property: database

    - secretKey: sslmode
      remoteRef:
        key: secret/data/greenlang/database/postgresql
        property: sslmode

---
# Redis Credentials for GreenLang API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: greenlang-api-redis
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api-redis
    app.kubernetes.io/component: cache-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: cache
    service: greenlang-api
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: greenlang-api-redis
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: greenlang-api-redis
          app.kubernetes.io/component: cache-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Redis connection parameters
        REDIS_HOST: "{{ .host }}"
        REDIS_PORT: "{{ .port }}"
        REDIS_PASSWORD: "{{ .password }}"
        REDIS_DB: "{{ .database | default \"0\" }}"
        REDIS_SSL: "{{ .ssl | default \"true\" }}"
        # Full Redis URL
        REDIS_URL: "rediss://:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database | default \"0\" }}"
        # Celery broker URL
        CELERY_BROKER_URL: "rediss://:{{ .password }}@{{ .host }}:{{ .port }}/1"
        CELERY_RESULT_BACKEND: "rediss://:{{ .password }}@{{ .host }}:{{ .port }}/2"

  data:
    - secretKey: host
      remoteRef:
        key: secret/data/greenlang/database/redis
        property: host

    - secretKey: port
      remoteRef:
        key: secret/data/greenlang/database/redis
        property: port

    - secretKey: password
      remoteRef:
        key: secret/data/greenlang/database/redis
        property: password

    - secretKey: database
      remoteRef:
        key: secret/data/greenlang/database/redis
        property: database

    - secretKey: ssl
      remoteRef:
        key: secret/data/greenlang/database/redis
        property: ssl

---
# JWT Signing Keys for GreenLang API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: greenlang-api-jwt-keys
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api-jwt-keys
    app.kubernetes.io/component: auth-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: authentication
    service: greenlang-api
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: greenlang-api-jwt-keys
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: greenlang-api-jwt-keys
          app.kubernetes.io/component: auth-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # RSA key pair for JWT signing (RS256)
        JWT_PRIVATE_KEY: "{{ .private_key }}"
        JWT_PUBLIC_KEY: "{{ .public_key }}"
        # Key ID for key rotation support
        JWT_KEY_ID: "{{ .key_id }}"
        # Algorithm configuration
        JWT_ALGORITHM: "RS256"
        # Token expiry settings
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "{{ .access_token_expire_minutes | default \"15\" }}"
        JWT_REFRESH_TOKEN_EXPIRE_DAYS: "{{ .refresh_token_expire_days | default \"7\" }}"

  data:
    - secretKey: private_key
      remoteRef:
        key: secret/data/greenlang/auth/jwt
        property: private_key

    - secretKey: public_key
      remoteRef:
        key: secret/data/greenlang/auth/jwt
        property: public_key

    - secretKey: key_id
      remoteRef:
        key: secret/data/greenlang/auth/jwt
        property: key_id

    - secretKey: access_token_expire_minutes
      remoteRef:
        key: secret/data/greenlang/auth/jwt
        property: access_token_expire_minutes

    - secretKey: refresh_token_expire_days
      remoteRef:
        key: secret/data/greenlang/auth/jwt
        property: refresh_token_expire_days

---
# Internal API Keys for GreenLang API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: greenlang-api-internal-keys
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api-internal-keys
    app.kubernetes.io/component: api-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: api-keys
    service: greenlang-api
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: greenlang-api-internal-keys
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: greenlang-api-internal-keys
          app.kubernetes.io/component: api-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Internal service-to-service API key
        INTERNAL_API_KEY: "{{ .internal_api_key }}"
        # Webhook signing secret
        WEBHOOK_SECRET: "{{ .webhook_secret }}"
        # Admin API key (for internal admin operations)
        ADMIN_API_KEY: "{{ .admin_api_key }}"
        # Service mesh authentication token
        SERVICE_MESH_TOKEN: "{{ .service_mesh_token }}"

  data:
    - secretKey: internal_api_key
      remoteRef:
        key: secret/data/greenlang/api-keys/internal
        property: internal_api_key

    - secretKey: webhook_secret
      remoteRef:
        key: secret/data/greenlang/api-keys/internal
        property: webhook_secret

    - secretKey: admin_api_key
      remoteRef:
        key: secret/data/greenlang/api-keys/internal
        property: admin_api_key

    - secretKey: service_mesh_token
      remoteRef:
        key: secret/data/greenlang/api-keys/internal
        property: service_mesh_token

---
# Combined API Secrets (for applications that need all secrets in one mount)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: greenlang-api-all-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: greenlang-api-all-secrets
    app.kubernetes.io/component: combined-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: combined
    service: greenlang-api
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: greenlang-api-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: greenlang-api-secrets
          app.kubernetes.io/component: combined-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Database
        DATABASE_URL: "postgresql://{{ .db_username }}:{{ .db_password }}@{{ .db_host }}:{{ .db_port }}/{{ .db_database }}?sslmode=require"
        # Redis
        REDIS_URL: "rediss://:{{ .redis_password }}@{{ .redis_host }}:{{ .redis_port }}/0"
        # JWT
        JWT_PRIVATE_KEY: "{{ .jwt_private_key }}"
        JWT_PUBLIC_KEY: "{{ .jwt_public_key }}"
        # API Keys
        INTERNAL_API_KEY: "{{ .internal_api_key }}"
        WEBHOOK_SECRET: "{{ .webhook_secret }}"

  dataFrom:
    - extract:
        key: secret/data/greenlang/database/postgresql
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "db_$1"

    - extract:
        key: secret/data/greenlang/database/redis
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "redis_$1"

    - extract:
        key: secret/data/greenlang/auth/jwt
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "jwt_$1"

    - extract:
        key: secret/data/greenlang/api-keys/internal
        conversionStrategy: Default
        decodingStrategy: None
