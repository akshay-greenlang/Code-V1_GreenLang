##############################################
# GreenLang Auth Service External Secrets
# SEC-006: Phase 3 - ESO Integration
# Secrets for authentication and authorization
##############################################

---
# JWT Signing Keys (RS256)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-jwt-signing
  namespace: greenlang
  labels:
    app.kubernetes.io/name: auth-service-jwt-signing
    app.kubernetes.io/component: jwt-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: signing
    service: auth-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: auth-service-jwt-signing
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: auth-service-jwt-signing
          app.kubernetes.io/component: jwt-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          security.greenlang.io/key-rotation: "enabled"
      data:
        # RSA-2048 private key for JWT signing (RS256)
        JWT_PRIVATE_KEY: "{{ .private_key }}"
        # RSA-2048 public key for JWT verification
        JWT_PUBLIC_KEY: "{{ .public_key }}"
        # Key ID (kid) for JWKS
        JWT_KEY_ID: "{{ .key_id }}"
        # Previous public keys for verification during rotation (JSON array)
        JWT_PREVIOUS_PUBLIC_KEYS: "{{ .previous_public_keys | default \"[]\" }}"
        # Algorithm
        JWT_ALGORITHM: "RS256"
        # Token configuration
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "{{ .access_token_expire_minutes | default \"15\" }}"
        JWT_REFRESH_TOKEN_EXPIRE_DAYS: "{{ .refresh_token_expire_days | default \"7\" }}"
        JWT_ISSUER: "{{ .issuer | default \"https://auth.greenlang.io\" }}"
        JWT_AUDIENCE: "{{ .audience | default \"greenlang-api\" }}"

  data:
    - secretKey: private_key
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: private_key

    - secretKey: public_key
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: public_key

    - secretKey: key_id
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: key_id

    - secretKey: previous_public_keys
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: previous_public_keys

    - secretKey: access_token_expire_minutes
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: access_token_expire_minutes

    - secretKey: refresh_token_expire_days
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: refresh_token_expire_days

    - secretKey: issuer
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: issuer

    - secretKey: audience
      remoteRef:
        key: secret/data/greenlang/auth/jwt-signing
        property: audience

---
# Refresh Token Encryption Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-refresh-token
  namespace: greenlang
  labels:
    app.kubernetes.io/name: auth-service-refresh-token
    app.kubernetes.io/component: encryption-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: encryption
    service: auth-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: auth-service-refresh-token
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: auth-service-refresh-token
          app.kubernetes.io/component: encryption-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          security.greenlang.io/key-rotation: "enabled"
      data:
        # AES-256-GCM key for refresh token encryption at rest
        REFRESH_TOKEN_ENCRYPTION_KEY: "{{ .encryption_key }}"
        # Key ID for rotation support
        REFRESH_TOKEN_KEY_ID: "{{ .key_id }}"
        # Previous keys for decryption during rotation (JSON array)
        REFRESH_TOKEN_PREVIOUS_KEYS: "{{ .previous_keys | default \"[]\" }}"
        # Refresh token signing key (HMAC-SHA256)
        REFRESH_TOKEN_SIGNING_KEY: "{{ .signing_key }}"

  data:
    - secretKey: encryption_key
      remoteRef:
        key: secret/data/greenlang/auth/refresh-token
        property: encryption_key

    - secretKey: key_id
      remoteRef:
        key: secret/data/greenlang/auth/refresh-token
        property: key_id

    - secretKey: previous_keys
      remoteRef:
        key: secret/data/greenlang/auth/refresh-token
        property: previous_keys

    - secretKey: signing_key
      remoteRef:
        key: secret/data/greenlang/auth/refresh-token
        property: signing_key

---
# Password Hashing Pepper
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-password-pepper
  namespace: greenlang
  labels:
    app.kubernetes.io/name: auth-service-password-pepper
    app.kubernetes.io/component: hashing-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: hashing
    service: auth-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: auth-service-password-pepper
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: auth-service-password-pepper
          app.kubernetes.io/component: hashing-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
          # Password pepper should NEVER be rotated after initial deployment
          security.greenlang.io/immutable: "true"
      data:
        # Password pepper (application-level secret added to password before hashing)
        PASSWORD_PEPPER: "{{ .pepper }}"
        # Pepper ID (for future rotation support)
        PASSWORD_PEPPER_ID: "{{ .pepper_id }}"
        # Argon2 configuration
        PASSWORD_HASH_ALGORITHM: "argon2id"
        PASSWORD_HASH_TIME_COST: "{{ .time_cost | default \"3\" }}"
        PASSWORD_HASH_MEMORY_COST: "{{ .memory_cost | default \"65536\" }}"
        PASSWORD_HASH_PARALLELISM: "{{ .parallelism | default \"4\" }}"

  data:
    - secretKey: pepper
      remoteRef:
        key: secret/data/greenlang/auth/password-pepper
        property: pepper

    - secretKey: pepper_id
      remoteRef:
        key: secret/data/greenlang/auth/password-pepper
        property: pepper_id

    - secretKey: time_cost
      remoteRef:
        key: secret/data/greenlang/auth/password-pepper
        property: time_cost

    - secretKey: memory_cost
      remoteRef:
        key: secret/data/greenlang/auth/password-pepper
        property: memory_cost

    - secretKey: parallelism
      remoteRef:
        key: secret/data/greenlang/auth/password-pepper
        property: parallelism

---
# OIDC Client Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-oidc-clients
  namespace: greenlang
  labels:
    app.kubernetes.io/name: auth-service-oidc-clients
    app.kubernetes.io/component: oidc-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: oidc
    service: auth-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: auth-service-oidc-clients
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: auth-service-oidc-clients
          app.kubernetes.io/component: oidc-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Google OAuth
        GOOGLE_CLIENT_ID: "{{ .google_client_id }}"
        GOOGLE_CLIENT_SECRET: "{{ .google_client_secret }}"
        # Microsoft Azure AD
        AZURE_AD_CLIENT_ID: "{{ .azure_ad_client_id }}"
        AZURE_AD_CLIENT_SECRET: "{{ .azure_ad_client_secret }}"
        AZURE_AD_TENANT_ID: "{{ .azure_ad_tenant_id }}"
        # GitHub OAuth
        GITHUB_CLIENT_ID: "{{ .github_client_id }}"
        GITHUB_CLIENT_SECRET: "{{ .github_client_secret }}"
        # Okta
        OKTA_CLIENT_ID: "{{ .okta_client_id }}"
        OKTA_CLIENT_SECRET: "{{ .okta_client_secret }}"
        OKTA_ISSUER: "{{ .okta_issuer }}"

  data:
    # Google
    - secretKey: google_client_id
      remoteRef:
        key: secret/data/greenlang/auth/oidc/google
        property: client_id

    - secretKey: google_client_secret
      remoteRef:
        key: secret/data/greenlang/auth/oidc/google
        property: client_secret

    # Azure AD
    - secretKey: azure_ad_client_id
      remoteRef:
        key: secret/data/greenlang/auth/oidc/azure-ad
        property: client_id

    - secretKey: azure_ad_client_secret
      remoteRef:
        key: secret/data/greenlang/auth/oidc/azure-ad
        property: client_secret

    - secretKey: azure_ad_tenant_id
      remoteRef:
        key: secret/data/greenlang/auth/oidc/azure-ad
        property: tenant_id

    # GitHub
    - secretKey: github_client_id
      remoteRef:
        key: secret/data/greenlang/auth/oidc/github
        property: client_id

    - secretKey: github_client_secret
      remoteRef:
        key: secret/data/greenlang/auth/oidc/github
        property: client_secret

    # Okta
    - secretKey: okta_client_id
      remoteRef:
        key: secret/data/greenlang/auth/oidc/okta
        property: client_id

    - secretKey: okta_client_secret
      remoteRef:
        key: secret/data/greenlang/auth/oidc/okta
        property: client_secret

    - secretKey: okta_issuer
      remoteRef:
        key: secret/data/greenlang/auth/oidc/okta
        property: issuer

---
# Session Encryption Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-session
  namespace: greenlang
  labels:
    app.kubernetes.io/name: auth-service-session
    app.kubernetes.io/component: session-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: session
    service: auth-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: auth-service-session
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: auth-service-session
          app.kubernetes.io/component: session-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"
      data:
        # Session encryption key (AES-256-GCM)
        SESSION_ENCRYPTION_KEY: "{{ .encryption_key }}"
        # Session signing key (HMAC-SHA256)
        SESSION_SIGNING_KEY: "{{ .signing_key }}"
        # Session secret for cookie signing
        SESSION_SECRET: "{{ .session_secret }}"
        # CSRF token key
        CSRF_SECRET_KEY: "{{ .csrf_secret }}"

  data:
    - secretKey: encryption_key
      remoteRef:
        key: secret/data/greenlang/auth/session
        property: encryption_key

    - secretKey: signing_key
      remoteRef:
        key: secret/data/greenlang/auth/session
        property: signing_key

    - secretKey: session_secret
      remoteRef:
        key: secret/data/greenlang/auth/session
        property: session_secret

    - secretKey: csrf_secret
      remoteRef:
        key: secret/data/greenlang/auth/session
        property: csrf_secret

---
# Combined Auth Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-all-secrets
  namespace: greenlang
  labels:
    app.kubernetes.io/name: auth-service-all-secrets
    app.kubernetes.io/component: combined-secrets
    app.kubernetes.io/part-of: greenlang
    secret-type: combined
    service: auth-service
spec:
  refreshInterval: 30s

  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: auth-service-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: auth-service-secrets
          app.kubernetes.io/component: combined-secrets
          app.kubernetes.io/part-of: greenlang
        annotations:
          reloader.stakater.com/match: "true"

  dataFrom:
    - extract:
        key: secret/data/greenlang/auth/jwt-signing
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "JWT_$1"

    - extract:
        key: secret/data/greenlang/auth/refresh-token
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "REFRESH_$1"

    - extract:
        key: secret/data/greenlang/auth/session
        conversionStrategy: Default
        decodingStrategy: None
      rewrite:
        - regexp:
            source: "(.*)"
            target: "SESSION_$1"
