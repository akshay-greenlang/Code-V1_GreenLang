# ============================================================================
# GreenLang Agent Factory - Prometheus Stack Helm Values
# ============================================================================
# Helm values for prometheus-community/kube-prometheus-stack
# Chart Version: 55.x (latest stable)
#
# Installation Command:
#   helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
#   helm repo update
#   helm install prometheus prometheus-community/kube-prometheus-stack \
#     -f prometheus-values.yaml \
#     --namespace monitoring \
#     --create-namespace
#
# Created: 2025-12-03
# Team: Monitoring & Observability
# ============================================================================

# Global settings
fullnameOverride: "prometheus"
namespaceOverride: "monitoring"

# ============================================================================
# Prometheus Operator Configuration
# ============================================================================

prometheusOperator:
  enabled: true

  # Resource allocation
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Pod security
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534

  # Admission webhooks
  admissionWebhooks:
    enabled: true
    patch:
      enabled: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi

# ============================================================================
# Prometheus Server Configuration
# ============================================================================

prometheus:
  enabled: true

  prometheusSpec:
    # Scrape configuration
    scrapeInterval: "15s"
    scrapeTimeout: "10s"
    evaluationInterval: "15s"

    # Retention settings
    retention: "30d"
    retentionSize: "90GB"

    # Storage configuration - 100GB persistent volume
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: standard
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 100Gi

    # Resource allocation
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    # Replicas for HA
    replicas: 2

    # Pod anti-affinity for HA
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - prometheus
              topologyKey: kubernetes.io/hostname

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534

    # Enable service discovery from all namespaces
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false

    # ServiceMonitor and PodMonitor selectors
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
    podMonitorSelector: {}
    podMonitorNamespaceSelector: {}

    # Additional scrape configs for agent metrics
    additionalScrapeConfigs:
      # GreenLang Agents scrape config
      - job_name: 'greenlang-agents'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - greenlang
                - gl-fuel
                - gl-cbam
                - gl-building
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name

    # External labels for federation
    externalLabels:
      cluster: greenlang-agent-factory
      environment: production

    # Enable remote write for long-term storage (optional)
    # remoteWrite:
    #   - url: "https://thanos-receive.example.com/api/v1/receive"

  # Ingress for Prometheus UI
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - prometheus.greenlang.ai
    tls:
      - secretName: prometheus-tls
        hosts:
          - prometheus.greenlang.ai

# ============================================================================
# Alertmanager Configuration
# ============================================================================

alertmanager:
  enabled: true

  alertmanagerSpec:
    # Storage
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: standard
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

    # Resources
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Replicas for HA
    replicas: 2

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534

  # Alertmanager configuration
  config:
    global:
      resolve_timeout: 5m
      slack_api_url: '${SLACK_WEBHOOK_URL}'

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'default-receiver'
      routes:
        # Critical alerts go to PagerDuty and Slack
        - match:
            severity: critical
          receiver: 'critical-alerts'
          continue: true

        # Warning alerts go to Slack only
        - match:
            severity: warning
          receiver: 'warning-alerts'

        # Agent-specific alerts
        - match_re:
            alertname: ^Agent.*
          receiver: 'agent-alerts'
          group_by: ['agent_id', 'alertname']

    receivers:
      - name: 'default-receiver'
        slack_configs:
          - channel: '#greenlang-alerts'
            send_resolved: true
            title: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
              *Cluster:* {{ .Labels.cluster }}
              {{ end }}

      - name: 'critical-alerts'
        slack_configs:
          - channel: '#greenlang-critical'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
            title: '[CRITICAL] {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Service:* {{ .Labels.service }}
              *Runbook:* {{ .Annotations.runbook_url }}
              {{ end }}
        # Uncomment for PagerDuty integration
        # pagerduty_configs:
        #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
        #     severity: critical

      - name: 'warning-alerts'
        slack_configs:
          - channel: '#greenlang-alerts'
            send_resolved: true
            color: 'warning'
            title: '[WARNING] {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

      - name: 'agent-alerts'
        slack_configs:
          - channel: '#greenlang-agent-alerts'
            send_resolved: true
            title: '[{{ .Status | toUpper }}] Agent Alert: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Agent:* {{ .Labels.agent_id }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

    inhibit_rules:
      # Inhibit warning when critical is firing for same alertname
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'cluster', 'service']

  # Ingress for Alertmanager UI
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - alertmanager.greenlang.ai

# ============================================================================
# Grafana Configuration
# ============================================================================

grafana:
  enabled: true

  # Admin credentials
  adminUser: admin
  # adminPassword should be set via secret
  adminPassword: "" # Will be overridden by existingSecret

  # Use existing secret for admin password
  # Create secret: kubectl create secret generic grafana-admin --from-literal=admin-password=YOUR_PASSWORD -n monitoring
  admin:
    existingSecret: "grafana-admin"
    userKey: admin-user
    passwordKey: admin-password

  # Persistence
  persistence:
    enabled: true
    storageClassName: standard
    accessModes:
      - ReadWriteOnce
    size: 10Gi

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 472
    fsGroup: 472

  # Grafana configuration
  grafana.ini:
    server:
      root_url: https://grafana.greenlang.ai
    security:
      admin_user: admin
      disable_gravatar: true
    auth:
      disable_login_form: false
    auth.anonymous:
      enabled: false
    users:
      allow_sign_up: false
    dashboards:
      default_home_dashboard_path: /var/lib/grafana/dashboards/agent-factory-overview.json
    alerting:
      enabled: true
      execute_alerts: true

  # Sidecar for dashboard provisioning
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      folder: /var/lib/grafana/dashboards
      searchNamespace: ALL
    datasources:
      enabled: true
      label: grafana_datasource
      labelValue: "1"

  # Default data sources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-prometheus:9090
          access: proxy
          isDefault: true
          editable: false
        - name: Alertmanager
          type: alertmanager
          url: http://prometheus-alertmanager:9093
          access: proxy
          editable: false

  # Ingress for Grafana
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - grafana.greenlang.ai
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.greenlang.ai

# ============================================================================
# Node Exporter Configuration
# ============================================================================

nodeExporter:
  enabled: true

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# ============================================================================
# Kube State Metrics Configuration
# ============================================================================

kubeStateMetrics:
  enabled: true

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ============================================================================
# Prometheus Rules (Default Rules)
# ============================================================================

defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # Disable if using managed K8s
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: false  # Disable if using managed K8s
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: false  # Disable if using managed K8s
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
