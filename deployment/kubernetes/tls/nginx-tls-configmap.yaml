# =============================================================================
# NGINX Ingress Controller TLS Configuration
# SEC-004: TLS 1.3 Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-tls-config
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: greenlang
    greenlang.io/component: sec-004
data:
  # TLS Protocol Configuration
  ssl-protocols: "TLSv1.2 TLSv1.3"

  # Modern cipher suites (TLS 1.3 + secure TLS 1.2)
  ssl-ciphers: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"

  # Prefer server ciphers over client
  ssl-prefer-server-ciphers: "true"

  # SSL session configuration for performance
  ssl-session-cache: "shared:SSL:50m"
  ssl-session-timeout: "1d"
  ssl-session-tickets: "false"

  # HSTS configuration
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  hsts-preload: "true"

  # Force SSL redirect
  ssl-redirect: "true"
  force-ssl-redirect: "true"

  # OCSP Stapling
  enable-ocsp: "true"

  # Security headers
  add-headers: "ingress-nginx/custom-headers"

  # Proxy SSL settings for backend connections
  proxy-ssl-protocols: "TLSv1.2 TLSv1.3"
  proxy-ssl-ciphers: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
  proxy-ssl-verify: "on"
  proxy-ssl-verify-depth: "2"

  # Buffer sizes for TLS
  proxy-buffer-size: "16k"
  proxy-buffers-number: "4"

  # Connection keepalive
  keep-alive: "75"
  keep-alive-requests: "1000"

  # Enable HTTP/2
  use-http2: "true"

  # Disable insecure features
  server-tokens: "false"
---
# Custom security headers
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-headers
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: greenlang
    greenlang.io/component: sec-004
data:
  X-Frame-Options: "DENY"
  X-Content-Type-Options: "nosniff"
  X-XSS-Protection: "1; mode=block"
  Referrer-Policy: "strict-origin-when-cross-origin"
  Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'"
  Permissions-Policy: "geolocation=(), microphone=(), camera=()"
