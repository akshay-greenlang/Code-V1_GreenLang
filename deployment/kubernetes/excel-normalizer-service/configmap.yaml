# =============================================================================
# GreenLang Excel & CSV Normalizer - ConfigMap
# =============================================================================
# Configuration for file format handling, encoding detection, column mapping
# strategies, normalization settings, data quality thresholds, transform
# operations, template management, caching, and metrics.
# PRD: AGENT-DATA-002
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: excel-normalizer-service-config
  namespace: greenlang
  labels:
    app.kubernetes.io/name: excel-normalizer-service
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: greenlang
  annotations:
    description: "Excel Normalizer configuration - format handling, encoding detection, column mapping, normalization, quality thresholds, transforms"
    prd: AGENT-DATA-002
data:
  # Environment
  ENVIRONMENT: "production"

  # Logging
  GL_EXCEL_NORMALIZER_LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"

  # Database (connection string via secret, schema config here)
  GL_EXCEL_NORMALIZER_DB_SCHEMA: "excel_normalizer_service"
  GL_EXCEL_NORMALIZER_DB_POOL_MIN: "2"
  GL_EXCEL_NORMALIZER_DB_POOL_MAX: "10"

  # Redis
  GL_EXCEL_NORMALIZER_REDIS_PREFIX: "gl:excel_normalizer:"
  GL_EXCEL_NORMALIZER_REDIS_TTL: "300"

  # Cache Configuration
  GL_EXCEL_NORMALIZER_CACHE_TTL_SECONDS: "300"
  GL_EXCEL_NORMALIZER_CACHE_MAX_SIZE: "2000"
  GL_EXCEL_NORMALIZER_TEMPLATE_CACHE_TTL: "600"

  # File Format Configuration
  GL_EXCEL_NORMALIZER_MAX_FILE_SIZE_MB: "50"
  GL_EXCEL_NORMALIZER_MAX_ROWS_PER_SHEET: "1000000"
  GL_EXCEL_NORMALIZER_MAX_COLUMNS_PER_SHEET: "1000"
  GL_EXCEL_NORMALIZER_MAX_SHEETS_PER_FILE: "50"

  # Encoding Detection
  GL_EXCEL_NORMALIZER_DEFAULT_ENCODING: "utf-8"
  GL_EXCEL_NORMALIZER_ENCODING_DETECTION_ENABLED: "true"
  GL_EXCEL_NORMALIZER_ENCODING_CONFIDENCE_THRESHOLD: "0.7"

  # Column Mapping Configuration
  GL_EXCEL_NORMALIZER_DEFAULT_MAPPING_STRATEGY: "synonym"
  GL_EXCEL_NORMALIZER_MIN_MAPPING_CONFIDENCE: "0.5"
  GL_EXCEL_NORMALIZER_FUZZY_MATCH_THRESHOLD: "0.8"

  # Normalization Configuration
  GL_EXCEL_NORMALIZER_BATCH_SIZE: "1000"
  GL_EXCEL_NORMALIZER_MAX_CONCURRENT_JOBS: "5"
  GL_EXCEL_NORMALIZER_JOB_TIMEOUT_SECONDS: "600"
  GL_EXCEL_NORMALIZER_SKIP_INVALID_ROWS: "false"

  # Data Quality Configuration
  GL_EXCEL_NORMALIZER_QUALITY_THRESHOLD: "0.5"
  GL_EXCEL_NORMALIZER_COMPLETENESS_WEIGHT: "0.4"
  GL_EXCEL_NORMALIZER_ACCURACY_WEIGHT: "0.35"
  GL_EXCEL_NORMALIZER_CONSISTENCY_WEIGHT: "0.25"

  # Metrics
  GL_EXCEL_NORMALIZER_ENABLE_METRICS: "true"
  METRICS_PORT: "8080"
  METRICS_PATH: "/metrics"

  # Tracing
  TRACING_ENABLED: "true"
  TRACING_SAMPLE_RATE: "0.1"
  OTEL_ENDPOINT: "http://otel-collector.monitoring.svc.cluster.local:4317"
  OTEL_SERVICE_NAME: "excel-normalizer-service"

  # Excel normalizer service configuration file
  excel-normalizer-config.yaml: |
    excel_normalizer_service:
      version: "1.0.0"
      environment: production

      file_formats:
        supported:
          - xlsx
          - xls
          - csv
          - tsv
          - ods
        max_file_size_mb: 50
        max_rows_per_sheet: 1000000
        max_columns_per_sheet: 1000
        max_sheets_per_file: 50

      encoding:
        default: utf-8
        detection_enabled: true
        confidence_threshold: 0.7
        supported_encodings:
          - utf-8
          - utf-16
          - ascii
          - iso-8859-1
          - windows-1252
          - shift_jis
          - gb2312
          - big5
          - latin-1

      delimiter_detection:
        enabled: true
        candidates:
          - ","
          - "\t"
          - ";"
          - "|"

      column_mapping:
        default_strategy: synonym
        min_confidence: 0.5
        fuzzy_match_threshold: 0.8
        strategies:
          exact:
            enabled: true
          synonym:
            enabled: true
            dictionary_path: /app/config/synonyms.json
          fuzzy:
            enabled: true
            algorithm: levenshtein
          ml:
            enabled: false
            model_path: /app/models/column_classifier
          template:
            enabled: true
          regex:
            enabled: true

      normalization:
        batch_size: 1000
        max_concurrent_jobs: 5
        job_timeout_seconds: 600
        skip_invalid_rows: false
        quality_threshold: 0.5

      data_quality:
        completeness_weight: 0.4
        accuracy_weight: 0.35
        consistency_weight: 0.25
        quality_levels:
          excellent: 0.95
          good: 0.85
          acceptable: 0.70
          poor: 0.50
          critical: 0.0

      validation:
        cross_column_rules: true
        severity_levels:
          - error
          - warning
          - info

      source_types:
        - generic
        - utility_bill
        - emissions_report
        - fuel_log
        - travel_log
        - waste_manifest
        - energy_audit
        - fleet_data
        - procurement
        - supply_chain
        - refrigerant_log

      cache:
        ttl_seconds: 300
        max_size: 2000
        template_cache_ttl: 600
        warmup_on_startup: true

      metrics:
        enabled: true
        prefix: gl_excel_normalizer
        histogram_buckets: [0.01, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10, 30, 60, 120]

      integration:
        auth_enabled: true
        audit_enabled: true
        alerting_enabled: true
        feature_flags_enabled: true
        access_guard_enabled: true
        agent_registry_enabled: true
        unit_normalizer_enabled: true
        citations_enabled: true
