#------------------------------------------------------------------------------
# S3 Event Processor AWS Credentials - External Secrets
# GreenLang Kubernetes Infrastructure
#
# This file defines an ExternalSecret that fetches AWS credentials from
# AWS Secrets Manager. In production, use IRSA (IAM Roles for Service Accounts)
# instead of long-lived credentials.
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# External Secret for AWS Credentials
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: s3-event-processor-aws-credentials
  namespace: greenlang-storage
  labels:
    app: s3-event-processor
    component: secrets
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: s3-event-processor-aws-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app: s3-event-processor
          component: secrets
      data:
        aws_access_key_id: "{{ .aws_access_key_id }}"
        aws_secret_access_key: "{{ .aws_secret_access_key }}"

  data:
    - secretKey: aws_access_key_id
      remoteRef:
        key: greenlang/s3-event-processor/credentials
        property: access_key_id

    - secretKey: aws_secret_access_key
      remoteRef:
        key: greenlang/s3-event-processor/credentials
        property: secret_access_key

---
#------------------------------------------------------------------------------
# Cluster Secret Store for AWS Secrets Manager
#------------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    component: secret-management
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
#------------------------------------------------------------------------------
# Service Account for IRSA (Recommended Production Approach)
#------------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: s3-event-processor-sa
  namespace: greenlang-storage
  annotations:
    # IRSA annotation - replace ACCOUNT_ID with actual AWS account ID
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/greenlang-s3-event-processor-role
    # Optional: Specify the audience for the OIDC token
    eks.amazonaws.com/audience: sts.amazonaws.com
    # Optional: Specify token expiration
    eks.amazonaws.com/token-expiration: "86400"
  labels:
    app: s3-event-processor
    component: service-account

---
#------------------------------------------------------------------------------
# IAM Policy Document for IRSA Role (Reference)
# This should be created via Terraform, included here for documentation
#------------------------------------------------------------------------------
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: irsa-policy-reference
#   namespace: greenlang-storage
#   labels:
#     app: s3-event-processor
#     component: documentation
# data:
#   iam-policy.json: |
#     {
#       "Version": "2012-10-17",
#       "Statement": [
#         {
#           "Sid": "SQSAccess",
#           "Effect": "Allow",
#           "Action": [
#             "sqs:ReceiveMessage",
#             "sqs:DeleteMessage",
#             "sqs:GetQueueAttributes",
#             "sqs:GetQueueUrl",
#             "sqs:ChangeMessageVisibility",
#             "sqs:SendMessage"
#           ],
#           "Resource": [
#             "arn:aws:sqs:us-east-1:ACCOUNT_ID:greenlang-artifact-processing",
#             "arn:aws:sqs:us-east-1:ACCOUNT_ID:greenlang-artifact-processing-dlq",
#             "arn:aws:sqs:us-east-1:ACCOUNT_ID:greenlang-report-indexing",
#             "arn:aws:sqs:us-east-1:ACCOUNT_ID:greenlang-report-indexing-dlq",
#             "arn:aws:sqs:us-east-1:ACCOUNT_ID:greenlang-audit-events",
#             "arn:aws:sqs:us-east-1:ACCOUNT_ID:greenlang-audit-events-dlq"
#           ]
#         },
#         {
#           "Sid": "S3ReadAccess",
#           "Effect": "Allow",
#           "Action": [
#             "s3:GetObject",
#             "s3:GetObjectVersion",
#             "s3:GetObjectTagging",
#             "s3:HeadObject",
#             "s3:ListBucket"
#           ],
#           "Resource": [
#             "arn:aws:s3:::greenlang-*",
#             "arn:aws:s3:::greenlang-*/*"
#           ]
#         },
#         {
#           "Sid": "S3WriteAccess",
#           "Effect": "Allow",
#           "Action": [
#             "s3:PutObject",
#             "s3:PutObjectTagging",
#             "s3:CopyObject",
#             "s3:DeleteObject"
#           ],
#           "Resource": [
#             "arn:aws:s3:::greenlang-*/*"
#           ]
#         },
#         {
#           "Sid": "SNSPublish",
#           "Effect": "Allow",
#           "Action": [
#             "sns:Publish"
#           ],
#           "Resource": [
#             "arn:aws:sns:us-east-1:ACCOUNT_ID:greenlang-*"
#           ]
#         },
#         {
#           "Sid": "KMSDecrypt",
#           "Effect": "Allow",
#           "Action": [
#             "kms:Decrypt",
#             "kms:GenerateDataKey"
#           ],
#           "Resource": [
#             "arn:aws:kms:us-east-1:ACCOUNT_ID:key/*"
#           ],
#           "Condition": {
#             "StringEquals": {
#               "kms:ViaService": [
#                 "sqs.us-east-1.amazonaws.com",
#                 "s3.us-east-1.amazonaws.com"
#               ]
#             }
#           }
#         },
#         {
#           "Sid": "CloudWatchMetrics",
#           "Effect": "Allow",
#           "Action": [
#             "cloudwatch:PutMetricData"
#           ],
#           "Resource": "*",
#           "Condition": {
#             "StringEquals": {
#               "cloudwatch:namespace": "GreenLang/S3Events"
#             }
#           }
#         },
#         {
#           "Sid": "OpenSearchAccess",
#           "Effect": "Allow",
#           "Action": [
#             "es:ESHttpPost",
#             "es:ESHttpPut",
#             "es:ESHttpGet"
#           ],
#           "Resource": [
#             "arn:aws:es:us-east-1:ACCOUNT_ID:domain/greenlang-search/*"
#           ]
#         }
#       ]
#     }
#
#   trust-policy.json: |
#     {
#       "Version": "2012-10-17",
#       "Statement": [
#         {
#           "Effect": "Allow",
#           "Principal": {
#             "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/OIDC_ID"
#           },
#           "Action": "sts:AssumeRoleWithWebIdentity",
#           "Condition": {
#             "StringEquals": {
#               "oidc.eks.us-east-1.amazonaws.com/id/OIDC_ID:sub": "system:serviceaccount:greenlang-storage:s3-event-processor-sa",
#               "oidc.eks.us-east-1.amazonaws.com/id/OIDC_ID:aud": "sts.amazonaws.com"
#             }
#           }
#         }
#       ]
#     }

---
#------------------------------------------------------------------------------
# Sealed Secret Alternative (for GitOps workflows)
#------------------------------------------------------------------------------
# If using Sealed Secrets instead of External Secrets:
#
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: s3-event-processor-aws-credentials
#   namespace: greenlang-storage
#   labels:
#     app: s3-event-processor
#     component: secrets
# spec:
#   encryptedData:
#     aws_access_key_id: AgBy3i4OJSWK+PiTySYZZA9rO43cG...
#     aws_secret_access_key: AgBy3i4OJSWK+PiTySYZZA9rO43cG...
#   template:
#     type: Opaque
#     metadata:
#       labels:
#         app: s3-event-processor
#         component: secrets

---
#------------------------------------------------------------------------------
# Namespace (if not exists)
#------------------------------------------------------------------------------
apiVersion: v1
kind: Namespace
metadata:
  name: greenlang-storage
  labels:
    name: greenlang-storage
    environment: production
    team: platform
