# =============================================================================
# PostgreSQL Logging Configuration
# =============================================================================
# GreenLang Production Logging Settings
# Optimized for: Performance Monitoring, Debugging, Compliance
# Last Updated: 2026-02-03
# =============================================================================

# -----------------------------------------------------------------------------
# LOGGING COLLECTOR
# -----------------------------------------------------------------------------
# Enable logging collector subprocess
logging_collector = on

# Log destination
# Options: stderr, csvlog, jsonlog (PG15+), syslog, eventlog (Windows)
log_destination = 'stderr,csvlog'

# -----------------------------------------------------------------------------
# LOG FILE CONFIGURATION
# -----------------------------------------------------------------------------
# Directory for log files (relative to data directory)
log_directory = 'log'

# Log filename pattern
# Supports strftime escapes
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# File permissions for log files (octal)
log_file_mode = 0600

# Truncate (overwrite) log files of same name
log_truncate_on_rotation = off

# Rotation based on time
log_rotation_age = 1d

# Rotation based on size
log_rotation_size = 100MB

# -----------------------------------------------------------------------------
# WHEN TO LOG
# -----------------------------------------------------------------------------
# Minimum message severity for logging
# Options: DEBUG5-1, INFO, NOTICE, WARNING, ERROR, LOG, FATAL, PANIC
log_min_messages = warning

# Minimum severity for error stack traces
log_min_error_statement = error

# Log statements taking longer than this (in ms)
# Set to 0 to disable, -1 logs all statements
log_min_duration_statement = 1000

# Sample rate for logging statements (0.0-1.0)
# 1.0 = log all statements exceeding threshold
log_min_duration_sample = -1
log_statement_sample_rate = 1.0

# Log transaction sample rate
log_transaction_sample_rate = 0.0

# -----------------------------------------------------------------------------
# WHAT TO LOG
# -----------------------------------------------------------------------------
# Log checkpoints
log_checkpoints = on

# Log connection attempts
log_connections = on

# Log disconnections
log_disconnections = on

# Log duration of completed statements
log_duration = off

# Log hostname in connection logs (DNS lookup overhead)
log_hostname = off

# Log lock wait events
log_lock_waits = on

# Threshold for lock wait logging
deadlock_timeout = 1s

# Log recovery conflict events (standby only)
log_recovery_conflict_waits = on

# Which statements to log
# Options: none, ddl, mod, all
log_statement = 'ddl'

# Log replication commands
log_replication_commands = on

# Log temporary file usage above threshold (0 = all)
log_temp_files = 0

# Log autovacuum activity above threshold (ms)
log_autovacuum_min_duration = 1000

# Log parameter values in BIND messages
log_parameter_max_length = -1
log_parameter_max_length_on_error = 0

# -----------------------------------------------------------------------------
# LOG FORMAT
# -----------------------------------------------------------------------------
# Log line prefix format
# %a = application name
# %u = user name
# %d = database name
# %r = remote host and port
# %h = remote host
# %p = process ID
# %t = timestamp without milliseconds
# %m = timestamp with milliseconds
# %n = timestamp with microseconds
# %i = command tag
# %e = SQL state error code
# %c = session ID
# %l = session line number
# %s = session start timestamp
# %v = virtual transaction ID
# %x = transaction ID (0 if none)
# %q = stop if not in backend
# %% = literal %

# Recommended prefix for production
log_line_prefix = '%m [%p] %q%u@%d '

# Alternative with more detail for debugging
# log_line_prefix = '%m [%p:%l] %q%u@%d/%a [%v:%x] '

# Log timezone
log_timezone = 'UTC'

# -----------------------------------------------------------------------------
# PROCESS TITLE
# -----------------------------------------------------------------------------
# Update process title with current activity
update_process_title = on

# Cluster name in process title
cluster_name = 'greenlang-prod'

# -----------------------------------------------------------------------------
# CSV LOG FORMAT
# -----------------------------------------------------------------------------
# CSV log output includes these columns:
# log_time, user_name, database_name, process_id, connection_from,
# session_id, session_line_num, command_tag, session_start_time,
# virtual_transaction_id, transaction_id, error_severity, sql_state_code,
# message, detail, hint, internal_query, internal_query_pos, context,
# query, query_pos, location, application_name, backend_type,
# leader_pid, query_id

# -----------------------------------------------------------------------------
# SYSLOG CONFIGURATION
# -----------------------------------------------------------------------------
# Syslog facility (if using syslog)
# syslog_facility = 'LOCAL0'

# Syslog program name
# syslog_ident = 'postgres'

# Include sequence numbers in syslog
# syslog_sequence_numbers = on

# Split long syslog messages
# syslog_split_messages = on

# -----------------------------------------------------------------------------
# ERROR VERBOSITY
# -----------------------------------------------------------------------------
# Error message detail level
# Options: TERSE, DEFAULT, VERBOSE
log_error_verbosity = default

# -----------------------------------------------------------------------------
# QUERY LOGGING
# -----------------------------------------------------------------------------
# Log nested statements in functions/triggers
log_nested_statements = off

# Log bind parameter values
# debug_print_parse = off
# debug_print_rewritten = off
# debug_print_plan = off
# debug_pretty_print = on

# -----------------------------------------------------------------------------
# PERFORMANCE LOGGING
# -----------------------------------------------------------------------------
# Auto-explain for slow queries
# shared_preload_libraries = 'auto_explain'
# auto_explain.log_min_duration = '3s'
# auto_explain.log_analyze = on
# auto_explain.log_buffers = on
# auto_explain.log_timing = on
# auto_explain.log_triggers = on
# auto_explain.log_verbose = on
# auto_explain.log_format = 'text'
# auto_explain.log_nested_statements = on
# auto_explain.sample_rate = 1.0

# -----------------------------------------------------------------------------
# LOG ANALYSIS TOOLS
# -----------------------------------------------------------------------------
# Recommended tools for log analysis:
#
# 1. pgBadger - PostgreSQL log analyzer
#    pgbadger -f stderr -o report.html /path/to/postgresql*.log
#
# 2. pg_stat_statements - Query statistics
#    SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 20;
#
# 3. Grafana + Loki - Log aggregation and visualization
#
# 4. ELK Stack - Elasticsearch, Logstash, Kibana

# -----------------------------------------------------------------------------
# LOG ROTATION AND RETENTION
# -----------------------------------------------------------------------------
# External log rotation with logrotate:
#
# /var/log/postgresql/*.log {
#     daily
#     rotate 14
#     copytruncate
#     delaycompress
#     compress
#     notifempty
#     missingok
#     su root root
# }

# Kubernetes logging (stdout/stderr):
# Set log_destination = 'stderr' and logging_collector = off
# Logs are captured by container runtime

# -----------------------------------------------------------------------------
# AUDIT LOGGING
# -----------------------------------------------------------------------------
# For compliance (SOC2, HIPAA, PCI-DSS), consider pgAudit:
#
# shared_preload_libraries = 'pgaudit'
# pgaudit.log = 'all'
# pgaudit.log_catalog = off
# pgaudit.log_client = on
# pgaudit.log_level = 'log'
# pgaudit.log_parameter = on
# pgaudit.log_relation = on
# pgaudit.log_statement_once = off
# pgaudit.role = 'auditor'

# -----------------------------------------------------------------------------
# EXAMPLE LOG QUERIES
# -----------------------------------------------------------------------------
# Parse CSV logs for analysis:
#
# -- Create foreign table for CSV logs
# CREATE EXTENSION file_fdw;
# CREATE SERVER pglog FOREIGN DATA WRAPPER file_fdw;
#
# CREATE FOREIGN TABLE pg_log (
#     log_time timestamp(3) with time zone,
#     user_name text,
#     database_name text,
#     process_id integer,
#     connection_from text,
#     session_id text,
#     session_line_num bigint,
#     command_tag text,
#     session_start_time timestamp with time zone,
#     virtual_transaction_id text,
#     transaction_id bigint,
#     error_severity text,
#     sql_state_code text,
#     message text,
#     detail text,
#     hint text,
#     internal_query text,
#     internal_query_pos integer,
#     context text,
#     query text,
#     query_pos integer,
#     location text,
#     application_name text,
#     backend_type text,
#     leader_pid integer,
#     query_id bigint
# ) SERVER pglog
# OPTIONS (filename '/var/lib/postgresql/data/log/postgresql-2024-01-01.csv', format 'csv');
#
# -- Query slow statements
# SELECT log_time, user_name, database_name, query
# FROM pg_log
# WHERE error_severity = 'LOG'
#   AND message LIKE 'duration:%'
# ORDER BY log_time DESC;

# =============================================================================
# END OF LOGGING CONFIGURATION
# =============================================================================
