; =============================================================================
; GreenLang Climate OS - PgBouncer Configuration
; =============================================================================
; PRD: INFRA-005 Vector Database Infrastructure with pgvector
; Purpose: Connection pooling for vector query workloads
; =============================================================================

[databases]
; Primary database (writer)
greenlang = host=${AURORA_WRITER_ENDPOINT} port=5432 dbname=greenlang

; Read replica (vector search queries)
greenlang_reader = host=${AURORA_READER_ENDPOINT} port=5432 dbname=greenlang

; Vector-specific pool with optimized settings
greenlang_vectors = host=${AURORA_READER_ENDPOINT} port=5432 dbname=greenlang pool_size=30

[pgbouncer]
; Listen settings
listen_addr = 0.0.0.0
listen_port = 6432

; Authentication (SCRAM-SHA-256 per INFRA-002 security requirements)
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

; Pool mode: transaction mode is optimal for pgvector queries
; (releases connection after each transaction)
pool_mode = transaction

; Connection limits
max_client_conn = 1000
default_pool_size = 50
reserve_pool_size = 10
reserve_pool_timeout = 5

; Timeouts
server_idle_timeout = 300
server_connect_timeout = 15
server_login_retry = 15
client_idle_timeout = 0
client_login_timeout = 60
query_timeout = 30
query_wait_timeout = 120

; Logging
log_connections = 0
log_disconnections = 0
log_pooler_errors = 1
stats_period = 60

; TLS settings
server_tls_sslmode = require
server_tls_ca_file = /etc/ssl/certs/rds-combined-ca-bundle.pem

; Admin
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

; DNS
dns_max_ttl = 15

; Application name for monitoring
application_name_add_host = 1

; Prepared statements not supported in transaction mode
; Use server_reset_query to clean up
server_reset_query = DISCARD ALL
server_reset_query_always = 0
