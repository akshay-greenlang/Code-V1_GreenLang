# =============================================================================
# PostgreSQL Performance Tuning Configuration
# =============================================================================
# GreenLang Production Database Configuration
# Optimized for: 32GB RAM, SSD Storage, High-Performance Workloads
# Last Updated: 2026-02-03
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------
# Maximum number of concurrent connections
# Formula: (CPU cores * 2) + effective_spindle_count (for SSD, typically higher)
max_connections = 200

# Reserved connections for superuser (maintenance, emergencies)
superuser_reserved_connections = 3

# Connection timeout for establishing new connections
authentication_timeout = 60s

# TCP keepalive settings for connection health
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 10

# -----------------------------------------------------------------------------
# MEMORY CONFIGURATION
# -----------------------------------------------------------------------------
# Optimized for 32GB RAM instance
# Total RAM: 32GB
# OS Reserve: ~4GB
# Available for PostgreSQL: ~28GB

# Shared memory buffer pool (25% of total RAM)
# Used for caching frequently accessed data pages
shared_buffers = 8GB

# Effective cache size (75% of total RAM)
# Hint to query planner about OS disk cache availability
effective_cache_size = 24GB

# Work memory per operation (sort, hash, etc.)
# Caution: This is per-operation, not per-connection
# Formula: (Total RAM - shared_buffers) / (max_connections * 2)
work_mem = 256MB

# Memory for maintenance operations (VACUUM, CREATE INDEX, etc.)
# Can be set higher as these operations are less frequent
maintenance_work_mem = 2GB

# Enable huge pages for better TLB efficiency
# Requires OS-level configuration (vm.nr_hugepages)
huge_pages = try

# Memory for hash-based operations in autovacuum
autovacuum_work_mem = -1

# Temporary buffer pool for temporary tables
temp_buffers = 64MB

# Maximum memory for prepared transactions
# Set to 0 if not using two-phase commit
max_prepared_transactions = 0

# -----------------------------------------------------------------------------
# WAL (Write-Ahead Log) CONFIGURATION
# -----------------------------------------------------------------------------
# WAL level for replication and point-in-time recovery
# Options: minimal, replica, logical
wal_level = replica

# Shared memory for WAL buffers
# Larger values improve write performance
wal_buffers = 64MB

# WAL compression to reduce I/O
wal_compression = on

# Checkpoint Configuration
# Time between automatic checkpoints
checkpoint_timeout = 15min

# Target for completing checkpoint writes (0.5-0.9)
# Higher values spread writes over longer period
checkpoint_completion_target = 0.9

# Maximum WAL size before forcing checkpoint
max_wal_size = 8GB

# Minimum WAL size to retain
min_wal_size = 2GB

# Enable WAL archiving for PITR and replication
archive_mode = on

# Archive command (customize for your backup solution)
# archive_command = 'cp %p /archive/%f'

# Synchronize WAL writes to disk
fsync = on

# Method for syncing WAL to disk
wal_sync_method = fdatasync

# Full page writes for crash recovery
full_page_writes = on

# Flush WAL pages to disk after this many bytes
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# -----------------------------------------------------------------------------
# QUERY PLANNER CONFIGURATION
# -----------------------------------------------------------------------------
# Cost of random page access vs sequential (1.0 = same cost)
# Lower for SSD storage (1.1-1.5), higher for HDD (4.0)
random_page_cost = 1.1

# Sequential page cost (baseline)
seq_page_cost = 1.0

# CPU cost for processing each row
cpu_tuple_cost = 0.01

# CPU cost for evaluating each index entry
cpu_index_tuple_cost = 0.005

# CPU cost for evaluating each operator/function
cpu_operator_cost = 0.0025

# Concurrent I/O operations for prefetch (SSD: 200, HDD: 2)
effective_io_concurrency = 200

# Statistics target for ANALYZE (higher = more accurate but slower)
default_statistics_target = 100

# Enable genetic query optimizer for complex queries
geqo = on
geqo_threshold = 12

# Join order optimization
from_collapse_limit = 8
join_collapse_limit = 8

# Enable JIT compilation for expensive queries
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# -----------------------------------------------------------------------------
# PARALLEL QUERY CONFIGURATION
# -----------------------------------------------------------------------------
# Maximum workers for parallel gather operations
max_parallel_workers_per_gather = 4

# Maximum parallel workers system-wide
max_parallel_workers = 8

# Maximum workers for parallel maintenance (index builds, etc.)
max_parallel_maintenance_workers = 4

# Allow leader process to participate in parallel query execution
parallel_leader_participation = on

# Minimum table size for parallel scan (8MB default)
min_parallel_table_scan_size = 8MB

# Minimum index size for parallel scan
min_parallel_index_scan_size = 512kB

# Cost threshold for parallel query
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

# Force parallel query for testing (not recommended for production)
# force_parallel_mode = off

# -----------------------------------------------------------------------------
# AUTOVACUUM CONFIGURATION
# -----------------------------------------------------------------------------
# Enable automatic vacuuming
autovacuum = on

# Maximum concurrent autovacuum processes
autovacuum_max_workers = 4

# Time between autovacuum daemon checks
autovacuum_naptime = 30s

# Minimum row changes before triggering vacuum
autovacuum_vacuum_threshold = 50

# Minimum row changes before triggering analyze
autovacuum_analyze_threshold = 50

# Fraction of table that must change for vacuum
# Lower values = more aggressive vacuuming
autovacuum_vacuum_scale_factor = 0.02

# Fraction of table that must change for analyze
autovacuum_analyze_scale_factor = 0.01

# Delay between vacuum operations (throttling)
autovacuum_vacuum_cost_delay = 2ms

# Cost limit before pausing vacuum
autovacuum_vacuum_cost_limit = 1000

# Freeze age thresholds
vacuum_freeze_min_age = 50000000
vacuum_freeze_table_age = 150000000
vacuum_multixact_freeze_min_age = 5000000
vacuum_multixact_freeze_table_age = 150000000

# Autovacuum freeze thresholds
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000

# -----------------------------------------------------------------------------
# BACKGROUND WRITER CONFIGURATION
# -----------------------------------------------------------------------------
# Delay between background writer rounds
bgwriter_delay = 200ms

# Maximum pages to write per round
bgwriter_lru_maxpages = 100

# Multiplier for recent page requests
bgwriter_lru_multiplier = 2.0

# Flush buffers after this many bytes
bgwriter_flush_after = 512kB

# -----------------------------------------------------------------------------
# LOCK MANAGEMENT
# -----------------------------------------------------------------------------
# Time to wait for locks (in milliseconds)
lock_timeout = 0

# Statement timeout (0 = disabled)
statement_timeout = 0

# Idle transaction timeout
idle_in_transaction_session_timeout = 60min

# Deadlock detection interval
deadlock_timeout = 1s

# Maximum number of lock objects
max_locks_per_transaction = 64

# Maximum predicate locks
max_pred_locks_per_transaction = 64
max_pred_locks_per_relation = -2
max_pred_locks_per_page = 2

# -----------------------------------------------------------------------------
# DISK SPACE MANAGEMENT
# -----------------------------------------------------------------------------
# Minimum free space on data disk before refusing writes
# temp_file_limit = -1

# Directory for temporary files
# temp_tablespaces = ''

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------
# Default search path
search_path = '"$user", public'

# Default timezone
timezone = 'UTC'

# Date style
datestyle = 'iso, mdy'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# Byte ordering for comparisons
bytea_output = 'hex'

# =============================================================================
# END OF CONFIGURATION
# =============================================================================
