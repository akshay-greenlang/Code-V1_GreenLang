# =============================================================================
# GreenLang Flyway Database Migration Configuration
# =============================================================================
# This configuration manages schema migrations for the GreenLang platform.
# Supports PostgreSQL with TimescaleDB extension via PgBouncer connection pooling.
# =============================================================================

# -----------------------------------------------------------------------------
# Database Connection (via PgBouncer)
# -----------------------------------------------------------------------------
# Note: Actual values should be provided via environment variables in production
# Format: jdbc:postgresql://host:port/database
flyway.url=${FLYWAY_URL:jdbc:postgresql://pgbouncer.database.svc.cluster.local:6432/greenlang}

# Authentication (use environment variables or secrets in production)
flyway.user=${FLYWAY_USER:greenlang_migrations}
flyway.password=${FLYWAY_PASSWORD}

# Connection pool settings for PgBouncer compatibility
flyway.connectRetries=10
flyway.connectRetriesInterval=5

# -----------------------------------------------------------------------------
# Schema Configuration
# -----------------------------------------------------------------------------
# Schemas to manage (in order of creation/migration)
flyway.schemas=public,metrics,audit

# Default schema for Flyway metadata table
flyway.defaultSchema=public

# Create schemas if they don't exist
flyway.createSchemas=true

# -----------------------------------------------------------------------------
# Migration Locations
# -----------------------------------------------------------------------------
# Multiple locations: local filesystem and S3 for distributed teams
flyway.locations=filesystem:sql,s3:greenlang-migrations/sql

# S3 configuration (when using S3 location)
flyway.s3.accessKey=${AWS_ACCESS_KEY_ID}
flyway.s3.secretKey=${AWS_SECRET_ACCESS_KEY}
flyway.s3.region=${AWS_REGION:us-east-1}

# -----------------------------------------------------------------------------
# Baseline Configuration
# -----------------------------------------------------------------------------
# Enable baseline on migrate for existing databases
flyway.baselineOnMigrate=true

# Baseline version (all migrations below this are ignored)
flyway.baselineVersion=0

# Description for baseline
flyway.baselineDescription=GreenLang initial baseline

# -----------------------------------------------------------------------------
# Validation Configuration
# -----------------------------------------------------------------------------
# Validate migrations on every migrate
flyway.validateOnMigrate=true

# Validate migration naming convention
flyway.validateMigrationNaming=true

# Fail if migration checksums differ
flyway.cleanOnValidationError=false

# -----------------------------------------------------------------------------
# Migration Execution
# -----------------------------------------------------------------------------
# IMPORTANT: Out of order migrations disabled for production safety
flyway.outOfOrder=false

# Allow mixed migrations (versioned + repeatable)
flyway.mixed=true

# Group all pending migrations in a single transaction
flyway.group=false

# Lock retry count for concurrent migrations
flyway.lockRetryCount=50

# -----------------------------------------------------------------------------
# Naming Conventions
# -----------------------------------------------------------------------------
# Versioned migration prefix
flyway.sqlMigrationPrefix=V

# Repeatable migration prefix
flyway.repeatableSqlMigrationPrefix=R

# Undo migration prefix (Flyway Teams)
flyway.undoSqlMigrationPrefix=U

# Migration separator
flyway.sqlMigrationSeparator=__

# Migration suffixes
flyway.sqlMigrationSuffixes=.sql

# -----------------------------------------------------------------------------
# Encoding and Formatting
# -----------------------------------------------------------------------------
flyway.encoding=UTF-8

# Placeholder configuration
flyway.placeholderReplacement=true
flyway.placeholderPrefix=${
flyway.placeholderSuffix=}

# -----------------------------------------------------------------------------
# Placeholders (Environment-specific values)
# -----------------------------------------------------------------------------
flyway.placeholders.environment=${ENVIRONMENT:development}
flyway.placeholders.retention_days=${RETENTION_DAYS:90}
flyway.placeholders.compression_after_days=${COMPRESSION_AFTER_DAYS:7}
flyway.placeholders.chunk_interval=${CHUNK_INTERVAL:1 day}
flyway.placeholders.replication_factor=${REPLICATION_FACTOR:1}

# -----------------------------------------------------------------------------
# Callbacks (for pre/post migration hooks)
# -----------------------------------------------------------------------------
# flyway.callbacks=com.greenlang.migrations.AuditCallback

# -----------------------------------------------------------------------------
# Error Handling
# -----------------------------------------------------------------------------
# Treat warnings as errors
flyway.failOnMissingLocations=true

# Clean disabled in production (safety measure)
flyway.cleanDisabled=true

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
# Output format for migration info
flyway.outputType=json

# -----------------------------------------------------------------------------
# TimescaleDB Specific Settings
# -----------------------------------------------------------------------------
# These are passed as placeholders to SQL migrations
flyway.placeholders.timescaledb_version=2.11
flyway.placeholders.default_chunk_time_interval=86400000000
flyway.placeholders.compression_segmentby=organization_id
flyway.placeholders.compression_orderby=timestamp DESC

# -----------------------------------------------------------------------------
# Teams/Enterprise Features (if licensed)
# -----------------------------------------------------------------------------
# flyway.licenseKey=${FLYWAY_LICENSE_KEY}
# flyway.stream=true
# flyway.batch=true
# flyway.cherryPick=
# flyway.dryRunOutput=

# -----------------------------------------------------------------------------
# Java Migrations (if using programmatic migrations)
# -----------------------------------------------------------------------------
# flyway.jarDirs=jars
