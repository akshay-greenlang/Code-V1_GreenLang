# =============================================================================
# Redis Production Configuration
# =============================================================================
# Complete production-ready configuration with all optimizations
# Priority: Security, reliability, performance, observability
# Use case: Production deployments requiring all features
# =============================================================================

# -----------------------------------------------------------------------------
# INCLUDES
# -----------------------------------------------------------------------------
# Include other configuration files (useful for environment-specific settings)
# include /etc/redis/local.conf

# -----------------------------------------------------------------------------
# NETWORK CONFIGURATION
# -----------------------------------------------------------------------------

# Bind to all interfaces (use network policies for security)
bind 0.0.0.0

# Default Redis port
port 6379

# TLS/SSL Configuration (uncomment for encrypted connections)
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-auth-clients optional
# tls-replication yes
# tls-cluster yes
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-ciphers "ECDHE+AESGCM:DHE+AESGCM:ECDHE+CHACHA20:DHE+CHACHA20"
# tls-prefer-server-ciphers yes

# TCP settings
tcp-keepalive 300
timeout 0
tcp-backlog 511
tcp-nodelay yes

# Maximum clients
maxclients 10000

# Unix socket (optional, for local connections)
# unixsocket /var/run/redis/redis.sock
# unixsocketperm 700

# -----------------------------------------------------------------------------
# SECURITY CONFIGURATION
# -----------------------------------------------------------------------------

# Protected mode - enabled for security
protected-mode yes

# Require password for all operations
requirepass ${REDIS_PASSWORD}

# Master password for replication
masterauth ${REDIS_PASSWORD}

# ACL Configuration
# aclfile /etc/redis/users.acl

# Default user permissions
# user default off

# Application user with limited permissions
# user greenlang-app on >${REDIS_APP_PASSWORD} ~greenlang:* +@read +@write -@dangerous

# Admin user with full access
# user admin on >${REDIS_ADMIN_PASSWORD} ~* &* +@all

# Rename dangerous commands
rename-command FLUSHALL "FLUSHALL_${RANDOM_SUFFIX}"
rename-command FLUSHDB "FLUSHDB_${RANDOM_SUFFIX}"
rename-command DEBUG ""
rename-command CONFIG "CONFIG_${RANDOM_SUFFIX}"
rename-command SHUTDOWN "SHUTDOWN_${RANDOM_SUFFIX}"
rename-command SLAVEOF ""
rename-command REPLICAOF ""

# Disable KEYS command in production (use SCAN instead)
rename-command KEYS "KEYS_${RANDOM_SUFFIX}"

# -----------------------------------------------------------------------------
# MEMORY CONFIGURATION
# -----------------------------------------------------------------------------

# Maximum memory
maxmemory 8gb

# Eviction policy
maxmemory-policy volatile-lru

# LRU samples
maxmemory-samples 10

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25
active-defrag-max-scan-fields 1000

# Jemalloc background thread
jemalloc-bg-thread yes

# OOM score adjustment
oom-score-adj no
oom-score-adj-values 0 200 800

# -----------------------------------------------------------------------------
# PERSISTENCE CONFIGURATION (HYBRID)
# -----------------------------------------------------------------------------

# RDB Configuration
save 900 1
save 300 10
save 60 10000

dbfilename dump.rdb
dir /data

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
sanitize-dump-payload clients

# AOF Configuration
appendonly yes
appendfilename "appendonly.aof"
appenddirname "appendonlydir"

# Fsync policy
appendfsync everysec
no-appendfsync-on-rewrite no

# AOF rewrite triggers
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF options
aof-load-truncated yes
aof-use-rdb-preamble yes
aof-timestamp-enabled no

# -----------------------------------------------------------------------------
# REPLICATION CONFIGURATION
# -----------------------------------------------------------------------------

# Replica configuration (set if this is a replica)
# replicaof <master-ip> <master-port>

# Replication settings
replica-serve-stale-data yes
replica-read-only yes
replica-ignore-maxmemory yes

# Diskless replication
repl-diskless-sync yes
repl-diskless-sync-delay 5
repl-diskless-sync-max-replicas 0
repl-diskless-load on-empty-db

# Replication backlog
repl-backlog-size 128mb
repl-backlog-ttl 3600

# Replication timeout
repl-timeout 60

# Disable TCP_NODELAY for replication
repl-disable-tcp-nodelay no

# Replica priority (lower = preferred for promotion)
replica-priority 100

# Minimum replicas for writes
min-replicas-to-write 1
min-replicas-max-lag 10

# Replica announced settings
replica-announce-ip ""
replica-announce-port 0

# -----------------------------------------------------------------------------
# LAZY FREEING CONFIGURATION
# -----------------------------------------------------------------------------

lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# -----------------------------------------------------------------------------
# THREADING CONFIGURATION
# -----------------------------------------------------------------------------

# I/O threads (set based on CPU cores)
io-threads 4
io-threads-do-reads yes

# -----------------------------------------------------------------------------
# CLIENT CONFIGURATION
# -----------------------------------------------------------------------------

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 512mb 128mb 60
client-output-buffer-limit pubsub 64mb 16mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Protocol max bulk length
proto-max-bulk-len 512mb

# -----------------------------------------------------------------------------
# SLOW LOG CONFIGURATION
# -----------------------------------------------------------------------------

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep last 1024 slow queries
slowlog-max-len 1024

# -----------------------------------------------------------------------------
# LATENCY MONITORING
# -----------------------------------------------------------------------------

latency-monitor-threshold 50

# -----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# -----------------------------------------------------------------------------

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty for stdout in containers)
logfile ""

# Syslog settings (if using syslog)
# syslog-enabled yes
# syslog-ident redis
# syslog-facility local0

# -----------------------------------------------------------------------------
# KEYSPACE NOTIFICATIONS
# -----------------------------------------------------------------------------

# Enable keyspace notifications
# K = Keyspace events
# E = Keyevent events
# g = Generic commands (DEL, EXPIRE, RENAME, ...)
# $ = String commands
# l = List commands
# s = Set commands
# h = Hash commands
# z = Sorted set commands
# x = Expired events
# e = Evicted events
# t = Stream commands
# A = Alias for g$lshzxe
notify-keyspace-events "Ex"

# -----------------------------------------------------------------------------
# ADVANCED CONFIGURATION
# -----------------------------------------------------------------------------

# Server tick frequency
hz 10
dynamic-hz yes

# Active expire effort
active-expire-effort 1

# Hash data structure thresholds
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List data structure settings
list-max-listpack-size -2
list-compress-depth 0

# Set data structure settings
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# Sorted set data structure settings
zset-max-listpack-entries 128
zset-max-listpack-value 64

# HyperLogLog sparse representation
hll-sparse-max-bytes 3000

# Stream settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# LUA time limit (5 seconds)
lua-time-limit 5000

# -----------------------------------------------------------------------------
# CLUSTER CONFIGURATION (if using cluster mode)
# -----------------------------------------------------------------------------

# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage no
# cluster-replica-no-failover no
# cluster-allow-reads-when-down no
# cluster-allow-pubsubshard-when-down yes
# cluster-link-sendbuf-limit 0

# cluster-announce-ip <ip>
# cluster-announce-port <port>
# cluster-announce-tls-port <port>
# cluster-announce-bus-port <port>

# -----------------------------------------------------------------------------
# DEBUG CONFIGURATION (Disable in Production)
# -----------------------------------------------------------------------------

# Crash log settings
crash-log-enabled no
crash-memcheck-enabled no

# Debug settings
# debug-assertions no
# use-exit-on-panic yes
