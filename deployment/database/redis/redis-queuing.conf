# =============================================================================
# Redis Queuing Configuration
# =============================================================================
# Optimized for Redis Streams and message queuing workloads
# Priority: Durability - never lose messages
# Use case: Task queues, event streams, message brokers
# =============================================================================

# -----------------------------------------------------------------------------
# NETWORK CONFIGURATION
# -----------------------------------------------------------------------------

# Bind to all interfaces
bind 0.0.0.0

# Default Redis port
port 6379

# TCP keepalive for connection health
tcp-keepalive 300

# Client idle timeout - 0 means no timeout
timeout 0

# TCP listen backlog
tcp-backlog 511

# Maximum clients - moderate for queue processing
maxclients 5000

# Enable TCP nodelay
tcp-nodelay yes

# -----------------------------------------------------------------------------
# MEMORY CONFIGURATION
# -----------------------------------------------------------------------------

# Maximum memory - 4GB for queuing workload
maxmemory 4gb

# Eviction policy: noeviction
# CRITICAL: Never evict keys - return errors instead
# Messages must never be lost in queuing scenarios
maxmemory-policy noeviction

# LRU samples
maxmemory-samples 10

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# Jemalloc background thread
jemalloc-bg-thread yes

# -----------------------------------------------------------------------------
# PERSISTENCE CONFIGURATION (AOF ENABLED)
# -----------------------------------------------------------------------------

# Disable RDB (using AOF for durability)
save ""

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF directory
appenddirname "appendonlydir"

# Fsync policy: everysec (balance between performance and durability)
# Options: always (safest), everysec (recommended), no (fastest)
appendfsync everysec

# Don't block during AOF rewrite
no-appendfsync-on-rewrite no

# Automatic AOF rewrite triggers
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF file on startup
aof-load-truncated yes

# Enable RDB preamble in AOF for faster loading
aof-use-rdb-preamble yes

# AOF timestamp support
aof-timestamp-enabled no

# -----------------------------------------------------------------------------
# STREAMS CONFIGURATION
# -----------------------------------------------------------------------------

# Stream macro node max bytes
stream-node-max-bytes 4096

# Stream macro node max entries
stream-node-max-entries 100

# -----------------------------------------------------------------------------
# REPLICATION CONFIGURATION
# -----------------------------------------------------------------------------

# Replication backlog size - larger for queuing workloads
repl-backlog-size 128mb

# Replication timeout
repl-timeout 60

# Disable diskless sync - use disk-based for durability
repl-diskless-sync no

# Require at least 1 replica for writes (high availability)
min-replicas-to-write 1
min-replicas-max-lag 10

# Wait for replica ACK before confirming write
# Uncomment for stronger durability guarantees
# wait-replica-policy on-write

# -----------------------------------------------------------------------------
# LAZY FREEING CONFIGURATION
# -----------------------------------------------------------------------------

# Async deletion settings
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# -----------------------------------------------------------------------------
# THREADING CONFIGURATION
# -----------------------------------------------------------------------------

# I/O threads for multi-core systems
io-threads 4
io-threads-do-reads yes

# -----------------------------------------------------------------------------
# CLIENT OUTPUT BUFFER LIMITS
# -----------------------------------------------------------------------------

# Normal clients
client-output-buffer-limit normal 0 0 0

# Replica clients - larger for queue replication
client-output-buffer-limit replica 512mb 128mb 60

# Pub/Sub clients
client-output-buffer-limit pubsub 64mb 16mb 60

# -----------------------------------------------------------------------------
# SLOW LOG CONFIGURATION
# -----------------------------------------------------------------------------

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep last 256 slow queries
slowlog-max-len 256

# -----------------------------------------------------------------------------
# LATENCY MONITORING
# -----------------------------------------------------------------------------

# Monitor operations taking more than 50ms
latency-monitor-threshold 50

# -----------------------------------------------------------------------------
# SECURITY CONFIGURATION
# -----------------------------------------------------------------------------

# Protected mode
protected-mode no

# Disable dangerous commands in production
# rename-command FLUSHALL ""
# rename-command FLUSHDB ""

# -----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# -----------------------------------------------------------------------------

# Log level
loglevel notice

# Log to stdout
logfile ""

# -----------------------------------------------------------------------------
# ADVANCED CONFIGURATION
# -----------------------------------------------------------------------------

# Server tick frequency
hz 10
dynamic-hz yes

# Active expire effort - moderate for queuing
active-expire-effort 1

# Data structure thresholds
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# -----------------------------------------------------------------------------
# CLUSTER CONFIGURATION (if using cluster mode)
# -----------------------------------------------------------------------------

# Uncomment for cluster mode
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 5000
# cluster-require-full-coverage no
# cluster-replica-validity-factor 10
