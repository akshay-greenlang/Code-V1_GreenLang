# =============================================================================
# Redis Sessions Configuration
# =============================================================================
# Optimized for session storage workloads
# Priority: Balance between performance and durability
# Use case: User sessions, authentication tokens, temporary user data
# =============================================================================

# -----------------------------------------------------------------------------
# NETWORK CONFIGURATION
# -----------------------------------------------------------------------------

# Bind to all interfaces
bind 0.0.0.0

# Default Redis port
port 6379

# TCP keepalive
tcp-keepalive 300

# Client idle timeout - 0 means no timeout
timeout 0

# TCP listen backlog
tcp-backlog 511

# Maximum clients
maxclients 10000

# Enable TCP nodelay
tcp-nodelay yes

# -----------------------------------------------------------------------------
# MEMORY CONFIGURATION
# -----------------------------------------------------------------------------

# Maximum memory - 2GB for session storage
maxmemory 2gb

# Eviction policy: volatile-ttl
# Evict keys with TTL set, prioritizing keys closer to expiration
# Perfect for sessions which always have TTL
maxmemory-policy volatile-ttl

# LRU samples for eviction accuracy
maxmemory-samples 10

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# Jemalloc background thread
jemalloc-bg-thread yes

# -----------------------------------------------------------------------------
# PERSISTENCE CONFIGURATION (RDB SNAPSHOTS)
# -----------------------------------------------------------------------------

# RDB snapshot policy:
# Save after 900 seconds (15 min) if at least 1 key changed
# Save after 300 seconds (5 min) if at least 10 keys changed
# Save after 60 seconds (1 min) if at least 10000 keys changed
save 900 1
save 300 10
save 60 10000

# RDB filename
dbfilename dump.rdb

# RDB directory
dir /data

# Stop accepting writes if RDB save fails
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# Remove RDB file used by replication after sync
rdb-del-sync-files no

# Disable AOF for session storage (RDB is sufficient)
appendonly no

# -----------------------------------------------------------------------------
# REPLICATION CONFIGURATION
# -----------------------------------------------------------------------------

# Replication backlog size
repl-backlog-size 64mb

# Replication timeout
repl-timeout 60

# Enable diskless sync for faster replication
repl-diskless-sync yes
repl-diskless-sync-delay 5
repl-diskless-sync-max-replicas 0

# Replica read-only
replica-read-only yes

# Replica serve stale data during sync
replica-serve-stale-data yes

# Min replicas for writes
min-replicas-to-write 0
min-replicas-max-lag 10

# -----------------------------------------------------------------------------
# LAZY FREEING CONFIGURATION
# -----------------------------------------------------------------------------

# Async deletion for expired sessions
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# -----------------------------------------------------------------------------
# THREADING CONFIGURATION
# -----------------------------------------------------------------------------

# I/O threads
io-threads 4
io-threads-do-reads yes

# -----------------------------------------------------------------------------
# CLIENT OUTPUT BUFFER LIMITS
# -----------------------------------------------------------------------------

# Normal clients
client-output-buffer-limit normal 0 0 0

# Replica clients
client-output-buffer-limit replica 256mb 64mb 60

# Pub/Sub clients
client-output-buffer-limit pubsub 32mb 8mb 60

# -----------------------------------------------------------------------------
# SLOW LOG CONFIGURATION
# -----------------------------------------------------------------------------

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep last 128 slow queries
slowlog-max-len 128

# -----------------------------------------------------------------------------
# LATENCY MONITORING
# -----------------------------------------------------------------------------

# Latency monitor threshold
latency-monitor-threshold 100

# -----------------------------------------------------------------------------
# SECURITY CONFIGURATION
# -----------------------------------------------------------------------------

# Protected mode
protected-mode no

# Disable dangerous commands
# rename-command FLUSHALL ""
# rename-command FLUSHDB ""
# rename-command DEBUG ""

# -----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# -----------------------------------------------------------------------------

# Log level
loglevel notice

# Log to stdout
logfile ""

# -----------------------------------------------------------------------------
# SESSION-SPECIFIC OPTIMIZATIONS
# -----------------------------------------------------------------------------

# Active expiration effort - higher for session cleanup
active-expire-effort 3

# Server tick frequency - higher for faster expiration
hz 10
dynamic-hz yes

# -----------------------------------------------------------------------------
# DATA STRUCTURE OPTIMIZATIONS
# -----------------------------------------------------------------------------

# Sessions typically use hashes - optimize for small hashes
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# String (session JSON) optimizations
# Sessions are typically under 4KB

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# -----------------------------------------------------------------------------
# NOTIFY KEYSPACE EVENTS
# -----------------------------------------------------------------------------

# Enable keyspace notifications for session expiration tracking
# E = Keyevent events, x = Expired events, K = Keyspace events
notify-keyspace-events Ex
