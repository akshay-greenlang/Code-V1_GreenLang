name: Docker Quick Fix

on:
  workflow_dispatch:

jobs:
  quick-fixes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Quick fix 1: Add missing 0.2 tag (no rebuild needed!)
      - name: Add 0.2 tag for existing runner
        run: |
          echo "Adding 0.2 tag to existing runner image..."
          docker buildx imagetools create \
            --tag ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2 \
            ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2.0

      # Quick fix 2: Build optimized runner (smaller size)
      - name: Build optimized runner (<300MB)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.runner.optimized
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2.0-slim
            ghcr.io/${{ github.repository_owner }}/greenlang-runner:slim
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/greenlang-runner:buildcache
          cache-to: type=inline

      # Quick fix 3: Build minimal full image (amd64 only for speed)
      - name: Build full image (amd64 only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.full
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/greenlang-full:0.2.0
            ghcr.io/${{ github.repository_owner }}/greenlang-full:0.2
            ghcr.io/${{ github.repository_owner }}/greenlang-full:latest
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/greenlang-full:buildcache
          cache-to: type=inline

      # Install and use cosign for signing
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.6.0

      - name: Sign images
        run: |
          # Sign the optimized runner
          cosign sign --yes ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2.0-slim

          # Sign the 0.2 tag
          cosign sign --yes ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2

          # Sign the full image
          cosign sign --yes ghcr.io/${{ github.repository_owner }}/greenlang-full:0.2.0

      # Quick SBOM generation
      - name: Generate SBOM
        run: |
          # Install syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          # Generate SBOM for optimized runner
          syft ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2.0-slim \
            -o spdx-json > sbom-runner-slim.json

          echo "SBOM generated successfully"

      # Final check
      - name: Verify fixes
        run: |
          echo "=== Quick Fixes Applied ==="
          echo "✅ Added 0.2 tag (no rebuild needed)"
          echo "✅ Built optimized runner (targeting <300MB)"
          echo "✅ Built full image (amd64 only for speed)"
          echo "✅ Signed images with cosign"
          echo "✅ Generated SBOM"
          echo ""
          echo "=== Image Sizes ==="
          docker pull ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2.0-slim
          docker images | grep greenlang-runner
          echo ""
          echo "=== Test Commands ==="
          docker run --rm ghcr.io/${{ github.repository_owner }}/greenlang-runner:0.2.0-slim --version