# GreenLang Release Orchestration Pipeline
#
# Consolidates: release.yml, release-pypi.yml, release-build.yml, release-docker.yml,
#               beta-testpypi.yml, publish-pypi.yml, rc-release.yml, release-signing.yml,
#               release-v030.yml, verify-version.yml, version-guard.yml, changelog.yml
#
# Complete release pipeline with stages:
# 1. Prepare: Extract version, validate consistency, create tag
# 2. Build: Build wheels, sdist, validate with twine
# 3. Test: Multi-OS, multi-Python validation
# 4. Security: Sign with Sigstore, generate SBOM, attestations
# 5. Publish: PyPI (trusted publishing), TestPyPI (dry-run option)
# 6. Docker: Build and push Docker images, sign with Cosign
# 7. Release: Create GitHub release with assets/notes
# 8. Verification: Post-publish validation
#
# Author: GreenLang Release Team
# Version: 3.0.0

name: Release Orchestration

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (TestPyPI only)'
        required: false
        default: false
        type: boolean
      publish_docker:
        description: 'Publish Docker images'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
      release-name: ${{ steps.version.outputs.release-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version information
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          if [[ "$VERSION" =~ (alpha|beta|rc|dev) ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
            echo "release-name=GreenLang $VERSION (Pre-release)" >> $GITHUB_OUTPUT
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "release-name=GreenLang $VERSION" >> $GITHUB_OUTPUT
          fi

          echo "Detected version: $VERSION"

      - name: Verify version consistency
        run: |
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          if [[ "$PYPROJECT_VERSION" != "${{ steps.version.outputs.version }}" ]]; then
            echo "::error::Version mismatch between tag (${{ steps.version.outputs.version }}) and pyproject.toml ($PYPROJECT_VERSION)"
            exit 1
          fi
          echo "Version consistency check passed"

  build-python:
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: 'pip'

      - name: Install build dependencies
        run: python -m pip install -U pip build wheel twine

      - name: Build package
        run: python -m build

      - name: Validate package
        run: twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages-${{ matrix.os }}-py${{ matrix.python }}
          path: dist/
          retention-days: 30

  build-docker:
    needs: prepare-release
    if: github.event.inputs.publish_docker != 'false'
    runs-on: ubuntu-latest
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker images
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare-release.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          provenance: true
          sbom: true

  # ============================================================================
  # Sign Docker Images with Cosign
  # ============================================================================
  sign-docker:
    needs: [prepare-release, build-docker]
    if: github.event.inputs.publish_docker != 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign container image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes \
            --oidc-issuer https://token.actions.githubusercontent.com \
            --annotations "version=${{ needs.prepare-release.outputs.version }}" \
            --annotations "repo=${{ github.repository }}" \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}

      - name: Verify signature
        run: |
          cosign verify \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}.*" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}

  # ============================================================================
  # Generate SLSA Provenance
  # ============================================================================
  slsa-provenance:
    needs: [prepare-release, build-docker, sign-docker]
    if: github.event.inputs.publish_docker != 'false'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
      attestations: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }} \
            -o cyclonedx-json=sbom.cyclonedx.json

      - name: Attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest --yes \
            --predicate sbom.cyclonedx.json \
            --type cyclonedx \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}

      - name: Generate SLSA provenance
        run: |
          DIGEST="${{ needs.build-docker.outputs.image_digest }}"
          cat > provenance.json << EOF
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "predicateType": "https://slsa.dev/provenance/v0.2",
            "subject": [
              {
                "name": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}",
                "digest": {
                  "sha256": "${DIGEST#sha256:}"
                }
              }
            ],
            "predicate": {
              "builder": {
                "id": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "buildType": "https://github.com/slsa-framework/slsa-github-generator/container@v1",
              "invocation": {
                "configSource": {
                  "uri": "git+https://github.com/${{ github.repository }}@refs/tags/v${{ needs.prepare-release.outputs.version }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  },
                  "entryPoint": ".github/workflows/release-orchestration.yml"
                },
                "parameters": {
                  "version": "${{ needs.prepare-release.outputs.version }}",
                  "is_prerelease": "${{ needs.prepare-release.outputs.is-prerelease }}"
                },
                "environment": {
                  "github_actor": "${{ github.actor }}",
                  "github_event_name": "${{ github.event_name }}",
                  "github_ref": "${{ github.ref }}",
                  "github_repository": "${{ github.repository }}",
                  "github_run_id": "${{ github.run_id }}",
                  "github_sha": "${{ github.sha }}",
                  "runner_os": "${{ runner.os }}"
                }
              },
              "metadata": {
                "buildInvocationId": "${{ github.run_id }}-${{ github.run_attempt }}",
                "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "completeness": {
                  "parameters": true,
                  "environment": true,
                  "materials": true
                },
                "reproducible": false
              },
              "materials": [
                {
                  "uri": "git+https://github.com/${{ github.repository }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              ]
            }
          }
          EOF

      - name: Attest SLSA provenance
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest --yes \
            --predicate provenance.json \
            --type slsaprovenance \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}

      - name: Upload provenance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: slsa-provenance
          path: |
            provenance.json
            sbom.cyclonedx.json
          retention-days: 90

      - name: Generate supply chain summary
        run: |
          echo "## Supply Chain Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ needs.prepare-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ needs.build-docker.outputs.image_digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Attestations" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cosign Signature | Attached |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM (CycloneDX) | Attached |" >> $GITHUB_STEP_SUMMARY
          echo "| SLSA Provenance (L2) | Attached |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Verify signature" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp 'https://github.com/${{ github.repository }}.*' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer https://token.actions.githubusercontent.com \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify SBOM" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-attestation --type cyclonedx \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp 'https://github.com/${{ github.repository }}.*' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer https://token.actions.githubusercontent.com \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify provenance" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-attestation --type slsaprovenance \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp 'https://github.com/${{ github.repository }}.*' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer https://token.actions.githubusercontent.com \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.image_digest }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  create-release:
    needs: [prepare-release, build-python, build-docker, sign-docker, slsa-provenance]
    if: always() && needs.prepare-release.result == 'success' && needs.build-python.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all Python build artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find . -name "*.whl" -exec cp {} release-assets/ \; 2>/dev/null || true
          find . -name "*.tar.gz" -exec cp {} release-assets/ \; 2>/dev/null || true

      - name: Generate changelog
        run: |
          if [[ -f CHANGELOG.md ]]; then
            awk "/^## \[?${{ needs.prepare-release.outputs.version }}\]?/{flag=1; next} /^## \[?[0-9]/{flag=0} flag {print}' CHANGELOG.md > version_changelog.txt
          else
            echo "## Changes in this release" > version_changelog.txt
            git log --oneline --no-merges $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)..HEAD >> version_changelog.txt 2>/dev/null || echo "GreenLang ${{ needs.prepare-release.outputs.version }} release" >> version_changelog.txt
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare-release.outputs.version }}
          name: ${{ needs.prepare-release.outputs.release-name }}
          body_path: version_changelog.txt
          prerelease: ${{ needs.prepare-release.outputs.is-prerelease }}
          files: release-assets/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    needs: [prepare-release, create-release]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    environment: pypi
    permissions:
      id-token: write

    steps:
      - name: Download Python build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-packages-ubuntu-latest-py3.11

      - name: Prepare PyPI assets
        run: |
          mkdir -p dist
          find . -name "*.whl" -exec cp {} dist/ \; 2>/dev/null || true
          find . -name "*.tar.gz" -exec cp {} dist/ \; 2>/dev/null || true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true

  publish-testpypi:
    needs: [prepare-release, build-python]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run == 'true'
    environment: testpypi
    permissions:
      id-token: write

    steps:
      - name: Download Python build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-packages-ubuntu-latest-py3.11

      - name: Prepare TestPyPI assets
        run: |
          mkdir -p dist
          find . -name "*.whl" -exec cp {} dist/ \; 2>/dev/null || true
          find . -name "*.tar.gz" -exec cp {} dist/ \; 2>/dev/null || true

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          verbose: true
