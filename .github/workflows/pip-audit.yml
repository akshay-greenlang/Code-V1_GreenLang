name: pip-audit
on:
  pull_request:
  push:
    branches: [main, master]
  schedule:
    - cron: "0 2 * * *"  # nightly
  workflow_dispatch:  # manual trigger

jobs:
  audit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: |
          pip install .[all]
          pip-audit --strict --desc --format json -o pip-audit.json || {
            echo "âŒ Vulnerabilities found"
            cat pip-audit.json
            exit 1
          }
          echo "âœ… No vulnerabilities found"

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results-${{ matrix.python-version }}
          path: pip-audit.json
          retention-days: 30

  audit-summary:
    needs: audit
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pip-audit-results-*
          merge-multiple: true

      - name: Create summary
        run: |
          echo "## ðŸ”’ Dependency Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if ls pip-audit-*.json 1> /dev/null 2>&1; then
            for file in pip-audit-*.json; do
              if [ -s "$file" ]; then
                echo "### âš ï¸ Issues found in $file:" >> $GITHUB_STEP_SUMMARY
                echo '```json' >> $GITHUB_STEP_SUMMARY
                cat "$file" | head -20 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              else
                echo "### âœ… No issues in $file" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "### âœ… All dependency checks passed!" >> $GITHUB_STEP_SUMMARY
          fi