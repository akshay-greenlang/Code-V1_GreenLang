# GreenLang Agents CI Pipeline
#
# Consolidates: gl-001-ci.yaml, gl-002-ci.yaml, gl-003-ci.yaml, gl-004-tests.yml,
#               gl-005-ci.yaml, gl-006-tests.yml, gl-007-tests.yml, gl-009-ci.yaml,
#               frmw-202-agent-scaffold.yml
#
# Unified CI for all GreenLang agents with matrix-based testing
#
# Author: GreenLang Agents Team
# Version: 3.0.0

name: Agents CI

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'applications/gl_agents/**'
      - 'greenlang/**'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'applications/gl_agents/**'
      - 'greenlang/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-changed-agents:
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.set-matrix.outputs.agents }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed agents
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Run all agents on manual trigger
            AGENTS=$(find applications/gl_agents -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
          else
            # Detect changed agents
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "applications/gl_agents/")
            AGENTS=$(echo "$CHANGED_FILES" | grep "^applications/gl_agents/" | cut -d'/' -f3 | sort -u | jq -R -s -c 'split("\n")[:-1]')

            # If no agents changed, test all
            if [[ "$AGENTS" == "[]" ]] || [[ "$AGENTS" == "[" "]" ]]; then
              AGENTS=$(find applications/gl_agents -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
            fi
          fi

          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "Testing agents: $AGENTS"

  test-agents:
    needs: detect-changed-agents
    if: needs.detect-changed-agents.outputs.agents != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        agent: ${{ fromJson(needs.detect-changed-agents.outputs.agents) }}
        python: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[test,dev]

      - name: Lint agent code
        run: |
          if [ -d "applications/gl_agents/${{ matrix.agent }}" ]; then
            ruff check applications/gl_agents/${{ matrix.agent }}/
            black --check applications/gl_agents/${{ matrix.agent }}/
          fi

      - name: Run agent tests
        run: |
          if [ -d "tests/agents/${{ matrix.agent }}" ]; then
            pytest tests/agents/${{ matrix.agent }}/ -v --cov=applications/gl_agents/${{ matrix.agent }}
          else
            echo "No tests found for ${{ matrix.agent }}"
          fi

      - name: Check agent coverage
        run: |
          python -m coverage report --fail-under=80 || echo "Coverage below 80% for ${{ matrix.agent }}"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-${{ matrix.agent }}-py${{ matrix.python }}-results
          path: test-results/
          retention-days: 7

  agents-gate:
    name: Agents CI Gate
    runs-on: ubuntu-latest
    needs: [test-agents]
    if: always()

    steps:
      - name: Check all agent tests passed
        run: |
          if [[ "${{ needs.test-agents.result }}" != "success" ]] && [[ "${{ needs.test-agents.result }}" != "skipped" ]]; then
            echo "::error::Agent tests failed"
            exit 1
          fi
          echo "âœ… All agent tests passed"
