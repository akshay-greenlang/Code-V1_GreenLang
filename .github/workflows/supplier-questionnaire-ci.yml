# =============================================================================
# GreenLang Supplier Questionnaire Service CI
# GreenLang Climate OS | AGENT-DATA-008
# =============================================================================
# Validates supplier questionnaire service: Python lint, type-check, unit tests,
# integration tests, security scan, coverage enforcement, K8s manifests,
# dashboard JSON, alert rules, SQL migration, Docker build, and deployment.
# =============================================================================

name: Supplier Questionnaire CI

on:
  pull_request:
    paths:
      - 'deployment/kubernetes/supplier-questionnaire-service/**'
      - 'deployment/database/migrations/V038__supplier_questionnaire_service.sql'
      - 'greenlang/supplier_questionnaire/**'
      - 'greenlang/agents/data/supplier_data_exchange_agent.py'
      - 'tests/unit/supplier_questionnaire_service/**'
      - 'tests/integration/supplier_questionnaire_service/**'
  push:
    branches: [master]
    paths:
      - 'deployment/kubernetes/supplier-questionnaire-service/**'
      - 'greenlang/supplier_questionnaire/**'
      - 'greenlang/agents/data/supplier_data_exchange_agent.py'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  K8S_DIR: deployment/kubernetes/supplier-questionnaire-service

jobs:
  # -------------------------------------------------------------------------
  # Job 1: Lint (ruff + black + isort + YAML + JSON)
  # -------------------------------------------------------------------------
  lint:
    name: Lint (ruff + black + isort + YAML + JSON)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: pip install --quiet ruff black isort pyyaml

      - name: Lint Python (ruff)
        run: |
          if [ -d "greenlang/supplier_questionnaire" ]; then
            ruff check greenlang/supplier_questionnaire/ --select E,F,W --ignore E501
          else
            echo "WARNING: supplier_questionnaire source not found"
          fi

      - name: Check formatting (black)
        run: |
          if [ -d "greenlang/supplier_questionnaire" ]; then
            black --check --diff greenlang/supplier_questionnaire/
          fi

      - name: Check imports (isort)
        run: |
          if [ -d "greenlang/supplier_questionnaire" ]; then
            isort --check-only --diff greenlang/supplier_questionnaire/
          fi

      - name: Validate K8s YAML syntax
        run: |
          python3 << 'PYEOF'
          import yaml
          import glob
          import sys

          errors = []
          checked = 0

          for path in sorted(glob.glob("${{ env.K8S_DIR }}/*.yaml")):
              checked += 1
              with open(path) as f:
                  try:
                      docs = list(yaml.safe_load_all(f))
                  except yaml.YAMLError as e:
                      errors.append(f"{path}: Invalid YAML - {e}")
                      continue

                  for doc in docs:
                      if doc is None:
                          continue
                      if "apiVersion" not in doc and "kind" not in doc:
                          if "resources" not in doc:
                              errors.append(f"{path}: Missing apiVersion or kind")

          if errors:
              print("K8s YAML validation errors:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)

          print(f"All {checked} K8s YAML files are valid")
          PYEOF

      - name: Validate dashboard JSON
        run: |
          for f in ${{ env.K8S_DIR }}/grafana/*.json; do
            [ -e "$f" ] || continue
            if ! python -m json.tool "$f" > /dev/null 2>&1; then
              echo "ERROR: Invalid JSON in $f"
              exit 1
            fi
          done
          echo "Dashboard JSON valid"

      - name: Validate alert YAML
        run: |
          python3 << 'PYEOF'
          import yaml
          import glob
          import sys

          errors = []
          for path in sorted(glob.glob("${{ env.K8S_DIR }}/alerts/*.yaml")):
              with open(path) as f:
                  try:
                      docs = list(yaml.safe_load_all(f))
                  except yaml.YAMLError as e:
                      errors.append(f"{path}: Invalid YAML - {e}")
                      continue

                  for doc in docs:
                      if doc is None:
                          continue
                      if "spec" in doc and "groups" in doc.get("spec", {}):
                          for group in doc["spec"]["groups"]:
                              if "rules" not in group:
                                  errors.append(f"Alert group missing rules")
                              for rule in group.get("rules", []):
                                  if "alert" in rule:
                                      if "expr" not in rule:
                                          errors.append(f"Alert '{rule['alert']}' missing expr")
                                      ann = rule.get("annotations", {})
                                      if "summary" not in ann:
                                          errors.append(f"Alert '{rule['alert']}' missing summary")

          if errors:
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          print("Alert YAML valid")
          PYEOF

  # -------------------------------------------------------------------------
  # Job 2: Type Check (mypy)
  # -------------------------------------------------------------------------
  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install \
            mypy \
            pydantic \
            fastapi \
            prometheus-client \
            psycopg \
            redis \
            pyyaml \
            types-PyYAML \
            types-redis \
            httpx

      - name: Run mypy strict mode
        run: |
          if [ -d "greenlang/supplier_questionnaire" ]; then
            mypy greenlang/supplier_questionnaire/ \
              --strict \
              --ignore-missing-imports \
              --no-error-summary \
              --show-column-numbers
          fi

  # -------------------------------------------------------------------------
  # Job 3: Unit Tests
  # -------------------------------------------------------------------------
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install \
            pytest \
            pytest-asyncio \
            pytest-cov \
            pydantic \
            fastapi \
            httpx \
            structlog \
            prometheus-client \
            psycopg \
            redis \
            pyyaml

      - name: Run unit tests
        run: |
          DIRS=""
          if [ -d "tests/unit/supplier_questionnaire_service" ]; then
            DIRS="$DIRS tests/unit/supplier_questionnaire_service/"
          fi
          if [ -n "$DIRS" ]; then
            pytest $DIRS -v --tb=short -q \
              --cov=greenlang/supplier_questionnaire \
              --cov-report=term-missing \
              --cov-report=xml:coverage-supplier-questionnaire.xml \
              --cov-fail-under=85 \
              --junitxml=junit-supplier-questionnaire-unit.xml
          else
            echo "WARNING: No unit tests found"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: junit-supplier-questionnaire-unit.xml
          if-no-files-found: ignore

  # -------------------------------------------------------------------------
  # Job 4: Integration Tests
  # -------------------------------------------------------------------------
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install \
            pytest \
            pytest-asyncio \
            pydantic \
            fastapi \
            httpx \
            structlog \
            prometheus-client \
            psycopg \
            redis \
            pyyaml

      - name: Run integration tests
        run: |
          if [ -d "tests/integration/supplier_questionnaire_service" ]; then
            pytest tests/integration/supplier_questionnaire_service/ -v --tb=short -q \
              --junitxml=junit-supplier-questionnaire-integration.xml
          else
            echo "WARNING: No integration tests found"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: junit-supplier-questionnaire-integration.xml
          if-no-files-found: ignore

  # -------------------------------------------------------------------------
  # Job 5: Security Scan (bandit + safety)
  # -------------------------------------------------------------------------
  security-scan:
    name: Security Scan (bandit + safety)
    runs-on: ubuntu-latest
    needs: [unit-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install \
            bandit \
            safety \
            pydantic \
            fastapi \
            prometheus-client \
            psycopg \
            redis

      - name: Run bandit security scan
        run: |
          if [ -d "greenlang/supplier_questionnaire" ]; then
            bandit -r greenlang/supplier_questionnaire/ -c .bandit.yml --severity-level medium || true
          fi

      - name: Run safety dependency check
        run: |
          if [ -f "requirements.txt" ]; then
            safety check -r requirements.txt --output text || true
          fi

  # -------------------------------------------------------------------------
  # Job 6: Migration Validate
  # -------------------------------------------------------------------------
  migration-validate:
    name: Migration Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate SQL migration
        run: |
          python3 << 'PYEOF'
          import sys

          migration_path = "deployment/database/migrations/V038__supplier_questionnaire_service.sql"
          try:
              with open(migration_path) as f:
                  content = f.read()
          except FileNotFoundError:
              print(f"ERROR: {migration_path} not found")
              sys.exit(1)

          errors = []

          if "CREATE SCHEMA" not in content:
              errors.append("Missing CREATE SCHEMA statement")

          required_tables = [
              "supplier_questionnaire_service.questionnaire_templates",
              "supplier_questionnaire_service.template_sections",
              "supplier_questionnaire_service.template_questions",
              "supplier_questionnaire_service.distributions",
              "supplier_questionnaire_service.distribution_events",
              "supplier_questionnaire_service.responses",
              "supplier_questionnaire_service.response_answers",
              "supplier_questionnaire_service.validation_results",
              "supplier_questionnaire_service.scores",
              "supplier_questionnaire_service.follow_up_actions",
          ]
          for table in required_tables:
              if f"CREATE TABLE {table}" not in content:
                  errors.append(f"Missing CREATE TABLE {table}")

          if "create_hypertable" not in content:
              errors.append("Missing create_hypertable call")

          if "MATERIALIZED VIEW" not in content:
              errors.append("Missing continuous aggregate (MATERIALIZED VIEW)")

          if "add_retention_policy" not in content:
              errors.append("Missing retention policy")

          if "GL-DATA-SUP-001" not in content:
              errors.append("Missing seed data for GL-DATA-SUP-001")

          if errors:
              print("SQL migration validation errors:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)

          print("SQL migration valid")
          PYEOF

  # -------------------------------------------------------------------------
  # Job 7: All Checks Gate
  # -------------------------------------------------------------------------
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-test, integration-test, security-scan, migration-validate]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Unit Tests: ${{ needs.unit-test.result }}"
          echo "Integration Tests: ${{ needs.integration-test.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Migration: ${{ needs.migration-validate.result }}"

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.unit-test.result }}" != "success" ] || \
             [ "${{ needs.migration-validate.result }}" != "success" ]; then
            echo "Required checks failed"
            exit 1
          fi
          echo "All required checks passed"
