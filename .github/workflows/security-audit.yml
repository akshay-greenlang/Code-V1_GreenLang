# GitHub Actions Workflow - Security Audit
# Automated dependency scanning and vulnerability detection
# Runs on: daily schedule, pull requests, and manual trigger

name: Security Audit & Dependency Scanning

on:
  # Daily security scan at midnight UTC
  schedule:
    - cron: '0 0 * * *'

  # On pull requests to main/master
  pull_request:
    branches:
      - main
      - master
    paths:
      - '**/requirements*.txt'
      - '**/pyproject.toml'
      - '**/setup.py'
      - '.github/workflows/security-audit.yml'

  # On push to main/master
  push:
    branches:
      - main
      - master
    paths:
      - '**/requirements*.txt'
      - '**/pyproject.toml'
      - '**/setup.py'

  # Manual trigger
  workflow_dispatch:
    inputs:
      severity_threshold:
        description: 'Fail build if vulnerabilities found at or above this severity'
        required: false
        default: 'high'
        type: choice
        options:
          - critical
          - high
          - medium
          - low

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ===========================================================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ===========================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.11']
        directory:
          - 'GreenLang_2030/agent_foundation'
          - '.'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install security scanning tools
        run: |
          pip install --upgrade pip
          pip install safety pip-audit bandit semgrep

      - name: Install dependencies
        working-directory: ${{ matrix.directory }}
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
        continue-on-error: true

      # Safety Check - PyPA vulnerability database
      - name: Run Safety Check
        working-directory: ${{ matrix.directory }}
        run: |
          safety check \
            --json \
            --output safety-report.json \
            --continue-on-error
        continue-on-error: true

      # pip-audit - Official PyPI vulnerability scanner
      - name: Run pip-audit
        working-directory: ${{ matrix.directory }}
        run: |
          pip-audit \
            --format json \
            --output pip-audit-report.json \
            --require-hashes \
            --strict
        continue-on-error: true

      # Bandit - Python code security scanner
      - name: Run Bandit
        working-directory: ${{ matrix.directory }}
        run: |
          bandit \
            -r . \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium \
            --skip B101,B601
        continue-on-error: true

      # Semgrep - Static analysis security scanner
      - name: Run Semgrep
        working-directory: ${{ matrix.directory }}
        run: |
          semgrep \
            --config=auto \
            --json \
            --output semgrep-report.json \
            --severity ERROR \
            --severity WARNING
        continue-on-error: true

      # Upload security reports as artifacts
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ matrix.python-version }}-${{ hashFiles(matrix.directory) }}
          path: |
            ${{ matrix.directory }}/safety-report.json
            ${{ matrix.directory }}/pip-audit-report.json
            ${{ matrix.directory }}/bandit-report.json
            ${{ matrix.directory }}/semgrep-report.json
          retention-days: 30

      # Fail on critical/high vulnerabilities
      - name: Check for Critical Vulnerabilities
        working-directory: ${{ matrix.directory }}
        run: |
          echo "Checking for critical vulnerabilities..."

          # Safety strict check (fail on any vulnerability)
          safety check --exit-code

          # pip-audit strict check
          pip-audit --strict
        continue-on-error: false

  # ===========================================================================
  # LICENSE COMPLIANCE CHECK
  # ===========================================================================
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install license checker
        run: |
          pip install pip-licenses

      - name: Check licenses
        working-directory: GreenLang_2030/agent_foundation
        run: |
          # Install dependencies
          pip install -r requirements.txt

          # Generate license report
          pip-licenses \
            --format=json \
            --output-file=licenses-report.json

          # Check for GPL/LGPL/AGPL (copyleft licenses)
          pip-licenses \
            --format=csv \
            --fail-on 'GNU General Public License v2 or later (GPLv2+)' \
            --fail-on 'GNU General Public License v3.0' \
            --fail-on 'GNU Lesser General Public License v2 or later (LGPLv2+)' \
            --fail-on 'GNU Lesser General Public License v3.0' \
            --fail-on 'GNU Affero General Public License v3.0'

      - name: Upload License Report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: GreenLang_2030/agent_foundation/licenses-report.json

  # ===========================================================================
  # SBOM GENERATION (Software Bill of Materials)
  # ===========================================================================
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install CycloneDX
        run: |
          pip install cyclonedx-bom

      - name: Generate SBOM
        working-directory: GreenLang_2030/agent_foundation
        run: |
          # Install dependencies
          pip install -r requirements.txt

          # Generate SBOM in CycloneDX format
          cyclonedx-py \
            --format json \
            --output sbom.json \
            --requirements requirements.txt

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: GreenLang_2030/agent_foundation/sbom.json

  # ===========================================================================
  # SUMMARY REPORT & NOTIFICATIONS
  # ===========================================================================
  security-summary:
    name: Security Summary Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, license-check, sbom-generation]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary report
        run: |
          echo "# Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Safety Check | ${{ needs.dependency-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| pip-audit | ${{ needs.dependency-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit | ${{ needs.dependency-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Security Reports: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "- License Report: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM: Available for download" >> $GITHUB_STEP_SUMMARY

      # Slack notification for critical vulnerabilities (optional)
      # - name: Notify Slack on Failure
      #   if: failure() && github.ref == 'refs/heads/main'
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "ðŸš¨ Security Audit Failed",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*Security vulnerabilities detected in main branch*\n\nWorkflow: ${{ github.workflow }}\nRepository: ${{ github.repository }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}

# ===========================================================================
# WORKFLOW NOTES
# ===========================================================================
#
# Security Scanning Tools:
# 1. Safety - PyPA vulnerability database (advisory-db)
# 2. pip-audit - Official PyPI vulnerability scanner (OSV database)
# 3. Bandit - Python code security linter
# 4. Semgrep - Static analysis security patterns
#
# Severity Levels:
# - CRITICAL: Immediate action required
# - HIGH: Patch within 24 hours
# - MEDIUM: Patch within 1 week
# - LOW: Patch in next release
#
# Notifications:
# - GitHub Actions summary report
# - Slack alerts for critical/high (configure webhook)
# - Email notifications (configure in repository settings)
#
# Required Secrets:
# - SLACK_SECURITY_WEBHOOK (optional for Slack notifications)
#
# Required Permissions:
# - contents: read (checkout code)
# - security-events: write (upload SARIF reports)
# - pull-requests: write (comment on PRs)
#
# ===========================================================================
