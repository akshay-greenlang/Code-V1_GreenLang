name: secret-scan
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, master]
  schedule:
    - cron: "0 3 * * 1"  # weekly full sweep

jobs:
  trufflehog-pr-diff:
    name: TruffleHog (PR diff)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install trufflehog3
        run: |
          python -m pip install --upgrade pip
          pip install trufflehog3

      - name: Scan PR diff only
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.sha }}
          echo "Scanning from $BASE to $HEAD"

          # Create a temp directory for the scan
          mkdir -p /tmp/trufflehog-results

          # Run scan on changed files only
          git diff --name-only $BASE..$HEAD > changed_files.txt

          if [ -s changed_files.txt ]; then
            echo "Scanning changed files:"
            cat changed_files.txt

            # Run trufflehog3 on changed files
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                trufflehog3 "$file" --format json -o /tmp/trufflehog-results/$(basename $file).json || true
              fi
            done < changed_files.txt

            # Check if any secrets were found
            FOUND_SECRETS=false
            for result in /tmp/trufflehog-results/*.json; do
              if [ -f "$result" ] && [ -s "$result" ]; then
                echo "⚠️ Potential secrets found in $(basename $result):"
                cat "$result"
                FOUND_SECRETS=true
              fi
            done

            if [ "$FOUND_SECRETS" = true ]; then
              echo "❌ Secret scan failed - potential secrets detected!"
              exit 1
            else
              echo "✅ No secrets detected in changed files"
            fi
          else
            echo "No files changed in this PR"
          fi

  trufflehog-weekly-full:
    name: TruffleHog (weekly full filesystem)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install trufflehog3
        run: |
          python -m pip install --upgrade pip
          pip install trufflehog3

      - name: Run full filesystem scan
        run: |
          echo "Running full filesystem scan..."
          trufflehog3 . --format json -o trufflehog-full-scan.json || true

          # Check results
          if [ -s trufflehog-full-scan.json ]; then
            echo "⚠️ Potential secrets found during weekly scan:"
            # Show first 50 lines as sample
            head -50 trufflehog-full-scan.json

            # Count total findings
            echo "Total findings: $(grep -c '"path"' trufflehog-full-scan.json || echo 0)"

            # Upload as artifact for review
            echo "Full results available as artifact"
          else
            echo "✅ No secrets detected in full scan"
          fi

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-weekly-scan
          path: trufflehog-full-scan.json
          retention-days: 30