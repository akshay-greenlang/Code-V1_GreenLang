# GreenLang Scheduled Maintenance
#
# Consolidates: gl-002-scheduled.yaml, gl-003-scheduled.yaml, weekly-metrics.yml,
#               friday-gate.yml
#
# Daily: Security scanning, dependency updates, performance benchmarks
# Weekly: Metrics aggregation, coverage trends
#
# Author: GreenLang DevOps Team
# Version: 3.0.0

name: Scheduled Maintenance

on:
  schedule:
    - cron: '0 2 * * *'     # Daily at 2 AM UTC
    - cron: '0 8 * * 1'     # Weekly on Monday at 8 AM UTC
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - all
          - security
          - dependencies
          - performance
          - metrics

permissions:
  contents: read
  security-events: write

jobs:
  daily-security:
    name: Daily Security Scan
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'security'

    steps:
      - uses: actions/checkout@v4

      - name: Run security scan
        uses: ./.github/workflows/unified-security-scan.yml

  daily-dependencies:
    name: Dependency Updates Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'dependencies'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for dependency updates
        run: |
          pip install pip-audit pip-check-updates
          pip-audit --format json --output dependency-audit.json || true
          pip list --outdated --format json > outdated-deps.json

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            dependency-audit.json
            outdated-deps.json

  daily-performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'performance'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[test,dev] pytest-benchmark

      - name: Run performance benchmarks
        run: |
          pytest tests/benchmarks/ --benchmark-only --benchmark-json=daily-benchmark.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: daily-benchmark-${{ github.run_number }}
          path: daily-benchmark.json
          retention-days: 90

  weekly-metrics:
    name: Weekly Metrics Aggregation
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 8 * * 1' || github.event.inputs.task == 'all' || github.event.inputs.task == 'metrics'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[test,dev]

      - name: Generate coverage trends
        run: |
          pytest --cov=greenlang --cov-report=json --cov-report=html
          python -m coverage json -o coverage-weekly.json

      - name: Collect code metrics
        run: |
          pip install radon
          radon cc greenlang/ -j > complexity-metrics.json
          radon mi greenlang/ -j > maintainability-metrics.json

      - name: Upload weekly metrics
        uses: actions/upload-artifact@v4
        with:
          name: weekly-metrics-${{ github.run_number }}
          path: |
            coverage-weekly.json
            complexity-metrics.json
            maintainability-metrics.json
          retention-days: 365

      - name: Metrics summary
        run: |
          echo "# Weekly Metrics Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: $(python -c "import json; print(json.load(open('coverage-weekly.json'))['totals']['percent_covered'])")" >> $GITHUB_STEP_SUMMARY
          echo "- Run: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
