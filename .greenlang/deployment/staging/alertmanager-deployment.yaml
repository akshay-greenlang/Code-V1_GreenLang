apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: greenlang-enforcement
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      slack_api_url: ${SLACK_WEBHOOK_URL}  # Set via secret

    route:
      receiver: 'default'
      group_by: ['alertname', 'severity', 'team']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h

      routes:
        # Critical alerts - Page immediately
        - match:
            severity: critical
          receiver: 'pagerduty-critical'
          continue: true

        # Critical also to Slack
        - match:
            severity: critical
          receiver: 'slack-critical'

        # Warnings to Slack
        - match:
            severity: warning
          receiver: 'slack-warnings'

        # IUM-specific alerts
        - match:
            alert_type: ium
          receiver: 'slack-ium-team'

        # Security alerts
        - match:
            alert_type: security
          receiver: 'slack-security-team'
          continue: true

        # Security also to email
        - match:
            alert_type: security
          receiver: 'email-security'

    receivers:
      - name: 'default'
        slack_configs:
          - channel: '#greenlang-alerts'
            title: 'GreenLang Enforcement Alert'
            text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
            send_resolved: true

      - name: 'pagerduty-critical'
        pagerduty_configs:
          - service_key: ${PAGERDUTY_SERVICE_KEY}
            description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
            severity: '{{ .Labels.severity }}'

      - name: 'slack-critical'
        slack_configs:
          - channel: '#greenlang-critical'
            color: 'danger'
            title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
              *Team:* {{ .Labels.team }}
            send_resolved: true
            actions:
              - type: button
                text: 'View in Grafana'
                url: '{{ .GeneratorURL }}'
              - type: button
                text: 'Runbook'
                url: 'https://docs.greenlang.io/runbooks/{{ .Labels.alertname }}'

      - name: 'slack-warnings'
        slack_configs:
          - channel: '#greenlang-warnings'
            color: 'warning'
            title: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
            send_resolved: true

      - name: 'slack-ium-team'
        slack_configs:
          - channel: '#greenlang-ium-alerts'
            color: 'warning'
            title: 'üìä IUM Alert: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .Annotations.summary }}
              *Current Score:* {{ .Annotations.current_score }}
              *Threshold:* {{ .Annotations.threshold }}
              *Action Required:* Review and improve IUM score
            send_resolved: true

      - name: 'slack-security-team'
        slack_configs:
          - channel: '#security-alerts'
            color: 'danger'
            title: 'üîí Security Alert: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
            send_resolved: true

      - name: 'email-security'
        email_configs:
          - to: 'security@greenlang.io'
            from: 'alertmanager@greenlang.io'
            smarthost: 'smtp.gmail.com:587'
            auth_username: ${SMTP_USERNAME}
            auth_password: ${SMTP_PASSWORD}
            headers:
              Subject: '[{{ .Labels.severity }}] GreenLang Security Alert: {{ .GroupLabels.alertname }}'

    inhibit_rules:
      # Inhibit warning if critical is firing
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace']

      # Don't alert on instance down if entire service is down
      - source_match:
          alertname: 'ServiceDown'
        target_match:
          alertname: 'InstanceDown'
        equal: ['service']

---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager-service
  namespace: greenlang-enforcement
  labels:
    app: alertmanager
    component: alerting
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9093
      targetPort: 9093
      protocol: TCP
  selector:
    app: alertmanager
    component: alerting

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager-deployment
  namespace: greenlang-enforcement
  labels:
    app: alertmanager
    component: alerting
spec:
  replicas: 2
  selector:
    matchLabels:
      app: alertmanager
      component: alerting
  template:
    metadata:
      labels:
        app: alertmanager
        component: alerting
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534

      containers:
        - name: alertmanager
          image: prom/alertmanager:v0.26.0
          imagePullPolicy: IfNotPresent

          args:
            - '--config.file=/etc/alertmanager/alertmanager.yml'
            - '--storage.path=/alertmanager'
            - '--cluster.listen-address=0.0.0.0:9094'
            - '--web.listen-address=0.0.0.0:9093'
            - '--web.external-url=https://alertmanager.greenlang.io'

          ports:
            - name: http
              containerPort: 9093
              protocol: TCP
            - name: cluster
              containerPort: 9094
              protocol: TCP

          env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: alertmanager-secrets
                  key: slack-webhook-url
            - name: PAGERDUTY_SERVICE_KEY
              valueFrom:
                secretKeyRef:
                  name: alertmanager-secrets
                  key: pagerduty-service-key
            - name: SMTP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: alertmanager-secrets
                  key: smtp-username
            - name: SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: alertmanager-secrets
                  key: smtp-password

          livenessProbe:
            httpGet:
              path: /-/healthy
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10

          readinessProbe:
            httpGet:
              path: /-/ready
              port: http
            initialDelaySeconds: 30
            periodSeconds: 5

          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi

          volumeMounts:
            - name: config
              mountPath: /etc/alertmanager
              readOnly: true
            - name: storage
              mountPath: /alertmanager

      volumes:
        - name: config
          configMap:
            name: alertmanager-config
        - name: storage
          emptyDir: {}

---
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: greenlang-enforcement
type: Opaque
stringData:
  slack-webhook-url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"  # REPLACE
  pagerduty-service-key: "your-pagerduty-service-key"  # REPLACE
  smtp-username: "alerts@greenlang.io"  # REPLACE
  smtp-password: "your-smtp-password"  # REPLACE
