# =============================================================================
# HashiCorp Vault External Secret Configuration
# =============================================================================
# This template creates ExternalSecret resources that sync secrets from
# HashiCorp Vault to Kubernetes secrets using the External Secrets Operator.
#
# Prerequisites:
#   1. External Secrets Operator installed in the cluster
#   2. HashiCorp Vault server accessible from the cluster
#   3. Vault authentication configured (Kubernetes auth recommended)
#   4. Appropriate Vault policies for the service account
#
# Vault Secret Structure (KV v2):
#   secret/data/greenlang/<environment>/database     -> { "url": "...", "host": "...", "password": "..." }
#   secret/data/greenlang/<environment>/redis        -> { "url": "...", "password": "..." }
#   secret/data/greenlang/<environment>/jwt          -> { "secret": "..." }
#   secret/data/greenlang/<environment>/llm          -> { "anthropic_key": "...", "openai_key": "..." }
#   secret/data/greenlang/<environment>/encryption   -> { "key": "..." }
#   secret/data/greenlang/<environment>/pki          -> { "certificate": "...", "private_key": "..." }
#
# Vault Authentication Methods Supported:
#   - Kubernetes (recommended): Uses service account tokens
#   - AppRole: Application-based authentication
#   - Token: Direct token authentication (not recommended for production)
# =============================================================================

{{- if and .Values.secrets.useExternalSecrets (eq .Values.secrets.provider "vault") }}
---
# -----------------------------------------------------------------------------
# ClusterSecretStore for HashiCorp Vault
# Defines how to connect to Vault and authenticate
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: {{ include "greenlang.fullname" . }}-vault-secretstore
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  provider:
    vault:
      # Vault server address
      server: {{ .Values.secrets.vault.address | default "https://vault.vault.svc.cluster.local:8200" }}

      # Vault secrets engine path (KV v2 is default)
      path: {{ .Values.secrets.vault.secretsEngine | default "secret" }}
      version: {{ .Values.secrets.vault.kvVersion | default "v2" }}

      # Vault namespace (for Vault Enterprise)
      {{- if .Values.secrets.vault.namespace }}
      namespace: {{ .Values.secrets.vault.namespace }}
      {{- end }}

      # TLS configuration
      {{- if .Values.secrets.vault.caBundle }}
      caBundle: {{ .Values.secrets.vault.caBundle | quote }}
      {{- end }}
      {{- if .Values.secrets.vault.caProvider }}
      caProvider:
        type: {{ .Values.secrets.vault.caProvider.type }}
        name: {{ .Values.secrets.vault.caProvider.name }}
        key: {{ .Values.secrets.vault.caProvider.key }}
        namespace: {{ .Values.secrets.vault.caProvider.namespace | default (include "greenlang.namespace" .) }}
      {{- end }}

      # Authentication method
      {{- if eq .Values.secrets.vault.authMethod "kubernetes" }}
      # Kubernetes authentication (recommended)
      auth:
        kubernetes:
          mountPath: {{ .Values.secrets.vault.kubernetes.mountPath | default "kubernetes" }}
          role: {{ .Values.secrets.vault.kubernetes.role | default "greenlang-app" }}
          serviceAccountRef:
            name: {{ include "greenlang.serviceAccountName" . }}
            namespace: {{ include "greenlang.namespace" . }}
      {{- else if eq .Values.secrets.vault.authMethod "approle" }}
      # AppRole authentication
      auth:
        appRole:
          path: {{ .Values.secrets.vault.appRole.path | default "approle" }}
          roleId: {{ .Values.secrets.vault.appRole.roleId }}
          secretRef:
            name: {{ .Values.secrets.vault.appRole.secretRef.name }}
            key: {{ .Values.secrets.vault.appRole.secretRef.key | default "secret-id" }}
            namespace: {{ include "greenlang.namespace" . }}
      {{- else if eq .Values.secrets.vault.authMethod "token" }}
      # Token authentication (not recommended for production)
      auth:
        tokenSecretRef:
          name: {{ .Values.secrets.vault.token.secretRef.name }}
          key: {{ .Values.secrets.vault.token.secretRef.key | default "token" }}
          namespace: {{ include "greenlang.namespace" . }}
      {{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - Main Application Secrets
# Syncs all application secrets from Vault
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-secrets
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
  annotations:
    description: "GreenLang application secrets from HashiCorp Vault"
spec:
  # How often to sync secrets from Vault
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-vault-secretstore
    kind: ClusterSecretStore

  # Target Kubernetes secret configuration
  target:
    name: {{ include "greenlang.fullname" . }}-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "greenlang.labels" . | nindent 10 }}
        annotations:
          description: "Auto-synced from HashiCorp Vault"
          external-secrets.io/managed: "true"

  # Data mappings from Vault to Kubernetes secret keys
  data:
    # Database credentials
    - secretKey: DATABASE_URL
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: url

    - secretKey: GREENLANG_DATABASE_URL
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: url

    - secretKey: DATABASE_HOST
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: host

    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: password

    # Redis credentials
    - secretKey: REDIS_URL
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: url

    - secretKey: GREENLANG_REDIS_URL
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: url

    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: password

    # JWT Secret
    - secretKey: GREENLANG_JWT_SECRET
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/jwt
        property: secret

    - secretKey: JWT_SECRET
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/jwt
        property: secret

    # LLM API Keys
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/llm
        property: anthropic_key

    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/llm
        property: openai_key

    # Data Encryption Key
    - secretKey: DATA_ENCRYPTION_KEY
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/encryption
        property: key

---
# -----------------------------------------------------------------------------
# ExternalSecret - Database Credentials (PostgreSQL subchart)
# Separate secret for database authentication if using Bitnami PostgreSQL
# -----------------------------------------------------------------------------
{{- if .Values.postgresql.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-postgresql-credentials
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-vault-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ include "greenlang.fullname" . }}-postgresql-credentials
    creationPolicy: Owner
  data:
    - secretKey: postgres-password
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: postgres_password

    - secretKey: password
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: password

    - secretKey: replication-password
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/database
        property: replication_password
{{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - Redis Credentials (Redis subchart)
# Separate secret for Redis authentication if using Bitnami Redis
# -----------------------------------------------------------------------------
{{- if .Values.redis.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-redis-credentials
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-vault-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ include "greenlang.fullname" . }}-redis-credentials
    creationPolicy: Owner
  data:
    - secretKey: redis-password
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/redis
        property: password
{{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - TLS Certificate from Vault PKI
# For managing TLS certificates via Vault's PKI secrets engine
# -----------------------------------------------------------------------------
{{- if and .Values.ingress.enabled .Values.secrets.vault.tlsSecretEnabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-tls
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
spec:
  # TLS certificates should refresh more frequently
  refreshInterval: {{ .Values.secrets.vault.tlsRefreshInterval | default "24h" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-vault-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ .Values.ingress.tls.secretName | default (printf "%s-tls" (include "greenlang.fullname" .)) }}
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/pki
        property: certificate

    - secretKey: tls.key
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/pki
        property: private_key

    {{- if .Values.secrets.vault.tlsIncludeCA }}
    - secretKey: ca.crt
      remoteRef:
        key: {{ .Values.secrets.vault.secretsPath | default "greenlang" }}/{{ .Values.config.appEnv }}/pki
        property: ca_chain
    {{- end }}
{{- end }}

---
# -----------------------------------------------------------------------------
# ExternalSecret - Dynamic Database Credentials (Optional)
# Uses Vault's database secrets engine for dynamic credentials
# Requires Vault database secrets engine configured for PostgreSQL
# -----------------------------------------------------------------------------
{{- if .Values.secrets.vault.dynamicDatabaseCredentials }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang.fullname" . }}-dynamic-db-creds
  namespace: {{ include "greenlang.namespace" . }}
  labels:
    {{- include "greenlang.labels" . | nindent 4 }}
  annotations:
    description: "Dynamic database credentials from Vault database secrets engine"
spec:
  # Dynamic credentials need frequent refresh (TTL-based)
  refreshInterval: {{ .Values.secrets.vault.dynamicDbRefreshInterval | default "5m" }}
  secretStoreRef:
    name: {{ include "greenlang.fullname" . }}-vault-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ include "greenlang.fullname" . }}-dynamic-db-creds
    creationPolicy: Owner
    template:
      type: Opaque
      # Template to construct connection string from dynamic credentials
      data:
        DATABASE_URL: "postgresql://{{ `{{ .username }}` }}:{{ `{{ .password }}` }}@{{ .Values.secrets.vault.dynamicDbHost }}:5432/{{ .Values.secrets.vault.dynamicDbName | default "greenlang" }}"
  dataFrom:
    - extract:
        key: database/creds/{{ .Values.secrets.vault.dynamicDbRole | default "greenlang-app" }}
{{- end }}

{{- end }}
