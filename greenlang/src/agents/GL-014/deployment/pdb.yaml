# ==============================================================================
# GL-014 EXCHANGER-PRO - Pod Disruption Budget
# ==============================================================================
# Pod Disruption Budget ensures high availability during voluntary disruptions
# such as:
#   - Node drains for maintenance
#   - Cluster upgrades
#   - Node autoscaling scale-down
#   - Deployment rollouts
#
# This policy ensures at least 1 pod (minAvailable: 1) is always available
# ==============================================================================
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gl-014-exchanger-pro-pdb
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/name: gl-014-exchanger-pro
    app.kubernetes.io/component: pdb
    app.kubernetes.io/part-of: greenlang-platform
    team: iota
  annotations:
    description: "GL-014 EXCHANGER-PRO - Pod Disruption Budget for high availability"
spec:
  # Minimum number of pods that must be available during disruption
  # Use minAvailable OR maxUnavailable, not both
  minAvailable: 1

  # Alternative: Maximum number of pods that can be unavailable
  # maxUnavailable: 1

  # Selector to match pods covered by this PDB
  selector:
    matchLabels:
      app: gl-014-exchanger-pro

  # Unhealthy pod eviction policy (Kubernetes 1.26+)
  # Options: IfHealthyBudget, AlwaysAllow
  # IfHealthyBudget: Only allow eviction of unhealthy pods if budget is satisfied
  # AlwaysAllow: Always allow eviction of unhealthy pods
  unhealthyPodEvictionPolicy: IfHealthyBudget

---
# ==============================================================================
# PDB with Percentage-Based Availability
# ==============================================================================
# Alternative PDB using percentage instead of absolute number
# Useful when replica count varies (e.g., with HPA)
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gl-014-exchanger-pro-pdb-percent
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/name: gl-014-exchanger-pro
    app.kubernetes.io/component: pdb-percent
  annotations:
    description: "GL-014 EXCHANGER-PRO - Percentage-based PDB"
spec:
  # Allow at most 25% of pods to be unavailable
  maxUnavailable: "25%"

  selector:
    matchLabels:
      app: gl-014-exchanger-pro

---
# ==============================================================================
# Service Account for GL-014 EXCHANGER-PRO
# ==============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-014-exchanger-pro-sa
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/name: gl-014-exchanger-pro
    app.kubernetes.io/component: serviceaccount
  annotations:
    description: "Service account for GL-014 EXCHANGER-PRO pods"
    # AWS IAM role annotation (if using IRSA)
    # eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/gl-014-exchanger-pro-role
automountServiceAccountToken: true

---
# ==============================================================================
# Role for GL-014 EXCHANGER-PRO
# ==============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-014-exchanger-pro-role
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/component: rbac
spec:
  rules:
    # Allow reading configmaps
    - apiGroups: [""]
      resources: ["configmaps"]
      verbs: ["get", "list", "watch"]

    # Allow reading secrets
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get", "list"]

    # Allow reading service endpoints
    - apiGroups: [""]
      resources: ["endpoints", "services"]
      verbs: ["get", "list", "watch"]

    # Allow reading pods for health checks
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list", "watch"]

---
# ==============================================================================
# RoleBinding for GL-014 EXCHANGER-PRO
# ==============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-014-exchanger-pro-rolebinding
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: gl-014-exchanger-pro-sa
    namespace: greenlang
roleRef:
  kind: Role
  name: gl-014-exchanger-pro-role
  apiGroup: rbac.authorization.k8s.io

---
# ==============================================================================
# PersistentVolumeClaim for Model Storage
# ==============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gl-014-exchanger-pro-models-pvc
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/component: storage
spec:
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard-rwo
  # If using existing PV
  # volumeName: gl-014-exchanger-pro-models-pv

---
# ==============================================================================
# ResourceQuota for GL-014 EXCHANGER-PRO
# ==============================================================================
apiVersion: v1
kind: ResourceQuota
metadata:
  name: gl-014-exchanger-pro-quota
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/component: quota
spec:
  hard:
    # Compute resources
    requests.cpu: "10"
    requests.memory: "20Gi"
    limits.cpu: "40"
    limits.memory: "40Gi"
    # Storage
    requests.storage: "50Gi"
    persistentvolumeclaims: "5"
    # Object counts
    pods: "20"
    services: "10"
    configmaps: "10"
    secrets: "10"

---
# ==============================================================================
# LimitRange for GL-014 EXCHANGER-PRO
# ==============================================================================
apiVersion: v1
kind: LimitRange
metadata:
  name: gl-014-exchanger-pro-limits
  namespace: greenlang
  labels:
    app: gl-014-exchanger-pro
    app.kubernetes.io/component: limits
spec:
  limits:
    # Container defaults
    - type: Container
      default:
        cpu: "1000m"
        memory: "2Gi"
      defaultRequest:
        cpu: "500m"
        memory: "1Gi"
      max:
        cpu: "4000m"
        memory: "4Gi"
      min:
        cpu: "100m"
        memory: "128Mi"
    # Pod limits
    - type: Pod
      max:
        cpu: "8000m"
        memory: "16Gi"
      min:
        cpu: "100m"
        memory: "128Mi"
