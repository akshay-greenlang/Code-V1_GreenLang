# ==============================================================================
# GL-015 INSULSCAN - Kubernetes Service
# ==============================================================================
# Service configuration for insulation inspection agent
# Exposes application and metrics endpoints
# ==============================================================================
apiVersion: v1
kind: Service
metadata:
  name: gl-015-insulscan
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: agent
    app.kubernetes.io/part-of: greenlang
    greenlang.io/agent-id: gl-015
    greenlang.io/agent-codename: insulscan
  annotations:
    description: "Service for GL-015 INSULSCAN insulation inspection agent"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP

  selector:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015

  ports:
    # Main application HTTP port
    - name: http
      port: 80
      targetPort: 8000
      protocol: TCP

    # Prometheus metrics port
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP

  # Session affinity for consistent routing (optional)
  sessionAffinity: None

  # IP family configuration
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv4

---
# ==============================================================================
# Headless Service for StatefulSet or direct pod access
# ==============================================================================
apiVersion: v1
kind: Service
metadata:
  name: gl-015-insulscan-headless
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
    service-type: headless
  annotations:
    description: "Headless service for direct pod access"
spec:
  type: ClusterIP
  clusterIP: None

  selector:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan

  ports:
    - name: http
      port: 8000
      targetPort: 8000
      protocol: TCP

  publishNotReadyAddresses: false

---
# ==============================================================================
# Internal Service for inter-agent communication
# ==============================================================================
apiVersion: v1
kind: Service
metadata:
  name: gl-015-insulscan-internal
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
    service-type: internal
  annotations:
    description: "Internal service for GreenLang agent network communication"
spec:
  type: ClusterIP

  selector:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan

  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
      protocol: TCP

    - name: http-internal
      port: 8080
      targetPort: 8080
      protocol: TCP

---
# ==============================================================================
# External Load Balancer Service (Optional - for direct external access)
# ==============================================================================
# Uncomment if direct LoadBalancer access is needed instead of Ingress
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: gl-015-insulscan-lb
#   namespace: greenlang
#   labels:
#     app: gl-015-insulscan
#     service-type: loadbalancer
#   annotations:
#     # AWS NLB annotations
#     service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
#     service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
#     service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
#     # GCP annotations
#     # cloud.google.com/load-balancer-type: "External"
#     # Azure annotations
#     # service.beta.kubernetes.io/azure-load-balancer-internal: "false"
# spec:
#   type: LoadBalancer
#
#   selector:
#     app: gl-015-insulscan
#
#   ports:
#     - name: https
#       port: 443
#       targetPort: 8000
#       protocol: TCP
#
#   # Restrict access to specific IPs
#   loadBalancerSourceRanges:
#     - 10.0.0.0/8
#     - 172.16.0.0/12
#     - 192.168.0.0/16
#
#   externalTrafficPolicy: Local
#   healthCheckNodePort: 30000

---
# ==============================================================================
# ServiceMonitor for Prometheus Operator
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: gl-015-insulscan
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
    release: prometheus
spec:
  selector:
    matchLabels:
      app: gl-015-insulscan
      app.kubernetes.io/name: insulscan

  namespaceSelector:
    matchNames:
      - greenlang

  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      scheme: http

      # Metric relabeling
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'go_.*'
          action: drop

      # Target relabeling
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - targetLabel: agent_id
          replacement: gl-015
        - targetLabel: agent_codename
          replacement: insulscan
