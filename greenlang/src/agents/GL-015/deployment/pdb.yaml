# ==============================================================================
# GL-015 INSULSCAN - Pod Disruption Budget
# ==============================================================================
# Ensures high availability during voluntary disruptions
# (node maintenance, cluster upgrades, etc.)
# ==============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gl-015-insulscan-pdb
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: availability
    app.kubernetes.io/part-of: greenlang
    greenlang.io/agent-id: gl-015
    greenlang.io/agent-codename: insulscan
  annotations:
    description: "Pod Disruption Budget for GL-015 INSULSCAN"
spec:
  # Minimum available pods during disruption
  # Use minAvailable OR maxUnavailable, not both
  minAvailable: 2

  # Alternative: Maximum unavailable pods
  # maxUnavailable: 1

  # Pod selector
  selector:
    matchLabels:
      app: gl-015-insulscan
      app.kubernetes.io/name: insulscan
      app.kubernetes.io/instance: gl-015

  # Unhealthy pod eviction policy (Kubernetes 1.27+)
  # - IfHealthyBudget: Only evict unhealthy pods if budget allows
  # - AlwaysAllow: Always allow eviction of unhealthy pods
  unhealthyPodEvictionPolicy: IfHealthyBudget

---
# ==============================================================================
# PDB for GPU-enabled deployment (if applicable)
# ==============================================================================
# apiVersion: policy/v1
# kind: PodDisruptionBudget
# metadata:
#   name: gl-015-insulscan-gpu-pdb
#   namespace: greenlang
#   labels:
#     app: gl-015-insulscan-gpu
#     variant: gpu
# spec:
#   # For GPU workloads, ensure at least 1 pod is always available
#   minAvailable: 1
#   selector:
#     matchLabels:
#       app: gl-015-insulscan-gpu

---
# ==============================================================================
# Priority Class for Critical Workloads
# ==============================================================================
# Ensures the agent pods are scheduled with appropriate priority
# ---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: gl-015-insulscan-high-priority
  labels:
    app: gl-015-insulscan
    greenlang.io/agent-id: gl-015
# Priority value (higher = more important)
# System critical: 2000000000
# Cluster critical: 1000000000
# Default: 0
value: 100000
globalDefault: false
preemptionPolicy: PreemptLowerPriority
description: "High priority for GL-015 INSULSCAN insulation inspection agent"

---
# ==============================================================================
# Resource Quota for Namespace (Optional)
# ==============================================================================
# Limits total resources the agent can consume in the namespace
# ---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: gl-015-insulscan-quota
  namespace: greenlang
  labels:
    app: gl-015-insulscan
spec:
  hard:
    # Pod limits
    pods: "20"

    # CPU limits
    requests.cpu: "10"
    limits.cpu: "20"

    # Memory limits
    requests.memory: "10Gi"
    limits.memory: "30Gi"

    # Storage limits
    requests.storage: "100Gi"
    persistentvolumeclaims: "10"

    # GPU limits (if applicable)
    # requests.nvidia.com/gpu: "4"
    # limits.nvidia.com/gpu: "4"

    # Service limits
    services: "10"
    services.loadbalancers: "2"
    services.nodeports: "5"

    # Config map and secret limits
    configmaps: "20"
    secrets: "20"

  # Scopes can limit which pods count against quota
  # scopes:
  #   - NotTerminating
  #   - BestEffort
  #   - NotBestEffort

---
# ==============================================================================
# Limit Range for Default Resources
# ==============================================================================
# Sets default resource requests/limits for containers without explicit values
# ---
apiVersion: v1
kind: LimitRange
metadata:
  name: gl-015-insulscan-limits
  namespace: greenlang
  labels:
    app: gl-015-insulscan
spec:
  limits:
    # Default container limits
    - type: Container
      default:
        cpu: "1000m"
        memory: "1Gi"
      defaultRequest:
        cpu: "250m"
        memory: "256Mi"
      min:
        cpu: "50m"
        memory: "64Mi"
      max:
        cpu: "4000m"
        memory: "8Gi"
      maxLimitRequestRatio:
        cpu: "4"
        memory: "4"

    # Pod-level limits
    - type: Pod
      max:
        cpu: "8000m"
        memory: "16Gi"

    # PVC storage limits
    - type: PersistentVolumeClaim
      min:
        storage: "1Gi"
      max:
        storage: "100Gi"
