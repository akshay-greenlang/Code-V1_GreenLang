# ==============================================================================
# GL-015 INSULSCAN - Network Policies
# ==============================================================================
# Network security policies for insulation inspection agent
# Implements zero-trust network model with explicit allow rules
# ==============================================================================

# ------------------------------------------------------------------------------
# Default Deny All Ingress
# ------------------------------------------------------------------------------
# Deny all incoming traffic by default - must explicitly allow
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-default-deny-ingress
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
    policy-type: default-deny
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Ingress

---
# ------------------------------------------------------------------------------
# Default Deny All Egress
# ------------------------------------------------------------------------------
# Deny all outgoing traffic by default - must explicitly allow
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-default-deny-egress
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: default-deny
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress

---
# ------------------------------------------------------------------------------
# Allow Ingress from Ingress Controller
# ------------------------------------------------------------------------------
# Allow traffic from NGINX Ingress Controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-ingress
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-ingress
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Ingress
  ingress:
    # Allow from NGINX Ingress Controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8000

    # Allow from internal load balancer
    - from:
        - namespaceSelector:
            matchLabels:
              name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: TCP
          port: 8000

---
# ------------------------------------------------------------------------------
# Allow Ingress from Prometheus
# ------------------------------------------------------------------------------
# Allow Prometheus to scrape metrics
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-prometheus
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-monitoring
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
        - namespaceSelector:
            matchLabels:
              name: monitoring
          podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9090

---
# ------------------------------------------------------------------------------
# Allow Ingress from Other GreenLang Agents
# ------------------------------------------------------------------------------
# Allow inter-agent communication within GreenLang namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-agents
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-agents
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: greenlang
          podSelector:
            matchLabels:
              app.kubernetes.io/part-of: greenlang
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 50051

---
# ------------------------------------------------------------------------------
# Allow Egress to Database
# ------------------------------------------------------------------------------
# Allow outbound connections to PostgreSQL database
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-database
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-database
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    # PostgreSQL within namespace
    - to:
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432

    # External RDS (AWS)
    - to:
        - ipBlock:
            cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 5432

---
# ------------------------------------------------------------------------------
# Allow Egress to Redis
# ------------------------------------------------------------------------------
# Allow outbound connections to Redis cache
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-redis
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-redis
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    # Redis within namespace
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # External ElastiCache (AWS)
    - to:
        - ipBlock:
            cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 6379

---
# ------------------------------------------------------------------------------
# Allow Egress to DNS
# ------------------------------------------------------------------------------
# Allow DNS resolution (required for most operations)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-dns
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-dns
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# ------------------------------------------------------------------------------
# Allow Egress to AWS Services
# ------------------------------------------------------------------------------
# Allow connections to AWS S3, Secrets Manager, CloudWatch
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-aws
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-aws
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    # AWS services via VPC endpoints or NAT
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# ------------------------------------------------------------------------------
# Allow Egress to Monitoring Stack
# ------------------------------------------------------------------------------
# Allow connections to OpenTelemetry collector, Prometheus, etc.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-monitoring-egress
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-monitoring-egress
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    # OpenTelemetry Collector
    - to:
        - namespaceSelector:
            matchLabels:
              name: observability
          podSelector:
            matchLabels:
              app: otel-collector
      ports:
        - protocol: TCP
          port: 4317
        - protocol: TCP
          port: 4318

    # Prometheus Pushgateway (if needed)
    - to:
        - namespaceSelector:
            matchLabels:
              name: monitoring
          podSelector:
            matchLabels:
              app: prometheus-pushgateway
      ports:
        - protocol: TCP
          port: 9091

---
# ------------------------------------------------------------------------------
# Allow Egress to Other GreenLang Agents
# ------------------------------------------------------------------------------
# Allow inter-agent communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-agents-egress
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-agents-egress
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: greenlang
          podSelector:
            matchLabels:
              app.kubernetes.io/part-of: greenlang
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 50051

---
# ------------------------------------------------------------------------------
# Allow Egress to CMMS Integration
# ------------------------------------------------------------------------------
# Allow outbound connections to external CMMS system
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gl-015-insulscan-allow-cmms
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    policy-type: allow-cmms
spec:
  podSelector:
    matchLabels:
      app: gl-015-insulscan
  policyTypes:
    - Egress
  egress:
    # External CMMS API (HTTPS)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# ------------------------------------------------------------------------------
# Service Account
# ------------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-015-insulscan-sa
  namespace: greenlang
  labels:
    app: gl-015-insulscan
    app.kubernetes.io/name: insulscan
    app.kubernetes.io/instance: gl-015
  annotations:
    # For AWS IRSA (IAM Roles for Service Accounts)
    # eks.amazonaws.com/role-arn: "arn:aws:iam::123456789:role/gl-015-insulscan-role"
automountServiceAccountToken: true

---
# ------------------------------------------------------------------------------
# RBAC Role
# ------------------------------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-015-insulscan-role
  namespace: greenlang
  labels:
    app: gl-015-insulscan
rules:
  # Allow reading ConfigMaps and Secrets (own resources only)
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    resourceNames: ["gl-015-insulscan-config", "gl-015-insulscan-secrets"]
    verbs: ["get", "list", "watch"]

  # Allow reading own pods for self-monitoring
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Allow reading events for debugging
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

---
# ------------------------------------------------------------------------------
# RBAC Role Binding
# ------------------------------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-015-insulscan-rolebinding
  namespace: greenlang
  labels:
    app: gl-015-insulscan
subjects:
  - kind: ServiceAccount
    name: gl-015-insulscan-sa
    namespace: greenlang
roleRef:
  kind: Role
  name: gl-015-insulscan-role
  apiGroup: rbac.authorization.k8s.io
