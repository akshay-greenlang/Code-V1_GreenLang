# ==============================================================================
# GL-013 PREDICTMAINT - Pod Disruption Budget
# ==============================================================================
# Pod Disruption Budget ensures high availability during voluntary disruptions
# such as:
#   - Node drains for maintenance
#   - Cluster upgrades
#   - Node autoscaling scale-down
#   - Deployment rollouts
#
# This policy ensures at least 2 pods (or 50%) are always available
# ==============================================================================
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gl-013-predictmaint-pdb
  namespace: greenlang
  labels:
    app: gl-013-predictmaint
    app.kubernetes.io/name: gl-013-predictmaint
    app.kubernetes.io/component: pdb
    app.kubernetes.io/part-of: greenlang-platform
    team: iota
  annotations:
    description: "GL-013 PREDICTMAINT - Pod Disruption Budget for high availability"
spec:
  # Minimum number of pods that must be available during disruption
  # Use minAvailable OR maxUnavailable, not both
  minAvailable: 2

  # Alternative: Maximum number of pods that can be unavailable
  # maxUnavailable: 1

  # Selector to match pods covered by this PDB
  selector:
    matchLabels:
      app: gl-013-predictmaint

  # Unhealthy pod eviction policy (Kubernetes 1.26+)
  # Options: IfHealthyBudget, AlwaysAllow
  # IfHealthyBudget: Only allow eviction of unhealthy pods if budget is satisfied
  # AlwaysAllow: Always allow eviction of unhealthy pods
  unhealthyPodEvictionPolicy: IfHealthyBudget

---
# ==============================================================================
# PDB with Percentage-Based Availability
# ==============================================================================
# Alternative PDB using percentage instead of absolute number
# Useful when replica count varies (e.g., with HPA)
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gl-013-predictmaint-pdb-percent
  namespace: greenlang
  labels:
    app: gl-013-predictmaint
    app.kubernetes.io/name: gl-013-predictmaint
    app.kubernetes.io/component: pdb-percent
  annotations:
    description: "GL-013 PREDICTMAINT - Percentage-based PDB"
spec:
  # Allow at most 25% of pods to be unavailable
  maxUnavailable: "25%"

  selector:
    matchLabels:
      app: gl-013-predictmaint

---
# ==============================================================================
# Service Account for GL-013 PREDICTMAINT
# ==============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-013-predictmaint-sa
  namespace: greenlang
  labels:
    app: gl-013-predictmaint
    app.kubernetes.io/name: gl-013-predictmaint
    app.kubernetes.io/component: serviceaccount
  annotations:
    description: "Service account for GL-013 PREDICTMAINT pods"
    # AWS IAM role annotation (if using IRSA)
    # eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/gl-013-predictmaint-role
automountServiceAccountToken: true

---
# ==============================================================================
# Role for GL-013 PREDICTMAINT
# ==============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-013-predictmaint-role
  namespace: greenlang
  labels:
    app: gl-013-predictmaint
    app.kubernetes.io/component: rbac
spec:
  rules:
    # Allow reading configmaps
    - apiGroups: [""]
      resources: ["configmaps"]
      verbs: ["get", "list", "watch"]

    # Allow reading secrets
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get", "list"]

    # Allow reading service endpoints
    - apiGroups: [""]
      resources: ["endpoints", "services"]
      verbs: ["get", "list", "watch"]

---
# ==============================================================================
# RoleBinding for GL-013 PREDICTMAINT
# ==============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-013-predictmaint-rolebinding
  namespace: greenlang
  labels:
    app: gl-013-predictmaint
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: gl-013-predictmaint-sa
    namespace: greenlang
roleRef:
  kind: Role
  name: gl-013-predictmaint-role
  apiGroup: rbac.authorization.k8s.io
