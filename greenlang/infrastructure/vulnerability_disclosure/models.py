# -*- coding: utf-8 -*-
"""
Vulnerability Disclosure Program Data Models - SEC-010

Pydantic v2 models for the GreenLang VDP system. Provides strongly-typed
data structures for vulnerability reports, submissions, researchers,
bounty payments, and workflow state management.

All datetime fields use UTC. All models enforce strict validation via
Pydantic v2 field validators and model configuration.

Models:
    - Severity: Vulnerability severity levels (critical, high, medium, low, informational)
    - SubmissionStatus: Submission workflow states
    - PaymentStatus: Bounty payment workflow states
    - VulnerabilityReport: Core report submitted by researcher
    - Submission: Full submission record with workflow state
    - Researcher: Security researcher profile
    - BountyPayment: Bounty payment record
    - DisclosureAdvisory: Public security advisory for disclosure

Example:
    >>> from greenlang.infrastructure.vulnerability_disclosure.models import (
    ...     VulnerabilityReport, Submission, Severity, SubmissionStatus
    ... )
    >>> report = VulnerabilityReport(
    ...     title="SQL Injection in User Search",
    ...     description="The user search endpoint is vulnerable to SQL injection...",
    ...     steps_to_reproduce=["Step 1: Navigate to /api/users/search", ...],
    ...     impact="Full database access possible",
    ...     affected_component="user-service",
    ... )
"""

from __future__ import annotations

import re
import uuid
from datetime import datetime, timedelta, timezone
from decimal import Decimal
from enum import Enum
from typing import Any, Dict, List, Optional

from pydantic import (
    BaseModel,
    ConfigDict,
    EmailStr,
    Field,
    field_validator,
    model_validator,
)


# ---------------------------------------------------------------------------
# Constants
# ---------------------------------------------------------------------------

_SUBMISSION_ID_PATTERN = re.compile(r"^VDP-\d{4}-\d{4,6}$")
"""Valid submission ID pattern: VDP-YYYY-NNNN (e.g., VDP-2026-0001)."""


# ---------------------------------------------------------------------------
# Enumerations
# ---------------------------------------------------------------------------


class Severity(str, Enum):
    """Vulnerability severity levels aligned with CVSS 3.1 qualitative scale.

    Severity determines disclosure timeline and bounty amount.
    """

    CRITICAL = "critical"
    """CVSS 9.0-10.0: Immediate exploitation risk, full system compromise."""

    HIGH = "high"
    """CVSS 7.0-8.9: Significant security impact, requires prompt attention."""

    MEDIUM = "medium"
    """CVSS 4.0-6.9: Moderate impact, exploitable under certain conditions."""

    LOW = "low"
    """CVSS 0.1-3.9: Limited impact, difficult to exploit."""

    INFORMATIONAL = "informational"
    """CVSS 0.0: Security best practice, no direct exploitation path."""


class SubmissionStatus(str, Enum):
    """Submission workflow states for vulnerability lifecycle.

    State transitions:
        submitted -> acknowledged -> triaging -> confirmed/duplicate/invalid
        confirmed -> remediation -> fixed -> disclosed -> closed
        duplicate/invalid -> closed
    """

    SUBMITTED = "submitted"
    """Initial state when report is received."""

    ACKNOWLEDGED = "acknowledged"
    """Auto-acknowledgment sent within 24 hours."""

    TRIAGING = "triaging"
    """Security team is assessing the report."""

    CONFIRMED = "confirmed"
    """Vulnerability confirmed as valid."""

    DUPLICATE = "duplicate"
    """Report is a duplicate of an existing submission."""

    INVALID = "invalid"
    """Report is not a valid security vulnerability."""

    REMEDIATION = "remediation"
    """Engineering team is working on a fix."""

    FIXED = "fixed"
    """Fix has been deployed to production."""

    DISCLOSED = "disclosed"
    """Public security advisory has been published."""

    CLOSED = "closed"
    """Submission workflow is complete."""


class PaymentStatus(str, Enum):
    """Bounty payment workflow states.

    State transitions:
        pending -> approved -> processing -> paid
        pending -> rejected
        processing -> failed -> pending (retry)
    """

    PENDING = "pending"
    """Payment created, awaiting approval."""

    APPROVED = "approved"
    """Payment approved by security lead."""

    PROCESSING = "processing"
    """Payment is being processed by payment provider."""

    PAID = "paid"
    """Payment completed successfully."""

    REJECTED = "rejected"
    """Payment request was rejected."""

    FAILED = "failed"
    """Payment processing failed, may retry."""


class IdentityVerificationMethod(str, Enum):
    """Methods for verifying researcher identity for bounty payments."""

    NONE = "none"
    """No verification performed."""

    EMAIL = "email"
    """Email verification only."""

    PGP = "pgp"
    """PGP key signature verification."""

    KYC = "kyc"
    """Full KYC verification (required for large payments)."""


# ---------------------------------------------------------------------------
# Core Report Model
# ---------------------------------------------------------------------------


class VulnerabilityReport(BaseModel):
    """Core vulnerability report submitted by a security researcher.

    Contains all the information needed to understand and reproduce
    the vulnerability. This is the public-facing submission format.

    Attributes:
        title: Brief summary of the vulnerability (5-200 chars).
        description: Detailed description of the security issue.
        steps_to_reproduce: Ordered list of steps to reproduce the issue.
        impact: Description of the security impact if exploited.
        affected_component: Service, module, or feature affected.
        proof_of_concept: Optional code, screenshots, or video links.
        suggested_fix: Optional suggested remediation approach.
        references: Optional list of related CVEs or security advisories.
    """

    model_config = ConfigDict(
        extra="forbid",
        str_strip_whitespace=True,
        json_schema_extra={
            "examples": [
                {
                    "title": "SQL Injection in User Search API",
                    "description": "The /api/v1/users/search endpoint is vulnerable...",
                    "steps_to_reproduce": [
                        "1. Navigate to /api/v1/users/search",
                        "2. Enter payload: ' OR '1'='1",
                        "3. Observe SQL error in response",
                    ],
                    "impact": "Full database access possible",
                    "affected_component": "user-service",
                }
            ]
        },
    )

    title: str = Field(
        ...,
        min_length=5,
        max_length=200,
        description="Brief summary of the vulnerability.",
    )
    description: str = Field(
        ...,
        min_length=20,
        max_length=50000,
        description="Detailed description of the security issue.",
    )
    steps_to_reproduce: List[str] = Field(
        ...,
        min_length=1,
        max_length=50,
        description="Ordered steps to reproduce the vulnerability.",
    )
    impact: str = Field(
        ...,
        min_length=10,
        max_length=5000,
        description="Description of security impact if exploited.",
    )
    affected_component: str = Field(
        ...,
        min_length=1,
        max_length=200,
        description="Service, module, or feature affected.",
    )
    proof_of_concept: Optional[str] = Field(
        default=None,
        max_length=100000,
        description="Code, screenshots, or video links demonstrating the issue.",
    )
    suggested_fix: Optional[str] = Field(
        default=None,
        max_length=10000,
        description="Suggested remediation approach.",
    )
    references: List[str] = Field(
        default_factory=list,
        max_length=20,
        description="Related CVEs, security advisories, or research papers.",
    )

    @field_validator("steps_to_reproduce")
    @classmethod
    def validate_steps(cls, v: List[str]) -> List[str]:
        """Ensure steps are non-empty and stripped."""
        cleaned = [step.strip() for step in v if step.strip()]
        if not cleaned:
            raise ValueError("At least one reproduction step is required.")
        return cleaned

    @field_validator("references")
    @classmethod
    def validate_references(cls, v: List[str]) -> List[str]:
        """Strip and deduplicate references."""
        cleaned = list(dict.fromkeys(ref.strip() for ref in v if ref.strip()))
        return cleaned


# ---------------------------------------------------------------------------
# Submission Model
# ---------------------------------------------------------------------------


class Submission(BaseModel):
    """Full submission record with workflow state and metadata.

    Represents the complete lifecycle of a vulnerability submission,
    from initial report through triage, remediation, and disclosure.

    Attributes:
        id: Internal UUID for database operations.
        submission_id: Public-facing ID (e.g., VDP-2026-0001).
        report: The vulnerability report content.
        severity: Assessed severity level (set during triage).
        status: Current workflow status.
        researcher_email: Contact email for the researcher.
        researcher_id: Optional link to Researcher record.
        cvss_score: CVSS 3.1 base score (0.0-10.0).
        cvss_vector: CVSS 3.1 vector string.
        bounty_amount: Awarded bounty amount in cents.
        bounty_currency: Currency code (default: USD).
        duplicate_of: If duplicate, the original submission ID.
        rejection_reason: If invalid, the reason for rejection.
        fix_commit_sha: Git commit SHA for the fix.
        fix_deployed_at: Timestamp when fix was deployed.
        disclosure_deadline: Deadline for public disclosure.
        disclosed_at: Timestamp of public disclosure.
        advisory_url: URL to public security advisory.
        assessor_id: User ID of the security analyst who triaged.
        submitted_at: Timestamp of initial submission.
        acknowledged_at: Timestamp of acknowledgment.
        triaged_at: Timestamp when triage completed.
        confirmed_at: Timestamp when confirmed as valid.
        fixed_at: Timestamp when fix was verified.
        closed_at: Timestamp when submission was closed.
        metadata: Arbitrary key-value metadata.
        notes: Internal notes from security team.
    """

    model_config = ConfigDict(
        extra="forbid",
        str_strip_whitespace=True,
    )

    id: str = Field(
        default_factory=lambda: str(uuid.uuid4()),
        description="Internal UUID for database operations.",
    )
    submission_id: str = Field(
        ...,
        min_length=10,
        max_length=20,
        description="Public-facing submission ID (e.g., VDP-2026-0001).",
    )
    report: VulnerabilityReport = Field(
        ...,
        description="The vulnerability report content.",
    )
    severity: Optional[Severity] = Field(
        default=None,
        description="Assessed severity level (set during triage).",
    )
    status: SubmissionStatus = Field(
        default=SubmissionStatus.SUBMITTED,
        description="Current workflow status.",
    )
    researcher_email: EmailStr = Field(
        ...,
        description="Contact email for the security researcher.",
    )
    researcher_id: Optional[str] = Field(
        default=None,
        description="Optional link to Researcher record.",
    )
    cvss_score: Optional[float] = Field(
        default=None,
        ge=0.0,
        le=10.0,
        description="CVSS 3.1 base score (0.0-10.0).",
    )
    cvss_vector: Optional[str] = Field(
        default=None,
        max_length=200,
        description="CVSS 3.1 vector string.",
    )
    bounty_amount: int = Field(
        default=0,
        ge=0,
        description="Awarded bounty amount in cents.",
    )
    bounty_currency: str = Field(
        default="USD",
        max_length=3,
        description="Currency code for bounty.",
    )
    duplicate_of: Optional[str] = Field(
        default=None,
        max_length=20,
        description="If duplicate, the original submission ID.",
    )
    rejection_reason: Optional[str] = Field(
        default=None,
        max_length=2000,
        description="If invalid, the reason for rejection.",
    )
    fix_commit_sha: Optional[str] = Field(
        default=None,
        max_length=40,
        description="Git commit SHA for the fix.",
    )
    fix_deployed_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp when fix was deployed to production.",
    )
    disclosure_deadline: Optional[datetime] = Field(
        default=None,
        description="Deadline for public disclosure.",
    )
    disclosed_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp of public disclosure.",
    )
    advisory_url: Optional[str] = Field(
        default=None,
        max_length=500,
        description="URL to public security advisory.",
    )
    assessor_id: Optional[str] = Field(
        default=None,
        description="User ID of the security analyst who triaged.",
    )
    submitted_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        description="Timestamp of initial submission.",
    )
    acknowledged_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp of acknowledgment.",
    )
    triaged_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp when triage completed.",
    )
    confirmed_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp when confirmed as valid.",
    )
    fixed_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp when fix was verified.",
    )
    closed_at: Optional[datetime] = Field(
        default=None,
        description="Timestamp when submission was closed.",
    )
    metadata: Dict[str, Any] = Field(
        default_factory=dict,
        description="Arbitrary key-value metadata.",
    )
    notes: List[str] = Field(
        default_factory=list,
        description="Internal notes from security team.",
    )

    @field_validator("submission_id")
    @classmethod
    def validate_submission_id(cls, v: str) -> str:
        """Validate submission ID matches expected pattern."""
        if not _SUBMISSION_ID_PATTERN.match(v):
            raise ValueError(
                f"Invalid submission ID '{v}'. Expected format: VDP-YYYY-NNNN"
            )
        return v

    @field_validator("cvss_vector")
    @classmethod
    def validate_cvss_vector(cls, v: Optional[str]) -> Optional[str]:
        """Basic validation of CVSS vector format."""
        if v is None:
            return v
        if not v.startswith("CVSS:3."):
            raise ValueError("CVSS vector must start with 'CVSS:3.'")
        return v

    @model_validator(mode="after")
    def validate_status_transitions(self) -> "Submission":
        """Validate status-specific required fields."""
        if self.status == SubmissionStatus.DUPLICATE and not self.duplicate_of:
            raise ValueError(
                "duplicate_of is required when status is DUPLICATE"
            )
        if self.status == SubmissionStatus.INVALID and not self.rejection_reason:
            raise ValueError(
                "rejection_reason is required when status is INVALID"
            )
        return self


# ---------------------------------------------------------------------------
# Researcher Model
# ---------------------------------------------------------------------------


class Researcher(BaseModel):
    """Security researcher profile for the VDP.

    Tracks researcher information, reputation, and bounty earnings
    for the hall of fame and payment processing.

    Attributes:
        id: Internal UUID.
        name: Display name (can be anonymous).
        email: Contact email address.
        pgp_key: Optional PGP public key for encrypted communications.
        reputation_score: Calculated reputation score (0-1000).
        submissions_count: Total number of submissions.
        valid_submissions_count: Number of confirmed valid submissions.
        bounties_earned: Total bounties earned in cents.
        hall_of_fame: Whether to display in public hall of fame.
        identity_verified: Whether identity has been verified.
        identity_verification_method: How identity was verified.
        tax_form_on_file: Whether W-9/W-8BEN is on file.
        payment_method: Preferred payment method.
        payment_details: Encrypted payment details.
        country_code: ISO 3166-1 alpha-2 country code.
        registered_at: Registration timestamp.
        last_submission_at: Last submission timestamp.
        metadata: Arbitrary metadata.
    """

    model_config = ConfigDict(
        extra="forbid",
        str_strip_whitespace=True,
    )

    id: str = Field(
        default_factory=lambda: str(uuid.uuid4()),
        description="Internal UUID.",
    )
    name: str = Field(
        default="Anonymous",
        min_length=1,
        max_length=200,
        description="Display name for hall of fame.",
    )
    email: EmailStr = Field(
        ...,
        description="Contact email address.",
    )
    pgp_key: Optional[str] = Field(
        default=None,
        max_length=10000,
        description="PGP public key for encrypted communications.",
    )
    reputation_score: int = Field(
        default=0,
        ge=0,
        le=10000,
        description="Calculated reputation score (0-10000).",
    )
    submissions_count: int = Field(
        default=0,
        ge=0,
        description="Total number of submissions.",
    )
    valid_submissions_count: int = Field(
        default=0,
        ge=0,
        description="Number of confirmed valid submissions.",
    )
    bounties_earned: int = Field(
        default=0,
        ge=0,
        description="Total bounties earned in cents.",
    )
    hall_of_fame: bool = Field(
        default=True,
        description="Whether to display in public hall of fame.",
    )
    identity_verified: bool = Field(
        default=False,
        description="Whether identity has been verified.",
    )
    identity_verification_method: IdentityVerificationMethod = Field(
        default=IdentityVerificationMethod.NONE,
        description="How identity was verified.",
    )
    tax_form_on_file: bool = Field(
        default=False,
        description="Whether W-9/W-8BEN is on file.",
    )
    payment_method: Optional[str] = Field(
        default=None,
        max_length=50,
        description="Preferred payment method (paypal, wire, crypto).",
    )
    payment_details: Optional[str] = Field(
        default=None,
        max_length=1000,
        description="Encrypted payment details.",
    )
    country_code: Optional[str] = Field(
        default=None,
        min_length=2,
        max_length=2,
        description="ISO 3166-1 alpha-2 country code.",
    )
    registered_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        description="Registration timestamp.",
    )
    last_submission_at: Optional[datetime] = Field(
        default=None,
        description="Last submission timestamp.",
    )
    metadata: Dict[str, Any] = Field(
        default_factory=dict,
        description="Arbitrary metadata.",
    )

    @field_validator("country_code")
    @classmethod
    def validate_country_code(cls, v: Optional[str]) -> Optional[str]:
        """Validate country code is uppercase."""
        if v is None:
            return v
        return v.upper()

    @property
    def bounties_earned_usd(self) -> Decimal:
        """Return bounties earned in USD (from cents)."""
        return Decimal(self.bounties_earned) / Decimal(100)


# ---------------------------------------------------------------------------
# Payment Model
# ---------------------------------------------------------------------------


class BountyPayment(BaseModel):
    """Bounty payment record.

    Tracks the lifecycle of a bounty payment from creation through
    approval and processing to final payment.

    Attributes:
        id: Internal UUID.
        submission_id: Related submission ID.
        researcher_id: Researcher receiving payment.
        amount: Payment amount in cents.
        currency: Currency code (ISO 4217).
        status: Current payment status.
        payment_method: Payment method used.
        payment_reference: External payment reference ID.
        approved_by: User ID of approver.
        approved_at: Approval timestamp.
        paid_at: Payment completion timestamp.
        created_at: Record creation timestamp.
        notes: Internal notes.
        metadata: Arbitrary metadata.
    """

    model_config = ConfigDict(
        extra="forbid",
        str_strip_whitespace=True,
    )

    id: str = Field(
        default_factory=lambda: str(uuid.uuid4()),
        description="Internal UUID.",
    )
    submission_id: str = Field(
        ...,
        description="Related submission ID.",
    )
    researcher_id: str = Field(
        ...,
        description="Researcher receiving payment.",
    )
    amount: int = Field(
        ...,
        ge=0,
        description="Payment amount in cents.",
    )
    currency: str = Field(
        default="USD",
        max_length=3,
        description="Currency code (ISO 4217).",
    )
    status: PaymentStatus = Field(
        default=PaymentStatus.PENDING,
        description="Current payment status.",
    )
    payment_method: Optional[str] = Field(
        default=None,
        max_length=50,
        description="Payment method used.",
    )
    payment_reference: Optional[str] = Field(
        default=None,
        max_length=200,
        description="External payment reference ID.",
    )
    approved_by: Optional[str] = Field(
        default=None,
        description="User ID of approver.",
    )
    approved_at: Optional[datetime] = Field(
        default=None,
        description="Approval timestamp.",
    )
    paid_at: Optional[datetime] = Field(
        default=None,
        description="Payment completion timestamp.",
    )
    created_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        description="Record creation timestamp.",
    )
    notes: str = Field(
        default="",
        max_length=2000,
        description="Internal notes.",
    )
    metadata: Dict[str, Any] = Field(
        default_factory=dict,
        description="Arbitrary metadata.",
    )

    @field_validator("currency")
    @classmethod
    def validate_currency(cls, v: str) -> str:
        """Validate currency is a valid ISO 4217 code."""
        return v.upper()

    @property
    def amount_decimal(self) -> Decimal:
        """Return amount as decimal (from cents)."""
        return Decimal(self.amount) / Decimal(100)


# ---------------------------------------------------------------------------
# Disclosure Advisory Model
# ---------------------------------------------------------------------------


class DisclosureAdvisory(BaseModel):
    """Public security advisory for vulnerability disclosure.

    Generated when a vulnerability is publicly disclosed. Contains
    all information for the public advisory.

    Attributes:
        id: Internal UUID.
        submission_id: Related submission ID.
        advisory_id: Public advisory ID (e.g., GLSA-2026-001).
        title: Advisory title.
        summary: Brief summary of the vulnerability.
        severity: Severity level.
        cvss_score: CVSS 3.1 base score.
        cvss_vector: CVSS 3.1 vector string.
        affected_versions: List of affected versions.
        fixed_versions: List of versions with the fix.
        description: Full description for public disclosure.
        impact: Impact description.
        remediation: Remediation steps.
        workaround: Optional temporary workaround.
        credits: Researcher credits (if opted in).
        references: External references.
        cve_id: Optional assigned CVE ID.
        published_at: Publication timestamp.
        updated_at: Last update timestamp.
    """

    model_config = ConfigDict(
        extra="forbid",
        str_strip_whitespace=True,
    )

    id: str = Field(
        default_factory=lambda: str(uuid.uuid4()),
        description="Internal UUID.",
    )
    submission_id: str = Field(
        ...,
        description="Related submission ID.",
    )
    advisory_id: str = Field(
        ...,
        min_length=5,
        max_length=50,
        description="Public advisory ID (e.g., GLSA-2026-001).",
    )
    title: str = Field(
        ...,
        min_length=5,
        max_length=200,
        description="Advisory title.",
    )
    summary: str = Field(
        ...,
        min_length=10,
        max_length=1000,
        description="Brief summary of the vulnerability.",
    )
    severity: Severity = Field(
        ...,
        description="Severity level.",
    )
    cvss_score: float = Field(
        ...,
        ge=0.0,
        le=10.0,
        description="CVSS 3.1 base score.",
    )
    cvss_vector: str = Field(
        ...,
        max_length=200,
        description="CVSS 3.1 vector string.",
    )
    affected_versions: List[str] = Field(
        default_factory=list,
        description="List of affected versions.",
    )
    fixed_versions: List[str] = Field(
        default_factory=list,
        description="List of versions with the fix.",
    )
    description: str = Field(
        ...,
        min_length=50,
        max_length=20000,
        description="Full description for public disclosure.",
    )
    impact: str = Field(
        ...,
        min_length=10,
        max_length=5000,
        description="Impact description.",
    )
    remediation: str = Field(
        ...,
        min_length=10,
        max_length=5000,
        description="Remediation steps.",
    )
    workaround: Optional[str] = Field(
        default=None,
        max_length=5000,
        description="Optional temporary workaround.",
    )
    credits: Optional[str] = Field(
        default=None,
        max_length=500,
        description="Researcher credits (if opted in).",
    )
    references: List[str] = Field(
        default_factory=list,
        description="External references.",
    )
    cve_id: Optional[str] = Field(
        default=None,
        max_length=20,
        description="Assigned CVE ID.",
    )
    published_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        description="Publication timestamp.",
    )
    updated_at: datetime = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        description="Last update timestamp.",
    )


# ---------------------------------------------------------------------------
# Exports
# ---------------------------------------------------------------------------

__all__ = [
    "BountyPayment",
    "DisclosureAdvisory",
    "IdentityVerificationMethod",
    "PaymentStatus",
    "Researcher",
    "Severity",
    "Submission",
    "SubmissionStatus",
    "VulnerabilityReport",
]
