# -*- coding: utf-8 -*-
"""
VDP Prometheus Metrics - SEC-010

Defines all Prometheus metrics for the GreenLang Vulnerability Disclosure
Program and provides helper functions for recording submission events,
triage events, and bounty payments.

Metrics are organized by subsystem:
    - Submission: Total submissions, acknowledgment time
    - Triage: Triage duration, severity distribution
    - Fix: Time to fix by severity
    - Bounty: Payments, amounts
    - Researcher: Active researcher count

All metrics use the ``gl_secops_vdp_`` prefix to namespace within
the GreenLang security operations metrics.

Example:
    >>> from greenlang.infrastructure.vulnerability_disclosure.metrics import (
    ...     record_submission, record_triage_completion, record_bounty_payment
    ... )
    >>> record_submission(severity="high", status="submitted")
    >>> record_triage_completion(severity="high", duration_seconds=3600)
    >>> record_bounty_payment(severity="high", amount_usd=2500)
"""

from __future__ import annotations

import logging
from typing import Optional

logger = logging.getLogger(__name__)

try:
    from prometheus_client import Counter, Gauge, Histogram

    PROMETHEUS_AVAILABLE = True
except ImportError:
    PROMETHEUS_AVAILABLE = False
    Counter = None  # type: ignore[misc, assignment]
    Gauge = None  # type: ignore[misc, assignment]
    Histogram = None  # type: ignore[misc, assignment]


# ---------------------------------------------------------------------------
# Metric Definitions
# ---------------------------------------------------------------------------

if PROMETHEUS_AVAILABLE:

    gl_secops_vdp_submissions_total = Counter(
        "gl_secops_vdp_submissions_total",
        "Total number of vulnerability submissions",
        labelnames=["severity", "status"],
    )
    """Counter: Total submissions by severity and status."""

    gl_secops_vdp_acknowledgment_time_seconds = Histogram(
        "gl_secops_vdp_acknowledgment_time_seconds",
        "Time from submission to acknowledgment in seconds",
        buckets=(60, 300, 900, 1800, 3600, 7200, 14400, 28800, 43200, 86400),
    )
    """Histogram: Acknowledgment time. Target: <24 hours (86400s)."""

    gl_secops_vdp_triage_time_seconds = Histogram(
        "gl_secops_vdp_triage_time_seconds",
        "Time from acknowledgment to triage completion in seconds",
        labelnames=["severity"],
        buckets=(
            3600,      # 1 hour
            7200,      # 2 hours
            14400,     # 4 hours
            28800,     # 8 hours
            43200,     # 12 hours
            86400,     # 1 day
            172800,    # 2 days
            259200,    # 3 days
            604800,    # 1 week
        ),
    )
    """Histogram: Triage duration by severity."""

    gl_secops_vdp_fix_time_days = Histogram(
        "gl_secops_vdp_fix_time_days",
        "Time from confirmation to fix deployment in days",
        labelnames=["severity"],
        buckets=(1, 3, 7, 14, 21, 30, 45, 60, 90),
    )
    """Histogram: Fix time by severity. Target based on disclosure deadline."""

    gl_secops_vdp_bounties_paid_total = Counter(
        "gl_secops_vdp_bounties_paid_total",
        "Total number of bounty payments made",
        labelnames=["severity"],
    )
    """Counter: Bounty payments by severity."""

    gl_secops_vdp_bounties_amount_total = Counter(
        "gl_secops_vdp_bounties_amount_total",
        "Total bounty amount paid in cents",
        labelnames=["severity", "currency"],
    )
    """Counter: Total bounty amounts by severity and currency."""

    gl_secops_vdp_researcher_count = Gauge(
        "gl_secops_vdp_researcher_count",
        "Number of registered security researchers",
        labelnames=["status"],
    )
    """Gauge: Researcher count by status (active, verified, etc.)."""

    gl_secops_vdp_pending_submissions = Gauge(
        "gl_secops_vdp_pending_submissions",
        "Number of submissions pending triage",
        labelnames=["severity"],
    )
    """Gauge: Pending submissions by severity."""

    gl_secops_vdp_disclosure_deadline_approaching = Gauge(
        "gl_secops_vdp_disclosure_deadline_approaching",
        "Number of submissions with disclosure deadline within 7 days",
        labelnames=["severity"],
    )
    """Gauge: Submissions with approaching deadlines."""

    gl_secops_vdp_duplicate_rate = Gauge(
        "gl_secops_vdp_duplicate_rate",
        "Percentage of submissions marked as duplicates",
    )
    """Gauge: Duplicate submission rate (0.0-1.0)."""

    gl_secops_vdp_invalid_rate = Gauge(
        "gl_secops_vdp_invalid_rate",
        "Percentage of submissions marked as invalid",
    )
    """Gauge: Invalid submission rate (0.0-1.0)."""

else:
    # Provide no-op stubs when prometheus_client is not installed
    logger.info(
        "prometheus_client not available; VDP metrics will be no-ops"
    )

    class _NoOpMetric:
        """No-op metric stub when prometheus_client is not installed."""

        def labels(self, *args, **kwargs):  # noqa: ANN
            """Return self for chaining."""
            return self

        def inc(self, amount=1):  # noqa: ANN
            """No-op increment."""

        def dec(self, amount=1):  # noqa: ANN
            """No-op decrement."""

        def set(self, value):  # noqa: ANN
            """No-op set."""

        def observe(self, amount):  # noqa: ANN
            """No-op observe."""

    gl_secops_vdp_submissions_total = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_acknowledgment_time_seconds = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_triage_time_seconds = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_fix_time_days = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_bounties_paid_total = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_bounties_amount_total = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_researcher_count = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_pending_submissions = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_disclosure_deadline_approaching = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_duplicate_rate = _NoOpMetric()  # type: ignore[assignment]
    gl_secops_vdp_invalid_rate = _NoOpMetric()  # type: ignore[assignment]


# ---------------------------------------------------------------------------
# Helper Functions
# ---------------------------------------------------------------------------


def record_submission(
    severity: str = "unknown",
    status: str = "submitted",
) -> None:
    """Record a vulnerability submission event.

    Args:
        severity: Submission severity (critical, high, medium, low, informational).
        status: Submission status.
    """
    try:
        gl_secops_vdp_submissions_total.labels(
            severity=severity,
            status=status,
        ).inc()
    except Exception as exc:
        logger.debug("Failed to record submission metric: %s", exc)


def record_acknowledgment_time(
    seconds: float,
) -> None:
    """Record the time from submission to acknowledgment.

    Args:
        seconds: Time in seconds.
    """
    try:
        gl_secops_vdp_acknowledgment_time_seconds.observe(seconds)
    except Exception as exc:
        logger.debug("Failed to record acknowledgment time metric: %s", exc)


def record_triage_completion(
    severity: str,
    duration_seconds: float,
) -> None:
    """Record triage completion time.

    Args:
        severity: Vulnerability severity.
        duration_seconds: Time from acknowledgment to triage completion.
    """
    try:
        gl_secops_vdp_triage_time_seconds.labels(
            severity=severity,
        ).observe(duration_seconds)
    except Exception as exc:
        logger.debug("Failed to record triage time metric: %s", exc)


def record_fix_time(
    severity: str,
    days: float,
) -> None:
    """Record time to fix a vulnerability.

    Args:
        severity: Vulnerability severity.
        days: Time from confirmation to fix deployment in days.
    """
    try:
        gl_secops_vdp_fix_time_days.labels(
            severity=severity,
        ).observe(days)
    except Exception as exc:
        logger.debug("Failed to record fix time metric: %s", exc)


def record_bounty_payment(
    severity: str,
    amount_cents: int,
    currency: str = "USD",
) -> None:
    """Record a bounty payment.

    Args:
        severity: Vulnerability severity.
        amount_cents: Payment amount in cents.
        currency: Payment currency.
    """
    try:
        gl_secops_vdp_bounties_paid_total.labels(
            severity=severity,
        ).inc()

        gl_secops_vdp_bounties_amount_total.labels(
            severity=severity,
            currency=currency,
        ).inc(amount_cents)
    except Exception as exc:
        logger.debug("Failed to record bounty payment metric: %s", exc)


def update_researcher_count(
    total: int,
    verified: int = 0,
    active: int = 0,
) -> None:
    """Update researcher count gauges.

    Args:
        total: Total registered researchers.
        verified: Number of verified researchers.
        active: Number of active researchers (submitted in last 90 days).
    """
    try:
        gl_secops_vdp_researcher_count.labels(status="total").set(total)
        gl_secops_vdp_researcher_count.labels(status="verified").set(verified)
        gl_secops_vdp_researcher_count.labels(status="active").set(active)
    except Exception as exc:
        logger.debug("Failed to update researcher count metric: %s", exc)


def update_pending_count(
    severity: str,
    count: int,
) -> None:
    """Update pending submissions gauge.

    Args:
        severity: Severity level.
        count: Number of pending submissions.
    """
    try:
        gl_secops_vdp_pending_submissions.labels(severity=severity).set(count)
    except Exception as exc:
        logger.debug("Failed to update pending count metric: %s", exc)


def update_deadline_approaching_count(
    severity: str,
    count: int,
) -> None:
    """Update disclosure deadline approaching gauge.

    Args:
        severity: Severity level.
        count: Number of submissions with approaching deadlines.
    """
    try:
        gl_secops_vdp_disclosure_deadline_approaching.labels(
            severity=severity,
        ).set(count)
    except Exception as exc:
        logger.debug("Failed to update deadline approaching metric: %s", exc)


def update_duplicate_rate(rate: float) -> None:
    """Update duplicate submission rate gauge.

    Args:
        rate: Duplicate rate (0.0-1.0).
    """
    try:
        gl_secops_vdp_duplicate_rate.set(rate)
    except Exception as exc:
        logger.debug("Failed to update duplicate rate metric: %s", exc)


def update_invalid_rate(rate: float) -> None:
    """Update invalid submission rate gauge.

    Args:
        rate: Invalid rate (0.0-1.0).
    """
    try:
        gl_secops_vdp_invalid_rate.set(rate)
    except Exception as exc:
        logger.debug("Failed to update invalid rate metric: %s", exc)


# ---------------------------------------------------------------------------
# Exports
# ---------------------------------------------------------------------------

__all__ = [
    # Metrics
    "gl_secops_vdp_acknowledgment_time_seconds",
    "gl_secops_vdp_bounties_amount_total",
    "gl_secops_vdp_bounties_paid_total",
    "gl_secops_vdp_disclosure_deadline_approaching",
    "gl_secops_vdp_duplicate_rate",
    "gl_secops_vdp_fix_time_days",
    "gl_secops_vdp_invalid_rate",
    "gl_secops_vdp_pending_submissions",
    "gl_secops_vdp_researcher_count",
    "gl_secops_vdp_submissions_total",
    "gl_secops_vdp_triage_time_seconds",
    # Helper functions
    "record_acknowledgment_time",
    "record_bounty_payment",
    "record_fix_time",
    "record_submission",
    "record_triage_completion",
    "update_deadline_approaching_count",
    "update_duplicate_rate",
    "update_invalid_rate",
    "update_pending_count",
    "update_researcher_count",
]
