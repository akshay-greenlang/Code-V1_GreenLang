# -*- coding: utf-8 -*-
"""
Vulnerability Disclosure Program Configuration - SEC-010

Configuration management for the GreenLang VDP system using Pydantic Settings.
Loads configuration from environment variables with the GL_VDP_ prefix, with
sensible defaults for each deployment environment.

Classes:
    - VDPConfig: Main configuration model with disclosure timelines, bounty tiers,
      acknowledgment deadlines, and notification settings.
    - BountyTier: Individual bounty tier configuration.
    - NotificationConfig: Slack and email notification settings.

Functions:
    - get_config: Factory function that loads config from environment variables.

Example:
    >>> from greenlang.infrastructure.vulnerability_disclosure.config import get_config
    >>> config = get_config()
    >>> config.disclosure_timeline_days["critical"]
    7
    >>> config.bounty_tiers["critical"]
    5000
"""

from __future__ import annotations

import logging
import os
from dataclasses import dataclass, field
from enum import Enum
from typing import Dict, List, Optional

from pydantic import Field, field_validator, model_validator
from pydantic_settings import BaseSettings

logger = logging.getLogger(__name__)


# ---------------------------------------------------------------------------
# Severity Levels
# ---------------------------------------------------------------------------


class Severity(str, Enum):
    """Vulnerability severity levels aligned with CVSS 3.1 qualitative scale."""

    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFORMATIONAL = "informational"


# ---------------------------------------------------------------------------
# Default Values
# ---------------------------------------------------------------------------

DEFAULT_DISCLOSURE_TIMELINES: Dict[str, int] = {
    "critical": 7,
    "high": 30,
    "medium": 60,
    "low": 90,
    "informational": 90,
}
"""Days allowed for remediation before public disclosure by severity."""

DEFAULT_BOUNTY_TIERS: Dict[str, int] = {
    "critical": 5000,
    "high": 2500,
    "medium": 1000,
    "low": 250,
    "informational": 0,
}
"""Base bounty amounts in USD by severity."""

DEFAULT_ACKNOWLEDGMENT_DEADLINE_HOURS: int = 24
"""Maximum hours before auto-acknowledgment must be sent."""


# ---------------------------------------------------------------------------
# Notification Configuration
# ---------------------------------------------------------------------------


@dataclass
class NotificationConfig:
    """Notification channel configuration.

    Attributes:
        slack_enabled: Whether Slack notifications are enabled.
        slack_webhook_url: Slack incoming webhook URL for security channel.
        slack_channel: Target Slack channel name.
        email_enabled: Whether email notifications are enabled.
        email_recipients: List of email addresses for security team.
        email_from: Sender email address for notifications.
        pagerduty_enabled: Whether PagerDuty is enabled for critical issues.
        pagerduty_routing_key: PagerDuty Events API routing key.
    """

    slack_enabled: bool = True
    slack_webhook_url: str = ""
    slack_channel: str = "#security-alerts"
    email_enabled: bool = True
    email_recipients: List[str] = field(default_factory=lambda: ["security@greenlang.io"])
    email_from: str = "vdp@greenlang.io"
    pagerduty_enabled: bool = False
    pagerduty_routing_key: str = ""


# ---------------------------------------------------------------------------
# Hall of Fame Configuration
# ---------------------------------------------------------------------------


@dataclass
class HallOfFameConfig:
    """Hall of Fame display configuration.

    Attributes:
        enabled: Whether the public hall of fame is enabled.
        max_display_count: Maximum researchers to display.
        include_bounty_totals: Whether to show total bounties earned.
        refresh_interval_hours: How often to refresh the leaderboard.
        minimum_valid_submissions: Minimum valid submissions to appear.
    """

    enabled: bool = True
    max_display_count: int = 50
    include_bounty_totals: bool = True
    refresh_interval_hours: int = 1
    minimum_valid_submissions: int = 1


# ---------------------------------------------------------------------------
# Main Configuration
# ---------------------------------------------------------------------------


class VDPConfig(BaseSettings):
    """Configuration for the GreenLang Vulnerability Disclosure Program.

    All fields can be set via environment variables with the GL_VDP_ prefix.
    For example, ``GL_VDP_AUTO_ACKNOWLEDGE_HOURS`` sets ``auto_acknowledge_hours``.

    Attributes:
        environment: Deployment environment (dev, staging, prod).
        auto_acknowledge_hours: Hours before auto-acknowledgment is sent.
        disclosure_timeline_critical_days: Days for critical severity disclosure.
        disclosure_timeline_high_days: Days for high severity disclosure.
        disclosure_timeline_medium_days: Days for medium severity disclosure.
        disclosure_timeline_low_days: Days for low severity disclosure.
        bounty_critical: Bounty amount for critical severity.
        bounty_high: Bounty amount for high severity.
        bounty_medium: Bounty amount for medium severity.
        bounty_low: Bounty amount for low severity.
        bounty_currency: Currency for bounty payments.
        quality_bonus_max_percent: Maximum quality bonus percentage.
        impact_bonus_max_percent: Maximum impact bonus percentage.
        duplicate_threshold: Similarity threshold for duplicate detection (0.0-1.0).
        require_pgp_for_high_severity: Require PGP encryption for high+ severity.
        max_deadline_extension_days: Maximum days a deadline can be extended.
        enable_public_hall_of_fame: Whether public hall of fame is enabled.
        slack_enabled: Whether Slack notifications are enabled.
        slack_webhook_url: Slack webhook URL for security channel.
        email_enabled: Whether email notifications are enabled.
        email_recipients: Comma-separated list of security team emails.
        postgres_url: PostgreSQL connection URL.
        redis_url: Redis connection URL for caching.
    """

    model_config = {
        "env_prefix": "GL_VDP_",
        "env_file": ".env",
        "env_file_encoding": "utf-8",
        "extra": "ignore",
        "validate_default": True,
    }

    # -- Environment --------------------------------------------------------

    environment: str = Field(
        default="dev",
        description="Deployment environment. Loaded from GL_ENVIRONMENT.",
    )

    # -- Acknowledgment -----------------------------------------------------

    auto_acknowledge_hours: int = Field(
        default=24,
        ge=1,
        le=72,
        description="Maximum hours before auto-acknowledgment must be sent.",
    )

    # -- Disclosure Timelines -----------------------------------------------

    disclosure_timeline_critical_days: int = Field(
        default=7,
        ge=1,
        le=90,
        description="Days before disclosure for critical severity.",
    )
    disclosure_timeline_high_days: int = Field(
        default=30,
        ge=1,
        le=180,
        description="Days before disclosure for high severity.",
    )
    disclosure_timeline_medium_days: int = Field(
        default=60,
        ge=1,
        le=365,
        description="Days before disclosure for medium severity.",
    )
    disclosure_timeline_low_days: int = Field(
        default=90,
        ge=1,
        le=365,
        description="Days before disclosure for low severity.",
    )

    # -- Bounty Tiers -------------------------------------------------------

    bounty_critical: int = Field(
        default=5000,
        ge=0,
        le=100000,
        description="Bounty amount for critical severity (USD).",
    )
    bounty_high: int = Field(
        default=2500,
        ge=0,
        le=50000,
        description="Bounty amount for high severity (USD).",
    )
    bounty_medium: int = Field(
        default=1000,
        ge=0,
        le=25000,
        description="Bounty amount for medium severity (USD).",
    )
    bounty_low: int = Field(
        default=250,
        ge=0,
        le=10000,
        description="Bounty amount for low severity (USD).",
    )
    bounty_currency: str = Field(
        default="USD",
        max_length=3,
        description="Currency for bounty payments (ISO 4217).",
    )

    # -- Bonus Configuration ------------------------------------------------

    quality_bonus_max_percent: int = Field(
        default=50,
        ge=0,
        le=100,
        description="Maximum quality bonus as percentage of base bounty.",
    )
    impact_bonus_max_percent: int = Field(
        default=100,
        ge=0,
        le=200,
        description="Maximum impact bonus as percentage of base bounty.",
    )

    # -- Duplicate Detection ------------------------------------------------

    duplicate_threshold: float = Field(
        default=0.85,
        ge=0.0,
        le=1.0,
        description="Similarity threshold for duplicate detection (0.0-1.0).",
    )

    # -- Security Settings --------------------------------------------------

    require_pgp_for_high_severity: bool = Field(
        default=True,
        description="Require PGP encryption for high+ severity communications.",
    )
    max_deadline_extension_days: int = Field(
        default=30,
        ge=0,
        le=90,
        description="Maximum days a disclosure deadline can be extended.",
    )

    # -- Hall of Fame -------------------------------------------------------

    enable_public_hall_of_fame: bool = Field(
        default=True,
        description="Whether the public hall of fame is enabled.",
    )
    hall_of_fame_max_display: int = Field(
        default=50,
        ge=1,
        le=200,
        description="Maximum researchers to display in hall of fame.",
    )

    # -- Notifications ------------------------------------------------------

    slack_enabled: bool = Field(
        default=True,
        description="Whether Slack notifications are enabled.",
    )
    slack_webhook_url: str = Field(
        default="",
        description="Slack incoming webhook URL for security channel.",
    )
    slack_channel: str = Field(
        default="#security-alerts",
        description="Slack channel for VDP notifications.",
    )
    email_enabled: bool = Field(
        default=True,
        description="Whether email notifications are enabled.",
    )
    email_recipients: str = Field(
        default="security@greenlang.io",
        description="Comma-separated list of security team email addresses.",
    )
    email_from: str = Field(
        default="vdp@greenlang.io",
        description="Sender email address for notifications.",
    )

    # -- Connection URLs ----------------------------------------------------

    postgres_url: str = Field(
        default="postgresql+asyncpg://localhost:5432/greenlang",
        description="PostgreSQL connection URL.",
    )
    redis_url: str = Field(
        default="redis://localhost:6379/3",
        description="Redis connection URL for VDP caching.",
    )

    # -- Validators ---------------------------------------------------------

    @field_validator("environment", mode="before")
    @classmethod
    def resolve_environment(cls, v: Optional[str]) -> str:
        """Resolve environment from GL_ENVIRONMENT if not set."""
        gl_env = os.environ.get("GL_ENVIRONMENT", "").strip().lower()
        if gl_env:
            return gl_env
        if v is not None and str(v).strip():
            return str(v).strip().lower()
        return "dev"

    @field_validator("environment")
    @classmethod
    def validate_environment_name(cls, v: str) -> str:
        """Validate environment is one of the known deployment targets."""
        allowed = {"dev", "development", "staging", "prod", "production", "test"}
        v_lower = v.strip().lower()
        if v_lower not in allowed:
            raise ValueError(f"Invalid environment '{v}'. Allowed: {sorted(allowed)}")
        if v_lower == "development":
            return "dev"
        if v_lower == "production":
            return "prod"
        return v_lower

    @field_validator("bounty_currency")
    @classmethod
    def validate_currency(cls, v: str) -> str:
        """Validate currency is a valid ISO 4217 code."""
        v_upper = v.strip().upper()
        valid_currencies = {"USD", "EUR", "GBP", "CAD", "AUD", "CHF", "JPY"}
        if v_upper not in valid_currencies:
            raise ValueError(
                f"Invalid currency '{v}'. Supported: {sorted(valid_currencies)}"
            )
        return v_upper

    # -- Helper Properties --------------------------------------------------

    @property
    def disclosure_timeline_days(self) -> Dict[str, int]:
        """Return disclosure timelines as a dict keyed by severity."""
        return {
            "critical": self.disclosure_timeline_critical_days,
            "high": self.disclosure_timeline_high_days,
            "medium": self.disclosure_timeline_medium_days,
            "low": self.disclosure_timeline_low_days,
            "informational": self.disclosure_timeline_low_days,
        }

    @property
    def bounty_tiers(self) -> Dict[str, int]:
        """Return bounty tiers as a dict keyed by severity."""
        return {
            "critical": self.bounty_critical,
            "high": self.bounty_high,
            "medium": self.bounty_medium,
            "low": self.bounty_low,
            "informational": 0,
        }

    @property
    def email_recipients_list(self) -> List[str]:
        """Return email recipients as a list."""
        return [
            email.strip()
            for email in self.email_recipients.split(",")
            if email.strip()
        ]

    def get_notification_config(self) -> NotificationConfig:
        """Build a NotificationConfig from settings."""
        return NotificationConfig(
            slack_enabled=self.slack_enabled,
            slack_webhook_url=self.slack_webhook_url,
            slack_channel=self.slack_channel,
            email_enabled=self.email_enabled,
            email_recipients=self.email_recipients_list,
            email_from=self.email_from,
        )

    def get_hall_of_fame_config(self) -> HallOfFameConfig:
        """Build a HallOfFameConfig from settings."""
        return HallOfFameConfig(
            enabled=self.enable_public_hall_of_fame,
            max_display_count=self.hall_of_fame_max_display,
        )


# ---------------------------------------------------------------------------
# Factory Function
# ---------------------------------------------------------------------------

_config_instance: Optional[VDPConfig] = None


def get_config(force_reload: bool = False) -> VDPConfig:
    """Load VDP configuration from environment variables.

    Creates a singleton VDPConfig instance on first call, reading from
    environment variables with the GL_VDP_ prefix. Subsequent calls return
    the cached instance unless force_reload is True.

    Args:
        force_reload: If True, discard the cached config and reload.

    Returns:
        The VDPConfig singleton.

    Example:
        >>> config = get_config()
        >>> config.bounty_tiers["critical"]
        5000
    """
    global _config_instance

    if _config_instance is not None and not force_reload:
        return _config_instance

    _config_instance = VDPConfig()

    logger.info(
        "VDP config loaded: environment=%s, auto_ack=%dh, "
        "critical_timeline=%dd, critical_bounty=$%d",
        _config_instance.environment,
        _config_instance.auto_acknowledge_hours,
        _config_instance.disclosure_timeline_critical_days,
        _config_instance.bounty_critical,
    )

    return _config_instance


def reset_config() -> None:
    """Reset the cached configuration. Used for testing."""
    global _config_instance
    _config_instance = None
    logger.debug("VDP config singleton reset.")


__all__ = [
    "DEFAULT_ACKNOWLEDGMENT_DEADLINE_HOURS",
    "DEFAULT_BOUNTY_TIERS",
    "DEFAULT_DISCLOSURE_TIMELINES",
    "HallOfFameConfig",
    "NotificationConfig",
    "Severity",
    "VDPConfig",
    "get_config",
    "reset_config",
]
