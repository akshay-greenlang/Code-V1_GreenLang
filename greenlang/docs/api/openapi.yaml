openapi: 3.0.3
info:
  title: GreenLang Emission Factor API
  description: |
    Production-grade REST API for emission factor queries and GHG calculations.

    ## Features

    - **327+ Emission Factors**: Comprehensive coverage for US, EU, UK, and global sources
    - **Multi-Gas Breakdown**: CO2, CH4, N2O with full GWP calculations
    - **Full Provenance**: Complete source tracking and data quality metrics
    - **Scope 1/2/3 Calculations**: GHG Protocol-aligned emission calculations
    - **Batch Processing**: Process up to 100 calculations per request
    - **Historical Queries**: Time-based factor retrieval
    - **Rate Limiting**: 1000 req/min for queries, 500 req/min for calculations
    - **Response Caching**: Sub-50ms response times at 95th percentile

    ## Performance SLA

    - Response Time: <50ms (95th percentile)
    - Throughput: 1000 requests/second capacity
    - Availability: 99.9% uptime guarantee
    - Horizontal Scaling: Kubernetes-ready with auto-scaling support

    ## Authentication

    API requests require Bearer token authentication (JWT or API key).
    Include the token in the `Authorization` header:

    ```
    Authorization: Bearer <your-token>
    ```

    ## Rate Limits

    | Endpoint Type | Rate Limit |
    |--------------|-----------|
    | Factor Queries | 1000/minute |
    | Calculations | 500/minute |
    | Batch Calculations | 100/minute |
    | Search | 500/minute |
    | Health/Stats | 1000/minute |

    ## Versioning

    This API uses URL path versioning. The current version is `v1`.
    All endpoints are prefixed with `/api/v1/`.

  version: 1.0.0
  contact:
    name: GreenLang Support
    email: support@greenlang.io
    url: https://greenlang.io
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  termsOfService: https://greenlang.io/terms

servers:
  - url: https://api.greenlang.io
    description: Production server
  - url: https://api-staging.greenlang.io
    description: Staging server
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Factors
    description: Emission factor queries and retrieval
  - name: Calculations
    description: GHG emission calculations
  - name: System
    description: Health checks and system statistics

security:
  - BearerAuth: []

paths:
  /:
    get:
      summary: API root
      description: Welcome message with API information and links
      operationId: getRootInfo
      tags:
        - System
      security: []
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: GreenLang Emission Factor API
                  version:
                    type: string
                    example: 1.0.0
                  description:
                    type: string
                    example: Production REST API for emission factor queries and calculations
                  docs:
                    type: string
                    example: /api/docs
                  redoc:
                    type: string
                    example: /api/redoc
                  health:
                    type: string
                    example: /api/v1/health
                  status:
                    type: string
                    example: operational

  /api/v1/health:
    get:
      summary: Health check
      description: |
        Health check endpoint for load balancers and monitoring systems.

        Returns 200 if the API is healthy and ready to serve requests.
        Checks database and cache availability.

        This endpoint does NOT require authentication.
      operationId: getHealth
      tags:
        - System
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                version: 1.0.0
                timestamp: '2025-11-21T10:30:00Z'
                database: connected
                cache: available
                uptime_seconds: 86400.0
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/stats:
    get:
      summary: Get API statistics
      description: Retrieve usage statistics and performance metrics
      operationId: getStats
      tags:
        - System
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'

  /api/v1/stats/coverage:
    get:
      summary: Get coverage statistics
      description: |
        Retrieve data coverage statistics including:
        - Number of geographies covered
        - Fuel types available
        - Scope distribution
        - Boundary type coverage
      operationId: getCoverageStats
      tags:
        - System
      responses:
        '200':
          description: Coverage statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoverageStats'

  /api/v1/factors:
    get:
      summary: List emission factors
      description: |
        Retrieve paginated list of emission factors with optional filters.

        Supports filtering by:
        - Fuel type (diesel, gasoline, electricity, etc.)
        - Geography (US, EU, UK, etc.)
        - Scope (1, 2, or 3)
        - Boundary (combustion, WTT, WTW, etc.)

        Results are paginated with configurable page size (max 500 items per page).
      operationId: listFactors
      tags:
        - Factors
      parameters:
        - name: fuel_type
          in: query
          description: Filter by fuel type
          schema:
            type: string
            example: diesel
        - name: geography
          in: query
          description: Filter by geography (ISO country code)
          schema:
            type: string
            example: US
        - name: scope
          in: query
          description: Filter by GHG scope
          schema:
            type: string
            enum: ['1', '2', '3']
            example: '1'
        - name: boundary
          in: query
          description: Filter by emission boundary
          schema:
            type: string
            enum: [combustion, WTT, WTW, cradle_to_gate, cradle_to_grave]
            example: combustion
        - name: page
          in: query
          description: Page number (1-indexed)
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Items per page (max 500)
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
      responses:
        '200':
          description: Factors retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorListResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/factors/{factor_id}:
    get:
      summary: Get emission factor by ID
      description: |
        Retrieve detailed information for a specific emission factor.

        Returns complete factor record including:
        - Emission vectors (CO2, CH4, N2O)
        - GWP calculations
        - Data quality metrics
        - Source provenance
        - Validity period
        - Compliance framework tags
      operationId: getFactorById
      tags:
        - Factors
      parameters:
        - name: factor_id
          in: path
          required: true
          description: Emission factor ID
          schema:
            type: string
            example: EF:US:diesel:2024:v1
      responses:
        '200':
          description: Factor retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmissionFactorResponse'
        '404':
          description: Factor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/factors/search:
    get:
      summary: Search emission factors
      description: |
        Full-text search across emission factors.

        Searches across:
        - Fuel type
        - Geography
        - Tags
        - Notes

        Returns ranked results with search execution time.
      operationId: searchFactors
      tags:
        - Factors
      parameters:
        - name: q
          in: query
          required: true
          description: Search query (minimum 2 characters)
          schema:
            type: string
            minLength: 2
            example: diesel
        - name: geography
          in: query
          description: Filter results by geography
          schema:
            type: string
            example: US
        - name: limit
          in: query
          description: Maximum results to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorSearchResponse'
        '400':
          description: Invalid search query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/factors/category/{fuel_type}:
    get:
      summary: Get factors by fuel type
      description: Retrieve all emission factors for a specific fuel type
      operationId: getFactorsByFuelType
      tags:
        - Factors
      parameters:
        - name: fuel_type
          in: path
          required: true
          description: Fuel type
          schema:
            type: string
            example: diesel
        - name: geography
          in: query
          description: Filter by geography
          schema:
            type: string
            example: US
      responses:
        '200':
          description: Factors retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorListResponse'

  /api/v1/factors/scope/{scope}:
    get:
      summary: Get factors by scope
      description: Retrieve all emission factors for a specific GHG scope
      operationId: getFactorsByScope
      tags:
        - Factors
      parameters:
        - name: scope
          in: path
          required: true
          description: GHG scope
          schema:
            type: string
            enum: ['1', '2', '3']
            example: '1'
      responses:
        '200':
          description: Factors retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorListResponse'

  /api/v1/calculate:
    post:
      summary: Calculate emissions
      description: |
        Calculate GHG emissions for a single activity.

        The API will:
        1. Select the appropriate emission factor
        2. Multiply by activity amount
        3. Return total CO2e and gas-by-gas breakdown

        Returns calculation ID for audit trail.
      operationId: calculateEmissions
      tags:
        - Calculations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculationRequest'
            example:
              fuel_type: diesel
              activity_amount: 100
              activity_unit: gallons
              geography: US
              scope: '1'
              boundary: combustion
      responses:
        '200':
          description: Calculation completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationResponse'
        '400':
          description: Invalid calculation request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: No matching emission factor found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/calculate/batch:
    post:
      summary: Batch calculate emissions
      description: |
        Calculate emissions for multiple activities in a single request.

        Maximum 100 calculations per batch.

        Useful for:
        - Processing monthly fuel consumption data
        - Calculating total facility emissions
        - Bulk data processing
      operationId: calculateBatch
      tags:
        - Calculations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchCalculationRequest'
      responses:
        '200':
          description: Batch calculation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchCalculationResponse'
        '400':
          description: Invalid batch request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/calculate/scope1:
    post:
      summary: Calculate Scope 1 emissions
      description: |
        Calculate direct GHG emissions (Scope 1).

        Scope 1 includes:
        - Stationary combustion (furnaces, boilers)
        - Mobile combustion (company vehicles)
        - Fugitive emissions (refrigerants, leaks)
        - Process emissions
      operationId: calculateScope1
      tags:
        - Calculations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Scope1Request'
            example:
              fuel_type: natural_gas
              consumption: 500
              unit: therms
              geography: US
      responses:
        '200':
          description: Scope 1 calculation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmissionResult'

  /api/v1/calculate/scope2:
    post:
      summary: Calculate Scope 2 emissions
      description: |
        Calculate purchased electricity emissions (Scope 2).

        Supports both:
        - Location-based method (grid average)
        - Market-based method (supplier-specific or RECs)
      operationId: calculateScope2
      tags:
        - Calculations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Scope2Request'
            example:
              electricity_kwh: 10000
              geography: US
      responses:
        '200':
          description: Scope 2 calculation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmissionResult'

  /api/v1/calculate/scope3:
    post:
      summary: Calculate Scope 3 emissions
      description: |
        Calculate indirect value chain emissions (Scope 3).

        **Note**: This endpoint is not yet implemented.
        Scope 3 requires category-specific calculation logic.
      operationId: calculateScope3
      tags:
        - Calculations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Scope3Request'
      responses:
        '501':
          description: Not yet implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token or API key authentication.

        Include the token in the Authorization header:
        ```
        Authorization: Bearer <your-token>
        ```

  schemas:
    CalculationRequest:
      type: object
      required:
        - fuel_type
        - activity_amount
        - activity_unit
      properties:
        factor_id:
          type: string
          description: Emission factor ID (if known)
          example: EF:US:diesel:2024:v1
        fuel_type:
          type: string
          description: 'Fuel type: diesel, gasoline, natural_gas, electricity, etc.'
          example: diesel
        activity_amount:
          type: number
          format: float
          minimum: 0
          exclusiveMinimum: true
          description: Activity amount (must be positive)
          example: 100.0
        activity_unit:
          type: string
          description: 'Activity unit: gallons, kWh, therms, liters, etc.'
          example: gallons
        geography:
          type: string
          default: US
          description: 'Geography: ISO country code (US, UK, EU, etc.)'
          example: US
        scope:
          type: string
          enum: ['1', '2', '3']
          default: '1'
          description: GHG scope (1, 2, or 3)
        boundary:
          type: string
          enum: [combustion, WTT, WTW, cradle_to_gate, cradle_to_grave]
          default: combustion
          description: Emission boundary
        gwp_set:
          type: string
          enum: [IPCC_AR6_100, IPCC_AR6_20, IPCC_AR5_100]
          default: IPCC_AR6_100
          description: GWP reference set
        calculation_date:
          type: string
          format: date
          description: Calculation date for historical queries

    Scope1Request:
      type: object
      required:
        - fuel_type
        - consumption
        - unit
      properties:
        fuel_type:
          type: string
          description: Fuel type
          example: natural_gas
        consumption:
          type: number
          format: float
          minimum: 0
          exclusiveMinimum: true
          description: Fuel consumption
          example: 500
        unit:
          type: string
          description: Consumption unit
          example: therms
        geography:
          type: string
          default: US
          description: Geography
          example: US

    Scope2Request:
      type: object
      required:
        - electricity_kwh
      properties:
        electricity_kwh:
          type: number
          format: float
          minimum: 0
          exclusiveMinimum: true
          description: Electricity consumption in kWh
          example: 10000
        geography:
          type: string
          default: US
          description: Grid geography
          example: US
        market_based_factor:
          type: number
          format: float
          description: Optional market-based factor (for renewable energy purchases)

    Scope3Request:
      type: object
      required:
        - category
        - activity_data
      properties:
        category:
          type: string
          description: 'Scope 3 category (business_travel, employee_commuting, etc.)'
          example: business_travel
        activity_data:
          type: object
          additionalProperties:
            type: number
          description: Activity data specific to category
          example:
            miles_driven: 1000
            vehicle_type: sedan
        geography:
          type: string
          default: US
          description: Geography

    BatchCalculationRequest:
      type: object
      required:
        - calculations
      properties:
        calculations:
          type: array
          minItems: 1
          maxItems: 100
          description: List of calculations (max 100)
          items:
            $ref: '#/components/schemas/CalculationRequest'

    CalculationResponse:
      type: object
      required:
        - calculation_id
        - emissions_kg_co2e
        - emissions_tonnes_co2e
        - emissions_by_gas
        - factor_used
        - timestamp
      properties:
        calculation_id:
          type: string
          description: Unique calculation ID
          example: calc_abc123xyz
        emissions_kg_co2e:
          type: number
          format: float
          description: Total CO2e emissions in kg
          example: 1021.0
        emissions_tonnes_co2e:
          type: number
          format: float
          description: Total CO2e emissions in tonnes
          example: 1.021
        emissions_by_gas:
          type: object
          description: Emissions by gas type
          properties:
            CO2:
              type: number
              format: float
            CH4:
              type: number
              format: float
            N2O:
              type: number
              format: float
          example:
            CO2: 1018.0
            CH4: 2.3
            N2O: 0.7
        factor_used:
          $ref: '#/components/schemas/EmissionFactorSummary'
        timestamp:
          type: string
          format: date-time
          description: Calculation timestamp

    BatchCalculationResponse:
      type: object
      required:
        - batch_id
        - total_emissions_kg_co2e
        - total_emissions_tonnes_co2e
        - calculations
        - count
        - timestamp
      properties:
        batch_id:
          type: string
          description: Unique batch ID
        total_emissions_kg_co2e:
          type: number
          format: float
          description: Total emissions across all calculations
        total_emissions_tonnes_co2e:
          type: number
          format: float
          description: Total emissions in tonnes
        calculations:
          type: array
          description: Individual calculation results
          items:
            $ref: '#/components/schemas/CalculationResponse'
        count:
          type: integer
          description: Number of calculations
        timestamp:
          type: string
          format: date-time

    EmissionResult:
      type: object
      required:
        - emissions_kg_co2e
        - emissions_tonnes_co2e
        - gas_breakdown
      properties:
        emissions_kg_co2e:
          type: number
          format: float
          description: Total CO2e emissions in kg
        emissions_tonnes_co2e:
          type: number
          format: float
          description: Total CO2e emissions in tonnes
        gas_breakdown:
          $ref: '#/components/schemas/GHGBreakdown'

    GHGBreakdown:
      type: object
      required:
        - CO2
        - CH4
        - N2O
      properties:
        CO2:
          type: number
          format: float
          description: CO2 emissions in kg
        CH4:
          type: number
          format: float
          description: CH4 emissions in kg
        N2O:
          type: number
          format: float
          description: N2O emissions in kg
        HFCs:
          type: number
          format: float
          description: HFC emissions in kg
        PFCs:
          type: number
          format: float
          description: PFC emissions in kg
        SF6:
          type: number
          format: float
          description: SF6 emissions in kg

    EmissionFactorSummary:
      type: object
      required:
        - factor_id
        - fuel_type
        - unit
        - geography
        - scope
        - boundary
        - co2e_per_unit
        - source
        - source_year
        - data_quality_score
        - uncertainty_percent
      properties:
        factor_id:
          type: string
          example: EF:US:diesel:2024:v1
        fuel_type:
          type: string
          example: diesel
        unit:
          type: string
          example: gallons
        geography:
          type: string
          example: US
        scope:
          type: string
          example: '1'
        boundary:
          type: string
          example: combustion
        co2e_per_unit:
          type: number
          format: float
          description: kg CO2e per unit
          example: 10.21
        source:
          type: string
          description: Source organization
          example: EPA
        source_year:
          type: integer
          example: 2024
        data_quality_score:
          type: number
          format: float
          minimum: 1
          maximum: 5
          description: Data quality score (1-5)
          example: 4.6
        uncertainty_percent:
          type: number
          format: float
          description: Uncertainty as percentage
          example: 5.0

    EmissionFactorResponse:
      type: object
      required:
        - factor_id
        - fuel_type
        - unit
        - geography
        - geography_level
        - scope
        - boundary
        - co2_per_unit
        - ch4_per_unit
        - n2o_per_unit
        - co2e_per_unit
        - gwp_set
        - ch4_gwp
        - n2o_gwp
        - data_quality
        - source
        - uncertainty_95ci
        - valid_from
        - license
        - compliance_frameworks
        - tags
      properties:
        factor_id:
          type: string
        fuel_type:
          type: string
        unit:
          type: string
        geography:
          type: string
        geography_level:
          type: string
        scope:
          type: string
        boundary:
          type: string
        co2_per_unit:
          type: number
          format: float
        ch4_per_unit:
          type: number
          format: float
        n2o_per_unit:
          type: number
          format: float
        co2e_per_unit:
          type: number
          format: float
        gwp_set:
          type: string
        ch4_gwp:
          type: number
          format: float
        n2o_gwp:
          type: number
          format: float
        data_quality:
          $ref: '#/components/schemas/DataQuality'
        source:
          $ref: '#/components/schemas/SourceInfo'
        uncertainty_95ci:
          type: number
          format: float
        valid_from:
          type: string
          format: date
        valid_to:
          type: string
          format: date
        license:
          type: string
        compliance_frameworks:
          type: array
          items:
            type: string
        tags:
          type: array
          items:
            type: string
        notes:
          type: string

    DataQuality:
      type: object
      required:
        - temporal
        - geographical
        - technological
        - representativeness
        - methodological
        - overall_score
        - rating
      properties:
        temporal:
          type: integer
          minimum: 1
          maximum: 5
        geographical:
          type: integer
          minimum: 1
          maximum: 5
        technological:
          type: integer
          minimum: 1
          maximum: 5
        representativeness:
          type: integer
          minimum: 1
          maximum: 5
        methodological:
          type: integer
          minimum: 1
          maximum: 5
        overall_score:
          type: number
          format: float
        rating:
          type: string

    SourceInfo:
      type: object
      required:
        - organization
        - publication
        - year
        - methodology
        - version
      properties:
        organization:
          type: string
        publication:
          type: string
        year:
          type: integer
        url:
          type: string
          format: uri
        methodology:
          type: string
        version:
          type: string

    FactorListResponse:
      type: object
      required:
        - factors
        - total_count
        - page
        - page_size
        - total_pages
      properties:
        factors:
          type: array
          items:
            $ref: '#/components/schemas/EmissionFactorSummary'
        total_count:
          type: integer
          description: Total number of factors matching query
        page:
          type: integer
          description: Current page number
        page_size:
          type: integer
          description: Items per page
        total_pages:
          type: integer
          description: Total number of pages

    FactorSearchResponse:
      type: object
      required:
        - query
        - factors
        - count
        - search_time_ms
      properties:
        query:
          type: string
          description: Search query
        factors:
          type: array
          items:
            $ref: '#/components/schemas/EmissionFactorSummary'
        count:
          type: integer
          description: Number of results
        search_time_ms:
          type: number
          format: float
          description: Search execution time in ms

    CoverageStats:
      type: object
      required:
        - total_factors
        - geographies
        - fuel_types
        - scopes
        - boundaries
        - by_geography
        - by_fuel_type
      properties:
        total_factors:
          type: integer
        geographies:
          type: integer
        fuel_types:
          type: integer
        scopes:
          type: object
          additionalProperties:
            type: integer
        boundaries:
          type: object
          additionalProperties:
            type: integer
        by_geography:
          type: object
          additionalProperties:
            type: integer
        by_fuel_type:
          type: object
          additionalProperties:
            type: integer

    CacheStats:
      type: object
      required:
        - enabled
        - hits
        - misses
        - hit_rate_pct
        - size
        - max_size
      properties:
        enabled:
          type: boolean
        hits:
          type: integer
        misses:
          type: integer
        hit_rate_pct:
          type: number
          format: float
        size:
          type: integer
        max_size:
          type: integer

    StatsResponse:
      type: object
      required:
        - version
        - total_factors
        - calculations_today
        - cache_stats
        - uptime_seconds
        - timestamp
      properties:
        version:
          type: string
        total_factors:
          type: integer
        calculations_today:
          type: integer
        cache_stats:
          $ref: '#/components/schemas/CacheStats'
        uptime_seconds:
          type: number
          format: float
        timestamp:
          type: string
          format: date-time

    HealthResponse:
      type: object
      required:
        - status
        - version
        - timestamp
        - database
        - cache
        - uptime_seconds
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Overall health status
        version:
          type: string
        timestamp:
          type: string
          format: date-time
        database:
          type: string
          description: Database status
        cache:
          type: string
          description: Cache status
        uptime_seconds:
          type: number
          format: float

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - timestamp
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Error message
        details:
          type: object
          description: Additional error details
        timestamp:
          type: string
          format: date-time
