---
# GL-016 WATERGUARD - Service Account & RBAC
# Project: GreenLang Industrial Sustainability Framework
# Agent: Water Treatment Quality Control

apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-016-waterguard
  namespace: greenlang
  labels:
    app: waterguard
    agent: gl-016
    component: water-treatment
    tier: agent
  annotations:
    description: "Service account for water treatment agent"
automountServiceAccountToken: true

---
# Role for accessing resources within the namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-016-waterguard-role
  namespace: greenlang
  labels:
    app: waterguard
    agent: gl-016
rules:
  # Allow reading ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Allow reading Secrets
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]

  # Allow reading Services for discovery
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch"]

  # Allow reading Endpoints for service discovery
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

  # Allow reading Pods for self-discovery
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Allow creating Events for logging
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # Allow lease management for leader election
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "create", "update", "delete"]

---
# RoleBinding to bind the role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-016-waterguard-rolebinding
  namespace: greenlang
  labels:
    app: waterguard
    agent: gl-016
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: gl-016-waterguard-role
subjects:
  - kind: ServiceAccount
    name: gl-016-waterguard
    namespace: greenlang

---
# ClusterRole for cluster-wide operations (if needed)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gl-016-waterguard-clusterrole
  labels:
    app: waterguard
    agent: gl-016
rules:
  # Allow reading nodes for topology awareness
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]

  # Allow reading namespaces for multi-namespace operations
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding (only if cluster-wide access is required)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gl-016-waterguard-clusterrolebinding
  labels:
    app: waterguard
    agent: gl-016
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: gl-016-waterguard-clusterrole
subjects:
  - kind: ServiceAccount
    name: gl-016-waterguard
    namespace: greenlang
