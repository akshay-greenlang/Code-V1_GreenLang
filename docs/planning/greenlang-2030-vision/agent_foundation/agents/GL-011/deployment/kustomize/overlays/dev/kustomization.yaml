# Kustomize Overlay - Development Environment
# Low replicas, verbose logging, relaxed resource limits

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base configuration
resources:
  - ../../base

# Namespace override
namespace: greenlang-dev

# Name prefix for resources
namePrefix: dev-

# Common labels for dev environment
commonLabels:
  environment: development
  tier: dev

# Common annotations
commonAnnotations:
  environment: "development"
  cost-center: "engineering-dev"

# ConfigMap overrides
configMapGenerator:
  - name: gl-011-config
    behavior: merge
    literals:
      - environment=development
      - log_level=DEBUG
      - logging_format=json
      - optimization_timeout=600
      - feature_market_integration=true
      - feature_carbon_trading=true
      - database_echo=true
      - metrics_enabled=true
      - enable_emissions_tracking=true
      - enable_cost_optimization=true

# Image tag override
images:
  - name: gcr.io/greenlang/gl-011-fuelcraft
    newTag: dev-latest

# Replica count override (lower for dev)
replicas:
  - name: gl-011-fuelcraft
    count: 1

# Patches for development-specific changes
patches:
  # Patch deployment for dev environment
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: gl-011-fuelcraft
        annotations:
          deployment-type: "development"
          auto-deploy: "true"
      spec:
        template:
          spec:
            containers:
            - name: gl-011-fuelcraft
              resources:
                requests:
                  cpu: "250m"
                  memory: "512Mi"
                limits:
                  cpu: "1000m"
                  memory: "2Gi"
              env:
              - name: GREENLANG_ENV
                value: "development"
              - name: DEBUG
                value: "true"
              - name: ENABLE_PROFILING
                value: "true"

  # Patch HPA for lower thresholds
  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: gl-011-fuelcraft-hpa
      spec:
        minReplicas: 1
        maxReplicas: 3
        metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 80

  # Patch Ingress for dev domain
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: gl-011-fuelcraft-ingress
        annotations:
          cert-manager.io/cluster-issuer: "selfsigned-issuer"
          nginx.ingress.kubernetes.io/limit-rps: "200"
      spec:
        tls:
        - hosts:
          - gl-011-dev.greenlang.local
          secretName: gl-011-tls-dev
        rules:
        - host: gl-011-dev.greenlang.local
          http:
            paths:
            - path: /api/v1
              pathType: Prefix
              backend:
                service:
                  name: gl-011-fuelcraft
                  port:
                    number: 8080

  # Patch PDB for dev (allow all disruptions)
  - patch: |-
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: gl-011-fuelcraft-pdb
      spec:
        minAvailable: 0

  # Patch ResourceQuota for dev (lower limits)
  - patch: |-
      apiVersion: v1
      kind: ResourceQuota
      metadata:
        name: gl-011-fuelcraft-quota
      spec:
        hard:
          requests.cpu: "4"
          limits.cpu: "8"
          requests.memory: "8Gi"
          limits.memory: "16Gi"
          pods: "5"
