# GL-011 FUELCRAFT - ServiceMonitor for Prometheus
# Enables Prometheus Operator to scrape metrics automatically

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: gl-011-fuelcraft
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"
    release: prometheus
    prometheus: kube-prometheus
spec:
  # Select the service to monitor
  selector:
    matchLabels:
      app: gl-011-fuelcraft
      agent: "GL-011"

  # Namespace to discover services in
  namespaceSelector:
    matchNames:
      - greenlang

  # Endpoints to scrape
  endpoints:
    - port: metrics  # Must match service port name
      path: /api/v1/metrics
      interval: 30s
      scrapeTimeout: 10s
      scheme: http

      # Relabeling configuration
      relabelings:
        # Add namespace label
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
          action: replace

        # Add pod name label
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
          action: replace

        # Add service name label
        - sourceLabels: [__meta_kubernetes_service_name]
          targetLabel: service
          action: replace

        # Add container name label
        - sourceLabels: [__meta_kubernetes_pod_container_name]
          targetLabel: container
          action: replace

        # Add node name label
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
          action: replace

        # Add pod IP
        - sourceLabels: [__meta_kubernetes_pod_ip]
          targetLabel: pod_ip
          action: replace

        # Add agent identifier
        - sourceLabels: []
          targetLabel: agent
          replacement: "GL-011"

      # Metric relabeling (applied after scraping)
      metricRelabelings:
        # Drop high-cardinality Go runtime metrics if needed
        - sourceLabels: [__name__]
          regex: 'go_.*'
          action: drop

        # Normalize metric names
        - sourceLabels: [__name__]
          targetLabel: __name__
          regex: 'gl_011_(.*)'
          replacement: 'gl_011_${1}'
          action: replace

---
# PodMonitor for direct pod scraping (alternative to ServiceMonitor)
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: gl-011-fuelcraft-pods
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"
    release: prometheus
spec:
  selector:
    matchLabels:
      app: gl-011-fuelcraft
      agent: "GL-011"

  namespaceSelector:
    matchNames:
      - greenlang

  podMetricsEndpoints:
    - port: metrics
      path: /api/v1/metrics
      interval: 30s
      scrapeTimeout: 10s

---
# PrometheusRule for GL-011 specific alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gl-011-fuelcraft-alerts
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    # Critical alerts
    - name: gl-011-critical
      interval: 30s
      rules:
        - alert: GL011Down
          expr: up{job="gl-011-fuelcraft"} == 0
          for: 1m
          labels:
            severity: critical
            agent: GL-011
            team: fuel-optimization
          annotations:
            summary: "GL-011 FUELCRAFT is down"
            description: "GL-011 pod {{ $labels.pod }} is down for more than 1 minute"
            runbook_url: "https://docs.greenlang.ai/runbooks/gl-011-down"

        - alert: GL011HighErrorRate
          expr: |
            sum(rate(gl_011_http_requests_total{status=~"5.."}[5m])) /
            sum(rate(gl_011_http_requests_total[5m])) > 0.05
          for: 5m
          labels:
            severity: critical
            agent: GL-011
          annotations:
            summary: "GL-011 high error rate"
            description: "GL-011 error rate is above 5% for 5 minutes"

        - alert: GL011FuelOptimizationFailures
          expr: |
            sum(rate(gl_011_fuel_optimization_failures_total[5m])) > 10
          for: 5m
          labels:
            severity: critical
            agent: GL-011
          annotations:
            summary: "GL-011 fuel optimization failures"
            description: "More than 10 fuel optimizations failed in the last 5 minutes"

    # Warning alerts
    - name: gl-011-warning
      interval: 60s
      rules:
        - alert: GL011HighLatency
          expr: |
            histogram_quantile(0.95, sum(rate(gl_011_http_request_duration_seconds_bucket[5m])) by (le)) > 2
          for: 10m
          labels:
            severity: warning
            agent: GL-011
          annotations:
            summary: "GL-011 high latency"
            description: "GL-011 p95 latency is above 2 seconds for 10 minutes"

        - alert: GL011HighCPU
          expr: |
            sum(rate(container_cpu_usage_seconds_total{container="gl-011-fuelcraft"}[5m])) /
            sum(kube_pod_container_resource_limits{container="gl-011-fuelcraft", resource="cpu"}) > 0.85
          for: 10m
          labels:
            severity: warning
            agent: GL-011
          annotations:
            summary: "GL-011 high CPU usage"
            description: "GL-011 CPU usage is above 85% of limit for 10 minutes"

        - alert: GL011HighMemory
          expr: |
            sum(container_memory_working_set_bytes{container="gl-011-fuelcraft"}) /
            sum(kube_pod_container_resource_limits{container="gl-011-fuelcraft", resource="memory"}) > 0.85
          for: 10m
          labels:
            severity: warning
            agent: GL-011
          annotations:
            summary: "GL-011 high memory usage"
            description: "GL-011 memory usage is above 85% of limit for 10 minutes"

        - alert: GL011EmissionsExceedance
          expr: |
            gl_011_emissions_exceedance_count > 0
          for: 5m
          labels:
            severity: warning
            agent: GL-011
            category: compliance
          annotations:
            summary: "GL-011 emissions limit exceedance detected"
            description: "Fuel mix optimization detected emissions exceeding regulatory limits"

        - alert: GL011FuelCostDeviation
          expr: |
            abs(gl_011_fuel_cost_actual - gl_011_fuel_cost_optimized) / gl_011_fuel_cost_optimized > 0.15
          for: 15m
          labels:
            severity: warning
            agent: GL-011
            category: cost
          annotations:
            summary: "GL-011 fuel cost deviation"
            description: "Actual fuel cost deviates more than 15% from optimized cost"

    # SLO alerts
    - name: gl-011-slo
      interval: 30s
      rules:
        - alert: GL011SLOAvailabilityBreach
          expr: |
            sum(rate(gl_011_http_requests_total{status!~"5.."}[1h])) /
            sum(rate(gl_011_http_requests_total[1h])) < 0.995
          for: 5m
          labels:
            severity: critical
            agent: GL-011
            slo: availability
          annotations:
            summary: "GL-011 SLO availability breach"
            description: "GL-011 availability is below 99.5% SLO"

---
# ConfigMap for Prometheus scrape configuration (optional, if not using Prometheus Operator)
apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-011-prometheus-config
  namespace: greenlang
data:
  prometheus.yml: |
    global:
      scrape_interval: 30s
      evaluation_interval: 30s
      external_labels:
        cluster: greenlang-production
        environment: production
        agent: GL-011

    scrape_configs:
      - job_name: 'gl-011-fuelcraft'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - greenlang

        relabel_configs:
          # Only scrape pods with app=gl-011-fuelcraft label
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: gl-011-fuelcraft

          # Set scrape port to 9090
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: "9090"

          # Add pod name
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
            action: replace

          # Add namespace
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
            action: replace

          # Add node
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node
            action: replace

        metric_relabel_configs:
          # Drop unwanted metrics to reduce storage
          - source_labels: [__name__]
            regex: 'process_.*'
            action: drop

---
# Grafana Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-011-grafana-dashboards
  namespace: greenlang
  labels:
    grafana_dashboard: "1"
data:
  gl-011-overview.json: |
    {
      "title": "GL-011 FUELCRAFT Overview",
      "description": "Fuel optimization and emissions management dashboard",
      "tags": ["gl-011", "fuelcraft", "fuel-optimization"],
      "panels": [
        {
          "title": "Request Rate",
          "type": "graph",
          "targets": [
            {
              "expr": "sum(rate(gl_011_http_requests_total[5m]))",
              "legendFormat": "Requests/sec"
            }
          ]
        },
        {
          "title": "Fuel Optimization Success Rate",
          "type": "gauge",
          "targets": [
            {
              "expr": "sum(rate(gl_011_fuel_optimization_success_total[5m])) / sum(rate(gl_011_fuel_optimization_total[5m])) * 100"
            }
          ]
        },
        {
          "title": "Emissions vs Limits",
          "type": "graph",
          "targets": [
            {
              "expr": "gl_011_emissions_actual",
              "legendFormat": "Actual"
            },
            {
              "expr": "gl_011_emissions_limit",
              "legendFormat": "Limit"
            }
          ]
        },
        {
          "title": "Fuel Cost Optimization",
          "type": "graph",
          "targets": [
            {
              "expr": "gl_011_fuel_cost_actual",
              "legendFormat": "Actual Cost"
            },
            {
              "expr": "gl_011_fuel_cost_optimized",
              "legendFormat": "Optimized Cost"
            }
          ]
        }
      ]
    }
