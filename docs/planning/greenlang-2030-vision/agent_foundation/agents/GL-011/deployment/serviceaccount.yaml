# GL-011 FUELCRAFT - ServiceAccount & RBAC
# Implements least privilege access for GL-011 pods
# Grants only necessary permissions to Kubernetes API

---
# ServiceAccount for GL-011 pods
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-011-fuelcraft
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"
    version: "1.0.0"
  annotations:
    description: "ServiceAccount for GL-011 FUELCRAFT fuel optimization agent"
    documentation: "https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/"

# Disable automatic token mounting (security best practice)
# Pods should explicitly mount tokens only if needed
automountServiceAccountToken: false

---
# Role - Namespace-scoped permissions for GL-011
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-011-fuelcraft-role
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"

rules:
  # Read access to ConfigMaps (for runtime configuration)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
    resourceNames: ["gl-011-config", "gl-011-config-staging"]

  # Read access to Secrets (for credentials)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
    resourceNames: ["gl-011-secrets"]

  # Read access to own Service endpoints
  - apiGroups: [""]
    resources: ["endpoints", "services"]
    verbs: ["get", "list", "watch"]
    resourceNames: ["gl-011-fuelcraft", "gl-011-fuelcraft-metrics", "gl-011-fuelcraft-headless"]

  # Pod self-inspection (for health checks, metrics)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

  # Events creation (for logging important events)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # Read access to own Deployment (for version checking)
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list"]
    resourceNames: ["gl-011-fuelcraft"]

  # Read access to HPA (for scaling awareness)
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list"]
    resourceNames: ["gl-011-fuelcraft-hpa"]

---
# RoleBinding - Bind Role to ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-011-fuelcraft-rolebinding
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"

subjects:
  - kind: ServiceAccount
    name: gl-011-fuelcraft
    namespace: greenlang

roleRef:
  kind: Role
  name: gl-011-fuelcraft-role
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole - Cluster-wide read-only permissions (if needed)
# Only create this if GL-011 needs cluster-level visibility
# For most applications, Role + RoleBinding is sufficient

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gl-011-fuelcraft-cluster-role
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"

rules:
  # Read-only access to Nodes (for node affinity decisions)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]

  # Read-only access to Namespaces
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "watch"]

  # Read-only access to StorageClasses (if using PVCs for fuel data)
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]

  # Read-only access to PersistentVolumes (for fuel data storage)
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding - Bind ClusterRole to ServiceAccount
# Only enable if GL-011 requires cluster-level permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gl-011-fuelcraft-cluster-rolebinding
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"

subjects:
  - kind: ServiceAccount
    name: gl-011-fuelcraft
    namespace: greenlang

roleRef:
  kind: ClusterRole
  name: gl-011-fuelcraft-cluster-role
  apiGroup: rbac.authorization.k8s.io

---
# Additional RBAC best practices for GL-011:
#
# 1. **Least Privilege Principle**:
#    - Grant only minimum required permissions
#    - Use resourceNames to restrict access to specific resources
#    - Prefer Role over ClusterRole when possible
#
# 2. **Token Management**:
#    - Set automountServiceAccountToken: false by default
#    - Only mount tokens when API access is required
#    - Use projected volumes for token rotation (Kubernetes 1.20+)
#
# 3. **Security Auditing**:
#    - Review RBAC permissions quarterly
#    - Monitor ServiceAccount token usage
#    - Use audit logs to detect privilege escalation
#
# 4. **Testing RBAC**:
#    kubectl auth can-i get configmaps --as=system:serviceaccount:greenlang:gl-011-fuelcraft -n greenlang
#    kubectl auth can-i delete pods --as=system:serviceaccount:greenlang:gl-011-fuelcraft -n greenlang
#
# 5. **RBAC for Secrets Access**:
#    - Use External Secrets Operator or Sealed Secrets
#    - Avoid granting broad secrets/* access
#    - Use resourceNames to restrict to specific secrets
#
# 6. **Pod Security Standards** (PSS):
#    GL-011 deployment complies with Restricted PSS:
#      * runAsNonRoot: true
#      * allowPrivilegeEscalation: false
#      * readOnlyRootFilesystem: true
#      * capabilities dropped
#
# 7. **RBAC Debugging**:
#    kubectl get rolebinding -n greenlang
#    kubectl describe role gl-011-fuelcraft-role -n greenlang
#    kubectl describe rolebinding gl-011-fuelcraft-rolebinding -n greenlang
