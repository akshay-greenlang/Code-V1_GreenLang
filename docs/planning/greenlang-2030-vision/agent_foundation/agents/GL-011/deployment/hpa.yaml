# GL-011 FUELCRAFT - Horizontal Pod Autoscaler
# Automatically scales pods based on CPU and memory utilization
# Maintains 2-10 pods, scales at 70% CPU or 80% memory

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: gl-011-fuelcraft-hpa
  namespace: greenlang
  labels:
    app: gl-011-fuelcraft
    agent: "GL-011"
    version: "1.0.0"
  annotations:
    description: "Horizontal Pod Autoscaler for GL-011 FUELCRAFT"

spec:
  # Target the GL-011 deployment
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: gl-011-fuelcraft

  # Min and max replicas (as specified: min 2, max 10)
  minReplicas: 2
  maxReplicas: 10

  # Metrics for scaling decisions
  metrics:
    # Scale on CPU utilization (target 70%)
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    # Scale on memory utilization (target 80%)
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

  # Scaling behavior (fine-tune for stability)
  behavior:
    # Scale up aggressively for fuel optimization demand spikes
    scaleUp:
      stabilizationWindowSeconds: 30   # Wait 30s before next scale-up
      policies:
        - type: Percent
          value: 100                    # Double the pods
          periodSeconds: 30
        - type: Pods
          value: 2                      # Or add 2 pods
          periodSeconds: 60
      selectPolicy: Max                 # Use whichever scales up more

    # Scale down conservatively to maintain optimization state
    scaleDown:
      stabilizationWindowSeconds: 300   # Wait 5 minutes before scale-down
      policies:
        - type: Percent
          value: 50                     # Reduce by 50%
          periodSeconds: 60
        - type: Pods
          value: 1                      # Or remove 1 pod
          periodSeconds: 120
      selectPolicy: Min                 # Use whichever scales down less

---
# Custom metrics HPA (optional - for fuel-specific metrics)
# Requires Prometheus Adapter or KEDA for custom metrics
#
# apiVersion: autoscaling/v2
# kind: HorizontalPodAutoscaler
# metadata:
#   name: gl-011-fuelcraft-hpa-custom
#   namespace: greenlang
# spec:
#   scaleTargetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: gl-011-fuelcraft
#   minReplicas: 2
#   maxReplicas: 10
#   metrics:
#     # Scale on pending optimization requests
#     - type: Pods
#       pods:
#         metric:
#           name: fuel_optimization_pending_requests
#         target:
#           type: AverageValue
#           averageValue: "50"
#
#     # Scale on fuel data processing queue depth
#     - type: External
#       external:
#         metric:
#           name: fuel_data_queue_depth
#         target:
#           type: AverageValue
#           averageValue: "100"

---
# Example: Vertical Pod Autoscaler (VPA) for resource optimization
# Install: kubectl apply -f https://github.com/kubernetes/autoscaler/releases/download/vertical-pod-autoscaler-0.14.0/vpa-v0.14.0.yaml
#
# apiVersion: autoscaling.k8s.io/v1
# kind: VerticalPodAutoscaler
# metadata:
#   name: gl-011-fuelcraft-vpa
#   namespace: greenlang
# spec:
#   targetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: gl-011-fuelcraft
#   updatePolicy:
#     updateMode: "Auto"
#   resourcePolicy:
#     containerPolicies:
#       - containerName: gl-011-fuelcraft
#         minAllowed:
#           memory: "1Gi"
#           cpu: "500m"
#         maxAllowed:
#           memory: "8Gi"
#           cpu: "4000m"

---
# Scaling policy documentation for GL-011:
#
# High-traffic pattern (fuel optimization peaks during market hours):
#   - Morning: 06:00-09:00 - Scale up for daily planning
#   - Trading hours: 09:00-17:00 - Maximum capacity
#   - Evening: 17:00-20:00 - Gradual scale down
#   - Night: 20:00-06:00 - Minimum capacity
#
# Fuel demand patterns:
#   - Weekly: Higher Monday-Friday, lower weekend
#   - Seasonal: Higher in winter (heating), summer (cooling)
#   - Market events: Spike during price volatility
#
# Recommended monitoring:
#   - Track HPA current/desired replicas
#   - Monitor scaling events in logs
#   - Set alerts for max replica threshold
#   - Review cost impact of scaling
