# GL-008 TRAPCATCHER - CI/CD Pipeline
# Automated testing, validation, and deployment

name: GL-008 CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/**'
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.10'
  DOCKER_IMAGE: greenlang/gl-008-trapcatcher
  COVERAGE_THRESHOLD: 85

jobs:
  # ============================================================================
  # CODE QUALITY CHECKS
  # ============================================================================

  lint-and-format:
    name: Code Quality (Lint & Format)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff mypy

      - name: Check code formatting (Black)
        run: black --check --diff .

      - name: Lint code (Ruff)
        run: ruff check .

      - name: Type checking (MyPy)
        run: mypy --ignore-missing-imports *.py

  # ============================================================================
  # UNIT & INTEGRATION TESTS
  # ============================================================================

  test:
    name: Tests (Unit & Integration)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsndfile1 ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          pytest tests/test_tools.py -v --cov=tools --cov-report=xml --cov-report=html

      - name: Run integration tests
        run: |
          pytest tests/test_agent.py -v --asyncio-mode=auto

      - name: Check coverage threshold
        run: |
          coverage report --fail-under=${{ env.COVERAGE_THRESHOLD }}

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-gl-008

  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json

      - name: Run Safety dependency check
        run: |
          pip install safety
          safety check --json

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ============================================================================
  # DOCKER BUILD & VALIDATION
  # ============================================================================

  docker:
    name: Docker Build & Validate
    runs-on: ubuntu-latest
    needs: [lint-and-format, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} .

      - name: Test Docker container
        run: |
          docker run --rm ${{ env.DOCKER_IMAGE }}:${{ github.sha }} python -c "import steam_trap_inspector; print('OK')"

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # PERFORMANCE BENCHMARKS
  # ============================================================================

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-benchmark

      - name: Run performance benchmarks
        run: |
          pytest tests/ --benchmark-only --benchmark-json=benchmark.json

      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'pytest'
          output-file-path: benchmark.json
          auto-push: true

  # ============================================================================
  # DEPLOYMENT
  # ============================================================================

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker, security]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure kubectl
        uses: azure/setup-kubectl@v3

      - name: Deploy to staging
        run: |
          kubectl apply -f k8s/staging/
          kubectl rollout status deployment/steam-trap-inspector -n greenlang-staging

      - name: Run smoke tests
        run: |
          kubectl run smoke-test --rm -i --restart=Never \
            --image=${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            -- python -m examples.basic_usage

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker, security, benchmark]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://gl-008.greenlang.org

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure kubectl
        uses: azure/setup-kubectl@v3

      - name: Deploy to production
        run: |
          kubectl apply -f k8s/production/
          kubectl rollout status deployment/steam-trap-inspector -n greenlang-production

      - name: Health check
        run: |
          kubectl get pods -n greenlang-production -l app=steam-trap-inspector
          curl -f https://gl-008.greenlang.org/health || exit 1

      - name: Tag Docker image
        run: |
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:latest
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:v1.0.0

  # ============================================================================
  # NOTIFICATIONS
  # ============================================================================

  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
      - name: Notify success
        if: ${{ success() }}
        run: |
          echo "GL-008 TRAPCATCHER deployed successfully!"
          # Add Slack/email notification here

      - name: Notify failure
        if: ${{ failure() }}
        run: |
          echo "GL-008 TRAPCATCHER deployment failed!"
          # Add Slack/email notification here
