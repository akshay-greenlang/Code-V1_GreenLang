# GL-009 THERMALIQ ThermalEfficiencyCalculator - Kubernetes Deployment
# Production-grade deployment with resource limits, health checks, and auto-scaling
# Compatible with Kubernetes 1.24+

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gl-009-thermaliq
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
    version: "1.0.0"
    component: "thermal-efficiency-calculator"
    category: "thermal-engineering"
  annotations:
    description: "THERMALIQ ThermalEfficiencyCalculator - Industrial thermal efficiency optimization agent"
    documentation: "https://docs.greenlang.ai/agents/GL-009"
    contact: "devops@greenlang.ai"

spec:
  # Replicas for production (3 for high availability)
  replicas: 3

  # Rolling update strategy with zero downtime
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Allow 1 extra pod during update
      maxUnavailable: 0  # Never take down all pods simultaneously

  # Minimum time for pod to be ready before considering it available
  minReadySeconds: 10

  # Label selector for pod management
  selector:
    matchLabels:
      app: gl-009-thermaliq
      agent: "GL-009"

  template:
    metadata:
      labels:
        app: gl-009-thermaliq
        agent: "GL-009"
        version: "1.0.0"
        component: "thermal-efficiency-calculator"
      annotations:
        # Prometheus metrics scraping
        prometheus.io/scrape: "true"
        prometheus.io/port: "8001"
        prometheus.io/path: "/api/v1/metrics"
        prometheus.io/interval: "30s"

        # Checksum for automatic rollout on config changes
        checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"
        checksum/secret: "{{ include (print $.Template.BasePath \"/secret.yaml\") . | sha256sum }}"

    spec:
      # Service account for RBAC
      serviceAccountName: gl-009-thermaliq

      # Security context for pod-level security
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # Affinity rules for high availability and optimal placement
      affinity:
        # Pod Anti-Affinity: Spread pods across nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - gl-009-thermaliq
                topologyKey: kubernetes.io/hostname
            - weight: 50
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - gl-009-thermaliq
                topologyKey: topology.kubernetes.io/zone

        # Node Affinity: Prefer nodes with specific labels
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 80
              preference:
                matchExpressions:
                  - key: workload-type
                    operator: In
                    values:
                      - computation-intensive
            - weight: 60
              preference:
                matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - high-memory

      # Topology spread constraints for even distribution
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: gl-009-thermaliq

      # Termination grace period for graceful shutdown
      terminationGracePeriodSeconds: 60

      # DNS Policy
      dnsPolicy: ClusterFirst

      # Init containers for pre-flight checks
      initContainers:
        - name: check-database
          image: postgres:14-alpine
          command:
            - sh
            - -c
            - |
              until pg_isready -h ${DB_HOST} -p ${DB_PORT} -U ${DB_USER}; do
                echo "Waiting for database to be ready..."
                sleep 2
              done
              echo "Database is ready!"
          env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: database_host
            - name: DB_PORT
              value: "5432"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: database_user

        - name: check-redis
          image: redis:7-alpine
          command:
            - sh
            - -c
            - |
              until redis-cli -h ${REDIS_HOST} -p ${REDIS_PORT} ping; do
                echo "Waiting for Redis to be ready..."
                sleep 2
              done
              echo "Redis is ready!"
          env:
            - name: REDIS_HOST
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: redis_host
            - name: REDIS_PORT
              value: "6379"

      containers:
        - name: thermaliq
          image: "gcr.io/greenlang/gl-009-thermaliq:1.0.0"
          imagePullPolicy: IfNotPresent

          # Security context for container-level security
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE

          # Ports exposed by the container
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
            - name: metrics
              containerPort: 8001
              protocol: TCP
            - name: admin
              containerPort: 8002
              protocol: TCP
            - name: websocket
              containerPort: 8003
              protocol: TCP

          # Environment variables from ConfigMap and Secrets
          env:
            # Environment type
            - name: GREENLANG_ENV
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: environment

            # Logging configuration
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: log_level

            - name: LOGGING_FORMAT
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: logging_format

            # Database configuration
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: database_url

            - name: DATABASE_POOL_SIZE
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: database_pool_size

            # Redis cache configuration
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: redis_url

            - name: CACHE_TTL_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: cache_ttl_seconds

            # API keys and authentication
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: api_key

            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: gl-009-secrets
                  key: jwt_secret

            - name: JWT_ALGORITHM
              value: "HS256"

            - name: JWT_EXPIRATION_MINUTES
              value: "60"

            # Metrics and monitoring
            - name: METRICS_ENABLED
              value: "true"

            - name: METRICS_PORT
              value: "8001"

            - name: PROMETHEUS_ENABLED
              value: "true"

            - name: OPENTELEMETRY_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: opentelemetry_enabled

            - name: JAEGER_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: jaeger_endpoint

            # Thermal efficiency calculation configuration
            - name: CALCULATION_TIMEOUT_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: calculation_timeout_seconds

            - name: MAX_CONCURRENT_CALCULATIONS
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: max_concurrent_calculations

            - name: ENABLE_HEAT_RECOVERY_ANALYSIS
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: enable_heat_recovery_analysis

            - name: ENABLE_PINCH_ANALYSIS
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: enable_pinch_analysis

            - name: ENABLE_EXERGY_ANALYSIS
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: enable_exergy_analysis

            # Scientific computing optimization
            - name: NUMPY_THREADS
              value: "4"

            - name: SCIPY_OPTIMIZATION_METHOD
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: scipy_optimization_method

            # Industrial protocol configuration
            - name: MODBUS_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: modbus_enabled

            - name: OPCUA_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: opcua_enabled

            - name: MQTT_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: gl-009-config
                  key: mqtt_enabled

            # Pod information for logging and observability
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name

            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

            - name: SERVICE_ACCOUNT
              valueFrom:
                fieldRef:
                  fieldPath: spec.serviceAccountName

            # Resource limits as environment variables
            - name: MEMORY_LIMIT_MB
              valueFrom:
                resourceFieldRef:
                  containerName: thermaliq
                  resource: limits.memory
                  divisor: 1Mi

            - name: CPU_LIMIT_CORES
              valueFrom:
                resourceFieldRef:
                  containerName: thermaliq
                  resource: limits.cpu
                  divisor: 1m

          # Resource requests and limits
          # Requests: guaranteed resources
          # Limits: maximum resources to prevent node exhaustion
          resources:
            requests:
              memory: "1Gi"
              cpu: "1000m"
              ephemeral-storage: "2Gi"
            limits:
              memory: "2Gi"
              cpu: "2000m"
              ephemeral-storage: "5Gi"

          # Liveness probe - restart pod if unresponsive
          # Detects deadlocks, memory leaks, infinite loops
          livenessProbe:
            httpGet:
              path: /api/v1/health
              port: http
              scheme: HTTP
              httpHeaders:
                - name: X-Probe-Type
                  value: liveness
            initialDelaySeconds: 60   # Wait for startup (thermal models loading)
            periodSeconds: 15         # Check every 15 seconds
            timeoutSeconds: 10        # 10 second timeout
            failureThreshold: 3       # Restart after 3 failures (45 seconds)
            successThreshold: 1       # 1 success to declare healthy

          # Readiness probe - remove from service if not ready
          # Detects slow startup, initialization issues
          readinessProbe:
            httpGet:
              path: /api/v1/ready
              port: http
              scheme: HTTP
              httpHeaders:
                - name: X-Probe-Type
                  value: readiness
            initialDelaySeconds: 20   # Quick readiness check
            periodSeconds: 10         # Check every 10 seconds
            timeoutSeconds: 5         # 5 second timeout
            failureThreshold: 3       # Remove after 3 failures (30 seconds)
            successThreshold: 1       # 1 success to add back to service

          # Startup probe - allow time for application bootstrap
          # Prevents killing slow-starting applications with thermal model initialization
          startupProbe:
            httpGet:
              path: /api/v1/health
              port: http
              scheme: HTTP
              httpHeaders:
                - name: X-Probe-Type
                  value: startup
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30      # 300 seconds (30 * 10s) for startup

          # Lifecycle hooks for graceful shutdown
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    # Send SIGTERM and wait for graceful shutdown
                    kill -TERM 1
                    # Wait for active calculations to complete
                    sleep 30

          # Volume mounts for logs, cache, and temporary files
          volumeMounts:
            - name: logs
              mountPath: /app/logs
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/cache
            - name: data
              mountPath: /app/data
            - name: calculations
              mountPath: /app/calculations
            - name: models
              mountPath: /app/models
            - name: reports
              mountPath: /app/reports

      # Volumes for ephemeral storage
      volumes:
        - name: logs
          emptyDir:
            sizeLimit: 2Gi
        - name: tmp
          emptyDir:
            sizeLimit: 1Gi
        - name: cache
          emptyDir:
            sizeLimit: 5Gi
        - name: data
          emptyDir:
            sizeLimit: 10Gi
        - name: calculations
          emptyDir:
            sizeLimit: 5Gi
        - name: models
          emptyDir:
            sizeLimit: 3Gi
        - name: reports
          emptyDir:
            sizeLimit: 2Gi

---
# ServiceAccount with RBAC permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-009-thermaliq
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"

---
# ClusterRole for GL-009
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gl-009-thermaliq
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
rules:
  # Read ConfigMaps and Secrets
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]

  # Read Pods (for pod discovery and health checks)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Read Nodes (for node information and resource availability)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]

  # Read Services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch"]

  # Read and create Events
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "create"]

  # Read Endpoints for service discovery
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for GL-009
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gl-009-thermaliq
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: gl-009-thermaliq
subjects:
  - kind: ServiceAccount
    name: gl-009-thermaliq
    namespace: greenlang
