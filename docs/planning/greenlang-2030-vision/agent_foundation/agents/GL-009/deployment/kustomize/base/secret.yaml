# GL-009 THERMALIQ ThermalEfficiencyCalculator - Secrets Management
# Uses External Secrets Operator for secure secret injection from AWS Secrets Manager

---
# ExternalSecret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-009-database-secret
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-009-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        database_url: "postgresql://{{ .database_user }}:{{ .database_password }}@{{ .database_host }}:{{ .database_port }}/{{ .database_name }}"
        database_host: "{{ .database_host }}"
        database_port: "{{ .database_port }}"
        database_name: "{{ .database_name }}"
        database_user: "{{ .database_user }}"
        database_password: "{{ .database_password }}"
  dataFrom:
    - extract:
        key: greenlang/gl-009/database

---
# ExternalSecret for Redis credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-009-redis-secret
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-009-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        redis_url: "redis://:{{ .redis_password }}@{{ .redis_host }}:{{ .redis_port }}/0"
        redis_host: "{{ .redis_host }}"
        redis_port: "{{ .redis_port }}"
        redis_password: "{{ .redis_password }}"
  dataFrom:
    - extract:
        key: greenlang/gl-009/redis

---
# ExternalSecret for API keys and JWT secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-009-api-secret
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-009-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        api_key: "{{ .api_key }}"
        jwt_secret: "{{ .jwt_secret }}"
        encryption_key: "{{ .encryption_key }}"
  dataFrom:
    - extract:
        key: greenlang/gl-009/api

---
# ExternalSecret for Sentry DSN
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-009-monitoring-secret
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-009-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        sentry_dsn: "{{ .sentry_dsn }}"
  dataFrom:
    - extract:
        key: greenlang/gl-009/monitoring

---
# Fallback Secret for local development (DO NOT USE IN PRODUCTION)
# This should be overridden by External Secrets in production
apiVersion: v1
kind: Secret
metadata:
  name: gl-009-secrets-dev
  namespace: greenlang
  labels:
    app: gl-009-thermaliq
    agent: "GL-009"
    environment: "development"
  annotations:
    description: "Development secrets - DO NOT USE IN PRODUCTION"
type: Opaque
stringData:
  # Database (local development)
  database_url: "postgresql://greenlang:greenlang@localhost:5432/gl009_thermaliq"
  database_host: "localhost"
  database_port: "5432"
  database_name: "gl009_thermaliq"
  database_user: "greenlang"
  database_password: "greenlang"

  # Redis (local development)
  redis_url: "redis://localhost:6379/0"
  redis_host: "localhost"
  redis_port: "6379"
  redis_password: ""

  # API Keys (local development)
  api_key: "dev-api-key-change-in-production"
  jwt_secret: "dev-jwt-secret-change-in-production-must-be-256-bits"
  encryption_key: "dev-encryption-key-change-in-production"

  # Monitoring (local development)
  sentry_dsn: ""
