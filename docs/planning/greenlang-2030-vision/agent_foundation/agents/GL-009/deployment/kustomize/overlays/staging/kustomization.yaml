# GL-009 THERMALIQ - Staging Environment
# Pre-production environment for final testing

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base configuration
bases:
  - ../../base

# Namespace override
namespace: greenlang-staging

# Name prefix for all resources
namePrefix: staging-

# Common labels for staging environment
commonLabels:
  environment: staging
  tier: staging

# Common annotations
commonAnnotations:
  environment: "staging"
  managed-by: "kustomize"

# Images - use staging tag
images:
  - name: gcr.io/greenlang/gl-009-thermaliq
    newTag: "staging-latest"

# Replicas - 2 for staging
replicas:
  - name: gl-009-thermaliq
    count: 2

# ConfigMap patches for staging
patches:
  # Set replicas to 2
  - target:
      kind: Deployment
      name: gl-009-thermaliq
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2

  # Update environment-specific config
  - target:
      kind: ConfigMap
      name: gl-009-config
    patch: |-
      - op: replace
        path: /data/environment
        value: "staging"
      - op: replace
        path: /data/log_level
        value: "INFO"
      - op: replace
        path: /data/database_pool_size
        value: "15"
      - op: replace
        path: /data/max_concurrent_calculations
        value: "30"
      - op: replace
        path: /data/calculation_timeout_seconds
        value: "300"
      - op: replace
        path: /data/sentry_enabled
        value: "true"
      - op: replace
        path: /data/sentry_traces_sample_rate
        value: "0.5"
      - op: add
        path: /data/enable_debug_endpoints
        value: "true"

  # Moderate resource requests and limits
  - target:
      kind: Deployment
      name: gl-009-thermaliq
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "768Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "750m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1536Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1500m"

  # Update HPA for staging
  - target:
      kind: HorizontalPodAutoscaler
      name: gl-009-thermaliq-hpa
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 2
      - op: replace
        path: /spec/maxReplicas
        value: 5
      - op: replace
        path: /spec/metrics/0/resource/target/averageUtilization
        value: 75

  # Update PDB for staging
  - target:
      kind: PodDisruptionBudget
      name: gl-009-thermaliq-pdb
    patch: |-
      - op: replace
        path: /spec/minAvailable
        value: 1

  # Update Ingress for staging domain
  - target:
      kind: Ingress
      name: gl-009-thermaliq-ingress
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts
        value:
          - staging.thermaliq.greenlang.ai
          - staging-api.thermaliq.greenlang.ai
      - op: replace
        path: /spec/rules/0/host
        value: "staging.thermaliq.greenlang.ai"
      - op: replace
        path: /spec/rules/1/host
        value: "staging-api.thermaliq.greenlang.ai"

# Additional resources for staging
resources:
  - staging-configmap-patch.yaml

# Secret management - use External Secrets with staging AWS Secrets Manager
patchesStrategicMerge:
  - |-
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: gl-009-database-secret
    spec:
      dataFrom:
        - extract:
            key: greenlang/staging/gl-009/database
