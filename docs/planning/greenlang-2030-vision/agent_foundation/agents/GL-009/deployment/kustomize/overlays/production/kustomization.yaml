# GL-009 THERMALIQ - Production Environment
# Full production configuration with high availability and multi-region support

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base configuration
bases:
  - ../../base

# Namespace override
namespace: greenlang-production

# Name prefix for all resources
namePrefix: prod-

# Common labels for production environment
commonLabels:
  environment: production
  tier: production
  criticality: high

# Common annotations
commonAnnotations:
  environment: "production"
  managed-by: "kustomize"
  backup-policy: "daily"
  monitoring: "enabled"
  alerting: "enabled"

# Images - use production tag with digest for immutability
images:
  - name: gcr.io/greenlang/gl-009-thermaliq
    newTag: "1.0.0"
    # digest: sha256:...  # Add digest for production immutability

# Replicas - 3 for production (HPA will scale up to 10)
replicas:
  - name: gl-009-thermaliq
    count: 3

# ConfigMap patches for production
patches:
  # Set replicas to 3 (HPA will manage scaling)
  - target:
      kind: Deployment
      name: gl-009-thermaliq
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  # Update environment-specific config
  - target:
      kind: ConfigMap
      name: gl-009-config
    patch: |-
      - op: replace
        path: /data/environment
        value: "production"
      - op: replace
        path: /data/log_level
        value: "WARNING"
      - op: replace
        path: /data/database_pool_size
        value: "20"
      - op: replace
        path: /data/max_concurrent_calculations
        value: "50"
      - op: replace
        path: /data/calculation_timeout_seconds
        value: "300"
      - op: replace
        path: /data/sentry_enabled
        value: "true"
      - op: replace
        path: /data/sentry_traces_sample_rate
        value: "0.1"
      - op: add
        path: /data/enable_debug_endpoints
        value: "false"
      - op: add
        path: /data/enable_production_optimizations
        value: "true"

  # Full resource requests and limits for production
  - target:
      kind: Deployment
      name: gl-009-thermaliq
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "2000m"

  # Production HPA configuration
  - target:
      kind: HorizontalPodAutoscaler
      name: gl-009-thermaliq-hpa
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 10
      - op: replace
        path: /spec/metrics/0/resource/target/averageUtilization
        value: 70
      - op: replace
        path: /spec/metrics/1/resource/target/averageUtilization
        value: 80

  # Production PDB - always keep 2 pods available
  - target:
      kind: PodDisruptionBudget
      name: gl-009-thermaliq-pdb
    patch: |-
      - op: replace
        path: /spec/minAvailable
        value: 2

  # Update Ingress for production domain
  - target:
      kind: Ingress
      name: gl-009-thermaliq-ingress
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts
        value:
          - thermaliq.greenlang.ai
          - api.thermaliq.greenlang.ai
      - op: replace
        path: /spec/rules/0/host
        value: "thermaliq.greenlang.ai"
      - op: replace
        path: /spec/rules/1/host
        value: "api.thermaliq.greenlang.ai"
      - op: add
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1rate-limit
        value: "200"

  # Add pod anti-affinity for production
  - target:
      kind: Deployment
      name: gl-009-thermaliq
    patch: |-
      - op: add
        path: /spec/template/spec/affinity/podAntiAffinity/requiredDuringSchedulingIgnoredDuringExecution
        value:
          - labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - gl-009-thermaliq
            topologyKey: kubernetes.io/hostname

  # Add production-grade health checks with tighter constraints
  - target:
      kind: Deployment
      name: gl-009-thermaliq
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe/periodSeconds
        value: 10
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe/failureThreshold
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe/periodSeconds
        value: 5
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe/failureThreshold
        value: 2

# Additional production resources
resources:
  - production-configmap-patch.yaml
  - production-monitoring.yaml

# Secret management - use External Secrets with production AWS Secrets Manager
patchesStrategicMerge:
  - |-
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: gl-009-database-secret
    spec:
      refreshInterval: 30m
      dataFrom:
        - extract:
            key: greenlang/production/gl-009/database
  - |-
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: gl-009-redis-secret
    spec:
      refreshInterval: 30m
      dataFrom:
        - extract:
            key: greenlang/production/gl-009/redis
  - |-
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: gl-009-api-secret
    spec:
      refreshInterval: 30m
      dataFrom:
        - extract:
            key: greenlang/production/gl-009/api
