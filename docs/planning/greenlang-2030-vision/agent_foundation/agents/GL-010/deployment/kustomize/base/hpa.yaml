# GL-010 EMISSIONWATCH EmissionsComplianceAgent - Horizontal Pod Autoscaler
# Autoscaling based on CPU, memory, and custom metrics
# Supports high-throughput emissions data processing

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: gl-010-emissionwatch-hpa
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
  annotations:
    description: "Horizontal pod autoscaler for GL-010 based on resource and custom metrics"

spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: gl-010-emissionwatch

  minReplicas: 3
  maxReplicas: 10

  # Scaling behavior configuration
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5 minutes stabilization before scale down
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60  # Scale down max 50% of pods per minute
        - type: Pods
          value: 2
          periodSeconds: 60  # Or max 2 pods per minute
      selectPolicy: Min  # Use the policy that scales down the least

    scaleUp:
      stabilizationWindowSeconds: 60  # 1 minute stabilization before scale up
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30  # Scale up max 100% of pods per 30 seconds
        - type: Pods
          value: 4
          periodSeconds: 30  # Or max 4 pods per 30 seconds
      selectPolicy: Max  # Use the policy that scales up the most

  # Metrics for autoscaling
  metrics:
    # CPU utilization
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70  # Scale when CPU > 70%

    # Memory utilization
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80  # Scale when memory > 80%

    # Custom metric: CEMS data ingestion rate
    - type: Pods
      pods:
        metric:
          name: cems_data_points_per_second
        target:
          type: AverageValue
          averageValue: "1000"  # Scale when avg data points > 1000/s per pod

    # Custom metric: Emissions calculation queue depth
    - type: Pods
      pods:
        metric:
          name: emissions_calculation_queue_depth
        target:
          type: AverageValue
          averageValue: "50"  # Scale when avg queue depth > 50 per pod

    # Custom metric: Active CEMS connections
    - type: Pods
      pods:
        metric:
          name: active_cems_connections
        target:
          type: AverageValue
          averageValue: "20"  # Scale when avg active connections > 20 per pod

    # Custom metric: Request latency (p95)
    - type: Pods
      pods:
        metric:
          name: http_request_duration_p95_seconds
        target:
          type: AverageValue
          averageValue: "2"  # Scale when p95 latency > 2 seconds

    # Custom metric: Pending compliance reports
    - type: Pods
      pods:
        metric:
          name: pending_compliance_reports
        target:
          type: AverageValue
          averageValue: "10"  # Scale when avg pending reports > 10 per pod
