# GL-010 EMISSIONWATCH EmissionsComplianceAgent - ServiceAccount and RBAC
# Minimal permissions following principle of least privilege
# Pod security standards compliant

---
# ServiceAccount for GL-010
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gl-010-emissionwatch
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
    component: "emissions-compliance-agent"
  annotations:
    description: "Service account for GL-010 EMISSIONWATCH EmissionsComplianceAgent"
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/gl-010-emissionwatch-role"
automountServiceAccountToken: true

---
# Role for namespace-scoped permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gl-010-emissionwatch-role
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
rules:
  # Read ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Read Secrets (for External Secrets Operator managed secrets)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]
    resourceNames:
      - gl-010-secrets
      - gl-010-secrets-dev
      - gl-010-signing-cert

  # Read Pods (for health checks and scaling awareness)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Create Events (for audit logging)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # Read Services (for service discovery)
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]

---
# RoleBinding for namespace-scoped permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gl-010-emissionwatch-rolebinding
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: gl-010-emissionwatch-role
subjects:
  - kind: ServiceAccount
    name: gl-010-emissionwatch
    namespace: greenlang

---
# ClusterRole for cluster-wide read permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gl-010-emissionwatch-clusterrole
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
rules:
  # Read Nodes (for resource availability monitoring)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]

  # Read namespaces (for multi-namespace deployment awareness)
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]

  # Read External Secrets status
  - apiGroups: ["external-secrets.io"]
    resources: ["externalsecrets"]
    verbs: ["get", "list", "watch"]

  # Read PodDisruptionBudgets (for maintenance awareness)
  - apiGroups: ["policy"]
    resources: ["poddisruptionbudgets"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for cluster-wide permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gl-010-emissionwatch-clusterrolebinding
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: gl-010-emissionwatch-clusterrole
subjects:
  - kind: ServiceAccount
    name: gl-010-emissionwatch
    namespace: greenlang

---
# PodSecurityPolicy (for clusters using PSP)
# Note: PSP is deprecated in K8s 1.21+, use Pod Security Standards instead
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: gl-010-emissionwatch-psp
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfiles: "runtime/default"
    apparmor.security.beta.kubernetes.io/allowedProfiles: "runtime/default"
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  allowedCapabilities:
    - NET_BIND_SERVICE
  volumes:
    - configMap
    - emptyDir
    - projected
    - secret
    - downwardAPI
    - persistentVolumeClaim
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    rule: MustRunAsNonRoot
  runAsGroup:
    rule: MustRunAs
    ranges:
      - min: 1000
        max: 65535
  supplementalGroups:
    rule: MustRunAs
    ranges:
      - min: 1000
        max: 65535
  fsGroup:
    rule: MustRunAs
    ranges:
      - min: 1000
        max: 65535
  seLinux:
    rule: RunAsAny
  readOnlyRootFilesystem: true

---
# ResourceQuota for GL-010 workloads
apiVersion: v1
kind: ResourceQuota
metadata:
  name: gl-010-emissionwatch-quota
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  hard:
    requests.cpu: "10"
    requests.memory: "20Gi"
    limits.cpu: "20"
    limits.memory: "40Gi"
    pods: "15"
    persistentvolumeclaims: "10"
    services: "10"
    secrets: "20"
    configmaps: "20"

---
# LimitRange for default resource limits
apiVersion: v1
kind: LimitRange
metadata:
  name: gl-010-emissionwatch-limits
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  limits:
    - type: Container
      default:
        memory: "2Gi"
        cpu: "2000m"
      defaultRequest:
        memory: "1Gi"
        cpu: "1000m"
      max:
        memory: "4Gi"
        cpu: "4000m"
      min:
        memory: "256Mi"
        cpu: "100m"
    - type: Pod
      max:
        memory: "8Gi"
        cpu: "8000m"
    - type: PersistentVolumeClaim
      max:
        storage: "100Gi"
      min:
        storage: "1Gi"
