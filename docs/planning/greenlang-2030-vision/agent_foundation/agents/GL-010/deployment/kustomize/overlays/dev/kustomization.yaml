# GL-010 EMISSIONWATCH - Development Environment
# Optimized for local development and testing
# Uses CEMS simulator instead of real CEMS connections

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base configuration
resources:
  - ../../base

# Namespace override
namespace: greenlang-dev

# Name prefix for all resources
namePrefix: dev-

# Common labels for dev environment
commonLabels:
  environment: development
  tier: dev

# Common annotations
commonAnnotations:
  environment: "development"
  managed-by: "kustomize"

# Images - use development tag
images:
  - name: gcr.io/greenlang/gl-010-emissionwatch
    newTag: "dev-latest"

# Replicas - single replica for development
replicas:
  - name: gl-010-emissionwatch
    count: 1

# ConfigMap patches for development
patches:
  # Reduce replicas to 1
  - target:
      kind: Deployment
      name: gl-010-emissionwatch
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1

  # Update environment-specific config
  - target:
      kind: ConfigMap
      name: gl-010-config
    patch: |-
      - op: replace
        path: /data/environment
        value: "development"
      - op: replace
        path: /data/log_level
        value: "DEBUG"
      - op: replace
        path: /data/database_pool_size
        value: "5"
      - op: replace
        path: /data/cems_polling_interval
        value: "120"
      - op: replace
        path: /data/cems_data_buffer_size
        value: "1000"
      - op: replace
        path: /data/sentry_enabled
        value: "false"
      - op: replace
        path: /data/auto_submit_reports
        value: "false"
      - op: replace
        path: /data/epa_ecmps_enabled
        value: "false"
      - op: replace
        path: /data/eu_ets_enabled
        value: "false"
      - op: add
        path: /data/use_cems_simulator
        value: "true"
      - op: add
        path: /data/enable_debug_endpoints
        value: "true"
      - op: replace
        path: /data/emissions_alert_threshold_percent
        value: "95"
      - op: replace
        path: /data/compliance_report_schedule
        value: "0 * * * *"

  # Reduce resource requests and limits
  - target:
      kind: Deployment
      name: gl-010-emissionwatch
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"

  # Disable HPA in development
  - target:
      kind: HorizontalPodAutoscaler
      name: gl-010-emissionwatch-hpa
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 2

  # Update PDB for single replica
  - target:
      kind: PodDisruptionBudget
      name: gl-010-emissionwatch-pdb
    patch: |-
      - op: replace
        path: /spec/minAvailable
        value: 0

  # Remove init containers in dev (use local databases)
  - target:
      kind: Deployment
      name: gl-010-emissionwatch
    patch: |-
      - op: remove
        path: /spec/template/spec/initContainers

  # Use development secrets
  - target:
      kind: Deployment
      name: gl-010-emissionwatch
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GREENLANG_ENV
          value: "development"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: LOG_LEVEL
          value: "DEBUG"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: gl-010-secrets-dev
              key: database_url
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: gl-010-secrets-dev
              key: redis_url
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: API_KEY
          valueFrom:
            secretKeyRef:
              name: gl-010-secrets-dev
              key: api_key
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: gl-010-secrets-dev
              key: jwt_secret
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: USE_CEMS_SIMULATOR
          value: "true"

  # Relax security context for development
  - target:
      kind: Deployment
      name: gl-010-emissionwatch
    patch: |-
      - op: replace
        path: /spec/template/spec/securityContext/readOnlyRootFilesystem
        value: false

# Remove External Secrets in dev (use static secrets instead)
patchesStrategicMerge:
  - |-
    apiVersion: v1
    kind: Secret
    metadata:
      name: gl-010-secrets-dev
    $patch: replace
