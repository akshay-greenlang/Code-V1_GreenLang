# GL-010 EMISSIONWATCH EmissionsComplianceAgent - Secrets Management
# Uses External Secrets Operator for secure secret injection from AWS Secrets Manager
# Includes EPA CDX, EU ETS registry, and database credentials

---
# ExternalSecret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-database-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        database_url: "postgresql://{{ .database_user }}:{{ .database_password }}@{{ .database_host }}:{{ .database_port }}/{{ .database_name }}"
        database_host: "{{ .database_host }}"
        database_port: "{{ .database_port }}"
        database_name: "{{ .database_name }}"
        database_user: "{{ .database_user }}"
        database_password: "{{ .database_password }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/database

---
# ExternalSecret for TimescaleDB credentials (time-series emissions data)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-timescale-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        timescale_url: "postgresql://{{ .timescale_user }}:{{ .timescale_password }}@{{ .timescale_host }}:{{ .timescale_port }}/{{ .timescale_database }}"
        timescale_host: "{{ .timescale_host }}"
        timescale_port: "{{ .timescale_port }}"
        timescale_database: "{{ .timescale_database }}"
        timescale_user: "{{ .timescale_user }}"
        timescale_password: "{{ .timescale_password }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/timescaledb

---
# ExternalSecret for Redis credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-redis-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        redis_url: "redis://:{{ .redis_password }}@{{ .redis_host }}:{{ .redis_port }}/0"
        redis_host: "{{ .redis_host }}"
        redis_port: "{{ .redis_port }}"
        redis_password: "{{ .redis_password }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/redis

---
# ExternalSecret for API keys and JWT secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-api-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        api_key: "{{ .api_key }}"
        jwt_secret: "{{ .jwt_secret }}"
        encryption_key: "{{ .encryption_key }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/api

---
# ExternalSecret for EPA CDX credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-epa-cdx-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        epa_cdx_username: "{{ .epa_cdx_username }}"
        epa_cdx_password: "{{ .epa_cdx_password }}"
        epa_cdx_api_key: "{{ .epa_cdx_api_key }}"
        epa_cdx_program_id: "{{ .epa_cdx_program_id }}"
        epa_naas_token: "{{ .epa_naas_token }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/epa-cdx

---
# ExternalSecret for EU ETS registry credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-eu-ets-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        eu_ets_api_key: "{{ .eu_ets_api_key }}"
        eu_ets_client_id: "{{ .eu_ets_client_id }}"
        eu_ets_client_secret: "{{ .eu_ets_client_secret }}"
        eu_ets_operator_id: "{{ .eu_ets_operator_id }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/eu-ets

---
# ExternalSecret for Sentry DSN and monitoring
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-monitoring-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-secrets
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        sentry_dsn: "{{ .sentry_dsn }}"
        pagerduty_api_key: "{{ .pagerduty_api_key }}"
        slack_webhook_url: "{{ .slack_webhook_url }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/monitoring

---
# ExternalSecret for report signing certificate
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gl-010-signing-secret
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
spec:
  refreshInterval: 24h  # Certificates change less frequently
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: gl-010-signing-cert
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        signing_certificate: "{{ .signing_certificate }}"
        signing_private_key: "{{ .signing_private_key }}"
        signing_certificate_chain: "{{ .signing_certificate_chain }}"
  dataFrom:
    - extract:
        key: greenlang/gl-010/signing-certificate

---
# Fallback Secret for local development (DO NOT USE IN PRODUCTION)
# This should be overridden by External Secrets in production
apiVersion: v1
kind: Secret
metadata:
  name: gl-010-secrets-dev
  namespace: greenlang
  labels:
    app: gl-010-emissionwatch
    agent: "GL-010"
    environment: "development"
  annotations:
    description: "Development secrets - DO NOT USE IN PRODUCTION"
type: Opaque
stringData:
  # Database (local development)
  database_url: "postgresql://greenlang:greenlang@localhost:5432/gl010_emissionwatch"
  database_host: "localhost"
  database_port: "5432"
  database_name: "gl010_emissionwatch"
  database_user: "greenlang"
  database_password: "greenlang"

  # TimescaleDB (local development)
  timescale_url: "postgresql://greenlang:greenlang@localhost:5433/gl010_timescale"
  timescale_host: "localhost"
  timescale_port: "5433"
  timescale_database: "gl010_timescale"
  timescale_user: "greenlang"
  timescale_password: "greenlang"

  # Redis (local development)
  redis_url: "redis://localhost:6379/0"
  redis_host: "localhost"
  redis_port: "6379"
  redis_password: ""

  # API Keys (local development)
  api_key: "dev-api-key-change-in-production"
  jwt_secret: "dev-jwt-secret-change-in-production-must-be-256-bits"
  encryption_key: "dev-encryption-key-change-in-production"

  # EPA CDX (development - use sandbox environment)
  epa_cdx_username: "dev-epa-cdx-user"
  epa_cdx_password: "dev-epa-cdx-password"
  epa_cdx_api_key: "dev-epa-cdx-api-key"
  epa_cdx_program_id: "DEV-PROGRAM"
  epa_naas_token: "dev-naas-token"

  # EU ETS (development - use sandbox environment)
  eu_ets_api_key: "dev-eu-ets-api-key"
  eu_ets_client_id: "dev-eu-ets-client-id"
  eu_ets_client_secret: "dev-eu-ets-client-secret"
  eu_ets_operator_id: "DEV-OPERATOR"

  # Monitoring (local development)
  sentry_dsn: ""
  pagerduty_api_key: ""
  slack_webhook_url: ""
