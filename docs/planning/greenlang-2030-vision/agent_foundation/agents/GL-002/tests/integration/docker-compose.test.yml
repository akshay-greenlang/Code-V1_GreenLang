version: '3.8'

services:
  # Mock OPC UA Server for SCADA simulation
  mock-opcua:
    image: python:3.10-slim
    container_name: gl002-mock-opcua
    working_dir: /app
    volumes:
      - ./mock_servers.py:/app/mock_servers.py
      - ./requirements-test.txt:/app/requirements.txt
    command: >
      sh -c "pip install -q -r requirements.txt &&
             python -c 'import asyncio; from mock_servers import MockOPCUAServer;
             async def run():
               server = MockOPCUAServer(host=\"0.0.0.0\", port=4840);
               await server.start();
               await asyncio.sleep(3600);
             asyncio.run(run())'"
    ports:
      - "4840:4840"
    networks:
      - gl002-test-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 4840)); s.close()"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Mock Modbus Server for Fuel & Emissions
  mock-modbus:
    image: python:3.10-slim
    container_name: gl002-mock-modbus
    working_dir: /app
    volumes:
      - ./mock_servers.py:/app/mock_servers.py
      - ./requirements-test.txt:/app/requirements.txt
    command: >
      sh -c "pip install -q -r requirements.txt &&
             python -c 'import asyncio; from mock_servers import MockModbusServer;
             async def run():
               server = MockModbusServer(host=\"0.0.0.0\", port=502);
               await server.start();
               await asyncio.sleep(3600);
             asyncio.run(run())'"
    ports:
      - "502:502"
    networks:
      - gl002-test-network

  # Mock SAP RFC Server
  mock-sap:
    image: python:3.10-slim
    container_name: gl002-mock-sap
    working_dir: /app
    volumes:
      - ./mock_servers.py:/app/mock_servers.py
      - ./requirements-test.txt:/app/requirements.txt
    command: >
      sh -c "pip install -q -r requirements.txt &&
             python -m aiohttp.web -H 0.0.0.0 -P 3300 mock_servers:MockSAPServer.app"
    ports:
      - "3300:3300"
    networks:
      - gl002-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3300/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Mock Oracle REST API
  mock-oracle-api:
    image: python:3.10-slim
    container_name: gl002-mock-oracle
    working_dir: /app
    volumes:
      - ./mock_servers.py:/app/mock_servers.py
      - ./requirements-test.txt:/app/requirements.txt
    command: >
      sh -c "pip install -q -r requirements.txt && python mock_servers.py"
    ports:
      - "8080:8080"
    networks:
      - gl002-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/materials"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Mock MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: gl002-mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - gl002-test-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "test", "-E", "-i", "healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 3

  # PostgreSQL for test data persistence
  postgres:
    image: postgres:15-alpine
    container_name: gl002-test-db
    environment:
      POSTGRES_DB: gl002_test
      POSTGRES_USER: gl002_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - gl002-test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gl002_user -d gl002_test"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis for caching and state management
  redis:
    image: redis:7-alpine
    container_name: gl002-test-redis
    ports:
      - "6379:6379"
    networks:
      - gl002-test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Test runner container
  integration-tests:
    image: python:3.10-slim
    container_name: gl002-integration-tests
    working_dir: /app
    volumes:
      - ../../:/app
    environment:
      - SCADA_HOST=mock-opcua
      - SCADA_PORT=4840
      - MODBUS_HOST=mock-modbus
      - MODBUS_PORT=502
      - SAP_HOST=mock-sap
      - SAP_PORT=3300
      - ORACLE_HOST=mock-oracle-api
      - ORACLE_PORT=8080
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONPATH=/app
    command: >
      sh -c "pip install -q -r requirements.txt &&
             pip install -q -r tests/integration/requirements-test.txt &&
             pytest tests/integration/ -v --tb=short --junitxml=/app/test-results/integration-results.xml --cov=integrations --cov-report=xml:/app/test-results/coverage.xml"
    depends_on:
      mock-opcua:
        condition: service_healthy
      mock-modbus:
        condition: service_started
      mock-sap:
        condition: service_healthy
      mock-oracle-api:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gl002-test-network
    volumes:
      - ./test-results:/app/test-results

networks:
  gl002-test-network:
    driver: bridge

volumes:
  postgres-data:
