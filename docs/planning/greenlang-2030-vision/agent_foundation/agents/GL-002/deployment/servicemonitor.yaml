---
# ServiceMonitor for GL-002 BoilerEfficiencyOptimizer
# Enables Prometheus Operator to scrape metrics automatically

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: gl-002-boiler-optimizer
  namespace: greenlang
  labels:
    app: gl-002-boiler-optimizer
    release: prometheus
    prometheus: kube-prometheus
spec:
  # Select the service to monitor
  selector:
    matchLabels:
      app: gl-002-boiler-optimizer

  # Namespace to discover services in
  namespaceSelector:
    matchNames:
      - greenlang

  # Endpoints to scrape
  endpoints:
    - port: metrics  # Must match service port name
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      scheme: http

      # Relabeling configuration
      relabelings:
        # Add namespace label
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
          action: replace

        # Add pod name label
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
          action: replace

        # Add service name label
        - sourceLabels: [__meta_kubernetes_service_name]
          targetLabel: service
          action: replace

        # Add container name label
        - sourceLabels: [__meta_kubernetes_pod_container_name]
          targetLabel: container
          action: replace

        # Add node name label
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
          action: replace

        # Add pod IP
        - sourceLabels: [__meta_kubernetes_pod_ip]
          targetLabel: pod_ip
          action: replace

      # Metric relabeling (applied after scraping)
      metricRelabelings:
        # Drop high-cardinality metrics if needed
        - sourceLabels: [__name__]
          regex: 'go_.*'
          action: drop

        # Normalize metric names
        - sourceLabels: [__name__]
          targetLabel: __name__
          regex: 'gl_002_(.*)'
          replacement: 'gl_002_${1}'
          action: replace

---
# PodMonitor for direct pod scraping (alternative to ServiceMonitor)
# Useful if you want to scrape pods directly without a service

apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: gl-002-boiler-optimizer-pods
  namespace: greenlang
  labels:
    app: gl-002-boiler-optimizer
    release: prometheus
spec:
  selector:
    matchLabels:
      app: gl-002-boiler-optimizer

  namespaceSelector:
    matchNames:
      - greenlang

  podMetricsEndpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# Service for metrics endpoint
# Required for ServiceMonitor to work

apiVersion: v1
kind: Service
metadata:
  name: gl-002-metrics
  namespace: greenlang
  labels:
    app: gl-002-boiler-optimizer
    service: metrics
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  selector:
    app: gl-002-boiler-optimizer
  ports:
    - name: metrics
      port: 8000
      targetPort: 8000
      protocol: TCP
  sessionAffinity: None

---
# PrometheusRule for alerting (included here for completeness)
# This references the alerts defined in prometheus_rules.yaml

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gl-002-alerts
  namespace: greenlang
  labels:
    app: gl-002-boiler-optimizer
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: gl-002-critical
      interval: 30s
      rules:
        - alert: GL002Down
          expr: up{job="gl-002-boiler-optimizer"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "GL-002 is down"
            description: "GL-002 pod {{ $labels.pod }} is down"

---
# ConfigMap for Prometheus scrape configuration (optional)
# Use this if you're not using Prometheus Operator

apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-002-prometheus-config
  namespace: greenlang
data:
  prometheus.yml: |
    global:
      scrape_interval: 30s
      evaluation_interval: 30s
      external_labels:
        cluster: greenlang-production
        environment: production

    scrape_configs:
      - job_name: 'gl-002-boiler-optimizer'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - greenlang

        relabel_configs:
          # Only scrape pods with app=gl-002-boiler-optimizer label
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: gl-002-boiler-optimizer

          # Set scrape port to 8000
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: "8000"

          # Add pod name
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
            action: replace

          # Add namespace
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
            action: replace

          # Add node
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node
            action: replace

        metric_relabel_configs:
          # Drop unwanted metrics to reduce storage
          - source_labels: [__name__]
            regex: 'process_.*'
            action: drop

---
# Grafana Dashboard ConfigMap
# Auto-import dashboards into Grafana

apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-002-grafana-dashboards
  namespace: greenlang
  labels:
    grafana_dashboard: "1"
data:
  gl-002-executive.json: |
    # Content from executive_dashboard.json would go here
    # Or reference it as a file in the deployment

  gl-002-operations.json: |
    # Content from operations_dashboard.json would go here

  gl-002-agent.json: |
    # Content from agent_dashboard.json would go here

  gl-002-quality.json: |
    # Content from quality_dashboard.json would go here
