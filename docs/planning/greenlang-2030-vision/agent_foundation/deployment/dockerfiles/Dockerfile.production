# Production-Optimized Dockerfile for GreenLang AI Agents
# Minimal size, maximum security, optimized for performance

# Stage 1: Build stage with full toolchain
FROM python:3.10-slim as builder

# Install only essential build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc6-dev \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Create and activate virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy and install requirements
COPY requirements/production.txt /tmp/requirements.txt
RUN pip install --no-cache-dir --upgrade pip==23.3.2 && \
    pip install --no-cache-dir -r /tmp/requirements.txt

# Stage 2: Compile Python files for optimization
FROM builder as compiler

COPY src /app/src
RUN python -m compileall -b /app/src && \
    find /app/src -name "*.py" -delete

# Stage 3: Security scanner
FROM aquasec/trivy:latest as scanner

COPY --from=compiler /app /app
RUN trivy filesystem --no-progress --severity HIGH,CRITICAL --exit-code 1 /app

# Stage 4: Final minimal runtime
FROM gcr.io/distroless/python3-debian12:nonroot

# Copy Python runtime and dependencies
COPY --from=builder /opt/venv /opt/venv
COPY --from=compiler /app /app

# Set environment variables
ENV PATH="/opt/venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONHASHSEED=random \
    PYTHONIOENCODING=utf-8 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PRODUCTION=true \
    LOG_LEVEL=INFO \
    MAX_WORKERS=4 \
    WORKER_TIMEOUT=60 \
    GRACEFUL_TIMEOUT=30

# Use non-root user (distroless default)
USER nonroot

# Working directory
WORKDIR /app

# Expose only necessary port
EXPOSE 8080

# No shell, no package manager, minimal attack surface
ENTRYPOINT ["python", "-m", "greenlang.agent.production_server"]

# Metadata
LABEL maintainer="GreenLang DevOps" \
      version="1.0.0-prod" \
      description="Production-optimized GreenLang AI Agent" \
      security.scan="passed" \
      base.image="distroless" \
      size.optimized="true"