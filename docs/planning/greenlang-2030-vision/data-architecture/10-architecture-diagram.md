# GreenLang Data Architecture - System Diagrams

## 1. High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           EXTERNAL DATA SOURCES                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐ │
│  │   SAP    │   │  Oracle  │   │ Workday  │   │Dynamics  │   │ NetSuite │ │
│  │   ERP    │   │   ERP    │   │   HCM    │   │   365    │   │   ERP    │ │
│  └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘ │
│       │              │              │              │              │         │
│       │ OData/RFC    │ REST API     │ REST/SOAP    │ Web API      │ REST    │
└───────┼──────────────┼──────────────┼──────────────┼──────────────┼─────────┘
        │              │              │              │              │
        └──────────────┴──────────────┴──────────────┴──────────────┘
                                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DATA INTEGRATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                      ERP CONNECTORS                                     │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │ │
│  │  │ SAP Connector│  │Oracle Connect│  │Workday Connect│  + 5 more      │ │
│  │  │ - OAuth2 Auth│  │ - REST Auth  │  │ - SOAP/REST  │                │ │
│  │  │ - Retry Logic│  │ - Pagination │  │ - Custom API │                │ │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                │ │
│  └─────────┼──────────────────┼──────────────────┼────────────────────────┘ │
│            │                  │                  │                           │
│  ┌─────────▼──────────────────▼──────────────────▼─────────────────────┐   │
│  │                    APACHE KAFKA (50+ Topics)                         │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │ emissions  │  │supply-chain│  │   csrd     │  │    iot     │    │   │
│  │  │   topics   │  │   topics   │  │  topics    │  │  topics    │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    │   │
│  │  1M+ events/second │ Exactly-once semantics │ Schema Registry      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────┬───────────────────────────────────────────────┘
                                │
┌───────────────────────────────▼───────────────────────────────────────────────┐
│                          PROCESSING LAYER                                      │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                    APACHE AIRFLOW (100+ DAGs)                           │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │  │
│  │  │  Emissions   │  │Supply Chain  │  │     CSRD     │  + 10 more      │  │
│  │  │   Pipeline   │  │  Pipeline    │  │   Pipeline   │                 │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                 │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                    SPARK / DATABRICKS (10TB+ daily)                     │  │
│  │  - Data transformations  - Feature engineering  - ML training           │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                      KAFKA STREAMS (Real-time)                          │  │
│  │  - Emissions aggregation  - Anomaly detection  - KPI calculation        │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└────────────────────────────────┬────────────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼────────────────────────────────────────────────┐
│                          STORAGE LAYER                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │              POSTGRESQL (200+ Tables, TimescaleDB)                       │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │   │
│  │  │ emissions  │  │supply_chain│  │    csrd    │  │   audit    │       │   │
│  │  │   schema   │  │   schema   │  │  schema    │  │  schema    │ + 6   │   │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │   │
│  │  50TB+ │ Partitioned │ Replicated │ Continuous Aggregates              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │              MONGODB (100+ Collections, Sharded)                         │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │   │
│  │  │ documents  │  │ analytics  │  │    iot     │  │ workflows  │       │   │
│  │  │    db      │  │     db     │  │    db      │  │    db      │ + 3   │   │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │   │
│  │  10M+ documents │ Change Streams │ Time-series Collections              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │              REDIS CLUSTER (6 nodes, 100K+ ops/sec)                      │   │
│  │  - Session cache  - API cache  - Rate limiting  - Leaderboards           │   │
│  │  <1ms latency │ 95% hit rate │ Distributed locks                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │           ELASTICSEARCH (8 nodes, 10TB+ indexed)                         │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │   │
│  │  │ emissions  │  │    csrd    │  │ suppliers  │  │audit_logs  │       │   │
│  │  │   index    │  │   docs     │  │   index    │  │   index    │       │   │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │   │
│  │  Full-text search │ ML anomaly detection │ Real-time aggregations       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                  DATA LAKE (Multi-PB, Delta Lake)                        │   │
│  │  ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐              │   │
│  │  │  Raw   │ --> │ Bronze │ --> │ Silver │ --> │  Gold  │              │   │
│  │  │  Zone  │     │  Zone  │     │  Zone  │     │  Zone  │              │   │
│  │  └────────┘     └────────┘     └────────┘     └────────┘              │   │
│  │  S3/Azure/GCS │ Parquet/Delta │ Partitioned │ Lifecycle Management     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
┌─────────────────────────────────────▼─────────────────────────────────────────┐
│                          APPLICATION LAYER                                     │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                        API GATEWAY (Kong/Nginx)                          │  │
│  │  - Authentication  - Rate limiting  - Load balancing  - SSL/TLS         │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │    CSRD      │  │  Emissions   │  │Supply Chain  │  │  Analytics   │    │
│  │   Backend    │  │   Backend    │  │   Backend    │  │   Backend    │    │
│  │  (FastAPI)   │  │  (FastAPI)   │  │  (FastAPI)   │  │  (FastAPI)   │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                        FRONTEND (React/Next.js)                          │  │
│  │  - CSRD Reports  - Emissions Dashboard  - Supply Chain  - Analytics     │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          IOT INGESTION                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐                │
│  │Air Quality│   │  Energy  │   │Emissions │   │ Vehicle  │  + 6 more      │
│  │  Sensors  │   │  Meters  │   │ Sensors  │   │ Trackers │                │
│  └─────┬────┘   └─────┬────┘   └─────┬────┘   └─────┬────┘                │
│        │              │              │              │                        │
│        └──────────────┴──────────────┴──────────────┘                        │
│                       │ MQTT/TLS                                             │
│         ┌─────────────▼─────────────────────────┐                           │
│         │    MQTT Broker (100K+ devices)        │                           │
│         │    - TLS encryption                    │                           │
│         │    - QoS levels                        │                           │
│         │    - Device authentication             │                           │
│         └─────────────┬─────────────────────────┘                           │
│                       │                                                       │
│         ┌─────────────▼─────────────────────────┐                           │
│         │  IoT Ingestion Pipeline (Python)      │                           │
│         │  - Message buffering (100K buffer)    │                           │
│         │  - Anomaly detection                  │                           │
│         │  - Alert generation                   │                           │
│         │  - Data enrichment                    │                           │
│         └─────────────┬─────────────────────────┘                           │
│                       │                                                       │
│         ┌─────────────▼─────────────────────────┐                           │
│         │  InfluxDB (Time-series DB)            │                           │
│         │  - 1M+ writes/second                  │                           │
│         │  - Continuous queries                 │                           │
│         │  - Retention policies                 │                           │
│         └───────────────────────────────────────┘                           │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## 2. Data Flow Diagram

```
┌─────────────┐
│  ERP Data   │
│ (SAP, etc)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Extraction  │ ──────► Error Log
│  Connector  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Kafka     │
│   Topic     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Validation  │ ──────► Data Quality Report
│   Stage     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│Transformation│
│  (Airflow)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Storage    │ ──────► Audit Log
│ PostgreSQL  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Cache     │
│   (Redis)   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│     API     │
│  Response   │
└─────────────┘
```

## 3. ERP Integration Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                    ERP Systems                                │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐     │
│  │   SAP   │   │ Oracle  │   │ Workday │   │Dynamics │     │
│  └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘     │
│       │             │             │             │            │
└───────┼─────────────┼─────────────┼─────────────┼────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌──────────────────────────────────────────────────────────────┐
│              Unified ERP Connector Layer                      │
│                                                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │            Connection Management                        │  │
│  │  - OAuth2/API Key Authentication                       │  │
│  │  - Connection pooling                                  │  │
│  │  - Retry logic with exponential backoff               │  │
│  │  - Circuit breaker pattern                            │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │         Data Extraction & Normalization                 │  │
│  │  - Purchase Orders → Standard PO Format                │  │
│  │  - Suppliers → Standard Supplier Format                │  │
│  │  - Invoices → Standard Invoice Format                  │  │
│  │  - GL Entries → Standard Accounting Format             │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │              Error Handling & Logging                   │  │
│  │  - Error classification                                │  │
│  │  - Automatic retry for transient errors               │  │
│  │  - Dead letter queue for failed records               │  │
│  │  - Detailed audit trail                               │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────┬───────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    Kafka Topics                               │
│  - integration.sap                                            │
│  - integration.oracle                                         │
│  - integration.workday                                        │
│  - integration.errors                                         │
└──────────────────────────────────────────────────────────────┘
```

## 4. IoT Data Flow Architecture

```
                         ┌─────────────┐
                         │ IoT Devices │
                         │  (100K+)    │
                         └──────┬──────┘
                                │ MQTT
                                ▼
                    ┌──────────────────────┐
                    │   MQTT Broker        │
                    │   - Topic routing    │
                    │   - QoS management   │
                    └──────────┬───────────┘
                               │
                               ▼
              ┌────────────────────────────────┐
              │   Ingestion Pipeline           │
              │   - Message buffering          │
              │   - Data validation            │
              │   - Anomaly detection          │
              │   ┌──────────────────────────┐ │
              │   │ Processing Rules:        │ │
              │   │ - Air Quality → AQI calc│ │
              │   │ - Energy → Power Factor │ │
              │   │ - Emissions → CO2e calc │ │
              │   └──────────────────────────┘ │
              └─────────┬──────────────────────┘
                        │
          ┌─────────────┼─────────────┐
          │             │             │
          ▼             ▼             ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   InfluxDB   │ │  PostgreSQL  │ │    Kafka     │
│ (Time-series)│ │  (Metadata)  │ │  (Alerts)    │
└──────────────┘ └──────────────┘ └──────────────┘
```

## 5. Caching Strategy

```
                    ┌─────────────┐
                    │   Request   │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ Check Redis │
                    └──────┬──────┘
                           │
                  ┌────────┴────────┐
                  │                 │
            Cache Hit          Cache Miss
                  │                 │
                  ▼                 ▼
          ┌─────────────┐   ┌─────────────┐
          │Return Cached│   │Query Database│
          │    Data     │   │              │
          └─────────────┘   └──────┬──────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │  Store in   │
                            │   Redis     │
                            │  (with TTL) │
                            └──────┬──────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │   Return    │
                            │    Data     │
                            └─────────────┘
```

## 6. Disaster Recovery Architecture

```
Primary Region (us-east-1)          Secondary Region (us-west-2)
┌──────────────────────────┐       ┌──────────────────────────┐
│                          │       │                          │
│  ┌────────────────────┐  │       │  ┌────────────────────┐  │
│  │   PostgreSQL       │  │       │  │   PostgreSQL       │  │
│  │   (Primary)        │  │ Repl. │  │   (Standby)        │  │
│  │                    │◄─┼───────┼──┤                    │  │
│  └────────────────────┘  │       │  └────────────────────┘  │
│                          │       │                          │
│  ┌────────────────────┐  │       │  ┌────────────────────┐  │
│  │   MongoDB          │  │       │  │   MongoDB          │  │
│  │   (Primary RS)     │  │ Repl. │  │   (Secondary RS)   │  │
│  │                    │◄─┼───────┼──┤                    │  │
│  └────────────────────┘  │       │  └────────────────────┘  │
│                          │       │                          │
│  ┌────────────────────┐  │       │  ┌────────────────────┐  │
│  │   S3 Data Lake     │  │       │  │   S3 Data Lake     │  │
│  │   (Primary)        │  │ Repl. │  │   (Replica)        │  │
│  │                    │◄─┼───────┼──┤                    │  │
│  └────────────────────┘  │       │  └────────────────────┘  │
│                          │       │                          │
└──────────────────────────┘       └──────────────────────────┘

RPO: 1 hour  │  RTO: 4 hours
```

## 7. Data Lake Zones

```
┌────────────────────────────────────────────────────────────┐
│  RAW ZONE                                                   │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐          │
│  │  SAP   │  │ Oracle │  │  IoT   │  │External│          │
│  │  Data  │  │  Data  │  │Telemetry│ │  Data  │          │
│  └────────┘  └────────┘  └────────┘  └────────┘          │
│  Format: JSON, CSV, Parquet | Retention: 7 years          │
└────────────────────┬───────────────────────────────────────┘
                     │ Cleanse & Validate
                     ▼
┌────────────────────────────────────────────────────────────┐
│  BRONZE ZONE (Delta Lake)                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐          │
│  │ Emissions  │  │Supply Chain│  │Sustainability│         │
│  │   Clean    │  │   Clean    │  │    Clean    │         │
│  └────────────┘  └────────────┘  └────────────┘          │
│  Quality checks applied | Retention: 3 years              │
└────────────────────┬───────────────────────────────────────┘
                     │ Conform & Enrich
                     ▼
┌────────────────────────────────────────────────────────────┐
│  SILVER ZONE (Delta Lake)                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐          │
│  │ Conformed  │  │ Enriched   │  │  Business  │          │
│  │  Emissions │  │  Supply    │  │   Logic    │          │
│  │            │  │   Chain    │  │  Applied   │          │
│  └────────────┘  └────────────┘  └────────────┘          │
│  Business rules applied | Retention: 2 years              │
└────────────────────┬───────────────────────────────────────┘
                     │ Aggregate & Optimize
                     ▼
┌────────────────────────────────────────────────────────────┐
│  GOLD ZONE (Parquet)                                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐          │
│  │   CSRD     │  │ Executive  │  │     ML     │          │
│  │  Reports   │  │ Dashboard  │  │  Features  │          │
│  └────────────┘  └────────────┘  └────────────┘          │
│  Optimized for consumption | Retention: 1 year            │
└────────────────────────────────────────────────────────────┘
```

## 8. Security Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      External Users                          │
└─────────────────────┬────────────────────────────────────────┘
                      │ HTTPS/TLS 1.3
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   WAF / DDoS Protection                      │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (Kong)                        │
│  - Rate limiting (per API key)                              │
│  - Authentication (OAuth2/JWT)                              │
│  - Request validation                                       │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   Load Balancer                              │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                Application Servers (VPC)                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           Network Segmentation                       │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │   Public   │  │  Private   │  │  Database  │    │   │
│  │  │   Subnet   │  │   Subnet   │  │   Subnet   │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│               Database Layer (Private)                       │
│  - Encryption at rest (AES-256)                             │
│  - Encryption in transit (TLS)                              │
│  - Network isolation                                        │
│  - IAM authentication                                       │
│  - Audit logging enabled                                    │
└─────────────────────────────────────────────────────────────┘

Security Monitoring:
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   CloudWatch│  │  GuardDuty  │  │Security Hub │
│    Logs     │  │   Alerts    │  │  Dashboard  │
└─────────────┘  └─────────────┘  └─────────────┘
```

---

These diagrams provide a visual representation of the complete GreenLang data architecture, showing data flows, system interactions, and security layers.