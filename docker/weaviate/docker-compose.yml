version: '3.7'

services:
  weaviate:
    image: semitechnologies/weaviate:1.25.5
    container_name: greenlang-weaviate
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50051:50051"  # gRPC port
    environment:
      # Query settings
      QUERY_DEFAULTS_LIMIT: '25'
      QUERY_MAXIMUM_RESULTS: '10000'

      # Authentication (anonymous for dev/CI)
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      AUTHENTICATION_APIKEY_ENABLED: 'false'

      # Persistence
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'

      # Vectorizer (we supply our own embeddings)
      DEFAULT_VECTORIZER_MODULE: 'none'
      ENABLE_MODULES: ''

      # Cluster settings
      CLUSTER_HOSTNAME: 'node1'
      CLUSTER_GOSSIP_BIND_PORT: '7100'
      CLUSTER_DATA_BIND_PORT: '7101'

      # Resource limits
      GOMAXPROCS: '2'
      GOMEMLIMIT: '2GiB'

      # Logging
      LOG_LEVEL: 'info'
      LOG_FORMAT: 'json'
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - greenlang-network

volumes:
  weaviate_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./weaviate_data

networks:
  greenlang-network:
    driver: bridge
