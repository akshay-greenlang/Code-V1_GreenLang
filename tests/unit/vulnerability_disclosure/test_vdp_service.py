"""
Unit tests for VDP service.

Tests vulnerability submission handling, triage workflow,
researcher management, and reward processing.
"""

import pytest
from datetime import datetime, timedelta
from unittest.mock import AsyncMock, MagicMock, patch
from uuid import uuid4


class TestSubmissionHandling:
    """Test vulnerability submission handling."""

    @pytest.mark.asyncio
    async def test_create_submission(self, sample_submission):
        """Test creating a new submission."""
        # Mock VDP service
        mock_service = AsyncMock()
        mock_service.create_submission.return_value = sample_submission

        result = await mock_service.create_submission(sample_submission)

        assert result["submission_id"] is not None
        assert result["status"] == "new"

    @pytest.mark.asyncio
    async def test_get_submission(self, sample_submission):
        """Test retrieving a submission."""
        mock_service = AsyncMock()
        mock_service.get_submission.return_value = sample_submission

        result = await mock_service.get_submission(sample_submission["submission_id"])

        assert result["submission_id"] == sample_submission["submission_id"]

    @pytest.mark.asyncio
    async def test_list_submissions(self, sample_submission):
        """Test listing submissions."""
        mock_service = AsyncMock()
        mock_service.list_submissions.return_value = [sample_submission]

        result = await mock_service.list_submissions()

        assert len(result) == 1

    @pytest.mark.asyncio
    async def test_update_submission_status(self, sample_submission):
        """Test updating submission status."""
        mock_service = AsyncMock()
        sample_submission["status"] = "triaged"
        mock_service.update_submission.return_value = sample_submission

        result = await mock_service.update_submission(
            sample_submission["submission_id"],
            {"status": "triaged"}
        )

        assert result["status"] == "triaged"


class TestTriageWorkflow:
    """Test vulnerability triage workflow."""

    @pytest.mark.asyncio
    async def test_triage_submission(self, sample_submission):
        """Test triaging a submission."""
        mock_service = AsyncMock()
        mock_service.triage_submission.return_value = {
            **sample_submission,
            "status": "triaged",
            "triaged_by": "security-analyst",
            "triaged_at": datetime.utcnow().isoformat(),
        }

        result = await mock_service.triage_submission(
            sample_submission["submission_id"],
            severity="high",
            assignee="security-analyst"
        )

        assert result["status"] == "triaged"

    @pytest.mark.asyncio
    async def test_validate_submission(self, sample_submission):
        """Test validating a submission."""
        mock_service = AsyncMock()
        mock_service.validate_submission.return_value = {
            **sample_submission,
            "status": "validated",
            "validated": True,
        }

        result = await mock_service.validate_submission(
            sample_submission["submission_id"],
            validated=True,
            notes="Confirmed SQL injection vulnerability"
        )

        assert result["validated"] is True

    @pytest.mark.asyncio
    async def test_reject_duplicate(self, sample_submission):
        """Test rejecting duplicate submission."""
        mock_service = AsyncMock()
        mock_service.reject_submission.return_value = {
            **sample_submission,
            "status": "rejected",
            "rejection_reason": "duplicate",
        }

        result = await mock_service.reject_submission(
            sample_submission["submission_id"],
            reason="duplicate",
            original_submission_id=str(uuid4())
        )

        assert result["status"] == "rejected"


class TestResearcherManagement:
    """Test researcher management."""

    @pytest.mark.asyncio
    async def test_get_researcher(self, sample_researcher):
        """Test getting researcher profile."""
        mock_service = AsyncMock()
        mock_service.get_researcher.return_value = sample_researcher

        result = await mock_service.get_researcher(sample_researcher["researcher_id"])

        assert result["researcher_id"] == sample_researcher["researcher_id"]

    @pytest.mark.asyncio
    async def test_update_researcher_reputation(self, sample_researcher):
        """Test updating researcher reputation."""
        mock_service = AsyncMock()
        sample_researcher["reputation_score"] = 90
        mock_service.update_researcher.return_value = sample_researcher

        result = await mock_service.update_researcher(
            sample_researcher["researcher_id"],
            reputation_delta=5
        )

        assert result["reputation_score"] == 90


class TestRewardProcessing:
    """Test reward processing."""

    @pytest.mark.asyncio
    async def test_calculate_reward(self, sample_submission, vdp_config):
        """Test calculating reward amount."""
        mock_service = AsyncMock()
        mock_service.calculate_reward.return_value = {
            "amount": 3500.00,
            "currency": "USD",
            "severity": "high",
        }

        result = await mock_service.calculate_reward(
            sample_submission["submission_id"]
        )

        assert result["amount"] >= vdp_config["reward_ranges"]["high"]["min"]
        assert result["amount"] <= vdp_config["reward_ranges"]["high"]["max"]

    @pytest.mark.asyncio
    async def test_process_payment(self, sample_submission, sample_researcher):
        """Test processing reward payment."""
        mock_service = AsyncMock()
        mock_service.process_payment.return_value = {
            "payment_id": str(uuid4()),
            "amount": 3500.00,
            "status": "completed",
            "researcher_id": sample_researcher["researcher_id"],
        }

        result = await mock_service.process_payment(
            sample_submission["submission_id"],
            amount=3500.00
        )

        assert result["status"] == "completed"


class TestSLAMonitoring:
    """Test SLA monitoring."""

    @pytest.mark.asyncio
    async def test_check_sla_status(self, sample_submission, vdp_config):
        """Test checking SLA status."""
        mock_service = AsyncMock()
        mock_service.check_sla_status.return_value = {
            "submission_id": sample_submission["submission_id"],
            "sla_hours": 24,
            "elapsed_hours": 12,
            "sla_met": True,
        }

        result = await mock_service.check_sla_status(
            sample_submission["submission_id"]
        )

        assert result["sla_met"] is True

    @pytest.mark.asyncio
    async def test_get_sla_breaches(self):
        """Test getting SLA breaches."""
        mock_service = AsyncMock()
        mock_service.get_sla_breaches.return_value = []

        result = await mock_service.get_sla_breaches()

        assert isinstance(result, list)
