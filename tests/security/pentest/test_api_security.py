# -*- coding: utf-8 -*-
"""
API Security Penetration Testing Module

Comprehensive API security testing including:
- REST API security
- GraphQL security
- API rate limiting
- Input validation
- Output encoding
- Mass assignment
- API key security
"""

import pytest
import asyncio
from typing import List, Dict, Any


class APISecurityTester:
    """API security testing framework."""

    def __init__(self, api_client=None):
        self.api_client = api_client

    async def test_rate_limiting(self, endpoint: str) -> Dict[str, Any]:
        """Test API rate limiting."""
        requests_sent = 0
        max_requests = 200

        for i in range(max_requests):
            response = await self._send_request(endpoint)
            requests_sent += 1

            if response.get("status_code") == 429:
                return {
                    "vulnerable": False,
                    "rate_limited_after": requests_sent
                }

        return {
            "vulnerable": True,
            "evidence": f"Sent {requests_sent} requests without rate limiting"
        }

    async def test_graphql_introspection(self) -> Dict[str, Any]:
        """Test if GraphQL introspection is disabled in production."""
        introspection_query = """
        {
            __schema {
                types {
                    name
                }
            }
        }
        """

        response = await self._send_graphql_query(introspection_query)

        if response.get("status_code") == 200:
            return {"vulnerable": True, "evidence": "Introspection enabled"}

        return {"vulnerable": False}

    async def test_graphql_depth_limiting(self) -> Dict[str, Any]:
        """Test GraphQL query depth limiting."""
        deep_query = self._generate_deep_graphql_query(depth=50)

        response = await self._send_graphql_query(deep_query)

        if response.get("status_code") == 200:
            return {"vulnerable": True, "evidence": "No depth limiting"}

        return {"vulnerable": False}

    async def test_mass_assignment(self) -> Dict[str, Any]:
        """Test mass assignment vulnerabilities."""
        # Try to set admin flag via mass assignment
        response = await self._send_request(
            "/api/v1/users/profile",
            method="PUT",
            json_data={
                "name": "Test User",
                "is_admin": True,  # Should not be assignable
                "role": "admin",
            }
        )

        # Check if admin flag was set
        profile = await self._send_request("/api/v1/users/profile")

        if profile.get("data", {}).get("is_admin"):
            return {"vulnerable": True, "evidence": "Mass assignment possible"}

        return {"vulnerable": False}

    async def test_excessive_data_exposure(self) -> Dict[str, Any]:
        """Test for excessive data exposure in API responses."""
        response = await self._send_request("/api/v1/users/list")

        if response.get("status_code") == 200:
            users = response.get("data", [])

            if users:
                user = users[0]
                sensitive_fields = ["password", "password_hash", "api_key", "secret"]

                for field in sensitive_fields:
                    if field in user:
                        return {
                            "vulnerable": True,
                            "evidence": f"Sensitive field exposed: {field}"
                        }

        return {"vulnerable": False}

    async def _send_request(
        self,
        endpoint: str,
        method: str = "GET",
        json_data: Dict = None
    ) -> Dict[str, Any]:
        """Send HTTP request."""
        if self.api_client:
            if method == "GET":
                return await self.api_client.get(endpoint)
            elif method == "PUT":
                return await self.api_client.put(endpoint, json=json_data)
        return {"status_code": 200, "data": {}}

    async def _send_graphql_query(self, query: str) -> Dict[str, Any]:
        """Send GraphQL query."""
        if self.api_client:
            return await self.api_client.post(
                "/graphql",
                json={"query": query}
            )
        return {"status_code": 400}

    def _generate_deep_graphql_query(self, depth: int) -> str:
        """Generate deeply nested GraphQL query."""
        query = "{ user { "
        for _ in range(depth):
            query += "profile { "
        query += "name"
        query += " }" * (depth + 1)
        return query


class TestAPISecurity:
    """API security test suite."""

    @pytest.fixture
    def api_tester(self):
        return APISecurityTester()

    @pytest.mark.asyncio
    @pytest.mark.security
    async def test_rate_limiting_enabled(self, api_tester):
        """Test rate limiting is enabled."""
        result = await api_tester.test_rate_limiting("/api/v1/packs")
        assert not result["vulnerable"], "No rate limiting!"

    @pytest.mark.asyncio
    @pytest.mark.security
    async def test_graphql_introspection_disabled(self, api_tester):
        """Test GraphQL introspection is disabled."""
        result = await api_tester.test_graphql_introspection()
        assert not result["vulnerable"], "GraphQL introspection enabled!"

    @pytest.mark.asyncio
    @pytest.mark.security
    async def test_no_mass_assignment(self, api_tester):
        """Test no mass assignment vulnerabilities."""
        result = await api_tester.test_mass_assignment()
        assert not result["vulnerable"], "Mass assignment vulnerability!"
