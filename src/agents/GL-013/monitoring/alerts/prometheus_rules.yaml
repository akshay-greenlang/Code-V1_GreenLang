# GL-013 PREDICTMAINT - Prometheus Alert Rules
# Predictive Maintenance Alerting Configuration
#
# This file defines Prometheus alerting rules for comprehensive
# predictive maintenance monitoring. Rules are organized by category
# and follow ISO standards for equipment monitoring.
#
# Standards Compliance:
#   - ISO 10816: Vibration severity limits
#   - ISO 13381: Prognostics thresholds
#   - IEC 60085: Temperature class limits
#
# Author: GL-MonitoringEngineer
# Version: 1.0.0
# Last Updated: 2024-12-01

groups:
  # ===========================================================================
  # EQUIPMENT HEALTH ALERTS
  # ===========================================================================
  - name: gl013_equipment_health
    interval: 30s
    rules:
      - alert: EquipmentHealthCritical
        expr: gl013_equipment_health_index < 25
        for: 5m
        labels:
          severity: critical
          category: equipment_health
          agent: gl013
          team: maintenance
          priority: P1
          impact: high
        annotations:
          summary: "Equipment {{ $labels.equipment_id }} health critical at {{ $value | printf \"%.1f\" }}%"
          description: "Health index for {{ $labels.equipment_id }} ({{ $labels.equipment_type }}) has fallen to {{ $value | printf \"%.1f\" }}%. Immediate inspection and maintenance required."
          action: "Initiate emergency maintenance procedure. Check vibration, temperature, and lubrication."
          runbook_url: "https://runbooks.greenlang.io/gl013/equipment-health-critical"

      - alert: EquipmentHealthWarning
        expr: gl013_equipment_health_index < 50 and gl013_equipment_health_index >= 25
        for: 15m
        labels:
          severity: warning
          category: equipment_health
          agent: gl013
          team: maintenance
          priority: P2
          impact: medium
        annotations:
          summary: "Equipment {{ $labels.equipment_id }} health degraded to {{ $value | printf \"%.1f\" }}%"
          description: "Health index for {{ $labels.equipment_id }} is degrading. Schedule maintenance within 7 days."
          action: "Review maintenance history and schedule inspection."
          runbook_url: "https://runbooks.greenlang.io/gl013/equipment-health-warning"

      - alert: EquipmentHealthDeclining
        expr: delta(gl013_equipment_health_index[1h]) < -5
        for: 30m
        labels:
          severity: high
          category: equipment_health
          agent: gl013
          team: maintenance
          priority: P2
          impact: medium
        annotations:
          summary: "Equipment {{ $labels.equipment_id }} health declining rapidly"
          description: "Health index dropped by {{ $value | printf \"%.1f\" }}% in the last hour. Investigate root cause."
          action: "Check recent operational changes and sensor readings."
          runbook_url: "https://runbooks.greenlang.io/gl013/equipment-health-declining"

  # ===========================================================================
  # FAILURE PREDICTION ALERTS
  # ===========================================================================
  - name: gl013_failure_prediction
    interval: 30s
    rules:
      - alert: RULCriticallyLow
        expr: gl013_equipment_rul_days < 7
        for: 5m
        labels:
          severity: critical
          category: failure_prediction
          agent: gl013
          team: maintenance
          priority: P1
          impact: high
        annotations:
          summary: "Equipment {{ $labels.equipment_id }} RUL critical: {{ $value | printf \"%.1f\" }} days remaining"
          description: "Predicted failure within {{ $value | printf \"%.1f\" }} days for {{ $labels.equipment_id }}. Immediate maintenance required."
          action: "Schedule emergency maintenance. Prepare spare parts and backup equipment."
          runbook_url: "https://runbooks.greenlang.io/gl013/rul-critical"

      - alert: RULLow
        expr: gl013_equipment_rul_days < 30 and gl013_equipment_rul_days >= 7
        for: 15m
        labels:
          severity: warning
          category: failure_prediction
          agent: gl013
          team: maintenance
          priority: P2
          impact: medium
        annotations:
          summary: "Equipment {{ $labels.equipment_id }} RUL low: {{ $value | printf \"%.1f\" }} days remaining"
          description: "Schedule maintenance for {{ $labels.equipment_id }} within {{ $value | printf \"%.0f\" }} days."
          action: "Plan maintenance window and order spare parts if needed."
          runbook_url: "https://runbooks.greenlang.io/gl013/rul-low"

      - alert: HighFailureProbability30Day
        expr: gl013_failure_probability_30d > 0.5
        for: 10m
        labels:
          severity: high
          category: failure_prediction
          agent: gl013
          team: maintenance
          priority: P1
          impact: high
        annotations:
          summary: "Equipment {{ $labels.equipment_id }} has {{ $value | printf \"%.0f\" }}% chance of failure in 30 days"
          description: "High failure probability detected. Recommend immediate inspection and preventive maintenance."
          action: "Review failure mode analysis and schedule appropriate maintenance."
          runbook_url: "https://runbooks.greenlang.io/gl013/high-failure-probability"

      - alert: FailureProbabilityIncreasing
        expr: delta(gl013_failure_probability_30d[24h]) > 0.1
        for: 1h
        labels:
          severity: warning
          category: failure_prediction
          agent: gl013
          team: maintenance
          priority: P2
          impact: medium
        annotations:
          summary: "Failure probability increasing for {{ $labels.equipment_id }}"
          description: "Failure probability increased by {{ $value | printf \"%.0f\" }}% in 24 hours."
          action: "Investigate degradation factors and adjust maintenance schedule."

      - alert: ReliabilityBelowThreshold
        expr: gl013_equipment_reliability < 0.7
        for: 30m
        labels:
          severity: warning
          category: failure_prediction
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "Reliability below threshold for {{ $labels.equipment_id }}: {{ $value | printf \"%.2f\" }}"
          description: "Current reliability R(t) = {{ $value | printf \"%.2f\" }} is below the 0.7 threshold."
          action: "Review reliability model and maintenance history."

  # ===========================================================================
  # VIBRATION ANALYSIS ALERTS (ISO 10816 COMPLIANT)
  # ===========================================================================
  - name: gl013_vibration
    interval: 15s
    rules:
      - alert: VibrationZoneDanger
        expr: gl013_vibration_zone == 4
        for: 1m
        labels:
          severity: emergency
          category: vibration
          agent: gl013
          team: maintenance
          priority: P0
          impact: critical
          safety: "true"
        annotations:
          summary: "DANGER: {{ $labels.equipment_id }} vibration in Zone D - STOP IMMEDIATELY"
          description: "ISO 10816 Zone D violation. Machine may cause damage. Immediate shutdown required."
          action: "STOP MACHINE IMMEDIATELY. Do not restart until inspection complete."
          runbook_url: "https://runbooks.greenlang.io/gl013/vibration-zone-d"

      - alert: VibrationZoneAlert
        expr: gl013_vibration_zone == 3
        for: 5m
        labels:
          severity: high
          category: vibration
          agent: gl013
          team: maintenance
          priority: P1
          impact: high
        annotations:
          summary: "Alert: {{ $labels.equipment_id }} vibration in Zone C"
          description: "ISO 10816 Zone C - Short-term operation only. Schedule maintenance within 48 hours."
          action: "Increase monitoring frequency. Plan maintenance window."
          runbook_url: "https://runbooks.greenlang.io/gl013/vibration-zone-c"

      - alert: VibrationZoneMarginLow
        expr: gl013_vibration_zone_margin_mm_s < 0.5
        for: 15m
        labels:
          severity: warning
          category: vibration
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "Low margin to next vibration zone for {{ $labels.equipment_id }}"
          description: "Only {{ $value | printf \"%.2f\" }} mm/s margin to next zone boundary."
          action: "Monitor closely and investigate root cause of vibration increase."

      - alert: VibrationTrendingUp
        expr: gl013_vibration_trend_rate > 0.1
        for: 2h
        labels:
          severity: warning
          category: vibration
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "Vibration trending up for {{ $labels.equipment_id }}"
          description: "Vibration increasing at {{ $value | printf \"%.2f\" }} mm/s per day."
          action: "Investigate cause. Check bearing condition and alignment."

      - alert: BearingFaultOuterRace
        expr: gl013_bearing_fault_frequency_energy{fault_type="BPFO"} > 0.5
        for: 10m
        labels:
          severity: high
          category: vibration
          agent: gl013
          team: maintenance
          priority: P1
          component: bearing
        annotations:
          summary: "Outer race bearing fault detected on {{ $labels.equipment_id }}"
          description: "Elevated energy at BPFO frequency indicates {{ $labels.bearing_id }} outer race degradation."
          action: "Schedule bearing replacement. Order replacement bearing."
          runbook_url: "https://runbooks.greenlang.io/gl013/bearing-fault"

      - alert: BearingFaultInnerRace
        expr: gl013_bearing_fault_frequency_energy{fault_type="BPFI"} > 0.5
        for: 10m
        labels:
          severity: high
          category: vibration
          agent: gl013
          team: maintenance
          priority: P1
          component: bearing
        annotations:
          summary: "Inner race bearing fault detected on {{ $labels.equipment_id }}"
          description: "Elevated energy at BPFI frequency indicates {{ $labels.bearing_id }} inner race degradation."
          action: "Schedule bearing replacement. Order replacement bearing."
          runbook_url: "https://runbooks.greenlang.io/gl013/bearing-fault"

      - alert: HighVibrationVelocity
        expr: gl013_vibration_velocity_mm_s > 4.5
        for: 10m
        labels:
          severity: warning
          category: vibration
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "High vibration on {{ $labels.equipment_id }}: {{ $value | printf \"%.2f\" }} mm/s"
          description: "Vibration velocity at {{ $labels.measurement_point }} exceeds 4.5 mm/s threshold."
          action: "Check machine balance, alignment, and bearing condition."

  # ===========================================================================
  # TEMPERATURE MONITORING ALERTS
  # ===========================================================================
  - name: gl013_temperature
    interval: 15s
    rules:
      - alert: TemperatureCritical
        expr: gl013_temperature_celsius > 120
        for: 2m
        labels:
          severity: critical
          category: temperature
          agent: gl013
          team: maintenance
          priority: P1
          impact: high
          safety: "true"
        annotations:
          summary: "Critical temperature on {{ $labels.equipment_id }}: {{ $value | printf \"%.1f\" }}C"
          description: "Temperature at {{ $labels.sensor_location }} has exceeded 120C. Risk of damage or fire."
          action: "Reduce load or shut down immediately. Investigate cooling system."
          runbook_url: "https://runbooks.greenlang.io/gl013/temperature-critical"

      - alert: TemperatureHigh
        expr: gl013_temperature_celsius > 100 and gl013_temperature_celsius <= 120
        for: 10m
        labels:
          severity: warning
          category: temperature
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "High temperature on {{ $labels.equipment_id }}: {{ $value | printf \"%.1f\" }}C"
          description: "Temperature elevated. Check cooling and ventilation."
          action: "Verify cooling system operation. Reduce load if possible."

      - alert: ThermalLifeLow
        expr: gl013_thermal_life_remaining_hours < 2000
        for: 30m
        labels:
          severity: high
          category: temperature
          agent: gl013
          team: maintenance
          priority: P1
        annotations:
          summary: "Low thermal life for {{ $labels.equipment_id }}: {{ $value | printf \"%.0f\" }} hours"
          description: "Thermal life consumed significantly. Insulation degradation likely."
          action: "Plan winding replacement or rewind. Monitor temperature closely."
          runbook_url: "https://runbooks.greenlang.io/gl013/thermal-life-low"

      - alert: ThermalLifeConsumedHigh
        expr: gl013_thermal_life_consumed_percent > 80
        for: 1h
        labels:
          severity: warning
          category: temperature
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "High thermal life consumption for {{ $labels.equipment_id }}: {{ $value | printf \"%.0f\" }}%"
          description: "Thermal life {{ $value | printf \"%.0f\" }}% consumed. Plan for replacement."
          action: "Schedule replacement during next planned outage."

      - alert: HighTemperatureRise
        expr: gl013_temperature_delta_ambient_celsius > 60
        for: 15m
        labels:
          severity: warning
          category: temperature
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "High temperature rise on {{ $labels.equipment_id }}: {{ $value | printf \"%.1f\" }}C above ambient"
          description: "Temperature rise exceeds 60C. Check load and cooling."
          action: "Reduce load if overloaded. Check cooling airflow."

  # ===========================================================================
  # ANOMALY DETECTION ALERTS
  # ===========================================================================
  - name: gl013_anomaly
    interval: 30s
    rules:
      - alert: AnomalyCritical
        expr: gl013_anomaly_score > 0.9
        for: 5m
        labels:
          severity: critical
          category: anomaly
          agent: gl013
          team: maintenance
          priority: P1
        annotations:
          summary: "Critical anomaly on {{ $labels.equipment_id }}: score {{ $value | printf \"%.2f\" }}"
          description: "ML model detected critical anomaly. Immediate investigation required."
          action: "Review sensor data and recent operational changes."
          runbook_url: "https://runbooks.greenlang.io/gl013/anomaly-critical"

      - alert: AnomalyHigh
        expr: gl013_anomaly_score > 0.7 and gl013_anomaly_score <= 0.9
        for: 15m
        labels:
          severity: warning
          category: anomaly
          agent: gl013
          team: maintenance
          priority: P2
        annotations:
          summary: "Anomaly detected on {{ $labels.equipment_id }}: score {{ $value | printf \"%.2f\" }}"
          description: "Unusual behavior detected. Investigation recommended."
          action: "Compare current readings with historical baselines."

      - alert: MultipleAnomaliesActive
        expr: sum(gl013_anomalies_active{severity="critical"}) > 3
        for: 10m
        labels:
          severity: high
          category: anomaly
          agent: gl013
          team: maintenance
          priority: P1
        annotations:
          summary: "Multiple critical anomalies: {{ $value }} active"
          description: "Systemic issue possible. Review all anomalies immediately."
          action: "Investigate for common cause. Check shared systems."

  # ===========================================================================
  # MAINTENANCE SCHEDULING ALERTS
  # ===========================================================================
  - name: gl013_maintenance
    interval: 1m
    rules:
      - alert: MaintenanceOverdue
        expr: gl013_maintenance_tasks_overdue > 0
        for: 1h
        labels:
          severity: high
          category: maintenance
          agent: gl013
          team: maintenance
          priority: P1
        annotations:
          summary: "{{ $value }} maintenance tasks overdue"
          description: "Scheduled maintenance has not been completed on time."
          action: "Review overdue tasks and reschedule immediately."

      - alert: EmergencyMaintenanceRequired
        expr: increase(gl013_maintenance_tasks_scheduled_total{urgency="emergency"}[1h]) > 0
        for: 1m
        labels:
          severity: critical
          category: maintenance
          agent: gl013
          team: maintenance
          priority: P0
        annotations:
          summary: "Emergency maintenance scheduled for {{ $labels.equipment_type }}"
          description: "Emergency maintenance task created. Immediate action required."
          action: "Mobilize maintenance team. Prepare required resources."
          runbook_url: "https://runbooks.greenlang.io/gl013/emergency-maintenance"

      - alert: SparePartsShortage
        expr: gl013_spare_parts_required > gl013_spare_parts_available
        for: 4h
        labels:
          severity: warning
          category: maintenance
          agent: gl013
          team: procurement
          priority: P2
        annotations:
          summary: "Spare parts shortage: {{ $labels.part_category }}"
          description: "Required parts exceed available inventory. Order additional parts."
          action: "Create purchase requisition for required parts."

      - alert: MaintenanceLeadTimeCritical
        expr: gl013_maintenance_lead_time_days < 3
        for: 1h
        labels:
          severity: high
          category: maintenance
          agent: gl013
          team: maintenance
          priority: P1
        annotations:
          summary: "Maintenance due soon for {{ $labels.equipment_id }}: {{ $value | printf \"%.0f\" }} days"
          description: "Less than 3 days until scheduled maintenance."
          action: "Confirm maintenance resources and schedule."

  # ===========================================================================
  # INTEGRATION AND CONNECTIVITY ALERTS
  # ===========================================================================
  - name: gl013_integration
    interval: 30s
    rules:
      - alert: ConnectorDisconnected
        expr: gl013_connector_status == 0
        for: 5m
        labels:
          severity: high
          category: integration
          agent: gl013
          team: platform
          priority: P1
        annotations:
          summary: "{{ $labels.connector_type }} connector disconnected from {{ $labels.endpoint }}"
          description: "Integration connector is not connected. Data flow interrupted."
          action: "Check network connectivity and endpoint availability."
          runbook_url: "https://runbooks.greenlang.io/gl013/connector-disconnected"

      - alert: ConnectorDegraded
        expr: gl013_connector_status == 2
        for: 10m
        labels:
          severity: warning
          category: integration
          agent: gl013
          team: platform
          priority: P2
        annotations:
          summary: "{{ $labels.connector_type }} connector degraded"
          description: "Connector experiencing issues. Some operations may fail."
          action: "Review connector logs and error rates."

      - alert: HighConnectorLatency
        expr: histogram_quantile(0.95, rate(gl013_connector_latency_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
          category: integration
          agent: gl013
          team: platform
          priority: P2
        annotations:
          summary: "High latency on {{ $labels.connector_type }} connector"
          description: "P95 latency exceeds 5 seconds. Performance degradation."
          action: "Check endpoint performance and network."

      - alert: DataSyncLag
        expr: gl013_data_sync_lag_seconds > 300
        for: 15m
        labels:
          severity: warning
          category: integration
          agent: gl013
          team: platform
          priority: P2
        annotations:
          summary: "Data sync lag: {{ $value | printf \"%.0f\" }} seconds for {{ $labels.data_source }}"
          description: "Sync lag exceeds 5 minutes. Data may be stale."
          action: "Check sync process and source system availability."

  # ===========================================================================
  # SYSTEM PERFORMANCE ALERTS
  # ===========================================================================
  - name: gl013_system
    interval: 30s
    rules:
      - alert: HighOperationLatency
        expr: histogram_quantile(0.95, rate(gl013_operation_latency_seconds_bucket[5m])) > 10
        for: 10m
        labels:
          severity: warning
          category: system
          agent: gl013
          team: platform
          priority: P2
        annotations:
          summary: "High latency for {{ $labels.operation_type }} operations"
          description: "P95 latency exceeds 10 seconds. System performance degraded."
          action: "Check system resources and database performance."

      - alert: HighErrorRate
        expr: sum(rate(gl013_operations_total{status="failure"}[5m])) / sum(rate(gl013_operations_total[5m])) > 0.1
        for: 5m
        labels:
          severity: high
          category: system
          agent: gl013
          team: platform
          priority: P1
        annotations:
          summary: "High error rate: {{ $value | printf \"%.1f\" }}%"
          description: "Operation failure rate exceeds 10%."
          action: "Review error logs and recent deployments."

      - alert: LowCacheHitRate
        expr: gl013_cache_hit_rate < 50
        for: 1h
        labels:
          severity: info
          category: system
          agent: gl013
          team: platform
          priority: P3
        annotations:
          summary: "Low cache hit rate: {{ $value | printf \"%.1f\" }}%"
          description: "Cache effectiveness reduced. May impact performance."
          action: "Review cache configuration and access patterns."

      - alert: ProvenanceValidationFailures
        expr: increase(gl013_provenance_validation_failures_total[1h]) > 0
        for: 5m
        labels:
          severity: high
          category: system
          agent: gl013
          team: platform
          priority: P1
          compliance: "true"
        annotations:
          summary: "Provenance validation failures detected"
          description: "Data provenance integrity compromised. Audit trail affected."
          action: "Investigate validation failures. Check for data corruption."
          runbook_url: "https://runbooks.greenlang.io/gl013/provenance-validation"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="gl013"} > 4e9
        for: 15m
        labels:
          severity: warning
          category: system
          agent: gl013
          team: platform
          priority: P2
        annotations:
          summary: "High memory usage: {{ $value | humanize }}"
          description: "GL-013 process memory exceeds 4GB."
          action: "Check for memory leaks. Consider scaling."

      - alert: CalculationLatencyHigh
        expr: histogram_quantile(0.99, rate(gl013_calculation_latency_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
          category: system
          agent: gl013
          team: platform
          priority: P2
        annotations:
          summary: "High calculation latency for {{ $labels.calculation_type }}"
          description: "P99 calculation latency exceeds 1 second."
          action: "Optimize calculations or increase resources."
