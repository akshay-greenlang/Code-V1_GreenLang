# ==============================================================================
# GL-014 EXCHANGER-PRO Heat Exchanger Optimizer - AgentSpec v2.0
# ==============================================================================
# GreenLang Agent Configuration Specification
# Schema Version: 2.0
# Agent ID: GL-014
# Codename: EXCHANGER-PRO
# ==============================================================================

# ------------------------------------------------------------------------------
# AGENT IDENTIFICATION
# ------------------------------------------------------------------------------
agent:
  id: GL-014
  codename: EXCHANGER-PRO
  name: HeatExchangerOptimizerAgent
  version: "1.0.0"
  type: optimizer
  category: heat_exchangers
  domain: Heat Exchangers

  description: >-
    Industrial heat exchanger optimization agent for performance monitoring,
    fouling prediction, and intelligent cleaning schedule generation.

  long_description: |
    EXCHANGER-PRO is a comprehensive heat exchanger optimization agent that:

    1. Monitors real-time thermal performance (heat duty, U-value, effectiveness)
    2. Calculates and trends fouling factors for shell and tube sides
    3. Predicts fouling progression using asymptotic models
    4. Generates cost-optimized cleaning schedules
    5. Quantifies economic impact of fouling
    6. Integrates with process historians, CMMS, and DCS systems

    The agent uses deterministic thermodynamic calculations following TEMA,
    HTRI, and industry-standard methods to ensure zero-hallucination operation.

# ------------------------------------------------------------------------------
# RUNTIME CONFIGURATION
# ------------------------------------------------------------------------------
configuration:
  # Runtime Settings
  runtime:
    deterministic: true
    temperature: 0.0
    seed: 42
    zero_hallucination: true
    max_retries: 3
    timeout_seconds: 300

  # Cache Configuration
  cache:
    enabled: true
    ttl_seconds: 300
    max_entries: 10000
    strategy: lru

  # Batch Processing
  batch:
    enabled: true
    max_batch_size: 500
    parallel_workers: 4
    chunk_size: 100

  # Performance Thresholds
  thresholds:
    # Fouling factor thresholds (m2-K/W)
    fouling_light: 0.0001
    fouling_moderate: 0.0003
    fouling_heavy: 0.0005
    fouling_severe: 0.001
    fouling_critical: 0.002

    # Performance thresholds
    efficiency_optimal: 95.0
    efficiency_good: 85.0
    efficiency_degraded: 75.0
    efficiency_poor: 65.0
    efficiency_critical: 50.0

    # U-value ratio thresholds
    u_ratio_optimal: 0.95
    u_ratio_good: 0.85
    u_ratio_degraded: 0.70
    u_ratio_poor: 0.55
    u_ratio_critical: 0.40

    # Approach temperature thresholds (K)
    approach_optimal: 5.0
    approach_acceptable: 10.0
    approach_degraded: 15.0
    approach_poor: 25.0

  # Economic Parameters
  economics:
    electricity_cost_per_kwh: 0.10
    steam_cost_per_kg: 0.03
    cooling_water_cost_per_m3: 0.50
    downtime_cost_per_hour: 5000.0
    cleaning_labor_cost_per_hour: 150.0

  # Cleaning Configuration
  cleaning:
    # Cost estimates by method (USD)
    chemical_cleaning_cost: 15000.0
    mechanical_cleaning_cost: 25000.0
    hydroblast_cleaning_cost: 35000.0
    offline_chemical_cost: 20000.0
    online_chemical_cost: 8000.0

    # Downtime estimates (hours)
    chemical_downtime_hours: 24.0
    mechanical_downtime_hours: 48.0
    hydroblast_downtime_hours: 36.0
    offline_chemical_hours: 36.0
    online_chemical_hours: 0.0

    # Effectiveness estimates (%)
    chemical_effectiveness: 85.0
    mechanical_effectiveness: 95.0
    hydroblast_effectiveness: 90.0

  # Fouling Model Parameters
  fouling_model:
    # Asymptotic fouling model: Rf(t) = Rf_max * (1 - exp(-t/tau))
    default_time_constant_days: 180.0
    max_fouling_factor: 0.002
    fouling_rate_acceleration_threshold: 0.00001

  # Safety Limits
  safety:
    max_pressure_drop_ratio: 2.0
    max_temperature_approach_k: 50.0
    min_flow_ratio: 0.5
    max_tube_velocity_m_s: 3.0
    min_tube_velocity_m_s: 0.5

# ------------------------------------------------------------------------------
# INPUT SCHEMA (Detailed)
# ------------------------------------------------------------------------------
inputs:
  # Temperature Data Input
  temperature_data:
    type: object
    required: true
    description: "Inlet/outlet temperatures for hot and cold streams"
    properties:
      hot_inlet_temp_c:
        type: float
        required: true
        description: "Hot stream inlet temperature"
        unit: "Celsius"
        constraints:
          min: -50.0
          max: 500.0
        validation:
          - "hot_inlet_temp_c > hot_outlet_temp_c"

      hot_outlet_temp_c:
        type: float
        required: true
        description: "Hot stream outlet temperature"
        unit: "Celsius"
        constraints:
          min: -50.0
          max: 500.0

      cold_inlet_temp_c:
        type: float
        required: true
        description: "Cold stream inlet temperature"
        unit: "Celsius"
        constraints:
          min: -50.0
          max: 500.0

      cold_outlet_temp_c:
        type: float
        required: true
        description: "Cold stream outlet temperature"
        unit: "Celsius"
        constraints:
          min: -50.0
          max: 500.0
        validation:
          - "cold_outlet_temp_c > cold_inlet_temp_c"

      ambient_temp_c:
        type: float
        required: false
        description: "Ambient temperature"
        unit: "Celsius"
        default: 25.0
        constraints:
          min: -40.0
          max: 60.0

      measurement_timestamp:
        type: datetime
        required: false
        description: "Timestamp of temperature measurement"
        format: "ISO8601"

  # Pressure Data Input
  pressure_data:
    type: object
    required: true
    description: "Pressure drops across shell and tube sides"
    properties:
      shell_inlet_pressure_kpa:
        type: float
        required: true
        description: "Shell side inlet pressure"
        unit: "kPa"
        constraints:
          min: 0.0
          max: 10000.0

      shell_outlet_pressure_kpa:
        type: float
        required: true
        description: "Shell side outlet pressure"
        unit: "kPa"
        constraints:
          min: 0.0
          max: 10000.0
        validation:
          - "shell_outlet_pressure_kpa <= shell_inlet_pressure_kpa"

      tube_inlet_pressure_kpa:
        type: float
        required: true
        description: "Tube side inlet pressure"
        unit: "kPa"
        constraints:
          min: 0.0
          max: 10000.0

      tube_outlet_pressure_kpa:
        type: float
        required: true
        description: "Tube side outlet pressure"
        unit: "kPa"
        constraints:
          min: 0.0
          max: 10000.0
        validation:
          - "tube_outlet_pressure_kpa <= tube_inlet_pressure_kpa"

      design_shell_pressure_drop_kpa:
        type: float
        required: false
        description: "Design shell side pressure drop"
        unit: "kPa"

      design_tube_pressure_drop_kpa:
        type: float
        required: false
        description: "Design tube side pressure drop"
        unit: "kPa"

  # Flow Data Input
  flow_data:
    type: object
    required: true
    description: "Mass and volumetric flow rates"
    properties:
      hot_mass_flow_kg_s:
        type: float
        required: true
        description: "Hot stream mass flow rate"
        unit: "kg/s"
        constraints:
          min: 0.001
          max: 10000.0

      cold_mass_flow_kg_s:
        type: float
        required: true
        description: "Cold stream mass flow rate"
        unit: "kg/s"
        constraints:
          min: 0.001
          max: 10000.0

      hot_volumetric_flow_m3_h:
        type: float
        required: false
        description: "Hot stream volumetric flow rate"
        unit: "m3/h"
        constraints:
          min: 0.0

      cold_volumetric_flow_m3_h:
        type: float
        required: false
        description: "Cold stream volumetric flow rate"
        unit: "m3/h"
        constraints:
          min: 0.0

      hot_velocity_m_s:
        type: float
        required: false
        description: "Hot stream velocity in exchanger"
        unit: "m/s"

      cold_velocity_m_s:
        type: float
        required: false
        description: "Cold stream velocity in exchanger"
        unit: "m/s"

  # Exchanger Parameters Input
  exchanger_parameters:
    type: object
    required: true
    description: "Heat exchanger design specifications"
    properties:
      exchanger_id:
        type: string
        required: true
        description: "Unique heat exchanger identifier"
        pattern: "^[A-Z0-9-]+$"
        max_length: 50

      exchanger_name:
        type: string
        required: false
        description: "Heat exchanger name/description"
        max_length: 200

      exchanger_type:
        type: enum
        required: true
        description: "Type of heat exchanger"
        values:
          - shell_and_tube
          - plate
          - air_cooled
          - spiral
          - double_pipe
          - finned_tube
          - plate_fin
          - printed_circuit

      flow_arrangement:
        type: enum
        required: true
        description: "Flow arrangement"
        values:
          - counterflow
          - parallel_flow
          - crossflow
          - multipass

      design_heat_duty_kw:
        type: float
        required: true
        description: "Design heat duty"
        unit: "kW"
        constraints:
          min: 0.0
          max: 1000000.0

      design_u_w_m2k:
        type: float
        required: true
        description: "Design overall heat transfer coefficient"
        unit: "W/m2-K"
        constraints:
          min: 1.0
          max: 10000.0

      clean_u_w_m2k:
        type: float
        required: false
        description: "Clean overall heat transfer coefficient"
        unit: "W/m2-K"
        constraints:
          min: 1.0
          max: 10000.0

      heat_transfer_area_m2:
        type: float
        required: true
        description: "Total heat transfer area"
        unit: "m2"
        constraints:
          min: 0.1
          max: 100000.0

      # Shell and Tube Specific
      shell_type:
        type: enum
        required: false
        description: "TEMA shell type designation"
        values:
          - E  # One-pass shell
          - F  # Two-pass shell with longitudinal baffle
          - G  # Split flow
          - H  # Double split flow
          - J  # Divided flow
          - K  # Kettle type reboiler
          - X  # Cross flow

      tube_layout:
        type: enum
        required: false
        description: "Tube layout pattern"
        values:
          - triangular_30
          - rotated_triangular_60
          - square_90
          - rotated_square_45

      number_of_tubes:
        type: integer
        required: false
        description: "Total number of tubes"
        constraints:
          min: 1
          max: 50000

      tube_length_m:
        type: float
        required: false
        description: "Tube length"
        unit: "m"
        constraints:
          min: 0.1
          max: 30.0

      tube_od_mm:
        type: float
        required: false
        description: "Tube outer diameter"
        unit: "mm"
        constraints:
          min: 5.0
          max: 100.0

      tube_id_mm:
        type: float
        required: false
        description: "Tube inner diameter"
        unit: "mm"
        constraints:
          min: 3.0
          max: 95.0

      tube_pitch_mm:
        type: float
        required: false
        description: "Tube pitch"
        unit: "mm"
        constraints:
          min: 6.0
          max: 150.0

      tube_material:
        type: enum
        required: false
        description: "Tube material"
        values:
          - carbon_steel
          - stainless_304
          - stainless_316
          - stainless_316L
          - duplex_2205
          - monel_400
          - inconel_625
          - hastelloy_c276
          - titanium_grade_2
          - copper
          - admiralty_brass
          - cupronickel_90_10
          - cupronickel_70_30

      number_of_passes:
        type: integer
        required: false
        description: "Number of tube passes"
        constraints:
          min: 1
          max: 16

      baffle_spacing_mm:
        type: float
        required: false
        description: "Baffle spacing"
        unit: "mm"
        constraints:
          min: 50.0
          max: 5000.0

      baffle_cut_percent:
        type: float
        required: false
        description: "Baffle cut percentage"
        unit: "%"
        constraints:
          min: 15.0
          max: 45.0
        default: 25.0

      shell_diameter_mm:
        type: float
        required: false
        description: "Shell inner diameter"
        unit: "mm"
        constraints:
          min: 50.0
          max: 5000.0

      # Design Fouling Factors
      design_fouling_shell_m2kw:
        type: float
        required: false
        description: "Design fouling factor for shell side"
        unit: "m2-K/W"
        default: 0.0002

      design_fouling_tube_m2kw:
        type: float
        required: false
        description: "Design fouling factor for tube side"
        unit: "m2-K/W"
        default: 0.0002

  # Fluid Properties Input
  fluid_properties:
    type: object
    required: true
    description: "Thermal and physical properties of process fluids"
    properties:
      hot_fluid:
        type: object
        required: true
        description: "Hot stream fluid properties"
        properties:
          name:
            type: string
            required: true
            max_length: 100

          fluid_type:
            type: enum
            required: true
            values:
              - water
              - steam
              - thermal_oil
              - crude_oil
              - naphtha
              - kerosene
              - diesel
              - gas_oil
              - fuel_oil
              - natural_gas
              - air
              - nitrogen
              - hydrogen
              - ammonia
              - refrigerant
              - brine
              - glycol_solution
              - chemical

          phase:
            type: enum
            required: false
            values:
              - liquid
              - gas
              - two_phase
              - supercritical
            default: liquid

          cp_j_kgk:
            type: float
            required: true
            description: "Specific heat capacity"
            unit: "J/kg-K"
            constraints:
              min: 100.0
              max: 50000.0

          density_kg_m3:
            type: float
            required: true
            description: "Density"
            unit: "kg/m3"
            constraints:
              min: 0.01
              max: 15000.0

          viscosity_pa_s:
            type: float
            required: true
            description: "Dynamic viscosity"
            unit: "Pa-s"
            constraints:
              min: 0.000001
              max: 1000.0

          thermal_conductivity_w_mk:
            type: float
            required: true
            description: "Thermal conductivity"
            unit: "W/m-K"
            constraints:
              min: 0.001
              max: 500.0

          prandtl_number:
            type: float
            required: false
            description: "Prandtl number"

      cold_fluid:
        type: object
        required: true
        description: "Cold stream fluid properties"
        properties:
          name:
            type: string
            required: true
            max_length: 100

          fluid_type:
            type: enum
            required: true
            values:
              - water
              - steam
              - thermal_oil
              - crude_oil
              - naphtha
              - kerosene
              - diesel
              - gas_oil
              - fuel_oil
              - natural_gas
              - air
              - nitrogen
              - hydrogen
              - ammonia
              - refrigerant
              - brine
              - glycol_solution
              - chemical

          phase:
            type: enum
            required: false
            values:
              - liquid
              - gas
              - two_phase
              - supercritical
            default: liquid

          cp_j_kgk:
            type: float
            required: true
            description: "Specific heat capacity"
            unit: "J/kg-K"
            constraints:
              min: 100.0
              max: 50000.0

          density_kg_m3:
            type: float
            required: true
            description: "Density"
            unit: "kg/m3"
            constraints:
              min: 0.01
              max: 15000.0

          viscosity_pa_s:
            type: float
            required: true
            description: "Dynamic viscosity"
            unit: "Pa-s"
            constraints:
              min: 0.000001
              max: 1000.0

          thermal_conductivity_w_mk:
            type: float
            required: true
            description: "Thermal conductivity"
            unit: "W/m-K"
            constraints:
              min: 0.001
              max: 500.0

          prandtl_number:
            type: float
            required: false
            description: "Prandtl number"

  # Operating History Input
  operating_history:
    type: object
    required: false
    description: "Historical operating and cleaning data"
    properties:
      commissioning_date:
        type: date
        required: false
        description: "Date exchanger was commissioned"

      last_cleaning_date:
        type: date
        required: false
        description: "Date of last cleaning"

      last_cleaning_method:
        type: enum
        required: false
        description: "Last cleaning method used"
        values:
          - chemical
          - mechanical
          - hydroblast
          - offline_chemical
          - online_chemical
          - ultrasonic
          - thermal

      last_cleaning_side:
        type: enum
        required: false
        description: "Side that was cleaned"
        values:
          - shell
          - tube
          - both

      days_since_cleaning:
        type: integer
        required: false
        description: "Days since last cleaning"
        constraints:
          min: 0

      cleaning_effectiveness_percent:
        type: float
        required: false
        description: "Effectiveness of last cleaning"
        unit: "%"
        constraints:
          min: 0.0
          max: 100.0

      historical_fouling_data:
        type: array
        required: false
        description: "Historical fouling factor measurements"
        items:
          type: object
          properties:
            timestamp:
              type: datetime
            shell_fouling_factor:
              type: float
            tube_fouling_factor:
              type: float
            total_fouling_factor:
              type: float
            u_value:
              type: float
            heat_duty:
              type: float

      cleaning_history:
        type: array
        required: false
        description: "Historical cleaning records"
        items:
          type: object
          properties:
            date:
              type: date
            method:
              type: string
            side:
              type: string
            cost:
              type: float
            downtime_hours:
              type: float
            pre_cleaning_fouling:
              type: float
            post_cleaning_fouling:
              type: float
            effectiveness:
              type: float

      average_operating_hours_per_day:
        type: float
        required: false
        description: "Average daily operating hours"
        default: 24.0
        constraints:
          min: 0.0
          max: 24.0

# ------------------------------------------------------------------------------
# OUTPUT SCHEMA (Detailed)
# ------------------------------------------------------------------------------
outputs:
  # Cleaning Schedule Output
  cleaning_schedule:
    type: object
    description: "Optimized cleaning schedule with cost-benefit analysis"
    properties:
      exchanger_id:
        type: string
        description: "Heat exchanger identifier"

      analysis_timestamp:
        type: datetime
        description: "Timestamp of analysis"

      recommended_cleaning_date:
        type: date
        description: "Recommended date for cleaning"

      recommended_cleaning_method:
        type: enum
        description: "Recommended cleaning method"
        values:
          - chemical
          - mechanical
          - hydroblast
          - offline_chemical
          - online_chemical
          - ultrasonic

      recommended_cleaning_side:
        type: enum
        description: "Recommended side to clean"
        values:
          - shell
          - tube
          - both

      urgency_level:
        type: enum
        description: "Cleaning urgency classification"
        values:
          - routine      # Can be scheduled for next turnaround
          - planned      # Should be scheduled within 60 days
          - urgent       # Should be cleaned within 14 days
          - critical     # Immediate cleaning required

      days_until_recommended:
        type: integer
        description: "Days until recommended cleaning date"

      cost_benefit_ratio:
        type: float
        description: "Ratio of savings to cleaning cost"

      estimated_cleaning_cost:
        type: float
        unit: "USD"
        description: "Estimated total cleaning cost"

      estimated_downtime_hours:
        type: float
        unit: "hours"
        description: "Estimated downtime for cleaning"

      estimated_downtime_cost:
        type: float
        unit: "USD"
        description: "Estimated cost of downtime"

      energy_savings_if_cleaned:
        type: float
        unit: "kW"
        description: "Power savings if cleaned now"

      monthly_energy_savings:
        type: float
        unit: "kWh"
        description: "Monthly energy savings if cleaned"

      payback_period_days:
        type: integer
        description: "Days to recover cleaning cost through savings"

      optimal_cleaning_window:
        type: object
        description: "Optimal window for cleaning"
        properties:
          start_date:
            type: date
          end_date:
            type: date
          reason:
            type: string

      cleaning_method_comparison:
        type: array
        description: "Comparison of cleaning methods"
        items:
          type: object
          properties:
            method:
              type: string
            cost:
              type: float
            downtime_hours:
              type: float
            effectiveness:
              type: float
            payback_days:
              type: integer
            recommended:
              type: boolean

      provenance_hash:
        type: string
        description: "SHA-256 hash for audit trail"

  # Performance Metrics Output
  performance_metrics:
    type: object
    description: "Current and projected performance metrics"
    properties:
      exchanger_id:
        type: string
        description: "Heat exchanger identifier"

      analysis_timestamp:
        type: datetime
        description: "Timestamp of analysis"

      # Heat Duty
      current_heat_duty_kw:
        type: float
        unit: "kW"
        description: "Current actual heat duty"

      design_heat_duty_kw:
        type: float
        unit: "kW"
        description: "Design heat duty"

      heat_duty_ratio:
        type: float
        description: "Ratio of current to design heat duty"

      heat_duty_deficit_kw:
        type: float
        unit: "kW"
        description: "Heat duty shortfall"

      # Overall Heat Transfer Coefficient
      current_u_w_m2k:
        type: float
        unit: "W/m2-K"
        description: "Current overall HTC"

      design_u_w_m2k:
        type: float
        unit: "W/m2-K"
        description: "Design overall HTC"

      clean_u_w_m2k:
        type: float
        unit: "W/m2-K"
        description: "Clean condition HTC"

      u_ratio:
        type: float
        description: "Ratio of current to design U-value"

      u_degradation_percent:
        type: float
        unit: "%"
        description: "Percentage U-value degradation"

      # LMTD
      lmtd_k:
        type: float
        unit: "K"
        description: "Log Mean Temperature Difference"

      lmtd_correction_factor:
        type: float
        description: "LMTD correction factor (F)"

      corrected_lmtd_k:
        type: float
        unit: "K"
        description: "Corrected LMTD"

      # Effectiveness-NTU
      effectiveness:
        type: float
        description: "Heat exchanger effectiveness (0-1)"

      ntu:
        type: float
        description: "Number of Transfer Units"

      capacity_ratio:
        type: float
        description: "Heat capacity ratio (Cmin/Cmax)"

      # Temperature Metrics
      approach_temperature_k:
        type: float
        unit: "K"
        description: "Temperature approach"

      hot_side_duty_kw:
        type: float
        unit: "kW"
        description: "Hot side heat duty"

      cold_side_duty_kw:
        type: float
        unit: "kW"
        description: "Cold side heat duty"

      duty_imbalance_percent:
        type: float
        unit: "%"
        description: "Duty imbalance (heat loss)"

      # Pressure Drop
      shell_pressure_drop_kpa:
        type: float
        unit: "kPa"
        description: "Shell side pressure drop"

      tube_pressure_drop_kpa:
        type: float
        unit: "kPa"
        description: "Tube side pressure drop"

      shell_dp_ratio:
        type: float
        description: "Shell DP to design ratio"

      tube_dp_ratio:
        type: float
        description: "Tube DP to design ratio"

      # Status
      performance_status:
        type: enum
        description: "Overall performance classification"
        values:
          - optimal    # U-ratio > 0.95
          - good       # U-ratio > 0.85
          - degraded   # U-ratio > 0.70
          - poor       # U-ratio > 0.55
          - critical   # U-ratio <= 0.55

      performance_score:
        type: float
        description: "Composite performance score (0-100)"

      provenance_hash:
        type: string
        description: "SHA-256 hash for audit trail"

  # Fouling Analysis Output
  fouling_analysis:
    type: object
    description: "Fouling state, predictions, and trends"
    properties:
      exchanger_id:
        type: string
        description: "Heat exchanger identifier"

      analysis_timestamp:
        type: datetime
        description: "Timestamp of analysis"

      # Current Fouling State
      shell_side_fouling_factor:
        type: float
        unit: "m2-K/W"
        description: "Shell side fouling factor"

      tube_side_fouling_factor:
        type: float
        unit: "m2-K/W"
        description: "Tube side fouling factor"

      total_fouling_factor:
        type: float
        unit: "m2-K/W"
        description: "Total fouling factor"

      fouling_state:
        type: enum
        description: "Fouling severity classification"
        values:
          - clean      # Rf < 0.0001
          - light      # 0.0001 <= Rf < 0.0003
          - moderate   # 0.0003 <= Rf < 0.0005
          - heavy      # 0.0005 <= Rf < 0.001
          - severe     # Rf >= 0.001

      fouling_percentage:
        type: float
        unit: "%"
        description: "Fouling as percentage of design allowance"

      # Fouling Mechanisms
      primary_fouling_mechanism:
        type: enum
        description: "Primary fouling mechanism identified"
        values:
          - particulate
          - crystallization
          - biological
          - corrosion
          - chemical_reaction
          - solidification
          - composite

      fouling_mechanisms:
        type: array
        description: "All identified fouling mechanisms"
        items:
          type: object
          properties:
            mechanism:
              type: string
            probability:
              type: float
            severity:
              type: string

      # Fouling Prediction
      fouling_rate_m2kw_per_day:
        type: float
        unit: "m2-K/W per day"
        description: "Current fouling rate"

      asymptotic_fouling_factor:
        type: float
        unit: "m2-K/W"
        description: "Predicted asymptotic fouling factor"

      time_constant_days:
        type: float
        unit: "days"
        description: "Fouling time constant"

      predicted_days_to_threshold:
        type: integer
        unit: "days"
        description: "Days until cleaning threshold reached"

      fouling_trend:
        type: enum
        description: "Fouling trend direction"
        values:
          - stable        # Rate change < 5%
          - increasing    # Rate increasing 5-20%
          - accelerating  # Rate increasing > 20%
          - decelerating  # Rate decreasing

      # Fouling Forecast
      fouling_forecast:
        type: array
        description: "Projected fouling factor over time"
        items:
          type: object
          properties:
            days_from_now:
              type: integer
            predicted_fouling_factor:
              type: float
            predicted_u_value:
              type: float
            predicted_efficiency:
              type: float
            confidence_interval_lower:
              type: float
            confidence_interval_upper:
              type: float

      provenance_hash:
        type: string
        description: "SHA-256 hash for audit trail"

  # Efficiency Report Output
  efficiency_report:
    type: object
    description: "Thermal efficiency and optimization recommendations"
    properties:
      exchanger_id:
        type: string
        description: "Heat exchanger identifier"

      analysis_timestamp:
        type: datetime
        description: "Timestamp of analysis"

      # Efficiency Metrics
      thermal_efficiency_percent:
        type: float
        unit: "%"
        description: "Current thermal efficiency"

      design_efficiency_percent:
        type: float
        unit: "%"
        description: "Design thermal efficiency"

      clean_efficiency_percent:
        type: float
        unit: "%"
        description: "Clean condition efficiency"

      efficiency_loss_percent:
        type: float
        unit: "%"
        description: "Efficiency loss due to fouling"

      # Energy Losses
      energy_loss_kw:
        type: float
        unit: "kW"
        description: "Current power loss due to inefficiency"

      daily_energy_loss_kwh:
        type: float
        unit: "kWh"
        description: "Daily energy loss"

      monthly_energy_loss_mwh:
        type: float
        unit: "MWh"
        description: "Monthly energy loss"

      annual_energy_loss_mwh:
        type: float
        unit: "MWh"
        description: "Annual energy loss projection"

      # Exergy Analysis
      exergy_efficiency_percent:
        type: float
        unit: "%"
        description: "Exergy (2nd law) efficiency"

      exergy_destruction_kw:
        type: float
        unit: "kW"
        description: "Rate of exergy destruction"

      # Recommendations
      recommendations:
        type: array
        description: "Optimization recommendations"
        items:
          type: object
          properties:
            priority:
              type: enum
              values: [critical, high, medium, low]
            category:
              type: enum
              values: [cleaning, operational, design, monitoring]
            action:
              type: string
              description: "Recommended action"
            expected_improvement_percent:
              type: float
            estimated_cost:
              type: float
            payback_period_days:
              type: integer
            implementation_complexity:
              type: enum
              values: [low, medium, high]

      efficiency_improvement_potential:
        type: float
        unit: "%"
        description: "Potential efficiency gain if all actions taken"

      provenance_hash:
        type: string
        description: "SHA-256 hash for audit trail"

  # Economic Impact Output
  economic_impact:
    type: object
    description: "Cost analysis and ROI projections"
    properties:
      exchanger_id:
        type: string
        description: "Heat exchanger identifier"

      analysis_timestamp:
        type: datetime
        description: "Timestamp of analysis"

      currency:
        type: string
        description: "Currency for all monetary values"
        default: "USD"

      # Energy Cost Losses
      hourly_energy_cost_loss:
        type: float
        unit: "USD/hour"
        description: "Hourly energy cost loss"

      daily_energy_cost_loss:
        type: float
        unit: "USD/day"
        description: "Daily energy cost loss"

      monthly_energy_cost_loss:
        type: float
        unit: "USD/month"
        description: "Monthly energy cost loss"

      annual_energy_cost_loss:
        type: float
        unit: "USD/year"
        description: "Annual energy cost loss projection"

      # Cleaning ROI
      cleaning_cost_estimate:
        type: float
        unit: "USD"
        description: "Estimated cleaning cost"

      downtime_cost_estimate:
        type: float
        unit: "USD"
        description: "Estimated downtime cost"

      total_cleaning_investment:
        type: float
        unit: "USD"
        description: "Total cleaning investment"

      post_cleaning_savings_monthly:
        type: float
        unit: "USD/month"
        description: "Monthly savings after cleaning"

      cleaning_roi_percent:
        type: float
        unit: "%"
        description: "Return on cleaning investment"

      simple_payback_days:
        type: integer
        unit: "days"
        description: "Simple payback period"

      # Optimal Frequency
      optimal_cleaning_frequency_days:
        type: integer
        unit: "days"
        description: "Economically optimal cleaning frequency"

      annual_optimal_cleanings:
        type: integer
        description: "Optimal cleanings per year"

      annual_cleaning_cost_optimal:
        type: float
        unit: "USD/year"
        description: "Annual cleaning cost at optimal frequency"

      # Total Cost Analysis
      total_cost_of_fouling_annual:
        type: float
        unit: "USD/year"
        description: "Total annual cost of fouling"

      total_cost_breakdown:
        type: object
        description: "Breakdown of fouling costs"
        properties:
          energy_loss:
            type: float
          cleaning_costs:
            type: float
          downtime_costs:
            type: float
          maintenance_overhead:
            type: float

      potential_annual_savings:
        type: float
        unit: "USD/year"
        description: "Potential annual savings with optimization"

      # NPV Analysis
      npv_cleaning_now:
        type: float
        unit: "USD"
        description: "NPV of cleaning now"

      npv_delayed_cleaning:
        type: float
        unit: "USD"
        description: "NPV of delayed cleaning"

      optimal_decision:
        type: string
        description: "Optimal economic decision"

      provenance_hash:
        type: string
        description: "SHA-256 hash for audit trail"

# ------------------------------------------------------------------------------
# TOOLS SPECIFICATION
# ------------------------------------------------------------------------------
tools:
  # Thermal Calculation Tools
  - name: calculate_heat_duty
    description: "Calculate heat duty from temperature and flow data"
    deterministic: true
    zero_hallucination: true
    formula: "Q = m_dot * Cp * delta_T"
    inputs:
      - mass_flow_rate
      - specific_heat
      - temperature_change
    outputs:
      - heat_duty_kw

  - name: calculate_lmtd
    description: "Calculate Log Mean Temperature Difference"
    deterministic: true
    zero_hallucination: true
    formula: "LMTD = (dT1 - dT2) / ln(dT1/dT2)"
    inputs:
      - hot_inlet_temp
      - hot_outlet_temp
      - cold_inlet_temp
      - cold_outlet_temp
      - flow_arrangement
    outputs:
      - lmtd
      - correction_factor
      - corrected_lmtd

  - name: calculate_overall_htc
    description: "Calculate overall heat transfer coefficient"
    deterministic: true
    zero_hallucination: true
    formula: "U = Q / (A * LMTD)"
    inputs:
      - heat_duty
      - heat_transfer_area
      - lmtd
    outputs:
      - overall_htc

  - name: calculate_effectiveness_ntu
    description: "Calculate effectiveness and NTU"
    deterministic: true
    zero_hallucination: true
    inputs:
      - heat_duty
      - min_heat_capacity_rate
      - max_possible_heat_transfer
    outputs:
      - effectiveness
      - ntu
      - capacity_ratio

  # Fouling Analysis Tools
  - name: calculate_fouling_factor
    description: "Calculate fouling factor from U-value degradation"
    deterministic: true
    zero_hallucination: true
    formula: "Rf = (1/U_fouled) - (1/U_clean)"
    inputs:
      - current_u_value
      - clean_u_value
    outputs:
      - total_fouling_factor

  - name: predict_fouling_progression
    description: "Predict fouling progression using asymptotic model"
    deterministic: true
    zero_hallucination: true
    formula: "Rf(t) = Rf_max * (1 - exp(-t/tau))"
    inputs:
      - current_fouling_factor
      - fouling_rate
      - time_constant
    outputs:
      - predicted_fouling_factor
      - days_to_threshold

  - name: identify_fouling_mechanism
    description: "Identify likely fouling mechanism from operating conditions"
    deterministic: true
    zero_hallucination: true
    inputs:
      - fluid_type
      - temperature_range
      - velocity
      - fouling_pattern
    outputs:
      - fouling_mechanism
      - confidence

  # Cleaning Schedule Tools
  - name: optimize_cleaning_schedule
    description: "Calculate optimal cleaning schedule based on economics"
    deterministic: true
    zero_hallucination: true
    inputs:
      - fouling_rate
      - cleaning_cost
      - energy_cost
      - downtime_cost
    outputs:
      - optimal_cleaning_date
      - cost_benefit_ratio

  - name: compare_cleaning_methods
    description: "Compare different cleaning methods"
    deterministic: true
    zero_hallucination: true
    inputs:
      - fouling_type
      - fouling_severity
      - exchanger_type
    outputs:
      - method_comparison
      - recommended_method

  # Economic Analysis Tools
  - name: calculate_energy_losses
    description: "Calculate energy and cost losses due to fouling"
    deterministic: true
    zero_hallucination: true
    inputs:
      - efficiency_loss
      - heat_duty
      - energy_cost
      - operating_hours
    outputs:
      - energy_loss_kw
      - daily_cost_loss
      - annual_cost_loss

  - name: calculate_cleaning_roi
    description: "Calculate ROI for cleaning investment"
    deterministic: true
    zero_hallucination: true
    inputs:
      - cleaning_cost
      - downtime_cost
      - monthly_savings
    outputs:
      - roi_percent
      - payback_period_days

# ------------------------------------------------------------------------------
# DATA SOURCES
# ------------------------------------------------------------------------------
data_sources:
  # Process Historian Integration
  - id: process_historian
    type: historian
    protocols:
      - OSIsoft_PI
      - Honeywell_PHD
      - AspenTech_IP21
      - OPC_UA
    poll_interval: 60
    batch_size: 1000

  # DCS/SCADA Integration
  - id: dcs_interface
    type: dcs
    protocols:
      - OPC_UA
      - Modbus_TCP
    host: "${DCS_HOST}"
    port: "${DCS_PORT}"
    poll_interval: 10

  # Temperature Sensors
  - id: temperature_sensors
    type: sensor
    protocol: modbus_tcp
    poll_interval: 5
    tags:
      - hot_inlet_temp
      - hot_outlet_temp
      - cold_inlet_temp
      - cold_outlet_temp

  # Flow Sensors
  - id: flow_sensors
    type: sensor
    protocol: modbus_tcp
    poll_interval: 5
    tags:
      - hot_flow_rate
      - cold_flow_rate

  # Pressure Sensors
  - id: pressure_sensors
    type: sensor
    protocol: modbus_tcp
    poll_interval: 10
    tags:
      - shell_inlet_pressure
      - shell_outlet_pressure
      - tube_inlet_pressure
      - tube_outlet_pressure

# ------------------------------------------------------------------------------
# DATA SINKS
# ------------------------------------------------------------------------------
data_sinks:
  # CMMS Integration
  - id: cmms_interface
    type: cmms
    systems:
      - SAP_PM
      - IBM_Maximo
      - Oracle_EAM
    publish_interval: 3600
    events:
      - cleaning_recommendation
      - work_order_creation
      - maintenance_alert

  # Process Historian
  - id: historian_output
    type: historian
    protocol: "${HISTORIAN_PROTOCOL}"
    endpoint: "${HISTORIAN_ENDPOINT}"
    publish_interval: 60
    tags:
      - fouling_factor
      - u_value
      - efficiency
      - cleaning_status

  # MQTT Telemetry
  - id: mqtt_telemetry
    type: mqtt
    broker: "${MQTT_BROKER_URL}"
    topic_prefix: "greenlang/gl-014"
    publish_interval: 30
    qos: 1

# ------------------------------------------------------------------------------
# PERSISTENCE
# ------------------------------------------------------------------------------
persistence:
  database:
    type: postgresql
    url: "${DATABASE_URL}"
    pool_size: "${DB_POOL_SIZE}"
    max_overflow: "${DB_MAX_OVERFLOW}"

  cache:
    type: redis
    url: "${REDIS_URL}"
    ttl: "${CACHE_TTL}"
    pool_size: "${REDIS_POOL_SIZE}"

  time_series:
    type: timescaledb
    enabled: true
    retention_days: 365
    chunk_interval: "1 day"

# ------------------------------------------------------------------------------
# OBSERVABILITY
# ------------------------------------------------------------------------------
observability:
  metrics:
    enabled: true
    port: 8001
    path: /metrics
    custom_metrics:
      - name: heat_exchanger_efficiency
        type: gauge
        description: "Current heat exchanger efficiency"
        labels: [exchanger_id, location]
      - name: fouling_factor
        type: gauge
        description: "Current fouling factor"
        labels: [exchanger_id, side]
      - name: days_to_cleaning
        type: gauge
        description: "Days until recommended cleaning"
        labels: [exchanger_id]
      - name: cleaning_recommendations_total
        type: counter
        description: "Total cleaning recommendations generated"
        labels: [exchanger_id, urgency]

  tracing:
    enabled: true
    exporter: otlp
    endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT}"
    sampling_rate: 0.1

  logging:
    level: "${LOG_LEVEL}"
    format: "${LOG_FORMAT}"
    structured: true
    correlation_id: true

# ------------------------------------------------------------------------------
# POLICIES
# ------------------------------------------------------------------------------
policies:
  retry:
    max_attempts: 3
    backoff: exponential
    initial_delay_ms: 1000
    max_delay_ms: 60000
    retryable_errors:
      - connection_timeout
      - temporary_failure

  circuit_breaker:
    enabled: true
    failure_threshold: 5
    timeout_seconds: 30
    recovery_timeout_seconds: 60

  rate_limiting:
    enabled: true
    requests_per_minute: "${RATE_LIMIT_PER_MINUTE}"
    burst: 10

  timeout:
    default_seconds: 30
    calculation_seconds: 60
    integration_seconds: 120

# ------------------------------------------------------------------------------
# WORKFLOWS
# ------------------------------------------------------------------------------
workflows:
  # Main Analysis Workflow
  heat_exchanger_analysis:
    description: "Complete heat exchanger analysis workflow"
    trigger: scheduled
    schedule: "*/5 * * * *"  # Every 5 minutes
    steps:
      - name: collect_process_data
        tool: collect_sensor_data
        timeout_seconds: 30
        on_failure: retry

      - name: validate_data
        tool: validate_input_data
        timeout_seconds: 10
        on_failure: log_and_skip

      - name: calculate_performance
        tool: calculate_heat_duty
        depends_on: [validate_data]
        timeout_seconds: 30

      - name: calculate_fouling
        tool: calculate_fouling_factor
        depends_on: [calculate_performance]
        timeout_seconds: 30

      - name: predict_fouling
        tool: predict_fouling_progression
        depends_on: [calculate_fouling]
        timeout_seconds: 30

      - name: evaluate_cleaning
        tool: optimize_cleaning_schedule
        depends_on: [predict_fouling]
        timeout_seconds: 60

      - name: generate_report
        tool: generate_analysis_report
        depends_on: [evaluate_cleaning]
        timeout_seconds: 30

      - name: publish_results
        tool: publish_to_sinks
        depends_on: [generate_report]
        timeout_seconds: 60

    on_success: log_completion
    on_failure: alert_and_retry

  # Cleaning Alert Workflow
  cleaning_alert:
    description: "Alert workflow when cleaning is needed"
    trigger: condition
    condition: "fouling_factor > threshold OR days_since_cleaning > max_days"
    steps:
      - name: evaluate_urgency
        tool: calculate_urgency
        timeout_seconds: 10

      - name: generate_work_order
        tool: create_cmms_work_order
        depends_on: [evaluate_urgency]
        condition: "urgency in [urgent, critical]"
        timeout_seconds: 30

      - name: send_notification
        tool: send_alert
        depends_on: [evaluate_urgency]
        timeout_seconds: 10

    on_success: log_alert_sent
    on_failure: escalate

# ------------------------------------------------------------------------------
# DEPLOYMENT
# ------------------------------------------------------------------------------
deployment:
  replicas: 3
  strategy: rolling_update
  max_surge: 1
  max_unavailable: 0

  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

  health_check:
    path: /health
    interval_seconds: 30
    timeout_seconds: 10
    failure_threshold: 3

  readiness_check:
    path: /readiness
    interval_seconds: 10
    timeout_seconds: 5
    failure_threshold: 3

  liveness_check:
    path: /liveness
    interval_seconds: 30
    timeout_seconds: 10
    failure_threshold: 3

  autoscaling:
    enabled: true
    min_replicas: 2
    max_replicas: 10
    target_cpu_percent: 70
    target_memory_percent: 80

  pod_disruption_budget:
    min_available: 1

  security_context:
    run_as_non_root: true
    read_only_root_filesystem: true
    drop_capabilities: [ALL]
