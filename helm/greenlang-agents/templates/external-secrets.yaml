{{- if .Values.externalSecrets.enabled -}}
{{/*
External Secrets - Vault/AWS Secrets Manager integration
*/}}
---
# SecretStore for AWS Secrets Manager
{{- if .Values.externalSecrets.aws.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-aws-secrets
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.externalSecrets.aws.region | default "us-east-1" }}
      {{- if .Values.externalSecrets.aws.role }}
      role: {{ .Values.externalSecrets.aws.role }}
      {{- end }}
      auth:
        jwt:
          serviceAccountRef:
            name: {{ include "greenlang-agents.serviceAccountName" . }}
{{- end }}
---
# SecretStore for HashiCorp Vault
{{- if .Values.externalSecrets.vault.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-vault
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
spec:
  provider:
    vault:
      server: {{ .Values.externalSecrets.vault.server | default "http://vault:8200" }}
      path: {{ .Values.externalSecrets.vault.path | default "secret" }}
      version: {{ .Values.externalSecrets.vault.version | default "v2" }}
      auth:
        kubernetes:
          mountPath: {{ .Values.externalSecrets.vault.mountPath | default "kubernetes" }}
          role: {{ .Values.externalSecrets.vault.role | default "greenlang-agents" }}
          serviceAccountRef:
            name: {{ include "greenlang-agents.serviceAccountName" . }}
{{- end }}
---
# ExternalSecret - Database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-db-secrets
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "SecretStore" }}
  target:
    name: {{ include "greenlang-agents.fullname" . }}-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        DATABASE_URL: "{{ `{{ .database_url }}` }}"
        REDIS_URL: "{{ `{{ .redis_url }}` }}"
  data:
    - secretKey: database_url
      remoteRef:
        key: {{ .Values.externalSecrets.databaseSecret | default "greenlang/database" }}
        property: url
    - secretKey: redis_url
      remoteRef:
        key: {{ .Values.externalSecrets.redisSecret | default "greenlang/redis" }}
        property: url
---
# ExternalSecret - API Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-api-keys
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "SecretStore" }}
  target:
    name: {{ include "greenlang-agents.fullname" . }}-api-keys
    creationPolicy: Owner
  data:
    {{- range .Values.externalSecrets.data }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteRef.key }}
        property: {{ .remoteRef.property }}
    {{- end }}
---
# ExternalSecret - TLS Certificates (if managed externally)
{{- if .Values.externalSecrets.tls.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-tls-external
  namespace: {{ include "greenlang-agents.namespace" . }}
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.tls.refreshInterval | default "24h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "SecretStore" }}
  target:
    name: {{ include "greenlang-agents.fullname" . }}-tls
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: {{ .Values.externalSecrets.tls.certSecret | default "greenlang/tls" }}
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: {{ .Values.externalSecrets.tls.certSecret | default "greenlang/tls" }}
        property: private_key
{{- end }}
{{- end }}
