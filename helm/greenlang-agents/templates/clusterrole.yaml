{{- if .Values.rbac.create -}}
{{/*
ClusterRole - Cluster-wide permissions for cross-namespace operations and CRD access
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-clusterrole
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
rules:
  # Nodes - view node info for scheduling decisions
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]

  # Namespaces - view namespaces
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "watch"]

  # PersistentVolumes - view storage info
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch"]

  # StorageClasses - view storage options
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]

  # IngressClasses - view ingress options
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingressclasses"]
    verbs: ["get", "list", "watch"]

  # PriorityClasses - view priority classes
  - apiGroups: ["scheduling.k8s.io"]
    resources: ["priorityclasses"]
    verbs: ["get", "list", "watch"]

  # Custom Resource Definitions - view CRDs
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["get", "list", "watch"]

  # Metrics - access metrics API
  - apiGroups: ["metrics.k8s.io"]
    resources: ["nodes", "pods"]
    verbs: ["get", "list"]

  # Prometheus ServiceMonitor CRD
  - apiGroups: ["monitoring.coreos.com"]
    resources: ["servicemonitors", "podmonitors", "prometheusrules"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # cert-manager CRDs
  - apiGroups: ["cert-manager.io"]
    resources: ["certificates", "certificaterequests", "issuers", "clusterissuers"]
    verbs: ["get", "list", "watch"]

  # External Secrets CRDs
  - apiGroups: ["external-secrets.io"]
    resources: ["externalsecrets", "secretstores", "clustersecretstores"]
    verbs: ["get", "list", "watch"]

  # Istio CRDs (if Istio is enabled)
  {{- if .Values.istio.enabled }}
  - apiGroups: ["networking.istio.io"]
    resources: ["virtualservices", "destinationrules", "gateways", "serviceentries"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["security.istio.io"]
    resources: ["peerauthentications", "authorizationpolicies"]
    verbs: ["get", "list", "watch"]
  {{- end }}

  # Keda ScaledObjects (if KEDA is enabled)
  {{- if .Values.keda.enabled }}
  - apiGroups: ["keda.sh"]
    resources: ["scaledobjects", "scaledjobs", "triggerauthentications"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}
---
{{/*
ClusterRoleBinding - Binds ClusterRole to ServiceAccount
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "greenlang-agents.fullname" . }}-clusterrolebinding
  labels:
    {{- include "greenlang-agents.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "greenlang-agents.fullname" . }}-clusterrole
subjects:
  - kind: ServiceAccount
    name: {{ include "greenlang-agents.serviceAccountName" . }}
    namespace: {{ include "greenlang-agents.namespace" . }}
{{- end }}
