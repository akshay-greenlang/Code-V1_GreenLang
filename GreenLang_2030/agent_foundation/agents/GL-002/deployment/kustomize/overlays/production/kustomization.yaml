# Kustomize Overlay - Production Environment
# Full production configuration with HA, security, and monitoring

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base configuration
bases:
  - ../../base

# Namespace override
namespace: greenlang

# Name prefix for resources (production has no prefix)
# namePrefix: ""

# Common labels for production environment
commonLabels:
  environment: production
  tier: production
  criticality: high

# Common annotations
commonAnnotations:
  environment: "production"
  cost-center: "industrial-optimization"
  compliance-level: "sox-compliant"
  data-classification: "confidential"
  security-tier: "tier-2"
  monitoring-level: "enhanced"

# ConfigMap overrides
configMapGenerator:
  - name: gl-002-config
    behavior: merge
    literals:
      - environment=production
      - log_level=INFO
      - cache_ttl_seconds=300
      - optimization_timeout_seconds=300
      - feature_predictive_maintenance=false
      - metrics_enabled=true
      - database_echo=false
      - alerting_enabled=true
      - security_tls_enabled=true

# Image tag override (production stable release)
images:
  - name: gcr.io/greenlang/gl-002-boiler-efficiency
    newTag: 1.0.0

# Replica count override (3 for HA)
replicas:
  - name: gl-002-boiler-efficiency
    count: 3

# Patches for production-specific changes
patches:
  # Patch deployment for production environment
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: gl-002-boiler-efficiency
        annotations:
          deployment-type: "production"
          auto-deploy: "false"
          approval-required: "true"
          change-freeze-exempt: "false"
      spec:
        strategy:
          rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
        template:
          metadata:
            annotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "8001"
              prometheus.io/path: "/api/v1/metrics"
              sentry.io/environment: "production"
          spec:
            containers:
            - name: gl-002-boiler-efficiency
              resources:
                requests:
                  cpu: "500m"
                  memory: "512Mi"
                limits:
                  cpu: "1000m"
                  memory: "1024Mi"
              env:
              - name: GREENLANG_ENV
                value: "production"
              - name: ENABLE_PROFILING
                value: "false"
              - name: SENTRY_ENVIRONMENT
                value: "production"
              - name: DATADOG_ENV
                value: "production"

  # Patch HPA for production (aggressive scaling)
  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: gl-002-boiler-efficiency-hpa
      spec:
        minReplicas: 3
        maxReplicas: 10
        metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 70
        - type: Resource
          resource:
            name: memory
            target:
              type: Utilization
              averageUtilization: 80
        behavior:
          scaleUp:
            stabilizationWindowSeconds: 30
            policies:
            - type: Percent
              value: 100
              periodSeconds: 30
          scaleDown:
            stabilizationWindowSeconds: 300
            policies:
            - type: Percent
              value: 50
              periodSeconds: 60

  # Patch Ingress for production domain
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: gl-002-boiler-efficiency-ingress
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-prod"
          nginx.ingress.kubernetes.io/limit-rps: "100"
          nginx.ingress.kubernetes.io/limit-connections: "10"
          nginx.ingress.kubernetes.io/enable-modsecurity: "true"
          nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      spec:
        tls:
        - hosts:
          - api.boiler.greenlang.io
          secretName: gl-002-tls-prod
        rules:
        - host: api.boiler.greenlang.io
          http:
            paths:
            - path: /api/v1
              pathType: Prefix
              backend:
                service:
                  name: gl-002-boiler-efficiency
                  port:
                    number: 80

  # Patch PDB for production (strict availability)
  - patch: |-
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: gl-002-boiler-efficiency-pdb
      spec:
        minAvailable: 2

  # Patch NetworkPolicy for production security
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: gl-002-boiler-efficiency-netpol
        annotations:
          security-review: "approved"
          security-tier: "tier-2"
      spec:
        podSelector:
          matchLabels:
            app: gl-002-boiler-efficiency
            agent: "GL-002"
        policyTypes:
        - Ingress
        - Egress

# Resources to add (production-specific)
resources:
  - production-alerts.yaml      # Production alert rules
  - production-backup.yaml      # Backup policies
  - production-monitoring.yaml  # Enhanced monitoring

# Note: Create production-alerts.yaml, production-backup.yaml, production-monitoring.yaml
